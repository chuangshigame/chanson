
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµå®å­”å­å­¦æ ¡ - V0.0.3 ä¸‡è±¡å½’ä¸€</title>
    <style>
        :root {
            --bg-body: #0f172a; --panel-bg: rgba(255, 255, 255, 0.96);
            --board-bg: #1e293b; --chalk-white: #f8f9fa; --chalk-yellow: #fde047; --chalk-blue: #60a5fa;
            --primary: #2563eb; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --purple: #8b5cf6;
            --gold: #fbbf24; --wood: #452912;
            --radius: 12px; --shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        /* åŸºç¡€å¸ƒå±€ */
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: var(--bg-body); background-image: radial-gradient(circle at top, #1e293b, #0f172a); color: #334155; margin: 0; padding: 10px; display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden; }
        .container { width: 100%; max-width: 1450px; display: grid; gap: 15px; grid-template-columns: 320px 1fr 320px; transition: 0.5s; }
        
        /* é¡¶éƒ¨æ¨ªå¹… */
        .header-banner { grid-column: 1 / -1; background: linear-gradient(135deg, #7f1d1d, #991b1b); color: #fff; text-align: center; padding: 15px; border-radius: var(--radius); border: 3px solid #fca5a5; box-shadow: var(--shadow); position: relative; }
        .header-banner h1 { margin: 0; font-size: 2.2rem; letter-spacing: 2px; color: var(--chalk-yellow); text-shadow: 2px 2px 5px rgba(0,0,0,0.6); }
        
        /* ç³»ç»Ÿæ  */
        .sys-bar { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; background: var(--panel-bg); padding: 10px 20px; border-radius: var(--radius); box-shadow: var(--shadow); flex-wrap: wrap; gap:10px; }
        .school-badge { padding: 5px 12px; background: linear-gradient(135deg, #fef08a, var(--gold)); color: #713f12; border-radius: 20px; font-weight: 800; border: 1px solid #d97706; }
        .sys-btn { padding:6px 12px; cursor:pointer; background:#f8fafc; border:1px solid #cbd5e1; border-radius:6px; font-weight:bold; transition: 0.2s; color: #1e293b; display: inline-flex; align-items: center; gap: 4px; font-size: 0.85rem; }
        .sys-btn:hover:not(:disabled) { background: #e2e8f0; transform: translateY(-1px); }
        .btn-auto.active { background: var(--danger); color: white; border-color: #b91c1c; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(239,68,68,0.5);} 70% {box-shadow: 0 0 0 8px rgba(239,68,68,0);} 100% {box-shadow: 0 0 0 0 rgba(239,68,68,0);} }

        /* ===== æˆ˜æ–—è§†è§‰ç‰¹æ•ˆ ===== */
        .b-dmg-float {
            position: fixed; pointer-events: none; z-index: 99990;
            font-family: 'Courier New', monospace; font-weight: 900;
            animation: bdmg-rise 1.5s ease-out forwards;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.8), 0 0 12px currentColor;
            white-space: nowrap;
        }
        @keyframes bdmg-rise {
            0%   { transform: translateY(0) scale(0.6); opacity: 1; }
            20%  { transform: translateY(-20px) scale(1.2); opacity: 1; }
            60%  { transform: translateY(-60px) scale(1); opacity: 0.9; }
            100% { transform: translateY(-110px) scale(0.8); opacity: 0; }
        }
        @keyframes b-shake-x {
            0%,100%{transform:translateX(0) rotate(0)}
            15%{transform:translateX(-10px) rotate(-1.5deg)}
            35%{transform:translateX(10px) rotate(1.5deg)}
            55%{transform:translateX(-7px)}
            75%{transform:translateX(7px)}
        }
        @keyframes b-hit-red { 0%,100%{background:rgba(0,0,0,0.6)} 30%{background:rgba(239,68,68,0.4);box-shadow:inset 0 0 30px rgba(239,68,68,0.5)} }
        @keyframes b-hit-crit { 0%,100%{box-shadow:0 0 15px rgba(0,0,0,0.5)} 30%{box-shadow:0 0 50px rgba(192,132,252,1),inset 0 0 25px rgba(192,132,252,0.4)} }
        @keyframes b-hit-heal { 0%,100%{background:rgba(0,0,0,0.6)} 30%{background:rgba(16,185,129,0.3);box-shadow:inset 0 0 20px rgba(16,185,129,0.4)} }
        @keyframes b-enemy-lunge { 0%,100%{transform:translateX(0)} 25%{transform:translateX(18px) scale(1.03)} 60%{transform:translateX(-4px)} }
        @keyframes b-screen-flash { 0%,100%{opacity:0} 10%,40%{opacity:1} }
        .b-entity.b-hit   { animation: b-shake-x 0.5s ease-out, b-hit-red 0.55s ease-out; }
        .b-entity.b-crit  { animation: b-shake-x 0.6s ease-out, b-hit-crit 0.7s ease-out; }
        .b-entity.b-heal  { animation: b-hit-heal 0.6s ease-out; }
        .b-entity.b-lunge { animation: b-enemy-lunge 0.45s ease-out; }
        #b-screen-flash   { position:absolute;inset:0;pointer-events:none;border-radius:8px;opacity:0;z-index:10; }


        /* é¢æ¿é€šç”¨ */
        .panel { background: var(--panel-bg); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); display:flex; flex-direction: column; position: relative; }
        .panel-title { font-size: 1.1rem; font-weight: 800; border-bottom: 3px solid var(--primary); padding-bottom: 8px; margin-top: 0; margin-bottom: 12px; color: #1e293b; display:flex; justify-content:space-between; align-items:flex-end; }
        
        /* èµ„æºæ ¼å­ */
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .res-box { background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; position: relative; }
        .res-box span { display: block; font-size: 1.2rem; font-weight: 900; color: var(--primary); margin-top: 5px; font-family: monospace; }
        .res-sub { font-size: 0.65rem; color: #64748b; position: absolute; bottom: 2px; right: 5px; font-weight:bold; }

        /* é»‘æ¿å±æ€§æ¡ */
        .blackboard { background: var(--board-bg); border: 8px solid var(--wood); border-radius: 6px; padding: 15px; color: var(--chalk-white); box-shadow: inset 0 0 15px rgba(0,0,0,0.8); }
        .stat-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem; font-weight: bold; position:relative; }
        .stat-label { width: 85px; color: var(--chalk-blue); z-index:2; }
        .bar-bg { flex: 1; height: 18px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); margin: 0 10px; position:relative; }
        .bar-fill { height: 100%; transition: width 0.3s ease-out; background-image: linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 10px 100%; }
        .stat-val { width: 35px; text-align: right; font-family: monospace; font-size: 1.1rem; color: var(--chalk-yellow); z-index:2; }
        .stress-warning { color: #fca5a5; font-size: 0.75rem; text-align: center; animation: blink 0.8s infinite; margin-top:-5px; font-weight:bold; display:none; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* æŒ‰é’®ç»„ä»¶ */
        .btn { width: 100%; padding: 10px; background: #fff; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; text-align: left; transition: 0.2s; font-weight: bold; color: #334155; display:flex; flex-direction:column; margin-bottom:8px; position: relative;}
        .btn:hover:not(:disabled) { border-color: var(--primary); background: #eff6ff; transform: translateX(3px); }
        .btn:disabled { background: #f1f5f9; border-color: #cbd5e1; color: #94a3b8; cursor: not-allowed; opacity: 0.7; }
        .btn-desc { font-size: 0.7rem; color: #64748b; font-weight: normal; margin-top: 4px; }
        .btn-main { background: linear-gradient(135deg, var(--primary), #1e40af); color: white; border: none; font-size: 1.2rem; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 900; width: 100%; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.4); text-align:center; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(37, 99, 235, 0.6); }

        /* æ¨¡æ€æ¡†ç³»ç»Ÿ */
        .fs-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.9); z-index: 2000; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(4px); }
        .fs-content { background: #f8fafc; width: 100%; max-width: 1300px; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .fs-header { background: #1e293b; color: white; padding: 15px 20px; display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; align-items:center; }
        .fs-close { background: transparent; border: none; color: white; font-size: 1.8rem; cursor: pointer; line-height:1; }
        .fs-body { padding: 20px; overflow-y: auto; flex: 1; }

        /* ç½‘æ ¼ä¸å¡ç‰‡ */
        .grid-sys { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
        .gacha-card { background: #fff; border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 15px; position:relative; }
        .expert-img { width: 65px; height: 65px; border-radius: 32px; object-fit: cover; border: 2px solid #cbd5e1; background: #f1f5f9; flex-shrink: 0; }
        .upkeep-tag { position:absolute; top:5px; right:5px; font-size:0.7rem; background:#fee2e2; color:#991b1b; padding:2px 5px; border-radius:4px; font-weight:bold; }
        .type-tag { position:absolute; bottom:5px; right:5px; font-size:0.7rem; padding:2px 5px; border-radius:4px; font-weight:bold; }
        .type-battle { background: #fee2e2; color:#b91c1c; } .type-passive { background: #e0f2fe; color:#0369a1; }
        .rarity-R { border-color: #3b82f6; box-shadow: 0 0 10px rgba(59,130,246,0.2); }
        .rarity-SR { border-color: #a855f7; box-shadow: 0 0 15px rgba(168,85,247,0.3); }
        .rarity-SSR { border-color: var(--gold); box-shadow: 0 0 20px rgba(251,191,36,0.5); background: linear-gradient(135deg, #fff, #fefce8); }
        
        /* æ ‘å½¢ç»“æ„ */
        .tree-tier { display: flex; gap: 15px; justify-content: center; width: 100%; margin-bottom: 25px; flex-wrap: wrap; }
        .tree-node { width: 220px; background:#fff; border: 2px solid #cbd5e1; border-radius: 8px; padding: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.3s; display: flex; flex-direction: column; justify-content: space-between; }
        .tree-node.locked { filter: grayscale(1); opacity: 0.6; }
        .tree-node.unlocked { border-color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); background:#f0fdf4; }
        .tree-node.branch-a { border-top: 5px solid var(--danger); }
        .tree-node.branch-b { border-top: 5px solid var(--warning); }
        .tree-node.branch-c { border-top: 5px solid #fbbf24; }
        .tree-node.branch-d { border-top: 5px solid var(--success); }

        /* åœ°å›¾ */
        .map-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background: #84cc16; padding: 15px; border-radius: 8px; border: 4px solid #4d7c0f; }
        .map-cell { background: rgba(255,255,255,0.5); border: 2px dashed #65a30d; border-radius: 6px; height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; position: relative; }
        .map-cell:hover { background: rgba(255,255,255,0.9); }
        .map-cell.selected { border: 3px solid var(--danger); background: #fff; }

        /* æ—¥å¿— */
        .log-box { flex: 1; overflow-y: auto; font-size: 0.85rem; background: #fff; border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; line-height: 1.5; }
        .log-item { margin-bottom: 8px; border-bottom: 1px dashed #e2e8f0; padding-bottom: 4px; }
        
        /* ç‹¬ç«‹å­¦ç”Ÿä¿¡ç®±æ ·å¼ */
        .mailbox-container { height: 180px; overflow-y: auto; background: #f1f5f9; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px;}
        .comment-bubble { background: #fff; border-left: 4px solid var(--primary); padding: 10px; border-radius: 0 8px 8px 0; font-size: 0.85rem; color: #1e293b; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .comment-meta { font-size: 0.7rem; color: #94a3b8; margin-top: 5px; text-align: right; }

        /* æˆ˜æ–—ç³»ç»Ÿå¸ƒå±€ */
        .battle-ui { display: flex; flex-direction: column; height: 85vh; max-height:850px; background: #000; color: #a3e635; padding: 15px; border-radius: 8px; font-family: 'Courier New', Courier, monospace; overflow: hidden; box-shadow: 0 0 30px rgba(101, 163, 13, 0.2); }
        .b-header { flex: 0 0 auto; display: flex; justify-content: space-between; border-bottom: 1px dashed #3f6212; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; color: #bef264; }
        .b-arena { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border: 2px solid #65a30d; border-radius: 8px; background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(20, 83, 45, 0.7)); position: relative; height: 160px; box-shadow: inset 0 0 25px rgba(101, 163, 13, 0.4); }
        .b-entity { width: 42%; background: rgba(0, 0, 0, 0.6); padding: 12px; border-radius: 8px; border: 1px solid #3f6212; box-shadow: 0 0 15px rgba(0,0,0,0.8); }
        .b-name { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; color: #d9f99d; text-shadow: 0 0 5px #d9f99d; }
        .b-hp-bg { height: 14px; background: #000; border: 1px solid #a3e635; margin: 5px 0; position: relative; border-radius:3px; overflow:hidden;}
        .b-hp-fill { height: 100%; background: linear-gradient(90deg, #4ade80, #16a34a); box-shadow: inset 0 0 8px rgba(255,255,255,0.4); transition: width 0.3s ease-out; }
        .b-hp-txt { position: absolute; width: 100%; text-align: center; top: -1px; font-size: 0.75rem; font-weight: bold; color: #fff; text-shadow:1px 1px 2px #000;}
        .b-stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 0.75rem; color:#cbd5e1; }
        .b-stress-bar { height: 5px; background: #000; border: 1px solid #ef4444; margin-top: 4px; border-radius:2px; }
        .b-stress-fill { height: 100%; background: #dc2626; transition: width 0.3s; }
        
        .b-weather { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); text-align: center; background: rgba(0,0,0,0.8); padding: 5px 12px; border-radius: 6px; border: 1px solid #fde047; color: #fde047; font-size: 0.75rem; z-index: 10; width: 150px; box-shadow: 0 0 10px rgba(253,224,71,0.3);}
        .b-buffs { display: flex; flex-wrap: wrap; gap: 4px; font-size: 0.7rem; margin-top: 5px; color: #a7f3d0; }
        
        /* æˆ˜æ–—æ—¥å¿—åŒºåŸŸ */
        .b-log { flex: 1; border: 1px dashed #3f6212; padding: 10px; margin: 10px 0; overflow-y: auto; font-size: 0.85rem; line-height: 1.5; background: rgba(0,0,0,0.4); min-height: 100px; display:flex; flex-direction:column; border-radius:4px; }
        .b-log-inner { margin-top: auto; } /* å¼ºåˆ¶å†…å®¹é ä¸‹ */
        .b-log span.sys { color: #fde047; } .b-log span.p { color: #93c5fd; } .b-log span.e { color: #fca5a5; } 
        .b-log span.dmg { color: #ef4444; font-weight: bold; } .b-log span.crit { color: #c084fc; font-weight: bold; text-shadow: 0 0 5px #c084fc; }
        
        .b-expert-select { flex: 0 0 auto; display:flex; gap:10px; margin-bottom:10px; overflow-x:auto; padding-bottom:5px; border-bottom:1px dashed #3f6212; min-height: 35px; align-items:center; }
        .b-expert-select::-webkit-scrollbar { height: 4px; }
        .b-expert-select::-webkit-scrollbar-thumb { background: #3f6212; border-radius: 2px; }

        /* æ“ä½œåŒºåŸŸ */
        .b-actions { flex: 0 0 auto; border-top: 1px dashed #3f6212; padding-top: 10px; display: grid; grid-template-columns: 140px 1fr; gap: 10px; height: 160px; }
        .b-cats { display: flex; flex-direction: column; gap: 4px; overflow-y: auto; padding-right:5px;}
        .b-cats::-webkit-scrollbar { width: 4px; } .b-cats::-webkit-scrollbar-thumb { background:#3f6212; }
        .b-cat-btn { background: rgba(0,0,0,0.6); color: #a3e635; border: 1px solid #3f6212; padding: 8px; cursor: pointer; font-family: inherit; font-size: 0.85rem; text-align: left; transition: 0.2s; border-radius:4px; }
        .b-cat-btn:hover, .b-cat-btn.active { background: #14532d; border-color: #a3e635; box-shadow: 0 0 8px rgba(163,230,53,0.3); }
        .b-skills { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 8px; align-content: start; overflow-y: auto; padding-right:5px; }
        .b-skills::-webkit-scrollbar { width: 4px; } .b-skills::-webkit-scrollbar-thumb { background:#3f6212; }
        .b-skill-btn { background: rgba(0,0,0,0.6); color: #fff; border: 1px solid #4ade80; padding: 8px; cursor: pointer; font-family: inherit; text-align: left; display: flex; flex-direction: column; transition: 0.2s; border-radius:4px; }
        .b-skill-btn:hover:not(:disabled) { background: #166534; transform: translateX(2px); box-shadow: 0 0 8px rgba(74,222,128,0.4); }
        .b-skill-btn:disabled { border-color: #334155; color: #64748b; cursor: not-allowed; text-decoration: line-through; opacity: 0.6; }
        .b-s-name { font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }
        .b-s-desc { font-size: 0.7rem; color: #bef264; }

        /* å­¦ç”Ÿæ¨¡å¼ */
        #student-container { display: none; width: 100%; max-width: 1400px; background: rgba(255,255,255,0.95); border-radius: 12px; padding: 12px; margin: 0 auto; box-shadow: var(--shadow); }
        .stu-grid { display: grid; grid-template-columns: 185px 1fr 380px; gap: 8px; align-items: start; }
        .stu-act-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; }
        .stu-act-btn { padding: 4px 6px; border: 1px solid #cbd5e1; border-radius: 5px; background: #fff; font-size: 0.7rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 4px; transition:0.15s; text-align:left; line-height: 1.2; width: 100%; box-sizing: border-box; }
        .stu-act-btn:hover { border-color: var(--primary); background: #eff6ff; }
        .stu-act-btn .stu-icon { font-size: 1rem; flex-shrink: 0; }
        .stu-act-btn b { font-size: 0.68rem; display:block; }
        .stu-act-btn .btn-sub { font-size: 0.58rem; color:#64748b; font-weight:normal; display:block; }
        .stu-stat-box { background: #1e293b; color: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.8rem; }
        .exam-board { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; border: 3px solid #047857; }
        
        .friend-card { background: #f8fafc; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap:wrap; gap:5px; }
        .friend-card.active { border-color: var(--success); background: #ecfdf5; }
        .rebirth-points { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; }
        .family-card { background: #fff; border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; position:relative; }
        .family-card:hover { border-color: var(--primary); background: #eff6ff; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .family-card.selected { border-color: var(--primary); background: #eff6ff; box-shadow: 0 0 0 3px rgba(37,99,235,0.2); }

        .crush-card { background: #fff; border: 1px solid #fbcfe8; border-radius: 5px; padding: 5px; margin-bottom: 4px; display:flex; flex-direction:column; position:relative; overflow:hidden; font-size:0.72rem;}
        .crush-head { display:flex; gap:4px; align-items:center; margin-bottom:4px; }
        .crush-img { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #f9a8d4; object-fit: cover; background: #fdf2f8; flex-shrink:0; cursor:pointer; transition:0.2s; }
        .crush-img:hover { transform: scale(1.1); }
        .crush-info h4 { margin:0; color:#be185d; font-size:0.72rem;}
        .crush-info p { margin:0; font-size:0.6rem; color:#64748b;}
        .crush-bar-bg { background:#f1f5f9; height:5px; border-radius:3px; overflow:hidden; margin-bottom:5px; }
        .crush-bar-fill { background:linear-gradient(90deg, #f472b6, #db2777); height:100%; transition: width 0.3s;}
        .crush-actions { display:grid; grid-template-columns:1fr 1fr; gap:3px; }
        .crush-dialog { background:#fdf2f8; padding:5px; border-radius:4px; font-size:0.65rem; color:#be185d; font-style:italic; margin-bottom:5px; display:none; border-left:2px solid #f472b6;}

        /* ===== ç»ˆæœ«ä¹‹è¯— ===== */
        #end-poem-overlay {
            display: none;
            position: fixed; inset: 0;
            background: #000;
            z-index: 99999;
            overflow: hidden;
            cursor: pointer;
        }
        #end-poem-track {
            position: absolute;
            left: 0; right: 0; top: 0;
            padding: 0 clamp(16px, 6vw, 60px) 20vh;
            box-sizing: border-box;
            text-align: center;
            animation: poemScroll 150s linear forwards;
        }
        #end-poem-track.done-anim ~ #end-poem-close-hint { display: block !important; }
        @keyframes poemScroll {
            from { transform: translateY(100vh); }
            to   { transform: translateY(-8000px); }
        }
        .poem-line { display: block; color: #d1d5db; font-size: clamp(1.05rem, 3.2vw, 1.25rem); line-height: 2; font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif; margin: 0; }
        .poem-line.dim    { color: #4b5563; }
        .poem-line.gold   { color: #fde047; font-weight: 700; font-size: clamp(1.1rem, 3.5vw, 1.35rem); }
        .poem-line.big    { color: #fff; font-weight: 900; font-size: clamp(1.3rem, 4.5vw, 1.7rem); letter-spacing: 4px; }
        .poem-line.small  { color: #374151; font-size: clamp(0.78rem, 2.2vw, 0.9rem); }
        .poem-line.italic { color: #c4cdd8; font-style: italic; }
        .poem-line.quote  { color: #f9a8d4; font-style: italic; border-left: 3px solid #f472b6; padding-left: 16px; text-align: left; display: inline-block; max-width: min(640px, 90vw); line-height: 2; margin: 4px 0; }
        .poem-spacer { display: block; height: clamp(1rem, 3vh, 2rem); }
        .poem-hint   { display: block; color: #374151; font-size: 0.8rem; }

        .chart-container { display: flex; align-items: flex-end; justify-content: space-around; height: 180px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px 5px 0 5px; margin: 15px 0; }
        .chart-col { display: flex; flex-direction: column; align-items: center; width: 14%; font-size: 0.7rem; }
        .chart-bar { width: 100%; border-radius: 4px 4px 0 0; transition: 0.5s; display: flex; justify-content: center; align-items:flex-end; color: white; font-weight: bold; padding-top: 5px; font-size: 0.8rem; padding-bottom:2px;}
        .chart-label { font-size: 0.7rem; font-weight: bold; margin-top: 5px; color: #475569; text-align: center; line-height:1.2; }

        /* é€šç”¨å¼¹çª—è¦†ç›– */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 9000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.6); max-height: 90vh; overflow-y:auto; }
        .modal-btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 8px; font-weight: bold; font-size: 1rem; transition: 0.2s; display:inline-flex; flex-direction:column; align-items:center; }
        .modal-btn:hover { background: #1d4ed8; transform: translateY(-2px); }

        /* Toast */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: rgba(15,23,42,0.95); color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold; border-left: 4px solid var(--primary); animation: slideIn 0.3s forwards, fadeOut 0.5s 3.5s forwards; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        @keyframes slideIn { from{transform: translateX(100%);} to{transform: translateX(0);} }
        @keyframes fadeOut { to{transform: translateY(-20px); opacity:0;} }
        /* ===== æŠ½å¡åŠ¨ç”» ===== */
        #gacha-overlay {
            display: none; position: fixed; inset: 0; z-index: 99998;
            background: #000; justify-content: center; align-items: center;
        }
        #gacha-overlay.show { display: flex; }
        #gacha-card {
            width: min(340px, 88vw); aspect-ratio: 2/3;
            border-radius: 20px; position: relative;
            display: flex; flex-direction: column; justify-content: flex-end;
            align-items: center; padding: 24px 20px;
            box-shadow: 0 0 80px var(--gc, #3b82f6);
            transform: scale(0) rotateY(180deg);
            transition: transform 0.6s cubic-bezier(0.34,1.56,0.64,1);
            cursor: pointer; overflow: hidden;
            background: var(--gc-bg, linear-gradient(160deg,#1e3a5f,#0f172a));
        }
        #gacha-card.flip { transform: scale(1) rotateY(0deg); }
        #gacha-card::before {
            content:''; position:absolute; inset:0;
            background: linear-gradient(135deg,rgba(255,255,255,0.15) 0%,transparent 60%);
            pointer-events:none;
        }
        #gacha-particles {
            position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:99999;
        }
        .g-particle {
            position:absolute; border-radius:50%;
            animation: gp-fly 1.2s ease-out forwards;
        }
        @keyframes gp-fly {
            0%   { transform: translate(-50%,-50%) scale(1); opacity:1; }
            100% { transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(0); opacity:0; }
        }
        #gacha-rarity-label {
            font-size: clamp(0.9rem,3vw,1.1rem); font-weight:900; letter-spacing:6px;
            text-transform:uppercase; margin-bottom:8px;
            text-shadow: 0 0 20px currentColor;
        }
        #gacha-name {
            font-size: clamp(1.4rem,5vw,1.9rem); font-weight:900; color:#fff;
            text-align:center; text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            line-height:1.2; margin-bottom:6px;
        }
        #gacha-desc {
            font-size: clamp(0.75rem,2.5vw,0.88rem); color:rgba(255,255,255,0.75);
            text-align:center; line-height:1.5;
        }
        #gacha-icon {
            font-size: clamp(3.5rem,12vw,5rem); margin-bottom:12px;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.5));
            animation: icon-float 2s ease-in-out infinite;
        }
        @keyframes icon-float {
            0%,100% { transform:translateY(0); }
            50%      { transform:translateY(-10px); }
        }
        #gacha-duplicate-badge {
            position:absolute; top:16px; right:16px;
            background:rgba(0,0,0,0.6); color:#fde047; font-size:0.75rem;
            font-weight:bold; padding:4px 10px; border-radius:20px;
            border:1px solid #fde047; display:none;
        }
        #gacha-tap-hint {
            position:absolute; bottom:12px; left:0; right:0; text-align:center;
            color:rgba(255,255,255,0.4); font-size:0.75rem; letter-spacing:2px;
            animation: hint-blink 1.2s infinite;
        }
        @keyframes hint-blink { 50%{opacity:0.1;} }
        #gacha-bg-glow {
            position:absolute; inset:-20px; border-radius:30px;
            background: radial-gradient(circle, var(--gc,#3b82f6) 0%, transparent 70%);
            opacity:0; animation: glow-pulse 1.5s ease-in-out infinite;
            pointer-events:none;
        }
        @keyframes glow-pulse { 0%,100%{opacity:0.15;transform:scale(1);} 50%{opacity:0.4;transform:scale(1.05);} }

        /* ===== æˆ˜æ–—ç‰¹æ•ˆ ===== */
        .b-damage-float {
            position: fixed; pointer-events: none; z-index: 99990;
            font-family: 'Courier New', monospace; font-weight: 900;
            text-shadow: 0 0 8px currentColor, 2px 2px 0 rgba(0,0,0,0.8);
            animation: dmg-float 1.4s ease-out forwards;
        }
        @keyframes dmg-float {
            0%   { transform: translateY(0) scale(1); opacity: 1; }
            40%  { transform: translateY(-40px) scale(1.15); opacity: 1; }
            100% { transform: translateY(-100px) scale(0.7); opacity: 0; }
        }
        @keyframes b-shake {
            0%,100% { transform: translateX(0); }
            20% { transform: translateX(-8px) rotate(-1deg); }
            40% { transform: translateX(8px) rotate(1deg); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }
        @keyframes b-flash-red {
            0%,100% { background: rgba(0,0,0,0.6); }
            30% { background: rgba(239,68,68,0.35); }
        }
        @keyframes b-flash-crit {
            0%,100% { box-shadow: 0 0 15px rgba(0,0,0,0.8); }
            30% { box-shadow: 0 0 40px rgba(192,132,252,0.9), inset 0 0 20px rgba(192,132,252,0.3); }
        }
        @keyframes b-flash-heal {
            0%,100% { background: rgba(0,0,0,0.6); }
            30% { background: rgba(16,185,129,0.25); }
        }
        .b-hit { animation: b-shake 0.4s ease-out, b-flash-red 0.5s ease-out; }
        .b-crit { animation: b-shake 0.5s ease-out, b-flash-crit 0.6s ease-out; }
        .b-heal { animation: b-flash-heal 0.6s ease-out; }
        @keyframes b-enemy-atk {
            0%,100% { transform: translateX(0); }
            25% { transform: translateX(15px); }
            75% { transform: translateX(-5px); }
        }
        .b-enemy-atk { animation: b-enemy-atk 0.45s ease-out; }

        /* ===== åè¿æŠ½ ===== */
        #gacha10-overlay {
            display: none; position: fixed; inset: 0; z-index: 99997;
            background: #000; flex-direction: column;
            justify-content: center; align-items: center; gap: 16px;
        }
        #gacha10-overlay.show { display: flex; }
        #gacha10-grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 10px; width: min(860px, 96vw); padding: 0 10px;
        }
        .g10-card {
            aspect-ratio: 2/3; border-radius: 12px; position: relative;
            display: flex; flex-direction: column; justify-content: flex-end;
            align-items: center; padding: 10px 6px;
            overflow: hidden;
            transform: translateY(60px) scale(0.8); opacity: 0;
            transition: transform 0.45s cubic-bezier(0.34,1.56,0.64,1), opacity 0.35s ease;
        }
        .g10-card.revealed { transform: translateY(0) scale(1); opacity: 1; }
        .g10-card::before { content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(255,255,255,0.18) 0%,transparent 55%); pointer-events:none; border-radius:12px; }
        .g10-card-icon { font-size: clamp(1.4rem,3.5vw,2rem); margin-bottom:4px; filter:drop-shadow(0 0 8px rgba(255,255,255,0.5)); }
        .g10-card-rarity { font-size: clamp(0.5rem,1.2vw,0.65rem); font-weight:900; letter-spacing:3px; margin-bottom:3px; text-shadow:0 0 8px currentColor; }
        .g10-card-name { font-size: clamp(0.55rem,1.4vw,0.78rem); font-weight:900; color:#fff; text-align:center; line-height:1.2; text-shadow:0 1px 6px rgba(0,0,0,0.9); }
        .g10-dup-badge { position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.6); color:#fde047; font-size:0.48rem; font-weight:bold; padding:2px 5px; border-radius:8px; border:1px solid #fde047; }
        #gacha10-close { background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.3); padding:10px 36px; border-radius:30px; cursor:pointer; font-size:1rem; font-weight:bold; transition:background 0.2s; letter-spacing:2px; }
        #gacha10-close:hover { background:rgba(255,255,255,0.2); }
        #gacha10-summary { color:rgba(255,255,255,0.7); font-size:0.85rem; letter-spacing:1px; opacity:0; transition:opacity 0.5s; text-align:center; }
        #gacha10-summary.show { opacity:1; }

        @media (max-width: 900px) {
            body { padding: 6px; }

            /* æ ¡é•¿ä¸‰æ  â†’ å•æ  */
            .container { grid-template-columns: 1fr !important; gap: 8px; }
            .header-banner h1 { font-size: 1.3rem; letter-spacing: 1px; }
            .header-banner { padding: 10px; }

            /* ç³»ç»Ÿæ æ¢è¡Œå‹ç¼© */
            .sys-bar { padding: 8px 10px; gap: 6px; }
            .sys-btn { padding: 5px 8px; font-size: 0.75rem; }
            .school-badge { font-size: 0.8rem; padding: 4px 8px; }

            /* èµ„æºæ ¼å­ä¸¤åˆ—ä¿ç•™ */
            .res-grid { grid-template-columns: 1fr 1fr; }

            /* æŒ‰é’®å­—ä½“ç¼©å° */
            .btn { padding: 8px; font-size: 0.85rem; }
            .btn-desc { font-size: 0.65rem; }
            .btn-main { font-size: 1rem; padding: 12px; }

            /* æ¨¡æ€æ¡†å…¨å± */
            .fs-modal { padding: 8px; }
            .fs-content { max-height: 95vh; border-radius: 8px; }
            .fs-body { padding: 12px; }
            .fs-header { padding: 10px 14px; font-size: 1rem; }
            .grid-sys { grid-template-columns: 1fr; }

            /* åœ°å›¾æ ¼å­ç¼©å° */
            .map-cell { height: 55px; font-size: 0.7rem; }
            .map-grid { gap: 5px; padding: 8px; }

            /* æ ‘èŠ‚ç‚¹ */
            .tree-node { width: 160px; font-size: 0.8rem; padding: 8px; }

            /* å­¦ç”Ÿä¸‰æ  â†’ å•æ å †å  */
            .stu-grid { grid-template-columns: 1fr !important; gap: 6px; }
            #student-container { padding: 8px; }

            /* å­¦ç”Ÿè¡ŒåŠ¨2åˆ—ä¿ç•™ï¼Œç¼©å­—ä½“ */
            .stu-act-btn { font-size: 0.65rem; padding: 4px 5px; }
            .stu-act-btn b { font-size: 0.63rem; }
            .stu-act-btn .btn-sub { font-size: 0.55rem; }
            .stu-act-grid { max-height: 300px; }

            /* åŠ¨ä½œåŒºå–æ¶ˆ max-width é™åˆ¶ */
            #student-container > .stu-grid > div:nth-child(2) { max-width: 100% !important; }

            /* æ‹çˆ±åŒºä¸¤åˆ— */
            #stu-crush-container { grid-template-columns: 1fr 1fr !important; }

            /* å¼¹çª— */
            .modal-content { padding: 15px; width: 95%; }

            /* é»‘æ¿å­—ä½“ç¼©å° */
            .blackboard { padding: 10px; }
            .stat-label { width: 70px; font-size: 0.8rem; }
            .stat-val { font-size: 0.95rem; }

            /* è”è€ƒæˆ˜æ–— - å…¨é¢é‡æ’ */
            .battle-ui { height: auto !important; max-height: none !important; overflow-y: auto !important; padding: 8px !important; }
            .b-arena { height: auto !important; flex-direction: column !important; gap: 8px; padding: 8px !important; }
            .b-entity { width: 100% !important; box-sizing: border-box; }
            .b-actions { grid-template-columns: 1fr !important; height: auto !important; min-height: 0 !important; }
            .b-cats { flex-direction: row !important; flex-wrap: wrap !important; gap: 4px !important; overflow: visible !important; padding: 0 !important; }
            .b-cat-btn { font-size: 0.7rem !important; padding: 5px 7px !important; }
            .b-skills { grid-template-columns: repeat(2, 1fr) !important; max-height: 200px; overflow-y: auto; }
            .b-header { font-size: 0.75rem !important; flex-wrap: wrap; gap: 4px; }
            #modal-battle .fs-content { height: auto !important; max-height: 95vh; overflow-y: auto; }

            /* è¯¾è¡¨ */
            #weekly-timetable { font-size: 0.6rem !important; }

            /* åœ°å›¾å¼¹çª— */
            .fs-body[style*="grid"] { display: flex !important; flex-direction: column !important; }
            .map-fs-body { display: flex !important; flex-direction: column !important; }
            .stu-action-col { max-width: 100% !important; }
        }

        @media (max-width: 480px) {
            .header-banner h1 { font-size: 1.1rem; }
            .sys-bar { flex-direction: column; align-items: flex-start; }
            .res-grid { grid-template-columns: 1fr 1fr; gap: 5px; }
            .res-box { padding: 7px; font-size: 0.8rem; }
            .res-box span { font-size: 1rem; }
            .tree-node { width: 140px; }
            .stu-grid { grid-template-columns: 1fr !important; }
            #stu-crush-container { grid-template-columns: 1fr !important; }
            .map-cell { height: 45px; font-size: 0.6rem; }
        }
    </style>
</head>
<body>

<div id="toast-container"></div>

<!-- èƒŒæ™¯éŸ³ä¹ -->
<audio id="bgm" loop style="display:none"></audio>

<!-- ================= éš¾åº¦é€‰æ‹©å¯åŠ¨é¡µï¼ˆç‹¬ç«‹äºmodalç³»ç»Ÿï¼‰================= -->
<div id="diff-screen" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:linear-gradient(135deg,#0f172a,#1e293b); z-index:99999; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:rgba(255,255,255,0.97); border-radius:16px; padding:40px 50px; text-align:center; max-width:520px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.5);">
        <div style="font-size:3rem; margin-bottom:10px;">ğŸ«</div>
        <h1 style="margin:0 0 8px 0; color:#1e293b; font-size:1.8rem;">å­”å­å­¦æ ¡</h1>
        <p style="color:#64748b; margin:0 0 30px 0; font-size:0.95rem;">è¯·é€‰æ‹©æ¸¸æˆéš¾åº¦å¼€å§‹ä½ çš„åŠå­¦éœ¸ä¸š</p>
        <div style="display:flex; flex-direction:column; gap:12px;">
            <button onclick="startGame(0)" style="padding:18px 24px; background:linear-gradient(135deg,#10b981,#059669); color:white; border:none; border-radius:10px; font-size:1.1rem; font-weight:bold; cursor:pointer; transition:0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                ğŸŒŸ ç®€å•æ¨¡å¼<br><span style="font-size:0.8rem; font-weight:normal; opacity:0.9;">åˆå§‹èµ„é‡‘500ä¸‡ Â· å‹åŠ›Ã—0.4 Â· èŠ±è´¹Ã—0.6</span>
            </button>
            <button onclick="startGame(1)" style="padding:18px 24px; background:linear-gradient(135deg,#2563eb,#1d4ed8); color:white; border:none; border-radius:10px; font-size:1.1rem; font-weight:bold; cursor:pointer; transition:0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                âš”ï¸ æ­£å¸¸æ¨¡å¼<br><span style="font-size:0.8rem; font-weight:normal; opacity:0.9;">åˆå§‹èµ„é‡‘100ä¸‡ Â· æ ‡å‡†æ¨¡æ‹Ÿæ³•åˆ™</span>
            </button>
            <button onclick="startGame(2)" style="padding:18px 24px; background:linear-gradient(135deg,#dc2626,#b91c1c); color:white; border:none; border-radius:10px; font-size:1.1rem; font-weight:bold; cursor:pointer; transition:0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                ğŸ’€ å›°éš¾æ¨¡å¼<br><span style="font-size:0.8rem; font-weight:normal; opacity:0.9;">åˆå§‹èµ„é‡‘50ä¸‡ Â· å‹åŠ›Ã—1.2 Â· èŠ±è´¹Ã—1.5</span>
            </button>
        </div>
    </div>
</div>

<!-- ================= æ ¡é•¿æ¨¡å¼ ================= -->
<div class="container" id="principal-container">
    <div class="header-banner">
        <h1>å­”å­å­¦æ ¡ V0.0.3 ä¸‡è±¡å½’ä¸€</h1>
        <p style="margin: 5px 0 0 0; font-size: 0.95rem; opacity: 0.9;">By ChansonTech | å¤§åƒä¸–ç•Œï¼Œçš†åœ¨å±€ä¸­</p>
    </div>

    <div class="sys-bar">
        <div style="display:flex; align-items:center; gap: 10px;">
            <span class="school-badge" id="ui-level-name">ğŸ† ä¹¡é•‡ä¸­å­¦</span>
            <button class="sys-btn" onclick="checkUpgrade()">ğŸ–ï¸ ç”³è¯·è¯„çº§ (æ˜¾ç¤ºæ¡ä»¶)</button>
            <button class="sys-btn btn-auto" id="btn-auto" onclick="toggleAuto()">ğŸ¤– è‡ªåŠ¨æ¨æ¼”</button>
        </div>
        <div style="display:flex; gap: 8px; align-items:center;">
            <span style="font-weight:bold; color:var(--danger); font-size:0.9rem;">âš”ï¸ è”è€ƒæˆ˜ç»©: <span id="ui-examPoints">0</span>åˆ†</span>
            <button class="sys-btn" style="background:var(--purple); color:white; border:none; padding:8px 15px;" onclick="switchMode('student')">ğŸ‘¨â€ğŸ“ åˆ‡æ¢è‡³ï¼šå­¦ç”Ÿæ·±æ½œè§†è§’</button>
            <span id="ui-diff-badge" style="font-size:0.8rem; background:#475569; color:white; padding:4px 8px; border-radius:4px; font-weight:bold;">éš¾åº¦: æ­£å¸¸</span>
            <button class="sys-btn" style="background:linear-gradient(135deg,#1e3a5f,#1e40af); color:#93c5fd; border:none;" onclick="showSocialWindow()">ğŸ¤ ç¤¾ä¼šå…³ç³»</button>
            <button class="sys-btn" style="background:linear-gradient(135deg,#064e3b,#065f46); color:#6ee7b7; border:none;" onclick="showMonthlyTargets()">ğŸ¯ æœˆåº¦ç›®æ ‡</button>
            <button class="sys-btn" style="background:linear-gradient(135deg,#4c1d95,#5b21b6); color:#c4b5fd; border:none;" onclick="showOlympiadSystem()">ğŸ† å­¦ç§‘ç«èµ›</button>
            <button class="sys-btn" onclick="hardReset()" style="color:var(--danger)">ğŸ”„ æŠ¹é™¤å­˜æ¡£</button>
        </div>
    </div>

    <div class="panel">
        <h2 class="panel-title">ğŸ“Š è´¢åŠ¡ä¸è¡Œæ”¿ä¸­æ¢</h2>
        <div class="res-grid">
            <div class="res-box">æ€»èµ„é‡‘(ä¸‡) <span id="ui-funds" style="color:#059669;">100</span><div class="res-sub" id="ui-salary">å¸¸è€—:-0 ä¸“å®¶:-0</div></div>
            <div class="res-box">åœ¨æ ¡ç”Ÿè§„æ¨¡ <span id="ui-students" style="color:#2563eb;">300</span></div>
            <div class="res-box">ç¤¾ä¼šå£°èª‰ <span id="ui-rep" style="color:var(--warning)">100</span></div>
            <div class="res-box">è¡Œæ”¿ AP <span><span id="ui-ap">10</span>/<span id="ui-maxap">20</span></span></div>
        </div>

        <h2 class="panel-title" style="margin-top: 5px;">ğŸ§¬ ç”Ÿæºå…­ç»´ (å½±å“å…¨æ ¡æˆ˜åŠ›)</h2>
        <div class="blackboard">
            <div class="stat-row"><div class="stat-label">ğŸ“š å­¦ä¸š(æ”»å‡»)</div><div class="bar-bg"><div id="bar-grade" class="bar-fill" style="background:linear-gradient(90deg, #3b82f6, #60a5fa);"></div></div><div class="stat-val" id="val-grade">40</div></div>
            <div class="stat-row" style="margin-bottom:0;"><div class="stat-label">ğŸ¤¯ å‹åŠ›(ç†µå¢)</div><div class="bar-bg"><div id="bar-stress" class="bar-fill" style="background:linear-gradient(90deg, #ef4444, #f87171);"></div></div><div class="stat-val" id="val-stress">20</div></div>
            <div class="stress-warning" id="warn-stress">âš ï¸ è­¦å‘Šï¼šæ€ç»´ç†µå¢æ¿’ä¸´å´©æºƒæé™ï¼</div>
            <div class="stat-row" style="margin-top:10px;"><div class="stat-label">ğŸ›¡ï¸ çºªå¾‹(é˜²å¾¡)</div><div class="bar-bg"><div id="bar-disc" class="bar-fill" style="background:linear-gradient(90deg, #f59e0b, #fbbf24);"></div></div><div class="stat-val" id="val-disc">60</div></div>
            <div class="stat-row"><div class="stat-label">ğŸƒâ€â™‚ï¸ ä½“è´¨(è¡€é‡)</div><div class="bar-bg"><div id="bar-fit" class="bar-fill" style="background:linear-gradient(90deg, #10b981, #34d399);"></div></div><div class="stat-val" id="val-fit">50</div></div>
            <div class="stat-row"><div class="stat-label">ğŸ¨ è‰ºæœ¯(æš´å‡»)</div><div class="bar-bg"><div id="bar-art" class="bar-fill" style="background:linear-gradient(90deg, #8b5cf6, #a78bfa);"></div></div><div class="stat-val" id="val-art">30</div></div>
        </div>
    </div>

    <div class="panel">
        <div style="text-align: center; margin-bottom: 15px; background:#f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div id="ui-date" style="font-size: 1.6rem; font-weight: 900; color: var(--primary); letter-spacing: 1px;">2018å¹´ 9æœˆ</div>
        </div>
        <button class="btn-main" id="btn-advance" onclick="advanceMonth()">â³ æ¨è¿›ä¸€ä¸ªæœˆ (è§¦å‘äº‹ä»¶/è”è€ƒ/æ”¶å­¦è´¹)</button>

        <h2 class="panel-title">ğŸ§  æˆ˜å¤‡ä¸­æ¢</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom:15px;">
            <button class="btn" style="background:#ecfdf5; border-color:#10b981;" onclick="openModal('modal-map')">ğŸ—ºï¸ æ ¡å›­åŸºå»ºæ‰©å»º<span class="btn-desc">3çº§ç‰¹æŠ€å»ºç­‘è§£é”</span></button>
            <button class="btn" style="background:#fff7ed; border-color:#f97316;" onclick="if(!game||!game.map)return showToast('è¯·å…ˆé€‰æ‹©éš¾åº¦ï¼');openModal('modal-shop');renderShop('infra')">ğŸ›’ ç‰¹ä¾›å•†åº—<span class="btn-desc">è“å›¾Â·é“å…·Â·æ”¿ç­–é€Ÿé€š</span></button>
            <button class="btn" style="background:#fdf4ff; border-color:#c026d3;" onclick="openModal('modal-rnd')">ğŸ”­ è£…å¤‡ç ”å‘ä¸­å¿ƒ<span class="btn-desc">å·Â·ç»„åˆæŠ€Â·æ•™å­¦è£…å¤‡</span></button>
            <button class="btn" style="background:#eff6ff; border-color:#3b82f6;" onclick="openModal('modal-experts')">ğŸ‘¨â€ğŸ« å¯»è®¿é¡¶çº§åå¸ˆ<span class="btn-desc">40ä½ä¸“å®¶+å¼ºåŠ›æˆ˜æŠ€</span></button>
            <button class="btn" style="background:#faf5ff; border-color:#a855f7;" onclick="openScheduleModal()">ğŸ“… å¸ˆèµ„ä¸ä¸»ç§‘æ’è¯¾<span class="btn-desc">ä¼˜åŒ–æ’è¯¾ç®—æ³•</span></button>
            <button class="btn" style="background:#fefce8; border-color:#eab308;" onclick="openModal('modal-policy')">ğŸ« å›½å®¶æ ¡ç­–ç§‘æŠ€æ ‘<span class="btn-desc">æ•™ç ”ç‚¹: <span id="ui-eduPoints" style="font-weight:bold;color:var(--danger)">0</span></span></button>
        </div>

        <h2 class="panel-title">ğŸ¯ æˆ˜æœ¯ä¸å¤§åŠ¿</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <button class="btn" onclick="organizeExam()">ğŸ“ æ¨¡æ‹Ÿé˜…å·å‡ºåˆ†<span class="btn-desc">è€—AP:3, ï¿¥<span id="cost-exam" class="c-val">2</span>ä¸‡ | å…­æ¡£åˆ†æ+æ•™ç ”ç‚¹</span></button>
            <button class="btn" onclick="showGaokaoHistory()">ğŸ“Š å†å¹´é«˜è€ƒæˆç»©<span class="btn-desc">æŸ¥çœ‹å†å¹´æˆç»©æŸ±çŠ¶å›¾</span></button>
            <button class="btn" id="btn-final-rating" onclick="showFinalRating('principal')" style="background:#faf5ff;border-color:#7c3aed;display:none;">ğŸ æŸ¥çœ‹å½“å‰ç»“å±€<span class="btn-desc">è¯„çº§Â·æ ¡å‹å›è®¿Â·ç»ˆæœ«è¯—</span></button>
            <button class="btn" onclick="openModal('modal-branches')">ğŸŒ å»ºç«‹å…¨çƒåˆ†æ ¡<span class="btn-desc">è€—å·¨èµ„å»ºç«‹éœ¸ä¸šåˆ†æ ¡</span></button>
            <button class="btn" onclick="runAction('sponsor')">ğŸ¤ å®´è¯·æ‹‰èµåŠ©<span class="btn-desc">è€—AP:4, é™å£°èª‰ | å¾—ï¿¥<span id="gain-spo" style="color:var(--success)">100</span>ä¸‡</span></button>
            <button class="btn" onclick="openModal('modal-achieve')">ğŸ† è£èª‰ä¸æ ¡å‹å½•<span class="btn-desc">æˆå°±è§£é”ä¸åäººå ‚</span></button>
        </div>
    </div>

    <div class="panel" style="display: flex; flex-direction: column;">
        <h2 class="panel-title">ğŸ“¨ ç‹¬ç«‹å­¦ç”Ÿä¿¡ç®± (å®æ—¶çªƒå¬)</h2>
        <div id="student-comments-box" class="mailbox-container"></div>

        <h2 class="panel-title">ğŸ“œ çºªäº‹æœ¬æœ«</h2>
        <div class="log-box" id="log-box"></div>
    </div>
</div>

<!-- ================= å­¦ç”Ÿæ¨¡å¼ ================= -->
<div id="student-container">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 3px solid var(--purple); padding-bottom:10px; margin-bottom:20px;">
        <h1 style="margin:0; color:var(--purple);">ğŸ‘¨â€ğŸ“ å­¦ç”Ÿè§†è§’ï¼šäººç”Ÿè½®å›æ¨¡æ‹Ÿå™¨</h1>
        <div style="display:flex; align-items:center; gap:15px;">
            <span class="rebirth-points">â˜¯ï¸ è½®å›ç‚¹æ•°: <span id="stu-ui-rp">0</span></span>
            <button class="sys-btn" style="background:linear-gradient(135deg,#1e1b4b,#312e81); color:#a5b4fc; border:none;" onclick="showStuJournal()">ğŸ““ å†…å¿ƒæ—¥è®°</button>
            <button class="sys-btn" onclick="switchMode('principal')">ğŸ”™ æ”¾å¼ƒå­¦ä¸šï¼Œè¿”å›æ ¡é•¿æ¨¡å¼</button>
        </div>
    </div>

    <div id="stu-setup" style="text-align:center; padding: 20px;">
        <h2>ç¬¬ä¸€æ­¥ï¼šä½ çš„åŸç”Ÿå®¶åº­å†³å®šäº†èµ·è·‘çº¿</h2>
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top:20px;" id="stu-family-grid"></div>
        
        <h2 style="margin-top:40px;">ç¬¬äºŒæ­¥ï¼šæ¶ˆè€—è½®å›ç‚¹è´­ä¹°å‰ä¸–é—æ³½</h2>
        <div style="display:flex; justify-content:center; gap:15px; margin-top:15px;" id="stu-talent-grid">
            <button class="btn" onclick="buyTalent('genius', 20, this)">ğŸ§  è¿‡ç›®ä¸å¿˜ (20ç‚¹)<br><span class="btn-desc">æ¯æ¬¡å­¦ä¹ é¢å¤–+3å­¦ä¸š</span></button>
            <button class="btn" onclick="buyTalent('rich', 15, this)">ğŸ’° éšå½¢å¯Œè±ª (15ç‚¹)<br><span class="btn-desc">å¼€å±€è‡ªå¸¦ï¿¥1000å·¨é¢èµ„é‡‘</span></button>
            <button class="btn" onclick="buyTalent('charm', 10, this)">âœ¨ ç»ä¸–å®¹é¢œ (10ç‚¹)<br><span class="btn-desc">å¼€å±€é­…åŠ›+40ï¼Œæ‹çˆ±æ˜“å¦‚åæŒ</span></button>
        </div>
        <button class="btn-main" style="width:300px; margin-top:30px; font-size:1.5rem;" onclick="startStudentGameplay()">âœ¨ é™ç”Ÿï¼Œå¼€å¯æ ¡å›­ç”Ÿæ´»</button>
    </div>

    <div id="stu-gameplay" style="display:none;" class="stu-grid">
        <!-- å·¦ä¾§çŠ¶æ€ -->
        <div>
            <div class="stu-stat-box">
                <h3 style="margin-top:0; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;">ğŸ“Š ä¸ªäººçŠ¶æ€é¢æ¿</h3>
                <div>ğŸ“† è¿›åº¦: é«˜<span id="stu-ui-year">ä¸€</span> <span id="stu-ui-month">ä¸Š</span>å­¦æœŸ (<span id="stu-ui-turn">1</span>/36)</div>
                <div style="font-size:0.8rem; color:#cbd5e1; margin-top:5px;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å®¶åº­èƒŒæ™¯: <span id="stu-ui-family">åŠ è½½ä¸­</span></div>
                <div style="font-size:0.8rem; color:#fde047; margin-top:5px; font-weight:bold;">ğŸ’µ é›¶èŠ±é’±: ï¿¥<span id="stu-val-money">0</span></div>
                
                <!-- ç²¾åŠ›æ¡ -->
                <div style="margin-top:10px; background:rgba(0,0,0,0.5); border-radius:4px; padding:2px; border:1px solid #4ade80;">
                    <div style="font-size:0.7rem; color:#4ade80; text-align:center;">âš¡ æœ¬æœˆç²¾åŠ› <span id="stu-val-energy">100</span>/100</div>
                    <div style="height:6px; background:#4ade80; width:100%; transition:0.3s;" id="stu-bar-energy"></div>
                </div>

                <div style="margin-top:10px;">
                    <div style="display:flex; justify-content:space-between;"><span>ğŸ“š å­¦ä¸šæŒæ§</span> <span id="stu-val-grade" style="color:var(--chalk-yellow);font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>ğŸ¤¯ ç²¾ç¥å‹åŠ›</span> <span id="stu-val-stress" style="color:#fca5a5;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>ğŸƒâ€â™‚ï¸ èº«ä½“ç´ è´¨</span> <span id="stu-val-fit" style="color:#a7f3d0;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>ğŸ¨ ä¸ªäººé­…åŠ›</span> <span id="stu-val-art" style="color:#c4b5fd;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; border-top:1px dashed #475569; padding-top:5px;">
                        <span style="color:#fbbf24">ğŸ¥‡ å¥¥èµ›: <span id="stu-val-oly">0</span>%</span>
                        <span style="color:#60a5fa" id="stu-lover-tag">ğŸ’” å•èº«ç‹—</span>
                    </div>
                </div>
            </div>

            <div class="exam-board">
                <h3 style="margin:0 0 5px 0;">ä¸Šæœˆå¤§å‹è”è€ƒæˆç»©</h3>
                <div style="font-size:3rem; font-weight:900; line-height:1;" id="stu-exam-score">--</div>
                <div style="font-size:0.9rem; margin-top:5px; opacity:0.9;" id="stu-exam-rank">å…¨æ ¡æ’å: å°šæœªè¿›è¡Œ</div>
            </div>

            <button class="btn-main" style="background:#475569; margin-top:10px;" onclick="endStudentMonth()">ğŸ›Œ ç¡è§‰ (ç»“æŸæœ¬æœˆ)</button>
        </div>

        <!-- ä¸­é—´åŠ¨ä½œåŒº -->
        <div class="stu-action-col" style="display:flex; flex-direction:column; height:100%;">
            <h2 style="margin-top:0;">ğŸ¯ æœ¬æœˆè¡ŒåŠ¨ (æ¶ˆè€—ç²¾åŠ›)</h2>
            <div class="stu-act-grid" style="overflow-y:auto; max-height:480px;">
                <button class="stu-act-btn" onclick="stuAct('hard_study')"><span class="stu-icon">âœï¸</span><div><b>ç‹‚åˆ·çœŸé¢˜ç†¬å¤œ</b><span class="btn-sub">è€—èƒ½:40|å­¦ä¸š++,å¤§å¢å‹</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('study')"><span class="stu-icon">ğŸ“–</span><div><b>è®¤çœŸå¬è®²</b><span class="btn-sub">è€—èƒ½:25|å­¦ä¸š+,å‹åŠ›â†‘</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('olympiad')"><span class="stu-icon">ğŸ”¬</span><div><b>æ­»ç£•å¥¥èµ›</b><span class="btn-sub">è€—èƒ½:50|æ»¡100ä¿é€</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('mun')"><span class="stu-icon">ğŸŒ</span><div><b>æ¨¡æ‹Ÿè”åˆå›½</b><span class="btn-sub">è€—èƒ½:50|å­¦ä¸š+é­…åŠ›++</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('work')"><span class="stu-icon">ğŸ”</span><div><b>å¿«é¤åº—æ‰“å·¥</b><span class="btn-sub">è€—èƒ½:30|èµšé’±è€—ä½“è´¨</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('scalper')"><span class="stu-icon">ğŸ«</span><div><b>å€’å–å‘¨è¾¹</b><span class="btn-sub">è€—èƒ½:30|é«˜é£é™©èµšé’±</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('esport')"><span class="stu-icon">ğŸ®</span><div><b>ç”µç«è”èµ›</b><span class="btn-sub">è€—èƒ½:40|èµ¢äº†çˆ†èµšå‡å‹</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('show')"><span class="stu-icon">ğŸ¤</span><div><b>æ‰è‰ºå¤§èµ›</b><span class="btn-sub">è€—èƒ½:40|éœ€é«˜é­…åŠ›</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('sport')"><span class="stu-icon">ğŸ€</span><div><b>ç¤¾å›¢æ‰“çƒ</b><span class="btn-sub">è€—èƒ½:25|ä½“è´¨++é­…åŠ›+</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('book')"><span class="stu-icon">ğŸ“š</span><div><b>å›¾ä¹¦é¦†é—²ä¹¦</b><span class="btn-sub">è€—èƒ½:20|é­…åŠ›++å¾®å‡å‹</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('rooftop')"><span class="stu-icon">ğŸŒ†</span><div><b>å¤©å°å‘å‘†</b><span class="btn-sub">è€—èƒ½:20|å‹åŠ›å°å¹…â†“</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('sick')"><span class="stu-icon">ğŸ¥</span><div><b>è£…ç—…èººå¹³</b><span class="btn-sub">è€—èƒ½:10|å­¦ä¸š--å‡å‹</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('diary')"><span class="stu-icon">ğŸ““</span><div><b>å†™æ—¥è®°</b><span class="btn-sub">è€—èƒ½:10|å‡å‹è§£é”ç»“å±€</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('volunteer')"><span class="stu-icon">ğŸ¤</span><div><b>å¿—æ„¿æœåŠ¡</b><span class="btn-sub">è€—èƒ½:25|ç»¼æµ‹é­…åŠ›++</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('club_drama')"><span class="stu-icon">ğŸ­</span><div><b>è¯å‰§ç¤¾æ’ç»ƒ</b><span class="btn-sub">è€—èƒ½:35|é­…åŠ›+++å¤§å‡å‹</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('tutor')"><span class="stu-icon">ğŸ‘¨â€ğŸ«</span><div><b>ç»™å­¦å¼Ÿè¡¥è¯¾</b><span class="btn-sub">è€—èƒ½:30|èµšé’±+å­¦ä¸š</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('fight')"><span class="stu-icon">ğŸ¥Š</span><div><b>å’Œéš”å£æ‰“æ¶</b><span class="btn-sub">è€—èƒ½:20|é«˜é£é™©çºªå¾‹ç½š</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('confession_prep')"><span class="stu-icon">ğŸ’Œ</span><div><b>ç­–åˆ’è¡¨ç™½</b><span class="btn-sub">è€—èƒ½:40|æå‡æ”»ç•¥ç‡</span></div></button>
            </div><!-- close stu-act-grid -->
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:8px; height: 100px; overflow-y:auto; font-size:0.78rem; margin-top:8px;" id="stu-log-box"></div>
        </div><!-- close middle column -->

        <!-- å³ä¾§ç¤¾äº¤åŒº -->
        <div style="display:flex; flex-direction:column; overflow:hidden;">
            <div style="background:#fff; border:2px solid #fbcfe8; border-radius:8px; padding:15px; margin-bottom:15px; display:flex; flex-direction:column; flex:1; overflow-y:auto;">
                <h3 style="margin:0 0 10px 0; color:#db2777;">ğŸ’Œ æ ¡å›­å¿ƒè·³å›å¿†</h3>
                <p style="font-size:0.7rem; color:#94a3b8; margin:0 0 10px 0;">ä¸åŒçš„æ”¿ç­–ä¼šæå¤§å½±å“æ”»ç•¥éš¾åº¦ã€‚è¯·é€‰æ‹©ä½ çš„ç¾ç»Šå¯¹è±¡ï¼š</p>
                <div id="stu-crush-container" style="display:grid; grid-template-columns:1fr 1fr; gap:6px;"></div>
            </div>

            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:15px; flex:0 0 auto;">
                <h3 style="margin:0 0 10px 0;">ğŸ‘¬ åŒæ¡Œä¸æ­»å…šç¾ç»Š</h3>
                <div id="stu-friends-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- ================= æ¨¡æ€æ¡†ç»„ ================= -->
<div id="modal-map" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>ğŸ—ºï¸ æ ¡å›­åŸºå»ºè§„åˆ’ä¸ç‰¹çº§å‡çº§ (20åœ°å—)</div><button class="fs-close" onclick="closeModal('modal-map')">Ã—</button></div>
        <div class="fs-body map-fs-body" style="display:grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            <div>
                <div class="map-grid" id="map-grid"></div>
                <div style="margin-top:12px;">
                    <div style="font-weight:bold;color:#1e293b;margin-bottom:6px;">âœ¨ æ¿€æ´»ä¸­çš„ç›¸é‚»åŠ æˆ</div>
                    <div id="adjacency-panel" style="display:flex;flex-direction:column;gap:5px;"></div>
                </div>
            </div>
            <div style="background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:15px; overflow-y:auto;">
                <h3 style="margin-top:0; border-bottom:2px solid #e2e8f0; padding-bottom:8px;">ğŸ› ï¸ å·¥ç¨‹å›¾çº¸</h3>
                <p id="map-hint" style="color:var(--danger); font-size:0.9rem;">è¯·å…ˆåœ¨å·¦ä¾§ç‚¹é€‰ä¸€å—ç©ºåœ°æˆ–å·²å»ºå»ºç­‘ï¼</p>
                <div id="fac-list" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </div>
    </div>
</div>

<div id="modal-experts" class="fs-modal">
    <div class="fs-content" style="max-width:1100px;">
        <div class="fs-header"><div>ğŸ‘¨â€ğŸ« çŒå¤´å¯»è®¿ç³»ç»Ÿ (40ä½é¡¶çº§åå¸ˆ/è§£é”æˆ˜æŠ€)</div><button class="fs-close" onclick="closeModal('modal-experts')">Ã—</button></div>
        <div class="fs-body">
            <div style="text-align:center; margin-bottom:20px;">
                <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap; align-items:center;">
                    <button class="btn-main" style="width:auto; padding:15px 40px; font-size:1.5rem;" onclick="gachaExpert()">ğŸ² æ”¯ä»˜ ï¿¥50ä¸‡ å¯»è®¿ä¸“å®¶</button>
                    <button class="btn-main" style="width:auto; padding:15px 40px; font-size:1.5rem; background:linear-gradient(135deg,#7c3aed,#4f46e5);" onclick="gachaExpert10()">âœ¨ åè¿å¯»è®¿ ï¿¥450ä¸‡ <span style="font-size:0.85rem;opacity:0.85;">ï¼ˆä¹æŠ˜ä¼˜æƒ ï¼‰</span></button>
                </div>
                <p style="color:#ef4444; font-size:0.9rem; font-weight:bold;">âš ï¸ æ³¨æ„ï¼šè¶Šå¼ºåŠ›çš„ä¸“å®¶ï¼Œæ¯æœˆçš„è–ªèµ„ç»´æŠ¤è´¹è¶Šé«˜ï¼å°å¿ƒç ´äº§ï¼</p>
            </div>
            <div class="grid-sys" id="expert-container"></div>
        </div>
    </div>
</div>

<div id="modal-branches" class="fs-modal">
    <div class="fs-content" style="max-width:800px;">
        <div class="fs-header"><div>ğŸŒ å…¨çƒåˆ†æ ¡ç½‘ç»œ (æä¾›è¢«åŠ¨åŠ æˆä¸æˆ˜æ–—å±æ€§)</div><button class="fs-close" onclick="closeModal('modal-branches')">Ã—</button></div>
        <div class="fs-body">
            <p style="color:#64748b; margin-bottom:20px;">å»ºç«‹åˆ†æ ¡éœ€è¦å·¨é¢èµ„é‡‘ï¼Œä½†èƒ½æä¾›å¼ºå¤§çš„è¢«åŠ¨å…‰ç¯ï¼Œå¹¶åœ¨è”è€ƒæˆ˜äº‰ä¸­ä¸ºæ‚¨æä¾›é¢å¤–çš„å±æ€§åŠ æˆã€‚</p>
            <div id="branch-container" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"></div>
        </div>
    </div>
</div>

<div id="modal-schedule" class="fs-modal">
    <div class="fs-content" style="max-width: 600px; height:auto;">
        <div class="fs-header"><div>ğŸ“… å¸ˆèµ„è°ƒåº¦ä¸è¯¾è¡¨åˆ¶å®š</div><button class="fs-close" onclick="closeModal('modal-schedule')">Ã—</button></div>
        <div class="fs-body">
            <div style="background:#fee2e2; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.85rem; color:#991b1b; border:1px solid #fca5a5;" id="sch-warn-box"><b>âš ï¸ å±é™©è­¦å‘Šï¼š</b>ä¸»ç§‘æ’è¯¾æ•°è‹¥è¶…è¿‡ <b>25èŠ‚</b>ï¼Œäº§ç”Ÿçš„æ€ç»´ç†µå¢å°†å‘ˆ<b>æŒ‡æ•°çº§çˆ†ç‚¸</b>ï¼</div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn" onclick="upgradeTeacher('main')" style="flex:1">ä¸»ç§‘ç»„å‡çº§<br><span id="tch-main" style="color:var(--primary); font-size:1.1rem;">å®ä¹ </span></button>
                <button class="btn" onclick="upgradeTeacher('minor')" style="flex:1">å‰¯ç§‘ç»„å‡çº§<br><span id="tch-minor" style="color:var(--primary); font-size:1.1rem;">å®ä¹ </span></button>
                <button class="btn" onclick="upgradeTeacher('spec')" style="flex:1">ç´ è´¨ç»„å‡çº§<br><span id="tch-spec" style="color:var(--primary); font-size:1.1rem;">å®ä¹ </span></button>
            </div>
            <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; display:flex; flex-direction:column; gap:15px;">
                <div><b>ğŸ“š ä¸»ç§‘è¯¾æ—¶ (é«˜å‹/é«˜æ”»)</b> <span id="lbl-main-hr" style="color:var(--danger); font-weight:bold;">20èŠ‚</span><input type="range" id="range-main" min="0" max="40" value="20" style="width:100%;pointer-events:none;opacity:0.7;" tabindex="-1"></div>
                <div><b>ğŸ”¬ å‰¯ç§‘è¯¾æ—¶ (ä¸­å‹/é˜²å®ˆ)</b> <span id="lbl-minor-hr" style="color:var(--primary); font-weight:bold;">15èŠ‚</span><input type="range" id="range-minor" min="0" max="40" value="15" style="width:100%;pointer-events:none;opacity:0.7;" tabindex="-1"></div>
                <div><b>ğŸ¨ ç´ è´¨è¯¾æ—¶ (é™å‹/æš´å‡»)</b> <span id="lbl-spec-hr" style="color:var(--success); font-weight:bold;">5èŠ‚</span><input type="range" id="range-spec" min="0" max="40" value="5" style="width:100%;pointer-events:none;opacity:0.7;" tabindex="-1"></div>
                <div style="text-align:right; font-size:0.9rem; font-weight:bold;">å½“å‰å‘¨è¯¾æ—¶æ€»é‡: <span id="sch-total-hr" style="color:var(--primary)">40</span>/60</div>
            </div>
            <!-- å‘¨è¯¾è¡¨å¯è§†åŒ– -->
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:15px; margin-top:10px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <h3 style="margin:0;font-size:1rem;">ğŸ“‹ æœ¬å‘¨è¯¾è¡¨ (ç‚¹å‡»æ ¼å­æ‰‹åŠ¨è°ƒæ•´)</h3>
                    <button class="btn" style="padding:4px 10px;font-size:0.8rem;" onclick="randomizeSchedule()">ğŸ² éšæœºæ’è¯¾</button>
                </div>
                <div id="weekly-timetable" style="display:grid;grid-template-columns:60px repeat(5,1fr);gap:3px;font-size:0.75rem;"></div>
                <div style="margin-top:8px;display:flex;gap:10px;font-size:0.72rem;">
                    <span style="background:#fecaca;padding:2px 6px;border-radius:3px;">ğŸ“š ä¸»ç§‘</span>
                    <span style="background:#bfdbfe;padding:2px 6px;border-radius:3px;">ğŸ”¬ å‰¯ç§‘</span>
                    <span style="background:#bbf7d0;padding:2px 6px;border-radius:3px;">ğŸ¨ ç´ è´¨</span>
                    <span style="background:#f1f5f9;padding:2px 6px;border-radius:3px;">â€” ç©ºè¯¾</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-policy" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>ğŸ« å›½å®¶æ ¡ç­–ç§‘æŠ€æ ‘ (å››å¤§æµæ´¾ 40é¡¹èŠ‚ç‚¹)</div><button class="fs-close" onclick="closeModal('modal-policy')">Ã—</button></div>
        <div class="fs-body">
            <div style="text-align:center; margin-bottom:20px; font-weight:bold;">
                <span style="color:var(--danger); margin-right:15px;">ğŸŸ¥ æé™åº”è¯•çº¿</span>
                <span style="color:var(--warning); margin-right:15px;">ğŸŸ¨ é“è…•çºªå¾‹çº¿</span>
                <span style="color:#fbbf24; margin-right:15px;">ğŸŸ¤ èµ„æœ¬è¿ä½œçº¿</span>
                <span style="color:var(--success);">ğŸŸ© ç´ è´¨å¼€æ”¾çº¿</span>
            </div>
            <div id="policy-container" style="display:flex; flex-direction:column; align-items:center;"></div>
        </div>
    </div>
</div>

<div id="modal-achieve" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>ğŸ† è£èª‰å²å†Œä¸æ°å‡ºæ ¡å‹</div><button class="fs-close" onclick="closeModal('modal-achieve')">Ã—</button></div>
        <div class="fs-body">
            <h3 style="margin-top:0; border-bottom:2px solid #cbd5e1; padding-bottom:5px;">ğŸ“ çŸ¥åæ ¡å‹å½• (å­¦ç”Ÿæ¨¡å¼é€šå…³ç•™å)</h3>
            <div id="alumni-container" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:25px;"></div>
            <h3 style="border-bottom:2px solid #cbd5e1; padding-bottom:5px;">ğŸ† ç»ˆææˆå°± (25é¡¹)</h3>
            <div class="grid-sys" id="achieve-container"></div>
        </div>
    </div>
</div>

<!-- ================= å²è¯—çº§å­¦æœ¯æˆ˜äº‰ PVE UI ================= -->
<div id="modal-battle" class="fs-modal" style="background: rgba(0,0,0,0.95); z-index: 6000;">
    <div class="fs-content" style="max-width: 1000px; background: transparent; box-shadow: none; border: 1px solid #3f6212; height:auto;">
        <div class="battle-ui" id="b-main">
            <div id="b-screen-flash"></div>
                <div>[ACADEMIC_WARFARE_OS_v2.0]</div>
                <div style="color:#bef264">>>> ROUND: <span id="b-turn-ui">1</span> / <span id="b-phase-ui" style="color:#fde047">NORMAL_PHASE</span> <<<</div>
            </div>
            
            <div class="b-arena">
                <div class="b-weather" id="b-weather-ui">â›… å¤©æ°”ï¼šæ™´æœ—</div>
                <!-- ç©å®¶é˜µè¥ -->
                <div class="b-entity" id="b-player-card">
                    <div class="b-name" style="color:#93c5fd">> ç©å®¶æœ¬æ ¡é˜µè¥_</div>
                    <div class="b-hp-bg"><div class="b-hp-fill" id="bp-hp-bar"></div><div class="b-hp-txt" id="bp-hp-txt">100 / 100</div></div>
                    <div class="b-stat-grid">
                        <div>æ€ç»´å¼ºåº¦: <span id="bp-atk" style="color:#fff">0</span></div>
                        <div>é€»è¾‘ä¸¥å¯†: <span id="bp-def" style="color:#fff">0</span></div>
                        <div>çµæ„Ÿè¿¸å‘: <span id="bp-crit" style="color:#fde047">0</span>%</div>
                        <div>å­¦æœ¯AP: <span id="bp-ap" style="color:#fbbf24">0</span></div>
                    </div>
                    <div style="margin-top:5px; font-size:0.7rem;">æ€ç»´ç†µå¢: <span id="bp-stress" style="color:#f59e0b">20</span> / 100 <span style="color:#64748b;font-size:0.65rem;">(â‰¥70æ··ä¹±Â·â‰¥100å´©æºƒ)</span></div>
                    <div class="b-stress-bar"><div class="b-stress-fill" id="bp-stress-bar"></div></div>
                    <div class="b-buffs" id="bp-buffs">BUFFS: NONE</div>
                </div>

                <div style="font-size:3rem; font-weight:900; color:#ef4444; font-family:monospace;">VS</div>

                <!-- æ•Œæ–¹AIé˜µè¥ -->
                <div class="b-entity" id="b-enemy-card">
                    <div class="b-name" style="color:#fca5a5" id="be-name">> æ•Œæ–¹ç›®æ ‡_</div>
                    <div class="b-hp-bg" style="border-color:#fca5a5"><div class="b-hp-fill" id="be-hp-bar" style="background:#dc2626"></div><div class="b-hp-txt" id="be-hp-txt">100 / 100</div></div>
                    <div class="b-stat-grid" style="color:#fca5a5">
                        <div>æ€ç»´å¼ºåº¦: <span id="be-atk" style="color:#fff">0</span></div>
                        <div>é€»è¾‘ä¸¥å¯†: <span id="be-def" style="color:#fff">0</span></div>
                        <div style="grid-column:1/-1; border-top:1px dashed #fca5a5; padding-top:4px; margin-top:2px;">
                            <b style="color:#fde047">BOSSç‰¹æ€§:</b> <span id="be-skill-desc" style="color:#fff">æœªçŸ¥</span>
                        </div>
                    </div>
                    <div style="margin-top:5px; font-size:0.7rem; color:#fca5a5">æ€ç»´ç†µå¢: <span id="be-stress">0</span> / 100</div>
                    <div class="b-stress-bar" style="border-color:#fca5a5"><div class="b-stress-fill" id="be-stress-bar" style="background:#991b1b"></div></div>
                    <div class="b-buffs" id="be-buffs">BUFFS: NONE</div>
                </div>
            </div>

            <!-- æˆ˜æ–—æ’­æŠ¥ç»ˆç«¯ (é«˜åº¦è‡ªé€‚åº”) -->
            <div class="b-log" id="b-log">
                <div class="b-log-inner">
                    <span class="sys">SYSTEM BOOT... ACADEMIC INTERFACE ENGAGED.</span><br>
                    <span class="sys">WAITING FOR EXAM TO START...</span>
                </div>
            </div>

            <div class="b-expert-select" id="b-expert-list"></div>

            <!-- æ“ä½œå° (å›ºå®šåº•éƒ¨) -->
            <div class="b-actions" id="b-action-panel">
                <div class="b-cats">
                    <button class="b-cat-btn" id="cat-atk" onclick="bShowCat('atk')">[1] å‡ºé¢˜æ”»å‡»ç³»</button>
                    <button class="b-cat-btn" id="cat-def" onclick="bShowCat('def')">[2] è§£é¢˜é˜²å®ˆç³»</button>
                    <button class="b-cat-btn" id="cat-sup" onclick="bShowCat('sup')">[3] å­¦æœ¯ç ”è®¨ç³»</button>
                    <button class="b-cat-btn" id="cat-psy" onclick="bShowCat('psy')">[4] å¿ƒç†å¹²æ‰°ç³»</button>
                    <button class="b-cat-btn" id="cat-insp" onclick="bShowCat('insp')">[5] çµæ„Ÿçˆ†å‘ç³»</button>
                    <button class="b-cat-btn" id="cat-ent" onclick="bShowCat('ent')" style="color:#f472b6;border-color:#be185d;">[6] ç†µå¢æ§åˆ¶ç³»</button>
                    <button class="b-cat-btn" id="cat-sys" onclick="bShowCat('sys')">[7] ä½“ç³»å¿…æ€ç³»</button>
                    <button class="b-cat-btn" id="cat-combo" onclick="bShowCat('combo')" style="color:#fde047;border-color:#b45309;">[8] âœ¨ç»„åˆæŠ€</button>
                    <button class="b-cat-btn" style="color:#94a3b8; border-color:#475569;" onclick="bRetreat()">[ESC] ç»“æŸæˆ˜æ–—</button>
                </div>
                <div class="b-skills" id="b-skills-container">
                    <div style="color:#64748b; margin-top:20px; font-size:0.9rem;">PLEASE SELECT A DISCIPLINE MODULE FROM THE LEFT MENU...</div>
                </div>
            </div>
        </div>
        
        <!-- æˆ˜å‰é€‰å¯¹æ‰‹ç•Œé¢ -->
        <div id="b-prep" style="background:#1e293b; padding:30px; border-radius:12px; display:none; color:#f8fafc; border: 2px solid #334155; height:80vh; overflow-y:auto;">
            <h2 style="text-align:center; margin-top:0; color:#fde047;">> å…¨çœå¤§å‹è”è€ƒç›®æ ‡é€‰æ‹© _</h2>
            <p style="text-align:center; color:#94a3b8; margin-bottom:25px;">è¯·é€‰æ‹©ä½ è¦è®¨ä¼çš„é¡¶çº§åæ ¡ï¼Œèƒœåˆ©å°†è·å¾—å·¨é¢æ ¡çº§ç§¯åˆ†ã€‚</p>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px;">Tier 1: ä¹¡é•‡ä¸å¿çº§ (å…¥é—¨)</h3>
            <div class="grid-sys" id="b-rival-t1"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 2: å¸‚çº§ç¤ºèŒƒ (è¿›é˜¶)</h3>
            <div class="grid-sys" id="b-rival-t2"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 3: çœçº§åæ ¡ (å›°éš¾)</h3>
            <div class="grid-sys" id="b-rival-t3"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 4: å…¨å›½ç™¾å¼º (å™©æ¢¦)</h3>
            <div class="grid-sys" id="b-rival-t4"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 5: ä¼ è¯´çº§ç¥åŸŸ (åœ°ç‹±)</h3>
            <div class="grid-sys" id="b-rival-t5"></div>
            
            <div style="text-align:center; margin-top:30px; margin-bottom:50px;">
                <button class="btn-main" style="background:#475569; width:auto; padding:10px 40px;" onclick="closeModal('modal-battle')">ABORT MISSION (æ’¤é€€æ— æƒ©ç½š)</button>
            </div>
        </div>
    </div>
</div>

<!-- é€šç”¨å¼¹çª— -->
<div id="modal-overlay">
    <div class="modal-content">
        <h2 id="modal-title" style="margin-top:0; color:#1e293b;">æ ‡é¢˜</h2>
        <div id="modal-desc" style="line-height:1.6; margin-bottom:25px; font-size:1rem; color:#475569; text-align:left;">å†…å®¹</div>
        <div id="modal-buttons" style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px;"></div>
    </div>
</div>

<div id="modal-shop" class="fs-modal">
    <div class="fs-content" style="max-width:900px;">
        <div class="fs-header"><div>ğŸ›’ ç‰¹ä¾›å•†åº—</div><button class="fs-close" onclick="closeModal('modal-shop')">Ã—</button></div>
        <div class="fs-body">
            <div style="display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap;" id="shop-tabs">
                <button class="btn" onclick="renderShop('infra')" style="background:#ecfdf5;border-color:#10b981;">ğŸ—ï¸ åŸºå»ºç±»</button>
                <button class="btn" onclick="renderShop('teacher')" style="background:#eff6ff;border-color:#3b82f6;">ğŸ‘¨â€ğŸ« å¸ˆèµ„ç±»</button>
                <button class="btn" onclick="renderShop('policy')" style="background:#faf5ff;border-color:#a855f7;">ğŸ“œ æ”¿ç­–ç±»</button>
                <button class="btn" onclick="renderShop('consume')" style="background:#fefce8;border-color:#eab308;">âš¡ æ¶ˆè€—ç±»</button>
                <button class="btn" onclick="renderShop('special')" style="background:#fff1f2;border-color:#f43f5e;">âœ¨ ç‰¹æ®Šç±»</button>
            </div>
            <div id="shop-content" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;"></div>
        </div>
    </div>
</div>

<div id="modal-rnd" class="fs-modal">
    <div class="fs-content" style="max-width:1000px;">
        <div class="fs-header"><div>ğŸ”¬ è£…å¤‡ç ”å‘ä¸­å¿ƒ</div><button class="fs-close" onclick="closeModal('modal-rnd')">Ã—</button></div>
        <div class="fs-body">
            <div style="display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap;">
                <button class="btn" onclick="renderRnd('scroll')" style="background:#fff7ed;border-color:#f97316;">ğŸ“œ æˆ˜æ–—å·è½´</button>
                <button class="btn" onclick="renderRnd('combo')" style="background:#fdf4ff;border-color:#c026d3;">âš¡ ç»„åˆæŠ€ç ”å‘</button>
                <button class="btn" onclick="renderRnd('equip')" style="background:#f0fdf4;border-color:#16a34a;">ğŸ’ æ•™å­¦è£…å¤‡</button>
            </div>
            <div id="rnd-content"></div>
        </div>
    </div>
</div>

<!-- ===== åè¿æŠ½ overlay ===== -->
<div id="gacha10-overlay">
    <div id="gacha10-grid"></div>
    <div id="gacha10-summary"></div>
    <button id="gacha10-close" onclick="closeGacha10()">ç¡®è®¤æ”¶ä¸‹</button>
</div>

<!-- ===== æŠ½å¡åŠ¨ç”» overlay ===== -->
<div id="gacha-overlay" onclick="closeGachaCard()">
    <div id="gacha-particles"></div>
    <div id="gacha-card">
        <div id="gacha-bg-glow"></div>
        <div id="gacha-duplicate-badge">é‡å¤ Â· å·²é€€æ¬¾</div>
        <div id="gacha-icon">ğŸ‘¨â€ğŸ«</div>
        <div id="gacha-rarity-label">R</div>
        <div id="gacha-name">ä¸“å®¶åç§°</div>
        <div id="gacha-desc">ä¸“å®¶æè¿°</div>
        <div id="gacha-tap-hint">Â· ç‚¹å‡»å…³é—­ Â·</div>
    </div>
</div>

<!-- ===== ç»ˆæœ«ä¹‹è¯— overlay ===== -->
<div id="end-poem-overlay">
    <div id="end-poem-close-btn" onclick="handlePoemClick()" style="display:none;position:fixed;bottom:40px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:rgba(255,255,255,0.7);padding:10px 32px;border-radius:30px;cursor:pointer;font-size:0.85rem;letter-spacing:3px;z-index:100000;">Â· ç‚¹å‡»å…³é—­ Â·</div>
    <div id="end-poem-track">
        <div class="poem-spacer"></div>
        <div class="poem-hint">Â· ç‚¹å‡»å…³é—­ Â·</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line dim">ä½ å¥½ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-line">å¦‚æœä½ è¯»åˆ°è¿™é‡Œï¼Œè¯´æ˜ä½ å·²ç»èµ°å®Œäº†è¿™åœºæ¸¸æˆã€‚</div>
        <div class="poem-line">è°¢è°¢ä½ ï¼Œæ„¿æ„èŠ±å‡ ä¸ªå°æ—¶ï¼Œ</div>
        <div class="poem-line">æ¥ä½“éªŒè¿™æ‰€è™šæ‹Ÿçš„å­¦æ ¡ï¼Œæ¥å½“ä¸€ä¸ªè™šæ‹Ÿçš„æ ¡é•¿ï¼Œ</div>
        <div class="poem-line">æ¥ç»å†é‚£äº›è™šæ‹Ÿçš„èƒœåˆ©ä¸å¤±è´¥ã€æ¬¢ç¬‘ä¸æ³ªæ°´ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-line gold">ä½†æˆ‘æƒ³è¯´çš„æ˜¯ï¼Œè¿™ä¸ªæ¸¸æˆé‡Œçš„ä¸€åˆ‡ï¼Œ</div>
        <div class="poem-line gold">å¯¹å¾ˆå¤šäººæ¥è¯´ï¼Œä»æ¥éƒ½ä¸æ˜¯è™šæ‹Ÿçš„ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-line">é‚£äº›æ·±å¤œåˆ·é¢˜çš„ç–²æƒ«ï¼Œæ˜¯çœŸçš„ã€‚</div>
        <div class="poem-line">é‚£äº›æ’åä¸‹é™çš„ææƒ§ï¼Œæ˜¯çœŸçš„ã€‚</div>
        <div class="poem-line">é‚£äº›è¢«è€å¸ˆå’Œå®¶é•¿å¤±æœ›çš„çœ¼ç¥ï¼Œæ˜¯çœŸçš„ã€‚</div>
        <div class="poem-line">é‚£äº›å› ä¸ºä¸€æ¬¡è€ƒè¯•å¤±åˆ©è€Œæ€€ç–‘è‡ªå·±ä»·å€¼çš„æ„Ÿè§‰ï¼Œæ˜¯çœŸçš„ã€‚</div>
        <div class="poem-line">é‚£äº›åœ¨å®¿èˆé‡Œå·å·å“­è¿‡å´ä¸æ•¢å‡ºå£°çš„å¤œæ™šï¼Œæ˜¯çœŸçš„ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-line italic">é‚£äº›æ”¾å¼ƒäº†ç”»ç”»ã€æ”¾å¼ƒäº†éŸ³ä¹ã€æ”¾å¼ƒäº†å†™ä½œã€æ”¾å¼ƒäº†"æ²¡ç”¨"çš„çƒ­çˆ±ï¼Œæ˜¯çœŸçš„ã€‚</div>
        <div class="poem-line italic">é‚£äº›è¢«ç£¨ç­çš„å¥½å¥‡å¿ƒã€è¢«å‹æŠ‘çš„è¡¨è¾¾æ¬²ã€è¢«æ ‡å‡†åŒ–çš„æ€è€ƒæ–¹å¼ï¼Œæ˜¯çœŸçš„ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-line dim">è¿™ä¸ªæ¸¸æˆé‡Œçš„æ¯ä¸€ä¸ªæ•°å­—ï¼ŒèƒŒåéƒ½å¯èƒ½æœ‰æ— æ•°ä¸ªçœŸå®çš„å¤œæ™šã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line">è¿™ä¸ªæ¸¸æˆé‡Œï¼Œä½ å¯ä»¥é€‰æ‹©å½“ä¸¥è‹›çš„æ ¡é•¿ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©å½“å¼€æ˜çš„æ ¡é•¿ã€‚</div>
        <div class="poem-line">ä½ å¯ä»¥è®©å­¦ç”Ÿæ‹¼å‘½åˆ·é¢˜ï¼Œä¹Ÿå¯ä»¥è®©ä»–ä»¬è‡ªç”±æˆé•¿ã€‚</div>
        <div class="poem-line">ä½ å¯ä»¥è¿½æ±‚å‡å­¦ç‡ï¼Œä¹Ÿå¯ä»¥è¿½æ±‚å¹¸ç¦æ„Ÿã€‚</div>
        <div class="poem-line">ä½ å¯ä»¥èµ¢å¾—æ‰€æœ‰çš„æˆ˜æ–—ï¼Œä¹Ÿå¯ä»¥è¾“æ‰ä¸€äº›ä¸œè¥¿ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-line gold">ä½†æ— è®ºä½ æ€ä¹ˆé€‰ï¼Œè¯·è®°ä½ï¼š</div>
        <div class="poem-line big">é‚£äº›æ•°å­—èƒŒåï¼Œæ˜¯ä¸€ä¸ªä¸ªæ´»ç”Ÿç”Ÿçš„äººã€‚</div>
        <div class="poem-line">é‚£äº›äººï¼Œä¸æ˜¯ä½ æ£‹ç›˜ä¸Šçš„æ£‹å­ã€‚</div>
        <div class="poem-line">ä»–ä»¬æœ‰è‡ªå·±çš„ææƒ§ï¼Œæœ‰è‡ªå·±çš„çƒ­çˆ±ï¼Œæœ‰è‡ªå·±çš„æ¢¦æƒ³â€”â€”</div>
        <div class="poem-line">é‚£äº›æ¢¦æƒ³ï¼Œå¯èƒ½å’Œä½ çš„æœŸæœ›ä¸ä¸€æ ·ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line">å¦‚æœä½ ç©äº†è¿™ä¸ªæ¸¸æˆï¼Œè¯·ç­”åº”æˆ‘ä¸€ä»¶äº‹ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-line">ä¸‹æ¬¡ï¼Œå½“ä½ çœ‹åˆ°èº«è¾¹æœ‰å­¦ç”Ÿä½ç€å¤´èµ°è¿‡çš„æ—¶å€™ï¼Œåˆ«åªæ˜¯çœ‹ä»–çš„æˆç»©ã€‚</div>
        <div class="poem-line gold">çœ‹çœ‹ä»–çš„çœ¼ç›ã€‚é‚£é‡Œå¯èƒ½æœ‰ä½ æ²¡çœ‹è§çš„ä¸œè¥¿ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-line">ä¸‹æ¬¡ï¼Œå½“æœ‰äººå‘Šè¯‰ä½ "æˆ‘æ˜¯ä¸ºä½ å¥½"çš„æ—¶å€™ï¼Œ</div>
        <div class="poem-line gold">é—®é—®è‡ªå·±ï¼šä»–ä»¬å®šä¹‰çš„"å¥½"ï¼ŒçœŸçš„æ˜¯ä½ æƒ³è¦çš„å—ï¼Ÿ</div>
        <div class="poem-spacer"></div>
        <div class="poem-line">ä¸‹æ¬¡ï¼Œå½“ä½ ä¸ºäº†ä¸€ä¸ªç›®æ ‡æ‹¼å‘½å¥”è·‘çš„æ—¶å€™ï¼Œåœä¸‹æ¥å–˜å£æ°”ã€‚</div>
        <div class="poem-line gold">é—®è‡ªå·±ï¼šå¦‚æœè¿™ä¸ªç›®æ ‡æ°¸è¿œè¾¾ä¸åˆ°ï¼Œæˆ‘è¿˜å€¼å¾—è¢«çˆ±å—ï¼Ÿ</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>
        <div class="poem-line big">ç­”æ¡ˆæ˜¯ï¼šå€¼å¾—ã€‚ä½ æ°¸è¿œå€¼å¾—ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-line">ä¸ç®¡ä½ æœ‰æ²¡æœ‰è€ƒä¸Šå¥½å¤§å­¦ï¼Œä¸ç®¡ä½ æœ‰æ²¡æœ‰æ‰¾åˆ°å¥½å·¥ä½œï¼Œ</div>
        <div class="poem-line">ä¸ç®¡ä½ æœ‰æ²¡æœ‰æ´»æˆåˆ«äººæœŸå¾…çš„æ ·å­â€”â€”</div>
        <div class="poem-line">ä½ éƒ½å€¼å¾—è¢«çˆ±ï¼Œè¢«ç†è§£ï¼Œè¢«æ¥çº³ã€‚</div>
        <div class="poem-line gold">ä¸æ˜¯å› ä¸ºä½ ä¼˜ç§€ï¼Œè€Œæ˜¯å› ä¸ºä½ æ˜¯ä½ ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line dim">è¿™ä¸ªæ¸¸æˆç»“æŸäº†ã€‚</div>
        <div class="poem-line dim">ä½†é‚£äº›ååœ¨æ•™å®¤é‡Œçš„å­©å­ï¼Œè¿˜åœ¨ç»§ç»­ã€‚</div>
        <div class="poem-line">å¦‚æœå¯ä»¥ï¼Œè¯·å¯¹ä»–ä»¬æ¸©æŸ”ä¸€ç‚¹ã€‚</div>
        <div class="poem-line gold">å¯¹è‡ªå·±ï¼Œä¹Ÿæ¸©æŸ”ä¸€ç‚¹ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line dim">å¦‚æœè¿™ä¸ªæ¸¸æˆèƒ½è®©ä¸€äº›äººä¼šå¿ƒä¸€ç¬‘ï¼Œ</div>
        <div class="poem-line dim">èƒ½è®©ä¸€äº›äººæƒ³èµ·è‡ªå·±çš„åä¸ƒå²ï¼Œ</div>
        <div class="poem-line dim">èƒ½è®©ä¸€äº›å¤§äººç¨å¾®æƒ³èµ·è‡ªå·±æ›¾ç»ä¹Ÿæ˜¯å­©å­â€”â€”</div>
        <div class="poem-line italic">é‚£å°±å¤Ÿäº†ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line dim">å“¦å¯¹äº†ï¼Œæ¸¸æˆé‡Œçš„"æ ¡é•¿æ¨¡å¼"ï¼ŒæŸç§ç¨‹åº¦ä¸Šæ˜¯æˆ‘åœ¨æƒ³è±¡ä¸€ç§ç†æƒ³çš„æ•™è‚²ã€‚</div>
        <div class="poem-line dim">å¦‚æœæˆ‘æ˜¯æ ¡é•¿ï¼Œæˆ‘ä¼šæ€ä¹ˆåšï¼Ÿæˆ‘ä¼šç»™å­¦ç”Ÿç•™å¤šå°‘ç©ºé—´ï¼Ÿ</div>
        <div class="poem-line dim">æˆ‘ä¼šåœ¨å‡å­¦ç‡å’Œå¹¸ç¦æ„Ÿä¹‹é—´æ€ä¹ˆé€‰ï¼Ÿ</div>
        <div class="poem-line italic">è¿™äº›é—®é¢˜ï¼Œæˆ‘æ²¡æœ‰ç­”æ¡ˆã€‚æˆ‘åªæ˜¯æŠŠå®ƒä»¬æ”¾è¿›æ¸¸æˆé‡Œï¼Œè®©æ¯ä¸ªç©å®¶è‡ªå·±å»å¯»æ‰¾ç­”æ¡ˆã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line">æ¸¸æˆå‘å¸ƒåï¼Œæˆ‘ä¼šæŠŠæ”¶åˆ°çš„æ¯ä¸€ä»½åé¦ˆéƒ½å­˜ä¸‹æ¥ã€‚</div>
        <div class="poem-line">ç­‰åå¹´åï¼ŒäºŒåä¸ƒå²çš„æˆ‘å†å›å¤´çœ‹ï¼Œä¹Ÿè®¸ä¼šç¬‘ç°åœ¨çš„è‡ªå·±å†™å¾—å¹¼ç¨šã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-line gold">ä½†æˆ‘æƒ³å¯¹äºŒåä¸ƒå²çš„è‡ªå·±è¯´ï¼š</div>
        <div class="poem-line">åˆ«å¿˜äº†åä¸ƒå²è¿™å¹´ï¼Œä½ åœ¨å‡Œæ™¨ä¸¤ç‚¹çš„ç¯å…‰ä¸‹ï¼Œæ•²ä¸‹è¿™äº›å­—çš„å¿ƒæƒ…ã€‚</div>
        <div class="poem-line">åˆ«å¿˜äº†ä½ æ›¾ç»æ˜¯è°ã€‚</div>
        <div class="poem-line">åˆ«å¿˜äº†ä½ æ›¾ç»æƒ³æˆä¸ºè°ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line dim">æœ€åï¼Œæˆ‘æƒ³ç”¨ä¸€å¥è¯æ¥ç»“æŸè¿™ç¯‡ç»“è¯­ã€‚</div>
        <div class="poem-line dim">è¿™å¥è¯ä¸æ˜¯æˆ‘å†™çš„ï¼Œæ˜¯ä¸€ä¸ªåä¸ƒå²çš„å¥³å­©åœ¨å¥¹çš„æ—¥è®°é‡Œå†™çš„ã€‚</div>
        <div class="poem-line dim">é‚£æœ¬æ—¥è®°ï¼Œæ˜¯å¥¹å»ä¸–åï¼Œå¥¹å¦ˆå¦ˆå‘ç°çš„ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-line quote">"æˆ‘å¸Œæœ›æœ‰ä¸€å¤©ï¼Œè€ƒè¯•ä¸å†æ˜¯äººç”Ÿçš„åˆ†æ°´å²­ï¼Œè€Œæ˜¯ä¼—å¤šæ²³æµä¸­çš„ä¸€æ¡ã€‚<br>æˆ‘å¸Œæœ›æœ‰ä¸€å¤©ï¼Œæˆ‘å¯ä»¥ä¸ç”¨å› ä¸ºè€ƒå¾—å¥½è€Œè¢«çˆ±ï¼Œä¹Ÿä¸ç”¨å› ä¸ºè€ƒä¸å¥½è€Œå¤±å»çˆ±ã€‚<br>æˆ‘å¸Œæœ›æœ‰ä¸€å¤©ï¼Œæœ‰äººå¯¹æˆ‘è¯´ï¼šä½ ä¸éœ€è¦æˆä¸ºä»»ä½•äººï¼Œä½ åªéœ€è¦æˆä¸ºä½ è‡ªå·±ã€‚"</div>
        <div class="poem-spacer"></div>
        <div class="poem-line">å¥¹æ²¡èƒ½ç­‰åˆ°è¿™ä¸€å¤©ã€‚</div>
        <div class="poem-line gold">ä½†ä¹Ÿè®¸ï¼Œæˆ‘ä»¬å¯ä»¥å¸®å¥¹ç­‰ä¸€ç­‰ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line small">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>
        <div class="poem-spacer"></div>
        <div class="poem-line big" style="font-size:clamp(1rem,3.5vw,1.3rem);letter-spacing:5px;color:#9ca3af;">æ¸¸æˆåˆ¶ä½œäºº Â· ChansonTech</div>
        <div class="poem-line small" style="color:#4b5563;">2026å¹´ æ˜¥</div>
        <div class="poem-spacer"></div>
        <div class="poem-line italic" style="color:#7c3aed;font-size:clamp(0.95rem,2.8vw,1.1rem);">"æ•™è‚²æ˜¯ä¸€æ£µæ ‘æ‘‡åŠ¨å¦ä¸€æ£µæ ‘ï¼Œä¸€æœµäº‘æ¨åŠ¨å¦ä¸€æœµäº‘ï¼Œä¸€ä¸ªçµé­‚å”¤é†’å¦ä¸€ä¸ªçµé­‚ã€‚"</div>
        <div class="poem-line small" style="color:#6d28d9;">â€”â€” é›…æ–¯è´å°”æ–¯</div>
        <div class="poem-spacer"></div>
        <div class="poem-line italic" style="color:#4b5563;font-size:clamp(0.85rem,2.5vw,1rem);">è°¨ä»¥æ­¤æ¸¸æˆï¼ŒçŒ®ç»™æ‰€æœ‰åœ¨åº”è¯•æ•™è‚²ä¸­æŒ£æ‰è¿‡ã€è¿·èŒ«è¿‡ã€åšæŒè¿‡çš„çµé­‚ã€‚</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>
        <div class="poem-line small" style="color:#111827;letter-spacing:6px;">â€” END â€”</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>
    </div>
</div>

<script>
    // ================= åŸºç¡€å­—å…¸æ•°æ® =================
    const DIFF_MODS = { 0: { name: "ç®€å•", startFund: 500, stressMult: 0.4, costMult: 0.6 }, 1: { name: "æ­£å¸¸", startFund: 100, stressMult: 0.7, costMult: 1.0 }, 2: { name: "å›°éš¾", startFund: 50,  stressMult: 1.2, costMult: 1.5 } };
    const SCHOOL_LEVELS = [ 
        { name: "ä¹¡é•‡ä¸­å­¦", baseStu: 300, reqRep: 0, reqFunds: 0, reqGrade: 0, reqExam: 0, upkeep: 8, tuition: 0.15 }, 
        { name: "å¿çº§é‡ç‚¹", baseStu: 1000, reqRep: 300, reqFunds: 100, reqGrade: 45, reqExam: 50, upkeep: 25, tuition: 0.25 }, 
        { name: "å¸‚çº§ç¤ºèŒƒ", baseStu: 2500, reqRep: 1000, reqFunds: 400, reqGrade: 60, reqExam: 150, upkeep: 60, tuition: 0.4 }, 
        { name: "çœçº§åæ ¡", baseStu: 5000, reqRep: 4000, reqFunds: 1500, reqGrade: 80, reqExam: 400, upkeep: 150, tuition: 0.7 }, 
        { name: "å…¨å›½é¡¶å°–", baseStu: 10000, reqRep: 10000, reqFunds: 5000, reqGrade: 92, reqExam: 1000, upkeep: 350, tuition: 1.5 } 
    ];
    const TEACHER_TIERS = [ { name: "å®ä¹ ç”Ÿ", multi: 0.8, upCost: 0, salary: 4 }, { name: "å¸‚éª¨å¹²", multi: 1.2, upCost: 40, salary: 12 }, { name: "ç‰¹çº§åå¸ˆ", multi: 1.8, upCost: 120, salary: 35 } ];
    const FAMILIES = [ {id:'worker', name:"å·¥è–ªé˜¶å±‚", desc:"å®¶å¢ƒæ™®é€šï¼Œä½†çˆ¶æ¯åƒè‹¦è€åŠ³ã€‚å¼€å±€èµ„é‡‘å°‘ï¼ŒæŠ—å‹å¼ºã€‚", money: 200}, {id:'intel', name:"ä¹¦é¦™é—¨ç¬¬", desc:"çˆ¶æ¯æ˜¯æ•™å¸ˆæˆ–å…¬åŠ¡å‘˜ã€‚å¼€å±€å­¦ä¸šä¸è‰ºæœ¯å±æ€§è¾ƒé«˜ã€‚", money: 500}, {id:'business', name:"ç»å•†ä¸–å®¶", desc:"å®¶é‡Œæœ‰çŸ¿ã€‚å¼€å±€èµ„é‡‘å……è£•ï¼Œä½†çˆ¶æ¯å¿™ç”Ÿæ„ï¼Œäº²æƒ…æ·¡æ¼ ã€‚", money: 2000} ];

    const FACILITIES = { 
        'confucius': { icon: 'ğŸ—¿', levels: [{name:'å­”å­åœ£åƒ',cost:20,desc:'çºªå¾‹+1,å£°èª‰+3/æœˆ'}, {name:'ç™¾å®¶é›•å¡‘ç¾¤',cost:60,desc:'çºªå¾‹+3,å£°èª‰+10/æœˆ'}, {name:'å„’å­¦æœåœ£æ®¿',cost:200,desc:'çºªå¾‹+8,è§£é”ç‰¹æŠ€ã€å­”å­åœ£å…‰ã€‘'}] }, 
        'media': { icon: 'ğŸ¢', levels: [{name:'ç”µæ•™å¤§æ¥¼',cost:40,desc:'å­¦ä¸šå€ç‡æå‡'}, {name:'æ™ºæ…§æ ¡å›­ç½‘',cost:100,desc:'å­¦ä¸šå€ç‡å¤§å¹…æå‡'}, {name:'é‡å­è¶…ç®—ä¸­å¿ƒ',cost:300,desc:'å­¦ä¸šæé€Ÿç‹‚é£™'}] }, 
        'track': { icon: 'ğŸƒ', levels: [{name:'å¡‘èƒ¶æ“åœº',cost:30,desc:'ä½“è´¨+1.5,å‡å‹'}, {name:'å®¤å†…ä½“è‚²é¦†',cost:80,desc:'ä½“è´¨+4,å¤§å¹…å‡å‹'}, {name:'å¥¥æ—åŒ¹å…‹ä¸­å¿ƒ',cost:250,desc:'ä½“è´¨æ°¸ä¸æ‰è½'}] }, 
        'library': { icon: 'ğŸ“š', levels: [{name:'å›¾ä¹¦é¦†',cost:50,desc:'æ¯æœˆå­¦ä¸šåŸºç¡€+1'}, {name:'æ•°å­—åŒ–ä¹¦åŸ',cost:120,desc:'æ¯æœˆå­¦ä¸š+3'}, {name:'å›½å®¶çº§æ–‡çŒ®åº“',cost:400,desc:'æ¯æœˆå­¦ä¸š+8,é«˜æ•™ç ”ç‚¹'}] }, 
        'clinic': { icon: 'ğŸ›‹ï¸', levels: [{name:'å¿ƒç†è¯Šæ‰€',cost:45,desc:'å¾®å¼±å¯¹å†²ä¸»ç§‘é«˜å‹'}, {name:'ç²¾ç¥åº·å¤ä¸­å¿ƒ',cost:150,desc:'å¤§å¹…æ¶ˆé™¤å…¨æ ¡å‹åŠ›'}, {name:'è„‘ç§‘å­¦ç ”ç©¶æ‰€',cost:500,desc:'é«˜å‹ä¸å†äº§ç”Ÿè´Ÿé¢æ•ˆæœ'}] }, 
        'art': { icon: 'ğŸ¨', levels: [{name:'è‰ºæœ¯ä¸­å¿ƒ',cost:60,desc:'ç´ è´¨æå‡'}, {name:'çš‡å®¶å¤§å‰§é™¢',cost:180,desc:'è‰ºæœ¯æ¶µå…»æš´å¢'}, {name:'å›½é™…è‰ºæœ¯å±•é¦†',cost:600,desc:'è‰ºæœ¯æ‹‰æ»¡,å£°èª‰æé«˜'}] }, 
        'lab': { icon: 'ğŸ”¬', levels: [{name:'å®éªŒå¤§æ¥¼',cost:80,desc:'è”è€ƒé¢å¤–æ•™ç ”ç‚¹'}, {name:'å›½å®¶é‡ç‚¹å®éªŒå®¤',cost:250,desc:'æ•™ç ”ç‚¹è·å–ç¿»å€'}, {name:'è¯ºå¥–å­µåŒ–åŸºåœ°',cost:800,desc:'æ•™ç ”ç‚¹æ— é™æº¢å‡º'}] }, 
        'dorm': { icon: 'ğŸ¨', levels: [{name:'è´µæ—å…¬å¯“',cost:100,desc:'è¢«åŠ¨å¸é‡‘'}, {name:'é¡¶å¥¢å…¨æ™¯å¥—æˆ¿',cost:300,desc:'å¸é‡‘èƒ½åŠ›ç¿»å€'}, {name:'ä¼´è¯»ç‹¬æ ‹åˆ«å¢…åŒº',cost:1000,desc:'å¸é‡‘ææ€–,ä½†é™çºªå¾‹'}] }, 
        'hospital': { icon: 'ğŸ¥', levels: [{name:'æ ¡åŒ»é™¢',cost:40,desc:'é˜²ç”Ÿç—…åœè¯¾'}, {name:'ä¸‰ç”²é™„å±åŒ»é™¢',cost:200,desc:'ä½“è´¨é£™å‡,å…ç–«ç–«ç—…'}, {name:'ç”Ÿå‘½ç§‘å­¦ä¸­å¿ƒ',cost:600,desc:'å…¨å‘˜æ»¡è¡€çŠ¶æ€'}] }, 
        'hall': { icon: 'ğŸ›ï¸', levels: [{name:'å¤§ç¤¼å ‚',cost:150,desc:'APä¸Šé™+5'}, {name:'å›½é™…ä¼šè®®ä¸­å¿ƒ',cost:400,desc:'APä¸Šé™+15'}, {name:'è”åˆå›½ä¼šåœº',cost:1500,desc:'APæ— ç©·å°½'}] } 
    };

    const BRANCHES_DB = [
        { id: 'b_hengshui', name: "è¡¡æ°´åˆ†æ ¡", cost: 2000, desc: "å…¨å‘˜æ”»å‡»åŠ›+15%ï¼Œå‹åŠ›ä¸Šé™+20ã€‚æ¯æœˆå£°èª‰+20ã€‚", buff: {atk:1.15, maxHp:1.2} },
        { id: 'b_beijing', name: "åŒ—äº¬åˆ†æ ¡", cost: 3000, desc: "å…¨å‘˜é˜²å¾¡åŠ›+20%ï¼ŒAPä¸Šé™+5ã€‚æ¯æœˆèµ„é‡‘+100ã€‚", buff: {def:1.2, ap:5} },
        { id: 'b_shanghai', name: "é­”éƒ½å›½é™…éƒ¨", cost: 4000, desc: "å…¨å‘˜æš´å‡»ç‡+10%ï¼ŒAPæ¶ˆè€—å‡å°‘ã€‚æ¯æœˆå£°èª‰+50ã€‚", buff: {crit:10, apRed:1} },
        { id: 'b_harvard', name: "å“ˆä½›é¢„ç§‘è¥", cost: 10000, desc: "å…¨å±æ€§+20%ï¼Œè§£é”éšè—æŠ€èƒ½ã€‚æ¯æœˆèµ„é‡‘+500ã€‚", buff: {all:1.2} },
        { id: 'b_oxford', name: "ç‰›æ´¥ä¹¦é™¢", cost: 8000, desc: "é˜²å¾¡åŠ›+30%ï¼Œå…ç–«æ™•çœ©ã€‚æ¯æœˆæ•™ç ”ç‚¹+50ã€‚", buff: {def:1.3, immune:true} },
        { id: 'b_huanggang', name: "é»„å†ˆå¯†å·å‚", cost: 2500, desc: "æ”»å‡»åŠ›+25%ï¼Œæ¯å›åˆè‡ªä¼¤ã€‚æ¯æœˆå­¦ä¸š+5ã€‚", buff: {atk:1.25, selfDmg:true} }
    ];

    const EXPERT_POOL = [
        { id: 'e1', name: "é€€å½¹é­”é¬¼æ•™å®˜", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: ä½¿æ•Œæ–¹å‹åŠ›+2ã€‚", battle: (p,e)=>{ e.stress+=2; return "æ•Œæ–¹å‹åŠ›+2"; } },
        { id: 'e2', name: "æŠ é—¨è€å‡ºçº³", rarity: 'R', upkeep: 2, desc: "è¢«åŠ¨: é™ä½15%å­¦æ ¡å¸¸è€—ã€‚", battle: null },
        { id: 'e3', name: "å‡¶æ‚å®¿ç®¡å¤§å¦ˆ", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: å·±æ–¹é˜²å¾¡+5%ã€‚", battle: (p,e)=>{ p.buffs.defUp=2; return "é˜²å¾¡å¢å¼º2å›åˆ"; } },
        { id: 'e4', name: "æ–°ä¸œæ–¹å¤§å¨", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: å›å¤2%HPã€‚", battle: (p,e)=>{ p.hp+=p.maxHp*0.02; return "å›å¤å°‘é‡HP"; } },
        { id: 'e5', name: "é“å£é—¨å«å¤§çˆ·", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: å·±æ–¹å‡ä¼¤æŠ¤ç›¾ã€‚", battle: (p,e)=>{ p.buffs.shield=1; return "æŠ¤ç›¾è¦†ç›–"; } },
        { id: 'e6', name: "å®ä¹ å¿ƒç†åŒ»ç”Ÿ", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: å‡å‹3ç‚¹ã€‚", battle: (p,e)=>{ p.stress=Math.max(0,p.stress-3); return "å‹åŠ›-3"; } },
        { id: 'e7', name: "é€€ä¼‘è€ç‰¹çº§", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: æ”»å‡»åŠ›+5%ã€‚", battle: (p,e)=>{ p.buffs.atkUp=2; return "æ”»å‡»æå‡2å›åˆ"; } },
        { id: 'e8', name: "é¸¡è¡€å®£ä¼ å¹²äº‹", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: æ¸…é™¤è´Ÿé¢BUFFã€‚", battle: (p,e)=>{ p.buffs.atkDown=0; p.buffs.defDown=0; p.buffs.dot=0; return "å‡€åŒ–è´Ÿé¢"; } },
        { id: 'e9', name: "æµ·å½’é’å¹´å­¦è€…", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: æš´å‡»ç‡+5%ã€‚", battle: (p,e)=>{ p.buffs.critUp=3; return "æš´å‡»æå‡3å›åˆ"; } },
        { id: 'e10', name: "æƒå¨å¿ƒç†å­¦æ•™æˆ", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: æ•Œæ–¹æ”»å‡»-10%ã€‚", battle: (p,e)=>{ e.buffs.atkDown=2; return "æ•Œæ”»ä¸‹é™2å›åˆ"; } },
        { id: 'e11', name: "å›½å®¶çº§é‡‘ç‰Œæ•™ç»ƒ", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: æ”»å‡»åŠ›æš´å¢ã€‚", battle: (p,e)=>{ p.buffs.atkUp=3; return "æ”»å‡»å¤§å¹…æå‡3å›åˆ"; } },
        { id: 'e12', name: "æŠ–éŸ³ç½‘çº¢åå¸ˆ", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: æ¦‚ç‡ä½¿æ•Œæ–¹æ™•çœ©ã€‚", battle: (p,e)=>{ if(Math.random()<0.3){e.buffs.stun=1; return "æ•Œæ–¹æ™•çœ©!";} return "æœªå‘½ä¸­"; } },
        { id: 'e13', name: "é“è…•çº§éƒ¨ä¸»ä»»", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: å¼ºåŠ›æŠ¤ç”²ã€‚", battle: (p,e)=>{ p.buffs.defUp=3; return "é˜²å¾¡å¤§å¹…å¢å¼º3å›åˆ"; } },
        { id: 'e14', name: "é€€å½¹å¥¥è¿å¥å°†", rarity: 'SR', upkeep: 10, desc: "è¢«åŠ¨: HPä¸Šé™æå¤§å¹…æå‡", battle: null },
        { id: 'e15', name: "è½é­„è‰ºæœ¯å¤§å¸ˆ", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: å¿…æš´çŠ¶æ€ã€‚", battle: (p,e)=>{ p.buffs.dmgUp=1; return "ä¸‹ä¸€æ¬¡æ”»å‡»å¿…å®šæš´å‡»ä¸”ä¼¤å®³æå‡"; } },
        { id: 'e16', name: "å…¨å›½å‘½é¢˜ç»„ç»„é•¿", rarity: 'SSR', upkeep: 50, desc: "æˆ˜æ–—: è‡´å‘½å¼±ç‚¹ã€‚", battle: (p,e)=>{ e.buffs.defDown=3; return "æ•Œæ–¹é˜²å¾¡å´©æºƒ3å›åˆ"; } },
        { id: 'e17', name: "åƒäº¿å•†ä¸šå·¨å­", rarity: 'SSR', upkeep: 50, desc: "æˆ˜æ–—: å›å¤3APã€‚", battle: (p,e)=>{ p.ap+=3; return "AP+3"; } },
        { id: 'e18', name: "è¯ºå¥–åè£”å¾—ä¸»", rarity: 'SSR', upkeep: 50, desc: "æˆ˜æ–—: å…¨å‘˜æŒç»­å›å¤ã€‚", battle: (p,e)=>{ p.buffs.hot=3; return "ç¾¤ä½“å›è¡€çŠ¶æ€3å›åˆ"; } },
        { id: 'e19', name: "æ•™è‚²å…ç‰¹æ´¾å‘˜", rarity: 'SSR', upkeep: 50, desc: "æˆ˜æ–—: å°å°æ•Œæ–¹ä¸€å›åˆã€‚", battle: (p,e)=>{ e.buffs.stun=1; e.buffs.atkDown=2; return "æ•Œæ–¹éœ‡æ…‘æ™•çœ©ï¼"; } },
        { id: 'e20', name: "å­”å­è½¬ä¸–æœ¬å°Š", rarity: 'SSR', upkeep: 150, desc: "æˆ˜æ–—: ç¥ä½‘å¤è‹ã€‚", battle: (p,e)=>{ p.hp=p.maxHp; p.stress=0; return "ç¥ä½‘å¤è‹ï¼Œæ»¡è¡€å¤æ´»"; } },
    ];

    // å…¨æ–°æ‹“å±•æŠ€èƒ½åº“ (34ä¸ªæŠ€èƒ½)
    const SKILL_DB = {
        // --- æ”»å‡»ç³» (ATK) ---
        'atk_0': { cat: 'atk', name: 'å¹³Aå‡ºé¢˜', desc: 'æ— æ¶ˆè€—ã€‚é€ æˆ100%ä¼¤å®³ã€‚', ap: 0, reqDesc: 'æ— ', req: ()=>true },
        'atk_1': { cat: 'atk', name: 'éšå ‚æµ‹éªŒ', desc: 'AP:5ã€‚é€ æˆ120%ä¼¤å®³ã€‚', ap: 5, reqDesc: 'æ— ', req: ()=>true },
        'atk_2': { cat: 'atk', name: 'åˆ·é¢˜æœºå™¨', desc: 'AP:3ã€‚é€ æˆ80%ä¼¤å®³ï¼Œå›å¤2%HPã€‚', ap: 3, reqDesc: 'æ— ', req: ()=>true },
        'atk_3': { cat: 'atk', name: 'æœˆè€ƒè½°ç‚¸', desc: 'AP:15ã€‚é€ æˆ150%ä¼¤å®³ï¼Œæ•Œæ–¹å‹åŠ›+5ã€‚', ap: 15, reqDesc: 'æ— ', req: ()=>true },
        'atk_4': { cat: 'atk', name: 'é¢˜æµ·æ·¹æ²¡', desc: 'AP:25ã€‚é€ æˆ3æ®µ60%ä¼¤å®³ã€‚', ap: 25, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.main>=1 },
        'atk_5': { cat: 'atk', name: 'å‡½æ•°å‹è½´é¢˜', desc: 'AP:35ã€‚é€ æˆ250%ç‰©ç†ä¼¤å®³ã€‚', ap: 35, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.main>=1 },
        'atk_6': { cat: 'atk', name: 'è‹±è¯­å¬åŠ›', desc: 'AP:18ã€‚é€ æˆ110%ä¼¤å®³ï¼Œæ–½åŠ æ˜“ä¼¤ã€‚', ap: 18, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.main>=1 },
        'atk_7': { cat: 'atk', name: 'åŒ–å­¦æ–¹ç¨‹å¼', desc: 'AP:30ã€‚é€ æˆ180%ä¼¤å®³ï¼Œæ–½åŠ æŒç»­æ¯’ç´ ä¼¤å®³3å›åˆã€‚', ap: 30, reqDesc: 'å‰¯ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.minor>=1 },
        'atk_8': { cat: 'atk', name: 'ç‰©ç†åŠ›å­¦', desc: 'AP:45ã€‚é€ æˆ350%ä¼¤å®³ï¼Œè‡ªèº«æ™•çœ©1å›åˆã€‚', ap: 45, reqDesc: 'å‰¯ç§‘è¾¾åˆ°[ç‰¹çº§åå¸ˆ]', req: ()=>game.teachers.minor>=2 },
        'atk_9': { cat: 'atk', name: 'ç”Ÿç‰©é—ä¼ å›¾', desc: 'AP:22ã€‚é€ æˆ140%ä¼¤å®³ï¼Œæ•Œæ”»ä¸‹é™ã€‚', ap: 22, reqDesc: 'å‰¯ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.minor>=1 },
        'atk_10': { cat: 'atk', name: 'æ”¿æ²»è¾¨æ', desc: 'AP:40ã€‚é€ æˆ300%ç²¾ç¥ä¼¤å®³ï¼Œæ— è§†éƒ¨åˆ†é˜²å¾¡ã€‚', ap: 40, reqDesc: 'ç´ è´¨è¾¾åˆ°[ç‰¹çº§åå¸ˆ]', req: ()=>game.teachers.spec>=2 },
        'atk_11': { cat: 'atk', name: 'è‹±è¯­ä½œæ–‡èƒŒè¯µ', desc: 'AP:15ã€‚é€ æˆ120%ä¼¤å®³ï¼Œå›å¤å°‘é‡APã€‚', ap: 15, reqDesc: 'æ— ', req: ()=>true },
        'atk_12': { cat: 'atk', name: 'å®Œå½¢å¡«ç©ºè¿æ–©', desc: 'AP:20ã€‚é€ æˆ4æ®µ40%çš„è¿ç»­ä¼¤å®³ã€‚', ap: 20, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.main>=1 },
        'atk_13': { cat: 'atk', name: 'ç«‹ä½“å‡ ä½•åŸæœ¬', desc: 'AP:28ã€‚é€ æˆ200%çœŸå®ä¼¤å®³ã€‚', ap: 28, reqDesc: 'æ— ', req: ()=>true },

        // --- é˜²å®ˆç³» (DEF) ---
        'def_0': { cat: 'def', name: 'æ•´ç†é”™é¢˜æœ¬', desc: 'AP:5ã€‚ä¸‹å›åˆé˜²å¾¡å¢å¼ºã€‚', ap: 5, reqDesc: 'æ— ', req: ()=>true },
        'def_1': { cat: 'def', name: 'æ ‡å‡†ç­”æ¡ˆ', desc: 'AP:10ã€‚å›å¤15% HPï¼Œæ¸…é™¤ä¸€ä¸ªè´Ÿé¢ã€‚', ap: 10, reqDesc: 'æ— ', req: ()=>true },
        'def_2': { cat: 'def', name: 'ä¸¤è€³ä¸é—»', desc: 'AP:8ã€‚é˜²å¾¡å¢å¼ºï¼Œå›å¤5APã€‚', ap: 8, reqDesc: 'æ— ', req: ()=>true },
        'def_3': { cat: 'def', name: 'è€ƒå‰åˆ’é‡ç‚¹', desc: 'AP:15ã€‚æ–½åŠ å‡ä¼¤æŠ¤ç›¾ã€‚', ap: 15, reqDesc: 'æ— ', req: ()=>true },
        'def_4': { cat: 'def', name: 'å¿ƒç†å»ºè®¾', desc: 'AP:12ã€‚è‡ªèº«å‹åŠ›-20ã€‚', ap: 12, reqDesc: 'æ— ', req: ()=>true },
        'def_5': { cat: 'def', name: 'é¢˜æµ·æŠ¤ç›¾', desc: 'AP:20ã€‚å·¨é¢æŠ¤ç›¾ï¼Œå…ç–«ä¸€æ¬¡ä¼¤å®³ã€‚', ap: 20, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.main>=1 },
        'def_6': { cat: 'def', name: 'åå¸ˆç‚¹æ‹¨', desc: 'AP:25ã€‚å›å¤30% HPï¼ŒæŒç»­å›è¡€2å›åˆã€‚', ap: 25, reqDesc: 'ç´ è´¨è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.spec>=1 },
        'def_7': { cat: 'def', name: 'ç»å¯¹é˜²å¾¡', desc: 'AP:40ã€‚è·å¾—æé™é—ªé¿çŠ¶æ€ã€‚', ap: 40, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[ç‰¹çº§åå¸ˆ]', req: ()=>game.teachers.main>=2 },
        'def_8': { cat: 'def', name: 'é€»è¾‘é—­ç¯', desc: 'AP:30ã€‚é˜²å®ˆåå‡»ï¼Œä¸‹å›åˆå¿…å®šæš´å‡»ã€‚', ap: 30, reqDesc: 'å‰¯ç§‘è¾¾åˆ°[ç‰¹çº§åå¸ˆ]', req: ()=>game.teachers.minor>=2 },
        'def_9': { cat: 'def', name: 'é—­ç›®å…»ç¥', desc: 'AP:10ã€‚å›å¤HPå¹¶æ¸…é™¤æ‰€æœ‰è´Ÿé¢çŠ¶æ€ã€‚', ap: 10, reqDesc: 'æ— ', req: ()=>true },

        // --- ç ”è®¨ç³» (SUP) ---
        'sup_0': { cat: 'sup', name: 'å°ç»„è®¨è®º', desc: 'AP:5ã€‚ç›´æ¥å›å¤10ç‚¹APã€‚', ap: 5, reqDesc: 'æ— ', req: ()=>true },
        'sup_1': { cat: 'sup', name: 'å…¨ç­ä¼ çº¸æ¡', desc: 'AP:10ã€‚å›è¡€å°‘è®¸ï¼ŒAP+5ã€‚', ap: 10, reqDesc: 'æ— ', req: ()=>true },
        'sup_2': { cat: 'sup', name: 'äº’å¸®äº’åŠ©', desc: 'AP:15ã€‚è‡ªèº«æ”»å‡»åŠ›æå‡3å›åˆã€‚', ap: 15, reqDesc: 'æ— ', req: ()=>true },
        'sup_3': { cat: 'sup', name: 'å¤´è„‘é£æš´', desc: 'AP:20ã€‚æš´å‡»ç‡æå¤§æå‡2å›åˆã€‚', ap: 20, reqDesc: 'ç´ è´¨è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.spec>=1 },
        'sup_4': { cat: 'sup', name: 'å­¦æœ¯æ²™é¾™', desc: 'AP:25ã€‚å…¨å‘˜æ»¡çŠ¶æ€æ¢å¤å¤§é‡HPä¸APã€‚', ap: 25, reqDesc: 'æ‹¥æœ‰ä¸“å®¶[è¯ºå¥–åè£”å¾—ä¸»]', req: ()=>hasExpert('e18') },
        'sup_5': { cat: 'sup', name: 'è€ƒç¥é™„ä½“', desc: 'AP:30ã€‚è·å¾—æ”»å‡»æå‡ã€é˜²å¾¡æå‡ã€æš´å‡»æå‡ç»¼åˆçŠ¶æ€ã€‚', ap: 30, reqDesc: 'æ— ', req: ()=>true },

        // --- å¿ƒç†ç³» (PSY) ---
        'psy_0': { cat: 'psy', name: 'æ­»äº¡å‡è§†', desc: 'AP:10ã€‚æ•Œæ–¹å‹åŠ›+15ã€‚', ap: 10, reqDesc: 'æ— ', req: ()=>true },
        'psy_1': { cat: 'psy', name: 'å‡¡å°”èµ›å‘è¨€', desc: 'AP:15ã€‚æ•Œæ–¹å‹åŠ›+25ï¼Œé™„å¸¦æ–½åŠ æ˜“ä¼¤ã€‚', ap: 15, reqDesc: 'æ— ', req: ()=>true },
        'psy_2': { cat: 'psy', name: 'æ’•æ¯è¯•å·', desc: 'AP:20ã€‚é™ä½æ•Œæ–¹æ”»å‡»åŠ›3å›åˆã€‚', ap: 20, reqDesc: 'æ— ', req: ()=>true },
        'psy_3': { cat: 'psy', name: 'æ’åå…¬å¸ƒ', desc: 'AP:30ã€‚é€ æˆæ•Œæ–¹å½“å‰HP 20%ä¼¤å®³ã€‚', ap: 30, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.main>=1 },
        'psy_4': { cat: 'psy', name: 'å«å®¶é•¿', desc: 'AP:40ã€‚æ•Œæ–¹å¼ºè¡Œæ™•çœ©1å›åˆï¼Œå¤§ä¼¤å®³ã€‚', ap: 40, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[ç‰¹çº§åå¸ˆ]', req: ()=>game.teachers.main>=2 },
        'psy_5': { cat: 'psy', name: 'å¹æ°”å¹²æ‰°', desc: 'AP:12ã€‚æ•Œæ–¹æ”»é˜²åŒé™2å›åˆã€‚', ap: 12, reqDesc: 'æ— ', req: ()=>true },

        // --- çµæ„Ÿç³» (INSP) ---
        'insp_0': { cat: 'insp', name: 'è’™ä¸€ä¸ª', desc: 'AP:5ã€‚50%å‡ ç‡300%ä¼¤ï¼Œ50% missã€‚', ap: 5, reqDesc: 'æ— ', req: ()=>true },
        'insp_1': { cat: 'insp', name: 'æŠ¼é¢˜å‘½ä¸­', desc: 'AP:30ã€‚30%å‡ ç‡é€ æˆ999ä¼¤å®³ã€‚', ap: 30, reqDesc: 'æ— ', req: ()=>true },
        'insp_2': { cat: 'insp', name: 'çµå…‰ä¹ç°', desc: 'AP:20ã€‚ä¸‹ä¸€æ¬¡æ”»å‡»å¿…å®šæš´å‡»ã€‚', ap: 20, reqDesc: 'è‰ºæœ¯å±æ€§>50', req: ()=>game.art>50 },
        'insp_3': { cat: 'insp', name: 'è‰ºæœ¯é€šæ„Ÿ', desc: 'AP:30ã€‚åŸºäºè‰ºæœ¯å±æ€§é€ æˆå·¨é¢ä¼¤å®³ã€‚', ap: 30, reqDesc: 'è‰ºæœ¯å±æ€§>70', req: ()=>game.art>70 },

        // --- ç†µå¢ç³» (ENTROPY) ---
        'ent_0': { cat: 'ent', name: 'å†¥æƒ³å‡€åŒ–', desc: 'AP:15ã€‚æ¸…é™¤è‡ªèº«å…¨éƒ¨æ€ç»´ç†µå¢ï¼ˆå‹åŠ›å½’é›¶ï¼‰ã€‚', ap: 15, reqDesc: 'æ— ', req: ()=>true },
        'ent_1': { cat: 'ent', name: 'å¿ƒæµçŠ¶æ€', desc: 'AP:20ã€‚è‡ªèº«å‹åŠ›-40ï¼Œæ”»å‡»åŠ›å°å¹…æå‡ã€‚', ap: 20, reqDesc: 'æ— ', req: ()=>true },
        'ent_2': { cat: 'ent', name: 'ç†µå¢ä¼ å¯¼', desc: 'AP:25ã€‚å°†å·±æ–¹å½“å‰å‹åŠ›çš„50%è½¬ç§»ç»™æ•Œæ–¹ã€‚', ap: 25, reqDesc: 'æ— ', req: ()=>true },
        'ent_3': { cat: 'ent', name: 'ç²¾ç¥å´©æºƒå¼¹', desc: 'AP:35ã€‚ç»™æ•Œæ–¹æ–½åŠ "æ€ç»´ç†µå¢"BUFFï¼Œæ¯å›åˆå‹åŠ›+15ï¼ŒæŒç»­3å›åˆã€‚', ap: 35, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.main>=1 },
        'ent_4': { cat: 'ent', name: 'è™šç©ºå‡è§†', desc: 'AP:18ã€‚ä½¿æ•Œæ–¹å‹åŠ›+30ï¼Œå¹¶å°å°å…¶ä¸‹å›åˆæŠ€èƒ½é‡Šæ”¾ã€‚', ap: 18, reqDesc: 'ç´ è´¨è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.spec>=1 },
        'ent_5': { cat: 'ent', name: 'æµ´ç«é‡ç”Ÿ', desc: 'AP:40ã€‚æ¶ˆè€—å·±æ–¹æ‰€æœ‰å‹åŠ›ä¸ºä»£ä»·ï¼Œå›å¤å¤§é‡HPï¼ˆå‹åŠ›Ã—20ç‚¹ï¼‰ã€‚', ap: 40, reqDesc: 'æ— ', req: ()=>true },

        // --- ä½“ç³»ç³» (SYS) ---
        'sys_è¡¡æ°´': { cat: 'sys', name: 'è¡¡æ°´æ¨¡å¼', desc: 'AP:50ã€‚æ”»å‡»ç¿»å€ï¼Œè‡ªèº«æ‰£è¡€20%ã€‚', ap: 50, reqDesc: 'æ”¿ç­–[è¡¡æ°´é«˜è€ƒé›†ä¸­è¥]', req: ()=>hasPolicy('A8') },
        'sys_ç´ è´¨': { cat: 'sys', name: 'ç´ è´¨æ•™è‚²', desc: 'AP:50ã€‚å…¨å±æ€§æå‡ï¼ŒæŒç»­å›è¡€å‡å‹ã€‚', ap: 50, reqDesc: 'æ”¿ç­–[ç†æƒ³ä¹Œæ‰˜é‚¦æ ¡å›­]', req: ()=>hasPolicy('D8') },
        'sys_èµ„æœ¬': { cat: 'sys', name: 'é’èƒ½åŠ›', desc: 'AP:0ã€‚è€—50ä¸‡èµ„é‡‘ï¼Œç§’æ€9999ç‚¹ä¼¤å®³ã€‚', ap: 0, reqDesc: 'æ‹¥æœ‰ä¸“å®¶[åƒäº¿å•†ä¸šå·¨å­]', req: ()=>hasExpert('e17') }
    };

    // æ•Œæ–¹BOSSåº“ (åŠ å…¥BOSSç‰¹æ€§)
    const RIVALS = [
        { id: 't1_1', tier:1, name: "æ‘å£å¸Œæœ›ä¸­å­¦", hp: 4000, atk: 650, def: 60, pts: 5, traitName:"é‡è›®ç”Ÿé•¿", traitDesc:"æ¯å›åˆæ¢å¤å°‘é‡ç”Ÿå‘½ã€‚", traitEff:(p,e)=>{ e.hp=Math.min(e.maxHp, e.hp+Math.floor(e.maxHp*0.02)); return "æ•Œæ–¹æ¢å¤ç”Ÿå‘½å€¼"; } },
        { id: 't1_2', tier:1, name: "é•‡åŠç¬¬ä¸‰ä¸­å­¦", hp: 5500, atk: 750, def: 120, pts: 8, traitName:"é¡½å¼ºæŠµæŠ—", traitDesc:"ç”Ÿå‘½ä½äº50%æ—¶é˜²å¾¡ç¿»å€ã€‚", traitEff:(p,e)=>{ if(e.hp<e.maxHp*0.5){ e.buffs.defUp=1; return "é˜²å¾¡æ¿€å¢"; } return null; } },
        { id: 't1_3', tier:1, name: "å¿èŒä¸šä¸­ä¸“", hp: 7000, atk: 850, def: 150, pts: 10, traitName:"æµæ°“æ‰“æ³•", traitDesc:"æ”»å‡»æœ‰æ¦‚ç‡æ–½åŠ æ™•çœ©ã€‚", traitEff:(p,e)=>null },
        { id: 't2_1', tier:2, name: "å¿ç¬¬ä¸€ä¸­å­¦", hp: 10500, atk: 1000, def: 300, pts: 15, traitName:"é¢˜æµ·æˆ˜æœ¯", traitDesc:"æ¯å›åˆå›ºå®šå‰Šå‡æˆ‘æ–¹APã€‚", traitEff:(p,e)=>{ p.ap=Math.max(0,p.ap-2); return "å‰Šå‡ç©å®¶AP"; } },
        { id: 't2_2', tier:2, name: "å¸‚æ™®é€šé«˜ä¸­", hp: 13500, atk: 1150, def: 360, pts: 18, traitName:"ä¸­è§„ä¸­çŸ©", traitDesc:"å…ç–«æ‰€æœ‰å±æ€§ä¸‹é™Debuffã€‚", traitEff:(p,e)=>{ e.buffs.atkDown=0; e.buffs.defDown=0; return null; } },
        { id: 't2_3', tier:2, name: "ç§ç«‹è´µæ—å­¦æ ¡", hp: 15000, atk: 1300, def: 300, pts: 20, traitName:"é’èƒ½åŠ›åŠ æŒ", traitDesc:"å¼€åœºè‡ªå¸¦é«˜é¢æŠ¤ç›¾å¹¶æå‡æ”»å‡»ã€‚", traitEff:(p,e)=>{ if(bState.turn===1){ e.buffs.shield=2; e.buffs.atkUp=5; return "æ¿€æ´»é‡‘é’±æŠ¤ç›¾ä¸æ”»å‡»"; } return null; } },
        { id: 't3_1', tier:3, name: "å¸‚å®éªŒä¸­å­¦", hp: 24000, atk: 1600, def: 600, pts: 30, traitName:"å®éªŒåˆ›æ–°", traitDesc:"æ¯3å›åˆæ–½åŠ å‰§æ¯’åŒ–å­¦ä¼¤å®³ã€‚", traitEff:(p,e)=>{ if(bState.turn%3===0){ p.buffs.dot=2; return "é‡Šæ”¾åŒ–å­¦æ¯’ç´ "; } return null; } },
        { id: 't3_2', tier:3, name: "å¸‚å¤–å›½è¯­", hp: 27000, atk: 1750, def: 540, pts: 35, traitName:"å¬åŠ›æŠ˜ç£¨", traitDesc:"å¢åŠ ç©å®¶æ¯å›åˆçš„å‹åŠ›å¢é•¿ã€‚", traitEff:(p,e)=>{ p.stress+=3; return "å™ªéŸ³å¢åŠ å‹åŠ›"; } },
        { id: 't3_3', tier:3, name: "çœé™„å±åˆ†æ ¡", hp: 30000, atk: 1900, def: 750, pts: 40, traitName:"æœ¬éƒ¨æ”¯æ´", traitDesc:"åŠè¡€æ—¶å¬å”¤ä¸€æ¬¡å¼ºåŠ›æ‰“å‡»ã€‚", traitEff:(p,e)=>{ if(e.hp<e.maxHp*0.5 && !e.hasSummoned){ e.hasSummoned=true; p.hp-=2000; return "å¤©é™ç¥ç½šï¼"; } return null; } },
        { id: 't4_1', tier:4, name: "çœå®éªŒä¸­å­¦", hp: 45000, atk: 2500, def: 1200, pts: 50, traitName:"å…¨çœæ ‡æ†", traitDesc:"æ”»å‡»åŠ›éšå›åˆæ•°ä¸æ–­æå‡ã€‚", traitEff:(p,e)=>{ e.atk+=50; return "æ”»å‡»åŠ›æˆé•¿"; } },
        { id: 't4_2', tier:4, name: "çœå¸ˆå¤§é™„ä¸­", hp: 48000, atk: 2650, def: 1260, pts: 55, traitName:"åå¸ˆå…‰ç¯", traitDesc:"å›åˆå¼€å§‹æ—¶æ¢å¤å¤§é‡ç”Ÿå‘½ã€‚", traitEff:(p,e)=>{ e.hp+=1500; return "åå¸ˆæ²»ç–—"; } },
        { id: 't4_3', tier:4, name: "ç™¾å¹´è€æ ¡ä¸€ä¸­", hp: 54000, atk: 2800, def: 1500, pts: 60, traitName:"åº•è•´æ·±åš", traitDesc:"æé«˜åŸºç¡€é˜²å¾¡ï¼Œå…ç–«æš´å‡»ã€‚", traitEff:(p,e)=>null },
        { id: 't5_1', tier:5, name: "è¡¡æ°´é’¢é“ä¸­å­¦", hp: 90000, atk: 4600, def: 2400, pts: 100, traitName:"æ­»äº¡è¡Œå†›", traitDesc:"åŒæ–¹æ— æ³•å›è¡€ï¼Œæ•Œæ–¹æ”»å‡»é™„å¸¦é«˜é¢çœŸä¼¤ã€‚", traitEff:(p,e)=>{ p.buffs.hot=0; e.buffs.hot=0; return "ç¦ç–—ç«‹åœºå±•å¼€"; } },
        { id: 't5_2', tier:5, name: "åŒ—äº¬å››ä¸­æœ¬éƒ¨", hp: 105000, atk: 3700, def: 3600, pts: 120, traitName:"é™ç»´æ‰“å‡»", traitDesc:"æ¯å›åˆå°å°ç©å®¶çš„APæ¢å¤ã€‚", traitEff:(p,e)=>{ p.ap=Math.max(0,p.ap-3); return "APå‹åˆ¶"; } },
        { id: 't5_3', tier:5, name: "é»„å†ˆå¯†å·å·¥å‚", hp: 84000, atk: 6100, def: 1500, pts: 150, traitName:"é¢˜æµ·æ·±æ¸Š", traitDesc:"æé«˜æ”»å‡»ï¼Œæ¯æ¬¡å—å‡»åå¼¹ä¼¤å®³ã€‚", traitEff:(p,e)=>null },
        { id: 't5_4', tier:5, name: "äººå¤§é™„ä¸­ç¥åŸŸ", hp: 120000, atk: 4900, def: 3000, pts: 200, traitName:"å…­è¾¹å½¢æˆ˜å£«", traitDesc:"å…ç–«æ‰€æœ‰å¼‚å¸¸ï¼Œå…¨å±æ€§æŒç»­å¢å¼ºã€‚", traitEff:(p,e)=>{ e.atk+=100; e.def+=50; return "ç¥æ€§å¢å¼º"; } },
        { id: 't5_5', tier:5, name: "å®‡å®™çœŸç†ä¸­å­¦", hp: 150000, atk: 7600, def: 7500, pts: 500, traitName:"çœŸç†æŠ¹æ€", traitDesc:"ç¬¬15å›åˆç›´æ¥ç§’æ€ç©å®¶ã€‚", traitEff:(p,e)=>{ if(bState.turn>=15){ p.hp=0; return "çœŸç†æŠ¹æ€å¯åŠ¨ï¼"; } return null; } }
    ];

    const WEATHER_TYPES = [
        { id: 'sun', name: 'â˜€ï¸ æ™´æœ—', desc: 'æ— ç‰¹æ®Šæ•ˆæœ', effect: ()=>{} },
        { id: 'rain', name: 'ğŸŒ§ï¸ é˜´é›¨', desc: 'å…¨å‘˜å¿ƒæƒ…ä½è½ï¼Œæš´å‡»ç‡-10%', effect: (p,e)=>{p.crit-=10; e.crit-=10;} },
        { id: 'morning', name: 'ğŸ“– æ—©è¯»å£°æµª', desc: 'æ€ç»´æ´»è·ƒï¼ŒåŒæ–¹æ”»å‡»åŠ›+20%', effect: (p,e)=>{p.atk*=1.2; e.atk*=1.2;} },
        { id: 'sleepy', name: 'ğŸ˜´ åˆåå›°å€¦', desc: 'æ˜æ˜æ¬²ç¡ï¼ŒåŒæ–¹é˜²å¾¡åŠ›-30%', effect: (p,e)=>{p.def*=0.7; e.def*=0.7;} },
        { id: 'storm', name: 'âš¡ è€ƒè¯•é£æš´', desc: 'å‹åŠ›éª¤å¢ï¼Œæ¯å›åˆå¢åŠ 10ç‚¹ç†µå¢', effect: (p,e)=>{p.stress+=10; e.stress+=10;} }
    ];

    const POLICY_TREE = [
        { tier: 1, nodes: [
            { id: "A1", name: "å†›äº‹åŒ–æ—©è¯»", class: "branch-a", desc: "å­¦ä¸š+1, å‹åŠ›+1", cost: 10, req: null },
            { id: "B1", name: "ä»ªå®¹ä»ªè¡¨å¤§æ£€æŸ¥", class: "branch-b", desc: "çºªå¾‹+1, è‰ºæœ¯-1", cost: 10, req: null },
            { id: "C1", name: "å°å–éƒ¨ç–¯ç‹‚æ¶¨ä»·", class: "branch-c", desc: "æ¯æœˆèµ„é‡‘ç•¥å¢, çºªå¾‹-1", cost: 10, req: null },
            { id: "D1", name: "å¼€è®¾è¯¾å¤–ç¤¾å›¢", class: "branch-d", desc: "è‰ºæœ¯+1, å‹åŠ›-1", cost: 10, req: null }
        ]},
        { tier: 2, nodes: [
            { id: "A2", name: "å¼ºåˆ¶æ™šè‡ªä¹ ", class: "branch-a", desc: "å­¦ä¸š+2, å‹åŠ›+2", cost: 20, req: "A1" },
            { id: "A3", name: "æœˆè€ƒçº¢æ¦œå¤§å­—æŠ¥", class: "branch-a", desc: "å­¦ä¸š+1, çºªå¾‹+1", cost: 20, req: "A1" },
            { id: "B2", name: "å…¨æ ¡ç”µå­è®¾å¤‡ç¦ä»¤", class: "branch-b", desc: "çºªå¾‹+2, å‹åŠ›+1", cost: 20, req: "B1" },
            { id: "B3", name: "ç”·å¥³ç”Ÿåˆ†æ¡Œè¿›é¤", class: "branch-b", desc: "é˜²æ—©æ‹, çºªå¾‹+1", cost: 20, req: "B1" },
            { id: "C2", name: "é£Ÿå ‚å¯¹å¤–å±‚å±‚æ‰¿åŒ…", class: "branch-c", desc: "èµ„é‡‘å¢åŠ , ä½“è´¨-2", cost: 20, req: "C1" },
            { id: "C3", name: "èµåŠ©è´¹æ˜ç æ ‡ä»·", class: "branch-c", desc: "å½•å–é™åˆ†æ”¶é’±, èµ„é‡‘å¤§å¢", cost: 20, req: "C1" },
            { id: "D2", name: "è½å®å‘¨æœ«åŒä¼‘", class: "branch-d", desc: "å‹åŠ›-3, å­¦ä¸š-1", cost: 20, req: "D1" },
            { id: "D3", name: "å…¨æ ¡è‰ºæœ¯èŠ‚ç­¹åŠ", class: "branch-d", desc: "è‰ºæœ¯+3, æ¶ˆè€—èµ„é‡‘", cost: 20, req: "D1" }
        ]},
        { tier: 3, nodes: [
            { id: "A4", name: "å‘¨æœ«ç–¯ç‹‚è¡¥è¯¾", class: "branch-a", desc: "å­¦ä¸š+3, å‹åŠ›+4", cost: 50, req: "A2" },
            { id: "A5", name: "é¢˜æµ·æˆ˜æœ¯å¤§çˆ†å‘", class: "branch-a", desc: "å­¦ä¸š+3, ä½“è´¨-2", cost: 50, req: "A3" },
            { id: "B4", name: "æ•™å®¤360åº¦ç›‘æ§", class: "branch-b", desc: "çºªå¾‹+3, å‹åŠ›+2", cost: 50, req: "B2" },
            { id: "B5", name: "è¿ç¦å“åœ°æ¯¯å¼æœæŸ¥", class: "branch-b", desc: "çºªå¾‹+2, ä½“è´¨+1", cost: 50, req: "B3" },
            { id: "C4", name: "å­¦åŒºæˆ¿ç–¯ç‹‚ç‚’ä½œ", class: "branch-c", desc: "æå‡åæ°”å’Œèµ„é‡‘", cost: 50, req: "C2" },
            { id: "C5", name: "å‹æ¦¨åº•è–ªå®ä¹ æ•™å¸ˆ", class: "branch-c", desc: "æ•™å¸ˆå·¥èµ„å¤§å¹…é™ä½", cost: 50, req: "C3" },
            { id: "D4", name: "å¿ƒç†å¥åº·è¯Šç–—å‘¨", class: "branch-d", desc: "å‹åŠ›-5, çºªå¾‹+1", cost: 50, req: "D2" },
            { id: "D5", name: "å¤§å­¦å¼è‡ªç”±èµ°ç­åˆ¶", class: "branch-d", desc: "è‰ºæœ¯+4, çºªå¾‹-2", cost: 50, req: "D3" }
        ]},
        { tier: 4, nodes: [
            { id: "A6", name: "æœ«ä½æ·˜æ±°åˆ¶é‡ç‚¹ç­", class: "branch-a", desc: "å­¦ä¸š+5, æåº¦é«˜å‹", cost: 100, req: "A4" },
            { id: "A7", name: "å¥¥èµ›å¼ºåŸºæå°–è¥", class: "branch-a", desc: "å­¦ä¸š+4, çƒ§é’±", cost: 100, req: "A5" },
            { id: "B6", name: "å­¦ç”Ÿäº’ç›¸ä¸¾æŠ¥å¥–åŠ±åˆ¶", class: "branch-b", desc: "çºªå¾‹+5, å‹åŠ›çˆ†è¡¨", cost: 100, req: "B4" },
            { id: "B7", name: "å†›è®­å¸¸æ€åŒ–", class: "branch-b", desc: "ä½“è´¨+5, çºªå¾‹+3", cost: 100, req: "B5" },
            { id: "C6", name: "å›½é™…åœŸè±ªç­å‰²éŸ­èœ", class: "branch-c", desc: "èµ„é‡‘æ¯æœˆå·¨é¢å…¥è´¦", cost: 100, req: "C4" },
            { id: "C7", name: "å¼ºè¿«è´­ä¹°å¤©ä»·æ ¡æœ", class: "branch-c", desc: "èµ„é‡‘æš´æ¶¨, å£°èª‰è·Œ", cost: 1000, req: "C5" },
            { id: "D6", name: "æ ¡å›­æ‹çˆ±å®Œå…¨è§£ç¦", class: "branch-d", desc: "å‹åŠ›-8, çºªå¾‹-5", cost: 1000, req: "D4" },
            { id: "D7", name: "å¸¸é’è—¤ç´ è´¨è€ƒæ ¸æ ‡å‡†", class: "branch-d", desc: "è‰ºæœ¯/ä½“è´¨+5, å£°èª‰é£™å‡", cost: 1000, req: "D5" }
        ]},
        { tier: 5, nodes: [
            { id: "A8", name: "ã€ç»ˆæã€‘è¡¡æ°´é«˜è€ƒé›†ä¸­è¥", class: "branch-a", desc: "è§£é”å¿…æ€æŠ€ã€åœ°ç‹±å‘¨ç‰¹è®­ã€‘", cost: 30000, req: "A6" },
            { id: "B8", name: "ã€ç»ˆæã€‘æ–¯å·´è¾¾ç»å¯¹æœä»", class: "branch-b", desc: "çºªå¾‹é”æ­»100", cost: 30000, req: "B6" },
            { id: "C8", name: "ã€ç»ˆæã€‘çº³æ–¯è¾¾å…‹ä¸Šå¸‚é›†å›¢", class: "branch-c", desc: "èµ„é‡‘æ— é™è†¨èƒ€", cost: 30000, req: "C6" },
            { id: "D8", name: "ã€ç»ˆæã€‘ç†æƒ³ä¹Œæ‰˜é‚¦æ ¡å›­", class: "branch-d", desc: "å‹åŠ›æ°¸è¿œä¸º0", cost: 30000, req: "D6" }
        ]}
    ];

    const ACHIEVEMENTS = [ 
        { id: 'a1', name: "ğŸ’¸ ç¬¬ä¸€æ¡¶é‡‘", desc: "èµ„é‡‘ç ´ 1,000 ä¸‡" }, 
        { id: 'a2', name: "ğŸ¤‘ å•†ä¸šå¸å›½", desc: "èµ„é‡‘ç ´ 1 äº¿" }, 
        { id: 'a3', name: "ğŸŒŸ åæ»¡å¤©ä¸‹", desc: "å£°èª‰ç ´ 10,000 ç‚¹" }, 
        { id: 'a4', name: "ğŸ‘‘ æ•™è‚²éœ¸ä¸»", desc: "å­¦æ ¡è¯„çº§è¾¾åˆ°ã€å…¨å›½é¡¶å°–ã€‘" }, 
        { id: 'a5', name: "ğŸ“ å­¦æœ¯æ³°æ–—", desc: "å…¨æ ¡å­¦ä¸šå¹³å‡è¾¾åˆ°90" }, 
        { id: 'a6', name: "ğŸ­ å·ç‹ä¹‹ç‹", desc: "ä¸»ç§‘è¯¾æ—¶æ’æ»¡40èŠ‚" }, 
        { id: 'a7', name: "ğŸ¥‡ å¥¥èµ›å¼ºæ ¡", desc: "ç‚¹äº®å¥¥èµ›å¼ºåŸºæ”¿ç­–" }, 
        { id: 'a8', name: "ğŸ’¥ é«˜å‹é”…ç‚¸äº†", desc: "å…¨æ ¡å¹³å‡å‹åŠ›çˆ†è¡¨100" }, 
        { id: 'a9', name: "ğŸš” æ— æ³•æ— å¤©", desc: "çºªå¾‹è·Œç ´10" }, 
        { id: 'a10', name: "ğŸƒ æ¬§çš‡é™„ä½“", desc: "æŠ½åˆ° SSR çº§ä¸“å®¶" }, 
        { id: 'a11', name: "ğŸ—ï¸ åŸºå»ºç‹‚é­”", desc: "å»ºæ»¡20å—åœ°çš®" }, 
        { id: 'a12', name: "ğŸ‘¨â€ğŸ« ç¾¤æ˜Ÿé—ªè€€", desc: "é›†é½20ä½åå¸ˆ" }, 
        { id: 'a13', name: "ğŸ“œ æ³•å®¶å¤§æˆ", desc: "ç‚¹æ»¡å…¨éƒ¨15é¡¹æ ¡ç­–" }, 
        { id: 'a14', name: "ğŸ‘¨â€ğŸ“ é‡‘æ¦œé¢˜å", desc: "å­¦ç”Ÿæ¨¡å¼é«˜è€ƒè¾¾åˆ°680åˆ†" }, 
        { id: 'a15', name: "ğŸ’• é’æ˜¥æ— æ‚”", desc: "å­¦ç”Ÿæ¨¡å¼æ™®é€šè¡¨ç™½æˆåŠŸ" }, 
        { id: 'a16', name: "ğŸ’€ å½»åº•å´©æºƒ", desc: "å­¦ç”Ÿæ¨¡å¼å‹åŠ›çªç ´100" }, 
        { id: 'a17', name: "âš”ï¸ å¯†å·å…‹æ˜Ÿ", desc: "PVEä¸­å‡»æºƒé»„å†ˆå¯†å·å·¥å‚" }, 
        { id: 'a18', name: "ğŸŒ å…¨çƒéœ¸æƒ", desc: "å»ºç«‹å…¨éƒ¨æµ·å¤–åˆ†æ ¡" },
        { id: 'a19', name: "ğŸ… å›½å®¶é˜Ÿ", desc: "å­¦ç”Ÿæ¨¡å¼è·å¾—å¥¥èµ›ä¿é€" },
        { id: 'ach_lin', name: "ğŸ“– å­¦éœ¸ä¹‹æ‹", desc: "åœ¨å­¦ç”Ÿæ¨¡å¼ä¸­æˆåŠŸæ”»ç•¥æ—çŸ¥ç§‹" },
        { id: 'ach_xia', name: "ğŸ¨ è‰ºæœ¯ä¹‹æ‹", desc: "åœ¨å­¦ç”Ÿæ¨¡å¼ä¸­æˆåŠŸæ”»ç•¥å¤æ™šæ™´" },
        { id: 'ach_jiang', name: "ğŸ€ çƒ­è¡€ä¹‹æ‹", desc: "åœ¨å­¦ç”Ÿæ¨¡å¼ä¸­æˆåŠŸæ”»ç•¥æ±Ÿä¸€èˆŸ" },
        { id: 'ach_shen', name: "ğŸš¬ æ•‘èµä¹‹æ‹", desc: "åœ¨å­¦ç”Ÿæ¨¡å¼ä¸­æˆåŠŸæ”»ç•¥æ²ˆæ¸”" },
        { id: 'a20', name: "ğŸ† ä¸‡è±¡å½’ä¸€", desc: "è§£é”å…¨éƒ¨æˆå°±ï¼" } 
    ];

    const FRIENDS = [
        {id:'f1', name:'ğŸ¤“ å­¦éœ¸åŒæ¡Œ', cost:200, desc:'æ¯æœˆå­¦ä¸š+2', eff:()=>{stuGame.grade+=2;}},
        {id:'f2', name:'ğŸ’° å¯ŒäºŒä»£å‘å°', cost:500, desc:'æ¯æœˆé›¶èŠ±é’±+100', eff:()=>{stuGame.money+=100;}},
        {id:'f3', name:'ğŸƒ ä½“è‚²ç‰¹é•¿ç”Ÿ', cost:200, desc:'æ¯æœˆä½“è´¨+3', eff:()=>{stuGame.fit+=3;}}
    ];

    // å››å¤§æ‹çˆ±å¯¹è±¡é…ç½®
    const CRUSHES = [
        { 
            id: 'lin', name: 'æ—çŸ¥ç§‹', title: 'å­¦éœ¸ç­é•¿', desc: 'è¡¨é¢é«˜å†·ä¸¥è°¨ï¼Œå®åˆ™å†…å¿ƒæ¸´æœ›è¢«ç†è§£ã€‚æ¸…åŒ—ç§å­é€‰æ‰‹ã€‚',
            dialogues: ["è¿™é“é¢˜é€‰Cï¼Œåˆ«å‘å‘†äº†ã€‚","ä»Šå¤©çš„æ—©è¯»ä½ è¿Ÿåˆ°äº†1åˆ†é’Ÿã€‚","ç¬”è®°å€Ÿä½ ï¼Œä¸è¦å¼„è„ã€‚","ä½ è§‰å¾—â€¦â€¦å®‡å®™æœ‰è¾¹ç•Œå—ï¼Ÿ","å‘¨æœ«é™ªæˆ‘å»è¶Ÿå›¾ä¹¦é¦†å§ã€‚","åˆ«è€æ˜¯ç©æ¸¸æˆäº†ï¼Œå¿«æœˆè€ƒäº†ã€‚","æˆ‘çš„ç›®æ ‡æ˜¯æ¸…åï¼Œä½ å‘¢ï¼Ÿ","ä»Šå¤©è®²çš„æ•°åˆ—ä½ å¬æ‡‚äº†å—ï¼Ÿ","æˆ‘å¶å°”ä¹Ÿä¼šè§‰å¾—ç´¯â€¦â€¦","ä½ ä¸ºä»€ä¹ˆæ€»æ˜¯çœ‹ç€æˆ‘ï¼Ÿ"],
            events: {
                30: { trigger: false, name:"å¤©å°èƒŒå•è¯", desc:"å‘ç°å¥¹å·å·åœ¨å¤©å°ä¸Šå†™è¯—ã€‚", check:()=>hasPolicy('A1')?1.5:(hasPolicy('D2')?0.7:1), log:"å¥¹æ¬£èµä½ çš„è‡ªå¾‹ï¼Œå¥½æ„Ÿå€å¢ã€‚" },
                60: { trigger: false, name:"æ•´ç†ç«èµ›èµ„æ–™", desc:"ç†¬å¤œç…§é¡¾ç”Ÿç—…çš„å¥¹ã€‚", check:()=>hasPolicy('A7')?2:1, log:"å…±åŒçš„ç«èµ›ç›®æ ‡è®©ä½ ä»¬ç´§ç´§ç›¸è¿ã€‚" },
                90: { trigger: false, name:"çº¦å®šæœªæ¥", desc:"ä¸€èµ·æŠ¥è€ƒåŒä¸€æ‰€å¤§å­¦ã€‚", check:()=>hasPolicy('A6')?(stuGame.grade>=80?1:-999):1, log:"ä½ ä»¬è®¸ä¸‹äº†ç¥åœ£çš„è¯ºè¨€ã€‚" }
            }
        },
        { 
            id: 'xia', name: 'å¤æ™šæ™´', title: 'è‰ºæœ¯ç‰¹é•¿ç”Ÿ', desc: 'è‡ªç”±æ´’è„±ï¼Œè®¨åŒæŸç¼šï¼Œæ„Ÿæ€§æµªæ¼«ã€‚åœ¨æ ¡å¤–å…¼èŒæ¨¡ç‰¹ã€‚',
            dialogues: ["è¿™æœµäº‘çš„å½¢çŠ¶åƒä¸åƒä¸€é¡¶å¸½å­ï¼Ÿ","å­¦æ ¡çš„åˆ¶æœçœŸéš¾çœ‹ã€‚","å‘¨æœ«æˆ‘è¦å»æ¼«å±•ï¼Œä¸€èµ·æ¥å—ï¼Ÿ","æˆ‘åˆšæ‰ç”»äº†ä½ ï¼Œåˆ«åŠ¨ï¼","å¥½æƒ³é€ƒè¯¾å»æµ·è¾¹å•Šâ€¦â€¦","ä½ å–œæ¬¢æ¢µé«˜è¿˜æ˜¯è«å¥ˆï¼Ÿ","å¬è¿™é¦–æ­Œï¼Œæ˜¯ä¸æ˜¯å¾ˆæœ‰æ„Ÿè§‰ï¼Ÿ","æˆ‘è®¨åŒè¢«è§„åˆ™æŸç¼šã€‚","ä½ è§‰å¾—æˆ‘è¿™èº«æ­é…æ€ä¹ˆæ ·ï¼Ÿ","å˜˜ï¼Œåˆ«å‘Šè¯‰è€å¸ˆæˆ‘åœ¨ç”»ç”»ã€‚"],
            events: {
                30: { trigger: false, name:"æ±Ÿè¾¹å†™ç”Ÿ", desc:"èŠèµ·å¥¹æƒ³å»æ„å¤§åˆ©ç•™å­¦ã€‚", check:()=>hasPolicy('D3')?1.5:(hasPolicy('A4')?0.5:1), log:"è‰ºæœ¯èŠ‚ç­¹åŠè®©å¥¹æ„Ÿå—åˆ°äº†è¢«é‡è§†ã€‚" },
                60: { trigger: false, name:"ç”»ä½œè¢«æ‰¹", desc:"å¥¹çš„ç”»è¢«è€å¸ˆæ‰¹è¯„ï¼Œä½ ç«™å‡ºæ¥ä¸ºå¥¹è¾©æŠ¤ã€‚", check:()=>hasPolicy('D5')?2:0.5, log:"ä½ çš„è¾©æŠ¤æ‰“åŠ¨äº†å¥¹ã€‚" },
                90: { trigger: false, name:"ç­¹åŠç”»å±•", desc:"éœ€è¦èµ„é‡‘æ”¯æŒã€‚", check:()=>hasPolicy('C2')?(stuGame.money>=500?2:-999):1, log:"ä½ ç”¨èµ„é‡‘èµåŠ©äº†å¥¹çš„ç”»å±•ï¼Œå¥¹æ„ŸåŠ¨è½æ³ªã€‚" }
            }
        },
        { 
            id: 'jiang', name: 'æ±Ÿä¸€èˆŸ', title: 'ä½“è‚²ç‰¹é•¿ç”Ÿ', desc: 'æ ¡ç¯®çƒé˜Ÿé˜Ÿé•¿ï¼Œé˜³å…‰å¼€æœ—ã€‚è®²ä¹‰æ°”ï¼Œæœ‰ç‚¹è½æ’ã€‚',
            dialogues: ["èµ°ï¼Œæ‰“çƒå»ï¼","ä½ è¿™ä½“èƒ½ä¸è¡Œå•Šï¼Œå¾—å¤šç»ƒã€‚","æ˜¨å¤©é‚£åœºNBAçœ‹äº†æ²¡ï¼Ÿ","é¥¿æ­»äº†ï¼Œå»é£Ÿå ‚åƒçƒ§çƒ¤ã€‚","å…„å¼Ÿï¼Œå¸®æˆ‘æŠ„ä¸‹ä½œä¸šå‘—ã€‚","æˆ‘å¯æ˜¯è¦è¿›å›½å®¶é˜Ÿçš„ç”·äººã€‚","åˆ«æ€•ï¼Œæœ‰æˆ‘åœ¨æ²¡äººæ•¢æ¬ºè´Ÿä½ ã€‚","å“å‘€ï¼Œå—ä¼¤æ˜¯å®¶å¸¸ä¾¿é¥­ã€‚","å‘¨æœ«å»ç½‘å§å¼€é»‘ï¼Ÿ","ä½ è§‰å¾—é‚£ä¸ªå•¦å•¦é˜Ÿé•¿æ€ä¹ˆæ ·ï¼Ÿå¼€ç©ç¬‘çš„å•¦ã€‚"],
            events: {
                30: { trigger: false, name:"èµ›åçƒ§çƒ¤", desc:"çœ‹ä»–æ‰“çƒèµ›åä¸€èµ·å»åƒçƒ§çƒ¤ã€‚", check:()=>(getFacLevelCount('track',1)>0)?1.5:(hasPolicy('D2')?1.2:0.8), log:"æ–°çƒé¦†è®©ä»–æˆ˜æ„é«˜æ˜‚ã€‚" },
                60: { trigger: false, name:"æ‹‰å–èµåŠ©", desc:"çƒé˜Ÿé¢ä¸´è§£æ•£å±æœºï¼Œä½ å¸®ä»–æ‹‰èµåŠ©ã€‚", check:()=>hasPolicy('C4')?2:1, log:"æ ¡å‹æŠ•èµ„æŒ½æ•‘äº†çƒé˜Ÿã€‚" },
                90: { trigger: false, name:"å…¨å¸‚å†³èµ›", desc:"ä½ å»ç°åœºåŠ æ²¹åŠ©å¨ã€‚", check:()=>hasPolicy('A4')?0.1:1.5, log:"ä½ åœ¨åœºè¾¹å¤§å–Šäº†ä»–çš„åå­—ã€‚" }
            }
        },
        { 
            id: 'shen', name: 'æ²ˆæ¸”', title: 'å›é€†è½¬æ ¡ç”Ÿ', desc: 'ä»å¤§åŸå¸‚è½¬æ¥ï¼ŒæŠ½çƒŸé€ƒè¯¾æŸ“å‘ã€‚å˜´ç¡¬å¿ƒè½¯ï¼Œé˜²å¾¡å¿ƒæå¼ºã€‚',
            dialogues: ["åˆ«çƒ¦æˆ‘ã€‚","ä½ å†çœ‹æˆ‘è¯•è¯•ï¼Ÿ","æ— èŠé€é¡¶çš„å­¦æ ¡ã€‚","å€Ÿä¸ªç«ã€‚","ä½ æƒ³çŸ¥é“æˆ‘è¿‡å»çš„äº‹ï¼Ÿåˆ«é—®ã€‚","è¿™é‡Œçš„ç©ºæ°”çœŸæ²‰é—·ã€‚","ä½ ä¸ºä»€ä¹ˆä¸å’Œå…¶ä»–äººä¸€æ ·èº²ç€æˆ‘ï¼Ÿ","æˆ‘ä¸éœ€è¦åŒæƒ…ã€‚","è¿™é¦–æ­Œï¼Œä½ å¬è¿‡å—ï¼Ÿ","å…¶å®â€¦â€¦è°¢è°¢ä½ é‚£å¤©å¸®æˆ‘ã€‚"],
            events: {
                30: { trigger: false, name:"å‘ç°ç§˜å¯†", desc:"å‘ç°å¥¹å…¶å®åœ¨æ‰“å·¥å…»å®¶ï¼Œä½ å¸®å¥¹ä¿å®ˆç§˜å¯†ã€‚", check:()=>hasPolicy('B1')?-1:(getFacLevelCount('clinic',0)>0?1.5:1), log:"ä½ çš„ç†è§£èåŒ–äº†å¥¹çš„å†°å†·ã€‚" },
                60: { trigger: false, name:"è‹±é›„æ•‘ç¾", desc:"å¥¹è¢«å°æ··æ··çº ç¼ ï¼Œä½ æŒºèº«è€Œå‡ºã€‚", check:()=>hasPolicy('B4')?2:1, log:"å®‰ä¿é˜Ÿçš„ä»‹å…¥è®©äº‹ä»¶å’Œå¹³è§£å†³ã€‚" },
                90: { trigger: false, name:"æ•å¼€å¿ƒæ‰‰", desc:"å¥¹ç”Ÿæ—¥ï¼Œä½ é€äº†å¥¹å–œæ¬¢çš„ä¹¦ã€‚", check:()=>hasPolicy('B3')?-1:1.5, log:"å¥¹ç¬¬ä¸€æ¬¡å¯¹ä½ éœ²å‡ºäº†çœŸå¿ƒçš„å¾®ç¬‘ã€‚" }
            }
        }
    ];

    const EVENT_POOL = [
        { t: "æ•™è‚²å±€çªå‡»æš—è®¿", d: "ä¸Šé¢çªå‡»æ£€æŸ¥è¿è§„è¡¥è¯¾ã€‚", o1: "å¡é’±æ‰“ç‚¹", a1:{act:()=>payCost(0,5)?(log("èŠ±é’±æ¶ˆç¾"),true):false, txt:"è€—èµ„ï¿¥5ä¸‡"}, o2: "ç¡¬æŠ—å®¡æŸ¥", a2:{act:()=>{game.discipline>65?mod("reputation",15):mod("reputation",-20);return true;}, txt:"çºªå¾‹>65å£°èª‰+15ï¼Œå¦åˆ™-20"} },
        { t: "é£Ÿå ‚é¼ å¤´é¸­è„–äº‹ä»¶", d: "å­¦ç”Ÿæ‹ç…§å‘äº†å¾®åšçƒ­æœã€‚", o1: "èŠ±é’±å‹çƒ­æœ", a1:{act:()=>payCost(0,10)?(mod("stress",5),true):false, txt:"è€—èµ„ï¿¥10ä¸‡,å‹åŠ›+5"}, o2: "æ‰¿è®¤å¹¶æ•´æ”¹", a2:{act:()=>{mod("reputation",-20); mod("funds",-5);return true;}, txt:"å£°èª‰-20,èµ„é‡‘-5ä¸‡"} },
        { t: "å¤©å°æŠ‘éƒé¢„è­¦", d: "æœ‰å­¦ç”Ÿå—ä¸äº†çˆ¬ä¸Šå¤©å°ï¼", o1: "ç´§æ€¥å¿ƒç†å¹²é¢„", a1:{act:()=>payCost(2,5)?(mod("stress",-10),true):false, txt:"è€—AP:2,ï¿¥5ä¸‡,å‹åŠ›-10"}, o2: "æ¶ˆé˜²å¼ºè¡Œæ‹‰ä¸‹", a2:{act:()=>{mod("stress",15);return true;}, txt:"å‹åŠ›+15"} },
        { t: "å°–å­ç”Ÿæ—©æ‹è¢«æŠ“", d: "å…¨æ ¡ç¬¬ä¸€å’Œç¬¬äºŒåœ¨æ“åœºçº¦ä¼šã€‚", o1: "æ£’æ‰“é¸³é¸¯è®°è¿‡", a1:{act:()=>{mod("stress",10); mod("discipline",5);return true;}, txt:"å‹åŠ›+10,çºªå¾‹+5"}, o2: "é¡ºå…¶è‡ªç„¶", a2:{act:()=>{mod("grade",-5); mod("discipline",-5);return true;}, txt:"å­¦ä¸š-5,çºªå¾‹-5"} },
        { t: "æ ¡å¤–é»‘å¸®æ”¶ä¿æŠ¤è´¹", d: "å‘¨è¾¹æ²»å®‰æ€¥å‰§æ¶åŒ–ã€‚", o1: "é›‡ä½£å®‰ä¿é˜Ÿ", a1:{act:()=>payCost(0,8)?(mod("discipline",10),true):false, txt:"è€—èµ„ï¿¥8ä¸‡,çºªå¾‹+10"}, o2: "ä¸é—»ä¸é—®", a2:{act:()=>{mod("stress",15);mod("discipline",-10);return true;}, txt:"å‹åŠ›+15,çºªå¾‹-10"} },
        { t: "ç«äº‰ç§ç«‹åæ ¡æ¥æŒ–å¢™è„š", d: "éš”å£æƒ³ç”¨ä¸¤å€å·¥èµ„æŒ–ä½ çš„åå¸ˆã€‚", o1: "åŠ è–ªæŒ½ç•™", a1:{act:()=>payCost(0,10)?(mod("grade",5),true):false, txt:"è€—èµ„ï¿¥10ä¸‡,å­¦ä¸š+5"}, o2: "çˆ±èµ°èµ°ä¸ç•™", a2:{act:()=>{mod("grade",-10);return true;}, txt:"å­¦ä¸š-10"} },
        { t: "æ¸…åå­¦éœ¸çŠ¶å…ƒç¬”è®°æ³„éœ²", d: "å…¨æ ¡ç–¯æŠ¢å¤å°ï¼Œå¼•å‘è¸©è¸é£é™©ã€‚", o1: "å­¦æ ¡å‡ºèµ„å®˜æ–¹å°å‘", a1:{act:()=>payCost(0,3)?(mod("grade",5),true):false, txt:"è€—èµ„ï¿¥3ä¸‡,å­¦ä¸š+5"}, o2: "æ²¡æ”¶å……å…¬", a2:{act:()=>{mod("stress",10);mod("discipline",5);return true;}, txt:"å‹åŠ›+10,çºªå¾‹+5"} },
        { t: "äº’è”ç½‘å¤§å‚é«˜ç®¡æ ¡å‹å›è®¿", d: "æ›¾ç»çš„åˆºå¤´å­¦ç”Ÿå¦‚ä»Šèº«ä»·è¿‡äº¿ã€‚", o1: "æœ€é«˜è§„æ ¼æ¥å¾…æ‹‰æŠ•èµ„", a1:{act:()=>payCost(2,5)?(mod("funds",30),true):false, txt:"è€—AP:2,ï¿¥5ä¸‡,è·ï¿¥30ä¸‡"}, o2: "ç®€å•åº§è°ˆ", a2:{act:()=>{mod("reputation",10);return true;}, txt:"å£°èª‰+10"} }
    ];

    // ================= å…¨å±€çŠ¶æ€ =================
    let metaData = { rebirthPoints: 0, unlockedEndings: [], alumni: [] };
    let defaultGame = {
        year: 2018, month: 9, levelIdx: 0, diff: 1, funds: 100, reputation: 100, ap: 10, maxAp: 20, eduPoints: 0, students: 300, examPoints: 0,
        grade: 40, stress: 10, discipline: 60, fitness: 50, art: 30, schedule: { main: 20, minor: 15, spec: 5 }, teachers: { main: 0, minor: 0, spec: 0 },
        unlockedNodes: [], unlockedExperts: [], branches: [], achievements: [], map: new Array(20).fill(null), policies: [],
        gaokaoHistory: [], lastGaokaoAvg: 0, seniorYear: false, seniorCountdown: 0,
        yearEndRating: [], battleSquad: [],
        shopData: { permBought:{}, monthlyBought:{}, month:9 },
        policyDiscount: 0, repShield: false, inspectImmune: false, nextGachaGuarantee: null, shards: 0
    };
    let game = null; let autoInterval = null; let selectedMapIndex = -1; let currentMode = 'principal';
    
    // å­¦ç”Ÿæ¨¡å¼çŠ¶æ€
    let stuGame = { active: false, year:1, month:1, turn:1, grade:40, stress:0, fit:40, art:40, talent:[], family:'', money:0, crushes:{}, lover:false, loverName:'', friends:[], examScore: 0, energy: 100, maxEnergy: 100, olympiadProgress: 0, isInsured: false };
    
    // æˆ˜æ–—çŠ¶æ€æœº
    let bState = { active: false, isOver: false, turn: 1, phase: '', p: {}, e: {}, log: [], rivalId: '', pts: 0, currentCat: 'atk', weather: null, expertUsed: false };

    // ================= åˆå§‹åŒ– =================
    function showDiffScreen() {
        let ds = document.getElementById('diff-screen');
        if(ds) ds.style.display = 'flex';
    }
    function hideDiffScreen() {
        let ds = document.getElementById('diff-screen');
        if(ds) ds.style.display = 'none';
    }

    function init() {
        // Always start with a valid game object
        game = JSON.parse(JSON.stringify(defaultGame));
        
        let meta = localStorage.getItem('school_v12_meta');
        if(meta) { try { metaData = JSON.parse(meta); } catch(e) {} }

        let saved = localStorage.getItem('school_v12_save');
        if(saved) {
            try {
                let parsed = JSON.parse(saved);
                game = Object.assign(JSON.parse(JSON.stringify(defaultGame)), parsed);
                // Repair any missing/invalid fields for old save compatibility
                if (game.diff === undefined || game.diff === null || !DIFF_MODS[game.diff]) game.diff = 1;
                if (!game.map || !Array.isArray(game.map)) game.map = new Array(20).fill(null);
                if (!Array.isArray(game.unlockedExperts)) game.unlockedExperts = [];
                if (!Array.isArray(game.policies)) game.policies = [];
                if (!Array.isArray(game.branches)) game.branches = [];
                if (!Array.isArray(game.achievements)) game.achievements = [];
                if (!Array.isArray(game.gaokaoHistory)) game.gaokaoHistory = [];
                if (!Array.isArray(game.battleSquad)) game.battleSquad = [];
                if (!game.teachers || typeof game.teachers !== 'object') game.teachers = { main: 0, minor: 0, spec: 0 };
                if (!game.schedule || typeof game.schedule !== 'object') game.schedule = { main: 20, minor: 15, spec: 5 };
                hideDiffScreen();
                log("è¯»å–å­˜æ¡£æˆåŠŸï¼éœ¸ä¸šç»§ç»­ã€‚");
                updateUI();
            } catch(e) {
                console.error("å­˜æ¡£è§£æå¤±è´¥ï¼Œé‡ç½®:", e);
                localStorage.removeItem('school_v12_save');
                game = JSON.parse(JSON.stringify(defaultGame));
                showDiffScreen();
            }
        } else {
            showDiffScreen();
        }
    }
    
    // ========== åŸºç¡€å¼•æ“ ==========
    function saveGame() { 
        localStorage.setItem('school_v12_save', JSON.stringify(game)); 
        localStorage.setItem('school_v12_meta', JSON.stringify(metaData));
        showToast("ğŸ’¾ ä¿å­˜æˆåŠŸ"); 
    }
    function hardReset() { if(confirm("è½®å›é‡å»ºï¼Œå½“å‰è¿›åº¦å½’é›¶ï¼ˆä¿ç•™è½®å›ç‚¹ï¼‰ï¼Œç¡®å®šå—ï¼Ÿ")){ if(autoInterval) toggleAuto(); localStorage.removeItem('school_v12_save'); game = JSON.parse(JSON.stringify(defaultGame)); showDiffScreen(); }}
    function getScaleFactor() {
        if(!game) return 1;
        let diff = (game.diff !== undefined && DIFF_MODS[game.diff]) ? game.diff : 1;
        return Math.max(1.0, (game.students / 500) * DIFF_MODS[diff].costMult);
    }
    function mod(stat, val) { game[stat] += val; }
   function getFacLevelCount(type, minLevel) { 
        try {
            if (!game || !game.map || !Array.isArray(game.map)) return 0;
            return game.map.filter(x => x && x.id === type && x.level >= minLevel).length;
        } catch(e) { return 0; }
    }
    function hasExpert(id) { return game && Array.isArray(game.unlockedExperts) && game.unlockedExperts.includes(id); }
    function hasPolicy(id) { return game && Array.isArray(game.policies) && game.policies.includes(id); }
    function hasBranch(id) { return game && Array.isArray(game.branches) && game.branches.includes(id); }
    
    function log(msg, color="#334155") { let b = document.getElementById('log-box'); if(!b) return; let date = (game && game.year) ? `[${game.year}.${game.month}]` : '[--]'; b.innerHTML = `<div class="log-item"><span style="color:var(--primary);font-weight:bold;">${date}</span> <span style="color:${color}">${msg}</span></div>` + b.innerHTML; }
    function showToast(msg) { let b = document.getElementById('toast-container'); let t = document.createElement('div'); t.className = 'toast'; t.innerText = msg; b.appendChild(t); setTimeout(()=>t.remove(), 3900); }
    
    // å¼¹çª—ç³»ç»Ÿ
    window.currentModalCallbacks = [];
    function showCustomModal(title, desc, btns) {
        document.getElementById('modal-title').innerHTML = title; 
        document.getElementById('modal-desc').innerHTML = desc;
        let btnContainer = document.getElementById('modal-buttons'); btnContainer.innerHTML = '';
        window.currentModalCallbacks = btns.map(b => b.action || function(){});
        btns.forEach((b, i) => {
            let btnEl = document.createElement('button'); btnEl.className = 'modal-btn'; btnEl.innerHTML = b.text;
            btnEl.onclick = function() { document.getElementById('modal-overlay').style.display = 'none'; window.currentModalCallbacks[i](); };
            btnContainer.appendChild(btnEl);
        });
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function openModal(id) { 
        if(!game || !game.map) return showToast("è¯·å…ˆé€‰æ‹©éš¾åº¦å¼€å§‹æ¸¸æˆï¼");
        document.getElementById(id).style.display='flex'; 
        if(id==='modal-achieve') renderAchievements();
        if(id==='modal-rnd') renderRnd('scroll');
        if(id==='modal-shop') renderShop('infra');
        renderModals(); 
    }

    function showDifficultySelect() {
        showCustomModal("ğŸŒ å¼€å¯éœ¸ä¸šçºªå…ƒï¼šé€‰æ‹©éš¾åº¦", "éš¾åº¦å†³å®šåˆå§‹èµ„é‡‘ã€æ—¥å¸¸å¼€é”€å€ç‡ä»¥åŠå­¦ç”ŸæŠ—å‹èƒ½åŠ›çš„æé™ã€‚", [
            {text:"ç®€å• (é€‚åˆä¼‘é—²ä½“éªŒ)", action:()=>startGame(0)}, 
            {text:"æ­£å¸¸ (æ ‡å‡†æ¨¡æ‹Ÿæ³•åˆ™)", action:()=>startGame(1)}, 
            {text:"å›°éš¾ (æè‡´æŠ—å‹æŠ˜ç£¨)", action:()=>startGame(2)}
        ]);
    }
    function startGame(diffIdx) {
        game = JSON.parse(JSON.stringify(defaultGame));
        game.diff = diffIdx;
        game.funds = DIFF_MODS[diffIdx].startFund;
        hideDiffScreen();
        log(`é€‰æ‹©äº†ã€${DIFF_MODS[diffIdx].name}ã€‘éš¾åº¦ã€‚å­¦æ ¡æ­£å¼æŒ‚ç‰Œæˆç«‹ï¼`);
        updateUI();
    }

    // ================= æ ¸å¿ƒæ¨æ¼”é€»è¾‘ =================
    function advanceMonth() {
        if(!game || !game.map) return showToast("è¯·å…ˆé€‰æ‹©éš¾åº¦å¼€å§‹æ¸¸æˆï¼");
        if(bState.active) return showToast("æˆ˜æ–—ä¸­æ— æ³•æ¨è¿›ï¼");
        let advBtn = document.getElementById('btn-advance'); if(game.funds <= 0 && advBtn && advBtn.disabled) return;
        game.month++; if (game.month > 12) { game.month = 1; game.year++; }
        
        // APæ¢å¤
        let hallLevel = getFacLevelCount('hall',0) ? game.map.find(x=>x&&x.id==='hall').level : -1;
        game.maxAp = 20 + (game.levelIdx * 5) + (hallLevel>=0?5:0) + (hallLevel>=1?10:0) + (hallLevel>=2?30:0) + (hasBranch('b_beijing')?5:0);
        game.ap = Math.min(game.maxAp, game.ap + 3);

        // åˆ†æ ¡æ”¶ç›Š
        BRANCHES_DB.forEach(b => {
            if(hasBranch(b.id)) {
                if(b.id.includes('hengshui')) game.reputation += 20;
                if(b.id.includes('beijing')) game.funds += 100;
                if(b.id.includes('shanghai')) game.reputation += 50;
                if(b.id.includes('harvard')) game.funds += 500;
                if(b.id.includes('oxford')) game.eduPoints += 50;
                if(b.id.includes('huanggang')) game.grade += 0.5;
            }
        });

        // æ¯å­¦æœŸæ”¶å­¦è´¹ (3æœˆä¸9æœˆ) - æ ¹æ®å£°èª‰ã€åœ¨æ ¡è§„æ¨¡ã€å­¦æ ¡ç­‰çº§åŠ¨æ€è°ƒæ•´
        if (game.month === 3 || game.month === 9) {
            let lvl = SCHOOL_LEVELS[game.levelIdx];
            
            // åœ¨æ ¡è§„æ¨¡ï¼šåŸºç¡€äººæ•° Ã— å£°èª‰ç³»æ•°ï¼ˆå£°èª‰è¶Šé«˜ï¼Œæ‹›ç”Ÿè¶Šå¤šï¼Œä¸Šé™1.8å€ï¼Œä¸‹é™0.4å€ï¼‰
            let repFactor = Math.max(0.4, Math.min(1.8, 0.6 + game.reputation / (lvl.reqRep || 500) * 0.6));
            game.students = Math.floor(lvl.baseStu * repFactor);
            game.students = Math.max(50, game.students);

            // å­¦è´¹å•ä»·ï¼šåŸºç¡€è´¹ç‡ Ã— å­¦æ ¡ç­‰çº§ç³»æ•° Ã— å£°èª‰æº¢ä»· Ã— é«˜è€ƒæˆç»©åŠ æˆ
            let baseRate = lvl.tuition;                                              // åŸºç¡€è´¹ç‡ï¼ˆä¸‡/äººï¼‰
            let repPremium = 1 + Math.min(1.0, game.reputation / 5000);            // å£°èª‰æº¢ä»·æœ€å¤šç¿»å€
            let gaokaoBonus = game.lastGaokaoAvg ? Math.max(0, (game.lastGaokaoAvg - 450) / 1500) : 0; // é«˜è€ƒå‡åˆ†è¶Šé«˜å­¦è´¹è¶Šè´µ
            let tuitionPerHead = baseRate * repPremium * (1 + gaokaoBonus);

            let income = Math.floor(game.students * tuitionPerHead);
            game.funds += income;
            let semesterName = game.month === 3 ? 'æ˜¥å­£å­¦æœŸ' : 'ç§‹å­£å­¦æœŸ';
            log(`ğŸ« ã€${semesterName}å¼€å­¦ã€‘åœ¨æ ¡ç”Ÿ ${game.students} äºº Ã— å­¦è´¹ ï¿¥${(tuitionPerHead * 10000).toFixed(0)}å…ƒ = æ”¶å…¥ ï¿¥${income}ä¸‡`, "var(--success)");
            showToast(`ğŸ“š ${semesterName}å­¦è´¹æ”¶å…¥ ï¿¥${income}ä¸‡`);
        }

        // åŸºç¡€æ¶ˆè€—
        let scale = getScaleFactor();
        let totalSal = (TEACHER_TIERS[game.teachers.main].salary + TEACHER_TIERS[game.teachers.minor].salary + TEACHER_TIERS[game.teachers.spec].salary) * (game.students / 150); 
        let upkeep = SCHOOL_LEVELS[game.levelIdx].upkeep * scale * (hasExpert('e2')?0.85:1);
        let exUpkeep = 0; game.unlockedExperts.forEach(id => { exUpkeep += EXPERT_POOL.find(x=>x.id===id).upkeep; });
        game.funds -= (totalSal + upkeep + exUpkeep);

        // å±æ€§å˜åŠ¨
        let fMain = game.schedule.main / 20; 
        game.grade += 1.0 * fMain * TEACHER_TIERS[game.teachers.main].multi;
        let stressGain = 1.5 * fMain * DIFF_MODS[game.diff !== undefined && DIFF_MODS[game.diff] ? game.diff : 1].stressMult;
        let clinicReduce = getFacLevelCount('clinic',0)*5 + getFacLevelCount('clinic',1)*10;
        if(getFacLevelCount('clinic',2)>0) stressGain = 0; else game.stress += Math.max(0, stressGain - clinicReduce);
        
        game.fitness += 0.5; game.art += 0.5;

        checkCrisis(); clampStats(); checkAchievements(); updateMailbox();
        applyAdjacencyBonuses(); // å»ºç­‘ç›¸é‚»åŠ æˆ
        // æ”¿ç­–æŠ˜æ‰£å€’è®¡æ—¶
        if(game.policyDiscount>0) game.policyDiscount--;
        // æœˆåº¦ç›®æ ‡åˆ·æ–° + æ•™è‚²å±€å…³ç³»è¢«åŠ¨è¡°å‡ + ç¤¾åŒºè¢«åŠ¨å½±å“
        generateMonthlyTargets();
        initSocialRelations();
        // æ•™è‚²å±€é«˜å¥½æ„Ÿå¸¦æ¥æ”¿ç­–æ‹¨æ¬¾
        if(game.social && game.social.govRelations.edu_bureau >= 70) { game.funds += 5; }
        // ç¤¾åŒºä½å¥½æ„Ÿå¸¦æ¥å£°èª‰æƒ©ç½š
        if(game.social && game.social.communityRel < 20) { game.reputation -= 5; log("ğŸ˜ï¸ ç¤¾åŒºå±…æ°‘æŒç»­æŠ•è¯‰ï¼Œå£°èª‰å—æŸ", "#ef4444"); }
        // æ•™å¸ˆæ´¾ç³»å½±å“ï¼ˆå¹´è½»æ´¾å ä¼˜â†’å­¦ä¸šï¼Œä¼ ç»Ÿæ´¾å ä¼˜â†’çºªå¾‹ï¼Œæ”¹é©æ´¾å ä¼˜â†’è‰ºæœ¯ï¼‰
        if(game.social) {
            let f = game.social.teacherFactions;
            if(f.young >= 70) game.grade = Math.min(100, game.grade + 0.5);
            if(f.old >= 70) game.discipline = Math.min(100, game.discipline + 0.5);
            if(f.reform >= 70) game.art = Math.min(100, game.art + 0.5);
            let maxF = Math.max(f.young, f.old, f.reform);
            let minF = Math.min(f.young, f.old, f.reform);
            if(maxF - minF > 60) { game.stress = Math.min(100, game.stress + 2); }
        }

        // è§¦å‘ç‰¹æ®Šäº‹ä»¶
        if (game.month === 3 || game.month === 11) { triggerExamSeason(); return; }
        if (game.month === 6) { triggerGaokao(); return; }
        if (Math.random() < 0.2) { 
            let e = EVENT_POOL[Math.floor(Math.random()*EVENT_POOL.length)];
            showCustomModal(`ğŸ² çªå‘äº‹ä»¶ï¼š${e.t}`, e.d, [
                {text: e.o1 + `<br><span class="event-eff">${e.a1.txt}</span>`, action:()=>{ if(e.a1.act()){updateUI();}else{advanceMonth();} }},
                {text: e.o2 + `<br><span class="event-eff">${e.a2.txt}</span>`, action:()=>{ e.a2.act(); updateUI(); }}
            ]);
            if(autoInterval) toggleAuto();
        } else updateUI();
    }
    
    function toggleAuto() {
        if(!game || !game.map) return showToast("è¯·å…ˆé€‰æ‹©éš¾åº¦å¼€å§‹æ¸¸æˆï¼");
        let btn = document.getElementById('btn-auto');
        if (autoInterval) { clearInterval(autoInterval); autoInterval = null; btn.classList.remove('active'); btn.innerText = "ğŸ¤– è‡ªåŠ¨æ¨æ¼”"; } 
        else { btn.classList.add('active'); btn.innerText = "ğŸ›‘ åœæ­¢æ¨æ¼”"; autoInterval = setInterval(() => { if(document.getElementById('modal-overlay').style.display === 'flex' || bState.active) return; document.getElementById('btn-advance').click(); }, 1200); }
    }

    function clampStats() { ['grade', 'stress', 'discipline', 'fitness', 'art'].forEach(s => game[s] = Math.max(0, Math.min(100, game[s]))); game.students = Math.max(50, game.students); }
    
    function triggerGameOver(icon, title, reason) {
        if(game._gameOver) return;
        game._gameOver = true;
        if(autoInterval) toggleAuto();
        let rating = getGameRating();
        let yearsRun = game.year - 2018;
        let html = `<div style="text-align:center;">
            <div style="font-size:4rem;">${icon}</div>
            <h2 style="color:var(--danger); margin:5px 0;">${title}</h2>
            <p style="color:#475569;">${reason}ï¼ŒåŠå­¦ <b>${yearsRun}</b> å¹´åç”»ä¸Šå¥ç‚¹ã€‚</p>
            <div style="background:#fef2f2; border:2px solid #fca5a5; border-radius:8px; padding:15px; margin:15px 0;">
                <div style="font-size:3rem; font-weight:900; color:${rating.color};">${rating.grade}</div>
                <div style="font-weight:bold; color:${rating.color};">${rating.name}</div>
                <p style="font-style:italic; color:#475569; margin:8px 0 0;">"${rating.quote}"</p>
            </div>
            <div style="background:#f8fafc; border-radius:8px; padding:12px; text-align:left; font-size:0.9rem;">
                <div>ğŸ“š å­¦ä¸šï¼š${Math.floor(game.grade)} | ğŸ˜° å‹åŠ›ï¼š${Math.floor(game.stress)} | ğŸ“ çºªå¾‹ï¼š${Math.floor(game.discipline)}</div>
                <div>â­ å£°èª‰ï¼š${Math.floor(game.reputation)} | ğŸ“ é«˜è€ƒå±Šæ•°ï¼š${game.gaokaoHistory.length} | ğŸ† è”è€ƒç§¯åˆ†ï¼š${game.examPoints}</div>
            </div>
        </div>`;
        showCustomModal(`ğŸ’€ æ¸¸æˆç»“æŸ Â· ${title}`, html, [
            {text:"ğŸ“œ æŸ¥çœ‹å®Œæ•´ç»“å±€", action:()=>{ showFinalRating('principal'); }},
            {text:"ğŸ”„ é‡æ–°å¼€å§‹", action: hardReset}
        ]);
        let btn = document.getElementById('btn-advance');
        if(btn) { btn.disabled = true; btn.innerText = "ğŸ’€ å·²ç»ˆç»“ Â· æ¸¸æˆç»“æŸ"; btn.style.background = '#7f1d1d'; }
        let ratingBtn = document.getElementById('btn-final-rating');
        if(ratingBtn) ratingBtn.style.display = 'block';
    }

    function checkCrisis() { 
        if(game._gameOver) return true;
        // â‘  èµ„é‡‘ç ´äº§
        if (game.funds < 0) { 
            game.funds = 0;
            triggerGameOver('ğŸ’¸','å­¦æ ¡ç ´äº§',`èµ„é‡‘é“¾æ–­è£‚ï¼Œæ‚¨çš„å­¦æ ¡åœ¨ ${game.year}å¹´${game.month}æœˆ å®£å‘Šç ´äº§`);
            return true; 
        }
        // â‘¡ å£°èª‰å½’é›¶ - è¢«ç¤¾ä¼šæŠ›å¼ƒ
        if(game.reputation <= 0) {
            game.reputation = 0;
            triggerGameOver('ğŸ‘','å£°èª‰å´©å¡Œ',`å­¦æ ¡å£°èª‰å½»åº•å½’é›¶ï¼Œæ•™è‚²å±€è´£ä»¤åœåŠï¼ˆ${game.year}å¹´${game.month}æœˆï¼‰`);
            return true;
        }
        // â‘¢ è¿ç»­3ä¸ªæœˆå‹åŠ›>90 - å‹åŠ›å´©æºƒ
        if(!game._highStressMonths) game._highStressMonths = 0;
        if(game.stress >= 90) { game._highStressMonths++; } else { game._highStressMonths = 0; }
        if(game._highStressMonths >= 3) {
            triggerGameOver('ğŸ’”','æ ¡å›­å¿ƒç†å±æœº',`è¿ç»­ä¸‰ä¸ªæœˆå…¨æ ¡å‹åŠ›çˆ†è¡¨ï¼Œæ¶æ€§äº‹ä»¶é¢‘å‘ï¼Œæ•™è‚²å±€å¼ºåˆ¶åœåŠï¼ˆ${game.year}å¹´${game.month}æœˆï¼‰`);
            return true;
        }
        // â‘£ çºªå¾‹é•¿æœŸä½ä¸‹ - å­¦ç”Ÿæš´åŠ¨
        if(!game._lowDiscMonths) game._lowDiscMonths = 0;
        if(game.discipline <= 10) { game._lowDiscMonths++; } else { game._lowDiscMonths = 0; }
        if(game._lowDiscMonths >= 4) {
            triggerGameOver('ğŸ”¥','å­¦ç”Ÿæš´åŠ¨',`çºªå¾‹é•¿æœŸå´©æºƒï¼Œå­¦ç”Ÿé›†ä½“ç½¢è¯¾å¹¶å†²å‡»æ ¡åŠï¼Œå­¦æ ¡è¢«è¿«åœåŠï¼ˆ${game.year}å¹´${game.month}æœˆï¼‰`);
            return true;
        }
        // â‘¤ ä¸¥é‡è¿è§„æ”¿ç­–è¢«æŸ¥å° (æ”¿ç­–åå™¬)
        if(game._govShutdown) {
            triggerGameOver('ğŸ›ï¸','æ”¿åºœæŸ¥å°',`å­¦æ ¡è¿è§„è¡Œä¸ºè¢«æ•™è‚²å±€ä¸¾æŠ¥å½»æŸ¥ï¼Œå¼ºåˆ¶åœåŠï¼ˆ${game.year}å¹´${game.month}æœˆï¼‰`);
            return true;
        }
        return false;
    }

    // ================= æˆå°±ç³»ç»Ÿ =================
    function checkAchievements() {
        if(!game || !Array.isArray(game.achievements)) return;
        ACHIEVEMENTS.forEach(a => {
            if(!game.achievements.includes(a.id)) {
                let unlocked = false;
                if(a.id==='a1' && game.funds>=1000) unlocked=true;
                if(a.id==='a2' && game.funds>=10000) unlocked=true;
                if(a.id==='a3' && game.reputation>=10000) unlocked=true;
                if(a.id==='a4' && game.levelIdx>=4) unlocked=true;
                if(a.id==='a8' && game.stress>=100) unlocked=true;
                if(a.id==='a9' && game.discipline<=10) unlocked=true;
                if(a.id==='a13' && game.policies.length>=15) unlocked=true;
                if(a.id==='a16' && stuGame.active && stuGame.stress>=100) unlocked=true;
                // å…¶ä»–éšè—æˆå°±é€šè¿‡æ¸¸æˆå†…äº‹ä»¶ç›´æ¥è§¦å‘
                if(unlocked) {
                    game.achievements.push(a.id);
                    showToast(`ğŸ† è·å¾—æˆå°±ï¼š${a.name}`);
                }
            }
        });
    }

    function renderAchievements() {
        let c = document.getElementById('achieve-container');
        c.innerHTML = ACHIEVEMENTS.map(a => {
            let has = game.achievements.includes(a.id);
            return `<div style="background:#fff; border:2px solid ${has?'var(--gold)':'#e2e8f0'}; padding:10px; border-radius:6px; opacity:${has?1:0.5}"><b>${a.name}</b><br><span style="font-size:0.75rem">${a.desc}</span></div>`;
        }).join('');
    }

    // ================= æˆ˜æ–—ç³»ç»Ÿ V2.0 =================
    function triggerExamSeason() {
        if(autoInterval) toggleAuto();
        showBattlePrep();
    }

    function showBattlePrep() {
        openModal('modal-battle');
        document.getElementById('b-prep').style.display = 'block'; document.getElementById('b-main').style.display = 'none';
        
        // Expert squad selection section
        let squadHtml = `<div style="background:#0f172a; border:1px solid #a3e635; border-radius:8px; padding:15px; margin-bottom:25px;">
            <h3 style="color:#fde047; margin-top:0;">âš”ï¸ ç»„å»ºæˆ˜æ–—ç¼–é˜Ÿ (é€‰æ‹© 3-5 ä½ä¸“å®¶)</h3>
            <p style="color:#94a3b8; font-size:0.85rem; margin-bottom:10px;">å·²é€‰ä¸“å®¶çš„æŠ€èƒ½ç»„åˆå°†äº§ç”ŸåŒ–å­¦ååº”ï¼Œå¸¦æ¥é¢å¤–å¢ç›Šã€‚</p>
            <div style="display:flex; flex-wrap:wrap; gap:8px;" id="squad-selector">`;
        game.unlockedExperts.forEach(eid => {
            let ex = EXPERT_POOL.find(x=>x.id===eid);
            if(!ex || !ex.battle) return;
            let inSquad = (game.battleSquad||[]).includes(eid);
            squadHtml += `<button onclick="toggleSquad('${eid}',this)" style="background:${inSquad?'#14532d':'rgba(0,0,0,0.6)'}; border:1px solid ${inSquad?'#a3e635':'#3f6212'}; color:${inSquad?'#a3e635':'#94a3b8'}; padding:6px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem; transition:0.2s;">
                ${ex.name} <span style="font-size:0.65rem;">(${ex.rarity})</span>
            </button>`;
        });
        let squadCount = (game.battleSquad||[]).length;
        let synergy = getBattleSynergy();
        squadHtml += `</div>
            <div style="margin-top:10px; color:#fde047; font-size:0.85rem;">å·²é€‰: <span id="squad-count">${squadCount}</span>/5 | ${synergy}</div>
        </div>`;
        
        let prepDiv = document.getElementById('b-prep');
        // Insert squad section at top if not already present
        let existingSquad = prepDiv.querySelector('.squad-section');
        if(!existingSquad) {
            let squadEl = document.createElement('div');
            squadEl.className = 'squad-section';
            squadEl.innerHTML = squadHtml;
            prepDiv.insertBefore(squadEl, prepDiv.querySelector('h2').nextSibling);
        } else {
            existingSquad.innerHTML = squadHtml;
        }
        
        let render = (list, id) => {
            let el = document.getElementById(id); el.innerHTML = '';
            list.forEach(r => {
                let unlocked = game.levelIdx + 1 >= r.tier;
                let html = `<div style="background:#0f172a; border:1px solid ${unlocked?'#4ade80':'#64748b'}; border-radius:6px; padding:10px; font-size:0.8rem; opacity:${unlocked?1:0.5}; position:relative;">
                    <div style="font-weight:bold; color:${unlocked?'#fff':'#94a3b8'}">${r.name}</div>
                    <div style="color:#fde047; margin:4px 0;">HP:${r.hp} ATK:${r.atk}</div>
                    <div style="color:#fca5a5; font-size:0.7rem; border-top:1px dashed #475569; padding-top:4px;"><b>ç‰¹æ€§:</b> ${r.traitName}</div>
                    ${unlocked ? `<button class="btn" style="margin-top:5px; padding:4px; font-size:0.8rem;" onclick="startBattle('${r.id}')">å‡ºå¾è®¨ä¼</button>` : 'ğŸ”’ ç­‰çº§ä¸è¶³'}
                </div>`;
                el.innerHTML += html;
            });
        };
        render(RIVALS.filter(r=>r.tier===1), 'b-rival-t1');
        render(RIVALS.filter(r=>r.tier===2), 'b-rival-t2');
        render(RIVALS.filter(r=>r.tier===3), 'b-rival-t3');
        render(RIVALS.filter(r=>r.tier===4), 'b-rival-t4');
        render(RIVALS.filter(r=>r.tier===5), 'b-rival-t5');
    }
    
    function toggleSquad(eid, btn) {
        if(!game.battleSquad) game.battleSquad = [];
        let idx = game.battleSquad.indexOf(eid);
        if(idx >= 0) {
            game.battleSquad.splice(idx, 1);
            btn.style.background = 'rgba(0,0,0,0.6)'; btn.style.borderColor = '#3f6212'; btn.style.color = '#94a3b8';
        } else {
            if(game.battleSquad.length >= 5) return showToast("æœ€å¤šé€‰æ‹©5åä¸“å®¶ï¼");
            game.battleSquad.push(eid);
            btn.style.background = '#14532d'; btn.style.borderColor = '#a3e635'; btn.style.color = '#a3e635';
        }
        let c = document.getElementById('squad-count');
        if(c) c.innerText = game.battleSquad.length;
        let syn = document.querySelector('.squad-section');
        if(syn) { let sDiv = syn.querySelector('div[style*="fde047"]'); if(sDiv) { sDiv.innerHTML = `å·²é€‰: <span id="squad-count">${game.battleSquad.length}</span>/5 | ${getBattleSynergy()}`; } }
    }
    
    function getBattleSynergy() {
        let squad = game.battleSquad || [];
        if(squad.length < 3) return `<span style="color:#94a3b8">éœ€è‡³å°‘3äººæ‰èƒ½æ¿€æ´»ååŒæ•ˆåº”</span>`;
        // Check synergies
        let hasHealer = squad.some(id => ['e4','e18','e6'].includes(id));
        let hasAttacker = squad.some(id => ['e7','e11','e16'].includes(id));
        let hasDebuffer = squad.some(id => ['e1','e10','e19'].includes(id));
        let synergies = [];
        if(hasHealer && hasAttacker) synergies.push('<span style="color:#a3e635">âš¡æ”»å®ˆå…¼å¤‡: æ”»å‡»+15%å›è¡€+1%</span>');
        if(hasDebuffer && hasAttacker) synergies.push('<span style="color:#fde047">ğŸ’¥ å…‹åˆ¶æˆ˜æœ¯: æš´å‡»ç‡+20%</span>');
        if(squad.length >= 5) synergies.push('<span style="color:#c084fc">âœ¨ æ»¡ç¼–åŠ æˆ: å…¨å±æ€§+10%</span>');
        return synergies.length ? synergies.join(' | ') : '<span style="color:#64748b">æ— ååŒæ•ˆåº”</span>';
    }

    function startBattle(rId) {
        let r = RIVALS.find(x => x.id === rId);
        document.getElementById('b-prep').style.display = 'none'; document.getElementById('b-main').style.display = 'flex';
        
        // åˆ†æ ¡æˆ˜æ–—å¢ç›Šï¼ˆå¤§å¹…åŠ å¼ºï¼‰
        let branchBuff = { atk:1, def:1, hp:1, crit:0, ap:0 };
        if(hasBranch('b_hengshui')) { branchBuff.atk+=0.35; branchBuff.hp+=0.4; bLog && bLog("è¡¡æ°´åˆ†æ ¡ï¼šæ”»å‡»+35% è¡€é‡+40%"); }
        if(hasBranch('b_beijing'))  { branchBuff.def+=0.4; branchBuff.ap+=10; }
        if(hasBranch('b_shanghai')) { branchBuff.crit+=20; }
        if(hasBranch('b_harvard'))  { branchBuff.atk+=0.4; branchBuff.def+=0.4; branchBuff.hp+=0.4; }
        if(hasBranch('b_oxford'))   { branchBuff.def+=0.3; branchBuff.hp+=0.3; }
        if(hasBranch('b_huanggang')){ branchBuff.atk+=0.5; } // ä½†æ¯å›åˆæ‰£è¡€
        
        // APä¸Šé™éšç­‰çº§æå‡
        let levelApBonus = game.levelIdx * 5;
        let initAp = Math.min(game.maxAp + levelApBonus, game.ap + levelApBonus + branchBuff.ap);

        bState = {
            active: true, isOver: false, turn: 1, phase: 'NORMAL', log: [], currentCat: 'atk',
            rivalId: rId, pts: r.pts, weather: WEATHER_TYPES[Math.floor(Math.random()*WEATHER_TYPES.length)],
            expertUsed: false,
            p: {
                maxHp: Math.floor((game.fitness * 100 + game.students * (10 + game.teachers.spec * 5)) * branchBuff.hp),
                atk: Math.floor(game.grade * (10 + game.teachers.main * 5) * branchBuff.atk),
                def: Math.floor(game.discipline * 8 * branchBuff.def),
                crit: Math.floor(game.art * 0.5 + branchBuff.crit),
                stress: 20, // åˆå§‹æ€ç»´ç†µå¢20ï¼ˆé0ï¼‰
                ap: initAp, maxAp: game.maxAp + levelApBonus, morale: 100,
                buffs: { atkUp:0, defUp:0, critUp:0, dmgUp:0, dodge:0, shield:0, hot:0, dot:0, stun:0, atkDown:0, defDown:0 }
            },
            e: {
                name: r.name, maxHp: r.hp, hp: r.hp, atk: r.atk, def: r.def, stress: 0, morale: 100, hasSummoned: false,
                buffs: { atkUp:0, defUp:0, shield:0, hot:0, stun:0, atkDown:0, defDown:0, dot:0 }
            }
        };
        bState.p.hp = bState.p.maxHp;
        
        // Apply squad synergy
        let squad = game.battleSquad || [];
        if(squad.length >= 3) {
            let hasHealer = squad.some(id => ['e4','e18','e6'].includes(id));
            let hasAttacker = squad.some(id => ['e7','e11','e16'].includes(id));
            let hasDebuffer = squad.some(id => ['e1','e10','e19'].includes(id));
            if(hasHealer && hasAttacker) { bState.p.atk = Math.floor(bState.p.atk * 1.15); bState.p.buffs.hot = 99; }
            if(hasDebuffer && hasAttacker) { bState.p.crit += 20; }
            if(squad.length >= 5) { bState.p.atk = Math.floor(bState.p.atk * 1.1); bState.p.def = Math.floor(bState.p.def * 1.1); }
        }

        // æ¸²æŸ“ä¸“å®¶åˆ—è¡¨ (å¸¦æŠ€èƒ½è¯´æ˜)
        let exEl = document.getElementById('b-expert-list'); exEl.innerHTML = '';
        if(game.unlockedExperts.length === 0) {
            exEl.innerHTML = `<div style="color:#475569;font-size:0.8rem;padding:5px;">å°šæ— ä¸“å®¶å¯è°ƒç”¨</div>`;
        }
        game.unlockedExperts.forEach(eid => {
            let ex = EXPERT_POOL.find(x=>x.id===eid);
            if(!ex || !ex.battle) return;
            let rarityColor = ex.rarity==='SSR'?'#fde047':ex.rarity==='SR'?'#c084fc':'#60a5fa';
            let btn = document.createElement('button');
            btn.style.cssText = `background:rgba(0,0,0,0.7);border:1px solid ${rarityColor};color:#e2e8f0;padding:6px 10px;border-radius:5px;cursor:pointer;font-size:0.72rem;display:flex;align-items:center;gap:6px;text-align:left;transition:0.2s;min-width:180px;`;
            btn.innerHTML = `<div style="width:28px;height:28px;border-radius:14px;overflow:hidden;flex-shrink:0;border:1px solid ${rarityColor};">
                <img src="src/expert/${eid}.png" onerror="this.style.display='none';this.parentNode.innerHTML='<div style=\\'background:${rarityColor};width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:0.6rem;color:#000;\\'>${ex.rarity}</div>'" style="width:100%;height:100%;object-fit:cover;">
            </div>
            <div>
                <div style="color:${rarityColor};font-weight:bold;">${ex.name}</div>
                <div style="color:#94a3b8;font-size:0.65rem;margin-top:1px;">${ex.desc}</div>
            </div>`;
            btn.onmouseover = () => btn.style.background = 'rgba(255,255,255,0.1)';
            btn.onmouseout = () => btn.style.background = 'rgba(0,0,0,0.7)';
            btn.onclick = () => useExpert(eid, btn);
            exEl.appendChild(btn);
        });

        document.getElementById('be-name').innerText = "> " + bState.e.name;
        document.getElementById('be-skill-desc').innerText = `${r.traitName}: ${r.traitDesc}`;
        document.getElementById('b-log').querySelector('.b-log-inner').innerHTML = `<span class="sys">æˆ˜æ–—å¼€å§‹ï¼é­é‡ ${bState.e.name}ï¼</span>`;
        bStartTurn();
    }

    function handleBuffs(entity, isPlayer) {
        let eName = isPlayer ? "æˆ‘æ–¹" : "æ•Œæ–¹";
        if(entity.buffs.dot > 0) {
            let dmg = Math.floor(entity.maxHp * 0.05);
            entity.hp -= dmg;
            bLog(`<span class="e">${eName} å—åˆ°æ¯’ç´ /æµè¡€ä¼¤å®³ ${dmg}ï¼</span>`);
            entity.buffs.dot--;
        }
        if(entity.buffs.hot > 0) {
            let heal = Math.floor(entity.maxHp * 0.08);
            entity.hp = Math.min(entity.maxHp, entity.hp + heal);
            bLog(`<span class="p">${eName} æŒç»­æ¢å¤äº† ${heal} HPï¼</span>`);
            entity.buffs.hot--;
        }
        ['atkUp', 'defUp', 'critUp', 'dmgUp', 'shield', 'stun', 'atkDown', 'defDown'].forEach(k => {
            if(entity.buffs[k] > 0) entity.buffs[k]--;
        });
    }

    function bStartTurn() {
        if(bState.isOver || bCheckEnd()) return;
        bState.expertUsed = false;
        bLog(`<br><span style="color:#94a3b8">--- ROUND ${bState.turn} ---</span>`);
        
        // å¤©æ°”ç³»ç»Ÿ
        if(!bState.weather || bState.turn % 3 === 0) { bState.weather = WEATHER_TYPES[Math.floor(Math.random()*WEATHER_TYPES.length)]; bLog(`â˜ï¸ å¤©æ°”å˜æ›´ä¸ºï¼š${bState.weather.name}`); }
        if(bState.weather && bState.weather.effect) bState.weather.effect(bState.p, bState.e);

        // APæ¢å¤ï¼ˆæ¯å›åˆ+3ï¼Œä¸Šé™ç”±ç­‰çº§å†³å®šï¼‰
        bState.p.ap = Math.min(bState.p.maxAp, bState.p.ap + 3);
        
        // æ€ç»´ç†µå¢è‡ªç„¶å¢é•¿ï¼ˆæ¯å›åˆ+2ï¼‰
        bState.p.stress = Math.min(100, bState.p.stress + 2);
        // æ•Œæ–¹entropyDotï¼ˆç²¾ç¥å´©æºƒå¼¹æ•ˆæœï¼‰
        if(bState.e.buffs.entropyDot > 0) {
            bState.e.stress = Math.min(100, bState.e.stress + 15);
            bState.e.buffs.entropyDot--;
            bLog(`<span style="color:#f472b6">æ•Œæ–¹æ€ç»´ç†µå¢å‘ä½œï¼æ•Œæ–¹å‹åŠ›+15ï¼ˆå‰©ä½™${bState.e.buffs.entropyDot}å›åˆï¼‰</span>`);
        }
        
        // ç†µå¢æ··ä¹±æƒ©ç½šï¼ˆç†µå¢>70æ—¶æ”»é˜²é™ä½ï¼›ç†µå¢>90æ—¶å®Œå…¨æ··ä¹±ï¼‰
        let entropyPenalty = '';
        if(bState.p.stress >= 90) {
            bState.p.buffs.atkDown = Math.max(bState.p.buffs.atkDown, 1);
            bState.p.buffs.defDown = Math.max(bState.p.buffs.defDown, 1);
            entropyPenalty = 'âš ï¸ æ€ç»´ç†µå¢æé«˜ï¼æ”»é˜²å¤§å¹…ä¸‹é™ï¼';
        } else if(bState.p.stress >= 70) {
            entropyPenalty = 'âš ï¸ æ€ç»´æ··ä¹±ï¼Œæ”»é˜²è½»åº¦é™ä½';
        }
        if(entropyPenalty) bLog(`<span style="color:#f59e0b">${entropyPenalty}</span>`);
        
        // BUFF ç»“ç®—
        handleBuffs(bState.p, true);
        handleBuffs(bState.e, false);

        // è§¦å‘æ•Œæ–¹ç‰¹æ€§
        let r = RIVALS.find(x=>x.id===bState.rivalId);
        if(r && r.traitEff) {
            let msg = r.traitEff(bState.p, bState.e);
            if(msg) bLog(`<span style="color:#fde047">[BOSSç‰¹æ€§è§¦å‘] ${msg}</span>`);
        }

        if(hasBranch('b_huanggang')) { bState.p.hp -= Math.floor(bState.p.maxHp*0.04); bLog("å¯†å·åå™¬æ‰£è¡€ï¼"); }
        if(bCheckEnd()) return;

        bUpdateUI();
        if(bState.p.stress >= 100) {
            bLog("ğŸš¨ æ€ç»´ç†µå¢çˆ†è¡¨ï¼Œé™·å…¥æ··ä¹±ï¼è·³è¿‡å›åˆï¼"); bState.p.stress = 40; setTimeout(eAction, 1000);
        } else if(bState.p.buffs.stun > 0) {
            bLog("ğŸš¨ æˆ‘æ–¹è¢«æ™•çœ©ï¼Œæ— æ³•è¡ŒåŠ¨ï¼"); setTimeout(eAction, 1000);
        } else {
            bShowCat(bState.currentCat);
            let btns = document.getElementById('b-expert-list').querySelectorAll('button');
            btns.forEach(b => b.disabled = false); 
        }
    }

    function useExpert(id, btn) {
        if(bState.expertUsed) return showToast("æ¯å›åˆåªèƒ½æŒ‡æ´¾ä¸€åä¸“å®¶ï¼");
        let ex = EXPERT_POOL.find(x=>x.id===id);
        if(!ex || !ex.battle) return showToast("è¯¥ä¸“å®¶æ— æˆ˜æ–—æŠ€èƒ½");
        let msg = ex.battle(bState.p, bState.e);
        if(msg) { 
            bLog(`<span class="sys">âš¡ [${ex.name}] ä¸“å®¶åŠ©é˜µ: ${msg}</span>`); 
            bState.expertUsed = true; 
            btn.disabled = true;
            btn.style.background = '#374151';
            btn.style.color = '#6b7280';
            if(bCheckEnd()) return;
            bUpdateUI(); 
        }
    }

    // ===== æˆ˜æ–—è§†è§‰ç‰¹æ•ˆ =====
    function bFx(entityId, cls, label, color, size) {
        var el = document.getElementById(entityId);
        if(el) {
            el.classList.remove('b-hit','b-crit','b-heal','b-lunge');
            void el.offsetWidth;
            el.classList.add(cls);
            setTimeout(()=>el.classList.remove(cls), 750);
        }
        if(label) {
            var r = el ? el.getBoundingClientRect() : {left:window.innerWidth/2,top:window.innerHeight/2,width:200,height:100};
            var f = document.createElement('div');
            f.className = 'b-dmg-float';
            f.style.cssText = `left:${r.left+r.width*0.2+Math.random()*r.width*0.4}px;top:${r.top+r.height*0.25}px;font-size:${size||'1.5rem'};color:${color||'#ef4444'};`;
            f.textContent = label;
            document.body.appendChild(f);
            setTimeout(()=>f.remove(), 1600);
        }
    }
    function bScreenFlash(color, dur) {
        var f = document.getElementById('b-screen-flash');
        if(!f) return;
        f.style.background = color;
        f.style.animation = 'none';
        void f.offsetWidth;
        f.style.animation = `b-screen-flash ${dur||0.4}s ease-out forwards`;
        setTimeout(()=>{ f.style.animation='none'; f.style.opacity=0; }, (dur||0.4)*1000+50);
    }

    function pAction(sid) {
        let s = SKILL_DB[sid];
        if(bState.p.ap < s.ap) return showToast("APä¸è¶³ï¼");
        bState.p.ap -= s.ap;
        document.getElementById('b-skills-container').innerHTML = ''; // Lock UI

        bLog(`<span class="p">æˆ‘æ–¹é‡Šæ”¾ [${s.name}]</span>`);
        
        // åˆ¤æ–­æŠ€èƒ½ç±»å‹å¹¶ç”Ÿæ•ˆ
        if(sid === 'sys_èµ„æœ¬') {
            if(game.funds>=50) { game.funds-=50; bState.e.hp -= 9999; bLog("é‡‘é’±çš„åŠ›é‡é€ æˆäº†æ¯ç­æ€§æ‰“å‡»ï¼"); }
            else bLog("èµ„é‡‘ä¸è¶³ä»¥é‡Šæ”¾é’èƒ½åŠ›ï¼");
        } else if(sid === 'insp_1') { 
            if(Math.random()<0.3) { bState.e.hp-=999; bLog("æŠ¼ä¸­åŸé¢˜ï¼é€ æˆ999å·¨é¢çœŸå®ä¼¤å®³ï¼"); } else { bState.e.hp-=10; bLog("æŠ¼é¢˜å¤±è´¥...åªé€ æˆäº†10ç‚¹æ“¦ä¼¤"); }
        } else if(s.cat === 'atk' || s.cat === 'insp') {
            let base = 1.0;
            let match = s.desc.match(/(\d+)%/);
            if(match) base = parseInt(match[1]) / 100;
            
            let rawAtk = bState.p.atk * (bState.p.buffs.atkUp>0 ? 1.5 : 1) * (bState.p.buffs.atkDown>0 ? 0.7 : 1);
            // æ€ç»´ç†µå¢â‰¥70æ—¶æ”»å‡»åŠ›è¡°å‡
            if(bState.p.stress >= 90) rawAtk *= 0.6;
            else if(bState.p.stress >= 70) rawAtk *= 0.8;
            let targetDef = bState.e.def * (bState.e.buffs.defUp>0 ? 1.5 : 1) * (bState.e.buffs.defDown>0 ? 0.3 : 1);
            
            // éƒ¨åˆ†æŠ€èƒ½æ— è§†é˜²å¾¡
            if(s.desc.includes('æ— è§†éƒ¨åˆ†é˜²å¾¡')) targetDef *= 0.5;
            if(s.desc.includes('çœŸå®ä¼¤å®³')) targetDef = 0;
            
            let critRate = bState.p.crit + (bState.p.buffs.critUp>0 ? 50 : 0);
            let isCrit = Math.random()*100 < critRate || bState.p.buffs.dmgUp>0;
            
            let dmg = Math.max(10, rawAtk * base - targetDef);
            if(isCrit) { dmg *= (bState.p.buffs.dmgUp>0 ? 2.0 : 1.5); bLog(`<span class="crit">æš´å‡»ï¼</span>`); }
            
            // å¤šæ®µä¼¤å®³å¤„ç†
            let hitCount = 1;
            if(sid === 'atk_4') hitCount = 3;
            if(sid === 'atk_12') hitCount = 4;
            
            let totalDmg = 0;
            for(let i=0; i<hitCount; i++) {
                let currentHit = dmg;
                if(bState.e.buffs.shield > 0) { currentHit=0; bState.e.buffs.shield--; bLog("æ•Œæ–¹æŠ¤ç›¾æŠµæŒ¡äº†ä¼¤å®³ï¼"); }
                else { totalDmg += Math.floor(currentHit); }
            }
            
            bState.e.hp -= totalDmg;
            bLog(`é€ æˆ <span class="dmg">${totalDmg}</span> ç‚¹ä¼¤å®³`);
            // è§†è§‰ç‰¹æ•ˆ
            if(isCrit) { bFx('b-enemy-card','b-crit',`ğŸ’¥ ${totalDmg}`,'#fde047','2rem'); bScreenFlash('rgba(192,132,252,0.35)',0.5); }
            else { bFx('b-enemy-card','b-hit',`-${totalDmg}`,'#ef4444','1.5rem'); }

            
            // æŠ€èƒ½é™„åŠ æ•ˆæœ
            if(sid==='atk_6') bState.e.buffs.defDown = 2;
            if(sid==='atk_7') bState.e.buffs.dot = 3;
            if(sid==='atk_8') bState.p.buffs.stun = 1;
            if(sid==='atk_9') bState.e.buffs.atkDown = 2;
        } else {
            // éæ”»å‡»æŠ€èƒ½
            if(sid==='def_0') bState.p.buffs.defUp = 2;
            if(sid==='def_1') { let h=Math.floor(bState.p.maxHp*0.15); bState.p.hp += h; bState.p.buffs.atkDown=0; bState.p.buffs.defDown=0; bLog("çŠ¶æ€æ¢å¤"); bFx('b-player-card','b-heal',`+${h}`,'#34d399','1.3rem'); }
            if(sid==='def_2') { bState.p.buffs.defUp=2; bState.p.ap+=5; }
            if(sid==='def_3') { bState.p.buffs.shield=1; bLog("è·å¾—æŠ¤ç›¾"); bScreenFlash('rgba(59,130,246,0.2)',0.35); }
            if(sid==='def_4') { bState.p.stress=Math.max(0,bState.p.stress-20); bLog("å‹åŠ›ä¸‹é™"); bFx('b-player-card','b-heal','ğŸ§˜','#a78bfa','1.8rem'); }
            if(sid==='def_5') { bState.p.buffs.shield=2; bLog("è·å¾—å·¨é¢æŠ¤ç›¾"); bScreenFlash('rgba(59,130,246,0.3)',0.4); }
            if(sid==='def_6') { let h=Math.floor(bState.p.maxHp*0.3); bState.p.hp += h; bState.p.buffs.hot=2; bLog("æŒç»­å›è¡€å¼€å§‹"); bFx('b-player-card','b-heal',`+${h}`,'#34d399','1.5rem'); }
            if(sid==='def_7') { bState.p.buffs.dodge=1; bLog("è¿›å…¥é—ªé¿çŠ¶æ€"); bScreenFlash('rgba(251,191,36,0.2)',0.3); }
            if(sid==='def_8') { bState.p.buffs.dmgUp=2; bLog("é˜²å®ˆåå‡»è“„åŠ›"); }
            if(sid==='def_9') { let h=Math.floor(bState.p.maxHp*0.1); bState.p.hp+=h; bState.p.buffs.dot=0; bState.p.buffs.stun=0; bLog("æ¸…å¿ƒå¯¡æ¬²"); bFx('b-player-card','b-heal',`+${h}`,'#34d399','1.2rem'); }
            
            if(sid==='sup_0') { bState.p.ap+=10; }
            if(sid==='sup_1') { bState.p.hp+=bState.p.maxHp*0.05; bState.p.ap+=5; }
            if(sid==='sup_2') { bState.p.buffs.atkUp=3; }
            if(sid==='sup_3') { bState.p.buffs.critUp=2; }
            if(sid==='sup_4') { bState.p.hp=bState.p.maxHp; bState.p.ap=game.maxAp; bLog("å…¨å‘˜æ»¡çŠ¶æ€å¤æ´»ï¼"); bFx('b-player-card','b-heal','âœ¨ æ»¡è¡€å¤æ´»','#fde047','1.6rem'); bScreenFlash('rgba(253,224,71,0.4)',0.6); }
            if(sid==='sup_5') { bState.p.buffs.atkUp=2; bState.p.buffs.defUp=2; bState.p.buffs.critUp=2; bLog("è€ƒç¥é™„ä½“å…¨å±æ€§æå‡ï¼"); bScreenFlash('rgba(251,191,36,0.3)',0.5); }

            if(sid==='psy_0') { bState.e.stress+=15; bFx('b-enemy-card','b-hit','âš¡å‹åŠ›+15','#f59e0b','1.3rem'); }
            if(sid==='psy_1') { bState.e.stress+=25; bState.e.buffs.defDown=2; bFx('b-enemy-card','b-hit','ğŸ’¥å‹åŠ›+25','#f59e0b','1.5rem'); }
            if(sid==='psy_2') { bState.e.buffs.atkDown=3; bLog("æ•Œæ–¹æ”»å‡»å¤§å¹…ä¸‹é™"); bFx('b-enemy-card','b-hit','â¬‡ATK','#94a3b8','1.3rem'); }
            if(sid==='psy_3') { let dpct=Math.floor(bState.e.hp*0.2); bState.e.hp -= dpct; bLog("æ•Œæ–¹å¿ƒæ€å—åˆ›ç™¾åˆ†æ¯”æ‰£è¡€"); bFx('b-enemy-card','b-hit',`-${dpct}`,'#ef4444','1.5rem'); }
            if(sid==='psy_4') { bState.e.buffs.stun=1; let dp=Math.floor(bState.p.atk*2); bState.e.hp -= dp; bLog("å«å®¶é•¿å¨åŠ›å·¨å¤§ï¼"); bFx('b-enemy-card','b-crit',`ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ -${dp}`,'#fde047','1.7rem'); bScreenFlash('rgba(239,68,68,0.25)',0.4); }
            if(sid==='psy_5') { bState.e.buffs.atkDown=2; bState.e.buffs.defDown=2; bFx('b-enemy-card','b-hit','â¬‡â¬‡å´©æºƒ','#c084fc','1.4rem'); }

            if(sid==='sys_è¡¡æ°´') { bState.p.buffs.atkUp=5; bState.p.hp-=Math.floor(bState.p.maxHp*0.2); bLog("å¼€å¯ç‹‚æš´æ¨¡å¼ï¼"); bScreenFlash('rgba(239,68,68,0.4)',0.5); bFx('b-player-card','b-crit','ğŸ”¥ç‹‚æš´','#ef4444','1.8rem'); }
            if(sid==='sys_ç´ è´¨') { bState.p.buffs.atkUp=3; bState.p.buffs.defUp=3; bState.p.buffs.hot=3; bState.p.stress=0; bLog("ç´ è´¨ä¹Œæ‰˜é‚¦é™ä¸´ï¼"); bScreenFlash('rgba(16,185,129,0.3)',0.6); bFx('b-player-card','b-heal','ğŸŒˆä¹Œæ‰˜é‚¦','#34d399','1.6rem'); }

            // ç†µå¢ç³»æŠ€èƒ½
            if(sid==='ent_0') { bState.p.stress=0; bLog("ğŸ§˜ å†¥æƒ³å‡€åŒ–ï¼æ€ç»´ç†µå¢å…¨éƒ¨æ¸…é™¤ï¼"); bFx('b-player-card','b-heal','ğŸ§˜æ¸…é›¶','#a78bfa','1.5rem'); }
            if(sid==='ent_1') { bState.p.stress=Math.max(0,bState.p.stress-40); bState.p.buffs.atkUp=2; bLog("å¿ƒæµçŠ¶æ€ï¼å‹åŠ›-40ï¼Œè¿›å…¥ä¸“æ³¨æ¨¡å¼ï¼"); bFx('b-player-card','b-heal','âš¡å¿ƒæµ','#a78bfa','1.5rem'); }
            if(sid==='ent_2') { let transfer=Math.floor(bState.p.stress*0.5); bState.e.stress+=transfer; bState.p.stress-=transfer; bLog(`ç†µå¢ä¼ å¯¼ï¼å°†${transfer}ç‚¹å‹åŠ›è½¬ç§»ç»™æ•Œæ–¹ï¼`); bFx('b-enemy-card','b-hit',`ğŸ’€+${transfer}å‹`,'#f59e0b','1.4rem'); }
            if(sid==='ent_3') { bState.e.buffs.entropyDot=(bState.e.buffs.entropyDot||0)+3; bLog("ç²¾ç¥å´©æºƒå¼¹ï¼æ•Œæ–¹æ€ç»´ç†µå¢æ¯å›åˆ+15ï¼ŒæŒç»­3å›åˆï¼"); bFx('b-enemy-card','b-hit','ğŸ’£å´©æºƒå¼¹','#c084fc','1.4rem'); }
            if(sid==='ent_4') { bState.e.stress+=30; bState.e.buffs.stun=1; bLog("è™šç©ºå‡è§†ï¼æ•Œæ–¹å‹åŠ›+30ï¼Œä¸‹å›åˆå°å°ï¼"); bFx('b-enemy-card','b-crit','ğŸ‘å°å°','#818cf8','1.6rem'); bScreenFlash('rgba(99,102,241,0.3)',0.4); }
            if(sid==='ent_5') { let heal=Math.floor(bState.p.stress*20); bState.p.hp=Math.min(bState.p.maxHp,bState.p.hp+heal); bState.p.stress=0; bLog(`æµ´ç«é‡ç”Ÿï¼ç‡ƒå°½å‹åŠ›ï¼Œå›å¤${heal}HPï¼`); bFx('b-player-card','b-heal',`ğŸ”¥+${heal}`,'#f97316','1.7rem'); bScreenFlash('rgba(249,115,22,0.35)',0.6); }
        }

        bUpdateUI();
        if(bCheckEnd()) return;
        setTimeout(eAction, 1000);
    }

    function eAction() {
        if(bState.isOver) return;
        if(bState.e.buffs.stun > 0) { bLog("æ•Œæ–¹æ™•çœ©ä¸­ï¼Œè·³è¿‡å›åˆ..."); setTimeout(nextTurn, 1000); return; }

        let rawAtk = bState.e.atk * (bState.e.buffs.atkUp>0 ? 1.5 : 1) * (bState.e.buffs.atkDown>0 ? 0.7 : 1);
        let targetDef = bState.p.def * (bState.p.buffs.defUp>0 ? 1.5 : 1) * (bState.p.buffs.defDown>0 ? 0.3 : 1);
        
        let dmg = Math.max(10, rawAtk - targetDef);
        
        // æ•Œæ–¹æ”»å‡»åŠ¨ç”»
        bFx('b-enemy-card','b-lunge',null,null,null);

        if(bState.p.buffs.dodge > 0) {
            dmg = 0; bLog("æˆ‘æ–¹å®Œç¾é—ªé¿äº†æ”»å‡»ï¼"); bState.p.buffs.dodge--;
            bFx('b-player-card','b-heal','âš¡é—ªé¿','#fde047','1.4rem');
        } else if(bState.p.buffs.shield > 0) {
            dmg = 0; bLog("æˆ‘æ–¹æŠ¤ç›¾æŠµæŒ¡äº†æ”»å‡»ï¼"); bState.p.buffs.shield--;
            bFx('b-player-card','b-heal','ğŸ›¡','#60a5fa','1.8rem');
        } else {
            let fdmg = Math.floor(dmg);
            bState.p.hp -= fdmg;
            bLog(`<span class="e">æ•Œæ–¹æ”»å‡»é€ æˆ ${fdmg} ä¼¤å®³</span>`);
            bFx('b-player-card','b-hit',`-${fdmg}`,'#fca5a5','1.5rem');
            bScreenFlash('rgba(239,68,68,0.2)',0.4);
        }
        
        bUpdateUI();
        if(bCheckEnd()) return;
        setTimeout(nextTurn, 1000);
    }

    function nextTurn() { bState.turn++; bStartTurn(); }

    function bCheckEnd() {
        if(bState.isOver) return true;
        if(bState.e.hp <= 0) {
            bState.isOver = true;
            let finalPts = bState.pts * 2;
            let finalMoney = bState.pts * 20; 
            let repGain = Math.floor(bState.pts * 0.2); // å¤§å¹…é™ä½å£°èª‰å¥–åŠ±
            game.examPoints += finalPts; game.funds += finalMoney; game.reputation += repGain;
            if(bState.rivalId === 't5_3' && !game.achievements.includes('a17')) { game.achievements.push('a17'); showToast("è¾¾æˆæˆå°±ï¼šå¯†å·å…‹æ˜Ÿ"); }
            showCustomModal("ğŸ† å²è¯—å¤§æ·", `è·å¾— ${finalPts} ç§¯åˆ†ï¼Œå¥–é‡‘ ï¿¥${finalMoney}ä¸‡ï¼Œå£°èª‰ +${repGain}ï¼`, [{text:"ç¡®å®š", action:()=>{ closeModal('modal-battle'); bState.active=false; updateUI(); }}]);
            return true;
        }
        if(bState.p.hp <= 0) {
            bState.isOver = true;
            game.reputation -= 30; // å¤±è´¥æ‰£å£°èª‰
            showCustomModal("ğŸ’€ æƒ¨è´¥", "å…¨å†›è¦†æ²¡ï¼Œå£°èª‰ä¸¥é‡å—æŸã€‚ä½†å­¦æ ¡åŸºé‡‘ä¼šå·²ä¸ºæ‚¨å…œåº•ï¼Œèµ„é‡‘æœªå—æŸå¤±ã€‚", [{text:"ç¡®å®š", action:()=>{ closeModal('modal-battle'); bState.active=false; updateUI(); }}]);
            return true;
        }
        return false;
    }

    function bLog(msg) { 
        let inner = document.getElementById('b-log').querySelector('.b-log-inner');
        inner.innerHTML += msg + '<br>'; 
        document.getElementById('b-log').scrollTop = document.getElementById('b-log').scrollHeight;
    }

    function bUpdateUI() {
        let p = bState.p; let e = bState.e;
        document.getElementById('b-weather-ui').innerHTML = `<b>${bState.weather.name}</b><br><span style="font-size:0.65rem">${bState.weather.desc}</span>`;
        document.getElementById('bp-hp-bar').style.width = Math.max(0, p.hp/p.maxHp*100) + '%';
        document.getElementById('bp-hp-txt').innerText = `${Math.floor(p.hp)}/${p.maxHp}`;
        document.getElementById('be-hp-bar').style.width = Math.max(0, e.hp/e.maxHp*100) + '%';
        document.getElementById('be-hp-txt').innerText = `${Math.floor(e.hp)}/${e.maxHp}`;
        document.getElementById('bp-ap').innerText = p.ap;
        document.getElementById('bp-atk').innerText = Math.floor(p.atk * (p.buffs.atkUp>0?1.5:1) * (p.buffs.atkDown>0?0.7:1));
        document.getElementById('be-atk').innerText = Math.floor(e.atk * (e.buffs.atkUp>0?1.5:1) * (e.buffs.atkDown>0?0.7:1));
        document.getElementById('bp-def').innerText = Math.floor(p.def * (p.buffs.defUp>0?1.5:1) * (p.buffs.defDown>0?0.3:1));
        document.getElementById('be-def').innerText = Math.floor(e.def * (e.buffs.defUp>0?1.5:1) * (e.buffs.defDown>0?0.3:1));
        
        let getBuffsStr = (buffObj) => {
            let res = [];
            if(buffObj.atkUp) res.push("âš”ï¸æ”»â†‘"); if(buffObj.defUp) res.push("ğŸ›¡ï¸é˜²â†‘");
            if(buffObj.atkDown) res.push("ğŸ“‰æ”»â†“"); if(buffObj.defDown) res.push("ğŸ“‰é˜²â†“");
            if(buffObj.shield) res.push("ğŸ”°æŠ¤ç›¾"); if(buffObj.dodge) res.push("ğŸ’¨é—ªé¿");
            if(buffObj.hot) res.push("ğŸ’–å›è¡€"); if(buffObj.dot) res.push("â˜ ï¸ä¸­æ¯’");
            if(buffObj.stun) res.push("ğŸ’«æ™•çœ©"); if(buffObj.critUp) res.push("âš¡æš´å‡»â†‘");
            return res.join(' ') || 'æ— ';
        }
        document.getElementById('bp-buffs').innerText = "BUFFS: " + getBuffsStr(p.buffs);
        document.getElementById('be-buffs').innerText = "BUFFS: " + getBuffsStr(e.buffs);
        
        document.getElementById('b-turn-ui').innerText = bState.turn;
    }

    function bShowCat(cat) {
        bState.currentCat = cat;
        document.querySelectorAll('.b-cat-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`cat-${cat}`).classList.add('active');

        let c = document.getElementById('b-skills-container'); c.innerHTML = '';
        for(let k in SKILL_DB) {
            let s = SKILL_DB[k];
            if(s.cat === cat) {
                let unlocked = s.req();
                let btn = document.createElement('button');
                btn.className = 'b-skill-btn';
                btn.disabled = !unlocked || bState.p.ap < s.ap;
                btn.innerHTML = `<div class="b-s-name">${s.name} (AP:${s.ap})</div>
                                 <div class="b-s-desc">${unlocked ? s.desc : `<span style="color:#ef4444">æ¡ä»¶æœªæ»¡è¶³: ${s.reqDesc}</span>`}</div>`;
                btn.onclick = () => pAction(k);
                c.appendChild(btn);
            }
        }
        // æ¸²æŸ“ç»„åˆæŠ€
        if(cat==='ent' && game.combos && game.combos.length) {
            let div = document.createElement('div');
            div.innerHTML = renderComboSkills();
            c.appendChild(div);
        }
    }
    
    function bRetreat() {
        showCustomModal("ğŸ³ï¸ ç¡®è®¤æ’¤é€€ï¼Ÿ", "æ’¤é€€è§†ä¸ºé€ƒå…µï¼å£°èª‰å°†å‡å°‘50ç‚¹ã€‚", [
            {text:"âœ… ç¡®è®¤æ’¤é€€", action:()=>{ bState.isOver = true; game.reputation -= 50; closeModal('modal-battle'); bState.active=false; updateUI(); }},
            {text:"âŒ ç»§ç»­æˆ˜æ–—", action:()=>{}}
        ]);
    }

    // ================= ç›¸é‚»å¥–åŠ±ç³»ç»Ÿ =================
    const ADJACENCY_BONUSES = [
        { pair: ['library','lab'],     name:'çŸ¥è¯†å…±æŒ¯', desc:'å›¾ä¹¦é¦†+å®éªŒæ¥¼ç›¸é‚»: æ¯æœˆæ•™ç ”ç‚¹+3', apply:(p,e)=>{ if(p&&e) game.eduPoints+=3; } },
        { pair: ['clinic','track'],    name:'èº«å¿ƒå¥åº·', desc:'å¿ƒç†è¯Šæ‰€+æ“åœºç›¸é‚»: å‹åŠ›æ¯æœˆé¢å¤–-5', apply:(p,e)=>{ if(p&&e) game.stress=Math.max(0,game.stress-5); } },
        { pair: ['confucius','hall'],  name:'ç¤¼ä¹åˆä¸€', desc:'å­”å­åœ£åƒ+å¤§ç¤¼å ‚ç›¸é‚»: å£°èª‰æ¯æœˆ+15', apply:(p,e)=>{ if(p&&e) game.reputation+=15; } },
        { pair: ['media','lab'],       name:'æ™ºæ…§æ ¡å›­', desc:'ç”µæ•™å¤§æ¥¼+å®éªŒæ¥¼ç›¸é‚»: å­¦ä¸šå€ç‡é¢å¤–+3%', apply:(p,e)=>{ if(p&&e) game.grade=Math.min(100,game.grade+0.5); } },
        { pair: ['dorm','hospital'],   name:'è´µæ—åŒ»ç–—', desc:'è´µæ—å…¬å¯“+æ ¡åŒ»é™¢ç›¸é‚»: æ¯æœˆèµ„é‡‘+20', apply:(p,e)=>{ if(p&&e) game.funds+=20; } },
        { pair: ['art','confucius'],   name:'æ–‡åŒ–åœ£åœ°', desc:'è‰ºæœ¯ä¸­å¿ƒ+å­”å­åœ£åƒç›¸é‚»: çºªå¾‹+5', apply:(p,e)=>{ if(p&&e) game.discipline=Math.min(100,game.discipline+5); } },
        { pair: ['track','hospital'],  name:'è¿åŠ¨åº·å¤', desc:'æ“åœº+æ ¡åŒ»é™¢ç›¸é‚»: ä½“è´¨æ¯æœˆ+2', apply:(p,e)=>{ if(p&&e) game.fitness=Math.min(100,game.fitness+2); } },
        { pair: ['library','art'],     name:'äººæ–‡èŸèƒ', desc:'å›¾ä¹¦é¦†+è‰ºæœ¯ä¸­å¿ƒç›¸é‚»: è‰ºæœ¯+3', apply:(p,e)=>{ if(p&&e) game.art=Math.min(100,game.art+3); } },
        { pair: ['hall','dorm'],       name:'åè´µå¥—é™¢', desc:'å¤§ç¤¼å ‚+è´µæ—å…¬å¯“ç›¸é‚»: APä¸Šé™+2', apply:(p,e)=>{ if(p&&e) game.maxAp=Math.min(50,game.maxAp+2); } },
    ];

    // æ£€æŸ¥åœ°å›¾ä¸Šæ˜¯å¦æœ‰ä¸¤ç§ç±»å‹çš„å»ºç­‘ç›¸é‚»ï¼ˆ4æ ¼ç›¸é‚»ï¼Œåœ°å›¾ä¸º5åˆ—ï¼‰
    function checkAdjacency(typeA, typeB) {
        const cols = 5;
        let posA = [], posB = [];
        game.map.forEach((f,i)=>{ if(f&&f.id===typeA) posA.push(i); if(f&&f.id===typeB) posB.push(i); });
        for(let a of posA) for(let b of posB) {
            let dr = Math.abs(Math.floor(a/cols)-Math.floor(b/cols));
            let dc = Math.abs((a%cols)-(b%cols));
            if((dr===1&&dc===0)||(dr===0&&dc===1)) return true;
        }
        return false;
    }

    function applyAdjacencyBonuses() {
        if(!game||!game.map) return;
        ADJACENCY_BONUSES.forEach(ab=>{
            let hasAdj = checkAdjacency(ab.pair[0],ab.pair[1]);
            ab.apply(hasAdj, hasAdj);
        });
    }

    function getActiveAdjacencies() {
        if(!game||!game.map) return [];
        return ADJACENCY_BONUSES.filter(ab=>checkAdjacency(ab.pair[0],ab.pair[1]));
    }

    // ================= å•†åº—ç³»ç»Ÿ =================
    const SHOP_ITEMS = {
        infra: [
            { id:'blueprint', name:'å»ºç­‘è“å›¾ï¼ˆéšæœºï¼‰', desc:'è§£é”ä¸€ç§æœªå»ºé€ çš„ç‰¹æ®Šå»ºç­‘', icon:'ğŸ“', costType:'funds', cost:200, limitType:'perm', limit:2,
              action:()=>{ let built=game.map.filter(x=>x).map(x=>x.id); let avail=Object.keys(FACILITIES).filter(k=>!built.includes(k)); if(!avail.length)return showToast("æ‰€æœ‰å»ºç­‘å·²è§£é”ï¼"); let chosen=avail[Math.floor(Math.random()*avail.length)]; let slot=game.map.findIndex(x=>!x); if(slot<0)return showToast("åœ°å—å·²æ»¡ï¼"); game.map[slot]={id:chosen,level:0}; showToast(`ğŸ“ è·å¾—è“å›¾ï¼š${FACILITIES[chosen].levels[0].name}ï¼`); } },
            { id:'landcard', name:'åœŸåœ°æ‰©å®¹å¡', desc:'å¢åŠ 1å—å¯å»ºé€ åœ°å—ï¼ˆæœ€å¤š25å—ï¼‰', icon:'ğŸ—ºï¸', costType:'funds', cost:500, limitType:'perm', limit:5,
              action:()=>{ if(game.map.length>=25)return showToast("å·²è¾¾æœ€å¤§åœ°å—æ•°ï¼"); game.map.push(null); showToast("ğŸ—ºï¸ åœ°å—æ‰©å¼ ï¼å½“å‰"+game.map.length+"å—"); } },
        ],
        teacher: [
            { id:'headhunt', name:'åå¸ˆçŒå¤´åˆ¸', desc:'ä¸‹æ¬¡å¯»è®¿å¿…å¾—SRåŠä»¥ä¸Š', icon:'ğŸ¯', costType:'edu', cost:150, limitType:'monthly', limit:2,
              action:()=>{ game.nextGachaGuarantee='SR'; showToast("ğŸ¯ ä¸‹æ¬¡å¯»è®¿ä¿åº•SRï¼"); } },
            { id:'trainpkg', name:'æ•™å¸ˆåŸ¹è®­ç¤¼åŒ…', desc:'ä»»é€‰ä¸€ç§‘æ•™å¸ˆç»„å‡ä¸€çº§', icon:'ğŸ“¦', costType:'funds', cost:180, limitType:'perm', limit:3,
              action:()=>{ showCustomModal("ğŸ“¦ é€‰æ‹©åŸ¹è®­ç§‘ç›®","",[{text:"ä¸»ç§‘ç»„å‡çº§",action:()=>{if(game.teachers.main<5){game.teachers.main++;updateUI();showToast("ä¸»ç§‘å‡çº§ï¼");}}},{text:"å‰¯ç§‘ç»„å‡çº§",action:()=>{if(game.teachers.minor<5){game.teachers.minor++;updateUI();showToast("å‰¯ç§‘å‡çº§ï¼");}}},{text:"ç´ è´¨ç»„å‡çº§",action:()=>{if(game.teachers.spec<5){game.teachers.spec++;updateUI();showToast("ç´ è´¨å‡çº§ï¼");}}}]); } },
            { id:'ssr_studio', name:'ç‰¹çº§æ•™å¸ˆå·¥ä½œå®¤', desc:'ç›´æ¥è§£é”ä¸€ä½SSRä¸“å®¶ï¼ˆè‡ªé€‰ï¼‰', icon:'â­', costType:'exam', cost:300, limitType:'perm', limit:1,
              action:()=>{ let ssrPool=EXPERT_POOL.filter(e=>e.rarity==='SSR'&&!hasExpert(e.id)); if(!ssrPool.length)return showToast("SSRä¸“å®¶å·²å…¨éƒ¨æ‹›å‹Ÿï¼"); showCustomModal("â­ é€‰æ‹©SSRä¸“å®¶","",ssrPool.map(e=>({text:e.name+' - '+e.desc,action:()=>{game.unlockedExperts.push(e.id);renderModals();updateUI();showToast("è·å¾—ï¼š"+e.name);}}))); } },
        ],
        policy: [
            { id:'policy_fast', name:'æ”¿ç­–é€Ÿé€šæ‰‹å†Œ', desc:'æ•™ç ”ç‚¹æ¶ˆè€—-20%ï¼ŒæŒç»­3ä¸ªæœˆ', icon:'ğŸ“‹', costType:'funds', cost:300, limitType:'perm', limit:2,
              action:()=>{ game.policyDiscount=(game.policyDiscount||0)+3; showToast("ğŸ“‹ æ•™ç ”ç‚¹æ¶ˆè€—-20%ï¼ŒæŒç»­3ä¸ªæœˆï¼"); } },
            { id:'media_ctrl', name:'èˆ†è®ºæ“æ§æŒ‡å—', desc:'åª’ä½“å…³ç³»+30ï¼ˆä¸€æ¬¡æ€§ï¼‰', icon:'ğŸ“¢', costType:'funds', cost:120, limitType:'none', limit:99,
              action:()=>{ initSocialRelations(); game.social.govRelations.media=Math.min(100,game.social.govRelations.media+30); showToast("ğŸ“¢ åª’ä½“å…³ç³»+30ï¼"); } },
            { id:'inspect_pass', name:'æ•™è‚²å±€å…æ£€é‡‘ç‰Œ', desc:'ä¸‹æ¬¡è§†å¯Ÿè‡ªåŠ¨é€šè¿‡ï¼Œå‹åŠ›ä¸å¢', icon:'ğŸ¥‡', costType:'exam', cost:100, limitType:'monthly', limit:1,
              action:()=>{ game.inspectImmune=true; showToast("ğŸ¥‡ ä¸‹æ¬¡è§†å¯Ÿè‡ªåŠ¨é€šè¿‡ï¼"); } },
        ],
        consume: [
            { id:'ap_potion', name:'ç²¾åŠ›æ¢å¤å‰‚', desc:'ç«‹å³æ¢å¤5ç‚¹AP', icon:'âš¡', costType:'funds', cost:50, limitType:'monthly', limit:3,
              action:()=>{ game.ap=Math.min(game.maxAp,game.ap+5); updateUI(); showToast("âš¡ AP+5ï¼"); } },
            { id:'stress_course', name:'å…¨æ ¡å‡å‹è¯¾ç¨‹', desc:'å…¨æ ¡å‹åŠ›-10', icon:'ğŸ˜Œ', costType:'funds', cost:100, limitType:'monthly', limit:2,
              action:()=>{ game.stress=Math.max(0,game.stress-10); updateUI(); showToast("ğŸ˜Œ å…¨æ ¡å‹åŠ›-10ï¼"); } },
            { id:'rep_shield', name:'å£°èª‰ä¿æŠ¤ä¼', desc:'å½“æœˆå£°èª‰ä¸‹é™äº‹ä»¶-50%å½±å“', icon:'ğŸ›¡ï¸', costType:'funds', cost:80, limitType:'monthly', limit:1,
              action:()=>{ game.repShield=true; showToast("ğŸ›¡ï¸ æœ¬æœˆå£°èª‰å—æŸå‡åŠï¼"); } },
        ],
        special: [
            { id:'hourglass', name:'æ—¶å…‰æ²™æ¼', desc:'ç«‹å³æ¨è¿›ä¸€æœˆï¼ˆä¸è§¦å‘äº‹ä»¶ï¼‰', icon:'â³', costType:'funds', cost:350, limitType:'perm', limit:3,
              action:()=>{ game.month++; if(game.month>12){game.month=1;game.year++;} game.ap=Math.min(game.maxAp,game.ap+game.maxAp); updateUI(); showToast("â³ æ—¶é—´è·³è·ƒï¼æ¨è¿›ä¸€æœˆï¼"); } },
            { id:'compass', name:'å‘½è¿ç½—ç›˜', desc:'éšæœºè·å¾—ä¸€é¡¹æœªè§£é”æˆå°±', icon:'ğŸ§­', costType:'edu', cost:200, limitType:'perm', limit:1,
              action:()=>{ let unowned=ACHIEVEMENTS.filter(a=>!game.achievements.includes(a.id)); if(!unowned.length)return showToast("æˆå°±å·²å…¨éƒ¨è§£é”ï¼"); let pick=unowned[Math.floor(Math.random()*unowned.length)]; game.achievements.push(pick.id); showToast("ğŸ§­ è·å¾—æˆå°±ï¼š"+pick.name+"ï¼"); } },
            { id:'shard', name:'éšè—å»ºç­‘ç¢ç‰‡', desc:'é›†é½3ç‰‡å…‘æ¢"å­”å­å­¦é™¢æ€»éƒ¨"', icon:'ğŸ’', costType:'exam', cost:80, limitType:'perm', limit:99,
              action:()=>{ game.shards=(game.shards||0)+1; showToast(`ğŸ’ ç¢ç‰‡+1ï¼Œå·²æœ‰${game.shards}/3ç‰‡`); if(game.shards>=3){ game.shards-=3; let slot=game.map.findIndex(x=>!x); if(slot<0)return showToast("åœ°å—å·²æ»¡ï¼Œå…‘æ¢å¤±è´¥ï¼"); game.map[slot]={id:'confucius',level:2}; showToast("ğŸ›ï¸ è§£é”ï¼å­”å­å­¦é™¢æ€»éƒ¨å»ºç«‹ï¼"); } } },
        ]
    };

    // å•†åº—è´­ä¹°è®°å½•å­˜å‚¨
    function getShopData() {
        if(!game.shopData) game.shopData = { permBought:{}, monthlyBought:{}, month:game.month };
        if(game.shopData.month !== game.month) { game.shopData.monthlyBought={}; game.shopData.month=game.month; }
        return game.shopData;
    }

    function renderShop(cat) {
        let el = document.getElementById('shop-content');
        if(!el) return;
        let items = SHOP_ITEMS[cat] || [];
        let sd = getShopData();
        let html = '';
        items.forEach(item => {
            let bought = item.limitType==='perm' ? (sd.permBought[item.id]||0) : (sd.monthlyBought[item.id]||0);
            let remaining = item.limit - bought;
            let canAfford = item.costType==='funds' ? game.funds>=item.cost
                          : item.costType==='edu'   ? game.eduPoints>=item.cost
                          : game.examPoints>=item.cost;
            let costLabel = item.costType==='funds' ? `ï¿¥${item.cost}ä¸‡`
                          : item.costType==='edu'   ? `æ•™ç ”ç‚¹${item.cost}`
                          : `è”è€ƒç§¯åˆ†${item.cost}`;
            let limitLabel = item.limitType==='perm' ? `æ°¸ä¹…é™${item.limit}`
                           : item.limitType==='monthly' ? `æ¯æœˆé™${item.limit}` : 'æ— é™åˆ¶';
            let soldOut = remaining <= 0;
            html += `<div style="background:#f8fafc;border:2px solid ${soldOut?'#e2e8f0':canAfford?'#3b82f6':'#fca5a5'};border-radius:10px;padding:14px;display:flex;flex-direction:column;gap:6px;">
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:1.8rem;">${item.icon}</span>
                    <div>
                        <div style="font-weight:bold;color:#1e293b;">${item.name}</div>
                        <div style="font-size:0.78rem;color:#64748b;">${item.desc}</div>
                    </div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
                    <span style="font-size:0.8rem;color:#64748b;">å‰©ä½™:<b style="color:${remaining>0?'#10b981':'#ef4444'}">${remaining}</b> | ${limitLabel}</span>
                    <button class="btn" style="padding:5px 14px;font-size:0.85rem;${soldOut?'opacity:0.4;cursor:not-allowed;':''}${canAfford?'':'border-color:#ef4444;color:#ef4444;'}"
                        ${soldOut?'disabled':''} onclick="buyShopItem('${cat}','${item.id}')">
                        ${soldOut?'å·²å”®å®Œ':costLabel}
                    </button>
                </div>
            </div>`;
        });
        el.innerHTML = html || '<p style="color:#64748b;">æš‚æ— å•†å“</p>';
    }

    function buyShopItem(cat, itemId) {
        let item = (SHOP_ITEMS[cat]||[]).find(x=>x.id===itemId);
        if(!item) return;
        let sd = getShopData();
        let bought = item.limitType==='perm' ? (sd.permBought[itemId]||0) : (sd.monthlyBought[itemId]||0);
        if(bought >= item.limit) return showToast("å·²è¾¾è´­ä¹°ä¸Šé™ï¼");
        if(item.costType==='funds') { if(!payCost(0,item.cost)) return; }
        else if(item.costType==='edu') { if(game.eduPoints<item.cost)return showToast("æ•™ç ”ç‚¹ä¸è¶³ï¼"); game.eduPoints-=item.cost; }
        else { if(game.examPoints<item.cost)return showToast("è”è€ƒç§¯åˆ†ä¸è¶³ï¼"); game.examPoints-=item.cost; }
        if(item.limitType==='perm') sd.permBought[itemId]=(sd.permBought[itemId]||0)+1;
        else if(item.limitType==='monthly') sd.monthlyBought[itemId]=(sd.monthlyBought[itemId]||0)+1;
        item.action();
        updateUI();
        renderShop(cat);
    }

    // ================= å‘¨è¯¾è¡¨ç³»ç»Ÿ =================
    // è¯¾è¡¨ï¼š5å¤© Ã— 8èŠ‚ = 40æ ¼ï¼Œå­˜å‚¨åœ¨ game.weeklyTable (æ•°ç»„40ä¸ªå…ƒç´ : 'main'/'minor'/'spec'/null)
    function initWeeklyTable() {
        if(!game.weeklyTable || game.weeklyTable.length !== 40) {
            game.weeklyTable = new Array(40).fill(null);
            // é»˜è®¤æ’è¯¾
            randomizeScheduleData();
        }
    }

    function randomizeSchedule() {
        randomizeScheduleData();
        renderWeeklyTimetable();
        syncScheduleFromTable();
    }

    function randomizeScheduleData() {
        if(!game) return;
        let m = game.schedule.main || 20, mi = game.schedule.minor || 15, sp = game.schedule.spec || 5;
        let slots = new Array(40).fill(null);
        let place = (type, count) => {
            let placed = 0, tries = 0;
            while(placed < count && tries < 200) {
                let idx = Math.floor(Math.random()*40);
                if(!slots[idx]) { slots[idx]=type; placed++; }
                tries++;
            }
        };
        place('main', Math.min(m,40)); place('minor', Math.min(mi, 40 - Math.min(m,40)));
        place('spec', Math.min(sp, 40 - Math.min(m,40) - Math.min(mi,40)));
        game.weeklyTable = slots;
    }

    function renderWeeklyTimetable() {
        let el = document.getElementById('weekly-timetable');
        if(!el) return;
        initWeeklyTable();
        const days = ['ä¸€','äºŒ','ä¸‰','å››','äº”'];
        const periods = ['ç¬¬1èŠ‚','ç¬¬2èŠ‚','ç¬¬3èŠ‚','ç¬¬4èŠ‚','åˆä¼‘','ç¬¬5èŠ‚','ç¬¬6èŠ‚','ç¬¬7èŠ‚'];
        const COLOR = { main:'#fecaca', minor:'#bfdbfe', spec:'#bbf7d0', null:'#f1f5f9' };
        const LABEL = { main:'ğŸ“šä¸»ç§‘', minor:'ğŸ”¬å‰¯ç§‘', spec:'ğŸ¨ç´ è´¨', null:'â€”' };
        const CYCLE = [null,'main','minor','spec'];
        // Header row
        let html = `<div style="background:#e2e8f0;border-radius:3px;padding:4px;text-align:center;font-weight:bold;">èŠ‚æ¬¡</div>`;
        days.forEach(d=>{ html+=`<div style="background:#e2e8f0;border-radius:3px;padding:4px;text-align:center;font-weight:bold;">å‘¨${d}</div>`; });
        // Body
        periods.forEach((p,row)=>{
            html+=`<div style="background:#f8fafc;border-radius:3px;padding:4px;text-align:center;color:#64748b;font-size:0.7rem;">${p}</div>`;
            days.forEach((_,col)=>{
                if(p==='åˆä¼‘'){ html+=`<div style="background:#fef9c3;border-radius:3px;padding:4px;text-align:center;color:#a16207;font-size:0.7rem;" colspan="5">åˆä¼‘</div>`; return; }
                let realRow = row > 3 ? row - 1 : row; // skip lunch visually
                let idx = realRow * 5 + col;
                if(row === 4) return; // handled above
                let type = game.weeklyTable[idx] || null;
                html+=`<div onclick="cycleCell(${idx})" style="background:${COLOR[type]};border-radius:3px;padding:4px;text-align:center;cursor:pointer;transition:0.15s;font-size:0.68rem;" title="ç‚¹å‡»åˆ‡æ¢">${LABEL[type]||'â€”'}</div>`;
            });
        });
        el.innerHTML = html;
    }

    function cycleCell(idx) {
        const CYCLE = [null,'main','minor','spec'];
        let cur = game.weeklyTable[idx];
        let next = CYCLE[(CYCLE.indexOf(cur)+1) % CYCLE.length];
        game.weeklyTable[idx] = next;
        syncScheduleFromTable();
        renderWeeklyTimetable();
    }

    function syncScheduleFromTable() {
        if(!game.weeklyTable) return;
        let m=0,mi=0,sp=0;
        game.weeklyTable.forEach(t=>{ if(t==='main')m++; else if(t==='minor')mi++; else if(t==='spec')sp++; });
        game.schedule.main = m; game.schedule.minor = mi; game.schedule.spec = sp;
        let ml=document.getElementById('lbl-main-hr'),ml2=document.getElementById('range-main');
        let mml=document.getElementById('lbl-minor-hr'),mml2=document.getElementById('range-minor');
        let sl=document.getElementById('lbl-spec-hr'),sl2=document.getElementById('range-spec');
        let tl=document.getElementById('sch-total-hr');
        if(ml)ml.innerText=m+'èŠ‚'; if(ml2)ml2.value=m;
        if(mml)mml.innerText=mi+'èŠ‚'; if(mml2)mml2.value=mi;
        if(sl)sl.innerText=sp+'èŠ‚'; if(sl2)sl2.value=sp;
        if(tl)tl.innerText=m+mi+sp;
    }

    // Override adjustSchedule to also re-render timetable
    function openScheduleModal() { 
        openModal('modal-schedule'); 
        initWeeklyTable(); 
        renderWeeklyTimetable(); 
    }

    function renderAdjacencyPanel() {
        let el = document.getElementById('adjacency-panel');
        if(!el) return;
        let active = getActiveAdjacencies();
        if(!active.length) { el.innerHTML='<p style="color:#94a3b8;font-size:0.8rem;">æš‚æ— ç›¸é‚»åŠ æˆï¼ˆå°†ç›¸ç¬¦å»ºç­‘æ”¾ç½®äºç›¸é‚»æ ¼å¯æ¿€æ´»ï¼‰</p>'; return; }
        el.innerHTML = active.map(ab=>`<div style="background:#f0fdf4;border:1px solid #86efac;border-radius:6px;padding:6px 10px;font-size:0.78rem;"><b style="color:#15803d;">âœ¨ ${ab.name}</b><br><span style="color:#166534;">${ab.desc}</span></div>`).join('');
    }

    // ================= å…¶å®ƒç³»ç»Ÿ =================
    function renderModals() {
        if(!game || !game.map || !Array.isArray(game.map)) return;
        // åœ°å›¾
        let mGrid = document.getElementById('map-grid'); mGrid.innerHTML = '';
        game.map.forEach((fac, idx) => {
            let div = document.createElement('div'); div.className = 'map-cell' + (idx === selectedMapIndex ? ' selected' : '');
            if(fac) {
                let fData = FACILITIES[fac.id];
                let adj = getActiveAdjacencies().some(ab=>ab.pair.includes(fac.id));
                div.innerHTML = `<span style="font-size:1.8rem;">${fData.icon}</span><span style="font-size:0.75rem;">${fData.levels[fac.level].name}</span>${adj?'<span style="position:absolute;top:2px;right:2px;font-size:0.6rem;background:#fde047;border-radius:3px;padding:1px 3px;color:#713f12;">âœ¨é‚»</span>':''}`;
                div.style.position='relative';
            } else div.innerHTML = `<span style="color:#a3e635;font-size:2rem;">+</span>`;
            div.onclick = () => { selectedMapIndex = idx; renderFacDetail(); }; mGrid.appendChild(div);
        });
        renderFacDetail();
        renderAdjacencyPanel();
        
        // ä¸“å®¶
        let ehtml = ''; EXPERT_POOL.forEach(e => {
            if(hasExpert(e.id)) {
                let typeTag = e.battle ? '<span class="type-tag type-battle">æˆ˜æ–—å‹</span>' : '<span class="type-tag type-passive">å†…æ”¿å‹</span>';
                ehtml += `<div class="gacha-card rarity-${e.rarity}">
                    <img src="src/expert/${e.id}.png" class="expert-img" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'50\\' height=\\'50\\'><rect width=\\'50\\' height=\\'50\\' fill=\\'%23e2e8f0\\'/><text x=\\'50%\\' y=\\'50%\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' font-size=\\'12\\'>æš‚æ— </text></svg>'">
                    <div class="upkeep-tag">ï¿¥${e.upkeep}</div>${typeTag}
                    <div><b>${e.name}</b><br><span style="font-size:0.75rem">${e.desc}</span></div>
                </div>`;
            }
        }); document.getElementById('expert-container').innerHTML = ehtml;

        // åˆ†æ ¡
        let bEl = document.getElementById('branch-container');
        if(bEl) {
            bEl.innerHTML = BRANCHES_DB.map(b => {
                let owned = hasBranch(b.id);
                return `<div style="background:#fff; border:2px solid ${owned?'var(--gold)':'#cbd5e1'}; padding:15px; border-radius:8px;">
                    <div style="font-weight:bold; font-size:1.1rem;">${b.name}</div>
                    <div style="font-size:0.8rem; color:#64748b; margin:5px 0;">${b.desc}</div>
                    ${owned ? '<span style="color:var(--success);font-weight:bold;">âœ… å·²å»ºç«‹</span>' : `<button class="btn" onclick="buyBranch('${b.id}', ${b.cost})">å»ºç«‹ (ï¿¥${b.cost}ä¸‡)</button>`}
                </div>`;
            }).join('');
        }

        // æ”¿ç­–
        let thtml = '';
        POLICY_TREE.forEach(layer => {
            let row = `<div class="tree-tier">`;
            layer.nodes.forEach(n => {
                let unlocked = hasPolicy(n.id); let canUnlock = !unlocked && (!n.req || hasPolicy(n.req));
                let cls = unlocked ? 'unlocked ' + n.class : (canUnlock ? n.class : 'locked ' + n.class);
                let btn = unlocked ? `<span style="color:var(--success);font-size:0.8rem;font-weight:bold;">å·²ç”Ÿæ•ˆ</span>` : 
                          (canUnlock ? `<button class="btn" style="margin:0; padding:4px;" onclick="unlockPolicy('${n.id}', ${n.cost})">é¢å¸ƒ</button>` : `<span style="color:#94a3b8;font-size:0.75rem;">æœªè§£é”</span>`);
                row += `<div class="tree-node ${cls}"><div><h4 style="margin:0 0 5px 0;font-size:0.95rem;">${n.name}</h4><p style="font-size:0.75rem;color:#64748b;">${n.desc}</p></div>${btn}</div>`;
            });
            thtml += row + `</div>`;
        });
        document.getElementById('policy-container').innerHTML = thtml;
        document.getElementById('ui-eduPoints').innerText = game.eduPoints;
    }

    function renderFacDetail() {
        let list = document.getElementById('fac-list'); list.innerHTML = '';
        if(selectedMapIndex===-1) return;
        if(game.map[selectedMapIndex]) {
            let fac = game.map[selectedMapIndex]; let fData = FACILITIES[fac.id];
            let lvlData = fData.levels[fac.level];
            let isMax = fac.level >= fData.levels.length-1;
            let nextInfo = !isMax ? `å‡çº§â†’ ${fData.levels[fac.level+1].name}` : '';
            list.innerHTML = `<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:8px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                    <span style="font-size:1.8rem;">${fData.icon}</span>
                    <div>
                        <div style="font-weight:bold;color:#1e293b;">${lvlData.name}</div>
                        <div style="font-size:0.7rem;color:#64748b;">ç­‰çº§ ${fac.level+1}/${fData.levels.length}</div>
                    </div>
                </div>
                <div style="background:#eff6ff;border-left:3px solid #3b82f6;padding:6px 10px;border-radius:0 6px 6px 0;font-size:0.8rem;color:#1e40af;margin-bottom:8px;">
                    âš¡ æ•ˆæœï¼š${lvlData.desc}
                </div>
                ${isMax ? '<div style="color:#10b981;font-size:0.8rem;font-weight:bold;">âœ… å·²æ»¡çº§</div>' : 
                `<div style="font-size:0.75rem;color:#64748b;margin-bottom:6px;">${nextInfo} (ï¿¥${fData.levels[fac.level+1].cost}ä¸‡)</div>
                <button class="btn" style="margin-right:6px;" onclick="upgradeFac()">â¬† å‡çº§</button>`}
                <button class="btn" style="border-color:#ef4444;color:#ef4444;" onclick="demolish()">ğŸ”¨ æ‹†é™¤</button>
            </div>`;
        } else {
            list.innerHTML = `<div style="color:#64748b;font-size:0.85rem;margin-bottom:8px;">é€‰æ‹©è¦å»ºé€ çš„å»ºç­‘ï¼š</div>`;
            for(let k in FACILITIES) {
                let fData = FACILITIES[k];
                let cost = fData.levels[0].cost;
                let desc = fData.levels[0].desc;
                list.innerHTML += `<button class="btn" style="margin-bottom:6px;text-align:left;display:block;width:100%;" onclick="buildFac('${k}',${cost})">
                    ${fData.icon} <b>${fData.levels[0].name}</b> (ï¿¥${cost}ä¸‡)<br>
                    <span style="font-size:0.72rem;color:#475569;">${desc}</span>
                </button>`;
            }
        }
    }

    function buildFac(k,c){ if(payCost(0,c)){game.map[selectedMapIndex]={id:k,level:0}; renderModals(); updateUI();}}
    function upgradeFac(){ let f=game.map[selectedMapIndex]; let c=FACILITIES[f.id].levels[f.level+1].cost; if(payCost(0,c)){f.level++; renderModals(); updateUI();}}
    function demolish() { game.map[selectedMapIndex] = null; renderModals(); updateUI(); }
    
    function unlockPolicy(id, cost) {
        if(game.eduPoints < cost) return showToast("æ•™ç ”ç‚¹ä¸è¶³");
        game.eduPoints -= cost; game.policies.push(id); renderModals(); updateUI();
    }

    function gachaExpert() {
        if(!payCost(0, 50)) return;

        // --- å†³å®šç¨€æœ‰åº¦ ---
        let targetRarity = 'R';
        if(game.nextGachaGuarantee) {
            targetRarity = game.nextGachaGuarantee;
            game.nextGachaGuarantee = null;
            showToast("ğŸ¯ çŒå¤´åˆ¸ç”Ÿæ•ˆï¼ä¿åº•SR+");
        } else {
            let r = Math.random();
            let ssrRate = [0, 0.005, 0.015, 0.04, 0.08][game.levelIdx];
            let srRate = 0.1 + (game.levelIdx * 0.02);
            if(r < ssrRate) targetRarity = 'SSR'; else if(r < ssrRate + srRate) targetRarity = 'SR';
        }

        // --- é€‰ä¸“å®¶ï¼ˆå…è®¸é‡å¤ï¼Œé‡å¤é€€æ¬¾ï¼‰---
        let pool = EXPERT_POOL.filter(x => x.rarity === targetRarity);
        if(!pool.length) pool = EXPERT_POOL;
        let ex = pool[Math.floor(Math.random() * pool.length)];
        let isDuplicate = hasExpert(ex.id);
        let refund = 0;

        if(pool.length === 0) {
            game.funds += 40; showToast("äººæ‰åº“å·²ç©ºï¼Œé€€æ¬¾40ä¸‡"); return;
        }

        if(!isDuplicate) {
            game.unlockedExperts.push(ex.id);
        } else {
            refund = { SSR: 35, SR: 25, R: 15 }[ex.rarity] || 15;
            game.funds += refund;
        }

        // --- æ’­æ”¾æŠ½å¡åŠ¨ç”» ---
        showGachaCard(ex, isDuplicate, refund);
        updateUI();
    }

    function showGachaCard(ex, isDuplicate, refund) {
        const RARITY_LABEL = { R:'R Â· ç¨€æœ‰', SR:'SR Â· è¶…ç¨€æœ‰', SSR:'SSR âœ¦ ä¼ å¥‡' };
        let theme = RARITY_THEME[ex.rarity] || RARITY_THEME.R;

        let ov = document.getElementById('gacha-overlay');
        let card = document.getElementById('gacha-card');

        // Apply theme
        card.style.setProperty('--gc', theme.color);
        card.style.setProperty('--gc-bg', theme.bg);
        card.style.background = theme.bg;
        card.style.boxShadow = `0 0 80px ${theme.color}`;
        document.getElementById('gacha-rarity-label').style.color = theme.color;
        document.getElementById('gacha-rarity-label').innerText = RARITY_LABEL[ex.rarity] || theme.label;
        document.getElementById('gacha-icon').innerText = EXPERT_ICONS[ex.id] || theme.icon;
        document.getElementById('gacha-name').innerText = ex.name;
        document.getElementById('gacha-desc').innerText = isDuplicate
            ? `å·²åœ¨éº¾ä¸‹ Â· é€€è¿˜ ï¿¥${refund}ä¸‡é…¬åŠ³`
            : ex.desc;
        let badge = document.getElementById('gacha-duplicate-badge');
        badge.style.display = isDuplicate ? 'block' : 'none';
        document.getElementById('gacha-bg-glow').style.setProperty('--gc', theme.color);

        // Show overlay
        ov.style.display = 'flex';
        card.classList.remove('flip');

        // Flash background then flip card
        ov.style.background = theme.color;
        setTimeout(() => { ov.style.background = '#000'; }, 120);
        setTimeout(() => {
            card.classList.add('flip');
            spawnParticles(theme.color);
            if(ex.rarity === 'SSR') spawnParticles(theme.color);
        }, 200);
    }

    function spawnParticles(color) {
        let container = document.getElementById('gacha-particles');
        let cx = window.innerWidth / 2, cy = window.innerHeight / 2;
        for(let i = 0; i < 24; i++) {
            let p = document.createElement('div');
            p.className = 'g-particle';
            let size = 6 + Math.random() * 10;
            let angle = Math.random() * Math.PI * 2;
            let dist = 120 + Math.random() * 200;
            p.style.cssText = `
                width:${size}px; height:${size}px;
                background:${color}; opacity:0.9;
                left:${cx}px; top:${cy}px;
                --dx:${Math.cos(angle)*dist}px;
                --dy:${Math.sin(angle)*dist}px;
                animation-delay:${Math.random()*0.3}s;
                animation-duration:${0.8+Math.random()*0.6}s;
            `;
            container.appendChild(p);
            setTimeout(() => p.remove(), 1500);
        }
    }

    function closeGachaCard() {
        let ov = document.getElementById('gacha-overlay');
        let card = document.getElementById('gacha-card');
        card.classList.remove('flip');
        setTimeout(() => { ov.style.display = 'none'; renderModals(); }, 300);
    }


    function gachaExpert10() {
        if(!payCost(0, 450)) return;

        let results = [];
        for(let i = 0; i < 10; i++) {
            let targetRarity = 'R';
            let r = Math.random();
            let ssrRate = [0, 0.005, 0.015, 0.04, 0.08][game.levelIdx];
            let srRate = 0.1 + (game.levelIdx * 0.02);
            if(r < ssrRate) targetRarity = 'SSR';
            else if(r < ssrRate + srRate) targetRarity = 'SR';
            // åè¿ä¿åº•ï¼šç¬¬10æŠ½è‹¥æ— SR+åˆ™å¼ºåˆ¶SR
            if(i === 9 && !results.some(x => x.rarity === 'SR' || x.rarity === 'SSR')) targetRarity = 'SR';

            let pool = EXPERT_POOL.filter(x => x.rarity === targetRarity);
            if(!pool.length) pool = EXPERT_POOL;
            let ex = pool[Math.floor(Math.random() * pool.length)];
            let isDuplicate = hasExpert(ex.id);
            let refund = 0;
            if(!isDuplicate) {
                game.unlockedExperts.push(ex.id);
            } else {
                refund = { SSR: 35, SR: 25, R: 15 }[ex.rarity] || 15;
                game.funds += refund;
            }
            results.push({ ex, isDuplicate, refund });
        }
        updateUI();
        showGacha10Cards(results);
    }

    const RARITY_THEME = {
        R:   { color:'#3b82f6', bg:'linear-gradient(160deg,#1e3a5f,#0f172a)', label:'R', icon:'ğŸ‘¨â€ğŸ«' },
        SR:  { color:'#a855f7', bg:'linear-gradient(160deg,#3b0764,#1e1b4b)', label:'SR', icon:'ğŸŒŸ' },
        SSR: { color:'#fbbf24', bg:'linear-gradient(160deg,#78350f,#1c1917)', label:'SSR', icon:'ğŸ‘‘' },
    };
    const EXPERT_ICONS = {
        e1:'ğŸ’ª',e2:'ğŸ’°',e3:'ğŸ‘µ',e4:'ğŸ³',e5:'ğŸšª',e6:'ğŸ§ ',e7:'ğŸ“–',e8:'ğŸ“¢',
        e9:'ğŸ“',e10:'ğŸ”¬',e11:'ğŸ…',e12:'ğŸ“±',e13:'âš¡',e14:'ğŸƒ',e15:'ğŸ¨',
        e16:'ğŸ“',e17:'ğŸ’',e18:'ğŸ†',e19:'ğŸ­',e20:'ğŸŒ',
    };

    function showGacha10Cards(results) {
        let ov = document.getElementById('gacha10-overlay');
        let grid = document.getElementById('gacha10-grid');
        let summary = document.getElementById('gacha10-summary');
        grid.innerHTML = '';
        summary.classList.remove('show');
        summary.textContent = '';
        ov.classList.add('show');

        // Flash bg colour of rarest pull
        let topRarity = results.some(x=>x.ex.rarity==='SSR') ? 'SSR' : results.some(x=>x.ex.rarity==='SR') ? 'SR' : 'R';
        let flashColor = RARITY_THEME[topRarity].color;
        ov.style.background = flashColor;
        setTimeout(()=>{ ov.style.background = '#000'; }, 150);

        // Build cards (hidden)
        results.forEach((r, i) => {
            let theme = RARITY_THEME[r.ex.rarity] || RARITY_THEME.R;
            let card = document.createElement('div');
            card.className = 'g10-card';
            card.style.background = theme.bg;
            card.style.boxShadow = `0 0 20px ${theme.color}55`;
            card.innerHTML = `
                ${r.isDuplicate ? '<div class="g10-dup-badge">é‡å¤</div>' : ''}
                <div class="g10-card-icon">${EXPERT_ICONS[r.ex.id] || theme.icon}</div>
                <div class="g10-card-rarity" style="color:${theme.color}">${theme.label}</div>
                <div class="g10-card-name">${r.ex.name}</div>
                ${r.isDuplicate ? `<div style="font-size:0.5rem;color:rgba(255,255,255,0.5);text-align:center;margin-top:2px;">é€€æ¬¾Â¥${r.refund}ä¸‡</div>` : ''}
            `;
            grid.appendChild(card);
        });

        // Stagger reveal
        let cards = grid.querySelectorAll('.g10-card');
        cards.forEach((card, i) => {
            setTimeout(()=>{
                card.classList.add('revealed');
                // Extra particle burst for SSR
                if(results[i].ex.rarity === 'SSR') {
                    spawnParticles(RARITY_THEME.SSR.color);
                    spawnParticles(RARITY_THEME.SSR.color);
                } else if(results[i].ex.rarity === 'SR') {
                    spawnParticles(RARITY_THEME.SR.color);
                }
            }, 80 + i * 120);
        });

        // Summary line
        let newCount = results.filter(x=>!x.isDuplicate).length;
        let ssrCount = results.filter(x=>x.ex.rarity==='SSR').length;
        let srCount  = results.filter(x=>x.ex.rarity==='SR').length;
        let totalRefund = results.reduce((s,x)=>s+(x.refund||0), 0);
        setTimeout(()=>{
            let parts = [];
            if(ssrCount) parts.push(`SSR Ã—${ssrCount} ğŸ‰`);
            if(srCount)  parts.push(`SR Ã—${srCount} âœ¨`);
            parts.push(`æ–°æˆå‘˜ +${newCount}`);
            if(totalRefund) parts.push(`é€€æ¬¾ Â¥${totalRefund}ä¸‡`);
            summary.textContent = parts.join('ã€€|ã€€');
            summary.classList.add('show');
        }, 80 + 9 * 120 + 600);
    }

    function closeGacha10() {
        let ov = document.getElementById('gacha10-overlay');
        ov.classList.remove('show');
        renderModals();
    }

    
    function payCost(ap, money) { if(!game) return false; if(game.ap>=ap && game.funds>=money) { game.ap-=ap; game.funds-=money; return true; } showToast("èµ„æºä¸è¶³"); return false; }

    function updateMailbox() {
        let box = document.getElementById('student-comments-box');
        let msgs = [];
        if(stuGame.active) {
            msgs.push(`è‡ªå·±: åˆšè€ƒäº† ${stuGame.examScore||0} åˆ†ã€‚`);
            if(stuGame.stress > 80) msgs.push("è‡ªå·±: å‹åŠ›å¤ªå¤§äº†ï¼Œæƒ³é€€å­¦...");
        } else {
            msgs.push("åŒ¿å: æ ¡é•¿å¥½ï¼Œæˆ‘ä¹Ÿæƒ³ç©å­¦ç”Ÿæ¨¡å¼ã€‚");
        }
        if(game.stress > 80) msgs.push("åŒ¿å: å­¦æ ¡å¤ªå‹æŠ‘äº†ï¼");
        if(hasBranch('b_harvard')) msgs.push("åŒ¿å: å¬è¯´å’±ä»¬è¿˜æœ‰å“ˆä½›åˆ†æ ¡ï¼Ÿå¤ªç‰›äº†ï¼");
        
        box.innerHTML = '';
        msgs.forEach(m => {
            box.innerHTML += `<div class="comment-bubble">${m}<div class="comment-meta">${game.year}.${game.month}</div></div>`;
        });
        box.scrollTop = box.scrollHeight;
    }

    function updateUI() {
        if(!game || !game.map) return;
        // update diff badge
        let diffBadge = document.getElementById('ui-diff-badge');
        if(diffBadge) { let d = (game.diff !== undefined && DIFF_MODS[game.diff]) ? game.diff : 1; diffBadge.innerText = `éš¾åº¦: ${DIFF_MODS[d].name}`; }
        let maxApEl = document.getElementById('ui-maxap'); if(maxApEl) maxApEl.innerText = game.maxAp || 20;
        let warn = document.getElementById('warn-stress'); if(warn) warn.style.display = game.stress >= 80 ? 'block' : 'none';
        document.getElementById('ui-date').innerText = `${game.year}å¹´ ${game.month}æœˆ`;
        document.getElementById('ui-funds').innerText = Math.floor(game.funds);
        document.getElementById('ui-rep').innerText = Math.floor(game.reputation);
        document.getElementById('ui-ap').innerText = Math.floor(game.ap);
        document.getElementById('val-grade').innerText = Math.floor(game.grade);
        document.getElementById('bar-grade').style.width = game.grade + '%';
        document.getElementById('ui-students').innerText = game.students;
        document.getElementById('ui-examPoints').innerText = game.examPoints;
        document.getElementById('val-stress').innerText = Math.floor(game.stress);
        document.getElementById('bar-stress').style.width = Math.min(100, game.stress) + '%';
        document.getElementById('val-disc').innerText = Math.floor(game.discipline);
        document.getElementById('bar-disc').style.width = game.discipline + '%';
        document.getElementById('val-fit').innerText = Math.floor(game.fitness);
        document.getElementById('bar-fit').style.width = game.fitness + '%';
        document.getElementById('val-art').innerText = Math.floor(game.art);
        document.getElementById('bar-art').style.width = game.art + '%';
        
        document.getElementById('ui-level-name').innerText = `ğŸ† ${SCHOOL_LEVELS[game.levelIdx].name}`;
        
        let exUpkeep = 0; game.unlockedExperts.forEach(id => { exUpkeep += EXPERT_POOL.find(x=>x.id===id).upkeep; });
        let totalSal = (TEACHER_TIERS[game.teachers.main].salary + TEACHER_TIERS[game.teachers.minor].salary + TEACHER_TIERS[game.teachers.spec].salary) * (game.students / 150); 
        let upkeep = SCHOOL_LEVELS[game.levelIdx].upkeep * getScaleFactor() * (hasExpert('e2')?0.85:1);
        document.getElementById('ui-salary').innerText = `å¸¸è€—:-${Math.floor(totalSal + upkeep)} ä¸“å®¶:-${exUpkeep}`;

        document.getElementById('tch-main').innerText = TEACHER_TIERS[game.teachers.main].name;
        document.getElementById('tch-minor').innerText = TEACHER_TIERS[game.teachers.minor].name;
        document.getElementById('tch-spec').innerText = TEACHER_TIERS[game.teachers.spec].name;

        // æ‹‰èµåŠ©é¢„æœŸé‡‘é¢ï¼ˆéšç­‰çº§å’Œç¤¾ä¼šå…³ç³»åŠ¨æ€æ›´æ–°ï¼‰
        let spoEl = document.getElementById('gain-spo');
        if(spoEl) {
            let base = [50, 100, 200, 400, 800][game.levelIdx] || 50;
            initSocialRelations();
            let socialBonus = Math.floor(((game.social.govRelations.local + game.social.govRelations.media) / 200) * base * 0.6);
            spoEl.innerText = base + socialBonus;
        }
    }

    // ================= å‡çº§å¼¹çª—é‡æ„ =================
    function checkUpgrade() {
        let next = SCHOOL_LEVELS[game.levelIdx + 1];
        if(!next) return showToast("å·²æ˜¯æœ€é«˜çº§åˆ«ï¼");
        let html = `
            <ul style="text-align:left; line-height:1.8; font-size:1.1rem; background:#f1f5f9; padding:15px 15px 15px 30px; border-radius:8px;">
                <li><b>åæœ›è¦æ±‚:</b> ${next.reqRep} (å½“å‰:${Math.floor(game.reputation)}) ${game.reputation>=next.reqRep?'<span style="color:var(--success)">âœ…</span>':'<span style="color:var(--danger)">âŒ</span>'}</li>
                <li><b>èµ„é‡‘å‚¨å¤‡:</b> ${next.reqFunds}ä¸‡ (å½“å‰:${Math.floor(game.funds)}) ${game.funds>=next.reqFunds?'<span style="color:var(--success)">âœ…</span>':'<span style="color:var(--danger)">âŒ</span>'}</li>
                <li><b>å¹³å‡å­¦ä¸š:</b> ${next.reqGrade} (å½“å‰:${Math.floor(game.grade)}) ${game.grade>=next.reqGrade?'<span style="color:var(--success)">âœ…</span>':'<span style="color:var(--danger)">âŒ</span>'}</li>
            </ul>
        `;
        let canUp = game.reputation>=next.reqRep && game.funds>=next.reqFunds && game.grade>=next.reqGrade;
        let btns = [{text:"ç»§ç»­åŠªåŠ›", action:()=>{}}];
        if(canUp) btns.push({text:"ç¡®è®¤æ™‹å‡ï¼", action:()=>{ 
            game.levelIdx++; 
            game.maxAp += 5; // æ¯æ¬¡å‡çº§APä¸Šé™+5
            game.ap = Math.min(game.maxAp, game.ap + 5);
            log(`ğŸ‰ æ™‹å‡ä¸ºã€${next.name}ã€‘ï¼APä¸Šé™+5ï¼Œç°ä¸º${game.maxAp}`); 
            updateUI(); 
        }});
        showCustomModal(`ç”³è¯·æ™‹å‡ï¼š${next.name}`, html, btns);
    }

    // å­¦ç”Ÿæ¨¡å¼å‡½æ•°
    function switchMode(m) { 
        if(m==='student'){ 
            document.getElementById('principal-container').style.display='none'; 
            document.getElementById('student-container').style.display='block'; 
            renderStudentSetup(); 
            renderStuFriends();
            renderStuCrushes();
        }
        else { document.getElementById('principal-container').style.display='grid'; document.getElementById('student-container').style.display='none'; updateUI(); }
    }
    
    function renderStudentSetup() {
        let grid = document.getElementById('stu-family-grid');
        grid.innerHTML = '';
        FAMILIES.forEach(f => {
            let el = document.createElement('div');
            el.className = 'family-card';
            if(stuGame.family === f.id) el.classList.add('selected');
            el.onclick = () => selectFamily(f.id, el);
            el.innerHTML = `<h3 style="margin:0 0 5px 0;">${f.name}</h3><p style="font-size:0.8rem;color:#64748b;">${f.desc}</p><div style="font-weight:bold;color:var(--primary);margin-top:5px;">åˆå§‹: ï¿¥${f.money}</div>`;
            grid.appendChild(el);
        });
    }

    function selectFamily(id, el) { 
        stuGame.family = id; 
        document.querySelectorAll('.family-card').forEach(c=>c.classList.remove('selected')); 
        el.classList.add('selected'); 
    }
    
    function buyTalent(id, c, el) { if(metaData.rebirthPoints>=c && !stuGame.talent.includes(id)) { metaData.rebirthPoints-=c; stuGame.talent.push(id); el.style.background='#dcfce7'; saveGame(); }}
    function startStudentGameplay() { 
        if(stuGame.family) { 
            stuGame.active=true; 
            if(!stuGame.crushes['lin']) {
                CRUSHES.forEach(c => { stuGame.crushes[c.id] = { aff:0, events:[] }; });
            }
            document.getElementById('stu-setup').style.display='none'; 
            document.getElementById('stu-gameplay').style.display='grid'; 
            updateStuUI(); 
            renderStuCrushes();
        } else showToast("è¯·é€‰å‡ºèº«"); 
    }
    
    // å­¦ç”Ÿè¡ŒåŠ¨é€»è¾‘ (æ¶ˆè€—ç²¾åŠ› + æ‰©å……ç©æ³•)
    function stuAct(t) { 
        let costs = {
            'hard_study': 40, 'study': 25, 'olympiad': 50, 'abroad': 30, 'work': 30, 'gacha': 10, 'esport': 40, 'show': 40, 'sport': 25, 'book': 20, 'sick': 10, 'parent': 15,
            'mun': 50, 'daydream': 10, 'scalper': 30, 'rooftop': 20,
            'diary': 10, 'volunteer': 25, 'club_drama': 35, 'tutor': 30, 'fight': 20, 'confession_prep': 40
        };
        let cost = costs[t] || 20;
        
        if(stuGame.energy < cost) { showToast("ğŸ˜´ ç²¾åŠ›ä¸è¶³ï¼Œè¯·ç‚¹å‡»ã€ç¡è§‰ã€‘ç»“æŸæœ¬æœˆï¼"); return; }
        
        stuGame.energy -= cost;
        let sLog = "";
        
        // æ•ˆæœæ¨¡æ‹Ÿ
        if(t==='study') { stuGame.grade+=2; stuGame.stress+=5; sLog="è®¤çœŸå¬è®²åšç¬”è®°ï¼Œå­¦ä¸š+2ï¼Œå‹åŠ›å¢åŠ ";}
        if(t==='hard_study') { stuGame.grade+=4; stuGame.stress+=12; sLog="ç–¯ç‹‚åˆ·çœŸé¢˜ç†¬å¤œï¼Œå­¦ä¸šå¤§å¢ï¼Œå¤´ç—›æ¬²è£‚ï¼";}
        if(t==='parent') { stuGame.money+=50; sLog="è·Ÿçˆ¶æ¯è¦äº†50å—é’±ç”Ÿæ´»è´¹ã€‚";}
        if(t==='work') { stuGame.money+=30; stuGame.fit-=2; sLog="å»æ ¡å¤–æ‰“å·¥ï¼Œèµšäº†30å…ƒï¼Œèº«ä½“ç–²æƒ«ã€‚";}
        if(t==='mun') { stuGame.grade+=1; stuGame.art+=3; sLog="å‚åŠ æ¨¡æ‹Ÿè”åˆå›½ï¼Œå£æ‰ä¸è§†é‡æå‡ï¼";}
        if(t==='daydream') { stuGame.stress=Math.max(0, stuGame.stress-5); sLog="å¯¹ç€çª—å¤–å‘å‘†ï¼Œç¨å¾®ç¼“äº†å£æ°”ã€‚";}
        if(t==='rooftop') { stuGame.stress=Math.max(0, stuGame.stress-12); sLog="åœ¨å¤©å°å¹é£ï¼Œå‹æŠ‘çš„å¿ƒæƒ…å¾—åˆ°ç¼“è§£ã€‚";}
        if(t==='sick') { stuGame.grade-=2; stuGame.stress=Math.floor(stuGame.stress/2); sLog="è£…ç—…èº²è¿›åŒ»åŠ¡å®¤ï¼Œæ¼äº†è¯¾ï¼Œä½†å‹åŠ›å‡åŠäº†ã€‚"; }
        if(t==='sport') { stuGame.fit+=3; stuGame.art+=1; stuGame.stress=Math.max(0,stuGame.stress-5); sLog="æŒ¥æ´’æ±—æ°´ï¼Œå¼ºå¥ä½“é­„ï¼"; }
        if(t==='book') { stuGame.art+=3; stuGame.stress=Math.max(0,stuGame.stress-5); sLog="åœ¨ä¹¦ä¸­æ‰¾åˆ°äº†é¢œå¦‚ç‰ã€‚"; }
        if(t==='show') { if(stuGame.art>60){stuGame.stress=Math.max(0,stuGame.stress-15); sLog="ä½ åœ¨èˆå°ä¸Šå¤§æ”¾å¼‚å½©ï¼å…¨åœºç©ç›®ï¼";}else{stuGame.stress=Math.min(100,stuGame.stress+10); sLog="æ‰è‰ºä¸ä½³ï¼Œæç ¸äº†è¡¨æ¼”ï¼Œå°´å°¬å¾—è„šè¶¾æŠ åœ°ã€‚";} }
        if(t==='esport') { if(Math.random()<0.5){stuGame.money+=100; stuGame.stress=Math.max(0,stuGame.stress-20); sLog="å¸¦é¢†æˆ˜é˜Ÿå¤ºå† ï¼Œç½‘è´¹å…¨å…è¿˜æ‹¿äº†å¥–é‡‘ï¼";}else{stuGame.stress=Math.min(100,stuGame.stress+10); sLog="é‡åˆ°çŒªé˜Ÿå‹è¿è·ªï¼Œæ°”å¾—é«˜è¡€å‹ã€‚";} }
        if(t==='scalper') { 
            if(Math.random()<0.3) { stuGame.money-=50; stuGame.stress+=20; sLog="å€’å–è¢«æ•™å¯¼ä¸»ä»»æŠ“ä½ï¼æ²¡æ”¶å¹¶ç½šæ¬¾ï¼"; }
            else { stuGame.money+=150; sLog="å€’å–æ¼”å”±ä¼šé—¨ç¥¨å¤§èµšä¸€ç¬”ï¼"; }
        }
        if(t==='diary') { 
            if(!stuGame.endingFlags) stuGame.endingFlags={};
            let diaryMonth = stuGame.endingFlags.diaryMonth;
            let curMonth = stuGame.turn; // use turn as unique month key
            if(diaryMonth === curMonth) { sLog="ä»Šå¤©å·²ç»å†™è¿‡æ—¥è®°äº†ï¼Œæ˜å¤©å†å†™å§ã€‚ï¼ˆæ¯æœˆé™å†™ä¸€æ¬¡ï¼‰"; }
            else {
                stuGame.endingFlags.diaryMonth = curMonth;
                stuGame.stress=Math.max(0,stuGame.stress-8); 
                stuGame.endingFlags.diary = (stuGame.endingFlags.diary||0)+1;
                sLog=`å†™äº†ç¬¬${stuGame.endingFlags.diary}ç¯‡æ—¥è®°ï¼Œå€¾è¯‰å†…å¿ƒç§¯å‹çš„æƒ…ç»ªï¼Œå‡å‹8ç‚¹ã€‚`;
                if(stuGame.endingFlags.diary>=5) { stuGame.endingFlags.writer=true; sLog+=" (è§£é”éšè—ç»“å±€ï¼šæ–‡å­—è®°å½•è€…)"; }
            }
        }
        if(t==='volunteer') { 
            stuGame.art+=3; stuGame.stress=Math.max(0,stuGame.stress-5);
            if(!stuGame.endingFlags) stuGame.endingFlags={};
            stuGame.endingFlags.volunteer=(stuGame.endingFlags.volunteer||0)+1;
            sLog="å‚åŠ ç¤¾åŒºæœåŠ¡ï¼Œå¸®åŠ©äº†æœ‰éœ€è¦çš„äººï¼Œé­…åŠ›+3ï¼Œå‹åŠ›-5ã€‚"; 
        }
        if(t==='club_drama') { 
            stuGame.art+=6; stuGame.stress=Math.max(0,stuGame.stress-15); 
            sLog="è¯å‰§ç¤¾æ’ç»ƒäº†ä¸‰ä¸ªå°æ—¶ï¼Œå®Œå…¨æ²‰æµ¸å…¶ä¸­ï¼Œå¿˜è®°äº†æ‰€æœ‰çƒ¦æ¼ï¼é­…åŠ›+6ï¼Œå‡å‹15ã€‚"; 
        }
        if(t==='tutor') { 
            stuGame.money+=80; stuGame.grade+=1; 
            sLog="ç»™å­¦å¼Ÿå­¦å¦¹è¡¥è¯¾ä¸¤å°æ—¶ï¼Œè®²é¢˜è¿‡ç¨‹ä¸­è‡ªå·±ä¹Ÿå·©å›ºäº†çŸ¥è¯†ç‚¹ï¼Œèµšäº†80å…ƒã€‚"; 
        }
        if(t==='fight') { 
            if(Math.random()<0.5) { 
                stuGame.stress=Math.max(0,stuGame.stress-20); stuGame.fit+=2;
                game.discipline-=5;
                sLog="ç—›æäº†å‡ ä¸ªæ¬ºè´Ÿäººçš„å®¶ä¼™ï¼Œå‹åŠ›æš´å‡ï¼ä½†çºªå¾‹ä¸»ä»»æ‰¾åˆ°å­¦æ ¡äº†â€¦â€¦çºªå¾‹-5ã€‚"; 
            } else { 
                stuGame.stress+=15; stuGame.fit-=3;
                sLog="è¢«å¯¹æ–¹å‡ ä¸ªäººå›´ä½äº†ï¼Œåƒäº†å¤§äºï¼Œèº«ä¸Šæœ‰ä¼¤ï¼Œè¿˜è¢«è¯·å®¶é•¿â€¦â€¦";
            }
        }
        if(t==='confession_prep') {
            if(!stuGame.confessionReady) stuGame.confessionReady = 0;
            stuGame.confessionReady = Math.min(3, stuGame.confessionReady+1);
            stuGame.stress = Math.max(0, stuGame.stress - 5);
            sLog = `ç²¾å¿ƒç­–åˆ’è¡¨ç™½æ–¹æ¡ˆï¼ˆè¿›åº¦${stuGame.confessionReady}/3ï¼‰ï¼Œå…‰æ˜¯æƒ³ç€å°±æœ‰ç‚¹ç”œèœœâ€¦â€¦å‡å‹5ã€‚`;
            if(stuGame.confessionReady>=3) sLog += " æ–¹æ¡ˆå°±ç»ªï¼è¡¨ç™½æˆåŠŸç‡å¤§å¹…æå‡ï¼";
        }
        
        // å¥¥èµ›æœºåˆ¶
        if(t === 'olympiad') {
            if(stuGame.isInsured) { sLog = "å·²ç»ä¿é€æ¸…åŒ—ï¼Œæ— éœ€å†å·ï¼"; }
            else {
                let successRate = stuGame.grade / 100; 
                if(Math.random() < successRate) {
                    stuGame.olympiadProgress = Math.min(100, stuGame.olympiadProgress + 15);
                    sLog = `æ”»å…‹éš¾é¢˜ï¼å¥¥èµ›è¿›åº¦: ${stuGame.olympiadProgress}%`;
                    if(stuGame.olympiadProgress >= 100) {
                        stuGame.isInsured = true;
                        showCustomModal("ğŸ† å›½å®¶é˜Ÿé‡‘ç‰Œï¼", "ä½ åœ¨å¥¥æ—åŒ¹å…‹ç«èµ›ä¸­æ–©è·é‡‘ç‰Œï¼Œå·²æå‰ä¿é€æ¸…åŒ—ï¼æ ¡é•¿ä¹ç–¯äº†ï¼", [{text:"çˆ½", action:()=>{ game.eduPoints+=100; game.reputation+=500; updateUI(); }}]);
                    }
                } else {
                    stuGame.stress += 20;
                    sLog = "é¢˜ç›®å¤ªéš¾ï¼Œä¸€é“æ²¡è§£å‡ºæ¥ï¼Œå¿ƒæ€ç‚¸è£‚ï¼";
                }
            }
        }
        
        let stuBox = document.getElementById('stu-log-box');
        stuBox.innerHTML += `<div>ğŸ‘‰ ${sLog}</div>`;
        stuBox.scrollTop = stuBox.scrollHeight;

        // å³æ—¶å´©æºƒæ£€æµ‹
        if(stuGame.stress >= 100) {
            stuGame.active = false;
            showCustomModal("ğŸ’€ ç²¾ç¥å´©æºƒ", 
                `<div style="text-align:center;padding:10px;">
                    <div style="font-size:3rem;">ğŸ§ ğŸ’¥</div>
                    <p style="color:#ef4444;font-weight:bold;">ç²¾ç¥å‹åŠ›çªç ´æé™ï¼</p>
                    <p>åœ¨ä¸€æ¬¡é«˜å¼ºåº¦å­¦ä¹ åï¼Œä½ çš„å­¦ç”Ÿå½“åœºå´©æºƒã€‚é«˜ä¸­ä¸‰å¹´çš„åŠªåŠ›æˆ›ç„¶è€Œæ­¢ã€‚</p>
                </div>`,
                [{text:"ç»“æŸæœ¬æ¬¡äººç”Ÿ", action:()=>{
                    stuGame = { active:false, year:1, month:1, turn:1, grade:40, stress:0, fit:40, art:40, talent:[], family:'', money:0, crushes:{}, lover:false, loverName:'', friends:[], examScore:0, energy:100, maxEnergy:100, olympiadProgress:0, isInsured:false };
                    switchMode('principal');
                }}]);
            return;
        }
        updateStuUI(); 
    }
    
    function endStudentMonth() {
        if(!stuGame.active) return;
        // è¢«åŠ¨ç²¾åŠ›ä¸å…‰ç¯ï¼ˆç‹¬ç«‹äºæ ¡é•¿ç³»ç»Ÿï¼‰
        stuGame.maxEnergy = hasPolicy('D5') ? 120 : 100;
        stuGame.energy = stuGame.maxEnergy;
        if(hasPolicy('A1')) stuGame.stress += 5;
        if(stuGame.lover) stuGame.energy = Math.min(stuGame.maxEnergy, stuGame.energy + 30);
        stuGame.friends.forEach(fid => { let f = FRIENDS.find(x=>x.id===fid); if(f) f.eff(); });

        stuGame.turn++;
        stuGame.month++;
        if(stuGame.month > 12) { stuGame.month = 1; stuGame.year++; }

        // å‹åŠ›æº¢å‡ºæ£€æµ‹ï¼ˆå´©æºƒç»“å±€ï¼‰
        if(stuGame.stress >= 100) {
            stuGame.active = false;
            showCustomModal("ğŸ’€ ç²¾ç¥å´©æºƒ", 
                `<div style="text-align:center;padding:10px;">
                    <div style="font-size:3rem;">ğŸ§ ğŸ’¥</div>
                    <p style="color:#ef4444;font-weight:bold;font-size:1.2rem;">ç²¾ç¥å‹åŠ›çªç ´æé™ï¼</p>
                    <p>ä½ çš„å­¦ç”Ÿé•¿æœŸæ‰¿å—å·¨å¤§å‹åŠ›ï¼Œæœ€ç»ˆåœ¨æŸä¸ªæ·±å¤œå½»åº•å´©æºƒã€‚<br>é«˜ä¸­ä¸‰å¹´çš„æ¢¦æƒ³ä¸æŒ£æ‰ï¼Œå°±æ­¤ç”»ä¸Šå¥å·ã€‚</p>
                    <p style="color:#94a3b8;font-size:0.85rem;">å­¦ä¸šåˆ†æ•°å½’é›¶ï¼Œæ— æ³•å‚åŠ é«˜è€ƒã€‚<br>è¯·å¥½å¥½ç…§é¡¾å­¦ç”Ÿçš„å¿ƒç†å¥åº·ã€‚</p>
                </div>`,
                [{text:"ç»“æŸæœ¬æ¬¡äººç”Ÿ", action:()=>{
                    stuGame = { active:false, year:1, month:1, turn:1, grade:40, stress:0, fit:40, art:40, talent:[], family:'', money:0, crushes:{}, lover:false, loverName:'', friends:[], examScore:0, energy:100, maxEnergy:100, olympiadProgress:0, isInsured:false };
                    document.getElementById('principal-container').style.display='grid';
                    document.getElementById('student-container').style.display='none';
                    updateUI();
                }}]);
            return;
        }

        // è‡ªåŠ¨è®¡ç®—å­¦ç”Ÿè”è€ƒ
        if(stuGame.month === 3 || stuGame.month === 6 || stuGame.month === 11) {
            let base = stuGame.grade * 5 + stuGame.art * 2 + stuGame.fit * 1;
            if(stuGame.isInsured) base = 750;
            let rand = Math.random() * 30;
            stuGame.examScore = Math.min(750, Math.floor(base + rand));
            let rank = Math.max(1, Math.floor(1000 - stuGame.examScore));
            document.getElementById('stu-exam-score').innerText = stuGame.examScore;
            document.getElementById('stu-exam-rank').innerText = `å…¨æ ¡æ’å: ${rank}`;
            let stuBox = document.getElementById('stu-log-box');
            if(stuBox) stuBox.innerHTML = `<div style="color:#2563eb;">ğŸ“… è”è€ƒç»“æŸï¼Œä½ çš„åˆ†æ•°: <b>${stuGame.examScore}</b>/750 (æ’å${rank})</div>` + stuBox.innerHTML;
        }

        // é«˜ä¸‰å‹åŠ›é€’å¢ç³»ç»Ÿï¼ˆç‹¬ç«‹ï¼‰
        let stuYearNum = Math.ceil(stuGame.turn / 12);
        if(stuYearNum >= 3 && !stuGame.seniorStarted) {
            stuGame.seniorStarted = true;
            stuGame.seniorCountdown = 12;
            showCustomModal("âš¡ é«˜ä¸‰å†²åˆºå¼€å§‹ï¼", `<div style="text-align:center;"><div style="font-size:3rem;">ğŸ“</div>
                <p>è·ç¦»é«˜è€ƒè¿˜æœ‰ <b style="color:var(--danger);font-size:1.5rem;">12</b> ä¸ªæœˆï¼</p>
                <p style="color:#ef4444;font-weight:bold;">ä»ç°åœ¨èµ·ï¼Œæ¯æœˆå‹åŠ›é€’å¢ã€‚è¯·æ…é‡åˆ†é…ç²¾åŠ›ï¼</p></div>`,
                [{text:"å†²ï¼ç»ä¸é€€ç¼©ï¼", action:()=>{stuGame.stress+=10; showToast("å‹åŠ›+10ï¼Œæ„å¿—å¦‚é“ï¼");}}]);
        }
        if(stuGame.seniorStarted && stuGame.seniorCountdown > 0) {
            stuGame.seniorCountdown = Math.max(0, (stuGame.seniorCountdown||0) - 1);
            let pressureGain = 3 + (12 - stuGame.seniorCountdown) * 1.5;
            stuGame.stress = Math.min(100, stuGame.stress + Math.floor(pressureGain));
            let rankEl = document.getElementById('stu-exam-rank');
            if(rankEl) rankEl.innerText = `â³ è·é«˜è€ƒï¼š${stuGame.seniorCountdown} ä¸ªæœˆ | æœ¬æœˆå‹åŠ›+${Math.floor(pressureGain)}`;

            // å´©æºƒè­¦å‘Šäº‹ä»¶
            if(stuGame.stress >= 85 && Math.random() < 0.25) {
                let events = [
                    { title:"ğŸš¨ ç²¾ç¥å´©æºƒè­¦æŠ¥", desc:"ä½ æ„Ÿè§‰è‡ªå·±å¿«è¦æ’‘ä¸ä½äº†â€¦â€¦", opt1:"å’¬ç‰™ç»§ç»­ï¼ˆå­¦ä¸š+5ï¼Œå‹åŠ›+15ï¼‰", opt2:"æ‰¾è€å¸ˆå€¾è¯‰ï¼ˆå‹åŠ›-20ï¼Œå­¦ä¸š-3ï¼‰",
                      eff1:()=>{stuGame.grade+=5;stuGame.stress=Math.min(100,stuGame.stress+15);}, eff2:()=>{stuGame.stress=Math.max(0,stuGame.stress-20);stuGame.grade-=3;} },
                    { title:"ğŸ˜° æƒ³è¦æ”¾å¼ƒé«˜è€ƒ", desc:"ä½ å†…å¿ƒå¼€å§‹è´¨ç–‘è¿™ä¸€åˆ‡çš„æ„ä¹‰â€¦â€¦", opt1:"å¼ºè¿«è‡ªå·±ï¼ˆå‹åŠ›+20ï¼Œå­¦ä¸š+3ï¼‰", opt2:"å’Œçˆ¶æ¯èŠèŠï¼ˆå‹åŠ›-15ï¼Œå­¦ä¸š-5ï¼‰",
                      eff1:()=>{stuGame.stress=Math.min(100,stuGame.stress+20);stuGame.grade+=3;}, eff2:()=>{stuGame.stress=Math.max(0,stuGame.stress-15);stuGame.grade-=5;} }
                ];
                let ev = events[Math.floor(Math.random()*events.length)];
                showCustomModal(ev.title, `<p>${ev.desc}</p><p style="color:#ef4444;">å½“å‰å‹åŠ›ï¼š${stuGame.stress}/100</p>`,
                    [{text:ev.opt1, action:()=>{ev.eff1(); updateStuUI();}},
                     {text:ev.opt2, action:()=>{ev.eff2(); updateStuUI();}}]);
                return;
            }
        }

        // å­¦ç”Ÿéšæœºå°äº‹ä»¶
        if(Math.random() < 0.12) {
            let evs = [
                {t:"ğŸ’ æ ¡å›­å¥‡é‡", d:"æ¡åˆ°ä¸€æœ¬äº”ä¸‰çœŸé¢˜ç§˜ç±ï¼", ops:[{text:"ç–¯ç‹‚å†…å·",action:()=>{stuGame.grade+=10;stuGame.stress+=20;updateStuUI();}},{text:"æ‹¿å»å–åºŸå“",action:()=>{stuGame.money+=50;updateStuUI();}}]},
                {t:"ğŸ‘€ è¢«è€å¸ˆå•ç‹¬è¾…å¯¼", d:"ä»»è¯¾è€å¸ˆå‘ç°ä½ çš„æ½œåŠ›ï¼", ops:[{text:"è®¤çœŸå¬è®²",action:()=>{stuGame.grade+=8;updateStuUI();}},{text:"æ•·è¡äº†äº‹",action:()=>{stuGame.stress=Math.max(0,stuGame.stress-5);updateStuUI();}}]},
                {t:"ğŸ® åŒå­¦é‚€ä½ æ‰“æ¸¸æˆ", d:"å®¿èˆå®¤å‹æ‹‰ä½ å¼€é»‘ä¸€å±€â€¦â€¦", ops:[{text:"é™ªç©ä¸€å±€",action:()=>{stuGame.stress=Math.max(0,stuGame.stress-15);stuGame.grade-=3;updateStuUI();}},{text:"å©‰è¨€æ‹’ç»",action:()=>{stuGame.grade+=2;updateStuUI();}}]}
            ];
            let ev = evs[Math.floor(Math.random()*evs.length)];
            showCustomModal(ev.t, ev.d, ev.ops);
            return;
        }

        // é«˜è€ƒç»“å±€
        if(stuGame.turn > 36) {
            stuGame.active = false;
            let score = stuGame.examScore;
            let ending = score>=700?"æ¸…åŒ—å½•å–ï¼Œæ¡ƒææ»¡å¤©ä¸‹ï¼":score>=600?"985å½•å–ï¼Œå‰ç¨‹ä¼¼é”¦ï¼":score>=550?"211å½•å–ï¼Œç¨³æ­¥å‰è¡Œã€‚":score>=450?"æœ¬ç§‘å½•å–ï¼Œç»§ç»­åŠ æ²¹ã€‚":"æœªè¾¾æœ¬ç§‘çº¿ï¼Œäººç”Ÿè·¯è¿˜é•¿ã€‚";
            showCustomModal("ğŸ“ é«˜è€ƒæ­æ™“",
                `<div style="text-align:center;"><div style="font-size:3rem;">ğŸ“</div>
                 <div style="font-size:2rem;font-weight:bold;color:#2563eb;">${score}<span style="font-size:1rem;">/750</span></div>
                 <div style="font-size:1.1rem;margin:10px 0;">${ending}</div>
                 ${stuGame.lover?`<p style="color:#db2777;">ğŸ’• ä¸${stuGame.loverName}ä¸€èµ·è¿æ¥æ–°äººç”Ÿã€‚</p>`:''}
                 </div>`,
                [{text:"ğŸ“œ æŸ¥çœ‹å®Œæ•´ç»“å±€", action:()=>{ showFinalRating('student'); }},
                 {text:"è¿”å›æ ¡é•¿è§†è§’", action:()=>{ document.getElementById('principal-container').style.display='grid'; document.getElementById('student-container').style.display='none'; updateUI(); }}]);
            return;
        }

        updateStuUI();
    }

    function updateStuUI() { 
        stuGame.energy = Math.min(stuGame.maxEnergy, Math.max(0, stuGame.energy || 0));
        stuGame.stress = Math.min(100, Math.max(0, stuGame.stress || 0));
        document.getElementById('stu-val-grade').innerText = stuGame.grade; 
        document.getElementById('stu-val-stress').innerText = Math.floor(stuGame.stress); 
        document.getElementById('stu-val-fit').innerText = stuGame.fit; 
        document.getElementById('stu-val-art').innerText = stuGame.art; 
        document.getElementById('stu-val-oly').innerText = Math.min(100, stuGame.olympiadProgress);
        document.getElementById('stu-val-money').innerText = stuGame.money;
        document.getElementById('stu-val-energy').innerText = stuGame.energy;
        document.getElementById('stu-bar-energy').style.width = Math.min(100, (stuGame.energy/stuGame.maxEnergy*100)) + '%';
        
        document.getElementById('stu-lover-tag').innerHTML = stuGame.lover ? `ğŸ’• ä¸[${stuGame.loverName}]çƒ­æ‹ä¸­` : 'ğŸ’” å•èº«ç‹—';

        document.getElementById('stu-ui-year').innerText = Math.ceil(stuGame.turn/12);
        document.getElementById('stu-ui-month').innerText = game.month;
        document.getElementById('stu-ui-turn').innerText = stuGame.turn;
    }
    
    // ================= æ‹çˆ±æœºåˆ¶æ‰©å…… (v2 - æ·±åº¦æƒ…æ„Ÿçº¿) =================
    // renderStuCrushes åœ¨ä¸‹æ–¹ç¬¬äºŒå¤„å®šä¹‰ï¼ŒåŒ…å«å®Œæ•´åŠŸèƒ½
    
    function interactCrush(cid, type) {
        if(stuGame.lover && type === 'confess') return showToast("ä½ å·²ç»æœ‰ä¼´ä¾£äº†ï¼Œä¸“ä¸€ä¸€ç‚¹ï¼");
        let ch = CRUSHES.find(x=>x.id===cid);
        let data = stuGame.crushes[cid];
        
        if(type === 'confess') {
            if(stuGame.energy < 50) return showToast("ç²¾åŠ›ä¸è¶³ï¼ˆéœ€è¦50ç‚¹ï¼‰");
            stuGame.energy -= 50;
            let dBox = document.getElementById(`dialog-${cid}`);
            if(dBox) dBox.style.display = 'block';
            
            if(data.aff >= 100) {
                if(hasPolicy('B3') || hasPolicy('B4')) {
                    if(dBox) dBox.innerText = `"å­¦æ ¡ç°åœ¨æŸ¥å¾—å¤ªä¸¥äº†ï¼Œç›‘æ§åˆ°å¤„éƒ½æ˜¯â€¦â€¦å¯¹ä¸èµ·ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç®—äº†å§ã€‚"`;
                    stuGame.stress += 50;
                    showToast("ç¯å¢ƒæ¶åŠ£ï¼Œè¡¨ç™½å¤±è´¥ï¼");
                } else {
                    stuGame.lover = true;
                    stuGame.loverName = ch.name;
                    if(dBox) dBox.innerText = `"å…¶å®â€¦â€¦æˆ‘ä¹Ÿå–œæ¬¢ä½ å¾ˆä¹…äº†ã€‚"`;
                    showToast(`ğŸ’˜ æˆåŠŸä¸ ${ch.name} å å…¥çˆ±æ²³ï¼`);
                    let achId = '';
                    if(cid==='lin') achId='ach_lin'; if(cid==='xia') achId='ach_xia';
                    if(cid==='jiang') achId='ach_jiang'; if(cid==='shen') achId='ach_shen';
                    if(achId && !game.achievements.includes(achId)) {
                        game.achievements.push(achId);
                        showToast(`ğŸ† è·å¾—æˆå°±ï¼š${ACHIEVEMENTS.find(x=>x.id===achId).name}`);
                    }
                }
            } else {
                if(dBox) dBox.innerText = `"æˆ‘ä»¬åªæ˜¯æ™®é€šçš„åŒå­¦å…³ç³»å§ï¼Ÿåˆ«å¼€è¿™ç§ç©ç¬‘äº†ã€‚"`;
                stuGame.stress += 30;
                showToast("å¥½æ„Ÿåº¦ä¸è¶³ï¼Œæƒ¨é­æ‹’ç»ï¼");
            }
        }

        // æ£€æŸ¥é˜¶æ®µäº‹ä»¶
        for(let lv in ch.events) {
            if(data.aff >= parseInt(lv) && !data.events.includes(lv)) {
                let ev = ch.events[lv];
                let checkRes = ev.check();
                if(checkRes === -999) {
                    showToast(`[äº‹ä»¶ä¸­æ–­] ${ch.name}å¯¹ä½ å¤§å¤±æ‰€æœ›ã€‚`);
                    data.events.push(lv);
                    data.aff -= 20;
                } else {
                    data.aff += 10 * checkRes;
                    data.events.push(lv);
                    showCustomModal(`ğŸ’• ç¾ç»ŠåŠ æ·±ï¼š${ch.name} - ${ev.name}`, `${ev.desc}<br><br><span style="color:var(--primary);font-weight:bold;">${ev.log}</span>`, [{text:"ç»§ç»­", action:()=>{renderStuCrushes(); updateStuUI();}}]);
                    return;
                }
            }
        }

        renderStuCrushes();
        updateStuUI();
    }

    // ================= å¥½æ„Ÿåº¦buffç³»ç»Ÿ =================
    function getCrushBuff(cid, aff) {
        if(aff < 30) return null;
        const buffs = {
            'lin': { name: 'å­¦éœ¸å…‰ç¯', desc: 'æ¯æ¬¡å­¦ä¹ é¢å¤–+2å­¦ä¸š', threshold: 30, apply: ()=>{ stuGame.grade += 2; } },
            'xia': { name: 'è‰ºæœ¯çµæ„Ÿ', desc: 'é­…åŠ›+3ï¼Œå‡å‹2', threshold: 30, apply: ()=>{ stuGame.art += 3; stuGame.stress = Math.max(0, stuGame.stress-2); } },
            'jiang': { name: 'è¿åŠ¨åŠ æˆ', desc: 'ä½“è´¨+2ï¼Œç²¾åŠ›+10', threshold: 30, apply: ()=>{ stuGame.fit += 2; stuGame.energy = Math.min(stuGame.maxEnergy, stuGame.energy+10); } },
            'shen': { name: 'å¿ƒçµæ…°è—‰', desc: 'å‡å‹5ï¼Œé­…åŠ›+2', threshold: 30, apply: ()=>{ stuGame.stress = Math.max(0,stuGame.stress-5); stuGame.art+=2; } }
        };
        return buffs[cid] || null;
    }

    // å¯¹è¯é€‰é¡¹ç³»ç»Ÿ - æ¯è§’è‰²10+ç§ï¼Œæœ‰å¢åŠ /å‡å°‘å¥½æ„Ÿçš„é€‰é¡¹
    const CRUSH_DIALOGUE_OPTIONS = {
        'lin': [
            { text: 'ä½ ä»Šå¤©è®²é¢˜è®²å¾—çœŸå¥½', effect: 5, reply: '"å“¼ï¼Œä½ åªæ˜¯åœ¨æ‹é©¬å±è€Œå·²ã€‚â€¦â€¦è°¢è°¢ä½ ã€‚"', type: 'good' },
            { text: 'å’±ä»¬ä¸€èµ·å»å›¾ä¹¦é¦†?', effect: 8, reply: '"å¥½å•Šï¼Œä½†ä½ å¾—è·Ÿä¸Šæˆ‘çš„è¿›åº¦ã€‚"', type: 'good' },
            { text: 'æˆ‘è§‰å¾—å¤ªå·äº†ï¼Œä¸å€¼å¾—', effect: -8, reply: '"ä½ è¿™ç§æ€åº¦è®©æˆ‘å¾ˆå¤±æœ›ã€‚è‡ªå·±æƒ³æ¸…æ¥šå§ã€‚"', type: 'bad' },
            { text: 'ä½ å¹³æ—¶æ€ä¹ˆæ”¾æ¾?', effect: 3, reply: '"â€¦â€¦å¶å°”ä¼šä¸€ä¸ªäººåœ¨å¤©å°çœ‹æ˜Ÿæ˜Ÿã€‚ä½ åˆ«ç¬‘è¯æˆ‘ã€‚"', type: 'neutral' },
            { text: 'å¸®æˆ‘æŠ„ä¸€ä¸‹ä½œä¸š', effect: -5, reply: '"ä½ ä»¥ä¸ºæˆ‘ä¼šå¸®ä½ ä½œå¼Šï¼Ÿï¼æ»šå»è‡ªå·±å†™ï¼"', type: 'bad' },
            { text: 'ä½ æœ‰æ²¡æœ‰æƒ³è¿‡æ¸…åä»¥å¤–çš„è·¯?', effect: 4, reply: '"æœ‰æ—¶å€™ä¼šæƒ³â€¦â€¦ä½†ç°åœ¨ä¸æ˜¯è¯¥æƒ³è¿™ä¸ªçš„æ—¶å€™ã€‚"', type: 'neutral' },
            { text: 'ä¸Šæ¬¡è€ƒè¯•ä½ æ˜¯ç¬¬ä¸€åå¯¹å—', effect: 6, reply: '"å—¯ã€‚ä½†æˆ‘è§‰å¾—æ•°å­¦è¿˜å¯ä»¥å†æé«˜ã€‚"', type: 'good' },
            { text: 'ä½ è¿™é“é¢˜çš„è§£æ³•ä¸å¯¹', effect: -3, reply: '"â€¦â€¦è®©æˆ‘é‡æ–°ç®—ç®—ã€‚ä½ è¯´å¾—æœ‰ç‚¹é“ç†ã€‚"', type: 'neutral' },
            { text: 'ä½ çš„å­—å¥½æ¼‚äº®', effect: 7, reply: '"â€¦ä½ æœ‰ç‚¹çƒ¦ã€‚è°¢è°¢ä½ æ³¨æ„åˆ°çš„ã€‚"', type: 'good' },
            { text: 'å‡æœŸæƒ³å»å“ªé‡Œ?', effect: 5, reply: '"æ¸…åå›­ã€‚æˆ‘è¦å»æ„Ÿå—ä¸€ä¸‹æ°›å›´ã€‚ä¹Ÿè®¸â€¦â€¦å¸¦ä¸Šä½ ä¹Ÿè¡Œã€‚"', type: 'good' },
        ],
        'xia': [
            { text: 'ä½ çš„ç”»çœŸçš„å¤ªæœ‰æ„Ÿè§‰äº†', effect: 8, reply: '"çœŸçš„å—ï¼Ÿï¼ä½ æ˜¯ç¬¬ä¸€ä¸ªè¿™ä¹ˆè¯´çš„ï¼"', type: 'good' },
            { text: 'è¦ä¸è¦ä¸€èµ·é€ƒè¯¾?', effect: 10, reply: '"å“‡ï¼Œä½ æ¯”æˆ‘æƒ³è±¡çš„æœ‰è¶£ï¼èµ°èµ°èµ°ï¼"', type: 'good' },
            { text: 'ç”»ç”»æ²¡ä»€ä¹ˆç”¨ï¼Œè¿˜æ˜¯å­¦ä¹ é‡è¦', effect: -10, reply: '"é‚£å°±åˆ«æ¥æ‰“æ‰°æˆ‘ç”»ç”»ï¼"', type: 'bad' },
            { text: 'è¿™é¦–æ­ŒçœŸå¥½å¬', effect: 6, reply: '"å¯¹å¯¹å¯¹ï¼è¿™æ˜¯æˆ‘æœ€è¿‘åœ¨è¿½çš„ä¹å›¢ï¼ä½ ä¹Ÿå–œæ¬¢ï¼Ÿ"', type: 'good' },
            { text: 'ä½ çš„åˆ¶æœå…¶å®æŒºå¥½çœ‹çš„', effect: 5, reply: '"â€¦â€¦å¥½å§ä½ çš„å®¡ç¾è¿˜è¡Œã€‚"', type: 'neutral' },
            { text: 'ä½ ç”»çš„è¿™æœµäº‘åƒæ£‰èŠ±ç³–', effect: 4, reply: '"å“ˆå“ˆï¼ä½ çš„è”æƒ³åŠ›ä¸å·®ï¼"', type: 'neutral' },
            { text: 'ä½ æœ‰æƒ³è¿‡å»æ„å¤§åˆ©å­¦è‰ºæœ¯å—', effect: 9, reply: '"ä½ â€¦â€¦æ€ä¹ˆçŸ¥é“æˆ‘çš„æ¢¦æƒ³ï¼Ÿä¸€èµ·å»å—ï¼Ÿ"', type: 'good' },
            { text: 'è¿™ç§é£æ ¼å¤ªå°ä¼—äº†', effect: -6, reply: '"éšä½ æ€ä¹ˆè¯´ï¼Œæˆ‘ä¸åœ¨ä¹å¤§ä¼—ã€‚"', type: 'bad' },
            { text: 'å¯ä»¥å¸®æˆ‘ç”»ä¸ªåƒå—', effect: 7, reply: '"å¥½å•Šï¼ä½†ä½ è¦ä¸€ç›´ä¿æŒè¿™ä¸ªè¡¨æƒ…ã€‚"', type: 'good' },
            { text: 'ä½ ä¸æ€•è¢«è€å¸ˆæŠ“åˆ°ç”»ç”»?', effect: 3, reply: '"æŠ“åˆ°åˆæ€æ ·ï¼Œå¤§ä¸äº†äº¤ä½œä¸šã€‚"', type: 'neutral' },
        ],
        'jiang': [
            { text: 'ä½ æ‰“ç¯®çƒçœŸçš„å¥½é…·', effect: 8, reply: '"å˜¿å˜¿ï¼Œä½ æ‡‚å¾—æ¬£èµï¼æ¥ï¼Œæˆ‘æ•™ä½ ï¼"', type: 'good' },
            { text: 'ä¸€èµ·å»æ‰“çƒå§', effect: 10, reply: '"ç­‰ä»€ä¹ˆï¼èµ°èµ·ï¼"', type: 'good' },
            { text: 'è¿åŠ¨æµªè´¹æ—¶é—´', effect: -10, reply: '"â€¦â€¦ä½ è¿™ç§äººæˆ‘æœ€çœ‹ä¸ä¸Šã€‚"', type: 'bad' },
            { text: 'ä½ æ˜¨å¤©é‚£ä¸ªä¸‰åˆ†çƒå¤ªå¸…äº†', effect: 7, reply: '"å“ˆï¼çœ‹åˆ°äº†ï¼Ÿé‚£å«è‰ºæœ¯ï¼"', type: 'good' },
            { text: 'å¸®æˆ‘åšä½œä¸šå§æˆ‘æ¥æ‰“çƒ', effect: -5, reply: '"å…„å¼Ÿï¼Œæˆ‘ä¹Ÿä¸ä¼šåšå•Šâ€¦â€¦"', type: 'bad' },
            { text: 'ä½ æœ‰æ²¡æœ‰æƒ³è¿‡æ‰“èŒä¸šè”èµ›', effect: 6, reply: '"å½“ç„¶ï¼æˆ‘å¯æ˜¯è¦è¿›å›½å®¶é˜Ÿçš„ç”·äººï¼"', type: 'good' },
            { text: 'ä»Šæ™šä¸€èµ·å»åƒçƒ§çƒ¤?', effect: 9, reply: '"è¿™è¯æˆ‘çˆ±å¬ï¼é›†åˆï¼"', type: 'good' },
            { text: 'ä½ å¹³æ—¶ä¹Ÿçœ‹ä¹¦å—', effect: 4, reply: '"â€¦â€¦å¶å°”ã€‚ä½“è‚²æ‚å¿—ç®—å—ï¼Ÿ"', type: 'neutral' },
            { text: 'ä½ å—ä¼¤äº†è¦å»åŒ»é™¢', effect: 6, reply: '"æ²¡äº‹æ²¡äº‹ï¼Œæ“¦ç ´ç‚¹çš®è€Œå·²ï¼"', type: 'neutral' },
            { text: 'çƒåœºçš„äº‹å…¨é ä½ äº†', effect: 5, reply: '"æ”¾å¿ƒï¼Œæˆ‘ä¸ä¼šè®©å¤§å®¶å¤±æœ›çš„ï¼"', type: 'good' },
        ],
        'shen': [
            { text: 'ä½ ä»Šå¤©çœ‹èµ·æ¥æŒºå¥½çš„', effect: 5, reply: '"â€¦â€¦å°‘åºŸè¯ã€‚"ï¼ˆä½†å˜´è§’å¾®å¾®ä¸Šæ‰¬ï¼‰', type: 'neutral' },
            { text: 'é‚£å¤©å¤šè°¢ä½ å¸®æˆ‘', effect: 8, reply: '"â€¦â€¦æˆ‘æ²¡æœ‰å¸®ä½ ï¼Œåˆ«ä¹±è¯´ã€‚"ï¼ˆèƒŒè¿‡è„¸å»ï¼‰', type: 'good' },
            { text: 'ä½ ä¸ºä»€ä¹ˆæ€»æ˜¯é€ƒè¯¾?', effect: -4, reply: '"å…³ä½ ä»€ä¹ˆäº‹ã€‚"', type: 'bad' },
            { text: 'è¿™é¦–æ­Œæ˜¯ä½ åœ¨å¬å—', effect: 7, reply: '"â€¦â€¦ä½ ä¹Ÿå¬åœ°ä¸‹ä¹é˜Ÿï¼Ÿ"ï¼ˆéœ²å‡ºæƒŠè®¶è¡¨æƒ…ï¼‰', type: 'good' },
            { text: 'ä½ åº”è¯¥å¥½å¥½ä¸Šè¯¾', effect: -8, reply: '"ä½ å’Œé‚£äº›è€å¸ˆä¸€æ ·çƒ¦ã€‚"', type: 'bad' },
            { text: 'æˆ‘ä¸ä¼šå‘Šè¯‰åˆ«äººä½ æ‰“å·¥çš„äº‹', effect: 10, reply: '"â€¦â€¦ä½ ä¸ºä»€ä¹ˆè¦å¸®æˆ‘ã€‚"ï¼ˆæ²‰é»˜è‰¯ä¹…ï¼‰', type: 'good' },
            { text: 'æŸ“å‘å¥½çœ‹ï¼Œæ˜¯ä»€ä¹ˆé¢œè‰²?', effect: 6, reply: '"â€¦â€¦æ˜Ÿäº‘è“ã€‚ä½ çœ¼ç›ä¸é”™ã€‚"', type: 'good' },
            { text: 'ä½ å®¶é‡Œâ€¦â€¦è¿˜å¥½å—', effect: 5, reply: '"â€¦â€¦ç®¡å¥½ä½ è‡ªå·±ã€‚"ï¼ˆè¯­æ°”è½¯åŒ–äº†ï¼‰', type: 'neutral' },
            { text: 'å€Ÿä½ æœ¬ä¹¦', effect: 9, reply: '"â€¦â€¦è¿™æ˜¯ä½ å–œæ¬¢çš„ä¹¦å—ã€‚"ï¼ˆè½»è½»æ¥è¿‡ï¼‰', type: 'good' },
            { text: 'è·Ÿæˆ‘è¯´è¯´ä½ è¿‡å»çš„äº‹?', effect: -3, reply: '"æˆ‘è¯´äº†ï¼Œåˆ«é—®ã€‚"', type: 'bad' },
        ]
    };
    
    // ç¤¼ç‰©ç³»ç»Ÿ
    const GIFT_CATALOG = {
        'lin': [
            { name: 'æ¸…åå¤§å­¦å‘¨è¾¹çºªå¿µå†Œ', cost: 80, effect: 15, reply: '"è¿™â€¦â€¦è¿™æ­£æ˜¯æˆ‘æƒ³è¦çš„ï¼è°¢è°¢ä½ ï¼ï¼"' },
            { name: 'é«˜ä¸­æ•°å­¦è§£é¢˜å®å…¸', cost: 50, effect: 10, reply: '"æ­£å¥½æˆ‘ç¼ºè¿™æœ¬ï¼Œè°¢è°¢ä½ è®°å¾—ã€‚"' },
            { name: 'æ¸¸ä¹åœºé—¨ç¥¨', cost: 100, effect: -5, reply: '"â€¦â€¦æˆ‘æ²¡ç©ºå»è¿™ç§åœ°æ–¹ã€‚"' },
        ],
        'xia': [
            { name: 'æ‰‹å·¥é¢œæ–™å¥—è£…', cost: 120, effect: 18, reply: '"è¿™æ˜¯ä¸“ä¸šçº§çš„ï¼ä½ çœŸçš„å¤ªæ‡‚æˆ‘äº†ï¼"' },
            { name: 'æ¢µé«˜ç”»å†Œ', cost: 80, effect: 12, reply: '"å“‡ï¼æˆ‘æœ€å–œæ¬¢æ¢µé«˜ï¼ä½ æ€ä¹ˆçŸ¥é“ï¼"' },
            { name: 'æ•°å­¦ä¹ é¢˜é›†', cost: 30, effect: -8, reply: '"â€¦â€¦è°¢è°¢ï¼Œæˆ‘â€¦â€¦ä¸éœ€è¦è¿™ä¸ªã€‚"' },
        ],
        'jiang': [
            { name: 'NBAçºªå¿µç‰ˆçƒè¡£', cost: 150, effect: 18, reply: '"å“‡é ï¼è¿™æ˜¯æˆ‘æœ€å–œæ¬¢çš„çƒé˜Ÿï¼å¤ªä»—ä¹‰äº†ï¼"' },
            { name: 'è›‹ç™½ç²‰èƒ½é‡æ£’', cost: 60, effect: 10, reply: '"å…„å¼Ÿï¼Œä½ å¤ªæ‡‚æˆ‘äº†ï¼"' },
            { name: 'æ–‡å­¦åè‘—å…¨é›†', cost: 80, effect: -3, reply: '"å‘ƒâ€¦â€¦è°¢äº†ï¼Œæˆ‘â€¦â€¦ä¼šçœ‹çš„ã€‚"' },
        ],
        'shen': [
            { name: 'åœ°ä¸‹ä¹é˜Ÿä¸“è¾‘é»‘èƒ¶', cost: 100, effect: 20, reply: '"â€¦â€¦ä½ æ€ä¹ˆæ‰¾åˆ°è¿™å¼ çš„ã€‚"ï¼ˆçœ¼çœ¶å¾®çº¢ï¼‰', },
            { name: 'ä¾¿åˆ©åº—ç”œå“', cost: 30, effect: 8, reply: '"â€¦â€¦æˆ‘ä¸å–œæ¬¢ç”œçš„ã€‚ä½†è°¢è°¢ä½ ã€‚"ï¼ˆé»˜é»˜åƒæ‰ï¼‰' },
            { name: 'åŠ±å¿—æˆåŠŸå­¦ä¹¦', cost: 40, effect: -12, reply: '"ä½ è§‰å¾—æˆ‘éœ€è¦è¢«æ¿€åŠ±ï¼Ÿæ»šã€‚"' },
        ]
    };

    function renderStuCrushes() {
        let c = document.getElementById('stu-crush-container');
        c.innerHTML = '';
        CRUSHES.forEach(ch => {
            let data = stuGame.crushes[ch.id];
            if(!data) return;
            
            let aff = data.aff;
            let buffInfo = getCrushBuff(ch.id, aff);
            let buffTag = buffInfo && aff >= 30 ? `<div style="background:#fdf2f8; border:1px solid #f9a8d4; padding:4px 8px; border-radius:4px; font-size:0.7rem; color:#be185d; margin-bottom:5px;">âœ¨ å¥½æ„ŸBUFF: ${buffInfo.name} - ${buffInfo.desc}</div>` : '';
            
            // é€æ­¥è§£é”å±æ€§ä¿¡æ¯
            let attrInfo = '';
            if(aff >= 20) attrInfo += `<span style="font-size:0.65rem; background:#f0fdf4; color:#166534; padding:1px 4px; border-radius:3px; margin-right:3px;">çˆ±å¥½å·²è§£é”</span>`;
            if(aff >= 50) attrInfo += `<span style="font-size:0.65rem; background:#eff6ff; color:#1e40af; padding:1px 4px; border-radius:3px; margin-right:3px;">ç§˜å¯†å·²è§£é”</span>`;
            if(aff >= 80) attrInfo += `<span style="font-size:0.65rem; background:#faf5ff; color:#6b21a8; padding:1px 4px; border-radius:3px; margin-right:3px;">å¿ƒå£°å·²è§£é”</span>`;
            
            let html = `
            <div class="crush-card">
                <div class="crush-head">
                    <img src="src/love/${ch.id}.png" class="crush-img" style="width:70px;height:70px;cursor:pointer;" onclick="showCrushPortrait('${ch.id}')"
                        onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'70\\' height=\\'70\\'><circle cx=\\'35\\' cy=\\'35\\' r=\\'35\\' fill=\\'%23fbcfe8\\'/><text x=\\'50%\\' y=\\'50%\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' font-size=\\'16\\' fill=\\'%23be185d\\'>${ch.name[0]}</text></svg>'" title="ç‚¹å‡»æŸ¥çœ‹ç«‹ç»˜">
                    <div class="crush-info">
                        <h4>${ch.name} <span style="font-size:0.7rem;color:#f472b6;">[${ch.title}]</span></h4>
                        <p>${ch.desc}</p>
                        ${attrInfo}
                    </div>
                </div>
                ${buffTag}
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                    <span style="font-size:0.7rem;color:#be185d;font-weight:bold;">å¥½æ„Ÿåº¦ ${Math.floor(aff)}/100</span>
                    ${aff>=100?'<span style="font-size:0.7rem;color:#db2777;font-weight:bold;">ğŸ’– å¿ƒåŠ¨æ»¡æº¢</span>':''}
                </div>
                <div class="crush-bar-bg"><div class="crush-bar-fill" style="width:${Math.min(100,aff)}%"></div></div>
                <div class="crush-dialog" id="dialog-${ch.id}"></div>
                <div class="crush-actions">
                    <button class="btn" style="margin:0; font-size:0.75rem; padding:6px;" onclick="showDialogOptions('${ch.id}')">ğŸ’¬ é€‰æ‹©è¯é¢˜ (5èƒ½)</button>
                    <button class="btn" style="margin:0; font-size:0.75rem; padding:6px;" onclick="showDeepCrushDialog('${ch.id}')">ğŸ­ è§¦å‘åœºæ™¯å¯¹è¯ (5èƒ½)</button>
                    <button class="btn" style="margin:0; font-size:0.75rem; padding:6px;" onclick="showGiftMenu('${ch.id}')">ğŸ é€‰æ‹©ç¤¼ç‰©</button>
                    <button class="btn-main" style="grid-column:1/-1; margin:0; padding:8px; font-size:0.8rem; background:#db2777;" onclick="interactCrush('${ch.id}', 'confess')">ğŸ’˜ å‹‡æ•¢è¡¨ç™½ (50èƒ½)</button>
                </div>
            </div>`;
            c.innerHTML += html;
        });
    }
    
    const CRUSH_PROFILES = {
        'lin': {
            icon: 'ğŸ“š', color: '#be185d',
            intro: 'æ—çŸ¥ç§‹ï¼Œ17å²ï¼Œæ–‡ç§‘ç­ç­é•¿ï¼Œå…¨å¹´çº§ç¬¬ä¸€ã€‚å¥¹çš„ä¸–ç•Œåªæœ‰ä¸‰ç§é¢œè‰²ï¼šè¯•å·çš„ç™½ã€å¢¨æ°´çš„é»‘ã€æ¸…åæ ¡å¾½çš„ç´«ã€‚æ¯å¤©æ—©ä¸Šäº”ç‚¹èµ·åºŠï¼ŒèƒŒå•è¯ã€åšç¬”è®°ã€æ•´ç†é”™é¢˜æœ¬â€”â€”å¥¹ä¸å…è®¸è‡ªå·±çŠ¯é”™ï¼Œå› ä¸ºå¥¹çŸ¥é“ï¼Œä¸€æ—¦åœä¸‹æ¥ï¼Œé‚£äº›å‹ç€å¥¹çš„ä¸œè¥¿å°±ä¼šæŠŠå¥¹æ·¹æ²¡ã€‚',
            hobby: 'å†™è¯—ï¼ˆä»ä¸ç»™äººçœ‹ï¼‰ã€å¤œæ™šåœ¨å¤©å°æ•°æ˜Ÿæ˜Ÿ',
            fear: 'å®³æ€•è®©çˆ¶æ¯å¤±æœ›ï¼Œå®³æ€•å‘ç°åŠªåŠ›æ²¡æœ‰æ„ä¹‰',
            dream: 'è€ƒä¸Šæ¸…åï¼Œç„¶åâ€¦â€¦å¥¹è¿˜æ²¡æœ‰æƒ³è¿‡"ç„¶å"ã€‚',
            quote: '"æˆ‘ä¸æ˜¯å¤©æ‰ï¼Œæˆ‘åªæ˜¯ä¸æ•¢åœã€‚"'
        },
        'xia': {
            icon: 'ğŸ¨', color: '#7c3aed',
            intro: 'å¤æ™šæ™´ï¼Œ17å²ï¼Œè‰ºæœ¯ç‰¹é•¿ç”Ÿï¼Œæ ¡å¤–å…¼èŒæ¨¡ç‰¹ã€‚å¥¹æ˜¯é‚£ç§èµ°è¿›æ•™å®¤ä¼šè®©ç©ºæ°”éƒ½å˜å¾—ä¸åŒçš„äººâ€”â€”é¦™æ°´ã€æ•£å‘ã€æ°¸è¿œæ­ªæˆ´çš„å¸½å¾½ã€‚å¥¹è®¨åŒè§„åˆ™ï¼Œè®¨åŒæ ‡å‡†ç­”æ¡ˆï¼Œè®¨åŒä»»ä½•å‘Šè¯‰å¥¹"åº”è¯¥æ€æ ·"çš„äººã€‚ä½†å¾ˆå°‘æœ‰äººçŸ¥é“ï¼Œå¥¹æ¯å¤©æ·±å¤œéƒ½åœ¨ç”»ç”»ï¼Œç”»å¥¹é‚£ä¸ªåªæœ‰å¥¹è‡ªå·±èƒ½è¿›å…¥çš„ä¸–ç•Œã€‚',
            hobby: 'åœ°ä¸‹å±•è§ˆã€ç‹¬ç«‹éŸ³ä¹èŠ‚ã€åŠå¤œå†™ç”Ÿ',
            fear: 'å®³æ€•æœ‰ä¸€å¤©å†ä¹Ÿç”»ä¸å‡ºè®©è‡ªå·±æ„ŸåŠ¨çš„ä¸œè¥¿',
            dream: 'å»ç±³å…°ï¼Œå¼€ä¸€åœºåªå±äºè‡ªå·±çš„ä¸ªå±•',
            quote: '"æˆ‘ä¸æ˜¯åœ¨é€ƒè¯¾ï¼Œæˆ‘æ˜¯åœ¨æ‰¾çœŸæ­£çš„è¯¾ã€‚"'
        },
        'jiang': {
            icon: 'ğŸ€', color: '#0369a1',
            intro: 'æ±Ÿä¸€èˆŸï¼Œ18å²ï¼Œæ ¡ç¯®çƒé˜Ÿé˜Ÿé•¿ï¼Œä½“è‚²ç‰¹é•¿ç”Ÿã€‚ä»–æ˜¯é‚£ç§ä½ ä¸€çœ¼å°±ä¼šæ³¨æ„åˆ°çš„ç”·ç”Ÿâ€”â€”ä¸æ˜¯å› ä¸ºå¸…ï¼Œè€Œæ˜¯å› ä¸ºä»–èº«ä¸Šæœ‰ä¸€ç§è®©äººæ”¾æ¾çš„åŠ›é‡ã€‚ä»–å¤§å¤§å’§å’§ï¼Œä¹‰æ°”å½“å¤´ï¼Œå¯ä»¥ä¸ºäº†æœ‹å‹ç¿»å¢™å‡ºå»ä¹°å®µå¤œï¼Œä¹Ÿå¯ä»¥å¸¦ä¼¤ä¸Šåœºæ‰“å®Œå†³èµ›ã€‚å¾ˆå¤šäººä¸çŸ¥é“ä»–å³æ‰‹æœ‰ä¸€å¤„æ²¡æœ‰å®Œå…¨åº·å¤çš„æ—§ä¼¤ã€‚',
            hobby: 'NBAç›´æ’­ã€è¡—å¤´ç¯®çƒã€åƒçƒ§çƒ¤',
            fear: 'å®³æ€•æœ‰ä¸€å¤©æ‰“ä¸äº†çƒï¼Œå®³æ€•è¢«äººçœ‹å‡ºä»–å…¶å®ä¹Ÿä¼šç´¯',
            dream: 'è¿›çœé˜Ÿï¼Œç„¶åæ˜¯å›½å®¶é˜Ÿ',
            quote: '"è¾“äº†å¯ä»¥ï¼Œä½†ä¸èƒ½è¾“å¾—ä¸å¥½çœ‹ã€‚"'
        },
        'shen': {
            icon: 'ğŸŒ™', color: '#475569',
            intro: 'æ²ˆæ¸”ï¼Œ17å²ï¼Œä»å¤§åŸå¸‚è½¬æ¥çš„æ’ç­ç”Ÿï¼ŒæŸ“äº†ä¸€å¤´æ˜Ÿäº‘è“çš„å‘ï¼Œè€³æœºæ°¸è¿œæŒ‚åœ¨è„–å­ä¸Šã€‚å¥¹ä¸è·Ÿäººè¯´è¯ï¼Œä¸å‚åŠ ä»»ä½•æ´»åŠ¨ï¼Œè¯¾å ‚ä¸Šè¦ä¹ˆç¡è§‰è¦ä¹ˆçœ‹çª—å¤–ã€‚å…¨æ ¡éƒ½çŸ¥é“å¥¹æ˜¯"é—®é¢˜å­¦ç”Ÿ"ï¼Œä½†æ²¡æœ‰äººçŸ¥é“å¥¹æ¯å¤©æ”¾å­¦åå»å“ªé‡Œâ€”â€”å¥¹åœ¨ç»™å¼Ÿå¼Ÿçš„å­¦è´¹æ‰“å·¥ã€‚å¥¹çš„é˜²å¾¡å¿ƒæ˜¯ä¸€åº§åŸå¢™ï¼Œä½†åŸå¢™é‡Œé¢ï¼Œä½ç€ä¸€ä¸ªæåº¦æ¸´æœ›è¢«çœŸæ­£ç†è§£çš„äººã€‚',
            hobby: 'åœ°ä¸‹ä¹é˜Ÿã€æ·±å¤œä¾¿åˆ©åº—ã€ä¸€ä¸ªäººèµ°å¾ˆè¿œçš„è·¯',
            fear: 'å®³æ€•è¢«äººç”¨æ€œæ‚¯çš„çœ¼ç¥çœ‹å¾…',
            dream: 'è®©å¼Ÿå¼Ÿèƒ½å¥½å¥½ä¸Šå­¦ï¼Œè‡³äºè‡ªå·±â€¦â€¦èµ°ä¸€æ­¥çœ‹ä¸€æ­¥ã€‚',
            quote: '"åˆ«é—®æˆ‘ä¸ºä»€ä¹ˆï¼Œé—®äº†æˆ‘ä¹Ÿä¸ä¼šè¯´ã€‚"'
        }
    };

    function showCrushPortrait(cid) {
        let ch = CRUSHES.find(x=>x.id===cid);
        let aff = (stuGame.crushes[cid] && stuGame.crushes[cid].aff) || 0;
        let prof = CRUSH_PROFILES[cid];
        
        let secrets = '';
        if(aff >= 50) secrets += `<div style="background:#f5f3ff;border-left:3px solid #8b5cf6;padding:8px 10px;border-radius:0 6px 6px 0;margin-top:8px;"><span style="color:#7c3aed;font-size:0.7rem;font-weight:bold;">ğŸ’œ è§£é”ç§˜å¯†ï¼ˆå¥½æ„Ÿâ‰¥50ï¼‰</span><p style="margin:4px 0 0;font-size:0.8rem;color:#475569;">${cid==='lin'?'å¥¹åœ¨å¤©å°ä¸Šå†™äº†ä¸‰å¹´è¯—ï¼Œä»æœªè®©ä»»ä½•äººçœ‹è¿‡ã€‚æœ‰ä¸€é¦–å†™çš„æ˜¯"å¦‚æœå¯ä»¥ï¼Œæˆ‘æƒ³åœ¨å®‡å®™è¾¹ç•Œå’Œä½ ä¸€èµ·è¿·è·¯"ã€‚':cid==='xia'?'å¥¹çš„æ¯äº²æ˜¯ä½ä¸¥è‹›çš„é’¢ç´è€å¸ˆï¼Œå¥¹ç”»ç”»æœ€åˆåªæ˜¯é€ƒç¦»ç´å£°çš„æ–¹å¼ï¼Œå´æ„å¤–å˜æˆäº†å¥¹å”¯ä¸€çš„å‡ºå£ã€‚':cid==='jiang'?'ä»–å³æ‰‹æœ‰ä¸€å¤„æ—§ä¼¤æ²¡æœ‰å®Œå…¨åº·å¤ï¼Œä½†ä»–åœ¨å†³èµ›å‰æ²¡æœ‰å‘Šè¯‰ä»»ä½•äººã€‚é‚£åœºçƒï¼Œä»–æ‰“å®Œå°±å»åŒ»åŠ¡å®¤æ‰“äº†å°é—­é’ˆã€‚':'å¥¹åœ¨æ‰“å·¥å…»å¼Ÿå¼Ÿä¸Šå­¦ï¼Œæ¯æœˆå·¥èµ„è½¬ç»™å®¶é‡Œï¼Œè‡ªå·±åªç•™ç”Ÿæ´»è´¹ã€‚å­¦æ ¡é‡Œæ²¡æœ‰ä¸€ä¸ªäººçŸ¥é“ã€‚'}</p></div>`;
        if(aff >= 80) secrets += `<div style="background:#fdf2f8;border-left:3px solid #ec4899;padding:8px 10px;border-radius:0 6px 6px 0;margin-top:8px;"><span style="color:#be185d;font-size:0.7rem;font-weight:bold;">ğŸ’– å¿ƒé‡Œè¯ï¼ˆå¥½æ„Ÿâ‰¥80ï¼‰</span><p style="margin:4px 0 0;font-size:0.8rem;color:#475569;font-style:italic;">${cid==='lin'?'"æˆ‘æƒ³è€ƒæ¸…åï¼Œä½†å¦‚æœå¯ä»¥çš„è¯â€¦â€¦æˆ‘å¸Œæœ›æˆ‘ä»¬èƒ½åœ¨åŒä¸€åº§åŸå¸‚ã€‚è¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡ï¼ŒæŠŠä¸€ä¸ªäººæ”¾è¿›æˆ‘çš„è®¡åˆ’é‡Œã€‚"':cid==='xia'?'"æˆ‘æ€•æˆ‘çœŸçš„ä¼šçˆ±ä¸Šä½ ã€‚ä½ å‡ºç°å¾—ä¸æ˜¯æ—¶å€™ï¼Œæˆ‘è¿˜æ²¡å‡†å¤‡å¥½è®©ä¸€ä¸ªäººçœ‹è§æˆ‘æ²¡ç”»å®Œçš„é‚£äº›ç”»ã€‚"':cid==='jiang'?'"ä½ æ˜¯æˆ‘é™¤äº†çƒä»¥å¤–ï¼Œç¬¬ä¸€ä¸ªè®©æˆ‘æƒ³è®¤çœŸä¿æŠ¤çš„äººã€‚è¿™è¯æˆ‘æ²¡è·Ÿä»»ä½•äººè¯´è¿‡ã€‚"':'"è°¢è°¢ä½ æ²¡æœ‰ç”¨é‚£ç§çœ¼ç¥çœ‹æˆ‘â€¦â€¦ä½ çŸ¥é“é‚£ç§çœ¼ç¥ã€‚è°¢è°¢ä½ è®©æˆ‘è§‰å¾—ï¼Œæˆ‘ä¹Ÿæ˜¯ä¸ªæ™®é€šäººã€‚"'}</p></div>`;
        
        showCustomModal(`${ch.name} Â· ${ch.title}`, `
            <div style="display:flex;gap:15px;align-items:flex-start;flex-wrap:wrap;">
                <div style="text-align:center;flex-shrink:0;">
                    <img src="src/avatar/${cid}.png" style="max-width:160px;max-height:220px;border-radius:8px;border:3px solid #f9a8d4;"
                        onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                    <div style="display:none;width:120px;height:160px;background:linear-gradient(135deg,#fdf2f8,#fce7f3);border-radius:8px;align-items:center;justify-content:center;border:3px dashed #f9a8d4;flex-direction:column;">
                        <div style="font-size:3rem;">${prof.icon}</div>
                        <div style="font-size:0.8rem;color:${prof.color};margin-top:8px;font-weight:bold;">${ch.name}</div>
                    </div>
                    <div style="margin-top:8px;background:#fdf2f8;border-radius:6px;padding:6px 10px;">
                        <div style="font-size:0.7rem;color:#be185d;font-weight:bold;">å¥½æ„Ÿåº¦</div>
                        <div style="background:#f1f5f9;height:6px;border-radius:3px;overflow:hidden;margin-top:4px;">
                            <div style="background:linear-gradient(90deg,#f472b6,#db2777);height:100%;width:${Math.min(100,aff)}%;transition:0.3s;"></div>
                        </div>
                        <div style="font-size:0.7rem;color:#64748b;margin-top:2px;">${Math.floor(aff)}/100</div>
                    </div>
                </div>
                <div style="flex:1;min-width:200px;text-align:left;">
                    <h3 style="color:${prof.color};margin:0 0 8px;">${ch.name} <span style="font-size:0.8rem;color:#94a3b8;">Â· ${ch.title}</span></h3>
                    <p style="font-size:0.82rem;color:#475569;line-height:1.6;margin:0 0 10px;">${prof.intro}</p>
                    <div style="display:flex;flex-direction:column;gap:5px;font-size:0.8rem;">
                        <div style="background:#f8fafc;padding:6px 10px;border-radius:6px;"><span style="color:#64748b;font-weight:bold;">çˆ±å¥½ï¼š</span>${prof.hobby}</div>
                        <div style="background:#f8fafc;padding:6px 10px;border-radius:6px;"><span style="color:#64748b;font-weight:bold;">å®³æ€•ï¼š</span>${prof.fear}</div>
                        <div style="background:#f8fafc;padding:6px 10px;border-radius:6px;"><span style="color:#64748b;font-weight:bold;">æ¢¦æƒ³ï¼š</span>${prof.dream}</div>
                        <div style="background:#fdf2f8;padding:8px 10px;border-radius:6px;border-left:3px solid ${prof.color};font-style:italic;color:#475569;">"${prof.quote}"</div>
                    </div>
                    ${secrets}
                </div>
            </div>`, [{text:'å…³é—­', action:()=>{}}]);
    }
    
    function showDialogOptions(cid) {
        if(stuGame.energy < 5) return showToast("ç²¾åŠ›ä¸è¶³ï¼ˆéœ€è¦5ç‚¹ï¼‰");
        let ch = CRUSHES.find(x=>x.id===cid);
        let options = CRUSH_DIALOGUE_OPTIONS[cid] || [];
        let selected = [...options].sort(()=>Math.random()-0.5).slice(0,5);
        let curAff = (stuGame.crushes[cid]&&stuGame.crushes[cid].aff)||0;
        let html = `<p style="color:#64748b; font-size:0.85rem; margin-top:0;">å’Œ ${ch.name} èŠä»€ä¹ˆï¼Ÿï¼ˆå½“å‰å¥½æ„Ÿï¼š<b style="color:#db2777;">${Math.floor(curAff)}</b>/100ï¼‰</p>
        <div style="display:flex;flex-direction:column;gap:8px;">`;
        selected.forEach((opt) => {
            let idx = options.indexOf(opt);
            html += `<button class="btn" style="text-align:left;padding:12px 14px;font-size:0.9rem;" onclick="pickDialogOption('${cid}',${idx})">${opt.text}</button>`;
        });
        html += '</div>';
        showCustomModal(`ğŸ’¬ å’Œ ${ch.name} èŠå¤©`, html, [{text:'ç®—äº†ï¼Œä¸è¯´äº†', action:()=>{}}]);
    }
    
    function pickDialogOption(cid, optIdx) {
        stuGame.energy -= 5;
        let ch = CRUSHES.find(x=>x.id===cid);
        let opt = CRUSH_DIALOGUE_OPTIONS[cid][optIdx];
        let data = stuGame.crushes[cid];
        let oldAff = data.aff;
        data.aff = Math.max(0, Math.min(100, data.aff + opt.effect));
        let delta = Math.round(data.aff - oldAff);
        let deltaStr = delta > 0 ? `<span style="color:#10b981;font-weight:bold;font-size:1.1rem;">+${delta} å¥½æ„Ÿ ğŸ’š</span>` : delta < 0 ? `<span style="color:#ef4444;font-weight:bold;font-size:1.1rem;">${delta} å¥½æ„Ÿ â¤ï¸â€ğŸ”¥</span>` : `<span style="color:#f59e0b;font-weight:bold;">æ— å˜åŒ– ğŸ’›</span>`;
        let resultHtml = `<div style="background:#f8fafc;border-radius:8px;padding:12px;margin-bottom:12px;border-left:3px solid #cbd5e1;">
            <p style="margin:0;font-size:0.9rem;color:#475569;font-style:italic;">"${opt.reply}"</p>
        </div>
        <div style="text-align:center;padding:8px;">${deltaStr}<br><span style="font-size:0.8rem;color:#64748b;">å½“å‰å¥½æ„Ÿï¼š${Math.floor(data.aff)}/100</span></div>`;
        showCustomModal(`ğŸ’¬ ${ch.name} çš„å›åº”`, resultHtml, [{text:'æ˜ç™½äº†', action:()=>{ checkCrushBuff(cid); renderStuCrushes(); updateStuUI(); }}]);
    }
    
    function showGiftMenu(cid) {
        let ch = CRUSHES.find(x=>x.id===cid);
        let gifts = GIFT_CATALOG[cid] || [];
        let html = `<p style="color:#64748b; font-size:0.85rem; margin-top:0;">é€‰æ‹©ä¸€ä»½ç¤¼ç‰©é€ç»™ ${ch.name}ï¼š</p><div style="display:flex;flex-direction:column;gap:8px;">`;
        gifts.forEach((g, i) => {
            html += `<button class="btn" style="text-align:left; padding:10px 12px;" onclick="giveGift('${cid}',${i})">
                ğŸ ${g.name} <span style="color:#94a3b8; font-size:0.75rem;">ï¿¥${g.cost}</span>
            </button>`;
        });
        html += '</div>';
        showCustomModal(`ğŸ ç»™ ${ch.name} é€ç¤¼ç‰©`, html, [{text:'å–æ¶ˆ', action:()=>{}}]);
    }
    
    function giveGift(cid, giftIdx) {
        let gifts = GIFT_CATALOG[cid];
        let g = gifts[giftIdx];
        if(stuGame.money < g.cost) return showToast("é›¶èŠ±é’±ä¸è¶³ï¼");
        stuGame.money -= g.cost;
        let data = stuGame.crushes[cid];
        data.aff = Math.max(0, Math.min(100, data.aff + g.effect));
        showToast(g.effect > 0 ? `ğŸ’ ${CRUSHES.find(x=>x.id===cid).name} ä¼¼ä¹å¾ˆå–œæ¬¢è¿™ä»½ç¤¼ç‰©` : `ğŸ’” è¿™ä»½ç¤¼ç‰©å¥½åƒæ²¡é€åˆ°å¿ƒåé‡Œâ€¦â€¦`);
        let dBox = document.getElementById(`dialog-${cid}`);
        if(dBox) { dBox.style.display='block'; dBox.innerText = g.reply; }
        checkCrushBuff(cid);
        renderStuCrushes();
        updateStuUI();
    }
    
    function checkCrushBuff(cid) {
        let data = stuGame.crushes[cid];
        if(data && data.aff >= 30) {
            let b = getCrushBuff(cid, data.aff);
            if(b) b.apply();
        }
    }
    function renderStuFriends() {
        let c = document.getElementById('stu-friends-container');
        c.innerHTML = FRIENDS.map(f => {
            let has = stuGame.friends.includes(f.id);
            return `<div class="friend-card ${has?'active':''}">
                <div><b>${f.name}</b><br><span style="font-size:0.75rem">${f.desc}</span></div>
                ${has?'<span style="color:var(--success);font-weight:bold;">å·²ç»“äº¤</span>':`<button class="btn" style="margin:0;padding:4px;" onclick="buyFriend('${f.id}',${f.cost})">ç»“äº¤ ï¿¥${f.cost}</button>`}
            </div>`;
        }).join('');
    }
    function buyFriend(id, cost) {
        if(stuGame.money >= cost) {
            stuGame.money -= cost;
            stuGame.friends.push(id);
            renderStuFriends();
            updateStuUI();
        } else showToast("é›¶èŠ±é’±ä¸è¶³");
    }

    function organizeExam() { 
        if(!payCost(3,2)) return;
        game.eduPoints += 3;
        
        let total = game.students;
        let baseScore = game.grade * 6 + 150; 
        
        let t_qb = Math.floor(total * (baseScore > 680 ? (baseScore-680)/400 : 0)); 
        let t_985 = Math.floor(total * (baseScore > 600 ? (baseScore-600)/350 : 0)); 
        let t_211 = Math.floor(total * (baseScore > 550 ? (baseScore-550)/300 : 0)); 
        let t_bk = Math.floor(total * (baseScore > 450 ? (baseScore-450)/250 : 0)); 
        let t_zk = Math.floor(total * (baseScore > 300 ? (baseScore-300)/200 : 0)); 
        
        t_985 = Math.max(0, t_985 - t_qb);
        t_211 = Math.max(0, t_211 - t_985 - t_qb);
        t_bk = Math.max(0, t_bk - t_211 - t_985 - t_qb);
        t_zk = Math.max(0, t_zk - t_bk - t_211 - t_985 - t_qb);
        let t_fail = Math.max(0, total - t_qb - t_985 - t_211 - t_bk - t_zk);
        
        let upline = total - t_fail;
        let uplinePct = Math.floor(upline/total*100);
        // æ¨¡æ‹Ÿé˜…å·ä¸åŠ å£°èª‰ï¼Œåªç»™æ•™ç ”ç‚¹å’Œæ•°æ®åˆ†æ
        
        let html = `
        <div class="chart-container" style="width:100%;">
            <div class="chart-col"><div class="chart-bar" style="background:#ef4444; height:${Math.max(2, (t_qb/total)*150)}px;">${t_qb}</div><div class="chart-label">æ¸…åŒ—</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#8b5cf6; height:${Math.max(2, (t_985/total)*150)}px;">${t_985}</div><div class="chart-label">985</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#3b82f6; height:${Math.max(2, (t_211/total)*150)}px;">${t_211}</div><div class="chart-label">211</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#10b981; height:${Math.max(2, (t_bk/total)*150)}px;">${t_bk}</div><div class="chart-label">ä¸€æœ¬</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#f59e0b; height:${Math.max(2, (t_zk/total)*150)}px;">${t_zk}</div><div class="chart-label">äºŒæœ¬</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#64748b; height:${Math.max(2, (t_fail/total)*150)}px;">${t_fail}</div><div class="chart-label">è½æ¦œ</div></div>
        </div>
        <p style="text-align:center;">æ•™ç ”ç‚¹ +3 | ä¸Šçº¿ç‡: ${uplinePct}%ï¼ˆæ¨¡æ‹Ÿè€ƒä¸è®¡å…¥å£°èª‰ï¼‰</p>
        `;
        
        showCustomModal("ğŸ“Š å…¨æ ¡æ¨¡æ‹Ÿè€ƒå…­æ¡£åˆ†æ", html, [{text:"ç¡®è®¤å½’æ¡£", action:updateUI}]);
        log(`ä¸¾åŠæ¨¡è€ƒï¼Œæ¸…åŒ— ${t_qb} äººï¼Œä¸€æœ¬ä¸Šçº¿ ${t_bk+t_211+t_985+t_qb} äºº`); 
        updateUI();
    }

    // ================= ç»“å±€è¯„çº§ä¸ç»ˆææ‹·é—® =================
    const RATING_QUOTES = [
        { grade: 'S', name: 'æ•™è‚²æ”¹é©è€…', quote: 'çœŸæ­£çš„æ•™è‚²ï¼Œä¸æ˜¯æŠŠç¯®å­è£…æ»¡ï¼Œè€Œæ˜¯æŠŠç¯ç‚¹äº®ã€‚ä½ åšåˆ°äº†ã€‚', color: '#fbbf24' },
        { grade: 'A', name: 'è‰¯å¸ˆç›Šå‹', quote: 'åˆ†æ•°ä¼šè¢«é—å¿˜ï¼Œä½†ä½ ç»™äºˆå­¦ç”Ÿçš„å‹‡æ°”å’Œå°Šä¸¥ï¼Œå°†ä¼´éšä»–ä»¬ä¸€ç”Ÿã€‚', color: '#60a5fa' },
        { grade: 'B', name: 'åŠ¡å®æ ¡é•¿', quote: 'ä½ åœ¨ä½“åˆ¶ä¸äººæ€§ä¹‹é—´è‰°éš¾å¹³è¡¡ã€‚å†å²ä¼šè®°ä½ï¼Œä½ æ›¾åŠªåŠ›è¿‡ã€‚', color: '#34d399' },
        { grade: 'C', name: 'åˆ†æ•°æœºå™¨', quote: 'é«˜åˆ†æ˜¯ä½ äº¤å‡ºçš„ç­”å·ï¼Œä½†é‚£äº›è¢«æ¦¨å¹²çš„å°‘å¹´ï¼Œè°æ¥ä¸ºä»–ä»¬ç­”å·ï¼Ÿ', color: '#f59e0b' },
        { grade: 'D', name: 'åˆ¶åº¦å¸®å‡¶', quote: 'ä½ ä»¥ä¸ºè‡ªå·±åœ¨é“¸é€ æœªæ¥ï¼Œå´ä¸çŸ¥äº²æ‰‹å»ºèµ·äº†ä¸€åº§ç²¾ç¥çš„å›šç¬¼ã€‚', color: '#ef4444' }
    ];
    
    function getStuRating() {
        let score = stuGame.examScore || 0;
        let stress = stuGame.stress || 0;
        let hasLover = stuGame.lover;
        let friends = stuGame.friends.length;
        let pts = 0;
        if(score >= 680) pts = 90;
        else if(score >= 620) pts = 75;
        else if(score >= 550) pts = 60;
        else if(score >= 450) pts = 45;
        else pts = 25;
        if(hasLover) pts += 10;
        pts += friends * 3;
        if(stuGame.isInsured) pts += 15;
        if(stress >= 90) pts -= 25;
        else if(stress >= 70) pts -= 10;
        const STU_RATINGS = [
            { grade: 'S', name: 'å…¨é¢å‘å±•çš„é’æ˜¥', quote: 'ä½ ç”¨åˆ†æ•°è¯æ˜äº†è‡ªå·±ï¼Œä¹Ÿç”¨æ¸©åº¦ç•™ä½äº†åˆ«äººã€‚è¿™æ ·çš„é«˜ä¸­æ—¶å…‰ï¼Œå€¼å¾—è¢«é“­è®°ã€‚', color: '#fbbf24' },
            { grade: 'A', name: 'æ— æ‚”çš„å°‘å¹´', quote: 'æˆç»©ä¸æ˜¯ä½ å”¯ä¸€çš„å‹‹ç« ã€‚é‚£äº›ç¬‘è¿‡ã€å“­è¿‡ã€çˆ±è¿‡çš„ç¬é—´ï¼Œæ‰æ˜¯çœŸæ­£å±äºä½ çš„è´¢å¯Œã€‚', color: '#60a5fa' },
            { grade: 'B', name: 'æ™®é€šå´çœŸå®', quote: 'ä½ æ²¡æœ‰æˆä¸ºåˆ«äººæœŸå¾…çš„æ ·å­ï¼Œä½†ä½ ä¸€ç›´æ˜¯ä½ è‡ªå·±ã€‚è¿™å·²ç»å¾ˆäº†ä¸èµ·äº†ã€‚', color: '#34d399' },
            { grade: 'C', name: 'è¢«åˆ†æ•°åå™¬çš„ä¸‰å¹´', quote: 'ä½ èµ¢äº†è€ƒè¯•ï¼Œå´è¾“äº†ä¸€äº›æ›´çè´µçš„ä¸œè¥¿ã€‚å¸Œæœ›å¤§å­¦èƒ½ç»™ä½ é‡æ–°è®¤è¯†è‡ªå·±çš„æœºä¼šã€‚', color: '#f59e0b' },
            { grade: 'D', name: 'è¿˜æ²¡å¼€å§‹å°±ç»“æŸäº†', quote: 'ä¸‰å¹´ï¼Œä½ æ‰›ç€æ¯”åŒé¾„äººæ›´é‡çš„ä¸œè¥¿ã€‚æ— è®ºç»“æœå¦‚ä½•ï¼Œä½ æ’‘ä¸‹æ¥äº†ã€‚è¿™å·²ç»æ˜¯è‹±é›„ã€‚', color: '#ef4444' }
        ];
        if(pts >= 85) return STU_RATINGS[0];
        if(pts >= 65) return STU_RATINGS[1];
        if(pts >= 45) return STU_RATINGS[2];
        if(pts >= 25) return STU_RATINGS[3];
        return STU_RATINGS[4];
    }

    // ========== 20+ç§å­¦ç”Ÿç»“å±€ç³»ç»Ÿ ==========
    function getStudentEnding() {
        let score = stuGame.examScore || 0;
        let stress = stuGame.stress || 0;
        let isInsured = stuGame.isInsured;
        let hasLover = stuGame.lover;
        let loverName = stuGame.loverName;
        let friends = stuGame.friends.length;
        let money = stuGame.money || 0;
        // å…³é”®èŠ‚ç‚¹æ ‡è®° (ä»æ¸¸æˆè¿‡ç¨‹ä¸­æ”¶é›†)
        let flags = stuGame.endingFlags || {};
        
        // ä¼˜å…ˆçº§æœ€é«˜çš„ç‰¹æ®Šç»“å±€
        if(isInsured) return {
            id:'E_OLYMPIAD', icon:'ğŸ…', name:'ç«èµ›ä¿é€ä¹‹è·¯',
            title:'å¥¥èµ›ä¿é€ï¼Œç›´è¾¾æ¸…åŒ—',
            desc:`ä½ åœ¨ç«èµ›ä¸­å±•ç°äº†è¶…è¶Šå¸¸äººçš„å¤©èµ‹ï¼Œç»•è¿‡äº†é«˜è€ƒè¿™æ¡ç‹¬æœ¨æ¡¥ï¼Œç›´æ¥è¢«æ¸…åå¤§å­¦å½•å–ã€‚
ç«™åœ¨æ¸…åå›­é‡Œï¼Œä½ æ„è¯†åˆ°ï¼šçœŸæ­£è®©ä½ èµ°åˆ°è¿™é‡Œçš„ï¼Œä¸æ˜¯é‚£äº›åšäº†æ— æ•°éçš„çœŸé¢˜ï¼Œè€Œæ˜¯é‚£ä¸ªå‡Œæ™¨ä¸¤ç‚¹ä»åœ¨æ”»å…‹éš¾é¢˜ã€çœ¼ç›å‘äº®çš„è‡ªå·±ã€‚`,
            color:'#fbbf24', emoji:'ğŸ“'
        };
        if(stress >= 95 && score < 400) return {
            id:'E_BREAKDOWN', icon:'ğŸ’”', name:'è¢«å‹å®çš„å°‘å¹´',
            title:'é«˜è€ƒå‰å¤•çš„å´©æºƒ',
            desc:`é«˜è€ƒå‰ä¸‰å¤©ï¼Œä½ è¯·äº†ç—…å‡ã€‚ä¸æ˜¯èº«ä½“ï¼Œæ˜¯å¿ƒã€‚åŒ»ç”Ÿè¯´ä½ æ˜¯é‡åº¦ç„¦è™‘ï¼Œéœ€è¦ä¼‘æ¯ã€‚
ä½ æ²¡æœ‰å‚åŠ é«˜è€ƒã€‚è¿™åœ¨å½“æ—¶åƒä¸€åœºåœ°éœ‡ï¼Œä½†äº”å¹´åï¼Œå½“ä½ åœ¨ä¸€å®¶å’–å•¡é¦†é‡Œåšç€è‡ªå·±å–œæ¬¢çš„äº‹ï¼Œä½ æœ‰æ—¶ä¼šæƒ³ï¼šä¹Ÿè®¸é‚£æ¬¡å´©æºƒï¼Œæ‰æ˜¯çœŸæ­£çš„æ‹¯æ•‘ã€‚`,
            color:'#6366f1', emoji:'ğŸŒ±'
        };
        if(flags.dropout) return {
            id:'E_DROPOUT', icon:'ğŸ’', name:'ä¸­é€”é€€å­¦',
            title:'æˆ‘é€‰æ‹©äº†å¦ä¸€æ¡è·¯',
            desc:`ä½ åœ¨é«˜äºŒé€€äº†å­¦ã€‚æ‰€æœ‰äººéƒ½è¯´ä½ ç–¯äº†ï¼Œä½ å¦ˆå“­äº†ä¸‰å¤©ã€‚
ä¸‰å¹´åï¼Œä½ çš„æ‰‹å·¥çš®å…·å“ç‰Œåœ¨ç½‘ä¸Šçˆ†çº¢ï¼Œæœˆè¥ä¸šé¢è¶…è¿‡äº†ç­ä¸Šå¤§å¤šæ•°åŒå­¦çš„å·¥èµ„ã€‚ä½ ä¸çŸ¥é“è¿™ç®—ä¸ç®—æˆåŠŸï¼Œä½†ä½ çŸ¥é“ï¼Œé‚£å¤©è¿ˆå‡ºæ ¡é—¨çš„è‡ªå·±ï¼Œæ¯”ä»»ä½•æ—¶å€™éƒ½è¯šå®ã€‚`,
            color:'#f59e0b', emoji:'âœ‚ï¸'
        };
        if(hasLover && score < 450) return {
            id:'E_EARLY_LOVE', icon:'ğŸ’•', name:'çˆ±æƒ…ï¼Œæ¯”æˆç»©æ›´é‡',
            title:'åˆ†æ•°ä¸é«˜ï¼Œä½†å¿ƒé‡Œæœ‰äºº',
            desc:`ä½ æ²¡è€ƒä¸Šä»€ä¹ˆå¥½å¤§å­¦ï¼Œä½†ä½ å’Œ${loverName}åœ¨åŒä¸€åº§åŸå¸‚ï¼Œè¯»ç€ä¸åŒçš„å­¦æ ¡ã€‚
å‘¨æœ«çš„æ—¶å€™ä½ ä»¬éª‘ç€å•è½¦å»åƒè·¯è¾¹æ‘Šï¼Œå¥¹/ä»–è¯´è¿™æ¯”ä¸Šæ¸…åæ›´å¹¸ç¦ã€‚ä¹Ÿè®¸å§ã€‚ä½†ä½ ç§ä¸‹é‡Œï¼Œä»ç„¶åœ¨å­¦ä¸€é—¨æŠ€èƒ½â€”â€”ä¸æ˜¯ä¸ºäº†è¯æ˜ä»€ä¹ˆï¼Œåªæ˜¯ä¸æƒ³è®©å¥¹/ä»–çš„å°†æ¥ï¼Œå› ä¸ºä½ è€Œå˜çª„ã€‚`,
            color:'#f472b6', emoji:'ğŸ’•'
        };
        if(flags.workToStudy && money >= 2000) return {
            id:'E_WORKER', icon:'ğŸ”§', name:'æ‰“å·¥ä»”çš„é€†è¢­',
            title:'ä¸€è¾¹æ‰“å·¥ï¼Œä¸€è¾¹è¯»ä¹¦',
            desc:`ä½ é«˜ä¸­ä¸‰å¹´éƒ½åœ¨æ‰“å·¥è¡¥è´´å®¶ç”¨ã€‚æˆç»©ä¸ç®—é¡¶å°–ï¼Œä½†ä½ çš„è‡ªå¾‹å’Œåƒè‹¦ç²¾ç¥è®©ä½ åœ¨å¤§å­¦ä¸€æ¯•ä¸šå°±å‡äº†ç»„é•¿ã€‚
ä¸‰åå²çš„ä½ ç®¡ç€äºŒåä¸ªäººï¼Œä½ å¯¹ä»–ä»¬è¯´ï¼šæˆ‘æ²¡ä¸Šè¿‡985ï¼Œä½†æˆ‘ä¸Šè¿‡æ¯”985æ›´éš¾çš„å­¦æ ¡â€”â€”ç”Ÿæ´»ã€‚`,
            color:'#10b981', emoji:'ğŸ’ª'
        };
        if(score >= 680) return {
            id:'E_ELITE', icon:'ğŸ“', name:'æ¸…åŒ—ä¹‹è·¯',
            title:'é¡¶å°–åæ ¡ï¼Œè£è€€ä¸ä»£ä»·',
            desc:`ä½ å¦‚æ„¿è€ƒä¸Šäº†é¡¶å°–åæ ¡ã€‚å¼€å­¦ç¬¬ä¸€å¤©ç«™åœ¨æœªåæ¹–è¾¹ï¼Œä½ è§‰å¾—ä¸‰å¹´çš„è¾›è‹¦å€¼äº†ã€‚
ä½†å¤§äºŒçš„æŸä¸ªæ·±å¤œï¼Œä½ å¯¹ç€å¤©èŠ±æ¿æƒ³ï¼šæˆ‘å–œæ¬¢ä»€ä¹ˆï¼Ÿæˆ‘ä¸ºä»€ä¹ˆåœ¨è¿™é‡Œï¼Ÿé‚£ä¸ªé—®é¢˜æ‚¬åœ¨ç©ºä¸­ï¼Œè‡³ä»Šæ²¡æœ‰ç­”æ¡ˆã€‚
æˆåŠŸæœ‰æ—¶å€™æ˜¯ä¸€ä¸ªæ¼‚äº®çš„ç‰¢ç¬¼â€”â€”ä½†è‡³å°‘ï¼Œæ˜¯ä½ è‡ªå·±é€‰çš„ã€‚`,
            color:'#ef4444', emoji:'ğŸ›ï¸'
        };
        if(score >= 600 && friends >= 3) return {
            id:'E_985_SOCIAL', icon:'ğŸ¤', name:'985+äººç”Ÿèµ¢å®¶',
            title:'æˆç»©ä¸å‹æƒ…ï¼Œéƒ½æ²¡è½ä¸‹',
            desc:`985é«˜æ ¡ï¼ŒåŠ ä¸Šä¸‰ä¸ªçœŸæ­£çš„æœ‹å‹ã€‚ä½ å¤§å­¦å››å¹´æœ€å¸¸è¢«é—®çš„é—®é¢˜æ˜¯ï¼šä½ å½“å¹´é«˜ä¸­æ˜¯æ€ä¹ˆè¿‡çš„ï¼Ÿ
ä½ æƒ³äº†æƒ³ï¼Œè¯´ï¼šæŒºå¥½çš„ï¼Œæœ‰äººé™ªã€‚é‚£æ˜¯å®è¯ã€‚`,
            color:'#3b82f6', emoji:'ğŸ‘¥'
        };
        if(score >= 550) return {
            id:'E_211', icon:'ğŸ“š', name:'211æœ¬ç§‘ï¼Œç¨³æ‰ç¨³æ‰“',
            title:'ä¸ç®—é¡¶å°–ï¼Œä½†å¤Ÿç”¨ä¸€ç”Ÿ',
            desc:`211å¤§å­¦ï¼Œä¸­ç­‰æˆç»©ï¼Œæ™®é€šä½†è¸å®çš„é’æ˜¥ã€‚
ä½ æ²¡æœ‰æˆä¸ºä¼ è¯´ï¼Œä½†ä½ æœ‰äº†ä¸€ä»½ç¨³å®šçš„å·¥ä½œï¼Œå…»äº†ä¸€åªçŒ«ï¼Œæ¯é€¢å‡æœŸå›åˆ°è¿™åº§åŸå¸‚ï¼Œç«™åœ¨å­¦æ ¡é—¨å£ï¼Œä½ ä¼šæƒ³ï¼šä¸‰å¹´ï¼Œä¹ŸæŒºå¥½çš„ã€‚`,
            color:'#8b5cf6', emoji:'ğŸ¯'
        };
        if(score >= 450) return {
            id:'E_REEXAM', icon:'ğŸ”„', name:'å¤è¯»ä¸€å¹´ï¼Œé‡æ–°å‡ºå‘',
            title:'å†æ¥ä¸€å¹´ï¼Œæˆ‘ä¸ç”˜å¿ƒ',
            desc:`ä¸€æœ¬çº¿å·®äº†ä¸€ç‚¹ã€‚ä½ é€‰æ‹©äº†å¤è¯»ã€‚é‚£ä¸€å¹´æ˜¯ä½ äººç”Ÿé‡Œæœ€å­¤ç‹¬çš„ä¸€å¹´â€”â€”åŒå­¦éƒ½èµ°äº†ï¼Œä½ ä¸€ä¸ªäººååœ¨æ•™å®¤é‡Œã€‚
ç¬¬äºŒå¹´ï¼Œä½ è€ƒä¸Šäº†æ»¡æ„çš„å­¦æ ¡ã€‚ä½†è®©ä½ çœŸæ­£æˆé•¿çš„ï¼Œæ˜¯å¤è¯»é‚£ä¸€å¹´çš„æ²‰é»˜ä¸åšæŒã€‚`,
            color:'#f59e0b', emoji:'ğŸŒ…'
        };
        if(score >= 300) return {
            id:'E_ORDINARY', icon:'ğŸŒ±', name:'æ™®é€šï¼Œä¹Ÿæ˜¯ä¸€ç§ç­”æ¡ˆ',
            title:'äºŒæœ¬ç”Ÿçš„å¹³é™äººç”Ÿ',
            desc:`äºŒæœ¬ï¼Œä¸æ˜¯ç†æƒ³ä¸­çš„ç»“æœã€‚åˆšå¼€å§‹ä½ æœ‰äº›æ²®ä¸§ï¼Œä½†æ…¢æ…¢åœ°ï¼Œä½ å‘ç°å¤§å­¦é‡Œæœ‰å¾ˆå¤šäººå’Œä½ ä¸€æ ·â€”â€”åŠªåŠ›è¿‡ã€æ²¡è¾¾åˆ°ï¼Œä½†ç…§æ ·åœ¨æ´»ç€ã€‚
åå¹´åï¼Œä½ ç»è¥ç€ä¸€å®¶å°åº—ï¼Œé¡¾å®¢éƒ½æ˜¯å›å¤´å®¢ã€‚ä½ ä¸çº¢ï¼Œä½†æ‰å®ã€‚`,
            color:'#64748b', emoji:'â˜•'
        };
        if(stress >= 80 && score >= 600) return {
            id:'E_HOLLOW', icon:'ğŸª†', name:'ç©ºå¿ƒä¼˜ç­‰ç”Ÿ',
            title:'è€ƒä¸Šäº†ï¼Œä½†ä»€ä¹ˆéƒ½æ²¡äº†',
            desc:`ä½ è€ƒä¸Šäº†å¥½å¤§å­¦ï¼Œä½†è¿›æ ¡å›­çš„ç¬¬ä¸€å­¦æœŸä½ å°±é€€å‡ºäº†æ‰€æœ‰ç¤¾å›¢ã€‚ä½ æ„Ÿåˆ°ä¸€ç§å¥‡ç‰¹çš„ç©ºæ´ã€‚
å¿ƒç†å’¨è¯¢å¸ˆè¯´è¿™å«"ç©ºå¿ƒç—…"â€”â€”ä¸ºäº†ç›®æ ‡æ´»äº†åå…«å¹´ï¼Œç›®æ ‡å®ç°äº†ï¼Œè‡ªå·±å´ä¸è§äº†ã€‚
ä½ åœ¨æ…¢æ…¢æ‰¾å›æ¥ã€‚`,
            color:'#94a3b8', emoji:'ğŸ”'
        };
        if(friends >= 4 && score < 500) return {
            id:'E_FRIENDSHIP', icon:'ğŸ­', name:'äººæ¯”åˆ†æ•°é‡è¦',
            title:'æˆç»©ä¸€èˆ¬ï¼Œä½†äº¤åˆ°äº†ä¸€ç”Ÿçš„æœ‹å‹',
            desc:`ä½ æ²¡è€ƒä¸Šä»€ä¹ˆå¥½å­¦æ ¡ï¼Œä½†é«˜ä¸­ä¸‰å¹´ä½ äº¤åˆ°äº†å››ä¸ªçœŸæ­£çš„æœ‹å‹ã€‚æ¯•ä¸šåå¹´ï¼Œä½ ä»¬è¿˜æ˜¯æ¯å¹´èšä¸€æ¬¡ã€‚
æœ‰ä¸€æ¬¡å–é…’ï¼Œæœ‰äººè¯´ï¼šæˆ‘å®æ„¿è¦é‚£æ®µæ—¶å…‰ï¼Œä¸è¦é‚£å¼ æ–‡å‡­ã€‚ä½ ä»¬éƒ½æ²‰é»˜äº†ä¸€ä¸‹ï¼Œç„¶åå“ˆå“ˆå¤§ç¬‘ã€‚`,
            color:'#fb923c', emoji:'ğŸ»'
        };
        // é»˜è®¤ç»“å±€
        return {
            id:'E_DEFAULT', icon:'ğŸš¶', name:'æ™®é€šçš„ï¼ŒçœŸå®çš„äººç”Ÿ',
            title:'æ²¡æœ‰ä¼ å¥‡ï¼Œä½†æœ‰è‡ªå·±',
            desc:`æ²¡æœ‰æˆå‰§æ€§çš„åè½¬ï¼Œä¹Ÿæ²¡æœ‰é«˜å…‰æ—¶åˆ»ã€‚ä½ è€ƒäº†ä¸€ä¸ªè¯´å¾—è¿‡å»çš„åˆ†æ•°ï¼Œå»äº†ä¸€æ‰€è¯´å¾—è¿‡å»çš„å­¦æ ¡ï¼Œè¿‡ç€è¯´å¾—è¿‡å»çš„ç”Ÿæ´»ã€‚
ä½†æœ‰ä¸€å¤©ä½ å‘ç°ï¼Œé‚£äº›ä½ ä»¥ä¸º"è¯´å¾—è¿‡å»"çš„äº‹ï¼Œéƒ½æ˜¯ä½ ä¸€ç‚¹ä¸€ç‚¹é€‰å‡ºæ¥çš„ã€‚
è¿™å°±æ˜¯ä½ çš„äººç”Ÿã€‚æ²¡æœ‰åˆ«äººçš„ï¼Œåªæœ‰ä½ çš„ã€‚`,
            color:'#475569', emoji:'ğŸŒ'
        };
    }
    
    function showFinalRating(mode) {
        let rating = mode === 'student' ? getStuRating() : getGameRating();
        let html = `<div style="text-align:center;">
            <div style="font-size:5rem; font-weight:900; color:${rating.color}; text-shadow: 0 0 20px ${rating.color};">${rating.grade}</div>
            <h2 style="color:${rating.color}; margin:5px 0;">${rating.name}</h2>
            <p style="font-size:1.05rem; color:#475569; font-style:italic; margin:15px 0; line-height:1.7; padding:15px; background:#f8fafc; border-left:4px solid ${rating.color}; text-align:left; border-radius:0 8px 8px 0;">"${rating.quote}"</p>`;
        
        if(mode === 'student') {
            let ending, stuScore;
            try {
                ending = getStudentEnding();
                stuScore = stuGame.examScore || 0;
            } catch(e) {
                ending = { name:'ç»“å±€åŠ è½½å¤±è´¥', desc:'æ•°æ®å¼‚å¸¸ï¼Œè¯·é‡è¯•ã€‚', color:'#94a3b8', emoji:'âš ï¸' };
                stuScore = 0;
            }
            let stuLabel = stuScore>=680?'æ¸…åŒ—å½•å– ğŸ‰':stuScore>=600?'985å½•å–':stuScore>=550?'211å½•å–':stuScore>=450?'ä¸€æœ¬å½•å–':stuScore>=300?'äºŒæœ¬å½•å–':'æœªèƒ½å½•å–';
            
            // ç»“å±€å¡ç‰‡
            html += `<div style="background:linear-gradient(135deg,${ending.color}22,${ending.color}11);border:2px solid ${ending.color};border-radius:12px;padding:18px;margin-bottom:15px;text-align:left;">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                    <span style="font-size:2.5rem;">${ending.emoji}</span>
                    <div>
                        <div style="font-size:0.7rem;color:${ending.color};font-weight:bold;letter-spacing:2px;">YOUR ENDING</div>
                        <div style="font-size:1.2rem;font-weight:900;color:#1e293b;">${ending.name}</div>
                    </div>
                </div>
                <p style="color:#374151;font-size:0.88rem;line-height:1.8;white-space:pre-line;margin:0;">${ending.desc}</p>
            </div>`;
            
            // å­¦ç”Ÿæˆç»©æ‘˜è¦
            html += `<div style="background:#f8fafc;border-radius:8px;padding:12px;text-align:left;font-size:0.85rem;margin-bottom:12px;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">
                    <div>ğŸ“Š é«˜è€ƒï¼š<b style="color:var(--primary);">${stuScore}åˆ†</b> (${stuLabel})</div>
                    <div>ğŸ˜° æœ€ç»ˆå‹åŠ›ï¼š${Math.floor(stuGame.stress)}</div>
                    <div>ğŸ’• ${stuGame.lover?'ğŸ’˜ ä¸'+stuGame.loverName+'åœ¨ä¸€èµ·':'ğŸ’” å•èº«ç‹—'}</div>
                    <div>ğŸ‘« æ­»å…šï¼š${stuGame.friends.length}äºº</div>
                    <div>ğŸ… å¥¥èµ›ä¿é€ï¼š${stuGame.isInsured?'âœ… æ˜¯':'âŒ å¦'}</div>
                    <div>ğŸ’° å‰©ä½™ï¼šï¿¥${stuGame.money}</div>
                </div>
            </div>`;
            
            // åŒå­¦ä»¬çš„åå¹´å
            html += `<h3 style="margin:10px 0 8px;color:#1e293b;text-align:left;font-size:1rem;">ğŸ”® ä½ çš„åŒå­¦ä»¬ï¼Œåå¹´åâ€¦â€¦</h3><div style="display:flex;flex-direction:column;gap:8px;">`;
            const FUTURES = {
                'lin':{
                    high:'æ—çŸ¥ç§‹è€ƒä¸Šäº†æ¸…åï¼Œæˆäº†ä¸€ä½åŠ©ç†æ•™æˆã€‚ä½†å¥¹æœ€è¿‘åœ¨å†™ä¸€ç¯‡è®ºæ–‡ï¼Œé¢˜ç›®å«ã€Šä¸­å›½é«˜ä¸­ç”Ÿçš„å¿ƒç†åˆ›ä¼¤ä¸è®¤çŸ¥æ¨¡å¼ã€‹â€”â€”å¥¹ç ”ç©¶çš„ï¼Œæ­£æ˜¯å¥¹è‡ªå·±ã€‚',
                    mid:'æ—çŸ¥ç§‹è€ƒä¸Šäº†985ï¼Œæ¯•ä¸šååšäº†ä¸€åé«˜ä¸­æ•°å­¦è€å¸ˆã€‚å¥¹ç»™å­¦ç”Ÿå¸ƒç½®çš„ä½œä¸šæ¯”åŒäº‹å°‘ä¸€åŠï¼Œå¥¹è¯´ï¼šå¤Ÿäº†å°±å¤Ÿäº†ã€‚',
                    low:'æ—çŸ¥ç§‹æ²¡æœ‰è€ƒä¸Šæ¸…åã€‚å¥¹è¾—è½¬è¯»äº†ä¸€æ‰€æ™®é€šé™¢æ ¡ï¼Œæ¯•ä¸šåå»äº†ä¸€å®¶å‡ºç‰ˆç¤¾åšç¼–è¾‘ã€‚å¥¹ç»ˆäºå¼€å§‹è®©äººçœ‹å¥¹å†™çš„è¯—äº†ã€‚'
                },
                'xia':{
                    high:'å¤æ™šæ™´çš„ç”»ä½œåœ¨ç±³å…°ä¸€ä¸ªå°ç”»å»Šå±•å‡ºï¼Œå…¥åœºè´¹äº”æ¬§å…ƒã€‚å¥¹è¯´é‚£æ˜¯å¥¹äººç”Ÿæœ€å¥½çš„ä¸€å¤©ã€‚',
                    mid:'å¤æ™šæ™´åœ¨ä¸€å®¶å¹¿å‘Šå…¬å¸åšè®¾è®¡ï¼Œå¶å°”æ¥è‡ªå·±çš„ç§æ´»å„¿ã€‚å¥¹æŠŠå®¢å…ä¸€é¢å¢™æ¶‚æˆäº†é»‘è‰²ï¼Œè¯´é‚£æ˜¯å¥¹çš„å®‡å®™ã€‚',
                    low:'å¤æ™šæ™´é«˜ä¸­æ²¡è¯»å®Œå°±è¾å­¦äº†ã€‚ç°åœ¨åœ¨ç½‘ä¸Šå–æ‰‹ç»˜ï¼Œæœˆå…¥ä¸‰åƒï¼Œå…»æ´»è‡ªå·±ã€‚å¥¹è¯´ï¼šè¿˜ä¸é”™ã€‚'
                },
                'jiang':{
                    high:'æ±Ÿä¸€èˆŸè¿›äº†çœé˜Ÿï¼Œæ²¡è¿›å›½å®¶é˜Ÿï¼Œä½†å½“ä¸Šäº†ä¸€æ‰€ä¸­å­¦çš„ä½“è‚²è€å¸ˆã€‚ä»–å¸¦çš„ç¯®çƒé˜Ÿè¿ç»­ä¸‰å¹´æ‹¿äº†å¸‚å† å†›ã€‚',
                    mid:'æ±Ÿä¸€èˆŸå¤§å­¦æ‰“äº†å››å¹´æ ¡é˜Ÿï¼Œæ¯•ä¸šååšäº†é”€å”®ã€‚å³æ‰‹åœ¨å˜å¤©æ—¶è¿˜ä¼šç–¼ï¼Œä½†ä»–ä¸æã€‚ä»–è¯´é‚£æ˜¯ä»–çš„å‹‹ç« ã€‚',
                    low:'æ±Ÿä¸€èˆŸé«˜ä¸‰æ²¡æ‰“æˆçƒï¼Œè¯»äº†ä¸ªå¤§ä¸“ï¼Œæ¯•ä¸šåå¼€äº†ä¸ªå°åº—å–è¿åŠ¨å™¨æã€‚æ¯å‘¨æ—¥ä¸‹åˆä»–è¿˜æ˜¯ä¼šå»çƒåœºï¼Œå’Œä¸€ç¾¤å”å”ä»¬æ‰“åŠåœºã€‚'
                },
                'shen':{
                    high:'æ²ˆæ¸”çš„ä¹é˜Ÿåœ¨åœ°ä¸‹éŸ³ä¹åœˆæœ‰äº†ä¸€äº›åæ°”ï¼Œå‡ºäº†ä¸€å¼ EPã€‚å¥¹åœ¨æœ€åä¸€é¦–æ­Œçš„å¤‡æ³¨é‡Œå†™ï¼šçŒ®ç»™é‚£ä¸ªæˆ‘ä»¥ä¸ºä¸é‡è¦çš„è‡ªå·±ã€‚',
                    mid:'æ²ˆæ¸”é«˜ä¸­æ¯•ä¸šåå»äº†å¤§åŸå¸‚ï¼Œç™½å¤©ä¸Šç­ï¼Œæ™šä¸Šåœ¨é…’å§é©»å”±ã€‚å¼Ÿå¼Ÿå·²ç»ä¸Šå¤§å­¦äº†ï¼Œå¥¹è§‰å¾—è‡ªå·±å¯ä»¥å¼€å§‹ä¸ºè‡ªå·±æ´»äº†ã€‚',
                    low:'æ²ˆæ¸”æ²¡èƒ½æ’‘å®Œé«˜ä¸­å°±èµ°äº†ã€‚å¥¹å»äº†å—æ–¹çš„ä¸€ä¸ªå·¥å‚ï¼Œå·¥ä½œå¾ˆç´¯ï¼Œä½†èµšäº†é’±ã€‚å¼Ÿå¼Ÿè€ƒä¸Šäº†å¤§å­¦ï¼Œå¥¹åœ¨è§†é¢‘é‡Œå“­äº†ã€‚å¥¹è¯´ï¼šå¤Ÿäº†ã€‚'
                }
            };
            CRUSHES.forEach(ch => {
                let data = stuGame.crushes[ch.id];
                let aff = data ? data.aff : 0;
                let f = FUTURES[ch.id];
                let story = aff >= 70 ? f.high : aff >= 35 ? f.mid : f.low;
                let borderColor = aff >= 70 ? '#f472b6' : aff >= 35 ? '#60a5fa' : '#94a3b8';
                html += `<div style="background:#f8fafc;padding:10px;border-radius:8px;border-left:3px solid ${borderColor};text-align:left;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <b style="color:#1e293b;font-size:0.9rem;">${ch.name}</b>
                        <span style="font-size:0.7rem;color:${borderColor};">å¥½æ„Ÿåº¦ ${Math.floor(aff)}</span>
                    </div>
                    <p style="margin:4px 0 0;font-size:0.8rem;color:#475569;font-style:italic;">${story}</p>
                </div>`;
            });
            html += '</div>';
        } else {
            // æ ¡é•¿æ¨¡å¼ï¼šè§¦å‘"åå¹´åçš„æ ¡å‹å›è®¿"
            let alumni;
            try { alumni = generateAlumniVisit(); } catch(e) { alumni = []; }
            html += `<div style="background:#f8fafc;padding:15px;border-radius:8px;margin-top:10px;text-align:left;">
                <h4 style="margin:0 0 10px;color:#1e293b;">ğŸ« å­¦æ ¡å»ºè®¾æˆæœ</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.88rem;">
                    <div>â­ æœ€ç»ˆå£°èª‰ï¼š${Math.floor(game.reputation)}</div>
                    <div>ğŸ’° èµ„é‡‘ï¼š${Math.floor(game.funds)}ä¸‡</div>
                    <div>ğŸ“š å­¦ä¸šï¼š${Math.floor(game.grade)}</div>
                    <div>ğŸ“ é«˜è€ƒå±Šæ•°ï¼š${game.gaokaoHistory.length}</div>
                    <div>ğŸ† è”è€ƒç§¯åˆ†ï¼š${game.examPoints}</div>
                    <div>ğŸ—“ï¸ åŠå­¦ï¼š${game.year - 2018}å¹´</div>
                </div>
            </div>
            <h4 style="margin:15px 0 8px;color:#1e293b;">ğŸ‘¤ æ ¡å‹å›è®¿æ—¥ Â· åå¹´åä»–ä»¬è¯´â€¦â€¦</h4>
            <div style="display:flex;flex-direction:column;gap:8px;">
                ${alumni.length ? alumni.map(a=>`<div style="background:${a.bg};padding:10px;border-radius:8px;border-left:3px solid ${a.color};text-align:left;">
                    <div style="font-size:0.75rem;color:${a.color};font-weight:bold;">${a.tag} Â· ${a.type}</div>
                    <p style="margin:4px 0 0;font-size:0.82rem;color:#374151;font-style:italic;">"${a.quote}"</p>
                </div>`).join('') : '<p style="color:#94a3b8;">ç»§ç»­åŠå­¦ï¼Œä¼šæœ‰æ›´å¤šæ ¡å‹å›æ¥â€¦â€¦</p>'}
            </div>`;
        }
        html += '</div>';
        showCustomModal(`${mode==='student'?'ğŸ‘¨â€ğŸ“ å­¦ç”Ÿç”Ÿæ¶¯':'ğŸ« æ ¡é•¿ç”Ÿæ¶¯'} Â· ç»“å±€è¯„ä»·`, html, [{text:'é“­è®°äºå¿ƒ', action:()=>{ showEndPoem(); }}]);
    }

    function generateAlumniVisit() {
        let rep = game.reputation;
        let stress = game.stress;
        let grade = game.grade;
        let alumni = [];
        
        if(grade >= 80 && stress >= 80) alumni.push({
            tag:'æ¸…åæ¯•ä¸šç”Ÿ', type:'é«˜åˆ†å­¦ç”ŸÂ·åå¹´å', color:'#ef4444', bg:'#fef2f2',
            quote:`æ ¡é•¿ï¼Œæˆ‘å¦‚æ‚¨æ‰€æ„¿è€ƒä¸Šäº†æ¸…åã€‚ç°åœ¨æ˜¯æŸäº’è”ç½‘å…¬å¸çš„P8ã€‚ä½†æˆ‘æƒ³é—®æ‚¨ä¸€ä¸ªé—®é¢˜ï¼šå½“å¹´é‚£é“æœˆè€ƒçš„æœ€åä¸€é¢˜ï¼Œæ‚¨çœŸçš„è§‰å¾—æ¯”æˆ‘ä»¬çš„ç¡çœ æ›´é‡è¦å—ï¼Ÿ`
        });
        if(grade >= 60 && stress < 60) alumni.push({
            tag:'985æ¯•ä¸šç”Ÿ', type:'æ™®é€šå­¦ç”ŸÂ·åå¹´å', color:'#60a5fa', bg:'#eff6ff',
            quote:`é‚£æ—¶å€™å­¦æ ¡å‹åŠ›ä¸ç®—å¤ªå¤§ï¼Œæˆ‘è¯»äº†985ï¼Œç°åœ¨åœ¨ä¸€å®¶ç ”ç©¶æ‰€åšç§‘ç ”ã€‚æˆ‘å¸¸å¸¸åº†å¹¸ï¼šå½“å¹´é‚£ä¸ªæ ¡é•¿ï¼Œè¿˜è®°å¾—æˆ‘ä»¬æ˜¯äººã€‚`
        });
        if(stress >= 90) alumni.push({
            tag:'åŒ¿åæ ¡å‹', type:'ä¸­é€”é€€å­¦è€…Â·åå¹´å', color:'#94a3b8', bg:'#f8fafc',
            quote:`æˆ‘æ²¡æœ‰æ¯•ä¸šã€‚å‹åŠ›å¤ªå¤§ï¼Œæˆ‘èµ°äº†ã€‚æˆ‘ç°åœ¨è¿˜å¥½ï¼Œä½†æˆ‘ä¸ä¼šå›é‚£æ‰€å­¦æ ¡çš„â€”â€”ä¸æ˜¯å› ä¸ºæ¨ï¼Œæ˜¯å› ä¸ºæ€•ã€‚`
        });
        if(rep < 200) alumni.push({
            tag:'å®¶é•¿ä»£è¡¨', type:'å½“å¹´è´¨ç–‘è€…', color:'#f59e0b', bg:'#fffbeb',
            quote:`æˆ‘å½“å¹´å°±è¯´é‚£æ‰€å­¦æ ¡ä¸é è°±ã€‚ç°åœ¨å­©å­å»äº†å¦ä¸€æ‰€ï¼Œè€ƒå¾—è¿˜è¡Œã€‚æ‚¨çŸ¥é“å—ï¼Œå£°èª‰è¿™ç§ä¸œè¥¿ï¼Œå­©å­ä»¬æ¯”å¤§äººæ›´èƒ½æ„Ÿå—åˆ°ã€‚`
        });
        alumni.push({
            tag:'é—®é¢˜å­¦ç”Ÿ', type:'å½“å¹´çš„åˆºå„¿å¤´', color:'#10b981', bg:'#f0fdf4',
            quote:`æ‚¨å¯èƒ½ä¸è®°å¾—æˆ‘äº†ï¼Œæˆ‘å½“å¹´è€é—¯ç¥¸ã€‚æˆ‘ç°åœ¨å¼€äº†ä¸ªå°å…¬å¸ï¼Œä¸‰åä¸ªå‘˜å·¥ã€‚æˆ‘æ‹›äººåªçœ‹ä¸€ä»¶äº‹ï¼šè¿™ä¸ªäººæœ‰æ²¡æœ‰è‡ªå·±çš„æƒ³æ³•ã€‚`
        });
        if(game.gaokaoHistory.length >= 5) alumni.push({
            tag:'ä¹¡æ‘æ•™å¸ˆ', type:'æ™®é€šæ¯•ä¸šç”Ÿ', color:'#8b5cf6', bg:'#faf5ff',
            quote:`æˆ‘æ²¡è€ƒä¸Šä»€ä¹ˆå¥½å­¦æ ¡ï¼Œç°åœ¨åœ¨åè¿œå±±åŒºæ•™å°å­¦ã€‚è¿™é‡Œæ²¡äººçŸ¥é“985æ˜¯ä»€ä¹ˆï¼Œä½†å­©å­ä»¬çŸ¥é“ï¼šæœ‰äººåœ¨ä¹ä»–ä»¬ã€‚æˆ‘æƒ³ï¼Œè¿™å°±å¤Ÿäº†ã€‚`
        });
        return alumni.slice(0, 4);
    }

    function getGameRating() {
        let score = 0;
        score += Math.min(40, game.reputation / 250 * 40);   // rep 10000 æ»¡åˆ†
        score += Math.min(20, game.grade / 100 * 20);        // grade 0-100 æ»¡åˆ†
        score += Math.min(10, (100 - game.stress) / 100 * 10);
        score += Math.min(10, game.discipline / 100 * 10);
        score += Math.min(10, game.fitness / 100 * 10);
        score += Math.min(10, game.art / 100 * 10);
        if(game.stress > 80) score -= 20;
        if(hasPolicy('A8')) score -= 15;
        if(hasPolicy('B6')) score -= 10;
        if(hasPolicy('D7') || hasPolicy('D8')) score += 15;
        score = Math.max(0, score);
        if(score >= 80) return RATING_QUOTES[0];
        if(score >= 60) return RATING_QUOTES[1];
        if(score >= 40) return RATING_QUOTES[2];
        if(score >= 20) return RATING_QUOTES[3];
        return RATING_QUOTES[4];
    }
    
    function showGaokaoHistory() {
        if(!game.gaokaoHistory || game.gaokaoHistory.length === 0) {
            return showCustomModal("ğŸ“Š å†å¹´é«˜è€ƒ", "å°šæœªä¸¾åŠè¿‡é«˜è€ƒï¼Œè¯·ç»§ç»­æ¨æ¼”è‡³å…­æœˆã€‚", [{text:"å¥½çš„", action:()=>{}}]);
        }
        let maxQb = Math.max(1, ...game.gaokaoHistory.map(h=>h.qb||0));
        let barsHtml = game.gaokaoHistory.slice(-10).map(h => {
            let barH = Math.max(4, Math.floor((h.qb/maxQb)*150));
            let upH = Math.max(2, Math.floor((h.upline/100)*30));
            return `<div style="display:flex;flex-direction:column;align-items:center;flex:1;min-width:40px;">
                <div style="font-size:0.6rem;color:#ef4444;font-weight:bold;">${h.qb}æ¸…åŒ—</div>
                <div style="background:#ef4444;width:80%;height:${barH}px;border-radius:3px 3px 0 0;min-height:4px; margin-bottom:2px;"></div>
                <div style="background:#3b82f6;width:80%;height:${upH}px;border-radius:3px 3px 0 0;"></div>
                <div style="font-size:0.55rem;color:#64748b;margin-top:3px;text-align:center;">${h.year}<br>${h.upline}%</div>
            </div>`;
        }).join('');
        let tableHtml = `<table style="width:100%;border-collapse:collapse;font-size:0.8rem;margin-top:15px;">
            <tr style="background:#f1f5f9;font-weight:bold;"><td style="padding:5px;">å¹´ä»½</td><td>å‡åˆ†</td><td>æ¸…åŒ—</td><td>985</td><td>211</td><td>ä¸€æœ¬</td><td>ä¸Šçº¿ç‡</td></tr>`;
        game.gaokaoHistory.forEach(h => {
            tableHtml += `<tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:4px;font-weight:bold;">${h.year}</td><td style="color:#ef4444;">${h.avg}</td><td style="color:#ef4444;">${h.qb}</td><td style="color:#8b5cf6;">${h.rep985}</td><td style="color:#3b82f6;">${h.p211}</td><td style="color:#10b981;">${h.bk}</td><td style="color:#64748b;">${h.upline}%</td></tr>`;
        });
        tableHtml += '</table>';
        showCustomModal("ğŸ“Š å†å¹´é«˜è€ƒæˆç»©è®°å½•", `<div style="background:#f8fafc;border-radius:8px;padding:10px;border:1px solid #e2e8f0;"><div style="display:flex;align-items:flex-end;height:180px;gap:4px;justify-content:space-around;">${barsHtml}</div><div style="text-align:center;font-size:0.65rem;color:#94a3b8;margin-top:5px;">ğŸŸ¥ çº¢æŸ±=æ¸…åŒ—äººæ•° &nbsp;ğŸŸ¦ è“æŸ±=ä¸Šçº¿ç‡</div></div>${tableHtml}`, [{text:"å…³é—­", action:()=>{}}]);
    }
    
    function runAction(t) {
        if(t==='sponsor') { 
            if(payCost(4,0)) { 
                initSocialRelations();
                let base = [50, 100, 200, 400, 800][game.levelIdx] || 50;
                let socialBonus = Math.floor(((game.social.govRelations.local + game.social.govRelations.media) / 200) * base * 0.6);
                let total = base + socialBonus;
                game.funds += total; 
                game.reputation -= 20; 
                log(`ğŸ¤ æ‹‰èµåŠ©è·å¾— ï¿¥${total}ä¸‡ï¼ˆåŸºç¡€${base}+ç¤¾ä¼šå…³ç³»+${socialBonus}ï¼‰`); 
                updateUI(); 
            } 
        }
    }

    // =========== ç¤¾ä¼šå…³ç³»ç³»ç»Ÿ ===========
    function initSocialRelations() {
        if(!game.social) game.social = {
            teacherFactions: { young: 50, old: 50, reform: 50 },
            govRelations: { local: 50, edu_bureau: 45, media: 30 },
            communityRel: 40,
            principals: [],
            lastInspection: -12,
            inspectionWarned: false,
            monthlyTargets: [],
            targetGenMonth: -1
        };
    }

    function showSocialWindow() {
        initSocialRelations();
        let s = game.social;
        let html = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
        
        <!-- æ•™å¸ˆæ´¾ç³» -->
        <div style="background:#f8fafc;border-radius:10px;padding:15px;border-left:4px solid #8b5cf6;">
            <h3 style="margin:0 0 10px;color:#6d28d9;">ğŸ‘©â€ğŸ« æ•™å¸ˆæ´¾ç³»å…³ç³»</h3>
            ${[['young','ğŸŒ± å¹´è½»æ”¹é©æ´¾','#10b981'],['old','ğŸ“š ä¿å®ˆä¼ ç»Ÿæ´¾','#6366f1'],['reform','âš¡ æ¿€è¿›æ”¹é©æ´¾','#f59e0b']].map(([k,name,color])=>`
            <div style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;font-size:0.85rem;">
                    <span>${name}</span><b style="color:${color};">${s.teacherFactions[k]}/100</b>
                </div>
                <div style="background:#e2e8f0;height:6px;border-radius:3px;overflow:hidden;">
                    <div style="background:${color};height:100%;width:${s.teacherFactions[k]}%;"></div>
                </div>
            </div>`).join('')}
            <div style="display:flex;gap:5px;flex-wrap:wrap;">
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('teacher_young')">æ”¯æŒå¹´è½»æ´¾ (AP:1)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('teacher_old')">å®‰æŠšä¼ ç»Ÿæ´¾ (AP:1)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('teacher_reform')">æ¿€åŠ±æ”¹é©æ´¾ (AP:1)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('teacher_gossip')">ğŸ•µ æŸ¥çœ‹å…«å¦</button>
            </div>
        </div>

        <!-- æ”¿åºœå…³ç³» -->
        <div style="background:#f8fafc;border-radius:10px;padding:15px;border-left:4px solid #3b82f6;">
            <h3 style="margin:0 0 10px;color:#1d4ed8;">ğŸ›ï¸ æ”¿åºœä¸åª’ä½“å…³ç³»</h3>
            ${[['local','ğŸ™ï¸ åœ°æ–¹æ”¿åºœ','#60a5fa'],['edu_bureau','ğŸ“‹ æ•™è‚²å±€','#818cf8'],['media','ğŸ“¡ åª’ä½“å…¬å…³','#f472b6']].map(([k,name,color])=>`
            <div style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;font-size:0.85rem;">
                    <span>${name}</span><b style="color:${color};">${s.govRelations[k]}/100</b>
                </div>
                <div style="background:#e2e8f0;height:6px;border-radius:3px;overflow:hidden;">
                    <div style="background:${color};height:100%;width:${s.govRelations[k]}%;"></div>
                </div>
            </div>`).join('')}
            <div style="display:flex;gap:5px;flex-wrap:wrap;">
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('gov_gift')">é€ç¤¼æ‰“ç‚¹ (ï¿¥10ä¸‡)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('media_pr')">åª’ä½“å®£ä¼  (ï¿¥5ä¸‡)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('inspect_prep')">ğŸ“‹ å¤‡æˆ˜è§†å¯Ÿ</button>
            </div>
            <div style="margin-top:8px;background:#fff;border-radius:6px;padding:8px;font-size:0.78rem;color:#475569;">
                ${s.govRelations.edu_bureau>=70?'âœ… æ•™è‚²å±€è®¤å¯ - æ¯æœˆæ”¿ç­–æ‹¨æ¬¾':s.govRelations.edu_bureau>=40?'âš ï¸ å…³ç³»ä¸€èˆ¬ - è§†å¯Ÿé£é™©è¾ƒé«˜':'âŒ å…³ç³»æ¶åŠ£ - éšæ—¶å¯èƒ½è¢«æŸ¥å°'}
            </div>
        </div>

        <!-- ç¤¾åŒºå…³ç³» -->
        <div style="background:#f8fafc;border-radius:10px;padding:15px;border-left:4px solid #10b981;">
            <h3 style="margin:0 0 10px;color:#065f46;">ğŸ˜ï¸ ç¤¾åŒºå…³ç³»</h3>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                <div style="flex:1;background:#e2e8f0;height:10px;border-radius:5px;overflow:hidden;">
                    <div style="background:#10b981;height:100%;width:${s.communityRel}%;transition:0.3s;"></div>
                </div>
                <b style="color:#10b981;">${s.communityRel}/100</b>
            </div>
            <p style="font-size:0.8rem;color:#475569;margin:0 0 8px;">${s.communityRel>=70?'ç¤¾åŒºå±…æ°‘ç§¯ææ”¯æŒï¼Œå¯è·å¾—å¿—æ„¿è€…èµ„æºå’Œåœºåœ°':s.communityRel>=40?'å…³ç³»å°šå¯ï¼Œä¿æŒç°çŠ¶':s.communityRel>=20?'å±…æ°‘æœ‰æŠ±æ€¨ï¼Œå™ªéŸ³/å µè½¦é—®é¢˜é¢‘å‘':'å±…æ°‘å¼ºçƒˆæŠ•è¯‰ï¼Œå¯èƒ½è”åè¯·æ„¿è¦æ±‚æ¬è¿'}</p>
            <div style="display:flex;gap:5px;flex-wrap:wrap;">
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('community_event')">ğŸª å¼€å±•ç¤¾åŒºæ´»åŠ¨ (ï¿¥3ä¸‡)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('open_campus')">ğŸ« å¼€æ”¾æ ¡å›­è®¾æ–½</button>
            </div>
        </div>

        <!-- æ ¡é•¿åœˆ -->
        <div style="background:#f8fafc;border-radius:10px;padding:15px;border-left:4px solid #f59e0b;">
            <h3 style="margin:0 0 10px;color:#92400e;">ğŸ“ æ•™è‚²åœˆäººè„‰</h3>
            <p style="font-size:0.8rem;color:#475569;margin:0 0 10px;">å·²å»ºç«‹å…³ç³»: ${(s.principals||[]).length} æ‰€å­¦æ ¡</p>
            <div style="display:flex;flex-direction:column;gap:6px;max-height:100px;overflow-y:auto;">
                ${(s.principals||[]).map(p=>`<div style="font-size:0.78rem;padding:4px 8px;background:${p.rel==='ally'?'#f0fdf4':'#fef2f2'};border-radius:4px;">${p.rel==='ally'?'ğŸ¤':'âš”ï¸'} ${p.name} (${p.rel==='ally'?'åŒç›Ÿ':'ç«äº‰'})</div>`).join('')||'<div style="color:#94a3b8;font-size:0.8rem;">å°šæœªå»ºç«‹ä»»ä½•åŒè¡Œå…³ç³»</div>'}
            </div>
            <div style="display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;">
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('principal_forum')">ğŸ“£ å‚åŠ æ ¡é•¿è®ºå› (AP:20)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('principal_compete')">âš”ï¸ æŒ–è§’ç«äº‰å¯¹æ‰‹ (ï¿¥20ä¸‡)</button>
            </div>
        </div>
        </div>`;
        showCustomModal("ğŸ¤ ç¤¾ä¼šå…³ç³»ç½‘ç»œ", html, [{text:'å…³é—­', action:()=>{}}]);
    }

    function socialAct(t) {
        initSocialRelations();
        let s = game.social;
        if(t==='teacher_young') { if(!payCost(1,0)) return; s.teacherFactions.young=Math.min(100,s.teacherFactions.young+10); s.teacherFactions.old=Math.max(0,s.teacherFactions.old-5); game.grade+=1; showToast("å¹´è½»æ´¾æ”¯æŒï¼å­¦ä¸š+1"); }
        if(t==='teacher_old') { if(!payCost(1,0)) return; s.teacherFactions.old=Math.min(100,s.teacherFactions.old+10); s.teacherFactions.reform=Math.max(0,s.teacherFactions.reform-5); game.discipline+=2; showToast("ä¼ ç»Ÿæ´¾å®‰æŠšï¼çºªå¾‹+2"); }
        if(t==='teacher_reform') { if(!payCost(1,0)) return; s.teacherFactions.reform=Math.min(100,s.teacherFactions.reform+10); s.teacherFactions.old=Math.max(0,s.teacherFactions.old-8); game.art+=2; showToast("æ”¹é©æ´¾æ¿€åŠ±ï¼è‰ºæœ¯+2"); }
        if(t==='teacher_gossip') {
            let gossips = [
                `"å¬è¯´${s.teacherFactions.young>60?'å¹´è½»çš„ç‹è€å¸ˆè¦å»ç§ç«‹å­¦æ ¡äº†':'ä¼ ç»Ÿæ´¾çš„èµµè€å¸ˆåœ¨å·å·å…¼èŒåŸ¹è®­æœºæ„'}"`,
                `"æ•°å­¦ç»„å’Œè¯­æ–‡ç»„æœ€è¿‘ä¸ºäº†åŠå…¬å®¤ç©ºè°ƒæ¸©åº¦é—¹çŸ›ç›¾ï¼Œè¯¾ä»£è¡¨éƒ½è¢«è¿«ç«™é˜Ÿäº†â€¦â€¦"`,
                `"ç­ä¸»ä»»ä»¬ç§ä¸‹ä¼ ï¼š'æ ¡é•¿é‚£ä¸ªæœˆåº¦å¥–é‡‘åˆ¶åº¦å§ï¼Œæ ¹æœ¬å°±æ˜¯å†…éƒ¨å…³ç³»æˆ·'ã€‚"`,
                `"æœ‰è€å¸ˆè¯´è¦é›†ä½“è¯·å‡å»å‚åŠ æ•™è‚²å±€çš„ä»€ä¹ˆåº§è°ˆä¼šï¼Œè¯´æ˜¯ä¸ºäº†'ç»´æƒ'"`,
                `"å¹´çº§ç»„é•¿è·Ÿæ•™åŠ¡ä¸»ä»»ä¸å¯¹ä»˜ï¼Œæ’è¯¾è¡¨æ—¶æœ‰æ„æŠŠå¯¹æ–¹ä¸å–œæ¬¢çš„ç­æ’åœ¨æ—©8ç‚¹ã€‚"`
            ];
            showCustomModal("ğŸ•µï¸ æ•™å¸ˆå…«å¦åœˆ", gossips[Math.floor(Math.random()*gossips.length)], [{text:'å½“æ²¡å¬è§',action:()=>{}},{text:'å¹²é¢„è°ƒè§£',action:()=>{s.teacherFactions.young=Math.min(100,s.teacherFactions.young+5);s.teacherFactions.old=Math.min(100,s.teacherFactions.old+5);showToast("è°ƒè§£æˆåŠŸï¼");}}]);
            return;
        }
        if(t==='gov_gift') { if(!payCost(0,10)) return; s.govRelations.local=Math.min(100,s.govRelations.local+12); s.govRelations.edu_bureau=Math.min(100,s.govRelations.edu_bureau+8); showToast("å…³ç³»æ‰“ç‚¹ï¼æ”¿åºœå¥½æ„Ÿ+12"); }
        if(t==='media_pr') { if(!payCost(0,5)) return; s.govRelations.media=Math.min(100,s.govRelations.media+15); game.reputation+=20; showToast("åª’ä½“å®£ä¼ ï¼å£°èª‰+20"); }
        if(t==='inspect_prep') { 
            showCustomModal("ğŸ“‹ è§†å¯Ÿåº”å¯¹æ–¹æ¡ˆ", `è·ä¸Šæ¬¡è§†å¯Ÿå·²è¿‡ ${game.year*12+game.month-(s.lastInspection||0)} ä¸ªæœˆã€‚\n\né€‰æ‹©åº”å¯¹ç­–ç•¥ï¼š`, [
                {text:"ğŸ­ ç²¾å¿ƒå¸ƒç½®æ ·æ¿è¯¾ (ï¿¥8ä¸‡)", action:()=>{ if(payCost(0,8)){s.govRelations.edu_bureau=Math.min(100,s.govRelations.edu_bureau+20); showToast("å®Œç¾åº”å¯¹ï¼æ•™è‚²å±€+20");} }},
                {text:"ğŸ’° ç›´æ¥æ‰“ç‚¹å…³é”®å®˜å‘˜ (ï¿¥15ä¸‡)", action:()=>{ if(payCost(0,15)){s.govRelations.edu_bureau=Math.min(100,s.govRelations.edu_bureau+35); showToast("é“¶å¼¹å¤–äº¤ï¼æ•™è‚²å±€+35");} }},
                {text:"ğŸ˜¤ ç¡¬æŠ—ï¼Œå±•ç¤ºçœŸå®æ°´å¹³", action:()=>{ let pass=game.grade>=60&&game.reputation>=500; s.govRelations.edu_bureau+=pass?10:-15; showToast(pass?"çœŸå®åŠ›é€šè¿‡ï¼":"å®åŠ›ä¸è¶³è¢«æ‰¹è¯„ï¼"); }}
            ]);
            return;
        }
        if(t==='community_event') { if(!payCost(0,3)) return; s.communityRel=Math.min(100,s.communityRel+15); game.reputation+=10; showToast("ç¤¾åŒºæ´»åŠ¨åœ†æ»¡ï¼å£°èª‰+10"); }
        if(t==='open_campus') { s.communityRel=Math.min(100,s.communityRel+8); game.fitness+=1; showToast("å¼€æ”¾æ ¡å›­ï¼ç¤¾åŒºå…³ç³»+8"); }
        if(t==='principal_forum') { 
            if(!payCost(20,0)) return;
            const SCHOOL_POOL = ['å¸‚ä¸€ä¸­æ ¡é•¿','çœå®éªŒæ ¡é•¿','é‡ç‚¹é™„ä¸­æ ¡é•¿','å¸‚ç¤ºèŒƒé«˜ä¸­æ ¡é•¿','çœé‡ç‚¹ä¸­å­¦æ ¡é•¿','åŒºä¼˜è´¨é«˜ä¸­æ ¡é•¿','å¸‚æ•™è‚²é›†å›¢æ ¡é•¿','çœå±ä¸­å­¦æ ¡é•¿','å¸‚æ–°é”åæ ¡æ ¡é•¿','åŒºåŒè¯­å­¦æ ¡æ ¡é•¿'];
            let existing = (s.principals||[]).map(p=>p.name);
            let available = SCHOOL_POOL.filter(name => !existing.includes(name));
            if(!available.length) { showToast("å·²è®¤è¯†æ‰€æœ‰å¯ç»“è¯†çš„æ ¡é•¿ï¼"); return; }
            let newName = available[Math.floor(Math.random()*available.length)];
            let newSchool = {name: newName, rel:'neutral'};
            if(!s.principals) s.principals=[];
            s.principals.push(newSchool); game.reputation+=10;
            showToast(`ç»“è¯†äº† ${newSchool.name}ï¼å£°èª‰+10`);
        }
        if(t==='principal_compete') { 
            if(!payCost(0,20)) return;
            game.grade+=5; game.students=Math.min(10000,game.students+100);
            showToast("æˆåŠŸæŒ–èµ°ç«äº‰å¯¹æ‰‹çš„åå¸ˆï¼å­¦ä¸š+5ï¼Œç”Ÿæº+100");
        }
        updateUI();
        showSocialWindow();
    }

    // =========== æœˆåº¦ç›®æ ‡ç³»ç»Ÿ ===========
    const TARGET_TEMPLATES = [
        {type:'teach',  icon:'ğŸ“š', gen:()=>{ let tgt=Math.floor(game.grade+10); return {desc:`å°†å­¦ä¸šæå‡è‡³ ${tgt} ä»¥ä¸Š`, check:(snap)=>game.grade>=snap.gradeTarget, snap:{gradeTarget:tgt}, reward:{rep:50,edu:5}, difficulty:'ç®€å•'}; }},
        {type:'build',  icon:'ğŸ—ï¸', gen:()=>{ let tgt=game.map.filter(x=>x).length+1; return {desc:'æœ¬æœˆæ–°å»ºæˆ–å‡çº§ä¸€åº§å»ºç­‘', check:(snap)=>game.map.filter(x=>x).length>=snap.buildTarget, snap:{buildTarget:tgt}, reward:{rep:30,funds:5}, difficulty:'ç®€å•'}; }},
        {type:'expert', icon:'ğŸ‘¨â€ğŸ«', gen:()=>{ let tgt=game.unlockedExperts.length+1; return {desc:'æ‹›å‹Ÿä¸€ä½æ–°ä¸“å®¶', check:(snap)=>game.unlockedExperts.length>=snap.expertTarget, snap:{expertTarget:tgt}, reward:{rep:60,edu:8}, difficulty:'ä¸­ç­‰'}; }},
        {type:'funds',  icon:'ğŸ’°', gen:()=>{ let tgt=Math.floor(game.funds+50); return {desc:`èµ„é‡‘ç§¯ç´¯åˆ° ${tgt} ä¸‡ä»¥ä¸Š`, check:(snap)=>game.funds>=snap.fundsTarget, snap:{fundsTarget:tgt}, reward:{rep:40,funds:20}, difficulty:'ä¸­ç­‰'}; }},
        {type:'rep',    icon:'â­', gen:()=>{ let tgt=Math.floor(game.reputation+200); return {desc:`å£°èª‰çªç ´ ${tgt} ç‚¹`, check:(snap)=>game.reputation>=snap.repTarget, snap:{repTarget:tgt}, reward:{rep:80,edu:10}, difficulty:'å›°éš¾'}; }},
        {type:'stress', icon:'ğŸ˜Œ', gen:()=>{ let tgt=Math.max(20,Math.floor(game.stress-20)); return {desc:`å°†å…¨æ ¡å‹åŠ›é™ä½è‡³ ${tgt} ä»¥ä¸‹`, check:(snap)=>game.stress<=snap.stressTarget, snap:{stressTarget:tgt}, reward:{rep:50,funds:10}, difficulty:'ä¸­ç­‰'}; }},
        {type:'battle', icon:'âš”ï¸', gen:()=>{ let tgt=game.examPoints+5; return {desc:'èµ¢å¾—ä¸€åœºè”è€ƒæˆ˜æ–—ï¼ˆè”è€ƒç§¯åˆ†+5ï¼‰', check:(snap)=>game.examPoints>=snap.examTarget, snap:{examTarget:tgt}, reward:{rep:100,edu:15}, difficulty:'å›°éš¾'}; }}
    ];

    function generateMonthlyTargets() {
        initSocialRelations();
        if(game.social.targetGenMonth === game.month) return;
        game.social.targetGenMonth = game.month;
        let count = 3 + Math.floor(Math.random()*3);
        let shuffled = [...TARGET_TEMPLATES].sort(()=>Math.random()-0.5).slice(0,count);
        game.social.monthlyTargets = shuffled.map(t=>{
            let g = t.gen();
            return { icon:t.icon, desc:g.desc, reward:g.reward, difficulty:g.difficulty, snap:g.snap, check:g.check, done:false, failed:false };
        });
    }

    function showMonthlyTargets() {
        initSocialRelations();
        generateMonthlyTargets();
        let targets = game.social.monthlyTargets || [];
        let diffColor = {ç®€å•:'#10b981',ä¸­ç­‰:'#f59e0b',å›°éš¾:'#ef4444'};
        let html = `<p style="color:#475569;font-size:0.85rem;margin-top:0;">å®Œæˆç›®æ ‡è·å¾—å¥–åŠ±ï¼Œæ”¾å¼ƒç›®æ ‡å£°èª‰-10ã€‚</p>
        <div style="display:flex;flex-direction:column;gap:10px;">`;
        targets.forEach((t,i)=>{
            let status = t.done?'âœ… å·²å®Œæˆ':t.failed?'âŒ å·²æ”¾å¼ƒ':'â³ è¿›è¡Œä¸­';
            let statusColor = t.done?'#10b981':t.failed?'#ef4444':'#f59e0b';
            html += `<div style="background:#f8fafc;border-radius:8px;padding:12px;border-left:4px solid ${diffColor[t.difficulty]||'#cbd5e1'};">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:1.2rem;">${t.icon}</span>
                    <span style="font-size:0.7rem;background:${diffColor[t.difficulty]};color:white;padding:2px 6px;border-radius:4px;">${t.difficulty}</span>
                </div>
                <div style="font-size:0.88rem;color:#1e293b;margin:5px 0;">${t.desc}</div>
                <div style="font-size:0.75rem;color:#64748b;">å¥–åŠ±ï¼šå£°èª‰+${t.reward.rep||0} ${t.reward.edu?'æ•™ç ”ç‚¹+'+t.reward.edu:''} ${t.reward.funds?'èµ„é‡‘+'+t.reward.funds+'ä¸‡':''}</div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
                    <span style="font-size:0.75rem;color:${statusColor};font-weight:bold;">${status}</span>
                    ${!t.done&&!t.failed?`<div style="display:flex;gap:5px;">
                        <button class="btn" style="font-size:0.7rem;padding:3px 8px;" onclick="claimTarget(${i})">âœ… å®Œæˆé¢†å–</button>
                        <button class="btn" style="font-size:0.7rem;padding:3px 8px;border-color:#ef4444;color:#ef4444;" onclick="abandonTarget(${i})">æ”¾å¼ƒ</button>
                    </div>`:''}
                </div>
            </div>`;
        });
        html += '</div>';
        showCustomModal("ğŸ¯ æœˆåº¦ç›®æ ‡æ¿", html, [{text:'å…³é—­',action:()=>{}}]);
    }

    function claimTarget(i) {
        let t = game.social.monthlyTargets[i];
        if(t.done||t.failed) return showToast("è¯¥ç›®æ ‡å·²å¤„ç†");
        // æ£€æŸ¥æ¡ä»¶æ˜¯å¦çœŸæ­£æ»¡è¶³
        let met = false;
        try { met = t.check ? t.check(t.snap||{}) : false; } catch(e) { met = false; }
        if(!met) return showToast("âš ï¸ ç›®æ ‡æ¡ä»¶å°šæœªè¾¾æˆï¼Œæ— æ³•é¢†å–ï¼");
        t.done = true;
        if(t.reward.rep) game.reputation += t.reward.rep;
        if(t.reward.edu) game.eduPoints += t.reward.edu;
        if(t.reward.funds) game.funds += t.reward.funds;
        showToast(`ğŸ‰ ç›®æ ‡å®Œæˆï¼å£°èª‰+${t.reward.rep||0}`);
        updateUI(); showMonthlyTargets();
    }
    function abandonTarget(i) {
        let t = game.social.monthlyTargets[i];
        t.failed = true; game.reputation = Math.max(0, game.reputation-10);
        showToast("æ”¾å¼ƒç›®æ ‡ï¼Œå£°èª‰-10"); updateUI(); showMonthlyTargets();
    }

    // =========== å­¦ç§‘ç«èµ›ç³»ç»Ÿï¼ˆçœçº§è§£é”ï¼‰===========
    const OLYMPIAD_SUBJECTS = [
        {id:'math',   name:'æ•°å­¦è”èµ›', icon:'ğŸ“', desc:'ä»¥éš¾åº¦å’Œå¹¿åº¦è‘—ç§°ï¼Œå…¨å›½å«é‡‘é‡æœ€é«˜'},
        {id:'physics',name:'ç‰©ç†ç«èµ›', icon:'âš›ï¸', desc:'å®éªŒä¸ç†è®ºå¹¶é‡ï¼Œé—¨æ§›æé«˜'},
        {id:'chem',   name:'åŒ–å­¦ç«èµ›', icon:'ğŸ§ª', desc:'è®°å¿†ä¸æ¨ç†åŒé‡è€ƒéªŒ'},
        {id:'bio',    name:'ç”Ÿç‰©ç«èµ›', icon:'ğŸ§¬', desc:'å®éªŒæ“ä½œä¸ç†è®ºçŸ¥è¯†èåˆ'},
        {id:'info',   name:'ä¿¡æ¯ç«èµ›', icon:'ğŸ’»', desc:'ä»£ç ä¸ç®—æ³•ï¼Œæœªæ¥æœ€çƒ­é—¨'}
    ];

    function showOlympiadSystem() {
        if(game.levelIdx < 3) return showCustomModal("ğŸ”’ ç«èµ›ç³»ç»Ÿ","è¯¥ç³»ç»Ÿéœ€è¦å­¦æ ¡è¾¾åˆ°ã€çœçº§åæ ¡ã€‘æ‰å¯è§£é”ã€‚ç»§ç»­åŠªåŠ›ï¼",[{text:'æ˜ç™½',action:()=>{}}]);
        if(!game.olympiadData) game.olympiadData = {
            squads: {math:{level:0,trained:false},physics:{level:0,trained:false},chem:{level:0,trained:false},bio:{level:0,trained:false},info:{level:0,trained:false}},
            medals: {gold:0,silver:0,bronze:0},
            scholarships: 0
        };
        let od = game.olympiadData;
        let html = `<div style="margin-bottom:12px;background:#eff6ff;border-radius:8px;padding:10px;text-align:center;font-size:0.85rem;">
            ğŸ… ç´¯è®¡é‡‘ç‰Œ: <b style="color:#f59e0b">${od.medals.gold}</b> 
            ğŸ¥ˆ é“¶ç‰Œ: <b style="color:#94a3b8">${od.medals.silver}</b> 
            ğŸ¥‰ é“œç‰Œ: <b style="color:#cd7f32">${od.medals.bronze}</b> 
            &nbsp;|&nbsp; ä¿é€åé¢: <b style="color:#10b981">${od.scholarships}</b> äºº
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">`;
        
        OLYMPIAD_SUBJECTS.forEach(sub=>{
            let sq = od.squads[sub.id];
            let stageName = ['æœªç»„å»º','çœçº§åˆèµ›','å…¨å›½å†³èµ›','å›½é™…å¥¥èµ›'][Math.min(3,sq.level)];
            let stageColor = ['#94a3b8','#3b82f6','#8b5cf6','#f59e0b'][Math.min(3,sq.level)];
            html += `<div style="background:#f8fafc;border:2px solid ${stageColor};border-radius:10px;padding:12px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <span style="font-size:1.8rem;">${sub.icon}</span>
                    <div>
                        <div style="font-weight:bold;font-size:0.9rem;">${sub.name}</div>
                        <div style="font-size:0.65rem;color:${stageColor};font-weight:bold;">${stageName}</div>
                    </div>
                </div>
                <p style="font-size:0.72rem;color:#64748b;margin:0 0 8px;">${sub.desc}</p>
                <div style="display:flex;flex-direction:column;gap:4px;">
                    ${sq.level===0?`<button class="btn" style="font-size:0.73rem;padding:4px;" onclick="olympiadAct('build','${sub.id}')">ğŸ”¨ ç»„å»ºé›†è®­é˜Ÿ (ï¿¥15ä¸‡+AP:2)</button>`:''}
                    ${sq.level>=1&&sq.level<3?`<button class="btn" style="font-size:0.73rem;padding:4px;" onclick="olympiadAct('compete','${sub.id}')">âš”ï¸ å‚åŠ æ¯”èµ› (AP:3)</button>`:''}
                    ${sq.level>=1?`<button class="btn" style="font-size:0.73rem;padding:4px;" onclick="olympiadAct('train','${sub.id}')">ğŸ‹ï¸ å¼ºåŒ–è®­ç»ƒ (ï¿¥5ä¸‡)</button>`:''}
                </div>
            </div>`;
        });
        html += '</div>';
        showCustomModal("ğŸ† å­¦ç§‘å¥¥æ—åŒ¹å…‹ç«èµ›ç³»ç»Ÿ", html, [{text:'å…³é—­',action:()=>{}}]);
    }

    function olympiadAct(act, subId) {
        if(!game.olympiadData) return;
        let sq = game.olympiadData.squads[subId];
        let od = game.olympiadData;
        if(act==='build') {
            if(!payCost(2,15)) return;
            sq.level=1; game.reputation+=30; game.eduPoints+=5;
            showToast(`${OLYMPIAD_SUBJECTS.find(s=>s.id===subId).name} é›†è®­é˜Ÿç»„å»ºå®Œæ¯•ï¼å£°èª‰+30`);
        }
        if(act==='train') {
            if(!payCost(0,5)) return;
            sq.trained=true; showToast("å¼ºåŒ–è®­ç»ƒå®Œæˆï¼ä¸‹æ¬¡å‚èµ›æˆåŠŸç‡æå‡");
        }
        if(act==='compete') {
            if(!payCost(3,0)) return;
            let sub = OLYMPIAD_SUBJECTS.find(s=>s.id===subId);
            let baseRate = 0.3 + game.grade/300 + (sq.trained?0.2:0) + (sq.level>=2?0.15:0);
            sq.trained = false;
            let roll = Math.random();
            let result, medal='', repGain=0, schGain=0;
            if(roll < baseRate*0.3) { medal='ğŸ¥‡ é‡‘ç‰Œ'; od.medals.gold++; repGain=200; schGain=2; result='é‡‘ç‰Œï¼ä¿é€åé¢+2ï¼'; sq.level=Math.min(3,sq.level+1); }
            else if(roll < baseRate*0.7) { medal='ğŸ¥ˆ é“¶ç‰Œ'; od.medals.silver++; repGain=100; schGain=1; result='é“¶ç‰Œï¼ä¿é€åé¢+1ï¼'; sq.level=Math.min(3,sq.level+1); }
            else if(roll < baseRate) { medal='ğŸ¥‰ é“œç‰Œ'; od.medals.bronze++; repGain=50; result='é“œç‰Œï¼å£°èª‰+50'; }
            else { result='æœªèƒ½è·å¥–â€¦â€¦æ˜å¹´å†æ¥'; repGain=-10; }
            od.scholarships += schGain;
            game.reputation += repGain;
            showCustomModal(`${sub.icon} ${sub.name} ç»“æœ`, `${medal||'ğŸ“‹'} ${result}\n\nå£°èª‰${repGain>=0?'+':''}${repGain} | ä¿é€åé¢æ€»è®¡: ${od.scholarships}`, [{text:'ç¡®è®¤',action:()=>showOlympiadSystem()}]);
            return;
        }
        updateUI(); showOlympiadSystem();
    }

    // =========== å­¦ç”Ÿæ—¥è®°/å†…å¿ƒç‹¬ç™½ç³»ç»Ÿ ===========
    function showStuJournal() {
        if(!stuGame.active) return showCustomModal("ğŸ““","è¯·å…ˆè¿›å…¥å­¦ç”Ÿæ¨¡å¼",[{text:'å¥½',action:()=>{}}]);
        if(!stuGame.journal) stuGame.journal = [];
        let entries = stuGame.journal;
        let autoEntry = generateAutoJournalEntry();
        let html = `<div style="background:#fffbeb;border-radius:8px;padding:15px;border-left:4px solid #f59e0b;margin-bottom:12px;">
            <div style="font-size:0.7rem;color:#92400e;font-weight:bold;">${game.year}å¹´${game.month}æœˆ Â· ä»Šæ—¥å¿ƒæƒ…</div>
            <p style="font-size:0.88rem;color:#78350f;line-height:1.7;margin:6px 0 0;font-style:italic;">"${autoEntry}"</p>
        </div>
        <h4 style="margin:0 0 8px;color:#1e293b;">ğŸ“– å†å²æ—¥è®°</h4>
        <div style="display:flex;flex-direction:column;gap:8px;max-height:200px;overflow-y:auto;">
        ${entries.length?entries.slice(-6).reverse().map(e=>`<div style="background:#f8fafc;border-radius:6px;padding:10px;border-left:3px solid #cbd5e1;">
            <div style="font-size:0.65rem;color:#94a3b8;">${e.date}</div>
            <p style="margin:3px 0 0;font-size:0.82rem;color:#475569;font-style:italic;">"${e.text}"</p>
        </div>`).join('') : '<div style="color:#94a3b8;font-size:0.82rem;">è¿˜æ²¡æœ‰ä»»ä½•æ—¥è®°ã€‚é€šè¿‡ã€å†™æ—¥è®°ã€‘è¡ŒåŠ¨æ¥è®°å½•ä½ çš„é«˜ä¸­æ—¶å…‰ã€‚</div>'}
        </div>`;
        showCustomModal("ğŸ““ å†…å¿ƒæ—¥è®°", html, [
            {text:'å†™ä¸‹ä»Šæ—¥æ„Ÿæƒ³', action:()=>{ stuGame.journal.push({date:`${game.year}.${game.month}`,text:autoEntry}); stuGame.stress=Math.max(0,stuGame.stress-5); showToast("å†™æ—¥è®°å‡å‹5"); showStuJournal(); }},
            {text:'å…³é—­', action:()=>{}}
        ]);
    }

    function generateAutoJournalEntry() {
        let stress = stuGame.stress, grade = stuGame.grade, score = stuGame.examScore||0;
        let lover = stuGame.lover, loverName = stuGame.loverName;
        let entries = [
            stress>=80?`ä»Šå¤©å‹åŠ›${Math.floor(stress)}ï¼Œæˆ‘å¿«å–˜ä¸è¿‡æ°”äº†ã€‚ä½†æˆ‘ä¸èƒ½åœï¼Œä¸æ•¢åœã€‚æˆ‘å®³æ€•å¦‚æœæˆ‘åœä¸‹æ¥ï¼Œæ‰€æœ‰äººéƒ½ä¼šå¤±æœ›ã€‚`:`å‹åŠ›${Math.floor(stress)}ï¼Œè¿˜ç®—å¯ä»¥ã€‚æˆ‘å‘Šè¯‰è‡ªå·±ï¼šæ¯ä¸€å¤©éƒ½ä¼šè¿‡å»çš„ã€‚`,
            grade>=70?`æ¨¡æ‹Ÿé¢˜åšåˆ°å‡Œæ™¨ï¼Œé”™è¯¯ç‡åœ¨ä¸‹é™ã€‚ä¹Ÿè®¸æˆ‘çœŸçš„å¯ä»¥ï¼Ÿ`:`åˆè®¢æ­£äº†ä¸€éé”™é¢˜æœ¬ã€‚åšå®Œä¹‹åï¼Œæˆ‘ååœ¨é‚£é‡Œå‘äº†ä¸€ä¼šå„¿å‘†ã€‚è¿™ä¸€åˆ‡å€¼å¾—å—ï¼Ÿ`,
            lover?`ä»Šå¤©${loverName}å†²æˆ‘ç¬‘äº†ä¸€ä¸‹ã€‚æˆ‘çš„å¿ƒè·³çªç„¶å¿«äº†ä¸‰æ‹ã€‚çœŸçš„å¾ˆè ¢ï¼Œä½†æ˜¯â€¦â€¦å¾ˆçœŸå®ã€‚`:`ç­ä¸Šæœ‰äººåœ¨è°ˆæ‹çˆ±ï¼Œæˆ‘æ²¡è¯´ä»€ä¹ˆã€‚åªæ˜¯æƒ³ç€ï¼Œå¦‚æœæˆ‘ä¹Ÿâ€¦â€¦ç®—äº†ã€‚`,
            `é£Ÿå ‚ä»Šå¤©æœ‰çº¢çƒ§è‚‰ã€‚æˆ‘å¤šæ‰“äº†ä¸€ä»½ã€‚è¿™æ˜¯ä»Šå¤©å”¯ä¸€è®©æˆ‘é«˜å…´çš„äº‹æƒ…ã€‚`,
            stress>=70?`æˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦è¯»ä¹¦ã€‚ä½†æˆ‘ä¹Ÿä¸çŸ¥é“ä¸è¯»ä¹¦çš„è¯ï¼Œæˆ‘ä¼šæ˜¯ä»€ä¹ˆã€‚æ‰€ä»¥æˆ‘ç»§ç»­è¯»ã€‚`:`èµ°å»Šä¸Šçœ‹åˆ°å¤•é˜³æŠŠçª—å­æŸ“æˆé‡‘è‰²ã€‚æˆ‘åœä¸‹æ¥çœ‹äº†ä¸‰ç§’é’Ÿã€‚ç„¶åç»§ç»­èµ°ã€‚`,
        ];
        let idx = Math.floor(Math.random()*entries.length);
        return entries[idx];
    }

    // =========== æ·±åº¦æƒ…æ„Ÿçº¿ï¼šè§’è‰²ç‹¬ç«‹å¯¹è¯ä¸åé¦ˆ ===========
    const DEEP_CRUSH_DIALOGUES = {
        'lin': {
            low: [
                {scene:'æ”¾å­¦å', line:`"ä½ â€¦â€¦æ˜¯æœ‰ä»€ä¹ˆäº‹å—ï¼Ÿæˆ‘è¦å»å›¾ä¹¦é¦†äº†ã€‚"`, mood:'è­¦æƒ•'},
                {scene:'æ—©è¯»è¯¾', line:`"é‚£é“é¢˜ä½ é€‰Cæ˜¯é”™çš„ã€‚æ˜¯Aï¼Œä½ è‡ªå·±å»æ¨å¯¼ä¸€éã€‚"`, mood:'å†·æ·¡'},
                {scene:'è¯¾é—´', line:`"å€Ÿç¬”è®°å¯ä»¥ï¼Œä½†ä¸è¦å¼„è„ã€‚"`, mood:'ç–è¿œ'}
            ],
            mid: [
                {scene:'æ”¾å­¦èµ°å»Š', line:`"ä»Šæ™šä¸ƒç‚¹æ•°å­¦è‡ªä¹ å®¤ï¼Œå¦‚æœä½ æ„¿æ„çš„è¯â€¦â€¦å¯ä»¥ä¸€èµ·ã€‚"`, mood:'è¯•æ¢'},
                {scene:'å¤©å°', line:`"â€¦â€¦ä½ ä¹Ÿå–œæ¬¢æ¥å¤©å°ï¼Ÿæˆ‘ä»¥ä¸ºåªæœ‰æˆ‘ä¸€ä¸ªäººçŸ¥é“è¿™é‡Œã€‚"`, mood:'æƒŠè®¶'},
                {scene:'è€ƒè¯•å', line:`"è¿™æ¬¡ä½ è¿›æ­¥äº†ä¸‰åã€‚æˆ‘æ³¨æ„åˆ°äº†ã€‚"`, mood:'å…³æ³¨'}
            ],
            high: [
                {scene:'æ·±å¤œå›¾ä¹¦é¦†', line:`"ä½ è¯´â€¦â€¦å¦‚æœæˆ‘ä»¬éƒ½æ²¡è€ƒä¸Šæ¸…åï¼Œæˆ‘ä»¬è¿˜ä¼šæ˜¯æœ‹å‹å—ï¼Ÿ"`, mood:'è„†å¼±'},
                {scene:'å¤©å°', line:`"æˆ‘ä»æ¥æ²¡æŠŠè¯—ç»™äººçœ‹è¿‡ã€‚ä½†â€¦â€¦ä½ å¯ä»¥çœ‹ã€‚"`, mood:'ä¿¡ä»»'},
                {scene:'å®£èª“å', line:`"æˆ‘ä¸çŸ¥é“å–œæ¬¢ä¸€ä¸ªäººæ˜¯ä»€ä¹ˆæ„Ÿè§‰ã€‚ä½†å½“ä½ åœ¨çš„æ—¶å€™ï¼Œæˆ‘çš„ä¸–ç•Œå¥½åƒâ€¦â€¦ä¸é‚£ä¹ˆé»‘ç™½äº†ã€‚"`, mood:'å¿ƒåŠ¨'}
            ]
        },
        'xia': {
            low: [
                {scene:'ç¾æœ¯å®¤å¤–', line:`"æ²¡äº‹ä½ ç»•ç€èµ°ï¼Œè¿™é‡Œåœ¨ä¸Šè¯¾ã€‚"`, mood:'æ— è§†'},
                {scene:'èµ°å»Š', line:`"å€Ÿé’±çš„è¯å»æ‰¾åˆ«äººï¼Œæˆ‘ä¹Ÿä¸å¯Œè£•ã€‚"`, mood:'æˆ’å¤‡'},
                {scene:'éŸ³ä¹è¯¾', line:`"â€¦â€¦åˆ«çœ‹æˆ‘ï¼Œçƒ¦ã€‚"`, mood:'æŠ—æ‹’'}
            ],
            mid: [
                {scene:'æ”¾å­¦', line:`"ä½ çŸ¥é“ä»Šæ™šæœ‰ä¸ªåœ°ä¸‹ä¹é˜Ÿåœ¨å•†åœºæ¼”å‡ºå—ï¼Ÿâ€¦â€¦é—®ä¸€å¥è€Œå·²ï¼Œåˆæ²¡å«ä½ å»ã€‚"`, mood:'æš—ç¤º'},
                {scene:'ç¾æœ¯å®¤', line:`"è¿™æ˜¯æˆ‘ç”»çš„ä½ ã€‚æ‹¿å»å§ï¼Œä¸è¦ä¸è¦è¿™ä¹ˆæƒŠè®¶ï¼Œä½ è¡¨æƒ…å¤ªæœ‰è¶£äº†ã€‚"`, mood:'å¤§èƒ†'},
                {scene:'æ“åœº', line:`"é‚£ä¸ªâ€¦â€¦æˆ‘æƒ³ç»™ä¸€ä¸ªäººç”»ç”»ï¼Œä½†æˆ‘ä¸çŸ¥é“ä»–å–œä¸å–œæ¬¢ã€‚"`, mood:'ç¾æ¶©'}
            ],
            high: [
                {scene:'æ¼«å±•', line:`"æˆ‘å…¶å®â€¦â€¦å¾ˆæ€•æœ‰ä¸€å¤©ç”»ä¸å‡ºä¸œè¥¿äº†ã€‚ä½ ä¸ä¼šè¯´æˆ‘çŸ«æƒ…å—ï¼Ÿ"`, mood:'è¢’éœ²'},
                {scene:'æ±Ÿè¾¹', line:`"å¦‚æœæˆ‘å»äº†ç±³å…°ï¼Œä½ ä¼šæ¥çœ‹æˆ‘çš„ç”»å±•å—ï¼Ÿ"`, mood:'æœŸå¾…'},
                {scene:'ç”»å®¤å¤œæ™š', line:`"æˆ‘ä¸çŸ¥é“çˆ±æƒ…æ˜¯ä»€ä¹ˆã€‚ä½†æˆ‘çŸ¥é“ç”»ä½ çš„æ—¶å€™ï¼Œæˆ‘çš„çº¿æ¡æ¯”ä»¥å‰æ›´ç¨³äº†ã€‚"`, mood:'æ·±æƒ…'}
            ]
        },
        'jiang': {
            low: [
                {scene:'æ“åœº', line:`"å“Ÿï¼Œæ¥çœ‹çƒï¼Ÿç«™è¿œç‚¹ï¼Œåˆ«æŒ¡ç€ã€‚"`, mood:'æ¼«ä¸ç»å¿ƒ'},
                {scene:'èµ°å»Š', line:`"å“ˆå“ˆä¸ç”¨è°¢ï¼Œéšæ‰‹çš„äº‹ã€‚"`, mood:'éšæ„'},
                {scene:'é£Ÿå ‚', line:`"é‚£ä¸ªåº§ä½æœ‰äººçš„ï¼Œæˆ‘æœ‹å‹çš„ã€‚"`, mood:'ç–è¿œ'}
            ],
            mid: [
                {scene:'ç¯®çƒåœº', line:`"çœ‹ä½ è·‘æ­¥å§¿åŠ¿ä¸å¯¹ï¼Œç­‰æ”¾å­¦æˆ‘æ•™ä½ ã€‚"`, mood:'ä¸»åŠ¨'},
                {scene:'æ¯”èµ›å', line:`"ä»Šå¤©ä½ æ¥çœ‹äº†ï¼Œæ˜¯å§ï¼Ÿè°¢äº†â€¦â€¦æˆ‘æ‰“å¾—è¿˜è¡Œå§ï¼Ÿ"`, mood:'åœ¨æ„'},
                {scene:'æ“åœºè¾¹', line:`"æˆ‘æ‰‹è¿™é‡Œâ€¦â€¦æ²¡äº‹ï¼Œè€æ¯›ç—…ã€‚ä½ åˆ«å£°å¼ å•Šï¼Œä¸ç„¶ä¸»ä»»åˆè®©æˆ‘ä¼‘èµ›ã€‚"`, mood:'ä¿¡ä»»'}
            ],
            high: [
                {scene:'æ·±å¤œæ“åœº', line:`"æˆ‘å…¶å®æ€•æ‰“ä¸äº†çƒäº†ã€‚ä½†æˆ‘æ›´æ€•â€¦â€¦ä¸çŸ¥é“å¦‚æœæ²¡æœ‰çƒï¼Œæˆ‘æ˜¯è°ã€‚"`, mood:'çœŸå®'},
                {scene:'æ¯”èµ›å‰', line:`"ä½ ä»Šå¤©ä¸€å®šè¦æ¥å•Šã€‚è®¤çœŸçš„ï¼Œä¸æ˜¯å¼€ç©ç¬‘ï¼Œæˆ‘â€¦â€¦éœ€è¦ä½ åœ¨åœºè¾¹ã€‚"`, mood:'ä¾èµ–'},
                {scene:'çƒ§çƒ¤æ‘Š', line:`"ä½ æ˜¯ç¬¬ä¸€ä¸ªâ€¦â€¦è®©æˆ‘è§‰å¾—ï¼Œå“ªæ€•ä¸æ‰“çƒï¼Œä¹Ÿè¿˜å¥½çš„äººã€‚"`, mood:'æ·±æƒ…'}
            ]
        },
        'shen': {
            low: [
                {scene:'èµ°å»Š', line:`"â€¦â€¦"ï¼ˆæˆ´ç€è€³æœºï¼Œæ²¡æœ‰å›åº”ï¼‰`, mood:'å°é—­'},
                {scene:'æ•™å®¤', line:`"æœ‰äº‹å—ï¼Ÿæ²¡äº‹åˆ«çƒ¦æˆ‘ã€‚"`, mood:'é˜²å¾¡'},
                {scene:'é—¨å£', line:`"å€Ÿæ©¡çš®ï¼Ÿè¿™ã€‚ä¸ç”¨è¿˜äº†ã€‚"`, mood:'å†·æ¼ '}
            ],
            mid: [
                {scene:'ä¾¿åˆ©åº—', line:`"â€¦â€¦ä½ ä¹Ÿä¹°è¿™ä¸ªå£å‘³å—ã€‚"ï¼ˆæ²‰é»˜ï¼‰"â€¦â€¦å¥½åƒå°±è¡Œã€‚"`, mood:'æ„å¤–'},
                {scene:'èµ°å»Š', line:`"ä½ â€¦â€¦çœ‹åˆ°æˆ‘ä»å“ªé‡Œæ¥äº†ï¼Ÿï¼ˆåœé¡¿ï¼‰â€¦â€¦åˆ«é—®ã€‚"`, mood:'ç´§å¼ '},
                {scene:'å¤©å°', line:`"ä½ ä¸é—®æˆ‘ä¸ºä»€ä¹ˆæ€»æ˜¯å¾ˆæ™šå›æ¥ï¼Œæ˜¯å› ä¸ºä½ çŒœåˆ°äº†ï¼Œè¿˜æ˜¯ä½ æ ¹æœ¬ä¸åœ¨ä¹ï¼Ÿ"`, mood:'è¯•æ¢'}
            ],
            high: [
                {scene:'ä¾¿åˆ©åº—æ·±å¤œ', line:`"æˆ‘å¼Ÿè¯´â€¦â€¦æœ‰äººå¸®ä»–å«äº†é¥­é’±ã€‚æ˜¯ä½ å—ã€‚ï¼ˆæ²‰é»˜ï¼‰â€¦â€¦è°¢è°¢ã€‚"`, mood:'åŠ¨å®¹'},
                {scene:'æ¥¼æ¢¯å£', line:`"æˆ‘ä¸æ˜¯ä¸æƒ³è¯´ã€‚æ˜¯æ€•è¯´äº†ï¼Œä½ ç”¨é‚£ç§çœ¼ç¥çœ‹æˆ‘ã€‚"`, mood:'è„†å¼±'},
                {scene:'å¤©å°å¤œæ™š', line:`"ä½ æ˜¯ç¬¬ä¸€ä¸ªâ€¦â€¦ä¸é—®åŸå› ã€ä¸ç»™å»ºè®®ã€åªæ˜¯åœ¨çš„äººã€‚"`, mood:'è¢’éœ²'}
            ]
        }
    };

    function showDeepCrushDialog(cid) {
        if(stuGame.energy < 5) return showToast("ç²¾åŠ›ä¸è¶³ï¼ˆéœ€è¦5ç‚¹ï¼‰");
        if(!stuGame.crushes[cid]) return showToast("å…ˆå»è®¤è¯†å¥¹/ä»–å§ï¼");
        stuGame.energy -= 5;
        let ch = CRUSHES.find(x=>x.id===cid);
        let aff = (stuGame.crushes[cid]&&stuGame.crushes[cid].aff)||0;
        let tier = aff>=70?'high':aff>=35?'mid':'low';
        let pool = DEEP_CRUSH_DIALOGUES[cid][tier];
        let entry = pool[Math.floor(Math.random()*pool.length)];
        let prof = CRUSH_PROFILES[cid];
        let moodColor = {å¿ƒåŠ¨:'#db2777',æ·±æƒ…:'#7c3aed',è„†å¼±:'#6366f1',ä¿¡ä»»:'#0284c7',è¢’éœ²:'#0891b2',çœŸå®:'#0f766e',è¯•æ¢:'#b45309',ç¾æ¶©:'#be185d',æœŸå¾…:'#7c3aed',åœ¨æ„:'#0369a1',ä¾èµ–:'#0369a1',å¤§èƒ†:'#7c3aed',æš—ç¤º:'#92400e',å…³æ³¨:'#065f46',ä¸»åŠ¨:'#059669',æƒŠè®¶:'#1d4ed8',è­¦æƒ•:'#475569',å†·æ·¡:'#475569',ç–è¿œ:'#64748b',æˆ’å¤‡:'#475569',é˜²å¾¡:'#475569',éšæ„:'#64748b',æ¼«ä¸ç»å¿ƒ:'#94a3b8',æ— è§†:'#9ca3af',æ„å¤–:'#b45309',ç´§å¼ :'#b45309',å°é—­:'#475569',å†·æ¼ :'#94a3b8',åŠ¨å®¹:'#0891b2',æŠ—æ‹’:'#dc2626'}[entry.mood]||'#475569';

        // æ„å»ºæƒ…æ™¯ç”»é¢
        let sceneHtml = `<div style="background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:12px;padding:16px 18px;margin-bottom:14px;position:relative;overflow:hidden;">
            <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:${prof.color}08;pointer-events:none;"></div>
            <div style="display:flex;gap:14px;align-items:flex-start;">
                <div style="flex-shrink:0;text-align:center;">
                    <div style="width:56px;height:72px;border-radius:10px;background:${prof.color}22;border:2px solid ${prof.color}55;display:flex;align-items:center;justify-content:center;">
                        <span style="font-size:2.2rem;">${prof.icon}</span>
                    </div>
                    <div style="margin-top:5px;font-size:0.6rem;color:${moodColor};font-weight:900;letter-spacing:1px;text-shadow:0 0 8px ${moodColor};">${entry.mood}</div>
                </div>
                <div style="flex:1;">
                    <div style="font-size:0.68rem;color:#64748b;margin-bottom:8px;letter-spacing:1px;">ğŸ“ ${entry.scene}</div>
                    <div style="background:#f8fafc;border-left:4px solid ${prof.color};padding:12px 14px;border-radius:0 10px 10px 0;">
                        <p style="margin:0;font-size:0.93rem;color:#1e293b;line-height:1.8;font-style:italic;">${entry.line}</p>
                    </div>
                </div>
            </div>
        </div>`;

        // æ„å»ºæœ‰æ¡ä»¶çš„å›åº”é€‰é¡¹
        let options = CRUSH_SCENE_OPTIONS[cid] ? (CRUSH_SCENE_OPTIONS[cid][tier] || []) : [];
        // åŠ ä¸Šé€šç”¨é€‰é¡¹
        options = options.concat(CRUSH_COMMON_OPTIONS[tier] || []);

        let btns = options.map(opt => {
            let canDo = !opt.req || opt.req();
            return {
                text: canDo ? opt.label : `ğŸ”’ ${opt.label} <span style="font-size:0.7rem;color:#94a3b8;">[${opt.reqDesc}]</span>`,
                action: canDo ? () => {
                    let data = stuGame.crushes[cid];
                    data.aff = Math.max(0, Math.min(100, data.aff + opt.effect));
                    if(opt.cost) stuGame.energy = Math.max(0, stuGame.energy - opt.cost);
                    if(opt.fn) opt.fn();
                    // å±•ç¤ºå›åº”å¯¹è¯ï¼ˆä¸é€éœ²å¥½æ„Ÿå˜åŒ–æ•°å€¼ï¼‰
                    let respHtml = `<div style="background:#f8fafc;border-left:3px solid ${prof.color};padding:12px 14px;border-radius:0 8px 8px 0;margin-bottom:10px;">
                        <p style="margin:0;font-size:0.9rem;color:#1e293b;line-height:1.7;font-style:italic;">"${opt.reply}"</p>
                    </div>
                    <div style="font-size:0.78rem;color:#94a3b8;text-align:center;">${opt.outcome}</div>`;
                    showCustomModal(`ğŸ’¬ ${ch.name} çš„å›åº”`, respHtml, [{text:'å¥½çš„', action:()=>{ checkCrushBuff(cid); renderStuCrushes(); updateStuUI(); }}]);
                } : () => { showToast(opt.reqDesc || 'æ¡ä»¶ä¸æ»¡è¶³'); }
            };
        });
        btns.push({text:'â€¦â€¦è¿˜æ˜¯ç®—äº†', action:()=>{ renderStuCrushes(); updateStuUI(); }});

        showCustomModal(`ğŸ’¬ ä¸ ${ch.name} çš„åœºæ™¯`, sceneHtml, btns);
    }

    // ===== åœºæ™¯å¯¹è¯é€‰é¡¹ç³»ç»Ÿ =====
    const CRUSH_SCENE_OPTIONS = {
        'lin': {
            low: [
                { label:'ä¸»åŠ¨å€Ÿå¥¹ç¬”è®°', reqDesc:'', effect: 3, reply:'â€¦â€¦å¯ä»¥ã€‚ä½†ä½ ç”¨å®Œè¦è¿˜æˆ‘ï¼Œè€Œä¸”ä¸èƒ½æŠ˜è§’ã€‚', outcome:'å¥¹æŒ‘äº†æŒ‘çœ‰ï¼Œå‹‰å¼ºç®—æ˜¯æ¥å—äº†ä½ ã€‚' },
                { label:'æå‡ºä¸€èµ·å¤‡è€ƒ', reqDesc:'å­¦ä¸šâ‰¥50', req:()=>stuGame.grade>=50, effect: 8, cost:5,
                  reply:'ä½ æˆç»©â€¦â€¦å—¯ï¼Œè¿˜è¡Œã€‚é‚£å°±â€¦â€¦æ¯å‘¨äºŒæ™šä¸Šï¼Œå›¾ä¹¦é¦†ä¸‰æ¥¼ã€‚', outcome:'å¥¹çœ‹äº†ä½ ä¸€çœ¼ï¼Œçœ‹èµ·æ¥è®¤ä¸ºä½ è¿˜ä¸ç®—æµªè´¹æ—¶é—´ã€‚' },
                { label:'æ‚„æ‚„æ”¾ä¸€é¦–å¥¹å–œæ¬¢çš„è¯—åœ¨å¥¹æ¡Œä¸Š', reqDesc:'è‰ºæœ¯â‰¥40', req:()=>stuGame.art>=40, effect: 12, cost:0,
                  reply:'ï¼ˆæ²‰é»˜è®¸ä¹…ï¼‰â€¦â€¦ä½ æ€ä¹ˆçŸ¥é“æˆ‘å–œæ¬¢è¿™é¦–ã€‚', outcome:'å¥¹æŠŠé‚£å¼ çº¸å¤¹è¿›äº†è¯¾æœ¬é‡Œã€‚' },
            ],
            mid: [
                { label:'è®¤çœŸå¬å¥¹è®²é¢˜ï¼Œæå‡ºæ–°æ€è·¯', reqDesc:'å­¦ä¸šâ‰¥65', req:()=>stuGame.grade>=65, effect: 10, cost:5,
                  reply:'â€¦â€¦è¿™ä¸ªè§’åº¦æˆ‘æ²¡æƒ³åˆ°ã€‚ï¼ˆåœé¡¿ï¼‰â€¦â€¦ä½ æœ€è¿‘è¿›æ­¥å¾ˆå¿«ã€‚', outcome:'å¥¹ç¬¬ä¸€æ¬¡æ­£çœ¼çœ‹ä½ è¶…è¿‡ä¸‰ç§’ã€‚' },
                { label:'åœ¨å¤©å°é™ªå¥¹çœ‹æ˜Ÿæ˜Ÿï¼Œä»€ä¹ˆéƒ½ä¸è¯´', reqDesc:'', effect: 7, reply:'â€¦â€¦ä½ ä¸è§‰å¾—æ— èŠå—ï¼Ÿï¼ˆåœé¡¿ï¼‰â€¦â€¦æˆ‘å…¶å®ä¸ä»‹æ„ä½ åœ¨ã€‚', outcome:'æ²‰é»˜æœ‰æ—¶å€™æ¯”ä»»ä½•è¯éƒ½æœ‰åˆ†é‡ã€‚' },
                { label:'å‘Šè¯‰å¥¹ä½ è¯»äº†å¥¹å†™çš„è¯—', reqDesc:'å¥½æ„Ÿâ‰¥45', req:()=>aff>=45, effect: 15, cost:5,
                  reply:'ï¼ˆè„¸çº¢ï¼‰â€¦â€¦ä½ æ€ä¹ˆçœ‹åˆ°çš„ã€‚é‚£â€¦â€¦ä½ è§‰å¾—å†™å¾—æ€ä¹ˆæ ·ã€‚', outcome:'å¥¹è¯•å›¾æ¿èµ·è„¸ï¼Œä½†æ²¡æœ‰æˆåŠŸã€‚' },
            ],
            high: [
                { label:'è¯´ï¼šæ— è®ºç»“æœå¦‚ä½•ï¼Œæˆ‘éƒ½ä¼šåœ¨', reqDesc:'', effect: 8, reply:'â€¦â€¦ï¼ˆä½å¤´ï¼‰è¿™ç§è¯â€¦â€¦ä¸èƒ½éšä¾¿è¯´çš„ã€‚ï¼ˆåœé¡¿ï¼‰â€¦â€¦ä½†è°¢è°¢ä½ ã€‚', outcome:'å¥¹æ²¡æœ‰æŠ¬å¤´ï¼Œä½†ä½ çœ‹åˆ°å¥¹çš„è€³å°–çº¢äº†ã€‚' },
                { label:'é‚€è¯·å¥¹é«˜è€ƒåä¸€èµ·å»çœ‹æ—¥å‡º', reqDesc:'å­¦ä¸šâ‰¥80ä¸”å¥½æ„Ÿâ‰¥70', req:()=>stuGame.grade>=80&&aff>=70, effect: 18, cost:10,
                  reply:'â€¦â€¦ï¼ˆå¾ˆé•¿çš„æ²‰é»˜ï¼‰é«˜è€ƒç»“æŸçš„é‚£å¤©æ—©ä¸Šâ€¦â€¦å¥½ã€‚', outcome:'è¿™æ˜¯å¥¹ç¬¬ä¸€æ¬¡ä¸»åŠ¨ç­”åº”ä½ çš„é‚€è¯·ã€‚' },
                { label:'å¸®å¥¹æ•´ç†å¥¹ä»æœªç»™äººçœ‹è¿‡çš„è¯—é›†', reqDesc:'å¥½æ„Ÿâ‰¥80', req:()=>aff>=80, effect: 20, cost:0,
                  reply:'ï¼ˆé¢¤æŠ–ï¼‰â€¦â€¦è¿™æ˜¯â€¦â€¦è°¢è°¢ä½ ï¼Œè®¤çœŸå¯¹å¾…å®ƒä»¬ã€‚', outcome:'ä½ çŸ¥é“è¿™æ„å‘³ç€ä»€ä¹ˆã€‚å¥¹ä¹ŸçŸ¥é“ã€‚' },
            ]
        },
        'xia': {
            low: [
                { label:'å®‰é™æ—è§‚å¥¹ç”»ç”»ï¼Œä¸æ‰“æ‰°', reqDesc:'', effect: 5, reply:'â€¦â€¦ä½ ä¸èµ°äº†ï¼Ÿéšä½ ã€‚ï¼ˆç»§ç»­ç”»ï¼‰', outcome:'å¥¹æ²¡æœ‰èµ¶ä½ èµ°ã€‚è¿™å·²ç»å¾ˆéš¾å¾—ã€‚' },
                { label:'çœŸè¯šå¤¸å¥¹çš„ç”»å¾ˆç‰¹åˆ«', reqDesc:'è‰ºæœ¯â‰¥35', req:()=>stuGame.art>=35, effect: 10, reply:'â€¦â€¦å“¼ï¼Œä½ æ‡‚ç”»å—ï¼Ÿï¼ˆåœé¡¿ï¼‰â€¦â€¦ä½†è°¢è°¢ã€‚', outcome:'å¥¹æŠŠç”»ç¬”æ¢äº†ä¸ªå§¿åŠ¿æ¡ï¼Œå‡è£…è‹¥æ— å…¶äº‹ã€‚' },
                { label:'åˆ†äº«ä¸€ä¸ªå†·é—¨çš„åœ°ä¸‹ä¹é˜Ÿç»™å¥¹', reqDesc:'è‰ºæœ¯â‰¥50', req:()=>stuGame.art>=50, effect: 14, cost:5, reply:'â€¦â€¦ç­‰ç­‰ï¼Œä½ ä¹ŸçŸ¥é“è¿™ä¸ªï¼Ÿï¼ˆæ„£äº†ä¸€ä¸‹ï¼‰â€¦â€¦è¿˜æŒºæœ‰å“ä½çš„ã€‚', outcome:'å¥¹ç¬¬ä¸€æ¬¡å¯¹ä½ å±•éœ²å‡ºçœŸå®çš„è¡¨æƒ…ã€‚' },
            ],
            mid: [
                { label:'è¡¨ç¤ºæ„¿æ„ä¸ºå¥¹çš„ç”»å±•å½“å¿—æ„¿è€…', reqDesc:'', effect: 8, reply:'â€¦â€¦ä½ ä¸æ€•æ— èŠå—ï¼Ÿï¼ˆåœé¡¿ï¼‰â€¦â€¦è¡Œï¼Œä½†åˆ«å¸®å€’å¿™ã€‚', outcome:'å¥¹åœ¨ä½ é¢å¤´ä¸Šç‚¹äº†æ ¹è®°å·ç¬”ï¼Œç®—æ˜¯ç™»è®°åœ¨å†Œã€‚' },
                { label:'é™ªå¥¹å‚åŠ æ·±å¤œå†™ç”Ÿ', reqDesc:'ä½“è´¨â‰¥40', req:()=>stuGame.fit>=40, effect: 12, cost:5,
                  reply:'â€¦â€¦ä½ ä¸æ€•å†·å—ï¼Ÿï¼ˆæŠŠå›´å·¾çš„ä¸€ç«¯é€’ç»™ä½ ï¼‰å‡‘åˆç”¨å§ã€‚', outcome:'ä½ ä»¬èƒŒé èƒŒåç€ï¼Œç›´åˆ°å¤©è¾¹æ³›å‡ºé±¼è‚šç™½ã€‚' },
                { label:'ä¹°ä¸‹å¥¹ç¬¬ä¸€æ¬¡å‚å±•çš„ä¹ ä½œ', reqDesc:'é›¶èŠ±é’±â‰¥300', req:()=>stuGame.money>=300, effect: 20, cost:0, fn:()=>{stuGame.money-=300;},
                  reply:'â€¦â€¦ä½ â€¦â€¦ä¸ºä»€ä¹ˆè¦ä¹°è¿™ä¸ªï¼Œè¿™åªæ˜¯ä¹ ä½œâ€”â€”ï¼ˆå“‘äº†å£°éŸ³ï¼‰â€¦â€¦è°¢è°¢ã€‚', outcome:'å¥¹æŠŠæ‰¾é›¶ç¡¬å¡ç»™ä½ ï¼Œä½†çœ¼çœ¶æ˜¯çº¢çš„ã€‚' },
            ],
            high: [
                { label:'è¯´ï¼šä½ çš„ç”»é‡Œæˆ‘çœ‹åˆ°äº†ä½ ', reqDesc:'å¥½æ„Ÿâ‰¥60', req:()=>aff>=60, effect: 10, reply:'â€¦â€¦ï¼ˆåœäº†ç¬”ï¼‰â€¦â€¦é‚£ä½ çœ‹åˆ°äº†ä»€ä¹ˆã€‚ï¼ˆè®¤çœŸåœ°é—®ï¼‰', outcome:'å¥¹æ”¾ä¸‹äº†é˜²å¾¡ï¼Œç¬¬ä¸€æ¬¡æƒ³çŸ¥é“ä½ çœ¼é‡Œçš„å¥¹ã€‚' },
                { label:'ç­”åº”å»ç±³å…°çœ‹å¥¹çš„ä¸ªå±•', reqDesc:'å¥½æ„Ÿâ‰¥75', req:()=>aff>=75, effect: 18, cost:0,
                  reply:'â€¦â€¦ï¼ˆæ²‰é»˜å¾ˆä¹…ï¼‰ä½ è¯´è¯ç®—æ•°å—ï¼Ÿï¼ˆåœé¡¿ï¼‰â€¦â€¦æˆ‘ä¼šç»™ä½ ç•™ç¥¨çš„ã€‚', outcome:'å¥¹è½¬è¿‡èº«ï¼Œç¬‘äº†ã€‚æ˜¯é‚£ç§ä½ å¾ˆå°‘è§åˆ°çš„ã€ä¸å¸¦é˜²å¤‡çš„ç¬‘ã€‚' },
                { label:'åœ¨å¥¹æœ€ä½è½æ—¶å¸®å¥¹å®Œæˆä¸€å¹…ç”»', reqDesc:'è‰ºæœ¯â‰¥70ä¸”å¥½æ„Ÿâ‰¥80', req:()=>stuGame.art>=70&&aff>=80, effect: 25, cost:10,
                  reply:'â€¦â€¦è¿™ä¸€ç¬”â€¦â€¦æ˜¯ä½ åŠ çš„ã€‚ï¼ˆæ”¾ä¸‹ç¬”ï¼‰â€¦â€¦ä½ ç”»çš„ï¼Œå’Œæˆ‘çš„æ„Ÿè§‰ä¸€æ ·ã€‚', outcome:'ä½ ä»¬è°éƒ½æ²¡è¯´è¯ï¼Œä½†æŸç§ä¸œè¥¿å·²ç»ä¸éœ€è¦è¨€è¯­äº†ã€‚' },
            ]
        },
        'jiang': {
            low: [
                { label:'åœ¨ç¯®çƒåœºè¾¹é¼“æŒ', reqDesc:'', effect: 3, reply:'å“ˆï¼Œè°¢å•Šï¼ä»Šå¤©çŠ¶æ€è¿˜è¡Œå§ï¼Ÿ', outcome:'ä»–éšå£ä¸€è¯´ï¼Œä½†å·²ç»è®°ä½ä½ åœ¨åœºäº†ã€‚' },
                { label:'å’Œä»–è°ˆè®ºNBA', reqDesc:'', effect: 7, reply:'çœŸçš„å‡çš„ä½ ä¹Ÿçœ‹ï¼å“ªé˜Ÿçš„ï¼Ÿï¼ˆç«‹åˆ»æ¥äº†ç²¾ç¥ï¼‰', outcome:'ä»–æŠŠä½ å½“æˆäº†"è‡ªå·±äºº"ã€‚' },
                { label:'å¸®ä»–æŠŠå—ä¼¤çš„å³æ‰‹åŒ…æ‰', reqDesc:'ä½“è´¨â‰¥45', req:()=>stuGame.fit>=45, effect: 12, cost:5,
                  reply:'â€¦â€¦æˆ‘è¯´æˆ‘æ²¡äº‹ã€‚ï¼ˆä½†ä»–æ²¡æœ‰ç¼©æ‰‹ï¼‰â€¦â€¦è°¢äº†ï¼Œåˆ«å£°å¼ ã€‚', outcome:'ä»–ç¬¬ä¸€æ¬¡åœ¨ä½ é¢å‰æ‰¿è®¤äº†è½¯å¼±ã€‚' },
            ],
            mid: [
                { label:'åœ¨ä»–å¤±åˆ©çš„æ¯”èµ›åé™ªä»–ååœ¨çƒåœº', reqDesc:'', effect: 8, reply:'ï¼ˆé•¿æ—¶é—´æ²‰é»˜ï¼‰â€¦â€¦ä½ ä¸è¯´è¯å•Šï¼Ÿï¼ˆåœé¡¿ï¼‰â€¦â€¦å…¶å®æŒºå¥½çš„ã€‚', outcome:'ä»–æ‹äº†æ‹ä½ çš„è‚©ï¼Œæ²¡æœ‰å¤šè¯´ã€‚æœ‰äº›äº‹ä¸éœ€è¦è¯´ã€‚' },
                { label:'å¸®ä»–æ‚„æ‚„è”ç³»è¿åŠ¨åŒ»å­¦åŒ»ç”Ÿ', reqDesc:'é›¶èŠ±é’±â‰¥200', req:()=>stuGame.money>=200, effect: 18, fn:()=>{stuGame.money-=200;},
                  reply:'â€¦â€¦è¿™æ˜¯æ€ä¹ˆæçš„â€¦â€¦ï¼ˆçœ‹ä½ ï¼‰â€¦â€¦ä½ ä¸ºä»€ä¹ˆè¦â€¦â€¦è°¢è°¢ä½ ï¼Œè®¤çœŸçš„ã€‚', outcome:'ä»–æ²‰é»˜äº†å¾ˆä¹…ï¼Œæœ€åæ¶äº†ä½ ä¸€ä¸‹ï¼Œç®—æ˜¯é“è°¢ã€‚' },
                { label:'å¸¦ä»–å»åƒä»–æœ€çˆ±çš„çƒ§çƒ¤', reqDesc:'é›¶èŠ±é’±â‰¥150', req:()=>stuGame.money>=150, effect: 10, fn:()=>{stuGame.money-=150;},
                  reply:'ä½ è¯·å®¢ï¼Ÿè¡Œï¼Œæˆ‘ä¸å®¢æ°”å•Šï¼ï¼ˆå¤§ç¬‘ï¼‰ä½†ä¸‹æ¬¡æ¢æˆ‘ã€‚', outcome:'ä»–åƒå¾—å¾ˆå¼€å¿ƒã€‚ä»–å¼€å¿ƒä½ ä¹Ÿå¼€å¿ƒã€‚' },
            ],
            high: [
                { label:'è¯´ï¼šå“ªæ€•ä½ ä¸æ‰“çƒï¼Œä½ ä¹Ÿæ˜¯ä½ ', reqDesc:'å¥½æ„Ÿâ‰¥65', req:()=>aff>=65, effect: 12, reply:'â€¦â€¦ï¼ˆæ„£äº†å¾ˆä¹…ï¼‰â€¦â€¦ä½ è¯´çš„æ˜¯çœŸçš„å—ã€‚ï¼ˆåœé¡¿ï¼‰â€¦â€¦è°¢äº†ã€‚', outcome:'ä»–æ²¡æœ‰è½¬ç§»è¯é¢˜ï¼Œè€Œæ˜¯è®¤çœŸåœ°çœ‹äº†ä½ ä¸€çœ¼ã€‚' },
                { label:'åœ¨ä»–å†³èµ›å‰å·å·æŠŠå¹¸è¿ç‰©å¡è¿›ä»–åŒ…é‡Œ', reqDesc:'å¥½æ„Ÿâ‰¥75', req:()=>aff>=75, effect: 15, cost:0,
                  reply:'ï¼ˆèµ›åï¼‰è¿™æ˜¯â€¦â€¦ä½ æ”¾çš„ï¼Ÿï¼ˆæ¡ä½ï¼‰â€¦â€¦æˆ‘æ•´åœºéƒ½æ„Ÿè§‰ä½ åœ¨çœ‹ç€æˆ‘ã€‚', outcome:'ä»–è¯´è¿™è¯çš„æ—¶å€™ï¼Œè€³æ ¹æœ‰ç‚¹çº¢ã€‚' },
                { label:'å¤§å£°å–Šä»–åå­—ä¸ºä»–æ‰“æ°”', reqDesc:'ä½“è´¨â‰¥60ä¸”å¥½æ„Ÿâ‰¥80', req:()=>stuGame.fit>=60&&aff>=80, effect: 20, cost:0,
                  reply:'ï¼ˆèµ›åæ‹‰ä½ä½ ï¼‰åˆšæ‰é‚£å£°å–Šâ€¦â€¦æˆ‘åœ¨åœºä¸Šå¬åˆ°äº†ã€‚ï¼ˆå’§å˜´ç¬‘ï¼‰â€¦â€¦åŠ æ²¹æˆ‘ã€‚', outcome:'ä»–æŠŠæ‰‹æ­åœ¨ä½ è‚©ä¸Šï¼Œç¬‘å¾—å¾ˆç¿çƒ‚ã€‚ä½ å¿ƒè·³æ¼äº†ä¸€æ‹ã€‚' },
            ]
        },
        'shen': {
            low: [
                { label:'é™é™ååœ¨å¥¹æ—è¾¹ï¼Œä¸è¯´è¯', reqDesc:'', effect: 4, reply:'â€¦â€¦ï¼ˆæ²¡æœ‰ç¦»å¼€ï¼‰', outcome:'å¥¹æ²¡æœ‰èµ°ã€‚è¿™æ¯”ä»»ä½•è¯éƒ½é‡è¦ã€‚' },
                { label:'æŠŠè€³æœºæ¥å£åˆ†ç»™å¥¹ï¼Œä¸€èµ·å¬éŸ³ä¹', reqDesc:'è‰ºæœ¯â‰¥30', req:()=>stuGame.art>=30, effect: 8, reply:'â€¦â€¦ä½ å¬è¿™ä¸ªï¼Ÿï¼ˆåœé¡¿ï¼‰â€¦â€¦è¿˜è¡Œã€‚', outcome:'å¥¹æ‘˜ä¸‹äº†ä¸€è¾¹è€³æœºï¼ŒæŠŠå¦ä¸€è¾¹ç»™äº†ä½ ã€‚' },
                { label:'å¸®å¥¹å¼Ÿå¼Ÿçš„å­¦æ ¡äº‹åŠ¡', reqDesc:'å­¦ä¸šâ‰¥55', req:()=>stuGame.grade>=55, effect: 15, cost:10,
                  reply:'â€¦â€¦ä½ æ€ä¹ˆçŸ¥é“æˆ‘å¼Ÿçš„äº‹ã€‚ï¼ˆåœé¡¿ï¼‰â€¦â€¦è°¢è°¢ã€‚ä¸ç”¨ä½ ç®¡çš„ã€‚', outcome:'å¥¹èƒŒå¯¹ä½ è¯´è°¢è°¢ï¼Œå£°éŸ³å¾ˆå°ï¼Œä½†æ˜¯çœŸçš„ã€‚' },
            ],
            mid: [
                { label:'æ·±å¤œä¸€èµ·åœ¨ä¾¿åˆ©åº—åƒçƒ­å…³ä¸œç…®', reqDesc:'é›¶èŠ±é’±â‰¥100', req:()=>stuGame.money>=100, effect: 10, fn:()=>{stuGame.money-=100;},
                  reply:'â€¦â€¦ä½ è¯·æˆ‘åƒï¼Ÿï¼ˆåœé¡¿ï¼‰â€¦â€¦å¥½ã€‚ä¸‹æ¬¡æˆ‘è¯·ã€‚', outcome:'å¥¹è¯´äº†"ä¸‹æ¬¡"ï¼Œè¿™æ„å‘³ç€å¥¹å·²ç»æŠŠä½ ç®—è¿›äº†å¥¹çš„è®¡åˆ’é‡Œã€‚' },
                { label:'æ‚„æ‚„æ›¿å¥¹å«ä»˜å¼Ÿå¼Ÿä¸€ä¸ªæœˆçš„é¥­é’±', reqDesc:'é›¶èŠ±é’±â‰¥500', req:()=>stuGame.money>=500, effect: 22, fn:()=>{stuGame.money-=500;},
                  reply:'â€¦â€¦ï¼ˆå¾ˆé•¿çš„æ²‰é»˜ï¼‰ä½ â€¦â€¦ä¸ºä»€ä¹ˆè¦è¿™æ ·åšã€‚ï¼ˆçœ¼çœ¶å‘çº¢ï¼‰â€¦â€¦æˆ‘ä¼šè¿˜ä½ çš„ã€‚', outcome:'å¥¹æ²¡æœ‰æ‹’ç»ã€‚è¿™å¯¹å¥¹æ¥è¯´å·²ç»æ˜¯è«å¤§çš„ä¿¡ä»»ã€‚' },
                { label:'å‘Šè¯‰å¥¹ï¼šä½ ä¸éœ€è¦è§£é‡Šï¼Œæˆ‘ä¸ä¼šè¯„åˆ¤ä½ ', reqDesc:'å¥½æ„Ÿâ‰¥40', req:()=>aff>=40, effect: 12, cost:0,
                  reply:'â€¦â€¦ï¼ˆåœé¡¿å¾ˆä¹…ï¼‰ä½ è¯´è¿™è¯â€¦â€¦æ˜¯è®¤çœŸçš„å—ï¼Ÿï¼ˆä½å£°ï¼‰â€¦â€¦é‚£â€¦â€¦è°¢è°¢ä½ ã€‚', outcome:'å¥¹ç¬¬ä¸€æ¬¡æŠ¬èµ·å¤´ï¼Œè®¤çœŸåœ°çœ‹äº†ä½ ã€‚' },
            ],
            high: [
                { label:'é™ªå¥¹èµ°é‚£æ¡å›æ‰“å·¥å¤„çš„è·¯', reqDesc:'ä½“è´¨â‰¥50ä¸”å¥½æ„Ÿâ‰¥65', req:()=>stuGame.fit>=50&&aff>=65, effect: 15, cost:5,
                  reply:'â€¦â€¦ï¼ˆèµ°äº†å¾ˆä¹…æ‰å¼€å£ï¼‰è¿™æ¡è·¯å¾ˆæ— èŠçš„ã€‚ï¼ˆåœé¡¿ï¼‰â€¦â€¦è°¢è°¢ä½ é™ªæˆ‘èµ°ã€‚', outcome:'ä½ ä»¬è°éƒ½æ²¡å†è¯´è¯ã€‚ä½†é‚£æ®µè·¯æ¯”ä»¥å¾€ä»»ä½•æ—¶å€™éƒ½çŸ­ã€‚' },
                { label:'é€å¥¹ä¸€å‰¯è€³æœºï¼Œè¯´ï¼šä½ å€¼å¾—æ›´å¥½çš„å£°éŸ³', reqDesc:'é›¶èŠ±é’±â‰¥400ä¸”å¥½æ„Ÿâ‰¥75', req:()=>stuGame.money>=400&&aff>=75, effect: 20, fn:()=>{stuGame.money-=400;},
                  reply:'â€¦â€¦ï¼ˆæ‘¸ç€è€³æœºï¼Œæ²‰é»˜ï¼‰â€¦â€¦ä½ â€¦â€¦ï¼ˆä½ä¸‹å¤´ï¼‰â€¦â€¦è°¢è°¢ä½ ã€‚æˆ‘ä¼šå¥½å¥½ç”¨çš„ã€‚', outcome:'å¥¹æŠŠæ—§è€³æœºæ”¶è¿›äº†å£è¢‹ï¼Œè€Œä¸æ˜¯æ‰”æ‰ã€‚ä½ çŸ¥é“é‚£ä»£è¡¨ä»€ä¹ˆã€‚' },
                { label:'å‘Šè¯‰å¥¹ï¼šå¼Ÿå¼Ÿçš„äº‹ï¼Œæˆ‘ä»¬ä¸€èµ·æƒ³åŠæ³•', reqDesc:'å¥½æ„Ÿâ‰¥85', req:()=>aff>=85, effect: 25, cost:0,
                  reply:'â€¦â€¦ï¼ˆå“‘äº†ï¼‰â€¦â€¦"æˆ‘ä»¬"ï¼Ÿï¼ˆåœé¡¿å¾ˆä¹…ï¼Œå£°éŸ³é¢¤æŠ–ï¼‰â€¦â€¦ä½ çŸ¥é“ä½ åœ¨è¯´ä»€ä¹ˆå—ã€‚', outcome:'è¿™æ˜¯å¥¹ç¬¬ä¸€æ¬¡å“­ã€‚å¥¹èƒŒå¯¹ç€ä½ å“­ï¼Œä½†å¥¹æ²¡æœ‰ç¦»å¼€ã€‚' },
            ]
        }
    };

    const CRUSH_COMMON_OPTIONS = {
        low: [
            { label:'å®‰é™åœ°çœ‹ç€å¥¹/ä»–ï¼Œä»€ä¹ˆéƒ½æ²¡åš', reqDesc:'', effect: 1, reply:'â€¦â€¦ï¼Ÿ', outcome:'ä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿï¼Œä½†ä½ åœ¨å¥¹/ä»–çœ¼é‡Œç•™ä¸‹äº†ä¸€ä¸ªæ¨¡ç³Šçš„å°è±¡ã€‚' },
        ],
        mid: [
            { label:'åˆ†äº«ä»Šå¤©é‡åˆ°çš„ä¸€ä»¶å°äº‹', reqDesc:'', effect: 4, reply:'â€¦â€¦ï¼ˆåœé¡¿ï¼‰â€¦â€¦ç„¶åå‘¢ï¼Ÿ', outcome:'å¥¹/ä»–å¼€å£é—®äº†ï¼Œå°±è¯´æ˜è¿˜æƒ³å¬ä¸‹å»ã€‚' },
        ],
        high: [
            { label:'ä»€ä¹ˆéƒ½ä¸è¯´ï¼Œåªæ˜¯å¾…åœ¨å¥¹/ä»–èº«è¾¹', reqDesc:'', effect: 6, reply:'â€¦â€¦ï¼ˆåœé¡¿ï¼‰â€¦â€¦ä½ ä»Šå¤©ä¸è¯´è¯ã€‚ï¼ˆåœé¡¿ï¼‰â€¦â€¦å…¶å®æŒºå¥½çš„ã€‚', outcome:'æœ‰äº›æ—¶åˆ»ï¼Œå­˜åœ¨æœ¬èº«å°±æ˜¯ç­”æ¡ˆã€‚' },
        ]
    };
    
    function adjustSchedule(t) {
        let val = parseInt(document.getElementById('range-'+t).value);
        game.schedule[t] = val;
        document.getElementById('lbl-'+t+'-hr').innerText = val + "èŠ‚";
        
        let total = game.schedule.main + game.schedule.minor + game.schedule.spec;
        document.getElementById('sch-total-hr').innerText = total;
        let warnBox = document.getElementById('sch-warn-box');
        if(total > 50) { warnBox.style.display='block'; warnBox.innerHTML='âš ï¸ <b>æåº¦å±é™©ï¼š</b>å­¦ç”Ÿæ¿’ä¸´çŒæ­»ï¼'; }
        else if(game.schedule.main > 25) { warnBox.style.display='block'; warnBox.innerHTML='âš ï¸ <b>å±é™©è­¦å‘Šï¼š</b>ä¸»ç§‘æ’è¯¾æ•°è‹¥è¶…è¿‡ <b>25èŠ‚</b>ï¼Œäº§ç”Ÿçš„æ€ç»´ç†µå¢å°†å‘ˆ<b>æŒ‡æ•°çº§çˆ†ç‚¸</b>ï¼'; }
        else { warnBox.style.display='none'; }
        updateUI();
    }

    function upgradeTeacher(k) { if(game.teachers[k]<2 && payCost(0,50)) { game.teachers[k]++; updateUI(); } }
    function triggerGaokao() { 
        let total = game.students;
        let baseScore = Math.min(750, game.grade * 6.5 + 120 + Math.random() * 30 - 15);
        game.lastGaokaoAvg = Math.floor(baseScore);
        
        let t_qb = Math.floor(total * (baseScore > 680 ? (baseScore-680)/350 : 0)); 
        let t_985 = Math.floor(total * (baseScore > 600 ? (baseScore-600)/320 : 0)); 
        let t_211 = Math.floor(total * (baseScore > 550 ? (baseScore-550)/280 : 0)); 
        let t_bk = Math.floor(total * (baseScore > 450 ? (baseScore-450)/240 : 0)); 
        let t_zk = Math.floor(total * (baseScore > 300 ? (baseScore-300)/200 : 0)); 
        t_985 = Math.max(0, t_985 - t_qb);
        t_211 = Math.max(0, t_211 - t_985 - t_qb);
        t_bk = Math.max(0, t_bk - t_211 - t_985 - t_qb);
        t_zk = Math.max(0, t_zk - t_bk - t_211 - t_985 - t_qb);
        let t_fail = Math.max(0, total - t_qb - t_985 - t_211 - t_bk - t_zk);
        
        let uplinePct = Math.floor((total - t_fail)/total*100);
        let repGain = t_qb * 5 + t_985 * 2 + t_211 * 1 + Math.floor(uplinePct * 2);
        game.reputation += repGain;
        
        game.gaokaoHistory.push({ year: game.year, avg: game.lastGaokaoAvg, qb: t_qb, rep985: t_985, p211: t_211, bk: t_bk, zk: t_zk, fail: t_fail, upline: uplinePct });
        
        let historyHtml = '';
        if(game.gaokaoHistory.length > 1) {
            historyHtml = `<div style="margin-top:15px; border-top:2px dashed #e2e8f0; padding-top:15px;">
                <h4 style="text-align:center; margin:0 0 10px 0; color:#1e293b;">ğŸ“ˆ å†å¹´é«˜è€ƒæ¸…åŒ—äººæ•°å¯¹æ¯”</h4>
                <div style="display:flex; align-items:flex-end; justify-content:space-around; height:120px; background:#f8fafc; border-radius:8px; padding:10px 5px 0; border:1px solid #e2e8f0;">`;
            let maxQb = Math.max(1, ...game.gaokaoHistory.map(h=>h.qb||0));
            game.gaokaoHistory.slice(-8).forEach(h => {
                let barH = Math.max(5, Math.floor((h.qb/Math.max(1,maxQb))*100));
                historyHtml += `<div style="display:flex;flex-direction:column;align-items:center;width:11%;">
                    <div style="font-size:0.6rem;color:#ef4444;font-weight:bold;">${h.qb}</div>
                    <div style="background:#ef4444;width:100%;height:${barH}px;border-radius:2px 2px 0 0;min-height:4px;"></div>
                    <div style="font-size:0.55rem;color:#64748b;margin-top:3px;">${h.year}</div>
                </div>`;
            });
            historyHtml += `</div></div>`;
        }
        
        let html = `
        <div class="chart-container" style="width:100%;">
            <div class="chart-col"><div class="chart-bar" style="background:#ef4444; height:${Math.max(2, (t_qb/total)*150)}px;">${t_qb}</div><div class="chart-label">æ¸…åŒ—</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#8b5cf6; height:${Math.max(2, (t_985/total)*150)}px;">${t_985}</div><div class="chart-label">985</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#3b82f6; height:${Math.max(2, (t_211/total)*150)}px;">${t_211}</div><div class="chart-label">211</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#10b981; height:${Math.max(2, (t_bk/total)*150)}px;">${t_bk}</div><div class="chart-label">ä¸€æœ¬</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#f59e0b; height:${Math.max(2, (t_zk/total)*150)}px;">${t_zk}</div><div class="chart-label">äºŒæœ¬</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#64748b; height:${Math.max(2, (t_fail/total)*150)}px;">${t_fail}</div><div class="chart-label">è½æ¦œ</div></div>
        </div>
        <p style="text-align:center;"><b>${game.year}å¹´é«˜è€ƒ</b> | å‡åˆ†: ${game.lastGaokaoAvg} | ä¸Šçº¿ç‡: ${uplinePct}% | å£°èª‰ +${repGain}</p>
        ${historyHtml}`;
        
        log(`ğŸ“ ${game.year}å¹´é«˜è€ƒæ­æ™“ï¼å‡åˆ†${game.lastGaokaoAvg}ï¼Œæ¸…åŒ—${t_qb}äººï¼Œä¸Šçº¿ç‡${uplinePct}%ï¼Œå£°èª‰+${repGain}`, "var(--success)");
        
        // æ ¡é•¿æ¨¡å¼ï¼šé«˜è€ƒç»“æœå¼¹çª—ï¼Œä¸è§¦å‘å­¦ç”Ÿç»“å±€
        showCustomModal(`ğŸ“ ${game.year}å¹´ Â· é«˜è€ƒæˆç»©å…¬å‘Š`, html, [{text:"ç¡®è®¤å½’æ¡£", action:updateUI}]);
    }
    function triggerEnrollment() { showCustomModal("å¼€å­¦", "ä¹æœˆæ–°å­¦æœŸå¼€å§‹ï¼Œè¿æ¥æ–°ç”Ÿä¸æ–°ç”Ÿå­¦è´¹ï¼", [{text:"OK", action:updateUI}]); }

    // ================= æˆ˜æ–—å·è½´ç³»ç»Ÿ =================
    const SCROLLS = [
        { id:'sc_basic',   name:'å¸¸è§„æˆ˜å¼ºåŒ–å·', desc:'æ”»å‡»+10%ï¼ˆé»˜è®¤è£…å¤‡ï¼‰', icon:'ğŸ“œ', atkMult:1.10, cost:0,   costType:'free', owned:true,  req:()=>true },
        { id:'sc_adv',     name:'å¼ºåŒ–å·', desc:'æ”»å‡»+20%', icon:'ğŸ“‹', atkMult:1.20, cost:50,  costType:'edu', owned:false, req:()=>true },
        { id:'sc_boss',    name:'BOSSå¯†å·', desc:'æš´å‡»+30%', icon:'ğŸ“—', critBonus:0.30, cost:80,  costType:'edu', owned:false, req:()=>game.levelIdx>=1 },
        { id:'sc_real',    name:'çœŸé¢˜å·', desc:'çœŸå®ä¼¤å®³ï¼Œæ— è§†50%é˜²å¾¡', icon:'ğŸ“•', trueReal:true, cost:120, costType:'edu', owned:false, req:()=>game.levelIdx>=2 },
        { id:'sc_multi',   name:'ç«èµ›å·', desc:'å¤šæ®µä¼¤å®³Ã—3ï¼ˆç¾¤ä½“æˆ˜ï¼‰', icon:'ğŸ“˜', multiHit:3, cost:150, costType:'edu', owned:false, req:()=>game.levelIdx>=3 },
    ];

    function getScrollData() {
        if(!game.scrolls) game.scrolls = { owned:['sc_basic'], equipped:'sc_basic' };
        return game.scrolls;
    }

    function getActiveScroll() {
        let sd = getScrollData();
        return SCROLLS.find(s=>s.id===sd.equipped) || SCROLLS[0];
    }

    // ================= ç»„åˆæŠ€ç³»ç»Ÿ =================
    const COMBO_RECIPES = [
        { id:'c01', name:'ç²¾ç¥å´©æºƒ',   desc:'æ•Œæ–¹å…¨ä½“æ™•çœ©2å›åˆ', ingredients:['sup_0','sup_3'], icon:'ğŸ§ ', effect:(p,e)=>{ e.buffs.stun=2; bLog("ğŸ’¥ ç²¾ç¥å´©æºƒï¼æ•Œæ–¹æ™•çœ©2å›åˆï¼"); } },
        { id:'c02', name:'æ™ºæ…§ç«èŠ±',   desc:'å…¨ä½“AP+10', ingredients:['sup_1','sup_2'], icon:'âœ¨', effect:(p,e)=>{ p.ap=Math.min(p.maxAp,p.ap+10); bLog("âœ¨ æ™ºæ…§ç«èŠ±ï¼AP+10ï¼"); } },
        { id:'c03', name:'é“å£é˜²å¾¡',   desc:'å·±æ–¹é˜²å¾¡Ã—2ï¼ŒæŒç»­3å›åˆ', ingredients:['def_0','def_1'], icon:'ğŸ›¡ï¸', effect:(p,e)=>{ p.buffs.defUp=3; bLog("ğŸ›¡ï¸ é“å£é˜²å¾¡ï¼é˜²å¾¡ç¿»å€3å›åˆï¼"); } },
        { id:'c04', name:'æ¯ç­æ‰“å‡»',   desc:'é€ æˆ500%çœŸå®ä¼¤å®³', ingredients:['atk_5','atk_13'], icon:'ğŸ’£', effect:(p,e)=>{ let dmg=Math.floor(bState.p.atk*5); e.hp-=dmg; bLog(`ğŸ’£ æ¯ç­æ‰“å‡»ï¼é€ æˆ${dmg}çœŸå®ä¼¤å®³ï¼`); } },
        { id:'c05', name:'å­¦éœ¸å‹åˆ¶',   desc:'æ•Œæ–¹æ”»å‡»-30%ï¼ŒæŒç»­5å›åˆ', ingredients:['atk_4','sup_3'], icon:'ğŸ‘“', effect:(p,e)=>{ e.buffs.atkDown=5; bLog("ğŸ‘“ å­¦éœ¸å‹åˆ¶ï¼æ•Œæ–¹æ”»å‡»å¤§é™5å›åˆï¼"); } },
        { id:'c06', name:'ç¥åœ£å…‰è¾‰',   desc:'æ»¡è¡€å¤æ´»+å…¨ä½“APæ¢å¤', ingredients:['sup_4','atk_2'], icon:'ğŸŒŸ', effect:(p,e)=>{ p.hp=p.maxHp; p.ap=p.maxAp; bLog("ğŸŒŸ ç¥åœ£å…‰è¾‰ï¼æ»¡è¡€å…¨APï¼"); } },
        { id:'c07', name:'ç†µå¢é£æš´',   desc:'æ•Œæ–¹å‹åŠ›+15ï¼Œæ··ä¹±3å›åˆ', ingredients:['entropy_add','sup_0'], icon:'ğŸŒ€', effect:(p,e)=>{ e.stress=Math.min(100,(e.stress||0)+15); e.buffs.stun=3; bLog("ğŸŒ€ ç†µå¢é£æš´ï¼æ··ä¹±3å›åˆï¼"); } },
        { id:'c08', name:'å‡ç†µå†²å‡»',   desc:'æ¶ˆé™¤å·±æ–¹è´Ÿé¢BUFF+æ”»å‡»+30%', ingredients:['entropy_clear','atk_1'], icon:'ğŸ’«', effect:(p,e)=>{ p.buffs.atkDown=0;p.buffs.dot=0;p.buffs.atkUp=3; bLog("ğŸ’« å‡ç†µå†²å‡»ï¼æ¸…é™¤è´Ÿé¢+æ”»å‡»å¤§å¹…æå‡ï¼"); } },
        { id:'c09', name:'é¢˜æµ·ç¢¾å‹',   desc:'4æ®µ100%ä¼¤å®³+æ•Œæ–¹é˜²å¾¡-50%', ingredients:['atk_4','atk_12'], icon:'ğŸ“š', effect:(p,e)=>{ for(let i=0;i<4;i++){let d=Math.floor(p.atk);e.hp-=d;} e.buffs.defDown=3; bLog("ğŸ“š é¢˜æµ·ç¢¾å‹ï¼4æ®µå…¨æ‰“+é˜²å¾¡å´©æºƒï¼"); } },
        { id:'c10', name:'æ•™ç ”è”åŠ¨',   desc:'æ•™ç ”ç‚¹+30ï¼Œä¸‹å›åˆAPå…¨æ»¡', ingredients:['atk_8','def_2'], icon:'ğŸ”¬', effect:(p,e)=>{ game.eduPoints+=30; p.ap=p.maxAp; bLog("ğŸ”¬ æ•™ç ”è”åŠ¨ï¼æ•™ç ”ç‚¹+30ï¼ŒAPæ»¡ï¼"); } },
        { id:'c11', name:'å¿ƒçµæ¶¤è¡',   desc:'å·±æ–¹å‹åŠ›æ¸…é›¶+HPå›å¤50%', ingredients:['sup_3','def_0'], icon:'ğŸ’', effect:(p,e)=>{ p.stress=0; p.hp=Math.min(p.maxHp,p.hp+Math.floor(p.maxHp*0.5)); bLog("ğŸ’ å¿ƒçµæ¶¤è¡ï¼å‹åŠ›å½’é›¶ï¼ŒHP+50%ï¼"); } },
        { id:'c12', name:'å¥¥èµ›é™ç»´',   desc:'æ— è§†é˜²å¾¡é€ æˆ300%ä¼¤å®³+æ™•çœ©', ingredients:['atk_10','atk_9'], icon:'ğŸ†', effect:(p,e)=>{ let d=Math.floor(p.atk*3); e.hp-=d; e.buffs.stun=1; bLog(`ğŸ† å¥¥èµ›é™ç»´ï¼${d}çœŸå®ä¼¤å®³+æ™•çœ©ï¼`); } },
        { id:'c13', name:'å…¨å†›çªå‡»',   desc:'åŒæ®µ250%ä¼¤å®³+å·±æ–¹æ”»å‡»+20%', ingredients:['atk_3','atk_6'], icon:'âš”ï¸', effect:(p,e)=>{ for(let i=0;i<2;i++){let d=Math.floor(p.atk*2.5); e.hp-=d;} p.buffs.atkUp=2; bLog("âš”ï¸ å…¨å†›çªå‡»ï¼åŒæ®µé‡å‡»ï¼"); } },
        { id:'c14', name:'çŸ¥è¯†å£å’',   desc:'å·±æ–¹é˜²å¾¡+80%æŒç»­4å›åˆ+åä¼¤', ingredients:['def_1','def_2'], icon:'ğŸ§±', effect:(p,e)=>{ p.buffs.defUp=4; p.buffs.thorns=true; bLog("ğŸ§± çŸ¥è¯†å£å’ï¼è¶…å¼ºé˜²å¾¡+åä¼¤ï¼"); } },
        { id:'c15', name:'é«˜è€ƒç‰¹è®­',   desc:'æœ¬åœºæˆ˜æ–—æ”»å‡»æ°¸ä¹…+25%', ingredients:['atk_11','atk_7'], icon:'ğŸ¯', effect:(p,e)=>{ p.atk=Math.floor(p.atk*1.25); bLog("ğŸ¯ é«˜è€ƒç‰¹è®­ï¼æœ¬åœºæ”»å‡»æ°¸ä¹…+25%ï¼"); } },
        { id:'c16', name:'è”è€ƒéœ¸æƒ',   desc:'æ•Œæ–¹å…¨å±æ€§ä¸‹é™+è”è€ƒç§¯åˆ†+10', ingredients:['atk_5','atk_3'], icon:'ğŸ‘‘', effect:(p,e)=>{ e.buffs.atkDown=4; e.buffs.defDown=4; game.examPoints+=10; bLog("ğŸ‘‘ è”è€ƒéœ¸æƒï¼æ•Œå…¨å±æ€§å´©æºƒï¼"); } },
        { id:'c17', name:'ç»å‘½å‹è¿«',   desc:'æ•Œæ–¹æŒç»­ä¼¤å®³5å›åˆ+æ— æ³•å›è¡€', ingredients:['atk_7','atk_0'], icon:'â˜ ï¸', effect:(p,e)=>{ e.buffs.dot=5; e.buffs.noHeal=true; bLog("â˜ ï¸ ç»å‘½å‹è¿«ï¼æŒç»­ä¸­æ¯’5å›åˆï¼"); } },
        { id:'c18', name:'èµ„é‡‘é“¾æ”»å‡»',  desc:'æ¶ˆè€—æ•Œæ–¹èµ„é‡‘å‹ï¼ˆèµ„é‡‘+50ä¸‡ï¼‰', ingredients:['sup_1','def_0'], icon:'ğŸ’°', effect:(p,e)=>{ game.funds+=50; bLog("ğŸ’° èµ„é‡‘é“¾æ”»å‡»ï¼è·å¾—50ä¸‡èµ„é‡‘ï¼"); } },
        { id:'c19', name:'å£°èª‰æ´—ç™½',   desc:'æˆ‘æ–¹å£°èª‰+100ï¼Œæ•Œæ–¹å‹åŠ›+10', ingredients:['sup_3','sup_2'], icon:'â­', effect:(p,e)=>{ game.reputation+=100; e.stress=(e.stress||0)+10; bLog("â­ å£°èª‰æ´—ç™½ï¼å£°èª‰+100ï¼"); } },
        { id:'c20', name:'æ•™è‚²éƒ¨è”åŠ¨',  desc:'APå…¨æ¢å¤+æ•Œæ–¹æ™•çœ©+æ•™ç ”ç‚¹+20', ingredients:['sup_4','sup_1'], icon:'ğŸ›ï¸', effect:(p,e)=>{ p.ap=p.maxAp; e.buffs.stun=2; game.eduPoints+=20; bLog("ğŸ›ï¸ æ•™è‚²éƒ¨è”åŠ¨ï¼APæ»¡+æ™•çœ©+æ•™ç ”ï¼"); } },
    ];

    // ================= æ•™å­¦è£…å¤‡ç³»ç»Ÿ =================
    const EQUIPMENT_DB = [
        { id:'eq_board',    name:'æ™ºèƒ½é»‘æ¿',  desc:'æ•™å­¦æ•ˆç‡+15%ï¼ˆå­¦ä¸šå€ç‡+15%ï¼‰', icon:'ğŸ“Ÿ', effect:'teach_eff',  bonus:0.15, obtain:'research', researched:false },
        { id:'eq_lab_kit',  name:'å®éªŒç®±',    desc:'ç†ç§‘è¯¾ç¨‹æ•ˆæœ+20%ï¼ˆæ•™ç ”ç‚¹è·å–+20%ï¼‰', icon:'ğŸ§ª', effect:'sci_eff',  bonus:0.20, obtain:'shop_edu', cost:100, researched:false },
        { id:'eq_sand',     name:'å¿ƒç†æ²™ç›˜',  desc:'å‡å‹æ•ˆæœ+30%ï¼ˆå‡å‹ç±»æŠ€èƒ½åŠ å¼ºï¼‰', icon:'ğŸ–ï¸', effect:'stress_red', bonus:0.30, obtain:'event',   researched:false },
        { id:'eq_vr',       name:'VRæ•™å­¦çœ¼é•œ', desc:'æ‰€æœ‰æŠ€èƒ½APæ¶ˆè€—-2', icon:'ğŸ¥½', effect:'ap_reduce', bonus:2, obtain:'research', researched:false },
        { id:'eq_projector',name:'è¶…æ¸…æŠ•å½±ä»ª', desc:'æˆ˜æ–—æš´å‡»ç‡+10%', icon:'ğŸ“½ï¸', effect:'crit_up', bonus:0.10, obtain:'shop_funds', cost:300, researched:false },
        { id:'eq_tablet',   name:'æ•™å­¦å¹³æ¿',  desc:'æ¯æœˆè‡ªåŠ¨è·å¾—1æ•™ç ”ç‚¹', icon:'ğŸ“±', effect:'edu_auto', bonus:1, obtain:'research', researched:false },
    ];

    function getEquipData() {
        if(!game.equip) game.equip = { owned:[], equipped:[] };
        return game.equip;
    }

    // ================= è£…å¤‡ç ”å‘ç³»ç»Ÿæ¸²æŸ“ =================
    function openRnd() {
        if(!game||!game.map) return showToast("è¯·å…ˆé€‰æ‹©éš¾åº¦å¼€å§‹æ¸¸æˆï¼");
        openModal('modal-rnd');
        renderRnd('scroll');
    }

    function renderRnd(tab) {
        let el = document.getElementById('rnd-content');
        if(!el) return;
        if(tab==='scroll') {
            let sd = getScrollData();
            let html = `<h3 style="margin-top:0;color:#ea580c;">ğŸ“œ æˆ˜æ–—å·è½´â€”â€”å¢å¼ºè”è€ƒæˆ˜æ–—å±æ€§</h3>
            <p style="color:#64748b;font-size:0.85rem;">è£…å¤‡å·è½´ååœ¨æˆ˜æ–—ä¸­æŒç»­ç”Ÿæ•ˆã€‚å½“å‰è£…å¤‡ï¼š<b style="color:#ea580c;">${SCROLLS.find(s=>s.id===sd.equipped)?.name||'æ— '}</b></p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">`;
            SCROLLS.forEach(sc=>{
                let owned = sd.owned.includes(sc.id) || sc.id==='sc_basic';
                let equipped = sd.equipped===sc.id;
                let canReq = sc.req();
                let costLabel = sc.costType==='free'?'é»˜è®¤æ‹¥æœ‰':`æ•™ç ”ç‚¹${sc.cost}`;
                html+=`<div style="background:${equipped?'#fef3c7':owned?'#f0fdf4':'#f8fafc'};border:2px solid ${equipped?'#f59e0b':owned?'#10b981':'#cbd5e1'};border-radius:8px;padding:12px;">
                    <div style="font-size:1.5rem;">${sc.icon}</div>
                    <div style="font-weight:bold;color:#1e293b;">${sc.name} ${equipped?'<span style="background:#f59e0b;color:white;font-size:0.6rem;padding:2px 5px;border-radius:3px;">è£…å¤‡ä¸­</span>':''}</div>
                    <div style="font-size:0.78rem;color:#64748b;margin:4px 0;">${sc.desc}</div>
                    ${!owned&&canReq?`<button class="btn" style="padding:4px 10px;font-size:0.78rem;margin-top:4px;" onclick="buyScroll('${sc.id}')">ç ”å‘ ${costLabel}</button>`:''}
                    ${owned&&!equipped?`<button class="btn" style="padding:4px 10px;font-size:0.78rem;margin-top:4px;background:#fef3c7;border-color:#f59e0b;" onclick="equipScroll('${sc.id}')">è£…å¤‡</button>`:''}
                    ${!canReq&&!owned?`<div style="font-size:0.7rem;color:#ef4444;margin-top:4px;">âš ï¸ éœ€å­¦æ ¡è¾¾åˆ°æ›´é«˜ç­‰çº§</div>`:''}
                </div>`;
            });
            html+='</div>';
            el.innerHTML=html;
        } else if(tab==='combo') {
            let learned = game.combos || [];
            let html=`<h3 style="margin-top:0;color:#c026d3;">âš¡ ç»„åˆæŠ€ç ”å‘â€”â€”æ¶ˆè€—æ•™ç ”ç‚¹è§£é”å¼ºåŠ›ç»„åˆæŠ€</h3>
            <p style="color:#64748b;font-size:0.85rem;">ç»„åˆæŠ€åœ¨æˆ˜æ–—ä¸­éœ€è¦æ¶ˆè€—é¢å¤–APä½¿ç”¨ï¼Œä½†æ•ˆæœæä¸ºå¼ºåŠ›ã€‚</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">`;
            COMBO_RECIPES.forEach((c,i)=>{
                let isLearned = learned.includes(c.id);
                let cost = 30 + i*5;
                html+=`<div style="background:${isLearned?'#fdf4ff':'#f8fafc'};border:2px solid ${isLearned?'#c026d3':'#cbd5e1'};border-radius:8px;padding:10px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-size:1.5rem;">${c.icon}</span>
                        <div>
                            <div style="font-weight:bold;color:#1e293b;">${c.name} ${isLearned?'<span style="background:#c026d3;color:white;font-size:0.6rem;padding:2px 5px;border-radius:3px;">å·²è§£é”</span>':''}</div>
                            <div style="font-size:0.72rem;color:#64748b;">${c.desc}</div>
                        </div>
                    </div>
                    ${!isLearned?`<button class="btn" style="padding:4px 10px;font-size:0.75rem;" onclick="learnCombo('${c.id}',${cost})">ç ”å‘ æ•™ç ”ç‚¹${cost}</button>`:'<div style="font-size:0.72rem;color:#10b981;">âœ… å·²åœ¨æˆ˜æ–—ç»„åˆæŠ€æ ä¸­å¯ç”¨</div>'}
                </div>`;
            });
            html+='</div>';
            el.innerHTML=html;
        } else if(tab==='equip') {
            let ed = getEquipData();
            let html=`<h3 style="margin-top:0;color:#16a34a;">ğŸ’ æ•™å­¦è£…å¤‡â€”â€”è£…å¤‡åæŒç»­æå‡å­¦æ ¡å±æ€§</h3>
            <p style="color:#64748b;font-size:0.85rem;">è£…å¤‡å¯é€šè¿‡ç ”å‘ã€å•†åº—æˆ–äº‹ä»¶è·å¾—ã€‚å½“å‰è£…å¤‡æ•°é‡: ${ed.equipped.length}/3</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">`;
            EQUIPMENT_DB.forEach(eq=>{
                let owned = ed.owned.includes(eq.id);
                let equipped = ed.equipped.includes(eq.id);
                let obtainLabel = eq.obtain==='research'?`æ•™ç ”ç‚¹80 ç ”å‘`
                                : eq.obtain==='shop_edu'?`æ•™ç ”ç‚¹${eq.cost} è´­ä¹°`
                                : eq.obtain==='shop_funds'?`ï¿¥${eq.cost}ä¸‡ è´­ä¹°`
                                : 'é€šè¿‡ç‰¹å®šäº‹ä»¶è·å¾—';
                html+=`<div style="background:${equipped?'#f0fdf4':owned?'#fdf4ff':'#f8fafc'};border:2px solid ${equipped?'#16a34a':owned?'#c026d3':'#cbd5e1'};border-radius:8px;padding:10px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-size:1.5rem;">${eq.icon}</span>
                        <div>
                            <div style="font-weight:bold;">${eq.name} ${equipped?'<span style="background:#16a34a;color:white;font-size:0.6rem;padding:2px 5px;border-radius:3px;">è£…å¤‡ä¸­</span>':owned?'<span style="background:#c026d3;color:white;font-size:0.6rem;padding:2px 5px;border-radius:3px;">å·²æ‹¥æœ‰</span>':''}</div>
                            <div style="font-size:0.72rem;color:#64748b;">${eq.desc}</div>
                        </div>
                    </div>
                    ${!owned?`<button class="btn" style="padding:4px 10px;font-size:0.75rem;" onclick="buyEquip('${eq.id}')">${obtainLabel}</button>`:''}
                    ${owned&&!equipped?`<button class="btn" style="padding:4px 10px;font-size:0.75rem;background:#f0fdf4;border-color:#16a34a;" onclick="equipItem('${eq.id}')">è£…å¤‡</button>`:''}
                    ${equipped?`<button class="btn" style="padding:4px 10px;font-size:0.75rem;border-color:#ef4444;color:#ef4444;" onclick="unequipItem('${eq.id}')">å¸ä¸‹</button>`:''}
                </div>`;
            });
            html+='</div>';
            el.innerHTML=html;
        }
    }

    function buyScroll(id) {
        let sc = SCROLLS.find(s=>s.id===id);
        if(!sc||sc.costType==='free') return;
        if(game.eduPoints<sc.cost) return showToast("æ•™ç ”ç‚¹ä¸è¶³ï¼");
        game.eduPoints-=sc.cost;
        let sd = getScrollData();
        if(!sd.owned.includes(id)) sd.owned.push(id);
        showToast(`ğŸ“œ ç ”å‘æˆåŠŸï¼š${sc.name}ï¼`);
        updateUI(); renderRnd('scroll');
    }

    function equipScroll(id) {
        let sd = getScrollData();
        sd.equipped=id;
        showToast(`å·²è£…å¤‡å·è½´ï¼š${SCROLLS.find(s=>s.id===id)?.name}`);
        renderRnd('scroll');
    }

    function learnCombo(id, cost) {
        if(game.eduPoints<cost) return showToast("æ•™ç ”ç‚¹ä¸è¶³ï¼");
        game.eduPoints-=cost;
        if(!game.combos) game.combos=[];
        if(!game.combos.includes(id)) game.combos.push(id);
        let c = COMBO_RECIPES.find(x=>x.id===id);
        showToast(`âš¡ ç»„åˆæŠ€ã€${c?.name}ã€‘å·²è§£é”ï¼`);
        updateUI(); renderRnd('combo');
    }

    function buyEquip(id) {
        let eq = EQUIPMENT_DB.find(e=>e.id===id);
        if(!eq) return;
        if(eq.obtain==='research') {
            if(game.eduPoints<80) return showToast("æ•™ç ”ç‚¹ä¸è¶³ï¼ˆéœ€80ï¼‰ï¼");
            game.eduPoints-=80;
        } else if(eq.obtain==='shop_edu') {
            if(game.eduPoints<eq.cost) return showToast("æ•™ç ”ç‚¹ä¸è¶³ï¼");
            game.eduPoints-=eq.cost;
        } else if(eq.obtain==='shop_funds') {
            if(!payCost(0,eq.cost)) return;
        } else return showToast("æ­¤è£…å¤‡åªèƒ½é€šè¿‡äº‹ä»¶è·å¾—ï¼");
        let ed = getEquipData();
        if(!ed.owned.includes(id)) ed.owned.push(id);
        showToast(`ğŸ’ è·å¾—è£…å¤‡ï¼š${eq.name}ï¼`);
        updateUI(); renderRnd('equip');
    }

    function equipItem(id) {
        let ed = getEquipData();
        if(ed.equipped.length>=3 && !ed.equipped.includes(id)) return showToast("æœ€å¤šåŒæ—¶è£…å¤‡3ä»¶ï¼è¯·å…ˆå¸ä¸‹ä¸€ä»¶ã€‚");
        if(!ed.equipped.includes(id)) ed.equipped.push(id);
        showToast(`å·²è£…å¤‡ï¼š${EQUIPMENT_DB.find(e=>e.id===id)?.name}`);
        applyEquipmentBonuses(); renderRnd('equip');
    }

    function unequipItem(id) {
        let ed = getEquipData();
        ed.equipped = ed.equipped.filter(x=>x!==id);
        showToast(`å·²å¸ä¸‹ï¼š${EQUIPMENT_DB.find(e=>e.id===id)?.name}`);
        renderRnd('equip');
    }

    function applyEquipmentBonuses() {
        // æœˆåº¦è¢«åŠ¨æ•ˆæœåœ¨advanceMonthä¸­å¤„ç†
        let ed = getEquipData();
        ed.equipped.forEach(id=>{
            let eq = EQUIPMENT_DB.find(e=>e.id===id);
            if(!eq) return;
            if(eq.effect==='edu_auto') { game.eduPoints+=eq.bonus; }
        });
    }

    // åœ¨æˆ˜æ–—ä¸­è·å–è£…å¤‡å¯¹APçš„å‡å…
    function getEquipApReduce() {
        let ed = getEquipData();
        let red = 0;
        ed.equipped.forEach(id=>{ let eq=EQUIPMENT_DB.find(e=>e.id===id); if(eq&&eq.effect==='ap_reduce') red+=eq.bonus; });
        return red;
    }

    // åœ¨æˆ˜æ–—ä¸­è·å–è£…å¤‡æš´å‡»åŠ æˆ
    function getEquipCritBonus() {
        let ed = getEquipData();
        let bonus = 0;
        ed.equipped.forEach(id=>{ let eq=EQUIPMENT_DB.find(e=>e.id===id); if(eq&&eq.effect==='crit_up') bonus+=eq.bonus; });
        return bonus;
    }

    // æ·»åŠ æˆ˜æ–—ç”¨æ–°æŠ€èƒ½ï¼šç†µå¢/å‡ç†µ
    // åœ¨SKILL_DBåè¿½åŠ æˆ˜æ–—æŠ€èƒ½å¹¶åŠ å…¥æ”¯æ´ç»„åˆæŠ€å…¥å£
    function renderComboSkills() {
        if(!game||!game.combos||!game.combos.length) return '';
        let html = `<div style="margin-top:12px;border-top:2px dashed #c026d3;padding-top:10px;">
            <div style="font-weight:bold;color:#c026d3;font-size:0.85rem;margin-bottom:6px;">âš¡ å·²è§£é”ç»„åˆæŠ€</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;">`;
        game.combos.forEach(cid=>{
            let c = COMBO_RECIPES.find(x=>x.id===cid);
            if(!c) return;
            html+=`<button class="b-skill-btn" onclick="useCombo('${cid}')" style="border-color:#c026d3;">${c.icon} ${c.name}<div style="font-size:0.62rem;color:#94a3b8;">${c.desc.substring(0,15)}...</div></button>`;
        });
        html+='</div></div>';
        return html;
    }

    function useCombo(id) {
        if(!bState.active||bState.isOver) return showToast("ä¸åœ¨æˆ˜æ–—ä¸­ï¼");
        let c = COMBO_RECIPES.find(x=>x.id===id);
        if(!c) return;
        let apCost = 20;
        if(bState.p.ap < apCost) return showToast(`APä¸è¶³ï¼ç»„åˆæŠ€éœ€è¦${apCost}AP`);
        bState.p.ap -= apCost;
        c.effect(bState.p, bState.e);
        bCheckEnd(); bRenderBattle();
    }

    // ================= èƒŒæ™¯éŸ³ä¹ =================
    const BGM_LIST = ['src/music/1.mp3','src/music/2.mp3','src/music/3.mp3','src/music/4.mp3'];
    let bgmIndex = Math.floor(Math.random() * BGM_LIST.length);
    let bgmStarted = false;

    function initBGM() {
        if(bgmStarted) return;
        bgmStarted = true;
        let audio = document.getElementById('bgm');
        audio.src = BGM_LIST[bgmIndex];
        audio.volume = 0.35;
        audio.play().catch(()=>{});
        audio.addEventListener('ended', () => {
            bgmIndex = (bgmIndex + 1) % BGM_LIST.length;
            audio.src = BGM_LIST[bgmIndex];
            audio.play().catch(()=>{});
        });
    }

    // é¦–æ¬¡ç”¨æˆ·äº¤äº’æ—¶å¯åŠ¨éŸ³ä¹ï¼ˆæµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾ç­–ç•¥è¦æ±‚ï¼‰
    document.addEventListener('click', initBGM, { once: true });
    document.addEventListener('keydown', initBGM, { once: true });

    // ================= ç»ˆæœ«ä¹‹è¯— =================
    function showEndPoem() {
        var o = document.getElementById('end-poem-overlay');
        var t = document.getElementById('end-poem-track');
        var fresh = t.cloneNode(true);
        t.parentNode.replaceChild(fresh, t);
        fresh = document.getElementById('end-poem-track');
        o.style.display = 'block';
        o.onclick = null; // not skippable
        // When animation ends, allow close
        fresh.addEventListener('animationend', function() {
            var btn = document.getElementById('end-poem-close-btn');
            if(btn) btn.style.display = 'block';
        });
    }

    function handlePoemClick() {
        // Only called after poem ends
        document.getElementById('end-poem-overlay').style.display = 'none';
    }

    // åˆå§‹åŒ–åŠ è½½
    window.onload = init;
</script>
</body>
</html>

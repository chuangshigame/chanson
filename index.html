
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµå®å­”å­å­¦æ ¡ - V0.0.3 ä¸‡è±¡å½’ä¸€</title>
    <style>
        :root {
            --bg-body: #0f172a; --panel-bg: rgba(255, 255, 255, 0.96);
            --board-bg: #1e293b; --chalk-white: #f8f9fa; --chalk-yellow: #fde047; --chalk-blue: #60a5fa;
            --primary: #2563eb; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --purple: #8b5cf6;
            --gold: #fbbf24; --wood: #452912;
            --radius: 12px; --shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        /* åŸºç¡€å¸ƒå±€ */
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: var(--bg-body); background-image: radial-gradient(circle at top, #1e293b, #0f172a); color: #334155; margin: 0; padding: 10px; display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden; }
        .container { width: 100%; max-width: 1450px; display: grid; gap: 15px; grid-template-columns: 320px 1fr 320px; transition: 0.5s; }
        
        /* é¡¶éƒ¨æ¨ªå¹… */
        .header-banner { grid-column: 1 / -1; background: linear-gradient(135deg, #7f1d1d, #991b1b); color: #fff; text-align: center; padding: 15px; border-radius: var(--radius); border: 3px solid #fca5a5; box-shadow: var(--shadow); position: relative; }
        .header-banner h1 { margin: 0; font-size: 2.2rem; letter-spacing: 2px; color: var(--chalk-yellow); text-shadow: 2px 2px 5px rgba(0,0,0,0.6); }
        
        /* ç³»ç»Ÿæ  */
        .sys-bar { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; background: var(--panel-bg); padding: 10px 20px; border-radius: var(--radius); box-shadow: var(--shadow); flex-wrap: wrap; gap:10px; }
        .school-badge { padding: 5px 12px; background: linear-gradient(135deg, #fef08a, var(--gold)); color: #713f12; border-radius: 20px; font-weight: 800; border: 1px solid #d97706; }
        .sys-btn { padding:6px 12px; cursor:pointer; background:#f8fafc; border:1px solid #cbd5e1; border-radius:6px; font-weight:bold; transition: 0.2s; color: #1e293b; display: inline-flex; align-items: center; gap: 4px; font-size: 0.85rem; }
        .sys-btn:hover:not(:disabled) { background: #e2e8f0; transform: translateY(-1px); }
        .btn-auto.active { background: var(--danger); color: white; border-color: #b91c1c; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(239,68,68,0.5);} 70% {box-shadow: 0 0 0 8px rgba(239,68,68,0);} 100% {box-shadow: 0 0 0 0 rgba(239,68,68,0);} }

        /* é¢æ¿é€šç”¨ */
        .panel { background: var(--panel-bg); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); display:flex; flex-direction: column; position: relative; }
        .panel-title { font-size: 1.1rem; font-weight: 800; border-bottom: 3px solid var(--primary); padding-bottom: 8px; margin-top: 0; margin-bottom: 12px; color: #1e293b; display:flex; justify-content:space-between; align-items:flex-end; }
        
        /* èµ„æºæ ¼å­ */
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .res-box { background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; position: relative; }
        .res-box span { display: block; font-size: 1.2rem; font-weight: 900; color: var(--primary); margin-top: 5px; font-family: monospace; }
        .res-sub { font-size: 0.65rem; color: #64748b; position: absolute; bottom: 2px; right: 5px; font-weight:bold; }

        /* é»‘æ¿å±æ€§æ¡ */
        .blackboard { background: var(--board-bg); border: 8px solid var(--wood); border-radius: 6px; padding: 15px; color: var(--chalk-white); box-shadow: inset 0 0 15px rgba(0,0,0,0.8); }
        .stat-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem; font-weight: bold; position:relative; }
        .stat-label { width: 85px; color: var(--chalk-blue); z-index:2; }
        .bar-bg { flex: 1; height: 18px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); margin: 0 10px; position:relative; }
        .bar-fill { height: 100%; transition: width 0.3s ease-out; background-image: linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 10px 100%; }
        .stat-val { width: 35px; text-align: right; font-family: monospace; font-size: 1.1rem; color: var(--chalk-yellow); z-index:2; }
        .stress-warning { color: #fca5a5; font-size: 0.75rem; text-align: center; animation: blink 0.8s infinite; margin-top:-5px; font-weight:bold; display:none; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* æŒ‰é’®ç»„ä»¶ */
        .btn { width: 100%; padding: 10px; background: #fff; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; text-align: left; transition: 0.2s; font-weight: bold; color: #334155; display:flex; flex-direction:column; margin-bottom:8px; position: relative;}
        .btn:hover:not(:disabled) { border-color: var(--primary); background: #eff6ff; transform: translateX(3px); }
        .btn:disabled { background: #f1f5f9; border-color: #cbd5e1; color: #94a3b8; cursor: not-allowed; opacity: 0.7; }
        .btn-desc { font-size: 0.7rem; color: #64748b; font-weight: normal; margin-top: 4px; }
        .btn-main { background: linear-gradient(135deg, var(--primary), #1e40af); color: white; border: none; font-size: 1.2rem; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 900; width: 100%; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.4); text-align:center; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(37, 99, 235, 0.6); }

        /* æ¨¡æ€æ¡†ç³»ç»Ÿ */
        .fs-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.9); z-index: 2000; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(4px); }
        .fs-content { background: #f8fafc; width: 100%; max-width: 1300px; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .fs-header { background: #1e293b; color: white; padding: 15px 20px; display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; align-items:center; }
        .fs-close { background: transparent; border: none; color: white; font-size: 1.8rem; cursor: pointer; line-height:1; }
        .fs-body { padding: 20px; overflow-y: auto; flex: 1; }

        /* ç½‘æ ¼ä¸å¡ç‰‡ */
        .grid-sys { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
        .gacha-card { background: #fff; border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 15px; position:relative; }
        .upkeep-tag { position:absolute; top:5px; right:5px; font-size:0.7rem; background:#fee2e2; color:#991b1b; padding:2px 5px; border-radius:4px; font-weight:bold; }
        .type-tag { position:absolute; bottom:5px; right:5px; font-size:0.7rem; padding:2px 5px; border-radius:4px; font-weight:bold; }
        .type-battle { background: #fee2e2; color:#b91c1c; } .type-passive { background: #e0f2fe; color:#0369a1; }
        .rarity-R { border-color: #3b82f6; box-shadow: 0 0 10px rgba(59,130,246,0.2); }
        .rarity-SR { border-color: #a855f7; box-shadow: 0 0 15px rgba(168,85,247,0.3); }
        .rarity-SSR { border-color: var(--gold); box-shadow: 0 0 20px rgba(251,191,36,0.5); background: linear-gradient(135deg, #fff, #fefce8); }
        
        /* æ ‘å½¢ç»“æ„ */
        .tree-tier { display: flex; gap: 15px; justify-content: center; width: 100%; margin-bottom: 25px; flex-wrap: wrap; }
        .tree-node { width: 220px; background:#fff; border: 2px solid #cbd5e1; border-radius: 8px; padding: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.3s; display: flex; flex-direction: column; justify-content: space-between; }
        .tree-node.locked { filter: grayscale(1); opacity: 0.6; }
        .tree-node.unlocked { border-color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); background:#f0fdf4; }
        .tree-node.branch-a { border-top: 5px solid var(--danger); }
        .tree-node.branch-b { border-top: 5px solid var(--warning); }
        .tree-node.branch-c { border-top: 5px solid #fbbf24; }
        .tree-node.branch-d { border-top: 5px solid var(--success); }

        /* åœ°å›¾ */
        .map-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background: #84cc16; padding: 15px; border-radius: 8px; border: 4px solid #4d7c0f; }
        .map-cell { background: rgba(255,255,255,0.5); border: 2px dashed #65a30d; border-radius: 6px; height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; position: relative; }
        .map-cell:hover { background: rgba(255,255,255,0.9); }
        .map-cell.selected { border: 3px solid var(--danger); background: #fff; }

        /* æ—¥å¿— */
        .log-box { flex: 1; overflow-y: auto; font-size: 0.85rem; background: #fff; border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; line-height: 1.5; }
        .log-item { margin-bottom: 8px; border-bottom: 1px dashed #e2e8f0; padding-bottom: 4px; }
        
        /* ç‹¬ç«‹å­¦ç”Ÿä¿¡ç®±æ ·å¼ */
        .mailbox-container { height: 180px; overflow-y: auto; background: #f1f5f9; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px;}
        .comment-bubble { background: #fff; border-left: 4px solid var(--primary); padding: 10px; border-radius: 0 8px 8px 0; font-size: 0.85rem; color: #1e293b; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .comment-meta { font-size: 0.7rem; color: #94a3b8; margin-top: 5px; text-align: right; }

        /* === ä¿®å¤åçš„æˆ˜æ–—ç³»ç»Ÿå¸ƒå±€ (ç¾åŒ–åŠ å¼ºç‰ˆ) === */
        .battle-ui { display: flex; flex-direction: column; height: 85vh; max-height:850px; background: #000; color: #a3e635; padding: 15px; border-radius: 8px; font-family: 'Courier New', Courier, monospace; overflow: hidden; box-shadow: 0 0 30px rgba(101, 163, 13, 0.2); }
        .b-header { flex: 0 0 auto; display: flex; justify-content: space-between; border-bottom: 1px dashed #3f6212; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; color: #bef264; }
        .b-arena { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border: 2px solid #65a30d; border-radius: 8px; background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(20, 83, 45, 0.7)); position: relative; height: 150px; box-shadow: inset 0 0 25px rgba(101, 163, 13, 0.4); }
        .b-entity { width: 42%; background: rgba(0, 0, 0, 0.6); padding: 12px; border-radius: 8px; border: 1px solid #3f6212; box-shadow: 0 0 15px rgba(0,0,0,0.8); }
        .b-name { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; color: #d9f99d; text-shadow: 0 0 5px #d9f99d; }
        .b-hp-bg { height: 14px; background: #000; border: 1px solid #a3e635; margin: 5px 0; position: relative; border-radius:3px; overflow:hidden;}
        .b-hp-fill { height: 100%; background: linear-gradient(90deg, #4ade80, #16a34a); box-shadow: inset 0 0 8px rgba(255,255,255,0.4); transition: width 0.3s ease-out; }
        .b-hp-txt { position: absolute; width: 100%; text-align: center; top: -1px; font-size: 0.75rem; font-weight: bold; color: #fff; text-shadow:1px 1px 2px #000;}
        .b-stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 0.75rem; color:#cbd5e1; }
        .b-stress-bar { height: 5px; background: #000; border: 1px solid #ef4444; margin-top: 4px; border-radius:2px; }
        .b-stress-fill { height: 100%; background: #dc2626; transition: width 0.3s; }
        
        .b-weather { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); text-align: center; background: rgba(0,0,0,0.8); padding: 5px 12px; border-radius: 6px; border: 1px solid #fde047; color: #fde047; font-size: 0.75rem; z-index: 10; width: 150px; box-shadow: 0 0 10px rgba(253,224,71,0.3);}
        .b-buffs { display: flex; flex-wrap: wrap; gap: 4px; font-size: 0.7rem; margin-top: 5px; color: #a7f3d0; }
        
        /* æˆ˜æ–—æ—¥å¿—åŒºåŸŸ */
        .b-log { flex: 1; border: 1px dashed #3f6212; padding: 10px; margin: 10px 0; overflow-y: auto; font-size: 0.85rem; line-height: 1.5; background: rgba(0,0,0,0.4); min-height: 100px; display:flex; flex-direction:column; border-radius:4px; }
        .b-log-inner { margin-top: auto; } /* å¼ºåˆ¶å†…å®¹é ä¸‹ */
        .b-log span.sys { color: #fde047; } .b-log span.p { color: #93c5fd; } .b-log span.e { color: #fca5a5; } 
        .b-log span.dmg { color: #ef4444; font-weight: bold; } .b-log span.crit { color: #c084fc; font-weight: bold; text-shadow: 0 0 5px #c084fc; }
        
        .b-expert-select { flex: 0 0 auto; display:flex; gap:10px; margin-bottom:10px; overflow-x:auto; padding-bottom:5px; border-bottom:1px dashed #3f6212; min-height: 35px; align-items:center; }
        .b-expert-select::-webkit-scrollbar { height: 4px; }
        .b-expert-select::-webkit-scrollbar-thumb { background: #3f6212; border-radius: 2px; }

        /* æ“ä½œåŒºåŸŸ */
        .b-actions { flex: 0 0 auto; border-top: 1px dashed #3f6212; padding-top: 10px; display: grid; grid-template-columns: 140px 1fr; gap: 10px; height: 160px; }
        .b-cats { display: flex; flex-direction: column; gap: 4px; overflow-y: auto; padding-right:5px;}
        .b-cats::-webkit-scrollbar { width: 4px; } .b-cats::-webkit-scrollbar-thumb { background:#3f6212; }
        .b-cat-btn { background: rgba(0,0,0,0.6); color: #a3e635; border: 1px solid #3f6212; padding: 8px; cursor: pointer; font-family: inherit; font-size: 0.85rem; text-align: left; transition: 0.2s; border-radius:4px; }
        .b-cat-btn:hover, .b-cat-btn.active { background: #14532d; border-color: #a3e635; box-shadow: 0 0 8px rgba(163,230,53,0.3); }
        .b-skills { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 8px; align-content: start; overflow-y: auto; padding-right:5px; }
        .b-skills::-webkit-scrollbar { width: 4px; } .b-skills::-webkit-scrollbar-thumb { background:#3f6212; }
        .b-skill-btn { background: rgba(0,0,0,0.6); color: #fff; border: 1px solid #4ade80; padding: 8px; cursor: pointer; font-family: inherit; text-align: left; display: flex; flex-direction: column; transition: 0.2s; border-radius:4px; }
        .b-skill-btn:hover:not(:disabled) { background: #166534; transform: translateX(2px); box-shadow: 0 0 8px rgba(74,222,128,0.4); }
        .b-skill-btn:disabled { border-color: #334155; color: #64748b; cursor: not-allowed; text-decoration: line-through; opacity: 0.6; }
        .b-s-name { font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }
        .b-s-desc { font-size: 0.7rem; color: #bef264; }

        /* å­¦ç”Ÿæ¨¡å¼ */
        #student-container { display: none; width: 100%; max-width: 1300px; background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px; margin: 0 auto; box-shadow: var(--shadow); }
        .stu-grid { display: grid; grid-template-columns: 320px 1fr 300px; gap: 20px; }
        .stu-act-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stu-act-btn { padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; background: #fff; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; transition:0.2s; text-align:left; }
        .stu-act-btn:hover { border-color: var(--primary); background: #eff6ff; transform:scale(1.02); }
        .stu-stat-box { background: #1e293b; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .exam-board { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; border: 3px solid #047857; }
        
        .friend-card { background: #f8fafc; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap:wrap; gap:5px; }
        .friend-card.active { border-color: var(--success); background: #ecfdf5; }
        .rebirth-points { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; }
        .family-card { background: #fff; border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; position:relative; }
        .family-card:hover { border-color: var(--primary); background: #eff6ff; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .family-card.selected { border-color: var(--primary); background: #eff6ff; box-shadow: 0 0 0 3px rgba(37,99,235,0.2); }

        /* å›¾è¡¨ */
        .chart-container { display: flex; align-items: flex-end; justify-content: space-around; height: 180px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px 5px 0 5px; margin: 15px 0; }
        .chart-col { display: flex; flex-direction: column; align-items: center; width: 14%; font-size: 0.7rem; }
        .chart-bar { width: 100%; border-radius: 4px 4px 0 0; transition: 0.5s; display: flex; justify-content: center; align-items:flex-end; color: white; font-weight: bold; padding-top: 5px; font-size: 0.8rem; padding-bottom:2px;}
        .chart-label { font-size: 0.7rem; font-weight: bold; margin-top: 5px; color: #475569; text-align: center; line-height:1.2; }

        /* é€šç”¨å¼¹çª—è¦†ç›– */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 5000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.6); max-height: 90vh; overflow-y:auto; }
        .modal-btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 8px; font-weight: bold; font-size: 1rem; transition: 0.2s; display:inline-flex; flex-direction:column; align-items:center; }
        .modal-btn:hover { background: #1d4ed8; transform: translateY(-2px); }

        /* Toast */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: rgba(15,23,42,0.95); color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold; border-left: 4px solid var(--primary); animation: slideIn 0.3s forwards, fadeOut 0.5s 3.5s forwards; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        @keyframes slideIn { from{transform: translateX(100%);} to{transform: translateX(0);} }
        @keyframes fadeOut { to{transform: translateY(-20px); opacity:0;} }
    </style>
</head>
<body>

<div id="toast-container"></div>

<!-- ================= æ ¡é•¿æ¨¡å¼ ================= -->
<div class="container" id="principal-container">
    <div class="header-banner">
        <h1>å­”å­å­¦æ ¡ V0.0.3 ä¸‡è±¡å½’ä¸€</h1>
        <p style="margin: 5px 0 0 0; font-size: 0.95rem; opacity: 0.9;">By ChansonTech</p>
    </div>

    <div class="sys-bar">
        <div style="display:flex; align-items:center; gap: 10px;">
            <span class="school-badge" id="ui-level-name">ğŸ† ä¹¡é•‡ä¸­å­¦</span>
            <button class="sys-btn" onclick="checkUpgrade()">ğŸ–ï¸ ç”³è¯·è¯„çº§ (æ˜¾ç¤ºæ¡ä»¶)</button>
            <button class="sys-btn btn-auto" id="btn-auto" onclick="toggleAuto()">ğŸ¤– è‡ªåŠ¨æ¨æ¼”</button>
        </div>
        <div style="display:flex; gap: 8px; align-items:center;">
            <span style="font-weight:bold; color:var(--danger); font-size:0.9rem;">âš”ï¸ è”è€ƒæˆ˜ç»©: <span id="ui-examPoints">0</span>åˆ†</span>
            <button class="sys-btn" style="background:var(--purple); color:white; border:none; padding:8px 15px;" onclick="switchMode('student')">ğŸ‘¨â€ğŸ“ åˆ‡æ¢è‡³ï¼šå­¦ç”Ÿæ·±æ½œè§†è§’</button>
            <span id="ui-diff-badge" style="font-size:0.8rem; background:#475569; color:white; padding:4px 8px; border-radius:4px; font-weight:bold;">éš¾åº¦: æ­£å¸¸</span>
            <button class="sys-btn" onclick="hardReset()" style="color:var(--danger)">ğŸ”„ æŠ¹é™¤å­˜æ¡£</button>
        </div>
    </div>

    <div class="panel">
        <h2 class="panel-title">ğŸ“Š è´¢åŠ¡ä¸è¡Œæ”¿ä¸­æ¢</h2>
        <div class="res-grid">
            <div class="res-box">æ€»èµ„é‡‘(ä¸‡) <span id="ui-funds" style="color:#059669;">100</span><div class="res-sub" id="ui-salary">å¸¸è€—:-0 ä¸“å®¶:-0</div></div>
            <div class="res-box">åœ¨æ ¡ç”Ÿè§„æ¨¡ <span id="ui-students" style="color:#2563eb;">300</span></div>
            <div class="res-box">ç¤¾ä¼šå£°èª‰ <span id="ui-rep" style="color:var(--warning)">100</span></div>
            <div class="res-box">è¡Œæ”¿ AP <span><span id="ui-ap">10</span>/<span id="ui-maxap">20</span></span></div>
        </div>

        <h2 class="panel-title" style="margin-top: 5px;">ğŸ§¬ ç”Ÿæºå…­ç»´ (å½±å“å…¨æ ¡æˆ˜åŠ›)</h2>
        <div class="blackboard">
            <div class="stat-row"><div class="stat-label">ğŸ“š å­¦ä¸š(æ”»å‡»)</div><div class="bar-bg"><div id="bar-grade" class="bar-fill" style="background:linear-gradient(90deg, #3b82f6, #60a5fa);"></div></div><div class="stat-val" id="val-grade">40</div></div>
            <div class="stat-row" style="margin-bottom:0;"><div class="stat-label">ğŸ¤¯ å‹åŠ›(ç†µå¢)</div><div class="bar-bg"><div id="bar-stress" class="bar-fill" style="background:linear-gradient(90deg, #ef4444, #f87171);"></div></div><div class="stat-val" id="val-stress">20</div></div>
            <div class="stress-warning" id="warn-stress">âš ï¸ è­¦å‘Šï¼šæ€ç»´ç†µå¢æ¿’ä¸´å´©æºƒæé™ï¼</div>
            <div class="stat-row" style="margin-top:10px;"><div class="stat-label">ğŸ›¡ï¸ çºªå¾‹(é˜²å¾¡)</div><div class="bar-bg"><div id="bar-disc" class="bar-fill" style="background:linear-gradient(90deg, #f59e0b, #fbbf24);"></div></div><div class="stat-val" id="val-disc">60</div></div>
            <div class="stat-row"><div class="stat-label">ğŸƒâ€â™‚ï¸ ä½“è´¨(è¡€é‡)</div><div class="bar-bg"><div id="bar-fit" class="bar-fill" style="background:linear-gradient(90deg, #10b981, #34d399);"></div></div><div class="stat-val" id="val-fit">50</div></div>
            <div class="stat-row"><div class="stat-label">ğŸ¨ è‰ºæœ¯(æš´å‡»)</div><div class="bar-bg"><div id="bar-art" class="bar-fill" style="background:linear-gradient(90deg, #8b5cf6, #a78bfa);"></div></div><div class="stat-val" id="val-art">30</div></div>
        </div>
    </div>

    <div class="panel">
        <div style="text-align: center; margin-bottom: 15px; background:#f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div id="ui-date" style="font-size: 1.6rem; font-weight: 900; color: var(--primary); letter-spacing: 1px;">2018å¹´ 9æœˆ</div>
        </div>
        <button class="btn-main" id="btn-advance" onclick="advanceMonth()">â³ æ¨è¿›ä¸€ä¸ªæœˆ (è§¦å‘äº‹ä»¶/è”è€ƒ/æ”¶å­¦è´¹)</button>

        <h2 class="panel-title">ğŸ§  æˆ˜å¤‡ä¸­æ¢</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom:15px;">
            <button class="btn" style="background:#ecfdf5; border-color:#10b981;" onclick="openModal('modal-map')">ğŸ—ºï¸ æ ¡å›­åŸºå»ºæ‰©å»º<span class="btn-desc">3çº§ç‰¹æŠ€å»ºç­‘è§£é”</span></button>
            <button class="btn" style="background:#eff6ff; border-color:#3b82f6;" onclick="openModal('modal-experts')">ğŸ‘¨â€ğŸ« å¯»è®¿é¡¶çº§åå¸ˆ<span class="btn-desc">40ä½ä¸“å®¶+å¼ºåŠ›æˆ˜æŠ€</span></button>
            <button class="btn" style="background:#faf5ff; border-color:#a855f7;" onclick="openModal('modal-schedule')">ğŸ“… å¸ˆèµ„ä¸ä¸»ç§‘æ’è¯¾<span class="btn-desc">ä¼˜åŒ–æ’è¯¾ç®—æ³•</span></button>
            <button class="btn" style="background:#fefce8; border-color:#eab308;" onclick="openModal('modal-policy')">ğŸ« å›½å®¶æ ¡ç­–ç§‘æŠ€æ ‘<span class="btn-desc">æ•™ç ”ç‚¹: <span id="ui-eduPoints" style="font-weight:bold;color:var(--danger)">0</span></span></button>
        </div>

        <h2 class="panel-title">ğŸ¯ æˆ˜æœ¯ä¸å¤§åŠ¿</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <button class="btn" onclick="organizeExam()">ğŸ“ æ¨¡æ‹Ÿé˜…å·å‡ºåˆ†<span class="btn-desc">è€—AP:3, ï¿¥<span id="cost-exam" class="c-val">2</span>ä¸‡ | å…­æ¡£åˆ†æ</span></button>
            <button class="btn" onclick="openModal('modal-branches')">ğŸŒ å»ºç«‹å…¨çƒåˆ†æ ¡<span class="btn-desc">è€—å·¨èµ„å»ºç«‹éœ¸ä¸šåˆ†æ ¡</span></button>
            <button class="btn" onclick="runAction('sponsor')">ğŸ¤ å®´è¯·æ‹‰èµåŠ©<span class="btn-desc">è€—AP:4, é™å£°èª‰ | å¾—ï¿¥<span id="gain-spo" style="color:var(--success)">100</span>ä¸‡</span></button>
            <button class="btn" onclick="openModal('modal-achieve')">ğŸ† è£èª‰ä¸æ ¡å‹å½•<span class="btn-desc">20å¤§æˆå°±è§£é”</span></button>
        </div>
    </div>

    <div class="panel" style="display: flex; flex-direction: column;">
        <h2 class="panel-title">ğŸ“¨ ç‹¬ç«‹å­¦ç”Ÿä¿¡ç®± (å®æ—¶çªƒå¬)</h2>
        <div id="student-comments-box" class="mailbox-container"></div>

        <h2 class="panel-title">ğŸ“œ çºªäº‹æœ¬æœ«</h2>
        <div class="log-box" id="log-box"></div>
    </div>
</div>

<!-- ================= å­¦ç”Ÿæ¨¡å¼ ================= -->
<div id="student-container">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 3px solid var(--purple); padding-bottom:10px; margin-bottom:20px;">
        <h1 style="margin:0; color:var(--purple);">ğŸ‘¨â€ğŸ“ å­¦ç”Ÿè§†è§’ï¼šäººç”Ÿè½®å›æ¨¡æ‹Ÿå™¨</h1>
        <div style="display:flex; align-items:center; gap:15px;">
            <span class="rebirth-points">â˜¯ï¸ è½®å›ç‚¹æ•°: <span id="stu-ui-rp">0</span></span>
            <button class="sys-btn" onclick="switchMode('principal')">ğŸ”™ æ”¾å¼ƒå­¦ä¸šï¼Œè¿”å›æ ¡é•¿æ¨¡å¼</button>
        </div>
    </div>

    <div id="stu-setup" style="text-align:center; padding: 20px;">
        <h2>ç¬¬ä¸€æ­¥ï¼šä½ çš„åŸç”Ÿå®¶åº­å†³å®šäº†èµ·è·‘çº¿</h2>
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top:20px;" id="stu-family-grid"></div>
        
        <h2 style="margin-top:40px;">ç¬¬äºŒæ­¥ï¼šæ¶ˆè€—è½®å›ç‚¹è´­ä¹°å‰ä¸–é—æ³½</h2>
        <div style="display:flex; justify-content:center; gap:15px; margin-top:15px;" id="stu-talent-grid">
            <button class="btn" onclick="buyTalent('genius', 20, this)">ğŸ§  è¿‡ç›®ä¸å¿˜ (20ç‚¹)<br><span class="btn-desc">æ¯æ¬¡å­¦ä¹ é¢å¤–+3å­¦ä¸š</span></button>
            <button class="btn" onclick="buyTalent('rich', 15, this)">ğŸ’° éšå½¢å¯Œè±ª (15ç‚¹)<br><span class="btn-desc">å¼€å±€è‡ªå¸¦ï¿¥1000å·¨é¢èµ„é‡‘</span></button>
            <button class="btn" onclick="buyTalent('charm', 10, this)">âœ¨ ç»ä¸–å®¹é¢œ (10ç‚¹)<br><span class="btn-desc">å¼€å±€é­…åŠ›+40ï¼Œæ‹çˆ±æ˜“å¦‚åæŒ</span></button>
        </div>
        <button class="btn-main" style="width:300px; margin-top:30px; font-size:1.5rem;" onclick="startStudentGameplay()">âœ¨ é™ç”Ÿï¼Œå¼€å¯æ ¡å›­ç”Ÿæ´»</button>
    </div>

    <div id="stu-gameplay" style="display:none;" class="stu-grid">
        <!-- å·¦ä¾§çŠ¶æ€ -->
        <div>
            <div class="stu-stat-box">
                <h3 style="margin-top:0; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;">ğŸ“Š ä¸ªäººçŠ¶æ€é¢æ¿</h3>
                <div>ğŸ“† è¿›åº¦: é«˜<span id="stu-ui-year">ä¸€</span> <span id="stu-ui-month">ä¸Š</span>å­¦æœŸ (<span id="stu-ui-turn">1</span>/36)</div>
                <div style="font-size:0.8rem; color:#cbd5e1; margin-top:5px;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å®¶åº­èƒŒæ™¯: <span id="stu-ui-family">åŠ è½½ä¸­</span></div>
                <div style="font-size:0.8rem; color:#fde047; margin-top:5px; font-weight:bold;">ğŸ’µ é›¶èŠ±é’±: ï¿¥<span id="stu-val-money">0</span></div>
                
                <!-- ç²¾åŠ›æ¡ -->
                <div style="margin-top:10px; background:rgba(0,0,0,0.5); border-radius:4px; padding:2px; border:1px solid #4ade80;">
                    <div style="font-size:0.7rem; color:#4ade80; text-align:center;">âš¡ æœ¬æœˆç²¾åŠ› <span id="stu-val-energy">100</span>/100</div>
                    <div style="height:6px; background:#4ade80; width:100%; transition:0.3s;" id="stu-bar-energy"></div>
                </div>

                <div style="margin-top:10px;">
                    <div style="display:flex; justify-content:space-between;"><span>ğŸ“š å­¦ä¸šæŒæ§</span> <span id="stu-val-grade" style="color:var(--chalk-yellow);font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>ğŸ¤¯ ç²¾ç¥å‹åŠ›</span> <span id="stu-val-stress" style="color:#fca5a5;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>ğŸƒâ€â™‚ï¸ èº«ä½“ç´ è´¨</span> <span id="stu-val-fit" style="color:#a7f3d0;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>ğŸ¨ ä¸ªäººé­…åŠ›</span> <span id="stu-val-art" style="color:#c4b5fd;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; border-top:1px dashed #475569; padding-top:5px;">
                        <span style="color:#fbbf24">ğŸ¥‡ å¥¥èµ›: <span id="stu-val-oly">0</span>%</span>
                        <span style="color:#60a5fa" id="stu-lover-tag">ğŸ’” å•èº«ç‹—</span>
                    </div>
                </div>
            </div>

            <div class="exam-board">
                <h3 style="margin:0 0 5px 0;">ä¸Šæœˆå¤§å‹è”è€ƒæˆç»©</h3>
                <div style="font-size:3rem; font-weight:900; line-height:1;" id="stu-exam-score">--</div>
                <div style="font-size:0.9rem; margin-top:5px; opacity:0.9;" id="stu-exam-rank">å…¨æ ¡æ’å: å°šæœªè¿›è¡Œ</div>
            </div>

            <button class="btn-main" style="background:#475569; margin-top:10px;" onclick="endStudentMonth()">ğŸ›Œ ç¡è§‰ (ç»“æŸæœ¬æœˆ)</button>
        </div>

        <!-- ä¸­é—´åŠ¨ä½œåŒº -->
        <div style="display:flex; flex-direction:column; height:100%;">
            <h2 style="margin-top:0;">ğŸ¯ æœ¬æœˆè¡ŒåŠ¨ (æ¶ˆè€—ç²¾åŠ›)</h2>
            <div class="stu-act-grid" style="flex:1; overflow-y:auto; padding-right:10px;">
                <button class="stu-act-btn" onclick="stuAct('hard_study')"><span style="font-size:2rem;">âœï¸</span><div><b>ç‹‚åˆ·çœŸé¢˜ç†¬å¤œ</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:40 | å­¦ä¸š+++, å‹åŠ›+++</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('study')"><span style="font-size:2rem;">ğŸ“–</span><div><b>è®¤çœŸå¬è®²åšç¬”è®°</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:25 | å­¦ä¸š++, å‹åŠ›+</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('olympiad')"><span style="font-size:2rem;">ğŸ”¬</span><div><b>æ­»ç£•å¥¥èµ›/å¼ºåŸº</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:50 | æéš¾, æ»¡100ä¿é€</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('mun')"><span style="font-size:2rem;">ğŸŒ</span><div><b>æ¨¡æ‹Ÿè”åˆå›½</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:50 | å­¦ä¸š+, é­…åŠ›++</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('work')"><span style="font-size:2rem;">ğŸ”</span><div><b>æ ¡å¤–å¿«é¤åº—æ‰“å·¥</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:30 | èµšå–é‡‘é’±, è€—ä½“è´¨</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('scalper')"><span style="font-size:2rem;">ğŸ«</span><div><b>å€’å–æ˜æ˜Ÿå‘¨è¾¹</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:30 | é«˜é£é™©èµšé’±</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('esport')"><span style="font-size:2rem;">ğŸ®</span><div><b>æŠ¥åç½‘å§ç”µç«è”èµ›</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:40 | èµ¢äº†çˆ†èµšå‡å‹</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('show')"><span style="font-size:2rem;">ğŸ¤</span><div><b>å‚åŠ æ ¡å›­æ‰è‰ºå¤§èµ›</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:40 | éœ€è¦é«˜é­…åŠ›æ”¯æ’‘</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('sport')"><span style="font-size:2rem;">ğŸ€</span><div><b>å‚åŠ ç¤¾å›¢æ‰“çƒ</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:25 | ä½“è´¨++, é­…åŠ›+, å‡å‹</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('book')"><span style="font-size:2rem;">ğŸ“š</span><div><b>èº²å›¾ä¹¦é¦†çœ‹é—²ä¹¦</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:20 | é­…åŠ›++, å‡å‹</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('rooftop')"><span style="font-size:2rem;">ğŸŒ†</span><div><b>å¤©å°å¹é£å‘å‘†</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:20 | å‹åŠ›å¤§å‡</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('sick')"><span style="font-size:2rem;">ğŸ¥</span><div><b>è£…ç—…å»åŒ»åŠ¡å®¤èººå¹³</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:10 | å­¦ä¸š--, å‹åŠ›æ¸…ç©º</span></div></button>
            </div>
            
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:10px; height: 150px; overflow-y:auto; font-size:0.85rem; margin-top:15px;" id="stu-log-box"></div>
        </div>

        <!-- å³ä¾§ç¤¾äº¤åŒº -->
        <div style="display:flex; flex-direction:column;">
            <div style="background:#fff; border:2px solid #fbcfe8; border-radius:8px; padding:15px; margin-bottom:15px;">
                <h3 style="margin:0 0 10px 0; color:#db2777;">ğŸ’Œ æ”»ç•¥æš—æ‹å¯¹è±¡</h3>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span>å¥½æ„Ÿåº¦:</span> <span style="font-weight:bold; color:#db2777;" id="stu-crush-aff">0/100</span>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                    <button class="btn" style="margin:0; font-size:0.8rem;" onclick="stuSocial('greet')">ğŸ‘‹ å¶é‡æ‰“æ‹›å‘¼ (5èƒ½)</button>
                    <button class="btn" style="margin:0; font-size:0.8rem;" onclick="stuSocial('gift')">ğŸ é€å°ç¤¼ç‰© (10èƒ½)</button>
                    <button class="btn" style="margin:0; font-size:0.8rem; grid-column:1/-1;" onclick="stuSocial('tutor')">ğŸ“ è¯¾åè¾…å¯¼ä½œä¸š (30èƒ½)</button>
                    <button class="btn-main" style="margin:5px 0 0 0; font-size:0.9rem; padding:8px; grid-column:1/-1; background:#db2777;" onclick="stuSocial('confess')">ğŸ’˜ å‹‡æ•¢è¡¨ç™½ (50èƒ½)</button>
                </div>
            </div>

            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:15px; flex:1; overflow-y:auto;">
                <h3 style="margin:0 0 10px 0;">ğŸ‘¬ åŒæ¡Œä¸æ­»å…šç¾ç»Š</h3>
                <div id="stu-friends-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- ================= æ¨¡æ€æ¡†ç»„ ================= -->
<div id="modal-map" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>ğŸ—ºï¸ æ ¡å›­åŸºå»ºè§„åˆ’ä¸ç‰¹çº§å‡çº§ (20åœ°å—)</div><button class="fs-close" onclick="closeModal('modal-map')">Ã—</button></div>
        <div class="fs-body" style="display:grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            <div class="map-grid" id="map-grid"></div>
            <div style="background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:15px; overflow-y:auto;">
                <h3 style="margin-top:0; border-bottom:2px solid #e2e8f0; padding-bottom:8px;">ğŸ› ï¸ å·¥ç¨‹å›¾çº¸</h3>
                <p id="map-hint" style="color:var(--danger); font-size:0.9rem;">è¯·å…ˆåœ¨å·¦ä¾§ç‚¹é€‰ä¸€å—ç©ºåœ°æˆ–å·²å»ºå»ºç­‘ï¼</p>
                <div id="fac-list" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </div>
    </div>
</div>

<div id="modal-experts" class="fs-modal">
    <div class="fs-content" style="max-width:1000px;">
        <div class="fs-header"><div>ğŸ‘¨â€ğŸ« çŒå¤´å¯»è®¿ç³»ç»Ÿ (40ä½é¡¶çº§åå¸ˆ/è§£é”æˆ˜æŠ€)</div><button class="fs-close" onclick="closeModal('modal-experts')">Ã—</button></div>
        <div class="fs-body">
            <div style="text-align:center; margin-bottom:20px;">
                <button class="btn-main" style="width:auto; padding:15px 40px; font-size:1.5rem;" onclick="gachaExpert()">ğŸ² æ”¯ä»˜ ï¿¥50ä¸‡ å¯»è®¿ä¸“å®¶</button>
                <p style="color:#ef4444; font-size:0.9rem; font-weight:bold;">âš ï¸ æ³¨æ„ï¼šè¶Šå¼ºåŠ›çš„ä¸“å®¶ï¼Œæ¯æœˆçš„è–ªèµ„ç»´æŠ¤è´¹è¶Šé«˜ï¼å°å¿ƒç ´äº§ï¼</p>
            </div>
            <div class="grid-sys" id="expert-container"></div>
        </div>
    </div>
</div>

<div id="modal-branches" class="fs-modal">
    <div class="fs-content" style="max-width:800px;">
        <div class="fs-header"><div>ğŸŒ å…¨çƒåˆ†æ ¡ç½‘ç»œ (æä¾›è¢«åŠ¨åŠ æˆä¸æˆ˜æ–—å±æ€§)</div><button class="fs-close" onclick="closeModal('modal-branches')">Ã—</button></div>
        <div class="fs-body">
            <p style="color:#64748b; margin-bottom:20px;">å»ºç«‹åˆ†æ ¡éœ€è¦å·¨é¢èµ„é‡‘ï¼Œä½†èƒ½æä¾›å¼ºå¤§çš„è¢«åŠ¨å…‰ç¯ï¼Œå¹¶åœ¨è”è€ƒæˆ˜äº‰ä¸­ä¸ºæ‚¨æä¾›é¢å¤–çš„å±æ€§åŠ æˆã€‚</p>
            <div id="branch-container" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"></div>
        </div>
    </div>
</div>

<div id="modal-schedule" class="fs-modal">
    <div class="fs-content" style="max-width: 600px; height:auto;">
        <div class="fs-header"><div>ğŸ“… å¸ˆèµ„è°ƒåº¦ä¸è¯¾è¡¨åˆ¶å®š</div><button class="fs-close" onclick="closeModal('modal-schedule')">Ã—</button></div>
        <div class="fs-body">
            <div style="background:#fee2e2; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.85rem; color:#991b1b; border:1px solid #fca5a5;" id="sch-warn-box"><b>âš ï¸ å±é™©è­¦å‘Šï¼š</b>ä¸»ç§‘æ’è¯¾æ•°è‹¥è¶…è¿‡ <b>25èŠ‚</b>ï¼Œäº§ç”Ÿçš„æ€ç»´ç†µå¢å°†å‘ˆ<b>æŒ‡æ•°çº§çˆ†ç‚¸</b>ï¼</div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn" onclick="upgradeTeacher('main')" style="flex:1">ä¸»ç§‘ç»„å‡çº§<br><span id="tch-main" style="color:var(--primary); font-size:1.1rem;">å®ä¹ </span></button>
                <button class="btn" onclick="upgradeTeacher('minor')" style="flex:1">å‰¯ç§‘ç»„å‡çº§<br><span id="tch-minor" style="color:var(--primary); font-size:1.1rem;">å®ä¹ </span></button>
                <button class="btn" onclick="upgradeTeacher('spec')" style="flex:1">ç´ è´¨ç»„å‡çº§<br><span id="tch-spec" style="color:var(--primary); font-size:1.1rem;">å®ä¹ </span></button>
            </div>
            <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; display:flex; flex-direction:column; gap:15px;">
                <div><b>ğŸ“š ä¸»ç§‘è¯¾æ—¶ (é«˜å‹/é«˜æ”»)</b> <span id="lbl-main-hr" style="color:var(--danger); font-weight:bold;">20èŠ‚</span><input type="range" id="range-main" min="0" max="40" value="20" oninput="adjustSchedule('main')" style="width:100%"></div>
                <div><b>ğŸ”¬ å‰¯ç§‘è¯¾æ—¶ (ä¸­å‹/é˜²å®ˆ)</b> <span id="lbl-minor-hr" style="color:var(--primary); font-weight:bold;">15èŠ‚</span><input type="range" id="range-minor" min="0" max="40" value="15" oninput="adjustSchedule('minor')" style="width:100%"></div>
                <div><b>ğŸ¨ ç´ è´¨è¯¾æ—¶ (é™å‹/æš´å‡»)</b> <span id="lbl-spec-hr" style="color:var(--success); font-weight:bold;">5èŠ‚</span><input type="range" id="range-spec" min="0" max="40" value="5" oninput="adjustSchedule('spec')" style="width:100%"></div>
                <div style="text-align:right; font-size:0.9rem; font-weight:bold;">å½“å‰å‘¨è¯¾æ—¶æ€»é‡: <span id="sch-total-hr" style="color:var(--primary)">40</span>/60</div>
            </div>
        </div>
    </div>
</div>

<div id="modal-policy" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>ğŸ« å›½å®¶æ ¡ç­–ç§‘æŠ€æ ‘ (å››å¤§æµæ´¾ 40é¡¹èŠ‚ç‚¹)</div><button class="fs-close" onclick="closeModal('modal-policy')">Ã—</button></div>
        <div class="fs-body">
            <div style="text-align:center; margin-bottom:20px; font-weight:bold;">
                <span style="color:var(--danger); margin-right:15px;">ğŸŸ¥ æé™åº”è¯•çº¿</span>
                <span style="color:var(--warning); margin-right:15px;">ğŸŸ¨ é“è…•çºªå¾‹çº¿</span>
                <span style="color:#fbbf24; margin-right:15px;">ğŸŸ¤ èµ„æœ¬è¿ä½œçº¿</span>
                <span style="color:var(--success);">ğŸŸ© ç´ è´¨å¼€æ”¾çº¿</span>
            </div>
            <div id="policy-container" style="display:flex; flex-direction:column; align-items:center;"></div>
        </div>
    </div>
</div>

<div id="modal-achieve" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>ğŸ† è£èª‰å²å†Œä¸æ°å‡ºæ ¡å‹</div><button class="fs-close" onclick="closeModal('modal-achieve')">Ã—</button></div>
        <div class="fs-body">
            <h3 style="margin-top:0; border-bottom:2px solid #cbd5e1; padding-bottom:5px;">ğŸ“ çŸ¥åæ ¡å‹å½• (å­¦ç”Ÿæ¨¡å¼é€šå…³ç•™å)</h3>
            <div id="alumni-container" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:25px;"></div>
            <h3 style="border-bottom:2px solid #cbd5e1; padding-bottom:5px;">ğŸ† ç»ˆææˆå°± (20é¡¹)</h3>
            <div class="grid-sys" id="achieve-container"></div>
        </div>
    </div>
</div>

<!-- ================= å²è¯—çº§å­¦æœ¯æˆ˜äº‰ PVE UI ================= -->
<div id="modal-battle" class="fs-modal" style="background: rgba(0,0,0,0.95); z-index: 6000;">
    <div class="fs-content" style="max-width: 1000px; background: transparent; box-shadow: none; border: 1px solid #3f6212; height:auto;">
        <div class="battle-ui" id="b-main">
            <div class="b-header">
                <div>[ACADEMIC_WARFARE_OS_v1.1]</div>
                <div style="color:#bef264">>>> ROUND: <span id="b-turn-ui">1</span> / <span id="b-phase-ui" style="color:#fde047">NORMAL_PHASE</span> <<<</div>
            </div>
            
            <div class="b-arena">
                <div class="b-weather" id="b-weather-ui">â›… å¤©æ°”ï¼šæ™´æœ—</div>
                <!-- ç©å®¶é˜µè¥ -->
                <div class="b-entity" id="b-player-card">
                    <div class="b-name" style="color:#93c5fd">> ç©å®¶æœ¬æ ¡é˜µè¥_</div>
                    <div class="b-hp-bg"><div class="b-hp-fill" id="bp-hp-bar"></div><div class="b-hp-txt" id="bp-hp-txt">100 / 100</div></div>
                    <div class="b-stat-grid">
                        <div>æ€ç»´å¼ºåº¦: <span id="bp-atk" style="color:#fff">0</span></div>
                        <div>é€»è¾‘ä¸¥å¯†: <span id="bp-def" style="color:#fff">0</span></div>
                        <div>çµæ„Ÿè¿¸å‘: <span id="bp-crit" style="color:#fde047">0</span>%</div>
                        <div>å­¦æœ¯AP: <span id="bp-ap" style="color:#fbbf24">0</span></div>
                    </div>
                    <div style="margin-top:5px; font-size:0.7rem;">æ€ç»´ç†µå¢: <span id="bp-stress" style="color:#ef4444">0</span> / 100</div>
                    <div class="b-stress-bar"><div class="b-stress-fill" id="bp-stress-bar"></div></div>
                    <div class="b-buffs" id="bp-buffs">BUFFS: NONE</div>
                </div>

                <div style="font-size:3rem; font-weight:900; color:#ef4444; font-family:monospace;">VS</div>

                <!-- æ•Œæ–¹AIé˜µè¥ -->
                <div class="b-entity" id="b-enemy-card">
                    <div class="b-name" style="color:#fca5a5" id="be-name">> æ•Œæ–¹ç›®æ ‡_</div>
                    <div class="b-hp-bg" style="border-color:#fca5a5"><div class="b-hp-fill" id="be-hp-bar" style="background:#dc2626"></div><div class="b-hp-txt" id="be-hp-txt">100 / 100</div></div>
                    <div class="b-stat-grid" style="color:#fca5a5">
                        <div>æ€ç»´å¼ºåº¦: <span id="be-atk" style="color:#fff">0</span></div>
                        <div>é€»è¾‘ä¸¥å¯†: <span id="be-def" style="color:#fff">0</span></div>
                        <div style="grid-column:1/-1;">æµæ´¾è¢«åŠ¨: <span id="be-skill-desc" style="color:#fde047">æœªçŸ¥</span></div>
                    </div>
                    <div style="margin-top:5px; font-size:0.7rem; color:#fca5a5">æ€ç»´ç†µå¢: <span id="be-stress">0</span> / 100</div>
                    <div class="b-stress-bar" style="border-color:#fca5a5"><div class="b-stress-fill" id="be-stress-bar" style="background:#991b1b"></div></div>
                    <div class="b-buffs" id="be-buffs">BUFFS: NONE</div>
                </div>
            </div>

            <!-- æˆ˜æ–—æ’­æŠ¥ç»ˆç«¯ (é«˜åº¦è‡ªé€‚åº”) -->
            <div class="b-log" id="b-log">
                <div class="b-log-inner">
                    <span class="sys">SYSTEM BOOT... ACADEMIC INTERFACE ENGAGED.</span><br>
                    <span class="sys">WAITING FOR EXAM TO START...</span>
                </div>
            </div>

            <div class="b-expert-select" id="b-expert-list"></div>

            <!-- æ“ä½œå° (å›ºå®šåº•éƒ¨) -->
            <div class="b-actions" id="b-action-panel">
                <div class="b-cats">
                    <button class="b-cat-btn" id="cat-atk" onclick="bShowCat('atk')">[1] å‡ºé¢˜æ”»å‡»ç³»</button>
                    <button class="b-cat-btn" id="cat-def" onclick="bShowCat('def')">[2] è§£é¢˜é˜²å®ˆç³»</button>
                    <button class="b-cat-btn" id="cat-sup" onclick="bShowCat('sup')">[3] å­¦æœ¯ç ”è®¨ç³»</button>
                    <button class="b-cat-btn" id="cat-psy" onclick="bShowCat('psy')">[4] å¿ƒç†å¹²æ‰°ç³»</button>
                    <button class="b-cat-btn" id="cat-insp" onclick="bShowCat('insp')">[5] çµæ„Ÿçˆ†å‘ç³»</button>
                    <button class="b-cat-btn" id="cat-sys" onclick="bShowCat('sys')">[6] ä½“ç³»å¿…æ€ç³»</button>
                    <button class="b-cat-btn" style="color:#94a3b8; border-color:#475569;" onclick="bRetreat()">[ESC] ç»“æŸæˆ˜æ–—</button>
                </div>
                <div class="b-skills" id="b-skills-container">
                    <div style="color:#64748b; margin-top:20px; font-size:0.9rem;">PLEASE SELECT A DISCIPLINE MODULE FROM THE LEFT MENU...</div>
                </div>
            </div>
        </div>
        
        <!-- æˆ˜å‰é€‰å¯¹æ‰‹ç•Œé¢ -->
        <div id="b-prep" style="background:#1e293b; padding:30px; border-radius:12px; display:none; color:#f8fafc; border: 2px solid #334155; height:80vh; overflow-y:auto;">
            <h2 style="text-align:center; margin-top:0; color:#fde047;">> å…¨çœå¤§å‹è”è€ƒç›®æ ‡é€‰æ‹© _</h2>
            <p style="text-align:center; color:#94a3b8; margin-bottom:25px;">è¯·é€‰æ‹©ä½ è¦è®¨ä¼çš„é¡¶çº§åæ ¡ï¼Œèƒœåˆ©å°†è·å¾—å·¨é¢æ ¡çº§ç§¯åˆ†ã€‚</p>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px;">Tier 1: ä¹¡é•‡ä¸å¿çº§ (å…¥é—¨)</h3>
            <div class="grid-sys" id="b-rival-t1"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 2: å¸‚çº§ç¤ºèŒƒ (è¿›é˜¶)</h3>
            <div class="grid-sys" id="b-rival-t2"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 3: çœçº§åæ ¡ (å›°éš¾)</h3>
            <div class="grid-sys" id="b-rival-t3"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 4: å…¨å›½ç™¾å¼º (å™©æ¢¦)</h3>
            <div class="grid-sys" id="b-rival-t4"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 5: ä¼ è¯´çº§ç¥åŸŸ (åœ°ç‹±)</h3>
            <div class="grid-sys" id="b-rival-t5"></div>
            
            <div style="text-align:center; margin-top:30px; margin-bottom:50px;">
                <button class="btn-main" style="background:#475569; width:auto; padding:10px 40px;" onclick="closeModal('modal-battle')">ABORT MISSION (æ’¤é€€æ— æƒ©ç½š)</button>
            </div>
        </div>
    </div>
</div>

<!-- é€šç”¨å¼¹çª— -->
<div id="modal-overlay">
    <div class="modal-content">
        <h2 id="modal-title" style="margin-top:0; color:#1e293b;">æ ‡é¢˜</h2>
        <div id="modal-desc" style="line-height:1.6; margin-bottom:25px; font-size:1rem; color:#475569; text-align:left;">å†…å®¹</div>
        <div id="modal-buttons" style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px;"></div>
    </div>
</div>

<script>
    // ================= åŸºç¡€å­—å…¸æ•°æ® =================
    const DIFF_MODS = { 0: { name: "ç®€å•", startFund: 500, stressMult: 0.6, costMult: 0.6 }, 1: { name: "æ­£å¸¸", startFund: 100, stressMult: 1.0, costMult: 1.0 }, 2: { name: "å›°éš¾", startFund: 50,  stressMult: 1.5, costMult: 1.5 } };
    const SCHOOL_LEVELS = [ 
        { name: "ä¹¡é•‡ä¸­å­¦", baseStu: 300, reqRep: 0, reqFunds: 0, reqGrade: 0, reqExam: 0, upkeep: 8, tuition: 0.1 }, 
        { name: "å¿çº§é‡ç‚¹", baseStu: 1000, reqRep: 300, reqFunds: 100, reqGrade: 45, reqExam: 50, upkeep: 25, tuition: 0.15 }, 
        { name: "å¸‚çº§ç¤ºèŒƒ", baseStu: 2500, reqRep: 1000, reqFunds: 400, reqGrade: 60, reqExam: 150, upkeep: 60, tuition: 0.2 }, 
        { name: "çœçº§åæ ¡", baseStu: 5000, reqRep: 4000, reqFunds: 1500, reqGrade: 80, reqExam: 400, upkeep: 150, tuition: 0.25 }, 
        { name: "å…¨å›½é¡¶å°–", baseStu: 10000, reqRep: 10000, reqFunds: 5000, reqGrade: 92, reqExam: 1000, upkeep: 350, tuition: 0.35 } 
    ];
    const TEACHER_TIERS = [ { name: "å®ä¹ ç”Ÿ", multi: 0.8, upCost: 0, salary: 4 }, { name: "å¸‚éª¨å¹²", multi: 1.2, upCost: 40, salary: 12 }, { name: "ç‰¹çº§åå¸ˆ", multi: 1.8, upCost: 120, salary: 35 } ];
    const FAMILIES = [ {id:'worker', name:"å·¥è–ªé˜¶å±‚", desc:"å®¶å¢ƒæ™®é€šï¼Œä½†çˆ¶æ¯åƒè‹¦è€åŠ³ã€‚å¼€å±€èµ„é‡‘å°‘ï¼Œä½†æŠ—å‹å¼ºã€‚(å‹åŠ›ä¸Šé™+20)", money: 200}, {id:'intel', name:"ä¹¦é¦™é—¨ç¬¬", desc:"çˆ¶æ¯æ˜¯æ•™å¸ˆæˆ–å…¬åŠ¡å‘˜ã€‚å¼€å±€å­¦ä¸šä¸è‰ºæœ¯å±æ€§è¾ƒé«˜ï¼Œèµ„é‡‘ä¸­ç­‰ã€‚", money: 500}, {id:'business', name:"ç»å•†ä¸–å®¶", desc:"å®¶é‡Œæœ‰çŸ¿ã€‚å¼€å±€èµ„é‡‘å……è£•ï¼Œä½†çˆ¶æ¯å¿™äºç”Ÿæ„ï¼Œäº²æƒ…æ·¡æ¼ ã€‚(å‹åŠ›å›å¤æ…¢)", money: 2000} ];

    const FACILITIES = { 
        'confucius': { icon: 'ğŸ—¿', levels: [{name:'å­”å­åœ£åƒ',cost:20,desc:'çºªå¾‹+1,å£°èª‰+3/æœˆ'}, {name:'ç™¾å®¶é›•å¡‘ç¾¤',cost:60,desc:'çºªå¾‹+3,å£°èª‰+10/æœˆ'}, {name:'å„’å­¦æœåœ£æ®¿',cost:200,desc:'çºªå¾‹+8,è§£é”ç‰¹æŠ€ã€å­”å­åœ£å…‰ã€‘'}] }, 
        'media': { icon: 'ğŸ¢', levels: [{name:'ç”µæ•™å¤§æ¥¼',cost:40,desc:'å­¦ä¸šå€ç‡æå‡'}, {name:'æ™ºæ…§æ ¡å›­ç½‘',cost:100,desc:'å­¦ä¸šå€ç‡å¤§å¹…æå‡'}, {name:'é‡å­è¶…ç®—ä¸­å¿ƒ',cost:300,desc:'å­¦ä¸šæé€Ÿç‹‚é£™'}] }, 
        'track': { icon: 'ğŸƒ', levels: [{name:'å¡‘èƒ¶æ“åœº',cost:30,desc:'ä½“è´¨+1.5,å‡å‹'}, {name:'å®¤å†…ä½“è‚²é¦†',cost:80,desc:'ä½“è´¨+4,å¤§å¹…å‡å‹'}, {name:'å¥¥æ—åŒ¹å…‹ä¸­å¿ƒ',cost:250,desc:'ä½“è´¨æ°¸ä¸æ‰è½'}] }, 
        'library': { icon: 'ğŸ“š', levels: [{name:'å›¾ä¹¦é¦†',cost:50,desc:'æ¯æœˆå­¦ä¸šåŸºç¡€+1'}, {name:'æ•°å­—åŒ–ä¹¦åŸ',cost:120,desc:'æ¯æœˆå­¦ä¸š+3'}, {name:'å›½å®¶çº§æ–‡çŒ®åº“',cost:400,desc:'æ¯æœˆå­¦ä¸š+8,é«˜æ•™ç ”ç‚¹'}] }, 
        'clinic': { icon: 'ğŸ›‹ï¸', levels: [{name:'å¿ƒç†è¯Šæ‰€',cost:45,desc:'å¾®å¼±å¯¹å†²ä¸»ç§‘é«˜å‹'}, {name:'ç²¾ç¥åº·å¤ä¸­å¿ƒ',cost:150,desc:'å¤§å¹…æ¶ˆé™¤å…¨æ ¡å‹åŠ›'}, {name:'è„‘ç§‘å­¦ç ”ç©¶æ‰€',cost:500,desc:'é«˜å‹ä¸å†äº§ç”Ÿè´Ÿé¢æ•ˆæœ'}] }, 
        'art': { icon: 'ğŸ¨', levels: [{name:'è‰ºæœ¯ä¸­å¿ƒ',cost:60,desc:'ç´ è´¨æå‡'}, {name:'çš‡å®¶å¤§å‰§é™¢',cost:180,desc:'è‰ºæœ¯æ¶µå…»æš´å¢'}, {name:'å›½é™…è‰ºæœ¯å±•é¦†',cost:600,desc:'è‰ºæœ¯æ‹‰æ»¡,å£°èª‰æé«˜'}] }, 
        'lab': { icon: 'ğŸ”¬', levels: [{name:'å®éªŒå¤§æ¥¼',cost:80,desc:'è”è€ƒé¢å¤–æ•™ç ”ç‚¹'}, {name:'å›½å®¶é‡ç‚¹å®éªŒå®¤',cost:250,desc:'æ•™ç ”ç‚¹è·å–ç¿»å€'}, {name:'è¯ºå¥–å­µåŒ–åŸºåœ°',cost:800,desc:'æ•™ç ”ç‚¹æ— é™æº¢å‡º'}] }, 
        'dorm': { icon: 'ğŸ¨', levels: [{name:'è´µæ—å…¬å¯“',cost:100,desc:'è¢«åŠ¨å¸é‡‘'}, {name:'é¡¶å¥¢å…¨æ™¯å¥—æˆ¿',cost:300,desc:'å¸é‡‘èƒ½åŠ›ç¿»å€'}, {name:'ä¼´è¯»ç‹¬æ ‹åˆ«å¢…åŒº',cost:1000,desc:'å¸é‡‘ææ€–,ä½†é™çºªå¾‹'}] }, 
        'hospital': { icon: 'ğŸ¥', levels: [{name:'æ ¡åŒ»é™¢',cost:40,desc:'é˜²ç”Ÿç—…åœè¯¾'}, {name:'ä¸‰ç”²é™„å±åŒ»é™¢',cost:200,desc:'ä½“è´¨é£™å‡,å…ç–«ç–«ç—…'}, {name:'ç”Ÿå‘½ç§‘å­¦ä¸­å¿ƒ',cost:600,desc:'å…¨å‘˜æ»¡è¡€çŠ¶æ€'}] }, 
        'hall': { icon: 'ğŸ›ï¸', levels: [{name:'å¤§ç¤¼å ‚',cost:150,desc:'APä¸Šé™+5'}, {name:'å›½é™…ä¼šè®®ä¸­å¿ƒ',cost:400,desc:'APä¸Šé™+15'}, {name:'è”åˆå›½ä¼šåœº',cost:1500,desc:'APæ— ç©·å°½'}] } 
    };

    const BRANCHES_DB = [
        { id: 'b_hengshui', name: "è¡¡æ°´åˆ†æ ¡", cost: 2000, desc: "å…¨å‘˜æ”»å‡»åŠ›+15%ï¼Œå‹åŠ›ä¸Šé™+20ã€‚æ¯æœˆå£°èª‰+20ã€‚", buff: {atk:1.15, maxHp:1.2} },
        { id: 'b_beijing', name: "åŒ—äº¬åˆ†æ ¡", cost: 3000, desc: "å…¨å‘˜é˜²å¾¡åŠ›+20%ï¼ŒAPä¸Šé™+5ã€‚æ¯æœˆèµ„é‡‘+100ã€‚", buff: {def:1.2, ap:5} },
        { id: 'b_shanghai', name: "é­”éƒ½å›½é™…éƒ¨", cost: 4000, desc: "å…¨å‘˜æš´å‡»ç‡+10%ï¼ŒAPæ¶ˆè€—å‡å°‘ã€‚æ¯æœˆå£°èª‰+50ã€‚", buff: {crit:10, apRed:1} },
        { id: 'b_harvard', name: "å“ˆä½›é¢„ç§‘è¥", cost: 10000, desc: "å…¨å±æ€§+20%ï¼Œè§£é”éšè—æŠ€èƒ½ã€‚æ¯æœˆèµ„é‡‘+500ã€‚", buff: {all:1.2} },
        { id: 'b_oxford', name: "ç‰›æ´¥ä¹¦é™¢", cost: 8000, desc: "é˜²å¾¡åŠ›+30%ï¼Œå…ç–«æ™•çœ©ã€‚æ¯æœˆæ•™ç ”ç‚¹+50ã€‚", buff: {def:1.3, immune:true} },
        { id: 'b_huanggang', name: "é»„å†ˆå¯†å·å‚", cost: 2500, desc: "æ”»å‡»åŠ›+25%ï¼Œæ¯å›åˆè‡ªä¼¤ã€‚æ¯æœˆå­¦ä¸š+5ã€‚", buff: {atk:1.25, selfDmg:true} }
    ];

    const EXPERT_POOL = [
        { id: 'e1', name: "é€€å½¹é­”é¬¼æ•™å®˜", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: ä½¿æ•Œæ–¹å‹åŠ›+2ã€‚", battle: (p,e)=>{ e.stress+=2; return "æ•Œæ–¹å‹åŠ›+2"; } },
        { id: 'e2', name: "æŠ é—¨è€å‡ºçº³", rarity: 'R', upkeep: 2, desc: "è¢«åŠ¨: é™ä½15%å­¦æ ¡å¸¸è€—ã€‚", battle: null },
        { id: 'e3', name: "å‡¶æ‚å®¿ç®¡å¤§å¦ˆ", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: å·±æ–¹é˜²å¾¡+5%ã€‚", battle: (p,e)=>{ p.def*=1.05; return "é˜²å¾¡+5%"; } },
        { id: 'e4', name: "æ–°ä¸œæ–¹å¤§å¨", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: å›å¤2%HPã€‚", battle: (p,e)=>{ p.hp+=p.maxHp*0.02; return "å›å¤å°‘é‡HP"; } },
        { id: 'e5', name: "é“å£é—¨å«å¤§çˆ·", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: å·±æ–¹é˜²å¾¡+10%ã€‚", battle: (p,e)=>{ p.def*=1.1; return "é˜²å¾¡+10%"; } },
        { id: 'e6', name: "å®ä¹ å¿ƒç†åŒ»ç”Ÿ", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: å‡å‹3ç‚¹ã€‚", battle: (p,e)=>{ p.stress=Math.max(0,p.stress-3); return "å‹åŠ›-3"; } },
        { id: 'e7', name: "é€€ä¼‘è€ç‰¹çº§", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: æ”»å‡»åŠ›+5%ã€‚", battle: (p,e)=>{ p.atk*=1.05; return "æ”»å‡»+5%"; } },
        { id: 'e8', name: "é¸¡è¡€å®£ä¼ å¹²äº‹", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: å£«æ°”ä¸é™ã€‚", battle: (p,e)=>{ p.morale=100; return "å£«æ°”é”å®š"; } },
        { id: 'e9', name: "æµ·å½’é’å¹´å­¦è€…", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: æš´å‡»ç‡+5%ã€‚", battle: (p,e)=>{ p.crit+=5; return "æš´å‡»+5%"; } },
        { id: 'e10', name: "æƒå¨å¿ƒç†å­¦æ•™æˆ", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: æ•Œæ–¹æ”»å‡»-10%ã€‚", battle: (p,e)=>{ e.atk*=0.9; return "æ•Œæ”»-10%"; } },
        { id: 'e11', name: "å›½å®¶çº§é‡‘ç‰Œæ•™ç»ƒ", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: æ”»å‡»åŠ›+15%ã€‚", battle: (p,e)=>{ p.atk*=1.15; return "æ”»å‡»+15%"; } },
        { id: 'e12', name: "æŠ–éŸ³ç½‘çº¢åå¸ˆ", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: æ¦‚ç‡ä½¿æ•Œæ–¹æ™•çœ©ã€‚", battle: (p,e)=>{ if(Math.random()<0.1){e.buffs.stun=1; return "æ•Œæ–¹æ™•çœ©!";} return null; } },
        { id: 'e13', name: "é“è…•çº§éƒ¨ä¸»ä»»", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: å·±æ–¹é˜²å¾¡+20%ã€‚", battle: (p,e)=>{ p.def*=1.2; return "é˜²å¾¡+20%"; } },
        { id: 'e14', name: "é€€å½¹å¥¥è¿å¥å°†", rarity: 'SR', upkeep: 10, desc: "è¢«åŠ¨: HPä¸Šé™æå¤§å¹…æå‡", battle: null },
        { id: 'e15', name: "è½é­„è‰ºæœ¯å¤§å¸ˆ", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: æš´å‡»ä¼¤å®³+50%ã€‚", battle: (p,e)=>{ p.buffs.dmgUp=1; return "çˆ†ä¼¤æå‡"; } },
        { id: 'e16', name: "å…¨å›½å‘½é¢˜ç»„ç»„é•¿", rarity: 'SSR', upkeep: 50, desc: "æˆ˜æ–—: æ”»å‡»åŠ›+30%ã€‚", battle: (p,e)=>{ p.atk*=1.3; return "æ”»å‡»+30%"; } },
        { id: 'e17', name: "åƒäº¿å•†ä¸šå·¨å­", rarity: 'SSR', upkeep: 50, desc: "æˆ˜æ–—: å›å¤3APã€‚", battle: (p,e)=>{ p.ap+=3; return "AP+3"; } },
        { id: 'e18', name: "è¯ºå¥–åè£”å¾—ä¸»", rarity: 'SSR', upkeep: 50, desc: "æˆ˜æ–—: å…¨å±æ€§+15%ã€‚", battle: (p,e)=>{ p.atk*=1.15; p.def*=1.15; return "å…¨èƒ½+15%"; } },
        { id: 'e19', name: "æ•™è‚²å…ç‰¹æ´¾å‘˜", rarity: 'SSR', upkeep: 50, desc: "æˆ˜æ–—: æ•Œæ–¹å…¨å±æ€§-10%ã€‚", battle: (p,e)=>{ e.atk*=0.9; e.def*=0.9; return "æ•Œå…¨å‡10%"; } },
        { id: 'e20', name: "å­”å­è½¬ä¸–æœ¬å°Š", rarity: 'SSR', upkeep: 150, desc: "æˆ˜æ–—: ç¥ä½‘å¤è‹ã€‚", battle: (p,e)=>{ p.hp=p.maxHp; p.stress=0; return "ç¥ä½‘å¤è‹"; } },
    ];

    const SKILL_DB = {
        // --- æ”»å‡»ç³» (ATK) ---
        'atk_0': { cat: 'atk', name: 'å¹³Aå‡ºé¢˜', desc: 'æ— æ¶ˆè€—ã€‚é€ æˆ100%ä¼¤å®³ã€‚', ap: 0, req: ()=>true },
        'atk_1': { cat: 'atk', name: 'éšå ‚æµ‹éªŒ', desc: 'AP:5ã€‚é€ æˆ120%ä¼¤å®³ã€‚', ap: 5, req: ()=>true },
        'atk_2': { cat: 'atk', name: 'åˆ·é¢˜æœºå™¨', desc: 'AP:3ã€‚é€ æˆ80%ä¼¤å®³ï¼Œå›å¤2%HPã€‚', ap: 3, req: ()=>true },
        'atk_3': { cat: 'atk', name: 'æœˆè€ƒè½°ç‚¸', desc: 'AP:15ã€‚é€ æˆ150%ä¼¤å®³ï¼Œæ•Œæ–¹å‹åŠ›+5ã€‚', ap: 15, req: ()=>true },
        'atk_4': { cat: 'atk', name: 'é¢˜æµ·æ·¹æ²¡', desc: 'AP:25ã€‚é€ æˆ3æ®µ60%ä¼¤å®³ã€‚', ap: 25, req: ()=>game.teachers.main>=1 },
        'atk_5': { cat: 'atk', name: 'å‡½æ•°å‹è½´é¢˜', desc: 'AP:35ã€‚é€ æˆ250%ç‰©ç†ä¼¤å®³ã€‚', ap: 35, req: ()=>game.teachers.main>=1 },
        'atk_6': { cat: 'atk', name: 'è‹±è¯­å¬åŠ›', desc: 'AP:18ã€‚é€ æˆ110%ä¼¤å®³ï¼Œæ— è§†éƒ¨åˆ†é˜²å¾¡ã€‚', ap: 18, req: ()=>game.teachers.main>=1 },
        'atk_7': { cat: 'atk', name: 'åŒ–å­¦æ–¹ç¨‹å¼', desc: 'AP:30ã€‚é€ æˆ180%ä¼¤å®³ï¼Œé™„åŠ è…èš€ã€‚', ap: 30, req: ()=>game.teachers.minor>=1 },
        'atk_8': { cat: 'atk', name: 'ç‰©ç†åŠ›å­¦', desc: 'AP:45ã€‚é€ æˆ350%ä¼¤å®³ï¼Œè‡ªèº«æ™•çœ©1å›åˆã€‚', ap: 45, req: ()=>game.teachers.minor>=2 },
        'atk_9': { cat: 'atk', name: 'ç”Ÿç‰©é—ä¼ å›¾', desc: 'AP:22ã€‚é€ æˆ140%ä¼¤å®³ï¼Œæ•Œæ”»ä¸‹é™ã€‚', ap: 22, req: ()=>game.teachers.minor>=1 },
        'atk_10': { cat: 'atk', name: 'æ”¿æ²»è¾¨æ', desc: 'AP:40ã€‚é€ æˆ300%ç²¾ç¥ä¼¤å®³ã€‚', ap: 40, req: ()=>game.teachers.spec>=2 },

        // --- é˜²å®ˆç³» (DEF) ---
        'def_0': { cat: 'def', name: 'æ•´ç†é”™é¢˜æœ¬', desc: 'AP:5ã€‚ä¸‹å›åˆå‡ä¼¤30%ã€‚', ap: 5, req: ()=>true },
        'def_1': { cat: 'def', name: 'æ ‡å‡†ç­”æ¡ˆ', desc: 'AP:10ã€‚å›å¤15% HPï¼Œæ¸…é™¤ä¸€ä¸ªè´Ÿé¢ã€‚', ap: 10, req: ()=>true },
        'def_2': { cat: 'def', name: 'ä¸¤è€³ä¸é—»', desc: 'AP:8ã€‚é˜²å¾¡+50%ï¼Œå›å¤5APã€‚', ap: 8, req: ()=>true },
        'def_3': { cat: 'def', name: 'è€ƒå‰åˆ’é‡ç‚¹', desc: 'AP:15ã€‚é˜²å¾¡+50%ï¼ŒæŒç»­2å›åˆã€‚', ap: 15, req: ()=>true },
        'def_4': { cat: 'def', name: 'å¿ƒç†å»ºè®¾', desc: 'AP:12ã€‚å‹åŠ›-20ã€‚', ap: 12, req: ()=>true },
        'def_5': { cat: 'def', name: 'é¢˜æµ·æŠ¤ç›¾', desc: 'AP:20ã€‚æŠµæŒ¡500ä¼¤å®³çš„æŠ¤ç›¾ã€‚', ap: 20, req: ()=>game.teachers.main>=1 },
        'def_6': { cat: 'def', name: 'åå¸ˆç‚¹æ‹¨', desc: 'AP:25ã€‚å›å¤30% HPã€‚', ap: 25, req: ()=>game.teachers.spec>=1 },
        'def_7': { cat: 'def', name: 'ç»å¯¹é˜²å¾¡', desc: 'AP:40ã€‚ä¸‹å›åˆæ— æ•Œã€‚', ap: 40, req: ()=>game.teachers.main>=2 },
        'def_8': { cat: 'def', name: 'é€»è¾‘é—­ç¯', desc: 'AP:30ã€‚åå¼¹ä¸‹ä¸€æ¬¡ä¼¤å®³ã€‚', ap: 30, req: ()=>game.teachers.minor>=2 },

        // --- ç ”è®¨ç³» (SUP) ---
        'sup_0': { cat: 'sup', name: 'å°ç»„è®¨è®º', desc: 'AP:5ã€‚å›å¤10ç‚¹APã€‚', ap: 5, req: ()=>true },
        'sup_1': { cat: 'sup', name: 'å…¨ç­ä¼ çº¸æ¡', desc: 'AP:10ã€‚å›è¡€å°‘è®¸ï¼ŒAP+5ã€‚', ap: 10, req: ()=>true },
        'sup_2': { cat: 'sup', name: 'äº’å¸®äº’åŠ©', desc: 'AP:15ã€‚æ”»+20%ï¼ŒæŒç»­3å›åˆã€‚', ap: 15, req: ()=>true },
        'sup_3': { cat: 'sup', name: 'å¤´è„‘é£æš´', desc: 'AP:20ã€‚æš´å‡»+40%ï¼ŒæŒç»­2å›åˆã€‚', ap: 20, req: ()=>game.teachers.spec>=1 },
        'sup_4': { cat: 'sup', name: 'å­¦æœ¯æ²™é¾™', desc: 'AP:25ã€‚å…¨å‘˜å›è¡€å›è“ã€‚', ap: 25, req: ()=>hasExpert('e18') },
        
        // --- å¿ƒç†ç³» (PSY) ---
        'psy_0': { cat: 'psy', name: 'æ­»äº¡å‡è§†', desc: 'AP:10ã€‚æ•Œæ–¹å‹åŠ›+15ã€‚', ap: 10, req: ()=>true },
        'psy_1': { cat: 'psy', name: 'å‡¡å°”èµ›å‘è¨€', desc: 'AP:15ã€‚æ•Œæ–¹å‹åŠ›+25ï¼Œæ•Œæ”»+10%ã€‚', ap: 15, req: ()=>true },
        'psy_2': { cat: 'psy', name: 'æ’•æ¯è¯•å·', desc: 'AP:20ã€‚æ•Œæ”»-30%ã€‚', ap: 20, req: ()=>true },
        'psy_3': { cat: 'psy', name: 'æ’åå…¬å¸ƒ', desc: 'AP:30ã€‚é€ æˆæ•Œæ–¹å½“å‰HP 20%ä¼¤å®³ã€‚', ap: 30, req: ()=>game.teachers.main>=1 },
        'psy_4': { cat: 'psy', name: 'å«å®¶é•¿', desc: 'AP:40ã€‚æ•Œæ–¹æ™•çœ©1å›åˆï¼Œå¤§ä¼¤å®³ã€‚', ap: 40, req: ()=>game.teachers.main>=2 },

        // --- çµæ„Ÿç³» (INSP) ---
        'insp_0': { cat: 'insp', name: 'è’™ä¸€ä¸ª', desc: 'AP:5ã€‚50%å‡ ç‡300%ä¼¤ï¼Œ50% missã€‚', ap: 5, req: ()=>true },
        'insp_1': { cat: 'insp', name: 'æŠ¼é¢˜å‘½ä¸­', desc: 'AP:30ã€‚30%å‡ ç‡é€ æˆ999ä¼¤å®³ã€‚', ap: 30, req: ()=>true },
        'insp_2': { cat: 'insp', name: 'çµå…‰ä¹ç°', desc: 'AP:20ã€‚å¿…å®šæš´å‡»ã€‚', ap: 20, req: ()=>game.art>50 },
        'insp_3': { cat: 'insp', name: 'è‰ºæœ¯é€šæ„Ÿ', desc: 'AP:30ã€‚åŸºäºè‰ºæœ¯å±æ€§é€ æˆå·¨é¢ä¼¤å®³ã€‚', ap: 30, req: ()=>game.art>70 },

        // --- ä½“ç³»ç³» (SYS) ---
        'sys_è¡¡æ°´': { cat: 'sys', name: 'è¡¡æ°´æ¨¡å¼', desc: 'AP:50ã€‚æ”»å‡»ç¿»å€ï¼Œè‡ªæ®‹ã€‚', ap: 50, req: ()=>hasPolicy('A8') },
        'sys_ç´ è´¨': { cat: 'sys', name: 'ç´ è´¨æ•™è‚²', desc: 'AP:50ã€‚å…¨å±æ€§+30%ï¼Œå›è¡€ã€‚', ap: 50, req: ()=>hasPolicy('D7') },
        'sys_èµ„æœ¬': { cat: 'sys', name: 'é’èƒ½åŠ›', desc: 'AP:0ã€‚è€—50ä¸‡ï¼Œä¼¤9999ã€‚', ap: 0, req: ()=>hasExpert('e17') }
    };

    const RIVALS = [
        { id: 't1_1', tier:1, name: "æ‘å£å¸Œæœ›ä¸­å­¦", hp: 4000, atk: 650, def: 60, pts: 5 },
        { id: 't1_2', tier:1, name: "é•‡åŠç¬¬ä¸‰ä¸­å­¦", hp: 5500, atk: 750, def: 120, pts: 8 },
        { id: 't1_3', tier:1, name: "å¿èŒä¸šä¸­ä¸“", hp: 7000, atk: 850, def: 150, pts: 10 },
        { id: 't2_1', tier:2, name: "å¿ç¬¬ä¸€ä¸­å­¦", hp: 10500, atk: 1000, def: 300, pts: 15 },
        { id: 't2_2', tier:2, name: "å¸‚æ™®é€šé«˜ä¸­", hp: 13500, atk: 1150, def: 360, pts: 18 },
        { id: 't2_3', tier:2, name: "ç§ç«‹è´µæ—å­¦æ ¡", hp: 15000, atk: 1300, def: 300, pts: 20 },
        { id: 't3_1', tier:3, name: "å¸‚å®éªŒä¸­å­¦", hp: 24000, atk: 1600, def: 600, pts: 30 },
        { id: 't3_2', tier:3, name: "å¸‚å¤–å›½è¯­", hp: 27000, atk: 1750, def: 540, pts: 35 },
        { id: 't3_3', tier:3, name: "çœé™„å±åˆ†æ ¡", hp: 30000, atk: 1900, def: 750, pts: 40 },
        { id: 't4_1', tier:4, name: "çœå®éªŒä¸­å­¦", hp: 45000, atk: 2500, def: 1200, pts: 50 },
        { id: 't4_2', tier:4, name: "çœå¸ˆå¤§é™„ä¸­", hp: 48000, atk: 2650, def: 1260, pts: 55 },
        { id: 't4_3', tier:4, name: "ç™¾å¹´è€æ ¡ä¸€ä¸­", hp: 54000, atk: 2800, def: 1500, pts: 60 },
        { id: 't5_1', tier:5, name: "è¡¡æ°´é’¢é“ä¸­å­¦", hp: 90000, atk: 4600, def: 2400, pts: 100 },
        { id: 't5_2', tier:5, name: "åŒ—äº¬å››ä¸­æœ¬éƒ¨", hp: 105000, atk: 3700, def: 3600, pts: 120 },
        { id: 't5_3', tier:5, name: "é»„å†ˆå¯†å·å·¥å‚", hp: 84000, atk: 6100, def: 1500, pts: 150 },
        { id: 't5_4', tier:5, name: "äººå¤§é™„ä¸­ç¥åŸŸ", hp: 120000, atk: 4900, def: 3000, pts: 200 },
        { id: 't5_5', tier:5, name: "å®‡å®™çœŸç†ä¸­å­¦", hp: 150000, atk: 7600, def: 7500, pts: 500 }
    ];

    const WEATHER_TYPES = [
        { id: 'sun', name: 'â˜€ï¸ æ™´æœ—', desc: 'æ— ç‰¹æ®Šæ•ˆæœ', effect: ()=>{} },
        { id: 'rain', name: 'ğŸŒ§ï¸ é˜´é›¨', desc: 'å…¨å‘˜å¿ƒæƒ…ä½è½ï¼Œæš´å‡»ç‡-10%', effect: (p,e)=>{p.crit-=10; e.crit-=10;} },
        { id: 'morning', name: 'ğŸ“– æ—©è¯»å£°æµª', desc: 'æ€ç»´æ´»è·ƒï¼ŒåŒæ–¹æ”»å‡»åŠ›+20%', effect: (p,e)=>{p.atk*=1.2; e.atk*=1.2;} },
        { id: 'sleepy', name: 'ğŸ˜´ åˆåå›°å€¦', desc: 'æ˜æ˜æ¬²ç¡ï¼ŒåŒæ–¹é˜²å¾¡åŠ›-30%', effect: (p,e)=>{p.def*=0.7; e.def*=0.7;} },
        { id: 'storm', name: 'âš¡ è€ƒè¯•é£æš´', desc: 'å‹åŠ›éª¤å¢ï¼Œæ¯å›åˆå¢åŠ 10ç‚¹ç†µå¢', effect: (p,e)=>{p.stress+=10; e.stress+=10;} }
    ];

    const POLICY_TREE = [
        { tier: 1, nodes: [
            { id: "A1", name: "å†›äº‹åŒ–æ—©è¯»", class: "branch-a", desc: "å­¦ä¸š+1, å‹åŠ›+1", cost: 10, req: null },
            { id: "B1", name: "ä»ªå®¹ä»ªè¡¨å¤§æ£€æŸ¥", class: "branch-b", desc: "çºªå¾‹+1, è‰ºæœ¯-1", cost: 10, req: null },
            { id: "C1", name: "å°å–éƒ¨ç–¯ç‹‚æ¶¨ä»·", class: "branch-c", desc: "æ¯æœˆèµ„é‡‘ç•¥å¢, çºªå¾‹-1", cost: 10, req: null },
            { id: "D1", name: "å¼€è®¾è¯¾å¤–ç¤¾å›¢", class: "branch-d", desc: "è‰ºæœ¯+1, å‹åŠ›-1", cost: 10, req: null }
        ]},
        { tier: 2, nodes: [
            { id: "A2", name: "å¼ºåˆ¶æ™šè‡ªä¹ ", class: "branch-a", desc: "å­¦ä¸š+2, å‹åŠ›+2", cost: 20, req: "A1" },
            { id: "A3", name: "æœˆè€ƒçº¢æ¦œå¤§å­—æŠ¥", class: "branch-a", desc: "å­¦ä¸š+1, çºªå¾‹+1", cost: 20, req: "A1" },
            { id: "B2", name: "å…¨æ ¡ç”µå­è®¾å¤‡ç¦ä»¤", class: "branch-b", desc: "çºªå¾‹+2, å‹åŠ›+1", cost: 20, req: "B1" },
            { id: "B3", name: "ç”·å¥³ç”Ÿåˆ†æ¡Œè¿›é¤", class: "branch-b", desc: "é˜²æ—©æ‹, çºªå¾‹+1", cost: 20, req: "B1" },
            { id: "C2", name: "é£Ÿå ‚å¯¹å¤–å±‚å±‚æ‰¿åŒ…", class: "branch-c", desc: "èµ„é‡‘å¢åŠ , ä½“è´¨-2", cost: 20, req: "C1" },
            { id: "C3", name: "èµåŠ©è´¹æ˜ç æ ‡ä»·", class: "branch-c", desc: "å½•å–é™åˆ†æ”¶é’±, èµ„é‡‘å¤§å¢", cost: 20, req: "C1" },
            { id: "D2", name: "è½å®å‘¨æœ«åŒä¼‘", class: "branch-d", desc: "å‹åŠ›-3, å­¦ä¸š-1", cost: 20, req: "D1" },
            { id: "D3", name: "å…¨æ ¡è‰ºæœ¯èŠ‚ç­¹åŠ", class: "branch-d", desc: "è‰ºæœ¯+3, æ¶ˆè€—èµ„é‡‘", cost: 20, req: "D1" }
        ]},
        { tier: 3, nodes: [
            { id: "A4", name: "å‘¨æœ«ç–¯ç‹‚è¡¥è¯¾", class: "branch-a", desc: "å­¦ä¸š+3, å‹åŠ›+4", cost: 50, req: "A2" },
            { id: "A5", name: "é¢˜æµ·æˆ˜æœ¯å¤§çˆ†å‘", class: "branch-a", desc: "å­¦ä¸š+3, ä½“è´¨-2", cost: 50, req: "A3" },
            { id: "B4", name: "æ•™å®¤360åº¦ç›‘æ§", class: "branch-b", desc: "çºªå¾‹+3, å‹åŠ›+2", cost: 50, req: "B2" },
            { id: "B5", name: "è¿ç¦å“åœ°æ¯¯å¼æœæŸ¥", class: "branch-b", desc: "çºªå¾‹+2, ä½“è´¨+1", cost: 50, req: "B3" },
            { id: "C4", name: "å­¦åŒºæˆ¿ç–¯ç‹‚ç‚’ä½œ", class: "branch-c", desc: "æå‡åæ°”å’Œèµ„é‡‘", cost: 50, req: "C2" },
            { id: "C5", name: "å‹æ¦¨åº•è–ªå®ä¹ æ•™å¸ˆ", class: "branch-c", desc: "æ•™å¸ˆå·¥èµ„å¤§å¹…é™ä½", cost: 50, req: "C3" },
            { id: "D4", name: "å¿ƒç†å¥åº·è¯Šç–—å‘¨", class: "branch-d", desc: "å‹åŠ›-5, çºªå¾‹+1", cost: 50, req: "D2" },
            { id: "D5", name: "å¤§å­¦å¼è‡ªç”±èµ°ç­åˆ¶", class: "branch-d", desc: "è‰ºæœ¯+4, çºªå¾‹-2", cost: 50, req: "D3" }
        ]},
        { tier: 4, nodes: [
            { id: "A6", name: "æœ«ä½æ·˜æ±°åˆ¶é‡ç‚¹ç­", class: "branch-a", desc: "å­¦ä¸š+5, æåº¦é«˜å‹", cost: 100, req: "A4" },
            { id: "A7", name: "å¥¥èµ›å¼ºåŸºæå°–è¥", class: "branch-a", desc: "å­¦ä¸š+4, çƒ§é’±", cost: 100, req: "A5" },
            { id: "B6", name: "å­¦ç”Ÿäº’ç›¸ä¸¾æŠ¥å¥–åŠ±åˆ¶", class: "branch-b", desc: "çºªå¾‹+5, å‹åŠ›çˆ†è¡¨", cost: 100, req: "B4" },
            { id: "B7", name: "å†›è®­å¸¸æ€åŒ–", class: "branch-b", desc: "ä½“è´¨+5, çºªå¾‹+3", cost: 100, req: "B5" },
            { id: "C6", name: "å›½é™…åœŸè±ªç­å‰²éŸ­èœ", class: "branch-c", desc: "èµ„é‡‘æ¯æœˆå·¨é¢å…¥è´¦", cost: 100, req: "C4" },
            { id: "C7", name: "å¼ºè¿«è´­ä¹°å¤©ä»·æ ¡æœ", class: "branch-c", desc: "èµ„é‡‘æš´æ¶¨, å£°èª‰è·Œ", cost: 1000, req: "C5" },
            { id: "D6", name: "æ ¡å›­æ‹çˆ±å®Œå…¨è§£ç¦", class: "branch-d", desc: "å‹åŠ›-8, çºªå¾‹-5", cost: 1000, req: "D4" },
            { id: "D7", name: "å¸¸é’è—¤ç´ è´¨è€ƒæ ¸æ ‡å‡†", class: "branch-d", desc: "è‰ºæœ¯/ä½“è´¨+5, å£°èª‰é£™å‡", cost: 1000, req: "D5" }
        ]},
        { tier: 5, nodes: [
            { id: "A8", name: "ã€ç»ˆæã€‘è¡¡æ°´é«˜è€ƒé›†ä¸­è¥", class: "branch-a", desc: "è§£é”å¿…æ€æŠ€ã€åœ°ç‹±å‘¨ç‰¹è®­ã€‘", cost: 30000, req: "A6" },
            { id: "B8", name: "ã€ç»ˆæã€‘æ–¯å·´è¾¾ç»å¯¹æœä»", class: "branch-b", desc: "çºªå¾‹é”æ­»100", cost: 30000, req: "B6" },
            { id: "C8", name: "ã€ç»ˆæã€‘çº³æ–¯è¾¾å…‹ä¸Šå¸‚é›†å›¢", class: "branch-c", desc: "èµ„é‡‘æ— é™è†¨èƒ€", cost: 30000, req: "C6" },
            { id: "D8", name: "ã€ç»ˆæã€‘ç†æƒ³ä¹Œæ‰˜é‚¦æ ¡å›­", class: "branch-d", desc: "å‹åŠ›æ°¸è¿œä¸º0", cost: 30000, req: "D6" }
        ]}
    ];

    const ACHIEVEMENTS = [ 
        { id: 'a1', name: "ğŸ’¸ ç¬¬ä¸€æ¡¶é‡‘", desc: "èµ„é‡‘ç ´ 1,000 ä¸‡" }, 
        { id: 'a2', name: "ğŸ¤‘ å•†ä¸šå¸å›½", desc: "èµ„é‡‘ç ´ 1 äº¿" }, 
        { id: 'a3', name: "ğŸŒŸ åæ»¡å¤©ä¸‹", desc: "å£°èª‰ç ´ 10,000 ç‚¹" }, 
        { id: 'a4', name: "ğŸ‘‘ æ•™è‚²éœ¸ä¸»", desc: "å­¦æ ¡è¯„çº§è¾¾åˆ°ã€å…¨å›½é¡¶å°–ã€‘" }, 
        { id: 'a5', name: "ğŸ“ å­¦æœ¯æ³°æ–—", desc: "å…¨æ ¡å­¦ä¸šå¹³å‡è¾¾åˆ°90" }, 
        { id: 'a6', name: "ğŸ­ å·ç‹ä¹‹ç‹", desc: "ä¸»ç§‘è¯¾æ—¶æ’æ»¡40èŠ‚" }, 
        { id: 'a7', name: "ğŸ¥‡ å¥¥èµ›å¼ºæ ¡", desc: "ç‚¹äº®å¥¥èµ›å¼ºåŸºæ”¿ç­–" }, 
        { id: 'a8', name: "ğŸ’¥ é«˜å‹é”…ç‚¸äº†", desc: "å…¨æ ¡å¹³å‡å‹åŠ›çˆ†è¡¨100" }, 
        { id: 'a9', name: "ğŸš” æ— æ³•æ— å¤©", desc: "çºªå¾‹è·Œç ´10" }, 
        { id: 'a10', name: "ğŸƒ æ¬§çš‡é™„ä½“", desc: "æŠ½åˆ° SSR çº§ä¸“å®¶" }, 
        { id: 'a11', name: "ğŸ—ï¸ åŸºå»ºç‹‚é­”", desc: "å»ºæ»¡20å—åœ°çš®" }, 
        { id: 'a12', name: "ğŸ‘¨â€ğŸ« ç¾¤æ˜Ÿé—ªè€€", desc: "é›†é½20ä½åå¸ˆ" }, 
        { id: 'a13', name: "ğŸ“œ æ³•å®¶å¤§æˆ", desc: "ç‚¹æ»¡å…¨éƒ¨15é¡¹æ ¡ç­–" }, 
        { id: 'a14', name: "ğŸ‘¨â€ğŸ“ é‡‘æ¦œé¢˜å", desc: "å­¦ç”Ÿæ¨¡å¼é«˜è€ƒè¾¾åˆ°680åˆ†" }, 
        { id: 'a15', name: "ğŸ’• é’æ˜¥æ— æ‚”", desc: "å­¦ç”Ÿæ¨¡å¼è¡¨ç™½æˆåŠŸ" }, 
        { id: 'a16', name: "ğŸ’€ å½»åº•å´©æºƒ", desc: "å­¦ç”Ÿæ¨¡å¼å‹åŠ›çªç ´100" }, 
        { id: 'a17', name: "âš”ï¸ å¯†å·å…‹æ˜Ÿ", desc: "PVEä¸­å‡»æºƒé»„å†ˆå¯†å·å·¥å‚" }, 
        { id: 'a18', name: "ğŸŒ å…¨çƒéœ¸æƒ", desc: "å»ºç«‹å…¨éƒ¨æµ·å¤–åˆ†æ ¡" },
        { id: 'a19', name: "ğŸ… å›½å®¶é˜Ÿ", desc: "å­¦ç”Ÿæ¨¡å¼è·å¾—å¥¥èµ›ä¿é€" },
        { id: 'a20', name: "ğŸ† ä¸‡è±¡å½’ä¸€", desc: "è§£é”å…¨éƒ¨æˆå°±ï¼" } 
    ];

    const FRIENDS = [
        {id:'f1', name:'ğŸ¤“ å­¦éœ¸åŒæ¡Œ', cost:200, desc:'æ¯æœˆå­¦ä¸š+2', eff:()=>{stuGame.grade+=2;}},
        {id:'f2', name:'ğŸ’° å¯ŒäºŒä»£å‘å°', cost:500, desc:'æ¯æœˆé›¶èŠ±é’±+100', eff:()=>{stuGame.money+=100;}},
        {id:'f3', name:'ğŸƒ ä½“è‚²ç‰¹é•¿ç”Ÿ', cost:200, desc:'æ¯æœˆä½“è´¨+3', eff:()=>{stuGame.fit+=3;}}
    ];

    const EVENT_POOL = [
        { t: "æ•™è‚²å±€çªå‡»æš—è®¿", d: "ä¸Šé¢çªå‡»æ£€æŸ¥è¿è§„è¡¥è¯¾ã€‚", o1: "å¡é’±æ‰“ç‚¹", a1:{act:()=>payCost(0,5)?(log("èŠ±é’±æ¶ˆç¾"),true):false, txt:"è€—èµ„ï¿¥5ä¸‡"}, o2: "ç¡¬æŠ—å®¡æŸ¥", a2:{act:()=>{game.discipline>65?mod("rep",15):mod("rep",-20);return true;}, txt:"çºªå¾‹>65å£°èª‰+15ï¼Œå¦åˆ™-20"} },
        { t: "é£Ÿå ‚é¼ å¤´é¸­è„–äº‹ä»¶", d: "å­¦ç”Ÿæ‹ç…§å‘äº†å¾®åšçƒ­æœã€‚", o1: "èŠ±é’±å‹çƒ­æœ", a1:{act:()=>payCost(0,10)?(mod("stress",5),true):false, txt:"è€—èµ„ï¿¥10ä¸‡,å‹åŠ›+5"}, o2: "æ‰¿è®¤å¹¶æ•´æ”¹", a2:{act:()=>{mod("rep",-20); mod("funds",-5);return true;}, txt:"å£°èª‰-20,èµ„é‡‘-5ä¸‡"} },
        { t: "å¤©å°æŠ‘éƒé¢„è­¦", d: "æœ‰å­¦ç”Ÿå—ä¸äº†çˆ¬ä¸Šå¤©å°ï¼", o1: "ç´§æ€¥å¿ƒç†å¹²é¢„", a1:{act:()=>payCost(2,5)?(mod("stress",-10),true):false, txt:"è€—AP:2,ï¿¥5ä¸‡,å‹åŠ›-10"}, o2: "æ¶ˆé˜²å¼ºè¡Œæ‹‰ä¸‹", a2:{act:()=>{mod("stress",15);return true;}, txt:"å‹åŠ›+15"} },
        { t: "å°–å­ç”Ÿæ—©æ‹è¢«æŠ“", d: "å…¨æ ¡ç¬¬ä¸€å’Œç¬¬äºŒåœ¨æ“åœºçº¦ä¼šã€‚", o1: "æ£’æ‰“é¸³é¸¯è®°è¿‡", a1:{act:()=>{mod("stress",10); mod("disc",5);return true;}, txt:"å‹åŠ›+10,çºªå¾‹+5"}, o2: "é¡ºå…¶è‡ªç„¶", a2:{act:()=>{mod("grade",-5); mod("disc",-5);return true;}, txt:"å­¦ä¸š-5,çºªå¾‹-5"} },
        { t: "æ ¡å¤–é»‘å¸®æ”¶ä¿æŠ¤è´¹", d: "å‘¨è¾¹æ²»å®‰æ€¥å‰§æ¶åŒ–ã€‚", o1: "é›‡ä½£å®‰ä¿é˜Ÿ", a1:{act:()=>payCost(0,8)?(mod("disc",10),true):false, txt:"è€—èµ„ï¿¥8ä¸‡,çºªå¾‹+10"}, o2: "ä¸é—»ä¸é—®", a2:{act:()=>{mod("stress",15);mod("disc",-10);return true;}, txt:"å‹åŠ›+15,çºªå¾‹-10"} },
        { t: "ç«äº‰ç§ç«‹åæ ¡æ¥æŒ–å¢™è„š", d: "éš”å£æƒ³ç”¨ä¸¤å€å·¥èµ„æŒ–ä½ çš„åå¸ˆã€‚", o1: "åŠ è–ªæŒ½ç•™", a1:{act:()=>payCost(0,10)?(mod("grade",5),true):false, txt:"è€—èµ„ï¿¥10ä¸‡,å­¦ä¸š+5"}, o2: "çˆ±èµ°èµ°ä¸ç•™", a2:{act:()=>{mod("grade",-10);return true;}, txt:"å­¦ä¸š-10"} },
        { t: "æ¸…åå­¦éœ¸çŠ¶å…ƒç¬”è®°æ³„éœ²", d: "å…¨æ ¡ç–¯æŠ¢å¤å°ï¼Œå¼•å‘è¸©è¸é£é™©ã€‚", o1: "å­¦æ ¡å‡ºèµ„å®˜æ–¹å°å‘", a1:{act:()=>payCost(0,3)?(mod("grade",5),true):false, txt:"è€—èµ„ï¿¥3ä¸‡,å­¦ä¸š+5"}, o2: "æ²¡æ”¶å……å…¬", a2:{act:()=>{mod("stress",10);mod("disc",5);return true;}, txt:"å‹åŠ›+10,çºªå¾‹+5"} },
        { t: "äº’è”ç½‘å¤§å‚é«˜ç®¡æ ¡å‹å›è®¿", d: "æ›¾ç»çš„åˆºå¤´å­¦ç”Ÿå¦‚ä»Šèº«ä»·è¿‡äº¿ã€‚", o1: "æœ€é«˜è§„æ ¼æ¥å¾…æ‹‰æŠ•èµ„", a1:{act:()=>payCost(2,5)?(mod("funds",30),true):false, txt:"è€—AP:2,ï¿¥5ä¸‡,è·ï¿¥30ä¸‡"}, o2: "ç®€å•åº§è°ˆ", a2:{act:()=>{mod("rep",10);return true;}, txt:"å£°èª‰+10"} }
    ];

    // ================= å…¨å±€çŠ¶æ€ =================
    let metaData = { rebirthPoints: 0, unlockedEndings: [], alumni: [] };
    let defaultGame = {
        year: 2018, month: 9, levelIdx: 0, diff: 1, funds: 100, reputation: 100, ap: 10, maxAp: 20, eduPoints: 0, students: 300, examPoints: 0,
        grade: 40, stress: 10, discipline: 60, fitness: 50, art: 30, schedule: { main: 20, minor: 15, spec: 5 }, teachers: { main: 0, minor: 0, spec: 0 },
        unlockedNodes: [], unlockedExperts: [], branches: [], achievements: [], map: new Array(20).fill(null), policies: []
    };
    let game = {}; let autoInterval = null; let selectedMapIndex = -1; let currentMode = 'principal';
    
    // å­¦ç”Ÿæ¨¡å¼çŠ¶æ€
    let stuGame = { active: false, year:1, month:1, turn:1, grade:40, stress:0, fit:40, art:40, talent:[], family:'', money:0, crushAffection:0, lover:false, friends:[], examScore: 0, energy: 100, maxEnergy: 100, olympiadProgress: 0, isInsured: false };
    
    // æˆ˜æ–—çŠ¶æ€æœº
    let bState = { active: false, isOver: false, turn: 1, phase: '', p: {}, e: {}, log: [], rivalId: '', pts: 0, currentCat: 'atk', weather: null, expertUsed: false };

    // ================= åˆå§‹åŒ– =================
    function init() {
        let meta = localStorage.getItem('school_v11_meta'); if(meta) metaData = JSON.parse(meta);
        let saved = localStorage.getItem('school_v11_save');
        if(saved) { 
            game = Object.assign(JSON.parse(JSON.stringify(defaultGame)), JSON.parse(saved)); 
            log("è¯»å–å­˜æ¡£æˆåŠŸï¼éœ¸ä¸šç»§ç»­ã€‚"); updateUI(); 
        } else { showDifficultySelect(); }
    }
    
    // ========== åŸºç¡€å¼•æ“ ==========
    function saveGame() { 
        localStorage.setItem('school_v11_save', JSON.stringify(game)); 
        localStorage.setItem('school_v11_meta', JSON.stringify(metaData));
        showToast("ğŸ’¾ ä¿å­˜æˆåŠŸ"); 
    }
    function hardReset() { if(confirm("è½®å›é‡å»ºï¼Œå½“å‰è¿›åº¦å½’é›¶ï¼ˆä¿ç•™è½®å›ç‚¹ï¼‰ï¼Œç¡®å®šå—ï¼Ÿ")){ if(autoInterval) toggleAuto(); localStorage.removeItem('school_v11_save'); location.reload(); }}
    function getScaleFactor() { return Math.max(1.0, (game.students / 500) * DIFF_MODS[game.diff].costMult); }
    function mod(stat, val) { game[stat] += val; }
    function getFacLevelCount(type, minLevel) { return game.map.filter(x => x && x.id === type && x.level >= minLevel).length; }
    function hasExpert(id) { return game.unlockedExperts.includes(id); }
    function hasPolicy(id) { return game.policies.includes(id); }
    function hasBranch(id) { return game.branches.includes(id); }
    
    function log(msg, color="#334155") { let b = document.getElementById('log-box'); b.innerHTML = `<div class="log-item"><span style="color:var(--primary);font-weight:bold;">[${game.year}.${game.month}]</span> <span style="color:${color}">${msg}</span></div>` + b.innerHTML; }
    function showToast(msg) { let b = document.getElementById('toast-container'); let t = document.createElement('div'); t.className = 'toast'; t.innerText = msg; b.appendChild(t); setTimeout(()=>t.remove(), 3900); }
    
    // å¼¹çª—ç³»ç»Ÿ
    window.currentModalCallbacks = [];
    function showCustomModal(title, desc, btns) {
        document.getElementById('modal-title').innerHTML = title; 
        document.getElementById('modal-desc').innerHTML = desc;
        let btnContainer = document.getElementById('modal-buttons'); btnContainer.innerHTML = '';
        window.currentModalCallbacks = btns.map(b => b.action || function(){});
        btns.forEach((b, i) => {
            let btnEl = document.createElement('button'); btnEl.className = 'modal-btn'; btnEl.innerHTML = b.text;
            btnEl.onclick = function() { document.getElementById('modal-overlay').style.display = 'none'; window.currentModalCallbacks[i](); };
            btnContainer.appendChild(btnEl);
        });
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function openModal(id) { 
        document.getElementById(id).style.display='flex'; 
        if(id==='modal-achieve') renderAchievements();
        renderModals(); 
    }

    function showDifficultySelect() {
        showCustomModal("ğŸŒ å¼€å¯éœ¸ä¸šçºªå…ƒï¼šé€‰æ‹©éš¾åº¦", "éš¾åº¦å†³å®šåˆå§‹èµ„é‡‘ã€æ—¥å¸¸å¼€é”€å€ç‡ä»¥åŠå­¦ç”ŸæŠ—å‹èƒ½åŠ›çš„æé™ã€‚", [
            {text:"ç®€å• (é€‚åˆä¼‘é—²ä½“éªŒ)", action:()=>startGame(0)}, 
            {text:"æ­£å¸¸ (æ ‡å‡†æ¨¡æ‹Ÿæ³•åˆ™)", action:()=>startGame(1)}, 
            {text:"å›°éš¾ (æè‡´æŠ—å‹æŠ˜ç£¨)", action:()=>startGame(2)}
        ]);
    }
    function startGame(diffIdx) {
        game = JSON.parse(JSON.stringify(defaultGame)); game.diff = diffIdx; game.funds = DIFF_MODS[diffIdx].startFund;
        log(`é€‰æ‹©äº†ã€${DIFF_MODS[diffIdx].name}ã€‘éš¾åº¦ã€‚å­¦æ ¡æ­£å¼æŒ‚ç‰Œæˆç«‹ï¼`); updateUI();
    }

    // ================= æ ¸å¿ƒæ¨æ¼”é€»è¾‘ =================
    function advanceMonth() {
        if(bState.active) return showToast("æˆ˜æ–—ä¸­æ— æ³•æ¨è¿›ï¼");
        game.month++; if (game.month > 12) { game.month = 1; game.year++; }
        
        // APæ¢å¤
        let hallLevel = getFacLevelCount('hall',0) ? game.map.find(x=>x&&x.id==='hall').level : -1;
        game.maxAp = 20 + (hallLevel>=0?5:0) + (hallLevel>=1?10:0) + (hallLevel>=2?30:0) + (hasBranch('b_beijing')?5:0);
        game.ap = Math.min(game.maxAp, game.ap + 3);

        // åˆ†æ ¡æ”¶ç›Š
        BRANCHES_DB.forEach(b => {
            if(hasBranch(b.id)) {
                if(b.id.includes('hengshui')) game.reputation += 20;
                if(b.id.includes('beijing')) game.funds += 100;
                if(b.id.includes('shanghai')) game.reputation += 50;
                if(b.id.includes('harvard')) game.funds += 500;
                if(b.id.includes('oxford')) game.eduPoints += 50;
                if(b.id.includes('huanggang')) game.grade += 0.5;
            }
        });

        // æ¯å­¦æœŸæ”¶å­¦è´¹ (3æœˆä¸9æœˆ)
        if (game.month === 3 || game.month === 9) {
            let income = Math.floor(game.students * SCHOOL_LEVELS[game.levelIdx].tuition);
            game.funds += income;
            log(`ğŸ« å¼€å­¦å­£åˆ°æ¥ï¼Œå…¨æ ¡ ${game.students} åå­¦ç”Ÿå…±ç¼´çº³å­¦è´¹ ï¿¥${income}ä¸‡ï¼`, "var(--success)");
            showToast(`å¼€å­¦æ”¶å…¥ ï¿¥${income}ä¸‡`);
        }

        // åŸºç¡€æ¶ˆè€—
        let scale = getScaleFactor();
        let totalSal = (TEACHER_TIERS[game.teachers.main].salary + TEACHER_TIERS[game.teachers.minor].salary + TEACHER_TIERS[game.teachers.spec].salary) * (game.students / 150); 
        let upkeep = SCHOOL_LEVELS[game.levelIdx].upkeep * scale * (hasExpert('e2')?0.85:1);
        let exUpkeep = 0; game.unlockedExperts.forEach(id => { exUpkeep += EXPERT_POOL.find(x=>x.id===id).upkeep; });
        game.funds -= (totalSal + upkeep + exUpkeep);

        // å±æ€§å˜åŠ¨
        let fMain = game.schedule.main / 20; 
        game.grade += 1.0 * fMain * TEACHER_TIERS[game.teachers.main].multi;
        let stressGain = 1.5 * fMain * DIFF_MODS[game.diff].stressMult;
        let clinicReduce = getFacLevelCount('clinic',0)*5 + getFacLevelCount('clinic',1)*10;
        if(getFacLevelCount('clinic',2)>0) stressGain = 0; else game.stress += Math.max(0, stressGain - clinicReduce);
        
        game.fitness += 0.5; game.art += 0.5;

        // å­¦ç”Ÿæ¨¡å¼è”åŠ¨
        if(stuGame.active) {
            // è¢«åŠ¨ç²¾åŠ›ä¸å…‰ç¯
            stuGame.maxEnergy = hasPolicy('D5') ? 120 : 100;
            stuGame.energy = stuGame.maxEnergy;
            if(hasPolicy('A1')) stuGame.stress += 5; // å†›äº‹åŒ–åŠ å‹
            if(stuGame.lover) stuGame.energy += 20; // çˆ±æƒ…æ»‹æ¶¦
            
            // æ­»å…šè¢«åŠ¨
            stuGame.friends.forEach(fid => {
                let f = FRIENDS.find(x=>x.id===fid);
                if(f) f.eff();
            });
            
            updateStuUI();
            
            // è‡ªåŠ¨è®¡ç®—è”è€ƒ
            if(game.month === 3 || game.month === 6 || game.month === 11) {
                let base = stuGame.grade * 5 + stuGame.art * 2 + stuGame.fit * 1;
                if(stuGame.isInsured) base = 750; // ä¿é€æ»¡åˆ†
                let rand = Math.random() * 50;
                stuGame.examScore = Math.floor(base + rand);
                let rank = Math.max(1, Math.floor(1000 - stuGame.examScore)); 
                document.getElementById('stu-exam-score').innerText = stuGame.examScore;
                document.getElementById('stu-exam-rank').innerText = `å…¨æ ¡æ’å: ${rank}`;
                let stuBox = document.getElementById('stu-log-box');
                stuBox.innerHTML += `<div>ğŸ“… è”è€ƒç»“æŸï¼Œä½ çš„åˆ†æ•°: <b>${stuGame.examScore}</b> (æ’å${rank})</div>`;
                
                if(stuGame.examScore > 600) { game.reputation += 5; log("ğŸŒŸ å­¦ç”Ÿä»£è¡¨è¡¨ç°ä¼˜å¼‚ï¼Œæ¯æ ¡å£°èª‰+5"); }
            }

            // å­¦ç”Ÿéšæœºäº‹ä»¶ (10%)
            if(Math.random() < 0.1) {
                showCustomModal("ğŸ’ æ ¡å›­å¥‡é‡", "åœ¨èµ°å»Šé‡Œæ¡åˆ°äº†ä¸€æœ¬æ­¦æ—ç§˜ç±(äº”ä¸‰çœŸé¢˜)ã€‚", [{text:"ç–¯ç‹‚å†…å·", action:()=>{stuGame.grade+=10; stuGame.stress+=20; updateStuUI();}}, {text:"æ‹¿å»å–åºŸå“", action:()=>{stuGame.money+=50; updateStuUI();}}]);
                if(autoInterval) toggleAuto();
                return;
            }
        }

        checkCrisis(); clampStats(); checkAchievements(); updateMailbox();

        // è§¦å‘ç‰¹æ®Šäº‹ä»¶
        if (game.month === 3 || game.month === 11) { triggerExamSeason(); return; }
        if (game.month === 6) { triggerGaokao(); return; }
        if (Math.random() < 0.2) { 
            let e = EVENT_POOL[Math.floor(Math.random()*EVENT_POOL.length)];
            showCustomModal(`ğŸ² çªå‘äº‹ä»¶ï¼š${e.t}`, e.d, [
                {text: e.o1 + `<br><span class="event-eff">${e.a1.txt}</span>`, action:()=>{ if(e.a1.act()){updateUI();}else{advanceMonth();} }},
                {text: e.o2 + `<br><span class="event-eff">${e.a2.txt}</span>`, action:()=>{ e.a2.act(); updateUI(); }}
            ]);
            if(autoInterval) toggleAuto();
        } else updateUI();
    }
    
    function toggleAuto() {
        let btn = document.getElementById('btn-auto');
        if (autoInterval) { clearInterval(autoInterval); autoInterval = null; btn.classList.remove('active'); btn.innerText = "ğŸ¤– è‡ªåŠ¨æ¨æ¼”"; } 
        else { btn.classList.add('active'); btn.innerText = "ğŸ›‘ åœæ­¢æ¨æ¼”"; autoInterval = setInterval(() => { if(document.getElementById('modal-overlay').style.display === 'flex' || bState.active) return; document.getElementById('btn-advance').click(); }, 1200); }
    }

    function clampStats() { ['grade', 'stress', 'discipline', 'fitness', 'art'].forEach(s => game[s] = Math.max(0, Math.min(100, game[s]))); game.students = Math.max(50, game.students); }
    function checkCrisis() { if (game.funds < 0) { showCustomModal("âŒ ç ´äº§", "èµ„é‡‘é“¾æ–­è£‚ã€‚", [{text:"é‡å¼€", action:hardReset}]); return true; } }

    // ================= æˆå°±ç³»ç»Ÿ =================
    function checkAchievements() {
        ACHIEVEMENTS.forEach(a => {
            if(!game.achievements.includes(a.id)) {
                let unlocked = false;
                if(a.id==='a1' && game.funds>=1000) unlocked=true;
                if(a.id==='a2' && game.funds>=10000) unlocked=true;
                if(a.id==='a3' && game.reputation>=10000) unlocked=true;
                if(a.id==='a4' && game.levelIdx>=4) unlocked=true;
                if(a.id==='a8' && game.stress>=100) unlocked=true;
                if(a.id==='a9' && game.discipline<=10) unlocked=true;
                if(a.id==='a13' && game.policies.length>=15) unlocked=true;
                // ... çœç•¥å…¶ä»–åˆ¤å®šç»†èŠ‚ï¼Œä»…ä½œæ¼”ç¤º
                if(unlocked) {
                    game.achievements.push(a.id);
                    showToast(`ğŸ† è·å¾—æˆå°±ï¼š${a.name}`);
                }
            }
        });
    }

    function renderAchievements() {
        let c = document.getElementById('achieve-container');
        c.innerHTML = ACHIEVEMENTS.map(a => {
            let has = game.achievements.includes(a.id);
            return `<div style="background:#fff; border:2px solid ${has?'var(--gold)':'#e2e8f0'}; padding:10px; border-radius:6px; opacity:${has?1:0.5}"><b>${a.name}</b><br><span style="font-size:0.75rem">${a.desc}</span></div>`;
        }).join('');
    }

    // ================= æˆ˜æ–—ç³»ç»Ÿ V2.0 =================
    function triggerExamSeason() {
        if(autoInterval) toggleAuto();
        showBattlePrep();
    }

    function showBattlePrep() {
        openModal('modal-battle');
        document.getElementById('b-prep').style.display = 'block'; document.getElementById('b-main').style.display = 'none';
        
        let render = (list, id) => {
            let el = document.getElementById(id); el.innerHTML = '';
            list.forEach(r => {
                let unlocked = game.levelIdx + 1 >= r.tier;
                let html = `<div style="background:#0f172a; border:1px solid ${unlocked?'#4ade80':'#64748b'}; border-radius:6px; padding:10px; font-size:0.8rem; opacity:${unlocked?1:0.5};">
                    <div style="font-weight:bold; color:${unlocked?'#fff':'#94a3b8'}">${r.name}</div>
                    <div style="color:#fde047">HP:${r.hp} ATK:${r.atk}</div>
                    ${unlocked ? `<button class="btn" style="margin-top:5px; padding:4px; font-size:0.8rem;" onclick="startBattle('${r.id}')">å‡ºå¾</button>` : 'ğŸ”’ ç­‰çº§ä¸è¶³'}
                </div>`;
                el.innerHTML += html;
            });
        };
        render(RIVALS.filter(r=>r.tier===1), 'b-rival-t1');
        render(RIVALS.filter(r=>r.tier===2), 'b-rival-t2');
        render(RIVALS.filter(r=>r.tier===3), 'b-rival-t3');
        render(RIVALS.filter(r=>r.tier===4), 'b-rival-t4');
        render(RIVALS.filter(r=>r.tier===5), 'b-rival-t5');
    }

    function startBattle(rId) {
        let r = RIVALS.find(x => x.id === rId);
        document.getElementById('b-prep').style.display = 'none'; document.getElementById('b-main').style.display = 'flex';
        
        // è®¡ç®—ç©å®¶å±æ€§ (ç»“åˆè€å¸ˆç­‰çº§ä¸äººæ•°)
        let branchBuff = { atk:1, def:1, hp:1, crit:0, ap:0 };
        if(hasBranch('b_hengshui')) { branchBuff.atk+=0.15; branchBuff.hp+=0.2; }
        if(hasBranch('b_beijing')) { branchBuff.def+=0.2; branchBuff.ap+=5; }
        if(hasBranch('b_shanghai')) { branchBuff.crit+=10; }
        if(hasBranch('b_harvard')) { branchBuff.atk+=0.2; branchBuff.def+=0.2; branchBuff.hp+=0.2; }
        if(hasBranch('b_huanggang')) { branchBuff.atk+=0.25; }

        bState = {
            active: true, isOver: false, turn: 1, phase: 'NORMAL', log: [], currentCat: 'atk',
            rivalId: rId, pts: r.pts, weather: WEATHER_TYPES[Math.floor(Math.random()*WEATHER_TYPES.length)],
            expertUsed: false,
            p: {
                // è¡€é‡å’Œæ”»å‡»åŠ›ç”±æ•™å¸ˆæ°´å¹³æ”¾å¤§
                maxHp: Math.floor((game.fitness * 100 + game.students * (10 + game.teachers.spec * 5)) * branchBuff.hp),
                atk: Math.floor(game.grade * (10 + game.teachers.main * 5) * branchBuff.atk),
                def: Math.floor(game.discipline * 8 * branchBuff.def),
                crit: Math.floor(game.art * 0.5 + branchBuff.crit),
                stress: game.stress, ap: game.ap + branchBuff.ap, morale: 100,
                buffs: { defUp: 0, critUp: 0, dmgUp: 0, dodge: 0, atkUp: 0, immune: 0 }
            },
            e: {
                name: r.name, maxHp: r.hp, hp: r.hp, atk: r.atk, def: r.def, stress: 0, morale: 100,
                buffs: { stun: 0, atkDown: 0, defDown: 0 }
            }
        };
        bState.p.hp = bState.p.maxHp;

        // æ¸²æŸ“ä¸“å®¶åˆ—è¡¨
        let exEl = document.getElementById('b-expert-list'); exEl.innerHTML = '';
        game.unlockedExperts.forEach(eid => {
            let ex = EXPERT_POOL.find(x=>x.id===eid);
            if(ex.battle) {
                let btn = document.createElement('button');
                btn.className = 'sys-btn'; btn.style.fontSize='0.75rem';
                btn.innerText = `Call ${ex.name}`;
                btn.onclick = () => useExpert(eid, btn);
                exEl.appendChild(btn);
            }
        });

        document.getElementById('be-name').innerText = "> " + bState.e.name;
        document.getElementById('b-log').querySelector('.b-log-inner').innerHTML = `<span class="sys">æˆ˜æ–—å¼€å§‹ï¼é­é‡ ${bState.e.name}ï¼</span>`;
        bStartTurn();
    }

    function bStartTurn() {
        if(bState.isOver || bCheckEnd()) return;
        bState.expertUsed = false;
        bLog(`<br><span style="color:#94a3b8">--- ROUND ${bState.turn} ---</span>`);
        
        if(bState.turn % 3 === 0) { bState.weather = WEATHER_TYPES[Math.floor(Math.random()*WEATHER_TYPES.length)]; bLog(`â˜ï¸ å¤©æ°”å˜æ›´ä¸ºï¼š${bState.weather.name}`); }
        if(bState.weather.effect) bState.weather.effect(bState.p, bState.e);

        bState.p.ap = Math.min(game.maxAp, bState.p.ap + 3);
        
        for(let k in bState.p.buffs) if(bState.p.buffs[k]>0) bState.p.buffs[k]--;
        for(let k in bState.e.buffs) if(bState.e.buffs[k]>0) bState.e.buffs[k]--;

        if(hasBranch('b_huanggang')) { bState.p.hp -= bState.p.maxHp*0.05; bLog("å¯†å·åå™¬æ‰£è¡€ï¼"); }
        if(bCheckEnd()) return;

        bUpdateUI();
        if(bState.p.stress >= 100) {
            bLog("ğŸš¨ æˆ‘æ–¹å‹åŠ›å´©æºƒï¼Œè·³è¿‡å›åˆï¼"); bState.p.stress = 50; setTimeout(eAction, 1000);
        } else {
            bShowCat(bState.currentCat);
            let btns = document.getElementById('b-expert-list').querySelectorAll('button');
            btns.forEach(b => b.disabled = false); 
        }
    }

    function useExpert(id, btn) {
        if(bState.expertUsed) return showToast("æ¯å›åˆåªèƒ½æŒ‡æ´¾ä¸€åä¸“å®¶ï¼");
        let ex = EXPERT_POOL.find(x=>x.id===id);
        let msg = ex.battle(bState.p, bState.e);
        if(msg) { 
            bLog(`<span class="sys">ä¸“å®¶åŠ©é˜µ: ${msg}</span>`); 
            bState.expertUsed = true; 
            btn.disabled = true; 
            if(bCheckEnd()) return;
            bUpdateUI(); 
        }
    }

    function pAction(sid) {
        let s = SKILL_DB[sid];
        if(bState.p.ap < s.ap) return showToast("APä¸è¶³ï¼");
        bState.p.ap -= s.ap;
        document.getElementById('b-skills-container').innerHTML = ''; // Lock UI

        bLog(`<span class="p">æˆ‘æ–¹é‡Šæ”¾ [${s.name}]</span>`);
        
        if(s.cat === 'atk' || s.cat === 'insp' || sid === 'sys_èµ„æœ¬') {
            let dmg = 0;
            if(sid === 'sys_èµ„æœ¬') dmg = 9999;
            else if(sid === 'insp_1') { 
                if(Math.random()<0.3) { dmg = 999; bLog("æŠ¼ä¸­åŸé¢˜ï¼å·¨é¢ä¼¤å®³ï¼"); } else { dmg = 10; bLog("æŠ¼é¢˜å¤±è´¥..."); }
            }
            else {
                let base = 1.0;
                let match = s.desc.match(/(\d+)%/);
                if(match) base = parseInt(match[1]) / 100;
                
                let raw = bState.p.atk * base;
                let crit = Math.random()*100 < bState.p.crit + (bState.p.buffs.critUp?50:0);
                dmg = Math.max(10, raw - bState.e.def * (bState.e.buffs.defDown?0.5:1));
                if(crit) { dmg *= 1.5; bLog(`<span class="crit">æš´å‡»ï¼</span>`); }
            }
            bState.e.hp -= Math.floor(dmg);
            bLog(`é€ æˆ <span class="dmg">${Math.floor(dmg)}</span> ç‚¹ä¼¤å®³`);
        } else {
            if(sid.includes('def')) bState.p.buffs.defUp = 2;
            if(sid.includes('ans')) { bState.p.hp += bState.p.maxHp*0.2; bLog("å›å¤HP"); }
            if(sid.includes('sup')) { bState.p.ap += 5; bLog("å›å¤AP"); }
            if(sid.includes('psy')) { bState.e.atk *= 0.9; bLog("æ•Œæ–¹æ”»å‡»ä¸‹é™"); }
        }

        bUpdateUI();
        if(bCheckEnd()) return;
        setTimeout(eAction, 1000);
    }

    function eAction() {
        if(bState.isOver) return;
        if(bState.e.buffs.stun > 0) { bLog("æ•Œæ–¹æ™•çœ©ä¸­..."); setTimeout(nextTurn, 1000); return; }

        let dmg = Math.max(10, bState.e.atk - bState.p.def * (bState.p.buffs.defUp?1.5:1));
        if(bState.p.buffs.dodge) { dmg = 0; bLog("æˆ‘æ–¹é—ªé¿äº†æ”»å‡»ï¼"); bState.p.buffs.dodge=0; }
        else {
            bState.p.hp -= Math.floor(dmg);
            bLog(`<span class="e">æ•Œæ–¹æ”»å‡»é€ æˆ ${Math.floor(dmg)} ä¼¤å®³</span>`);
        }
        
        bUpdateUI();
        if(bCheckEnd()) return;
        setTimeout(nextTurn, 1000);
    }

    function nextTurn() { bState.turn++; bStartTurn(); }

    function bCheckEnd() {
        if(bState.isOver) return true;
        // ç¡®ä¿æ­»æ–—æ•Œæ–¹<0åˆ¤èƒœ
        if(bState.e.hp <= 0) {
            bState.isOver = true;
            let finalPts = bState.pts * 2;
            let finalMoney = bState.pts * 20; 
            game.examPoints += finalPts; game.funds += finalMoney;
            if(bState.rivalId === 't5_3' && !game.achievements.includes('a17')) { game.achievements.push('a17'); showToast("è¾¾æˆæˆå°±ï¼šå¯†å·å…‹æ˜Ÿ"); }
            showCustomModal("ğŸ† å²è¯—å¤§æ·", `è·å¾— ${finalPts} ç§¯åˆ†ï¼Œå¥–é‡‘ ï¿¥${finalMoney}ä¸‡`, [{text:"ç¡®å®š", action:()=>{ closeModal('modal-battle'); bState.active=false; updateUI(); }}]);
            return true;
        }
        if(bState.p.hp <= 0) {
            bState.isOver = true;
            game.reputation -= 20;
            showCustomModal("ğŸ’€ æƒ¨è´¥", "å…¨å†›è¦†æ²¡ï¼Œå£°èª‰ä¸¥é‡å—æŸã€‚ä½†å­¦æ ¡åŸºé‡‘ä¼šå·²ä¸ºæ‚¨å…œåº•ï¼Œèµ„é‡‘æœªå—æŸå¤±ã€‚", [{text:"ç¡®å®š", action:()=>{ closeModal('modal-battle'); bState.active=false; updateUI(); }}]);
            return true;
        }
        return false;
    }

    function bLog(msg) { 
        let inner = document.getElementById('b-log').querySelector('.b-log-inner');
        inner.innerHTML += msg + '<br>'; 
        document.getElementById('b-log').scrollTop = document.getElementById('b-log').scrollHeight;
    }

    function bUpdateUI() {
        let p = bState.p; let e = bState.e;
        document.getElementById('b-weather-ui').innerHTML = `<b>${bState.weather.name}</b><br><span style="font-size:0.65rem">${bState.weather.desc}</span>`;
        document.getElementById('bp-hp-bar').style.width = Math.max(0, p.hp/p.maxHp*100) + '%';
        document.getElementById('bp-hp-txt').innerText = `${Math.floor(p.hp)}/${p.maxHp}`;
        document.getElementById('be-hp-bar').style.width = Math.max(0, e.hp/e.maxHp*100) + '%';
        document.getElementById('be-hp-txt').innerText = `${Math.floor(e.hp)}/${e.maxHp}`;
        document.getElementById('bp-ap').innerText = p.ap;
        document.getElementById('bp-atk').innerText = Math.floor(p.atk);
        
        let pB = []; if(p.buffs.defUp) pB.push("ğŸ›¡ï¸æŠ¤ç›¾"); if(p.buffs.critUp) pB.push("âš¡æš´å‡»");
        document.getElementById('bp-buffs').innerText = pB.join(' ') || 'æ— ';
    }

    function bShowCat(cat) {
        bState.currentCat = cat;
        document.querySelectorAll('.b-cat-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`cat-${cat}`).classList.add('active');

        let c = document.getElementById('b-skills-container'); c.innerHTML = '';
        for(let k in SKILL_DB) {
            let s = SKILL_DB[k];
            if(s.cat === cat) {
                let unlocked = s.req();
                let btn = document.createElement('button');
                btn.className = 'b-skill-btn';
                btn.disabled = !unlocked || bState.p.ap < s.ap;
                btn.innerHTML = `<div class="b-s-name">${s.name} (AP:${s.ap})</div><div class="b-s-desc">${unlocked?s.desc:'æ¡ä»¶æœªæ»¡è¶³'}</div>`;
                btn.onclick = () => pAction(k);
                c.appendChild(btn);
            }
        }
    }
    
    function bRetreat() {
        if(confirm("æ’¤é€€è§†ä¸ºé€ƒå…µï¼å£°èª‰å°†å‡å°‘50ç‚¹ï¼Œç¡®å®šï¼Ÿ")) {
            bState.isOver = true; game.reputation -= 50;
            closeModal('modal-battle'); bState.active=false; updateUI();
        }
    }

    // ================= å…¶å®ƒç³»ç»Ÿ =================
    function renderModals() {
        // åœ°å›¾
        let mGrid = document.getElementById('map-grid'); mGrid.innerHTML = '';
        game.map.forEach((fac, idx) => {
            let div = document.createElement('div'); div.className = 'map-cell' + (idx === selectedMapIndex ? ' selected' : '');
            if(fac) {
                let fData = FACILITIES[fac.id];
                div.innerHTML = `<span style="font-size:1.8rem;">${fData.icon}</span><span style="font-size:0.75rem;">${fData.levels[fac.level].name}</span>`;
            } else div.innerHTML = `<span style="color:#a3e635;font-size:2rem;">+</span>`;
            div.onclick = () => { selectedMapIndex = idx; renderFacDetail(); }; mGrid.appendChild(div);
        });
        renderFacDetail();
        
        // ä¸“å®¶
        let ehtml = ''; EXPERT_POOL.forEach(e => {
            if(hasExpert(e.id)) {
                let typeTag = e.battle ? '<span class="type-tag type-battle">æˆ˜æ–—å‹</span>' : '<span class="type-tag type-passive">å†…æ”¿å‹</span>';
                ehtml += `<div class="gacha-card rarity-${e.rarity}"><div class="upkeep-tag">ï¿¥${e.upkeep}</div>${typeTag}<div><b>${e.name}</b><br><span style="font-size:0.75rem">${e.desc}</span></div></div>`;
            }
        }); document.getElementById('expert-container').innerHTML = ehtml;

        // åˆ†æ ¡
        let bEl = document.getElementById('branch-container');
        if(bEl) {
            bEl.innerHTML = BRANCHES_DB.map(b => {
                let owned = hasBranch(b.id);
                return `<div style="background:#fff; border:2px solid ${owned?'var(--gold)':'#cbd5e1'}; padding:15px; border-radius:8px;">
                    <div style="font-weight:bold; font-size:1.1rem;">${b.name}</div>
                    <div style="font-size:0.8rem; color:#64748b; margin:5px 0;">${b.desc}</div>
                    ${owned ? '<span style="color:var(--success);font-weight:bold;">âœ… å·²å»ºç«‹</span>' : `<button class="btn" onclick="buyBranch('${b.id}', ${b.cost})">å»ºç«‹ (ï¿¥${b.cost}ä¸‡)</button>`}
                </div>`;
            }).join('');
        }

        // æ”¿ç­–
        let thtml = '';
        POLICY_TREE.forEach(layer => {
            let row = `<div class="tree-tier">`;
            layer.nodes.forEach(n => {
                let unlocked = hasPolicy(n.id); let canUnlock = !unlocked && (!n.req || hasPolicy(n.req));
                let cls = unlocked ? 'unlocked ' + n.class : (canUnlock ? n.class : 'locked ' + n.class);
                let btn = unlocked ? `<span style="color:var(--success);font-size:0.8rem;font-weight:bold;">å·²ç”Ÿæ•ˆ</span>` : 
                          (canUnlock ? `<button class="btn" style="margin:0; padding:4px;" onclick="unlockPolicy('${n.id}', ${n.cost})">é¢å¸ƒ</button>` : `<span style="color:#94a3b8;font-size:0.75rem;">æœªè§£é”</span>`);
                row += `<div class="tree-node ${cls}"><div><h4 style="margin:0 0 5px 0;font-size:0.95rem;">${n.name}</h4><p style="font-size:0.75rem;color:#64748b;">${n.desc}</p></div>${btn}</div>`;
            });
            thtml += row + `</div>`;
        });
        document.getElementById('policy-container').innerHTML = thtml;
        document.getElementById('ui-eduPoints').innerText = game.eduPoints;
    }

    function renderFacDetail() {
        let list = document.getElementById('fac-list'); list.innerHTML = '';
        if(selectedMapIndex===-1) return;
        if(game.map[selectedMapIndex]) {
             let fac = game.map[selectedMapIndex]; let fData = FACILITIES[fac.id];
             let isMax = fac.level >= fData.levels.length-1;
             list.innerHTML = `<p>${fData.levels[fac.level].name}</p>${isMax?'':`<button class="btn" onclick="upgradeFac()">å‡çº§ (ï¿¥${fData.levels[fac.level+1].cost})</button>`}<button class="btn" style="border-color:red;color:red" onclick="demolish()">æ‹†é™¤</button>`;
        } else {
            for(let k in FACILITIES) {
                let cost = FACILITIES[k].levels[0].cost;
                list.innerHTML += `<button class="btn" onclick="buildFac('${k}',${cost})">${FACILITIES[k].icon} ${FACILITIES[k].levels[0].name} (ï¿¥${cost})</button>`;
            }
        }
    }

    function buildFac(k,c){ if(payCost(0,c)){game.map[selectedMapIndex]={id:k,level:0}; renderModals(); updateUI();}}
    function upgradeFac(){ let f=game.map[selectedMapIndex]; let c=FACILITIES[f.id].levels[f.level+1].cost; if(payCost(0,c)){f.level++; renderModals(); updateUI();}}
    function demolish() { game.map[selectedMapIndex] = null; renderModals(); updateUI(); }
    
    function unlockPolicy(id, cost) {
        if(game.eduPoints < cost) return showToast("æ•™ç ”ç‚¹ä¸è¶³");
        game.eduPoints -= cost; game.policies.push(id); renderModals(); updateUI();
    }

    function gachaExpert() {
        if(!payCost(0, 50)) return;
        let r = Math.random(); 
        let ssrRate = [0, 0.005, 0.015, 0.04, 0.08][game.levelIdx]; 
        let srRate = 0.1 + (game.levelIdx * 0.02);
        let targetRarity = 'R'; if(r < ssrRate) targetRarity = 'SSR'; else if(r < ssrRate + srRate) targetRarity = 'SR';
        
        let pool = EXPERT_POOL.filter(x => x.rarity === targetRarity && !hasExpert(x.id));
        if(pool.length === 0) pool = EXPERT_POOL.filter(x => !hasExpert(x.id));
        if(pool.length === 0) return showToast("äººæ‰åº“å·²ç©º");
        
        let ex = pool[Math.floor(Math.random() * pool.length)]; game.unlockedExperts.push(ex.id);
        showCustomModal("âœ¨ å¯»è®¿æˆåŠŸ", `è·å¾— ${ex.rarity} çº§ä¸“å®¶ï¼š${ex.name}`, [{text:"ç¡®å®š", action:()=>{renderModals(); updateUI();}}]);
    }

    function buyBranch(id, cost) { if(payCost(0, cost)) { game.branches.push(id); log(`ğŸŒ å»ºç«‹äº†ã€${BRANCHES_DB.find(x=>x.id===id).name}ã€‘ï¼`); renderModals(); updateUI(); } }
    
    function payCost(ap, money) { if(game.ap>=ap && game.funds>=money) { game.ap-=ap; game.funds-=money; return true; } showToast("èµ„æºä¸è¶³"); return false; }

    function updateMailbox() {
        let box = document.getElementById('student-comments-box');
        let msgs = [];
        if(stuGame.active) {
            msgs.push(`è‡ªå·±: åˆšè€ƒäº† ${stuGame.examScore||0} åˆ†ã€‚`);
            if(stuGame.stress > 80) msgs.push("è‡ªå·±: å‹åŠ›å¤ªå¤§äº†ï¼Œæƒ³é€€å­¦...");
        } else {
            msgs.push("åŒ¿å: æ ¡é•¿å¥½ï¼Œæˆ‘ä¹Ÿæƒ³ç©å­¦ç”Ÿæ¨¡å¼ã€‚");
        }
        if(game.stress > 80) msgs.push("åŒ¿å: å­¦æ ¡å¤ªå‹æŠ‘äº†ï¼");
        if(hasBranch('b_harvard')) msgs.push("åŒ¿å: å¬è¯´å’±ä»¬è¿˜æœ‰å“ˆä½›åˆ†æ ¡ï¼Ÿå¤ªç‰›äº†ï¼");
        
        box.innerHTML = '';
        msgs.forEach(m => {
            box.innerHTML += `<div class="comment-bubble">${m}<div class="comment-meta">${game.year}.${game.month}</div></div>`;
        });
        box.scrollTop = box.scrollHeight;
    }

    function updateUI() {
        document.getElementById('ui-date').innerText = `${game.year}å¹´ ${game.month}æœˆ`;
        document.getElementById('ui-funds').innerText = Math.floor(game.funds);
        document.getElementById('ui-rep').innerText = Math.floor(game.reputation);
        document.getElementById('ui-ap').innerText = Math.floor(game.ap);
        document.getElementById('val-grade').innerText = Math.floor(game.grade);
        document.getElementById('bar-grade').style.width = game.grade + '%';
        document.getElementById('ui-students').innerText = game.students;
        document.getElementById('ui-examPoints').innerText = game.examPoints;
        document.getElementById('val-stress').innerText = Math.floor(game.stress);
        document.getElementById('bar-stress').style.width = Math.min(100, game.stress) + '%';
        document.getElementById('val-disc').innerText = Math.floor(game.discipline);
        document.getElementById('bar-disc').style.width = game.discipline + '%';
        document.getElementById('val-fit').innerText = Math.floor(game.fitness);
        document.getElementById('bar-fit').style.width = game.fitness + '%';
        document.getElementById('val-art').innerText = Math.floor(game.art);
        document.getElementById('bar-art').style.width = game.art + '%';
        
        document.getElementById('ui-level-name').innerText = `ğŸ† ${SCHOOL_LEVELS[game.levelIdx].name}`;
        
        let exUpkeep = 0; game.unlockedExperts.forEach(id => { exUpkeep += EXPERT_POOL.find(x=>x.id===id).upkeep; });
        let totalSal = (TEACHER_TIERS[game.teachers.main].salary + TEACHER_TIERS[game.teachers.minor].salary + TEACHER_TIERS[game.teachers.spec].salary) * (game.students / 150); 
        let upkeep = SCHOOL_LEVELS[game.levelIdx].upkeep * getScaleFactor() * (hasExpert('e2')?0.85:1);
        document.getElementById('ui-salary').innerText = `å¸¸è€—:-${Math.floor(totalSal + upkeep)} ä¸“å®¶:-${exUpkeep}`;

        document.getElementById('tch-main').innerText = TEACHER_TIERS[game.teachers.main].name;
        document.getElementById('tch-minor').innerText = TEACHER_TIERS[game.teachers.minor].name;
        document.getElementById('tch-spec').innerText = TEACHER_TIERS[game.teachers.spec].name;
    }

    // ================= å‡çº§å¼¹çª—é‡æ„ =================
    function checkUpgrade() {
        let next = SCHOOL_LEVELS[game.levelIdx + 1];
        if(!next) return showToast("å·²æ˜¯æœ€é«˜çº§åˆ«ï¼");
        let html = `
            <ul style="text-align:left; line-height:1.8; font-size:1.1rem; background:#f1f5f9; padding:15px 15px 15px 30px; border-radius:8px;">
                <li><b>åæœ›è¦æ±‚:</b> ${next.reqRep} (å½“å‰:${Math.floor(game.reputation)}) ${game.reputation>=next.reqRep?'<span style="color:var(--success)">âœ…</span>':'<span style="color:var(--danger)">âŒ</span>'}</li>
                <li><b>èµ„é‡‘å‚¨å¤‡:</b> ${next.reqFunds}ä¸‡ (å½“å‰:${Math.floor(game.funds)}) ${game.funds>=next.reqFunds?'<span style="color:var(--success)">âœ…</span>':'<span style="color:var(--danger)">âŒ</span>'}</li>
                <li><b>å¹³å‡å­¦ä¸š:</b> ${next.reqGrade} (å½“å‰:${Math.floor(game.grade)}) ${game.grade>=next.reqGrade?'<span style="color:var(--success)">âœ…</span>':'<span style="color:var(--danger)">âŒ</span>'}</li>
            </ul>
        `;
        let canUp = game.reputation>=next.reqRep && game.funds>=next.reqFunds && game.grade>=next.reqGrade;
        let btns = [{text:"ç»§ç»­åŠªåŠ›", action:()=>{}}];
        if(canUp) btns.push({text:"ç¡®è®¤æ™‹å‡ï¼", action:()=>{ game.levelIdx++; log(`æ™‹å‡ä¸ºã€${next.name}ã€‘ï¼`); updateUI(); }});
        showCustomModal(`ç”³è¯·æ™‹å‡ï¼š${next.name}`, html, btns);
    }

    // å­¦ç”Ÿæ¨¡å¼å‡½æ•°
    function switchMode(m) { 
        if(m==='student'){ 
            document.getElementById('principal-container').style.display='none'; 
            document.getElementById('student-container').style.display='block'; 
            renderStudentSetup(); 
            renderStuFriends();
        }
        else { document.getElementById('principal-container').style.display='grid'; document.getElementById('student-container').style.display='none'; updateUI(); }
    }
    
    function renderStudentSetup() {
        let grid = document.getElementById('stu-family-grid');
        grid.innerHTML = '';
        FAMILIES.forEach(f => {
            let el = document.createElement('div');
            el.className = 'family-card';
            if(stuGame.family === f.id) el.classList.add('selected');
            el.onclick = () => selectFamily(f.id, el);
            el.innerHTML = `<h3 style="margin:0 0 5px 0;">${f.name}</h3><p style="font-size:0.8rem;color:#64748b;">${f.desc}</p><div style="font-weight:bold;color:var(--primary);margin-top:5px;">åˆå§‹: ï¿¥${f.money}</div>`;
            grid.appendChild(el);
        });
    }

    function selectFamily(id, el) { 
        stuGame.family = id; 
        document.querySelectorAll('.family-card').forEach(c=>c.classList.remove('selected')); 
        el.classList.add('selected'); 
    }
    
    function buyTalent(id, c, el) { if(metaData.rebirthPoints>=c && !stuGame.talent.includes(id)) { metaData.rebirthPoints-=c; stuGame.talent.push(id); el.style.background='#dcfce7'; saveGame(); }}
    function startStudentGameplay() { if(stuGame.family) { stuGame.active=true; document.getElementById('stu-setup').style.display='none'; document.getElementById('stu-gameplay').style.display='grid'; updateStuUI(); } else showToast("è¯·é€‰å‡ºèº«"); }
    
    // å­¦ç”Ÿè¡ŒåŠ¨é€»è¾‘ (æ¶ˆè€—ç²¾åŠ› + æ‰©å……ç©æ³•)
    function stuAct(t) { 
        let costs = {
            'hard_study': 40, 'study': 25, 'olympiad': 50, 'abroad': 30, 'work': 30, 'gacha': 10, 'esport': 40, 'show': 40, 'sport': 25, 'book': 20, 'sick': 10, 'parent': 15,
            'mun': 50, 'daydream': 10, 'scalper': 30, 'rooftop': 20
        };
        let cost = costs[t] || 20;
        
        if(stuGame.energy < cost) { showToast("ğŸ˜´ ç²¾åŠ›ä¸è¶³ï¼Œè¯·ç‚¹å‡»ã€ç¡è§‰ã€‘ç»“æŸæœ¬æœˆï¼"); return; }
        
        stuGame.energy -= cost;
        let sLog = "";
        
        // æ•ˆæœæ¨¡æ‹Ÿ
        if(t==='study') { stuGame.grade+=2; stuGame.stress+=2; sLog="å¬è¯¾è®°ç¬”è®°ï¼Œå­¦ä¸š+2";}
        if(t==='hard_study') { stuGame.grade+=4; stuGame.stress+=5; sLog="ç†¬å¤œåˆ·é¢˜ï¼Œå­¦ä¸šçŒ›å¢ä½†å‹åŠ›å¤§ï¼";}
        if(t==='parent') { stuGame.money+=50; sLog="è·Ÿçˆ¶æ¯è¦äº†50å—é’±ç”Ÿæ´»è´¹ã€‚";}
        if(t==='work') { stuGame.money+=30; stuGame.fit-=2; sLog="å»æ ¡å¤–æ‰“å·¥ï¼Œèµšäº†30å…ƒï¼Œèº«ä½“ç–²æƒ«ã€‚";}
        if(t==='mun') { stuGame.grade+=1; stuGame.art+=3; sLog="å‚åŠ æ¨¡æ‹Ÿè”åˆå›½ï¼Œå£æ‰ä¸è§†é‡æå‡ï¼";}
        if(t==='daydream') { stuGame.stress=Math.max(0, stuGame.stress-10); sLog="å¯¹ç€çª—å¤–å‘å‘†ï¼Œå¿ƒæƒ…èˆ’ç•…äº†ä¸€äº›ã€‚";}
        if(t==='rooftop') { stuGame.stress=Math.max(0, stuGame.stress-25); sLog="åœ¨å¤©å°å¹é£ï¼Œå‹åŠ›å¤§å¹…æ¶ˆæ•£ã€‚";}
        if(t==='scalper') { 
            if(Math.random()<0.3) { stuGame.money-=50; stuGame.stress+=20; sLog="å€’å–è¢«æ•™å¯¼ä¸»ä»»æŠ“ä½ï¼æ²¡æ”¶å¹¶ç½šæ¬¾ï¼"; }
            else { stuGame.money+=150; sLog="å€’å–æ¼”å”±ä¼šé—¨ç¥¨å¤§èµšä¸€ç¬”ï¼"; }
        }
        
        // å¥¥èµ›æœºåˆ¶
        if(t === 'olympiad') {
            if(stuGame.isInsured) { sLog = "å·²ç»ä¿é€æ¸…åŒ—ï¼Œæ— éœ€å†å·ï¼"; }
            else {
                let successRate = stuGame.grade / 100; // å­¦ä¸šè¶Šé«˜æˆåŠŸç‡è¶Šé«˜
                if(Math.random() < successRate) {
                    stuGame.olympiadProgress += 15;
                    sLog = `æ”»å…‹éš¾é¢˜ï¼å¥¥èµ›è¿›åº¦: ${stuGame.olympiadProgress}%`;
                    if(stuGame.olympiadProgress >= 100) {
                        stuGame.isInsured = true;
                        showCustomModal("ğŸ† å›½å®¶é˜Ÿé‡‘ç‰Œï¼", "ä½ åœ¨å¥¥æ—åŒ¹å…‹ç«èµ›ä¸­æ–©è·é‡‘ç‰Œï¼Œå·²æå‰ä¿é€æ¸…åŒ—ï¼æ ¡é•¿ä¹ç–¯äº†ï¼", [{text:"çˆ½", action:()=>{ game.eduPoints+=100; game.reputation+=500; updateUI(); }}]);
                    }
                } else {
                    stuGame.stress += 20;
                    sLog = "é¢˜ç›®å¤ªéš¾ï¼Œä¸€é“æ²¡è§£å‡ºæ¥ï¼Œå¿ƒæ€ç‚¸è£‚ï¼";
                }
            }
        }
        
        let stuBox = document.getElementById('stu-log-box');
        stuBox.innerHTML += `<div>ğŸ‘‰ ${sLog}</div>`;
        stuBox.scrollTop = stuBox.scrollHeight;

        stuGame.turn++; updateStuUI(); 
    }
    
    function endStudentMonth() { advanceMonth(); }

    function updateStuUI() { 
        document.getElementById('stu-val-grade').innerText = stuGame.grade; 
        document.getElementById('stu-val-stress').innerText = stuGame.stress; 
        document.getElementById('stu-val-fit').innerText = stuGame.fit; 
        document.getElementById('stu-val-art').innerText = stuGame.art; 
        document.getElementById('stu-val-oly').innerText = stuGame.olympiadProgress; 
        document.getElementById('stu-val-money').innerText = stuGame.money;
        document.getElementById('stu-val-energy').innerText = stuGame.energy;
        document.getElementById('stu-bar-energy').style.width = (stuGame.energy/stuGame.maxEnergy*100) + '%';
        
        document.getElementById('stu-lover-tag').innerHTML = stuGame.lover ? 'ğŸ’• çˆ±æƒ…æ»‹æ¶¦' : 'ğŸ’” å•èº«ç‹—';

        document.getElementById('stu-ui-year').innerText = Math.ceil(stuGame.turn/12);
        document.getElementById('stu-ui-month').innerText = game.month;
        document.getElementById('stu-ui-turn').innerText = stuGame.turn;
    }
    
    // æ‹çˆ±æœºåˆ¶
    function stuSocial(t) { 
        let cost = 0; let moneyCost = 0;
        if(t === 'greet') cost=5; else if(t==='gift') {cost=10; moneyCost=50;} else if(t==='tutor') cost=30; else if(t==='confess') cost=50;
        
        if(stuGame.energy < cost) { showToast("ç²¾åŠ›ä¸è¶³"); return; }
        if(stuGame.money < moneyCost) { showToast("é›¶èŠ±é’±ä¸å¤Ÿä¹°ç¤¼ç‰©"); return; }
        
        stuGame.energy -= cost;
        stuGame.money -= moneyCost;

        if(t==='confess') {
            if(stuGame.crushAffection >= 100) {
                if(Math.random() > 0.3) {
                    stuGame.lover = true;
                    showToast("ğŸ’˜ è¡¨ç™½æˆåŠŸï¼æ¯æœˆç²¾åŠ›æ¢å¤æé«˜ï¼");
                } else {
                    showToast("ğŸ’” è¢«å‘äº†å¥½äººå¡ï¼Œå‹åŠ›çˆ†è¡¨ï¼");
                    stuGame.stress += 50;
                }
            } else showToast("å¥½æ„Ÿåº¦ä¸æ»¡100ï¼Œè¡¨ç™½å¤±è´¥ï¼");
        } else {
            stuGame.crushAffection += (t==='gift'?15:5);
            stuGame.crushAffection = Math.min(100, stuGame.crushAffection);
        }
        updateStuUI(); 
    }

    // ç¾ç»Šæ¸²æŸ“
    function renderStuFriends() {
        let c = document.getElementById('stu-friends-container');
        c.innerHTML = FRIENDS.map(f => {
            let has = stuGame.friends.includes(f.id);
            return `<div class="friend-card ${has?'active':''}">
                <div><b>${f.name}</b><br><span style="font-size:0.75rem">${f.desc}</span></div>
                ${has?'<span style="color:var(--success);font-weight:bold;">å·²ç»“äº¤</span>':`<button class="btn" style="margin:0;padding:4px;" onclick="buyFriend('${f.id}',${f.cost})">ç»“äº¤ ï¿¥${f.cost}</button>`}
            </div>`;
        }).join('');
    }
    function buyFriend(id, cost) {
        if(stuGame.money >= cost) {
            stuGame.money -= cost;
            stuGame.friends.push(id);
            renderStuFriends();
            updateStuUI();
        } else showToast("é›¶èŠ±é’±ä¸è¶³");
    }

    function organizeExam() { 
        if(!payCost(3,2)) return;
        game.eduPoints += 10;
        
        // æ¨¡æ‹Ÿæˆç»©åˆ†å¸ƒ (æ­£æ€åˆ†å¸ƒè¿‘ä¼¼)
        let total = game.students;
        let baseScore = game.grade * 6 + 150; 
        
        let t_qb = Math.floor(total * (baseScore > 680 ? (baseScore-680)/400 : 0)); 
        let t_985 = Math.floor(total * (baseScore > 600 ? (baseScore-600)/350 : 0)); 
        let t_211 = Math.floor(total * (baseScore > 550 ? (baseScore-550)/300 : 0)); 
        let t_bk = Math.floor(total * (baseScore > 450 ? (baseScore-450)/250 : 0)); 
        let t_zk = Math.floor(total * (baseScore > 300 ? (baseScore-300)/200 : 0)); 
        
        // ä¿®æ­£é‡å 
        t_985 = Math.max(0, t_985 - t_qb);
        t_211 = Math.max(0, t_211 - t_985 - t_qb);
        t_bk = Math.max(0, t_bk - t_211 - t_985 - t_qb);
        t_zk = Math.max(0, t_zk - t_bk - t_211 - t_985 - t_qb);
        let t_fail = Math.max(0, total - t_qb - t_985 - t_211 - t_bk - t_zk);
        
        // 6æ¡£å›¾è¡¨ HTML
        let html = `
        <div class="chart-container" style="width:100%;">
            <div class="chart-col"><div class="chart-bar" style="background:#ef4444; height:${Math.max(2, (t_qb/total)*150)}px;">${t_qb}</div><div class="chart-label">æ¸…åŒ—</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#8b5cf6; height:${Math.max(2, (t_985/total)*150)}px;">${t_985}</div><div class="chart-label">985</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#3b82f6; height:${Math.max(2, (t_211/total)*150)}px;">${t_211}</div><div class="chart-label">211</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#10b981; height:${Math.max(2, (t_bk/total)*150)}px;">${t_bk}</div><div class="chart-label">ä¸€æœ¬</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#f59e0b; height:${Math.max(2, (t_zk/total)*150)}px;">${t_zk}</div><div class="chart-label">äºŒæœ¬</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#64748b; height:${Math.max(2, (t_fail/total)*150)}px;">${t_fail}</div><div class="chart-label">è½æ¦œ</div></div>
        </div>
        <p style="text-align:center;">æ•™ç ”ç‚¹ +10 | æœ¬æ¬¡ä¸Šçº¿ç‡: ${Math.floor((total-t_fail)/total*100)}%</p>
        `;
        
        showCustomModal("ğŸ“Š å…¨æ ¡æ¨¡æ‹Ÿè€ƒå…­æ¡£åˆ†æ", html, [{text:"ç¡®è®¤å½’æ¡£", action:updateUI}]);
        log(`ä¸¾åŠæ¨¡è€ƒï¼Œæ¸…åŒ— ${t_qb} äººï¼Œä¸€æœ¬ä¸Šçº¿ ${t_bk+t_211+t_985+t_qb} äºº`); 
        updateUI();
    }

    function runAction(t) {
        if(t==='sponsor') { if(payCost(4,0)) { game.funds+=50; game.reputation-=20; log("æ‹‰èµåŠ©+50ä¸‡"); updateUI(); } }
    }
    
    function adjustSchedule(t) {
        let val = parseInt(document.getElementById('range-'+t).value);
        game.schedule[t] = val;
        document.getElementById('lbl-'+t+'-hr').innerText = val + "èŠ‚";
        
        let total = game.schedule.main + game.schedule.minor + game.schedule.spec;
        document.getElementById('sch-total-hr').innerText = total;
        let warnBox = document.getElementById('sch-warn-box');
        if(total > 50) { warnBox.style.display='block'; warnBox.innerHTML='âš ï¸ <b>æåº¦å±é™©ï¼š</b>å­¦ç”Ÿæ¿’ä¸´çŒæ­»ï¼'; }
        else if(game.schedule.main > 25) { warnBox.style.display='block'; warnBox.innerHTML='âš ï¸ <b>å±é™©è­¦å‘Šï¼š</b>ä¸»ç§‘æ’è¯¾æ•°è‹¥è¶…è¿‡ <b>25èŠ‚</b>ï¼Œäº§ç”Ÿçš„æ€ç»´ç†µå¢å°†å‘ˆ<b>æŒ‡æ•°çº§çˆ†ç‚¸</b>ï¼'; }
        else { warnBox.style.display='none'; }
        updateUI();
    }

    function upgradeTeacher(k) { if(game.teachers[k]<2 && payCost(0,50)) { game.teachers[k]++; updateUI(); } }
    function triggerGaokao() { showCustomModal("é«˜è€ƒ", "å…­æœˆé«˜è€ƒç»“æŸï¼å‡ºåˆ†ä¸­...", [{text:"OK", action:updateUI}]); }
    function triggerEnrollment() { showCustomModal("å¼€å­¦", "ä¹æœˆæ–°å­¦æœŸå¼€å§‹ï¼Œè¿æ¥æ–°ç”Ÿä¸æ–°ç”Ÿå­¦è´¹ï¼", [{text:"OK", action:updateUI}]); }

    // åˆå§‹åŒ–åŠ è½½
    window.onload = init;
</script>
</body>
</html>

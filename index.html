
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­”å­å­¦æ ¡æ¨¡æ‹Ÿå™¨</title>
    <style>
        :root {
            --bg-body: #0f172a; --panel-bg: rgba(255, 255, 255, 0.96);
            --board-bg: #1e293b; --chalk-white: #f8f9fa; --chalk-yellow: #fde047; --chalk-blue: #60a5fa;
            --primary: #2563eb; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --purple: #8b5cf6;
            --gold: #fbbf24; --wood: #452912;
            --radius: 12px; --shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        /* åŸºç¡€å¸ƒå±€ */
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: var(--bg-body); background-image: radial-gradient(circle at top, #1e293b, #0f172a); color: #334155; margin: 0; padding: 10px; display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden; }
        .container { width: 100%; max-width: 1450px; display: grid; gap: 15px; grid-template-columns: 320px 1fr 320px; transition: 0.5s; }
        
        /* é¡¶éƒ¨æ¨ªå¹… */
        .header-banner { grid-column: 1 / -1; background: linear-gradient(135deg, #7f1d1d, #991b1b); color: #fff; text-align: center; padding: 15px; border-radius: var(--radius); border: 3px solid #fca5a5; box-shadow: var(--shadow); position: relative; }
        .header-banner h1 { margin: 0; font-size: 2.2rem; letter-spacing: 2px; color: var(--chalk-yellow); text-shadow: 2px 2px 5px rgba(0,0,0,0.6); }
        
        /* ç³»ç»Ÿæ  */
        .sys-bar { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; background: var(--panel-bg); padding: 10px 20px; border-radius: var(--radius); box-shadow: var(--shadow); flex-wrap: wrap; gap:10px; }
        .school-badge { padding: 5px 12px; background: linear-gradient(135deg, #fef08a, var(--gold)); color: #713f12; border-radius: 20px; font-weight: 800; border: 1px solid #d97706; }
        .sys-btn { padding:6px 12px; cursor:pointer; background:#f8fafc; border:1px solid #cbd5e1; border-radius:6px; font-weight:bold; transition: 0.2s; color: #1e293b; display: inline-flex; align-items: center; gap: 4px; font-size: 0.85rem; }
        .sys-btn:hover:not(:disabled) { background: #e2e8f0; transform: translateY(-1px); }
        .btn-auto.active { background: var(--danger); color: white; border-color: #b91c1c; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(239,68,68,0.5);} 70% {box-shadow: 0 0 0 8px rgba(239,68,68,0);} 100% {box-shadow: 0 0 0 0 rgba(239,68,68,0);} }

        /* é¢æ¿é€šç”¨ */
        .panel { background: var(--panel-bg); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); display:flex; flex-direction: column; position: relative; }
        .panel-title { font-size: 1.1rem; font-weight: 800; border-bottom: 3px solid var(--primary); padding-bottom: 8px; margin-top: 0; margin-bottom: 12px; color: #1e293b; display:flex; justify-content:space-between; align-items:flex-end; }
        
        /* èµ„æºæ ¼å­ */
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .res-box { background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; position: relative; }
        .res-box span { display: block; font-size: 1.2rem; font-weight: 900; color: var(--primary); margin-top: 5px; font-family: monospace; }
        .res-sub { font-size: 0.65rem; color: #64748b; position: absolute; bottom: 2px; right: 5px; font-weight:bold; }

        /* é»‘æ¿å±æ€§æ¡ */
        .blackboard { background: var(--board-bg); border: 8px solid var(--wood); border-radius: 6px; padding: 15px; color: var(--chalk-white); box-shadow: inset 0 0 15px rgba(0,0,0,0.8); }
        .stat-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem; font-weight: bold; position:relative; }
        .stat-label { width: 85px; color: var(--chalk-blue); z-index:2; }
        .bar-bg { flex: 1; height: 18px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); margin: 0 10px; position:relative; }
        .bar-fill { height: 100%; transition: width 0.3s ease-out; background-image: linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 10px 100%; }
        .stat-val { width: 35px; text-align: right; font-family: monospace; font-size: 1.1rem; color: var(--chalk-yellow); z-index:2; }
        .stress-warning { color: #fca5a5; font-size: 0.75rem; text-align: center; animation: blink 0.8s infinite; margin-top:-5px; font-weight:bold; display:none; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* æŒ‰é’®ç»„ä»¶ */
        .btn { width: 100%; padding: 10px; background: #fff; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; text-align: left; transition: 0.2s; font-weight: bold; color: #334155; display:flex; flex-direction:column; margin-bottom:8px; position: relative;}
        .btn:hover:not(:disabled) { border-color: var(--primary); background: #eff6ff; transform: translateX(3px); }
        .btn:disabled { background: #f1f5f9; border-color: #cbd5e1; color: #94a3b8; cursor: not-allowed; opacity: 0.7; }
        .btn-desc { font-size: 0.7rem; color: #64748b; font-weight: normal; margin-top: 4px; }
        .btn-main { background: linear-gradient(135deg, var(--primary), #1e40af); color: white; border: none; font-size: 1.2rem; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 900; width: 100%; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.4); text-align:center; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(37, 99, 235, 0.6); }

        /* æ¨¡æ€æ¡†ç³»ç»Ÿ */
        .fs-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.9); z-index: 2000; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(4px); }
        .fs-content { background: #f8fafc; width: 100%; max-width: 1300px; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .fs-header { background: #1e293b; color: white; padding: 15px 20px; display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; align-items:center; }
        .fs-close { background: transparent; border: none; color: white; font-size: 1.8rem; cursor: pointer; line-height:1; }
        .fs-body { padding: 20px; overflow-y: auto; flex: 1; }

        /* ç½‘æ ¼ä¸å¡ç‰‡ */
        .grid-sys { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
        .gacha-card { background: #fff; border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 15px; position:relative; }
        .expert-img { width: 65px; height: 65px; border-radius: 32px; object-fit: cover; border: 2px solid #cbd5e1; background: #f1f5f9; flex-shrink: 0; }
        .upkeep-tag { position:absolute; top:5px; right:5px; font-size:0.7rem; background:#fee2e2; color:#991b1b; padding:2px 5px; border-radius:4px; font-weight:bold; }
        .type-tag { position:absolute; bottom:5px; right:5px; font-size:0.7rem; padding:2px 5px; border-radius:4px; font-weight:bold; }
        .type-battle { background: #fee2e2; color:#b91c1c; } .type-passive { background: #e0f2fe; color:#0369a1; }
        .rarity-R { border-color: #3b82f6; box-shadow: 0 0 10px rgba(59,130,246,0.2); }
        .rarity-SR { border-color: #a855f7; box-shadow: 0 0 15px rgba(168,85,247,0.3); }
        .rarity-SSR { border-color: var(--gold); box-shadow: 0 0 20px rgba(251,191,36,0.5); background: linear-gradient(135deg, #fff, #fefce8); }
        
        /* æ ‘å½¢ç»“æ„ */
        .tree-tier { display: flex; gap: 15px; justify-content: center; width: 100%; margin-bottom: 25px; flex-wrap: wrap; }
        .tree-node { width: 220px; background:#fff; border: 2px solid #cbd5e1; border-radius: 8px; padding: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.3s; display: flex; flex-direction: column; justify-content: space-between; }
        .tree-node.locked { filter: grayscale(1); opacity: 0.6; }
        .tree-node.unlocked { border-color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); background:#f0fdf4; }
        .tree-node.branch-a { border-top: 5px solid var(--danger); }
        .tree-node.branch-b { border-top: 5px solid var(--warning); }
        .tree-node.branch-c { border-top: 5px solid #fbbf24; }
        .tree-node.branch-d { border-top: 5px solid var(--success); }

        /* åœ°å›¾ */
        .map-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background: #84cc16; padding: 15px; border-radius: 8px; border: 4px solid #4d7c0f; }
        .map-cell { background: rgba(255,255,255,0.5); border: 2px dashed #65a30d; border-radius: 6px; height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; position: relative; }
        .map-cell:hover { background: rgba(255,255,255,0.9); }
        .map-cell.selected { border: 3px solid var(--danger); background: #fff; }

        /* æ—¥å¿— */
        .log-box { flex: 1; overflow-y: auto; font-size: 0.85rem; background: #fff; border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; line-height: 1.5; }
        .log-item { margin-bottom: 8px; border-bottom: 1px dashed #e2e8f0; padding-bottom: 4px; }
        
        /* ç‹¬ç«‹å­¦ç”Ÿä¿¡ç®±æ ·å¼ */
        .mailbox-container { height: 180px; overflow-y: auto; background: #f1f5f9; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px;}
        .comment-bubble { background: #fff; border-left: 4px solid var(--primary); padding: 10px; border-radius: 0 8px 8px 0; font-size: 0.85rem; color: #1e293b; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .comment-meta { font-size: 0.7rem; color: #94a3b8; margin-top: 5px; text-align: right; }

        /* æˆ˜æ–—ç³»ç»Ÿå¸ƒå±€ */
        .battle-ui { display: flex; flex-direction: column; height: 85vh; max-height:850px; background: #000; color: #a3e635; padding: 15px; border-radius: 8px; font-family: 'Courier New', Courier, monospace; overflow: hidden; box-shadow: 0 0 30px rgba(101, 163, 13, 0.2); }
        .b-header { flex: 0 0 auto; display: flex; justify-content: space-between; border-bottom: 1px dashed #3f6212; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; color: #bef264; }
        .b-arena { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border: 2px solid #65a30d; border-radius: 8px; background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(20, 83, 45, 0.7)); position: relative; height: 160px; box-shadow: inset 0 0 25px rgba(101, 163, 13, 0.4); }
        .b-entity { width: 42%; background: rgba(0, 0, 0, 0.6); padding: 12px; border-radius: 8px; border: 1px solid #3f6212; box-shadow: 0 0 15px rgba(0,0,0,0.8); }
        .b-name { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; color: #d9f99d; text-shadow: 0 0 5px #d9f99d; }
        .b-hp-bg { height: 14px; background: #000; border: 1px solid #a3e635; margin: 5px 0; position: relative; border-radius:3px; overflow:hidden;}
        .b-hp-fill { height: 100%; background: linear-gradient(90deg, #4ade80, #16a34a); box-shadow: inset 0 0 8px rgba(255,255,255,0.4); transition: width 0.3s ease-out; }
        .b-hp-txt { position: absolute; width: 100%; text-align: center; top: -1px; font-size: 0.75rem; font-weight: bold; color: #fff; text-shadow:1px 1px 2px #000;}
        .b-stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 0.75rem; color:#cbd5e1; }
        .b-stress-bar { height: 5px; background: #000; border: 1px solid #ef4444; margin-top: 4px; border-radius:2px; }
        .b-stress-fill { height: 100%; background: #dc2626; transition: width 0.3s; }
        
        .b-weather { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); text-align: center; background: rgba(0,0,0,0.8); padding: 5px 12px; border-radius: 6px; border: 1px solid #fde047; color: #fde047; font-size: 0.75rem; z-index: 10; width: 150px; box-shadow: 0 0 10px rgba(253,224,71,0.3);}
        .b-buffs { display: flex; flex-wrap: wrap; gap: 4px; font-size: 0.7rem; margin-top: 5px; color: #a7f3d0; }
        
        /* æˆ˜æ–—æ—¥å¿—åŒºåŸŸ */
        .b-log { flex: 1; border: 1px dashed #3f6212; padding: 10px; margin: 10px 0; overflow-y: auto; font-size: 0.85rem; line-height: 1.5; background: rgba(0,0,0,0.4); min-height: 100px; display:flex; flex-direction:column; border-radius:4px; }
        .b-log-inner { margin-top: auto; } /* å¼ºåˆ¶å†…å®¹é ä¸‹ */
        .b-log span.sys { color: #fde047; } .b-log span.p { color: #93c5fd; } .b-log span.e { color: #fca5a5; } 
        .b-log span.dmg { color: #ef4444; font-weight: bold; } .b-log span.crit { color: #c084fc; font-weight: bold; text-shadow: 0 0 5px #c084fc; }
        
        .b-expert-select { flex: 0 0 auto; display:flex; gap:10px; margin-bottom:10px; overflow-x:auto; padding-bottom:5px; border-bottom:1px dashed #3f6212; min-height: 35px; align-items:center; }
        .b-expert-select::-webkit-scrollbar { height: 4px; }
        .b-expert-select::-webkit-scrollbar-thumb { background: #3f6212; border-radius: 2px; }

        /* æ“ä½œåŒºåŸŸ */
        .b-actions { flex: 0 0 auto; border-top: 1px dashed #3f6212; padding-top: 10px; display: grid; grid-template-columns: 140px 1fr; gap: 10px; height: 160px; }
        .b-cats { display: flex; flex-direction: column; gap: 4px; overflow-y: auto; padding-right:5px;}
        .b-cats::-webkit-scrollbar { width: 4px; } .b-cats::-webkit-scrollbar-thumb { background:#3f6212; }
        .b-cat-btn { background: rgba(0,0,0,0.6); color: #a3e635; border: 1px solid #3f6212; padding: 8px; cursor: pointer; font-family: inherit; font-size: 0.85rem; text-align: left; transition: 0.2s; border-radius:4px; }
        .b-cat-btn:hover, .b-cat-btn.active { background: #14532d; border-color: #a3e635; box-shadow: 0 0 8px rgba(163,230,53,0.3); }
        .b-skills { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 8px; align-content: start; overflow-y: auto; padding-right:5px; }
        .b-skills::-webkit-scrollbar { width: 4px; } .b-skills::-webkit-scrollbar-thumb { background:#3f6212; }
        .b-skill-btn { background: rgba(0,0,0,0.6); color: #fff; border: 1px solid #4ade80; padding: 8px; cursor: pointer; font-family: inherit; text-align: left; display: flex; flex-direction: column; transition: 0.2s; border-radius:4px; }
        .b-skill-btn:hover:not(:disabled) { background: #166534; transform: translateX(2px); box-shadow: 0 0 8px rgba(74,222,128,0.4); }
        .b-skill-btn:disabled { border-color: #334155; color: #64748b; cursor: not-allowed; text-decoration: line-through; opacity: 0.6; }
        .b-s-name { font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }
        .b-s-desc { font-size: 0.7rem; color: #bef264; }

        /* å­¦ç”Ÿæ¨¡å¼ */
        #student-container { display: none; width: 100%; max-width: 1400px; background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px; margin: 0 auto; box-shadow: var(--shadow); }
        .stu-grid { display: grid; grid-template-columns: 320px 1fr 340px; gap: 20px; }
        .stu-act-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stu-act-btn { padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; background: #fff; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; transition:0.2s; text-align:left; }
        .stu-act-btn:hover { border-color: var(--primary); background: #eff6ff; transform:scale(1.02); }
        .stu-stat-box { background: #1e293b; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .exam-board { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; border: 3px solid #047857; }
        
        .friend-card { background: #f8fafc; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap:wrap; gap:5px; }
        .friend-card.active { border-color: var(--success); background: #ecfdf5; }
        .rebirth-points { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; }
        .family-card { background: #fff; border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; position:relative; }
        .family-card:hover { border-color: var(--primary); background: #eff6ff; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .family-card.selected { border-color: var(--primary); background: #eff6ff; box-shadow: 0 0 0 3px rgba(37,99,235,0.2); }

        /* æ‹çˆ±å¡ç‰‡ */
        .crush-card { background: #fff; border: 2px solid #fbcfe8; border-radius: 8px; padding: 10px; margin-bottom: 10px; display:flex; flex-direction:column; position:relative; overflow:hidden;}
        .crush-head { display:flex; gap:10px; align-items:center; margin-bottom:10px; }
        .crush-img { width: 70px; height: 70px; border-radius: 50%; border: 2px solid #f9a8d4; object-fit: cover; background: #fdf2f8; flex-shrink:0; cursor:pointer; transition:0.2s; }
        .crush-img:hover { transform: scale(1.1); box-shadow: 0 0 15px rgba(249,168,212,0.5); }
        .crush-info h4 { margin:0 0 2px 0; color:#be185d; font-size:1rem;}
        .crush-info p { margin:0; font-size:0.7rem; color:#64748b;}
        .crush-bar-bg { background:#f1f5f9; height:8px; border-radius:4px; overflow:hidden; margin-bottom:8px; border:1px solid #cbd5e1;}
        .crush-bar-fill { background:linear-gradient(90deg, #f472b6, #db2777); height:100%; transition: width 0.3s;}
        .crush-actions { display:grid; grid-template-columns:1fr 1fr; gap:5px; }
        .crush-dialog { background:#fdf2f8; padding:8px; border-radius:6px; font-size:0.75rem; color:#be185d; font-style:italic; margin-bottom:8px; display:none; border-left:3px solid #f472b6;}

        /* å›¾è¡¨ */
        .chart-container { display: flex; align-items: flex-end; justify-content: space-around; height: 180px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px 5px 0 5px; margin: 15px 0; }
        .chart-col { display: flex; flex-direction: column; align-items: center; width: 14%; font-size: 0.7rem; }
        .chart-bar { width: 100%; border-radius: 4px 4px 0 0; transition: 0.5s; display: flex; justify-content: center; align-items:flex-end; color: white; font-weight: bold; padding-top: 5px; font-size: 0.8rem; padding-bottom:2px;}
        .chart-label { font-size: 0.7rem; font-weight: bold; margin-top: 5px; color: #475569; text-align: center; line-height:1.2; }

        /* é€šç”¨å¼¹çª—è¦†ç›– */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 9000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.6); max-height: 90vh; overflow-y:auto; }
        .modal-btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 8px; font-weight: bold; font-size: 1rem; transition: 0.2s; display:inline-flex; flex-direction:column; align-items:center; }
        .modal-btn:hover { background: #1d4ed8; transform: translateY(-2px); }

        /* Toast */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: rgba(15,23,42,0.95); color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold; border-left: 4px solid var(--primary); animation: slideIn 0.3s forwards, fadeOut 0.5s 3.5s forwards; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        @keyframes slideIn { from{transform: translateX(100%);} to{transform: translateX(0);} }
        @keyframes fadeOut { to{transform: translateY(-20px); opacity:0;} }
    </style>
</head>
<body>

<div id="toast-container"></div>

<!-- ================= æ ¡é•¿æ¨¡å¼ ================= -->
<div class="container" id="principal-container" style="display:none;">
    <div class="header-banner">
        <h1>å­”å­å­¦æ ¡ V1.0a å½¼å²¸ç¯ç«</h1>
        <p style="margin: 5px 0 0 0; font-size: 0.95rem; opacity: 0.9;">By ChansonTech | å¤§åƒä¸–ç•Œï¼Œçš†åœ¨å±€ä¸­</p>
    </div>

    <div class="sys-bar">
        <div style="display:flex; align-items:center; gap: 10px;">
            <span class="school-badge" id="ui-level-name">ğŸ† ä¹¡é•‡ä¸­å­¦</span>
            <button class="sys-btn" onclick="checkUpgrade()">ğŸ–ï¸ ç”³è¯·è¯„çº§ (æ˜¾ç¤ºæ¡ä»¶)</button>
            <button class="sys-btn btn-auto" id="btn-auto" onclick="toggleAuto()">ğŸ¤– è‡ªåŠ¨æ¨æ¼”</button>
        </div>
        <div style="display:flex; gap: 8px; align-items:center;">
            <span style="font-weight:bold; color:var(--danger); font-size:0.9rem;">âš”ï¸ è”è€ƒæˆ˜ç»©: <span id="ui-examPoints">0</span>åˆ†</span>
            <button class="sys-btn" style="background:var(--purple); color:white; border:none; padding:8px 15px;" onclick="switchMode('student')">ğŸ‘¨â€ğŸ“ åˆ‡æ¢è‡³ï¼šå­¦ç”Ÿè§†è§’</button>
            <span id="ui-diff-badge" style="font-size:0.8rem; background:#475569; color:white; padding:4px 8px; border-radius:4px; font-weight:bold;">éš¾åº¦: æ­£å¸¸</span>
            <button class="sys-btn" style="background:linear-gradient(135deg,#1e3a5f,#1e40af); color:#93c5fd; border:none;" onclick="showSocialWindow()">ğŸ¤ ç¤¾ä¼šå…³ç³»</button>
            <button class="sys-btn" style="background:linear-gradient(135deg,#064e3b,#065f46); color:#6ee7b7; border:none;" onclick="showMonthlyTargets()">ğŸ¯ æœˆåº¦ç›®æ ‡</button>
            <button class="sys-btn" style="background:linear-gradient(135deg,#4c1d95,#5b21b6); color:#c4b5fd; border:none;" onclick="showOlympiadSystem()">ğŸ† å­¦ç§‘ç«èµ›</button>
            <button class="sys-btn" onclick="hardReset()" style="color:var(--danger)">ğŸ”„ æŠ¹é™¤å­˜æ¡£</button>
        </div>
    </div>

    <div class="panel">
        <h2 class="panel-title">ğŸ“Š è´¢åŠ¡ä¸è¡Œæ”¿ä¸­æ¢</h2>
        <div class="res-grid">
            <div class="res-box">æ€»èµ„é‡‘(ä¸‡) <span id="ui-funds" style="color:#059669;">100</span><div class="res-sub" id="ui-salary">å¸¸è€—:-0 ä¸“å®¶:-0</div></div>
            <div class="res-box">åœ¨æ ¡ç”Ÿè§„æ¨¡ <span id="ui-students" style="color:#2563eb;">300</span></div>
            <div class="res-box">ç¤¾ä¼šå£°èª‰ <span id="ui-rep" style="color:var(--warning)">100</span></div>
            <div class="res-box">è¡Œæ”¿ AP <span><span id="ui-ap">10</span>/<span id="ui-maxap">20</span></span></div>
        </div>

        <h2 class="panel-title" style="margin-top: 5px;">ğŸ§¬ ç”Ÿæºå…­ç»´ (å½±å“å…¨æ ¡æˆ˜åŠ›)</h2>
        <div class="blackboard">
            <div class="stat-row"><div class="stat-label">ğŸ“š å­¦ä¸š(æ”»å‡»)</div><div class="bar-bg"><div id="bar-grade" class="bar-fill" style="background:linear-gradient(90deg, #3b82f6, #60a5fa);"></div></div><div class="stat-val" id="val-grade">40</div></div>
            <div class="stat-row" style="margin-bottom:0;"><div class="stat-label">ğŸ¤¯ å‹åŠ›(ç†µå¢)</div><div class="bar-bg"><div id="bar-stress" class="bar-fill" style="background:linear-gradient(90deg, #ef4444, #f87171);"></div></div><div class="stat-val" id="val-stress">20</div></div>
            <div class="stress-warning" id="warn-stress">âš ï¸ è­¦å‘Šï¼šæ€ç»´ç†µå¢æ¿’ä¸´å´©æºƒæé™ï¼</div>
            <div class="stat-row" style="margin-top:10px;"><div class="stat-label">ğŸ›¡ï¸ çºªå¾‹(é˜²å¾¡)</div><div class="bar-bg"><div id="bar-disc" class="bar-fill" style="background:linear-gradient(90deg, #f59e0b, #fbbf24);"></div></div><div class="stat-val" id="val-disc">60</div></div>
            <div class="stat-row"><div class="stat-label">ğŸƒâ€â™‚ï¸ ä½“è´¨(è¡€é‡)</div><div class="bar-bg"><div id="bar-fit" class="bar-fill" style="background:linear-gradient(90deg, #10b981, #34d399);"></div></div><div class="stat-val" id="val-fit">50</div></div>
            <div class="stat-row"><div class="stat-label">ğŸ¨ è‰ºæœ¯(æš´å‡»)</div><div class="bar-bg"><div id="bar-art" class="bar-fill" style="background:linear-gradient(90deg, #8b5cf6, #a78bfa);"></div></div><div class="stat-val" id="val-art">30</div></div>
        </div>
    </div>

    <div class="panel">
        <div style="text-align: center; margin-bottom: 15px; background:#f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div id="ui-date" style="font-size: 1.6rem; font-weight: 900; color: var(--primary); letter-spacing: 1px;">2018å¹´ 9æœˆ</div>
        </div>
        <button class="btn-main" id="btn-advance" onclick="advanceMonth()">â³ æ¨è¿›ä¸€ä¸ªæœˆ (è§¦å‘äº‹ä»¶/è”è€ƒ/æ”¶å­¦è´¹)</button>

        <h2 class="panel-title">ğŸ§  æˆ˜å¤‡</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom:15px;">
            <button class="btn" style="background:#ecfdf5; border-color:#10b981;" onclick="openModal('modal-map')">ğŸ—ºï¸ æ ¡å›­åŸºå»ºæ‰©å»º<span class="btn-desc">3çº§ç‰¹æŠ€å»ºç­‘è§£é”</span></button>
            <button class="btn" style="background:#eff6ff; border-color:#3b82f6;" onclick="openModal('modal-experts')">ğŸ‘¨â€ğŸ« å¯»è®¿é¡¶çº§åå¸ˆ<span class="btn-desc">40ä½ä¸“å®¶+å¼ºåŠ›æˆ˜æŠ€</span></button>
            <button class="btn" style="background:#faf5ff; border-color:#a855f7;" onclick="openModal('modal-schedule')">ğŸ“… å¸ˆèµ„ä¸ä¸»ç§‘æ’è¯¾<span class="btn-desc">ä¼˜åŒ–æ’è¯¾</span></button>
            <button class="btn" style="background:#fefce8; border-color:#eab308;" onclick="openModal('modal-policy')">ğŸ« æ ¡ç­–ç§‘æŠ€æ ‘<span class="btn-desc">æ•™ç ”ç‚¹: <span id="ui-eduPoints" style="font-weight:bold;color:var(--danger)">0</span></span></button>
        </div>

        <h2 class="panel-title">ğŸ¯ æˆ˜æœ¯</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <button class="btn" onclick="organizeExam()">ğŸ“ æ¨¡æ‹Ÿè€ƒ<span class="btn-desc">è€—AP:3, ï¿¥<span id="cost-exam" class="c-val">2</span>ä¸‡ | å…­æ¡£åˆ†æ+å£°èª‰</span></button>
            <button class="btn" onclick="showGaokaoHistory()">ğŸ“Š å†å¹´é«˜è€ƒæˆç»©<span class="btn-desc">æŸ¥çœ‹å†å¹´æˆç»©æŸ±çŠ¶å›¾</span></button>
            <button class="btn" onclick="openModal('modal-branches')">ğŸŒ å»ºç«‹å…¨çƒåˆ†æ ¡<span class="btn-desc">è€—å·¨èµ„å»ºç«‹éœ¸ä¸šåˆ†æ ¡</span></button>
            <button class="btn" onclick="runAction('sponsor')">ğŸ¤ å®´è¯·æ‹‰èµåŠ©<span class="btn-desc">è€—AP:4, é™å£°èª‰ | å¾—ï¿¥<span id="gain-spo" style="color:var(--success)">100</span>ä¸‡</span></button>
            <button class="btn" onclick="openModal('modal-achieve')">ğŸ† è£èª‰ä¸æ ¡å‹å½•<span class="btn-desc">æˆå°±è§£é”ä¸åäººå ‚</span></button>
        </div>
    </div>

    <div class="panel" style="display: flex; flex-direction: column;">
        <h2 class="panel-title">ğŸ“¨ å­¦ç”Ÿä¿¡ç®±</h2>
        <div id="student-comments-box" class="mailbox-container"></div>

        <h2 class="panel-title">ğŸ“œ çºªäº‹æœ¬æœ«</h2>
        <div class="log-box" id="log-box"></div>
    </div>
</div>

<!-- ================= å­¦ç”Ÿæ¨¡å¼ ================= -->
<div id="student-container">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 3px solid var(--purple); padding-bottom:10px; margin-bottom:20px;">
        <h1 style="margin:0; color:var(--purple);">ğŸ‘¨â€ğŸ“ å­¦ç”Ÿæ¨¡å¼</h1>
        <div style="display:flex; align-items:center; gap:15px;">
            <span class="rebirth-points">â˜¯ï¸ è½®å›ç‚¹æ•°: <span id="stu-ui-rp">0</span></span>
            <button class="sys-btn" style="background:linear-gradient(135deg,#1e1b4b,#312e81); color:#a5b4fc; border:none;" onclick="showStuJournal()">ğŸ““ å†…å¿ƒæ—¥è®°</button>
            <button class="sys-btn" onclick="switchMode('principal')">ğŸ”™ æ”¾å¼ƒå­¦ä¸šï¼Œè¿”å›æ ¡é•¿æ¨¡å¼</button>
        </div>
    </div>

    <div id="stu-setup" style="text-align:center; padding: 20px;">
        <h2>ç¬¬ä¸€æ­¥ï¼šä½ çš„åŸç”Ÿå®¶åº­å†³å®šäº†èµ·è·‘çº¿</h2>
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top:20px;" id="stu-family-grid"></div>
        
        <h2 style="margin-top:40px;">ç¬¬äºŒæ­¥ï¼šæ¶ˆè€—è½®å›ç‚¹è´­ä¹°å‰ä¸–é—æ³½</h2>
        <div style="display:flex; justify-content:center; gap:15px; margin-top:15px;" id="stu-talent-grid">
            <button class="btn" onclick="buyTalent('genius', 20, this)">ğŸ§  è¿‡ç›®ä¸å¿˜ (20ç‚¹)<br><span class="btn-desc">æ¯æ¬¡å­¦ä¹ é¢å¤–+3å­¦ä¸š</span></button>
            <button class="btn" onclick="buyTalent('rich', 15, this)">ğŸ’° éšå½¢å¯Œè±ª (15ç‚¹)<br><span class="btn-desc">å¼€å±€è‡ªå¸¦ï¿¥1000å·¨é¢èµ„é‡‘</span></button>
            <button class="btn" onclick="buyTalent('charm', 10, this)">âœ¨ ç»ä¸–å®¹é¢œ (10ç‚¹)<br><span class="btn-desc">å¼€å±€é­…åŠ›+40ï¼Œæ‹çˆ±æ˜“å¦‚åæŒ</span></button>
        </div>
        <button class="btn-main" style="width:300px; margin-top:30px; font-size:1.5rem;" onclick="startStudentGameplay()">âœ¨ é™ç”Ÿï¼Œå¼€å¯æ ¡å›­ç”Ÿæ´»</button>
    </div>

    <div id="stu-gameplay" style="display:none;" class="stu-grid">
        <!-- å·¦ä¾§çŠ¶æ€ -->
        <div>
            <div class="stu-stat-box">
                <h3 style="margin-top:0; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;">ğŸ“Š ä¸ªäººçŠ¶æ€é¢æ¿</h3>
                <div>ğŸ“† è¿›åº¦: é«˜<span id="stu-ui-year">ä¸€</span> <span id="stu-ui-month">ä¸Š</span>å­¦æœŸ (<span id="stu-ui-turn">1</span>/36)</div>
                <div style="font-size:0.8rem; color:#cbd5e1; margin-top:5px;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ å®¶åº­èƒŒæ™¯: <span id="stu-ui-family">åŠ è½½ä¸­</span></div>
                <div style="font-size:0.8rem; color:#fde047; margin-top:5px; font-weight:bold;">ğŸ’µ é›¶èŠ±é’±: ï¿¥<span id="stu-val-money">0</span></div>
                
                <!-- ç²¾åŠ›æ¡ -->
                <div style="margin-top:10px; background:rgba(0,0,0,0.5); border-radius:4px; padding:2px; border:1px solid #4ade80;">
                    <div style="font-size:0.7rem; color:#4ade80; text-align:center;">âš¡ æœ¬æœˆç²¾åŠ› <span id="stu-val-energy">100</span>/100</div>
                    <div style="height:6px; background:#4ade80; width:100%; transition:0.3s;" id="stu-bar-energy"></div>
                </div>

                <div style="margin-top:10px;">
                    <div style="display:flex; justify-content:space-between;"><span>ğŸ“š å­¦ä¸šæŒæ§</span> <span id="stu-val-grade" style="color:var(--chalk-yellow);font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>ğŸ¤¯ ç²¾ç¥å‹åŠ›</span> <span id="stu-val-stress" style="color:#fca5a5;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>ğŸƒâ€â™‚ï¸ èº«ä½“ç´ è´¨</span> <span id="stu-val-fit" style="color:#a7f3d0;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>ğŸ¨ ä¸ªäººé­…åŠ›</span> <span id="stu-val-art" style="color:#c4b5fd;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; border-top:1px dashed #475569; padding-top:5px;">
                        <span style="color:#fbbf24">ğŸ¥‡ å¥¥èµ›: <span id="stu-val-oly">0</span>%</span>
                        <span style="color:#60a5fa" id="stu-lover-tag">ğŸ’” å•èº«ç‹—</span>
                    </div>
                </div>
            </div>

            <div class="exam-board">
                <h3 style="margin:0 0 5px 0;">ä¸Šæœˆå¤§å‹è”è€ƒæˆç»©</h3>
                <div style="font-size:3rem; font-weight:900; line-height:1;" id="stu-exam-score">--</div>
                <div style="font-size:0.9rem; margin-top:5px; opacity:0.9;" id="stu-exam-rank">å…¨æ ¡æ’å: å°šæœªè¿›è¡Œ</div>
            </div>

            <button class="btn-main" style="background:#475569; margin-top:10px;" onclick="endStudentMonth()">ğŸ›Œ ç¡è§‰ (ç»“æŸæœ¬æœˆ)</button>
        </div>

        <!-- ä¸­é—´åŠ¨ä½œåŒº -->
        <div style="display:flex; flex-direction:column; height:100%;">
            <h2 style="margin-top:0;">ğŸ¯ æœ¬æœˆè¡ŒåŠ¨ (æ¶ˆè€—ç²¾åŠ›)</h2>
            <div class="stu-act-grid" style="flex:1; overflow-y:auto; padding-right:10px;">
                <button class="stu-act-btn" onclick="stuAct('hard_study')"><span style="font-size:2rem;">âœï¸</span><div><b>ç‹‚åˆ·çœŸé¢˜ç†¬å¤œ</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:40 | å­¦ä¸š++, å·¨é¢å¢å‹</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('study')"><span style="font-size:2rem;">ğŸ“–</span><div><b>è®¤çœŸå¬è®²åšç¬”è®°</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:25 | å­¦ä¸š+, å‹åŠ›æå‡</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('olympiad')"><span style="font-size:2rem;">ğŸ”¬</span><div><b>æ­»ç£•å¥¥èµ›/å¼ºåŸº</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:50 | æéš¾, æ»¡100ä¿é€</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('mun')"><span style="font-size:2rem;">ğŸŒ</span><div><b>æ¨¡æ‹Ÿè”åˆå›½</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:50 | å­¦ä¸š+, é­…åŠ›++</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('work')"><span style="font-size:2rem;">ğŸ”</span><div><b>æ ¡å¤–å¿«é¤åº—æ‰“å·¥</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:30 | èµšå–é‡‘é’±, è€—ä½“è´¨</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('scalper')"><span style="font-size:2rem;">ğŸ«</span><div><b>å€’å–æ˜æ˜Ÿå‘¨è¾¹</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:30 | é«˜é£é™©èµšé’±</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('esport')"><span style="font-size:2rem;">ğŸ®</span><div><b>æŠ¥åç½‘å§ç”µç«è”èµ›</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:40 | èµ¢äº†çˆ†èµšå‡å‹</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('show')"><span style="font-size:2rem;">ğŸ¤</span><div><b>å‚åŠ æ ¡å›­æ‰è‰ºå¤§èµ›</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:40 | éœ€è¦é«˜é­…åŠ›æ”¯æ’‘</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('sport')"><span style="font-size:2rem;">ğŸ€</span><div><b>å‚åŠ ç¤¾å›¢æ‰“çƒ</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:25 | ä½“è´¨++, é­…åŠ›+, å¾®å‡å‹</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('book')"><span style="font-size:2rem;">ğŸ“š</span><div><b>èº²å›¾ä¹¦é¦†çœ‹é—²ä¹¦</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:20 | é­…åŠ›++, å¾®å‡å‹</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('rooftop')"><span style="font-size:2rem;">ğŸŒ†</span><div><b>å¤©å°å¹é£å‘å‘†</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:20 | å‹åŠ›å°å¹…åº¦ä¸‹é™</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('sick')"><span style="font-size:2rem;">ğŸ¥</span><div><b>è£…ç—…å»åŒ»åŠ¡å®¤èººå¹³</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:10 | å­¦ä¸š--, å‡åŠå‹åŠ›</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('diary')"><span style="font-size:2rem;">ğŸ““</span><div><b>å†™æ—¥è®°/è¡¨è¾¾å†…å¿ƒ</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:10 | è§£é”ç‰¹æ®Šç»“å±€/å‡å‹</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('volunteer')"><span style="font-size:2rem;">ğŸ¤</span><div><b>å‚åŠ ç¤¾åŒºå¿—æ„¿æœåŠ¡</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:25 | ç»¼æµ‹åŠ åˆ†ï¼Œé­…åŠ›++</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('club_drama')"><span style="font-size:2rem;">ğŸ­</span><div><b>å‚åŠ è¯å‰§ç¤¾æ’ç»ƒ</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:35 | é­…åŠ›+++ï¼Œå‹åŠ›å¤§å‡</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('tutor')"><span style="font-size:2rem;">ğŸ‘¨â€ğŸ«</span><div><b>ç»™å­¦å¼Ÿå­¦å¦¹è¡¥è¯¾</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:30 | èµšé’±+å­¦ä¸šå·©å›º</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('fight')"><span style="font-size:2rem;">ğŸ¥Š</span><div><b>å’Œéš”å£ç­æ‰“æ¶</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:20 | é«˜é£é™©ï¼Œçºªå¾‹æƒ©ç½š</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('confession_prep')"><span style="font-size:2rem;">ğŸ’Œ</span><div><b>ç²¾å¿ƒç­–åˆ’è¡¨ç™½æ–¹æ¡ˆ</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—èƒ½:40 | å¤§å¹…æå‡æ”»ç•¥æˆåŠŸç‡</span></div></button>
            
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:10px; height: 150px; overflow-y:auto; font-size:0.85rem; margin-top:15px;" id="stu-log-box"></div>
        </div>

        <!-- å³ä¾§ç¤¾äº¤åŒº -->
        <div style="display:flex; flex-direction:column; overflow:hidden;">
            <div style="background:#fff; border:2px solid #fbcfe8; border-radius:8px; padding:15px; margin-bottom:15px; display:flex; flex-direction:column; flex:1; overflow-y:auto;">
                <h3 style="margin:0 0 10px 0; color:#db2777;">ğŸ’Œ æ ¡å›­å¿ƒè·³å›å¿†</h3>
                <p style="font-size:0.7rem; color:#94a3b8; margin:0 0 10px 0;">ä¸åŒçš„æ”¿ç­–ä¼šæå¤§å½±å“æ”»ç•¥éš¾åº¦ã€‚è¯·é€‰æ‹©ä½ çš„ç¾ç»Šå¯¹è±¡ï¼š</p>
                <div id="stu-crush-container" style="display:flex; flex-direction:column; gap:8px;"></div>
            </div>

            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:15px; flex:0 0 auto;">
                <h3 style="margin:0 0 10px 0;">ğŸ‘¬ åŒæ¡Œä¸æ­»å…šç¾ç»Š</h3>
                <div id="stu-friends-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- ================= æ¨¡æ€æ¡†ç»„ ================= -->
<div id="modal-map" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>ğŸ—ºï¸ æ ¡å›­åŸºå»ºè§„åˆ’ä¸ç‰¹çº§å‡çº§ (20åœ°å—)</div><button class="fs-close" onclick="closeModal('modal-map')">Ã—</button></div>
        <div class="fs-body" style="display:grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            <div class="map-grid" id="map-grid"></div>
            <div style="background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:15px; overflow-y:auto;">
                <h3 style="margin-top:0; border-bottom:2px solid #e2e8f0; padding-bottom:8px;">ğŸ› ï¸ å·¥ç¨‹å›¾çº¸</h3>
                <p id="map-hint" style="color:var(--danger); font-size:0.9rem;">è¯·å…ˆåœ¨å·¦ä¾§ç‚¹é€‰ä¸€å—ç©ºåœ°æˆ–å·²å»ºå»ºç­‘ï¼</p>
                <div id="fac-list" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </div>
    </div>
</div>

<div id="modal-experts" class="fs-modal">
    <div class="fs-content" style="max-width:1100px;">
        <div class="fs-header"><div>ğŸ‘¨â€ğŸ« çŒå¤´å¯»è®¿ç³»ç»Ÿ (40ä½é¡¶çº§åå¸ˆ/è§£é”æˆ˜æŠ€)</div><button class="fs-close" onclick="closeModal('modal-experts')">Ã—</button></div>
        <div class="fs-body">
            <div style="text-align:center; margin-bottom:20px;">
                <button class="btn-main" style="width:auto; padding:15px 40px; font-size:1.5rem;" onclick="gachaExpert()">ğŸ² æ”¯ä»˜ ï¿¥50ä¸‡ å¯»è®¿ä¸“å®¶</button>
                <p style="color:#ef4444; font-size:0.9rem; font-weight:bold;">âš ï¸ æ³¨æ„ï¼šè¶Šå¼ºåŠ›çš„ä¸“å®¶ï¼Œæ¯æœˆçš„è–ªèµ„ç»´æŠ¤è´¹è¶Šé«˜ï¼å°å¿ƒç ´äº§ï¼</p>
            </div>
            <div class="grid-sys" id="expert-container"></div>
        </div>
    </div>
</div>

<div id="modal-branches" class="fs-modal">
    <div class="fs-content" style="max-width:800px;">
        <div class="fs-header"><div>ğŸŒ å…¨çƒåˆ†æ ¡ç½‘ç»œ (æä¾›è¢«åŠ¨åŠ æˆä¸æˆ˜æ–—å±æ€§)</div><button class="fs-close" onclick="closeModal('modal-branches')">Ã—</button></div>
        <div class="fs-body">
            <p style="color:#64748b; margin-bottom:20px;">å»ºç«‹åˆ†æ ¡éœ€è¦å·¨é¢èµ„é‡‘ï¼Œä½†èƒ½æä¾›å¼ºå¤§çš„è¢«åŠ¨å…‰ç¯ï¼Œå¹¶åœ¨è”è€ƒæˆ˜äº‰ä¸­ä¸ºæ‚¨æä¾›é¢å¤–çš„å±æ€§åŠ æˆã€‚</p>
            <div id="branch-container" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"></div>
        </div>
    </div>
</div>

<div id="modal-schedule" class="fs-modal">
    <div class="fs-content" style="max-width: 600px; height:auto;">
        <div class="fs-header"><div>ğŸ“… å¸ˆèµ„è°ƒåº¦ä¸è¯¾è¡¨åˆ¶å®š</div><button class="fs-close" onclick="closeModal('modal-schedule')">Ã—</button></div>
        <div class="fs-body">
            <div style="background:#fee2e2; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.85rem; color:#991b1b; border:1px solid #fca5a5;" id="sch-warn-box"><b>âš ï¸ å±é™©è­¦å‘Šï¼š</b>ä¸»ç§‘æ’è¯¾æ•°è‹¥è¶…è¿‡ <b>25èŠ‚</b>ï¼Œäº§ç”Ÿçš„æ€ç»´ç†µå¢å°†å‘ˆ<b>æŒ‡æ•°çº§çˆ†ç‚¸</b>ï¼</div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn" onclick="upgradeTeacher('main')" style="flex:1">ä¸»ç§‘ç»„å‡çº§<br><span id="tch-main" style="color:var(--primary); font-size:1.1rem;">å®ä¹ </span></button>
                <button class="btn" onclick="upgradeTeacher('minor')" style="flex:1">å‰¯ç§‘ç»„å‡çº§<br><span id="tch-minor" style="color:var(--primary); font-size:1.1rem;">å®ä¹ </span></button>
                <button class="btn" onclick="upgradeTeacher('spec')" style="flex:1">ç´ è´¨ç»„å‡çº§<br><span id="tch-spec" style="color:var(--primary); font-size:1.1rem;">å®ä¹ </span></button>
            </div>
            <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; display:flex; flex-direction:column; gap:15px;">
                <div><b>ğŸ“š ä¸»ç§‘è¯¾æ—¶ (é«˜å‹/é«˜æ”»)</b> <span id="lbl-main-hr" style="color:var(--danger); font-weight:bold;">20èŠ‚</span><input type="range" id="range-main" min="0" max="40" value="20" oninput="adjustSchedule('main')" style="width:100%"></div>
                <div><b>ğŸ”¬ å‰¯ç§‘è¯¾æ—¶ (ä¸­å‹/é˜²å®ˆ)</b> <span id="lbl-minor-hr" style="color:var(--primary); font-weight:bold;">15èŠ‚</span><input type="range" id="range-minor" min="0" max="40" value="15" oninput="adjustSchedule('minor')" style="width:100%"></div>
                <div><b>ğŸ¨ ç´ è´¨è¯¾æ—¶ (é™å‹/æš´å‡»)</b> <span id="lbl-spec-hr" style="color:var(--success); font-weight:bold;">5èŠ‚</span><input type="range" id="range-spec" min="0" max="40" value="5" oninput="adjustSchedule('spec')" style="width:100%"></div>
                <div style="text-align:right; font-size:0.9rem; font-weight:bold;">å½“å‰å‘¨è¯¾æ—¶æ€»é‡: <span id="sch-total-hr" style="color:var(--primary)">40</span>/60</div>
            </div>
        </div>
    </div>
</div>

<div id="modal-policy" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>ğŸ« å›½å®¶æ ¡ç­–ç§‘æŠ€æ ‘ (å››å¤§æµæ´¾ 40é¡¹èŠ‚ç‚¹)</div><button class="fs-close" onclick="closeModal('modal-policy')">Ã—</button></div>
        <div class="fs-body">
            <div style="text-align:center; margin-bottom:20px; font-weight:bold;">
                <span style="color:var(--danger); margin-right:15px;">ğŸŸ¥ æé™åº”è¯•çº¿</span>
                <span style="color:var(--warning); margin-right:15px;">ğŸŸ¨ é“è…•çºªå¾‹çº¿</span>
                <span style="color:#fbbf24; margin-right:15px;">ğŸŸ¤ èµ„æœ¬è¿ä½œçº¿</span>
                <span style="color:var(--success);">ğŸŸ© ç´ è´¨å¼€æ”¾çº¿</span>
            </div>
            <div id="policy-container" style="display:flex; flex-direction:column; align-items:center;"></div>
        </div>
    </div>
</div>

<div id="modal-achieve" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>ğŸ† è£èª‰å²å†Œä¸æ°å‡ºæ ¡å‹</div><button class="fs-close" onclick="closeModal('modal-achieve')">Ã—</button></div>
        <div class="fs-body">
            <h3 style="margin-top:0; border-bottom:2px solid #cbd5e1; padding-bottom:5px;">ğŸ“ çŸ¥åæ ¡å‹å½• (å­¦ç”Ÿæ¨¡å¼é€šå…³ç•™å)</h3>
            <div id="alumni-container" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:25px;"></div>
            <h3 style="border-bottom:2px solid #cbd5e1; padding-bottom:5px;">ğŸ† ç»ˆææˆå°± (25é¡¹)</h3>
            <div class="grid-sys" id="achieve-container"></div>
        </div>
    </div>
</div>

<!-- ================= å²è¯—çº§å­¦æœ¯æˆ˜äº‰ PVE UI ================= -->
<div id="modal-battle" class="fs-modal" style="background: rgba(0,0,0,0.95); z-index: 6000;">
    <div class="fs-content" style="max-width: 1000px; background: transparent; box-shadow: none; border: 1px solid #3f6212; height:auto;">
        <div class="battle-ui" id="b-main" style="display:none;">
            <div class="b-header">
                <div>[ACADEMIC_WARFARE_OS_v2.0]</div>
                <div style="color:#bef264">>>> ROUND: <span id="b-turn-ui">1</span> / <span id="b-phase-ui" style="color:#fde047">NORMAL_PHASE</span> <<<</div>
            </div>
            
            <div class="b-arena">
                <div class="b-weather" id="b-weather-ui">â›… å¤©æ°”ï¼šæ™´æœ—</div>
                <!-- ç©å®¶é˜µè¥ -->
                <div class="b-entity" id="b-player-card">
                    <div class="b-name" style="color:#93c5fd">> ç©å®¶æœ¬æ ¡é˜µè¥_</div>
                    <div class="b-hp-bg"><div class="b-hp-fill" id="bp-hp-bar"></div><div class="b-hp-txt" id="bp-hp-txt">100 / 100</div></div>
                    <div class="b-stat-grid">
                        <div>æ€ç»´å¼ºåº¦: <span id="bp-atk" style="color:#fff">0</span></div>
                        <div>é€»è¾‘ä¸¥å¯†: <span id="bp-def" style="color:#fff">0</span></div>
                        <div>çµæ„Ÿè¿¸å‘: <span id="bp-crit" style="color:#fde047">0</span>%</div>
                        <div>å­¦æœ¯AP: <span id="bp-ap" style="color:#fbbf24">0</span></div>
                    </div>
                    <div style="margin-top:5px; font-size:0.7rem;">æ€ç»´ç†µå¢: <span id="bp-stress" style="color:#f59e0b">20</span> / 100 <span style="color:#64748b;font-size:0.65rem;">(â‰¥70æ··ä¹±Â·â‰¥100å´©æºƒ)</span></div>
                    <div class="b-stress-bar"><div class="b-stress-fill" id="bp-stress-bar"></div></div>
                    <div class="b-buffs" id="bp-buffs">BUFFS: NONE</div>
                </div>

                <div style="font-size:3rem; font-weight:900; color:#ef4444; font-family:monospace;">VS</div>

                <!-- æ•Œæ–¹AIé˜µè¥ -->
                <div class="b-entity" id="b-enemy-card">
                    <div class="b-name" style="color:#fca5a5" id="be-name">> æ•Œæ–¹ç›®æ ‡_</div>
                    <div class="b-hp-bg" style="border-color:#fca5a5"><div class="b-hp-fill" id="be-hp-bar" style="background:#dc2626"></div><div class="b-hp-txt" id="be-hp-txt">100 / 100</div></div>
                    <div class="b-stat-grid" style="color:#fca5a5">
                        <div>æ€ç»´å¼ºåº¦: <span id="be-atk" style="color:#fff">0</span></div>
                        <div>é€»è¾‘ä¸¥å¯†: <span id="be-def" style="color:#fff">0</span></div>
                        <div style="grid-column:1/-1; border-top:1px dashed #fca5a5; padding-top:4px; margin-top:2px;">
                            <b style="color:#fde047">BOSSç‰¹æ€§:</b> <span id="be-skill-desc" style="color:#fff">æœªçŸ¥</span>
                        </div>
                    </div>
                    <div style="margin-top:5px; font-size:0.7rem; color:#fca5a5">æ€ç»´ç†µå¢: <span id="be-stress">0</span> / 100</div>
                    <div class="b-stress-bar" style="border-color:#fca5a5"><div class="b-stress-fill" id="be-stress-bar" style="background:#991b1b"></div></div>
                    <div class="b-buffs" id="be-buffs">BUFFS: NONE</div>
                </div>
            </div>

            <!-- æˆ˜æ–—æ’­æŠ¥ç»ˆç«¯ (é«˜åº¦è‡ªé€‚åº”) -->
            <div class="b-log" id="b-log">
                <div class="b-log-inner">
                    <span class="sys">SYSTEM BOOT... ACADEMIC INTERFACE ENGAGED.</span><br>
                    <span class="sys">WAITING FOR EXAM TO START...</span>
                </div>
            </div>

            <div class="b-expert-select" id="b-expert-list"></div>

            <!-- æ“ä½œå° (å›ºå®šåº•éƒ¨) -->
            <div class="b-actions" id="b-action-panel">
                <div class="b-cats">
                    <button class="b-cat-btn" id="cat-atk" onclick="bShowCat('atk')">[1] å‡ºé¢˜æ”»å‡»ç³»</button>
                    <button class="b-cat-btn" id="cat-def" onclick="bShowCat('def')">[2] è§£é¢˜é˜²å®ˆç³»</button>
                    <button class="b-cat-btn" id="cat-sup" onclick="bShowCat('sup')">[3] å­¦æœ¯ç ”è®¨ç³»</button>
                    <button class="b-cat-btn" id="cat-psy" onclick="bShowCat('psy')">[4] å¿ƒç†å¹²æ‰°ç³»</button>
                    <button class="b-cat-btn" id="cat-insp" onclick="bShowCat('insp')">[5] çµæ„Ÿçˆ†å‘ç³»</button>
                    <button class="b-cat-btn" id="cat-sys" onclick="bShowCat('sys')">[6] ä½“ç³»å¿…æ€ç³»</button>
                    <button class="b-cat-btn" style="color:#94a3b8; border-color:#475569;" onclick="bRetreat()">[ESC] ç»“æŸæˆ˜æ–—</button>
                </div>
                <div class="b-skills" id="b-skills-container">
                    <div style="color:#64748b; margin-top:20px; font-size:0.9rem;">PLEASE SELECT A DISCIPLINE MODULE FROM THE LEFT MENU...</div>
                </div>
            </div>
        </div>
        
        <!-- æˆ˜å‰é€‰å¯¹æ‰‹ç•Œé¢ -->
        <div id="b-prep" style="background:#1e293b; padding:30px; border-radius:12px; display:none; color:#f8fafc; border: 2px solid #334155; height:80vh; overflow-y:auto;">
            <h2 style="text-align:center; margin-top:0; color:#fde047;">> å…¨çœå¤§å‹è”è€ƒç›®æ ‡é€‰æ‹© _</h2>
            <p style="text-align:center; color:#94a3b8; margin-bottom:25px;">è¯·é€‰æ‹©ä½ è¦è®¨ä¼çš„é¡¶çº§åæ ¡ï¼Œèƒœåˆ©å°†è·å¾—å·¨é¢æ ¡çº§ç§¯åˆ†ã€‚</p>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px;">Tier 1: ä¹¡é•‡ä¸å¿çº§ (å…¥é—¨)</h3>
            <div class="grid-sys" id="b-rival-t1"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 2: å¸‚çº§ç¤ºèŒƒ (è¿›é˜¶)</h3>
            <div class="grid-sys" id="b-rival-t2"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 3: çœçº§åæ ¡ (å›°éš¾)</h3>
            <div class="grid-sys" id="b-rival-t3"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 4: å…¨å›½ç™¾å¼º (å™©æ¢¦)</h3>
            <div class="grid-sys" id="b-rival-t4"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 5: ä¼ è¯´çº§ç¥åŸŸ (åœ°ç‹±)</h3>
            <div class="grid-sys" id="b-rival-t5"></div>
            
            <div style="text-align:center; margin-top:30px; margin-bottom:50px;">
                <button class="btn-main" style="background:#475569; width:auto; padding:10px 40px;" onclick="closeModal('modal-battle')">ABORT MISSION (æ’¤é€€æ— æƒ©ç½š)</button>
            </div>
        </div>
    </div>
</div>

<!-- é€šç”¨å¼¹çª— -->
<div id="modal-overlay">
    <div class="modal-content">
        <h2 id="modal-title" style="margin-top:0; color:#1e293b;">æ ‡é¢˜</h2>
        <div id="modal-desc" style="line-height:1.6; margin-bottom:25px; font-size:1rem; color:#475569; text-align:left;">å†…å®¹</div>
        <div id="modal-buttons" style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px;"></div>
    </div>
</div>

<script>
    // ================= åŸºç¡€å­—å…¸æ•°æ® =================
    const DIFF_MODS = { 0: { name: "ç®€å•", startFund: 500, stressMult: 0.4, costMult: 0.6 }, 1: { name: "æ­£å¸¸", startFund: 100, stressMult: 0.7, costMult: 1.0 }, 2: { name: "å›°éš¾", startFund: 50,  stressMult: 1.2, costMult: 1.5 } };
    const SCHOOL_LEVELS = [ 
        { name: "ä¹¡é•‡ä¸­å­¦", baseStu: 300, reqRep: 0, reqFunds: 0, reqGrade: 0, reqExam: 0, upkeep: 8, tuition: 0.15 }, 
        { name: "å¿çº§é‡ç‚¹", baseStu: 1000, reqRep: 300, reqFunds: 100, reqGrade: 45, reqExam: 50, upkeep: 25, tuition: 0.25 }, 
        { name: "å¸‚çº§ç¤ºèŒƒ", baseStu: 2500, reqRep: 1000, reqFunds: 400, reqGrade: 60, reqExam: 150, upkeep: 60, tuition: 0.4 }, 
        { name: "çœçº§åæ ¡", baseStu: 5000, reqRep: 4000, reqFunds: 1500, reqGrade: 80, reqExam: 400, upkeep: 150, tuition: 0.7 }, 
        { name: "å…¨å›½é¡¶å°–", baseStu: 10000, reqRep: 10000, reqFunds: 5000, reqGrade: 92, reqExam: 1000, upkeep: 350, tuition: 1.5 } 
    ];
    const TEACHER_TIERS = [ { name: "å®ä¹ ç”Ÿ", multi: 0.8, upCost: 0, salary: 4 }, { name: "å¸‚éª¨å¹²", multi: 1.2, upCost: 40, salary: 12 }, { name: "ç‰¹çº§åå¸ˆ", multi: 1.8, upCost: 120, salary: 35 } ];
    const FAMILIES = [ {id:'worker', name:"å·¥è–ªé˜¶å±‚", desc:"å®¶å¢ƒæ™®é€šï¼Œä½†çˆ¶æ¯åƒè‹¦è€åŠ³ã€‚å¼€å±€èµ„é‡‘å°‘ï¼ŒæŠ—å‹å¼ºã€‚", money: 200}, {id:'intel', name:"ä¹¦é¦™é—¨ç¬¬", desc:"çˆ¶æ¯æ˜¯æ•™å¸ˆæˆ–å…¬åŠ¡å‘˜ã€‚å¼€å±€å­¦ä¸šä¸è‰ºæœ¯å±æ€§è¾ƒé«˜ã€‚", money: 500}, {id:'business', name:"ç»å•†ä¸–å®¶", desc:"å®¶é‡Œæœ‰çŸ¿ã€‚å¼€å±€èµ„é‡‘å……è£•ï¼Œä½†çˆ¶æ¯å¿™ç”Ÿæ„ï¼Œäº²æƒ…æ·¡æ¼ ã€‚", money: 2000} ];

    const FACILITIES = { 
        'confucius': { icon: 'ğŸ—¿', levels: [{name:'å­”å­åœ£åƒ',cost:20,desc:'çºªå¾‹+1,å£°èª‰+3/æœˆ'}, {name:'ç™¾å®¶é›•å¡‘ç¾¤',cost:60,desc:'çºªå¾‹+3,å£°èª‰+10/æœˆ'}, {name:'å„’å­¦æœåœ£æ®¿',cost:200,desc:'çºªå¾‹+8,è§£é”ç‰¹æŠ€ã€å­”å­åœ£å…‰ã€‘'}] }, 
        'media': { icon: 'ğŸ¢', levels: [{name:'ç”µæ•™å¤§æ¥¼',cost:40,desc:'å­¦ä¸šå€ç‡æå‡'}, {name:'æ™ºæ…§æ ¡å›­ç½‘',cost:100,desc:'å­¦ä¸šå€ç‡å¤§å¹…æå‡'}, {name:'é‡å­è¶…ç®—ä¸­å¿ƒ',cost:300,desc:'å­¦ä¸šæé€Ÿç‹‚é£™'}] }, 
        'track': { icon: 'ğŸƒ', levels: [{name:'å¡‘èƒ¶æ“åœº',cost:30,desc:'ä½“è´¨+1.5,å‡å‹'}, {name:'å®¤å†…ä½“è‚²é¦†',cost:80,desc:'ä½“è´¨+4,å¤§å¹…å‡å‹'}, {name:'å¥¥æ—åŒ¹å…‹ä¸­å¿ƒ',cost:250,desc:'ä½“è´¨æ°¸ä¸æ‰è½'}] }, 
        'library': { icon: 'ğŸ“š', levels: [{name:'å›¾ä¹¦é¦†',cost:50,desc:'æ¯æœˆå­¦ä¸šåŸºç¡€+1'}, {name:'æ•°å­—åŒ–ä¹¦åŸ',cost:120,desc:'æ¯æœˆå­¦ä¸š+3'}, {name:'å›½å®¶çº§æ–‡çŒ®åº“',cost:400,desc:'æ¯æœˆå­¦ä¸š+8,é«˜æ•™ç ”ç‚¹'}] }, 
        'clinic': { icon: 'ğŸ›‹ï¸', levels: [{name:'å¿ƒç†è¯Šæ‰€',cost:45,desc:'å¾®å¼±å¯¹å†²ä¸»ç§‘é«˜å‹'}, {name:'ç²¾ç¥åº·å¤ä¸­å¿ƒ',cost:150,desc:'å¤§å¹…æ¶ˆé™¤å…¨æ ¡å‹åŠ›'}, {name:'è„‘ç§‘å­¦ç ”ç©¶æ‰€',cost:500,desc:'é«˜å‹ä¸å†äº§ç”Ÿè´Ÿé¢æ•ˆæœ'}] }, 
        'art': { icon: 'ğŸ¨', levels: [{name:'è‰ºæœ¯ä¸­å¿ƒ',cost:60,desc:'ç´ è´¨æå‡'}, {name:'çš‡å®¶å¤§å‰§é™¢',cost:180,desc:'è‰ºæœ¯æ¶µå…»æš´å¢'}, {name:'å›½é™…è‰ºæœ¯å±•é¦†',cost:600,desc:'è‰ºæœ¯æ‹‰æ»¡,å£°èª‰æé«˜'}] }, 
        'lab': { icon: 'ğŸ”¬', levels: [{name:'å®éªŒå¤§æ¥¼',cost:80,desc:'è”è€ƒé¢å¤–æ•™ç ”ç‚¹'}, {name:'å›½å®¶é‡ç‚¹å®éªŒå®¤',cost:250,desc:'æ•™ç ”ç‚¹è·å–ç¿»å€'}, {name:'è¯ºå¥–å­µåŒ–åŸºåœ°',cost:800,desc:'æ•™ç ”ç‚¹æ— é™æº¢å‡º'}] }, 
        'dorm': { icon: 'ğŸ¨', levels: [{name:'è´µæ—å…¬å¯“',cost:100,desc:'è¢«åŠ¨å¸é‡‘'}, {name:'é¡¶å¥¢å…¨æ™¯å¥—æˆ¿',cost:300,desc:'å¸é‡‘èƒ½åŠ›ç¿»å€'}, {name:'ä¼´è¯»ç‹¬æ ‹åˆ«å¢…åŒº',cost:1000,desc:'å¸é‡‘ææ€–,ä½†é™çºªå¾‹'}] }, 
        'hospital': { icon: 'ğŸ¥', levels: [{name:'æ ¡åŒ»é™¢',cost:40,desc:'é˜²ç”Ÿç—…åœè¯¾'}, {name:'ä¸‰ç”²é™„å±åŒ»é™¢',cost:200,desc:'ä½“è´¨é£™å‡,å…ç–«ç–«ç—…'}, {name:'ç”Ÿå‘½ç§‘å­¦ä¸­å¿ƒ',cost:600,desc:'å…¨å‘˜æ»¡è¡€çŠ¶æ€'}] }, 
        'hall': { icon: 'ğŸ›ï¸', levels: [{name:'å¤§ç¤¼å ‚',cost:150,desc:'APä¸Šé™+5'}, {name:'å›½é™…ä¼šè®®ä¸­å¿ƒ',cost:400,desc:'APä¸Šé™+15'}, {name:'è”åˆå›½ä¼šåœº',cost:1500,desc:'APæ— ç©·å°½'}] } 
    };

    const BRANCHES_DB = [
        { id: 'b_hengshui', name: "è¡¡æ°´åˆ†æ ¡", cost: 2000, desc: "å…¨å‘˜æ”»å‡»åŠ›+15%ï¼Œå‹åŠ›ä¸Šé™+20ã€‚æ¯æœˆå£°èª‰+20ã€‚", buff: {atk:1.15, maxHp:1.2} },
        { id: 'b_beijing', name: "åŒ—äº¬åˆ†æ ¡", cost: 3000, desc: "å…¨å‘˜é˜²å¾¡åŠ›+20%ï¼ŒAPä¸Šé™+5ã€‚æ¯æœˆèµ„é‡‘+100ã€‚", buff: {def:1.2, ap:5} },
        { id: 'b_shanghai', name: "é­”éƒ½å›½é™…éƒ¨", cost: 4000, desc: "å…¨å‘˜æš´å‡»ç‡+10%ï¼ŒAPæ¶ˆè€—å‡å°‘ã€‚æ¯æœˆå£°èª‰+50ã€‚", buff: {crit:10, apRed:1} },
        { id: 'b_harvard', name: "å“ˆä½›é¢„ç§‘è¥", cost: 10000, desc: "å…¨å±æ€§+20%ï¼Œè§£é”éšè—æŠ€èƒ½ã€‚æ¯æœˆèµ„é‡‘+500ã€‚", buff: {all:1.2} },
        { id: 'b_oxford', name: "ç‰›æ´¥ä¹¦é™¢", cost: 8000, desc: "é˜²å¾¡åŠ›+30%ï¼Œå…ç–«æ™•çœ©ã€‚æ¯æœˆæ•™ç ”ç‚¹+50ã€‚", buff: {def:1.3, immune:true} },
        { id: 'b_huanggang', name: "é»„å†ˆå¯†å·å‚", cost: 2500, desc: "æ”»å‡»åŠ›+25%ï¼Œæ¯å›åˆè‡ªä¼¤ã€‚æ¯æœˆå­¦ä¸š+5ã€‚", buff: {atk:1.25, selfDmg:true} }
    ];

    const EXPERT_POOL = [
        { id: 'e1', name: "é€€å½¹é­”é¬¼æ•™å®˜", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: ä½¿æ•Œæ–¹å‹åŠ›+2ã€‚", battle: (p,e)=>{ e.stress+=2; return "æ•Œæ–¹å‹åŠ›+2"; } },
        { id: 'e2', name: "æŠ é—¨è€å‡ºçº³", rarity: 'R', upkeep: 2, desc: "è¢«åŠ¨: é™ä½15%å­¦æ ¡å¸¸è€—ã€‚", battle: null },
        { id: 'e3', name: "å‡¶æ‚å®¿ç®¡å¤§å¦ˆ", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: å·±æ–¹é˜²å¾¡+5%ã€‚", battle: (p,e)=>{ p.buffs.defUp=2; return "é˜²å¾¡å¢å¼º2å›åˆ"; } },
        { id: 'e4', name: "æ–°ä¸œæ–¹å¤§å¨", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: å›å¤2%HPã€‚", battle: (p,e)=>{ p.hp+=p.maxHp*0.02; return "å›å¤å°‘é‡HP"; } },
        { id: 'e5', name: "é“å£é—¨å«å¤§çˆ·", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: å·±æ–¹å‡ä¼¤æŠ¤ç›¾ã€‚", battle: (p,e)=>{ p.buffs.shield=1; return "æŠ¤ç›¾è¦†ç›–"; } },
        { id: 'e6', name: "å®ä¹ å¿ƒç†åŒ»ç”Ÿ", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: å‡å‹3ç‚¹ã€‚", battle: (p,e)=>{ p.stress=Math.max(0,p.stress-3); return "å‹åŠ›-3"; } },
        { id: 'e7', name: "é€€ä¼‘è€ç‰¹çº§", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: æ”»å‡»åŠ›+5%ã€‚", battle: (p,e)=>{ p.buffs.atkUp=2; return "æ”»å‡»æå‡2å›åˆ"; } },
        { id: 'e8', name: "é¸¡è¡€å®£ä¼ å¹²äº‹", rarity: 'R', upkeep: 2, desc: "æˆ˜æ–—: æ¸…é™¤è´Ÿé¢BUFFã€‚", battle: (p,e)=>{ p.buffs.atkDown=0; p.buffs.defDown=0; p.buffs.dot=0; return "å‡€åŒ–è´Ÿé¢"; } },
        { id: 'e9', name: "æµ·å½’é’å¹´å­¦è€…", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: æš´å‡»ç‡+5%ã€‚", battle: (p,e)=>{ p.buffs.critUp=3; return "æš´å‡»æå‡3å›åˆ"; } },
        { id: 'e10', name: "æƒå¨å¿ƒç†å­¦æ•™æˆ", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: æ•Œæ–¹æ”»å‡»-10%ã€‚", battle: (p,e)=>{ e.buffs.atkDown=2; return "æ•Œæ”»ä¸‹é™2å›åˆ"; } },
        { id: 'e11', name: "å›½å®¶çº§é‡‘ç‰Œæ•™ç»ƒ", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: æ”»å‡»åŠ›æš´å¢ã€‚", battle: (p,e)=>{ p.buffs.atkUp=3; return "æ”»å‡»å¤§å¹…æå‡3å›åˆ"; } },
        { id: 'e12', name: "æŠ–éŸ³ç½‘çº¢åå¸ˆ", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: æ¦‚ç‡ä½¿æ•Œæ–¹æ™•çœ©ã€‚", battle: (p,e)=>{ if(Math.random()<0.3){e.buffs.stun=1; return "æ•Œæ–¹æ™•çœ©!";} return "æœªå‘½ä¸­"; } },
        { id: 'e13', name: "é“è…•çº§éƒ¨ä¸»ä»»", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: å¼ºåŠ›æŠ¤ç”²ã€‚", battle: (p,e)=>{ p.buffs.defUp=3; return "é˜²å¾¡å¤§å¹…å¢å¼º3å›åˆ"; } },
        { id: 'e14', name: "é€€å½¹å¥¥è¿å¥å°†", rarity: 'SR', upkeep: 10, desc: "è¢«åŠ¨: HPä¸Šé™æå¤§å¹…æå‡", battle: null },
        { id: 'e15', name: "è½é­„è‰ºæœ¯å¤§å¸ˆ", rarity: 'SR', upkeep: 10, desc: "æˆ˜æ–—: å¿…æš´çŠ¶æ€ã€‚", battle: (p,e)=>{ p.buffs.dmgUp=1; return "ä¸‹ä¸€æ¬¡æ”»å‡»å¿…å®šæš´å‡»ä¸”ä¼¤å®³æå‡"; } },
        { id: 'e16', name: "å…¨å›½å‘½é¢˜ç»„ç»„é•¿", rarity: 'SSR', upkeep: 50, desc: "æˆ˜æ–—: è‡´å‘½å¼±ç‚¹ã€‚", battle: (p,e)=>{ e.buffs.defDown=3; return "æ•Œæ–¹é˜²å¾¡å´©æºƒ3å›åˆ"; } },
        { id: 'e17', name: "åƒäº¿å•†ä¸šå·¨å­", rarity: 'SSR', upkeep: 50, desc: "æˆ˜æ–—: å›å¤3APã€‚", battle: (p,e)=>{ p.ap+=3; return "AP+3"; } },
        { id: 'e18', name: "è¯ºå¥–åè£”å¾—ä¸»", rarity: 'SSR', upkeep: 50, desc: "æˆ˜æ–—: å…¨å‘˜æŒç»­å›å¤ã€‚", battle: (p,e)=>{ p.buffs.hot=3; return "ç¾¤ä½“å›è¡€çŠ¶æ€3å›åˆ"; } },
        { id: 'e19', name: "æ•™è‚²å…ç‰¹æ´¾å‘˜", rarity: 'SSR', upkeep: 50, desc: "æˆ˜æ–—: å°å°æ•Œæ–¹ä¸€å›åˆã€‚", battle: (p,e)=>{ e.buffs.stun=1; e.buffs.atkDown=2; return "æ•Œæ–¹éœ‡æ…‘æ™•çœ©ï¼"; } },
        { id: 'e20', name: "å­”å­è½¬ä¸–æœ¬å°Š", rarity: 'SSR', upkeep: 150, desc: "æˆ˜æ–—: ç¥ä½‘å¤è‹ã€‚", battle: (p,e)=>{ p.hp=p.maxHp; p.stress=0; return "ç¥ä½‘å¤è‹ï¼Œæ»¡è¡€å¤æ´»"; } },
    ];

    // å…¨æ–°æ‹“å±•æŠ€èƒ½åº“ (34ä¸ªæŠ€èƒ½)
    const SKILL_DB = {
        // --- æ”»å‡»ç³» (ATK) ---
        'atk_0': { cat: 'atk', name: 'å¹³Aå‡ºé¢˜', desc: 'æ— æ¶ˆè€—ã€‚é€ æˆ100%ä¼¤å®³ã€‚', ap: 0, reqDesc: 'æ— ', req: ()=>true },
        'atk_1': { cat: 'atk', name: 'éšå ‚æµ‹éªŒ', desc: 'AP:5ã€‚é€ æˆ120%ä¼¤å®³ã€‚', ap: 5, reqDesc: 'æ— ', req: ()=>true },
        'atk_2': { cat: 'atk', name: 'åˆ·é¢˜æœºå™¨', desc: 'AP:3ã€‚é€ æˆ80%ä¼¤å®³ï¼Œå›å¤2%HPã€‚', ap: 3, reqDesc: 'æ— ', req: ()=>true },
        'atk_3': { cat: 'atk', name: 'æœˆè€ƒè½°ç‚¸', desc: 'AP:15ã€‚é€ æˆ150%ä¼¤å®³ï¼Œæ•Œæ–¹å‹åŠ›+5ã€‚', ap: 15, reqDesc: 'æ— ', req: ()=>true },
        'atk_4': { cat: 'atk', name: 'é¢˜æµ·æ·¹æ²¡', desc: 'AP:25ã€‚é€ æˆ3æ®µ60%ä¼¤å®³ã€‚', ap: 25, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.main>=1 },
        'atk_5': { cat: 'atk', name: 'å‡½æ•°å‹è½´é¢˜', desc: 'AP:35ã€‚é€ æˆ250%ç‰©ç†ä¼¤å®³ã€‚', ap: 35, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.main>=1 },
        'atk_6': { cat: 'atk', name: 'è‹±è¯­å¬åŠ›', desc: 'AP:18ã€‚é€ æˆ110%ä¼¤å®³ï¼Œæ–½åŠ æ˜“ä¼¤ã€‚', ap: 18, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.main>=1 },
        'atk_7': { cat: 'atk', name: 'åŒ–å­¦æ–¹ç¨‹å¼', desc: 'AP:30ã€‚é€ æˆ180%ä¼¤å®³ï¼Œæ–½åŠ æŒç»­æ¯’ç´ ä¼¤å®³3å›åˆã€‚', ap: 30, reqDesc: 'å‰¯ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.minor>=1 },
        'atk_8': { cat: 'atk', name: 'ç‰©ç†åŠ›å­¦', desc: 'AP:45ã€‚é€ æˆ350%ä¼¤å®³ï¼Œè‡ªèº«æ™•çœ©1å›åˆã€‚', ap: 45, reqDesc: 'å‰¯ç§‘è¾¾åˆ°[ç‰¹çº§åå¸ˆ]', req: ()=>game.teachers.minor>=2 },
        'atk_9': { cat: 'atk', name: 'ç”Ÿç‰©é—ä¼ å›¾', desc: 'AP:22ã€‚é€ æˆ140%ä¼¤å®³ï¼Œæ•Œæ”»ä¸‹é™ã€‚', ap: 22, reqDesc: 'å‰¯ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.minor>=1 },
        'atk_10': { cat: 'atk', name: 'æ”¿æ²»è¾¨æ', desc: 'AP:40ã€‚é€ æˆ300%ç²¾ç¥ä¼¤å®³ï¼Œæ— è§†éƒ¨åˆ†é˜²å¾¡ã€‚', ap: 40, reqDesc: 'ç´ è´¨è¾¾åˆ°[ç‰¹çº§åå¸ˆ]', req: ()=>game.teachers.spec>=2 },
        'atk_11': { cat: 'atk', name: 'è‹±è¯­ä½œæ–‡èƒŒè¯µ', desc: 'AP:15ã€‚é€ æˆ120%ä¼¤å®³ï¼Œå›å¤å°‘é‡APã€‚', ap: 15, reqDesc: 'æ— ', req: ()=>true },
        'atk_12': { cat: 'atk', name: 'å®Œå½¢å¡«ç©ºè¿æ–©', desc: 'AP:20ã€‚é€ æˆ4æ®µ40%çš„è¿ç»­ä¼¤å®³ã€‚', ap: 20, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.main>=1 },
        'atk_13': { cat: 'atk', name: 'ç«‹ä½“å‡ ä½•åŸæœ¬', desc: 'AP:28ã€‚é€ æˆ200%çœŸå®ä¼¤å®³ã€‚', ap: 28, reqDesc: 'æ— ', req: ()=>true },

        // --- é˜²å®ˆç³» (DEF) ---
        'def_0': { cat: 'def', name: 'æ•´ç†é”™é¢˜æœ¬', desc: 'AP:5ã€‚ä¸‹å›åˆé˜²å¾¡å¢å¼ºã€‚', ap: 5, reqDesc: 'æ— ', req: ()=>true },
        'def_1': { cat: 'def', name: 'æ ‡å‡†ç­”æ¡ˆ', desc: 'AP:10ã€‚å›å¤15% HPï¼Œæ¸…é™¤ä¸€ä¸ªè´Ÿé¢ã€‚', ap: 10, reqDesc: 'æ— ', req: ()=>true },
        'def_2': { cat: 'def', name: 'ä¸¤è€³ä¸é—»', desc: 'AP:8ã€‚é˜²å¾¡å¢å¼ºï¼Œå›å¤5APã€‚', ap: 8, reqDesc: 'æ— ', req: ()=>true },
        'def_3': { cat: 'def', name: 'è€ƒå‰åˆ’é‡ç‚¹', desc: 'AP:15ã€‚æ–½åŠ å‡ä¼¤æŠ¤ç›¾ã€‚', ap: 15, reqDesc: 'æ— ', req: ()=>true },
        'def_4': { cat: 'def', name: 'å¿ƒç†å»ºè®¾', desc: 'AP:12ã€‚è‡ªèº«å‹åŠ›-20ã€‚', ap: 12, reqDesc: 'æ— ', req: ()=>true },
        'def_5': { cat: 'def', name: 'é¢˜æµ·æŠ¤ç›¾', desc: 'AP:20ã€‚å·¨é¢æŠ¤ç›¾ï¼Œå…ç–«ä¸€æ¬¡ä¼¤å®³ã€‚', ap: 20, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.main>=1 },
        'def_6': { cat: 'def', name: 'åå¸ˆç‚¹æ‹¨', desc: 'AP:25ã€‚å›å¤30% HPï¼ŒæŒç»­å›è¡€2å›åˆã€‚', ap: 25, reqDesc: 'ç´ è´¨è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.spec>=1 },
        'def_7': { cat: 'def', name: 'ç»å¯¹é˜²å¾¡', desc: 'AP:40ã€‚è·å¾—æé™é—ªé¿çŠ¶æ€ã€‚', ap: 40, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[ç‰¹çº§åå¸ˆ]', req: ()=>game.teachers.main>=2 },
        'def_8': { cat: 'def', name: 'é€»è¾‘é—­ç¯', desc: 'AP:30ã€‚é˜²å®ˆåå‡»ï¼Œä¸‹å›åˆå¿…å®šæš´å‡»ã€‚', ap: 30, reqDesc: 'å‰¯ç§‘è¾¾åˆ°[ç‰¹çº§åå¸ˆ]', req: ()=>game.teachers.minor>=2 },
        'def_9': { cat: 'def', name: 'é—­ç›®å…»ç¥', desc: 'AP:10ã€‚å›å¤HPå¹¶æ¸…é™¤æ‰€æœ‰è´Ÿé¢çŠ¶æ€ã€‚', ap: 10, reqDesc: 'æ— ', req: ()=>true },

        // --- ç ”è®¨ç³» (SUP) ---
        'sup_0': { cat: 'sup', name: 'å°ç»„è®¨è®º', desc: 'AP:5ã€‚ç›´æ¥å›å¤10ç‚¹APã€‚', ap: 5, reqDesc: 'æ— ', req: ()=>true },
        'sup_1': { cat: 'sup', name: 'å…¨ç­ä¼ çº¸æ¡', desc: 'AP:10ã€‚å›è¡€å°‘è®¸ï¼ŒAP+5ã€‚', ap: 10, reqDesc: 'æ— ', req: ()=>true },
        'sup_2': { cat: 'sup', name: 'äº’å¸®äº’åŠ©', desc: 'AP:15ã€‚è‡ªèº«æ”»å‡»åŠ›æå‡3å›åˆã€‚', ap: 15, reqDesc: 'æ— ', req: ()=>true },
        'sup_3': { cat: 'sup', name: 'å¤´è„‘é£æš´', desc: 'AP:20ã€‚æš´å‡»ç‡æå¤§æå‡2å›åˆã€‚', ap: 20, reqDesc: 'ç´ è´¨è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.spec>=1 },
        'sup_4': { cat: 'sup', name: 'å­¦æœ¯æ²™é¾™', desc: 'AP:25ã€‚å…¨å‘˜æ»¡çŠ¶æ€æ¢å¤å¤§é‡HPä¸APã€‚', ap: 25, reqDesc: 'æ‹¥æœ‰ä¸“å®¶[è¯ºå¥–åè£”å¾—ä¸»]', req: ()=>hasExpert('e18') },
        'sup_5': { cat: 'sup', name: 'è€ƒç¥é™„ä½“', desc: 'AP:30ã€‚è·å¾—æ”»å‡»æå‡ã€é˜²å¾¡æå‡ã€æš´å‡»æå‡ç»¼åˆçŠ¶æ€ã€‚', ap: 30, reqDesc: 'æ— ', req: ()=>true },

        // --- å¿ƒç†ç³» (PSY) ---
        'psy_0': { cat: 'psy', name: 'æ­»äº¡å‡è§†', desc: 'AP:10ã€‚æ•Œæ–¹å‹åŠ›+15ã€‚', ap: 10, reqDesc: 'æ— ', req: ()=>true },
        'psy_1': { cat: 'psy', name: 'å‡¡å°”èµ›å‘è¨€', desc: 'AP:15ã€‚æ•Œæ–¹å‹åŠ›+25ï¼Œé™„å¸¦æ–½åŠ æ˜“ä¼¤ã€‚', ap: 15, reqDesc: 'æ— ', req: ()=>true },
        'psy_2': { cat: 'psy', name: 'æ’•æ¯è¯•å·', desc: 'AP:20ã€‚é™ä½æ•Œæ–¹æ”»å‡»åŠ›3å›åˆã€‚', ap: 20, reqDesc: 'æ— ', req: ()=>true },
        'psy_3': { cat: 'psy', name: 'æ’åå…¬å¸ƒ', desc: 'AP:30ã€‚é€ æˆæ•Œæ–¹å½“å‰HP 20%ä¼¤å®³ã€‚', ap: 30, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[å¸‚éª¨å¹²]', req: ()=>game.teachers.main>=1 },
        'psy_4': { cat: 'psy', name: 'å«å®¶é•¿', desc: 'AP:40ã€‚æ•Œæ–¹å¼ºè¡Œæ™•çœ©1å›åˆï¼Œå¤§ä¼¤å®³ã€‚', ap: 40, reqDesc: 'ä¸»ç§‘è¾¾åˆ°[ç‰¹çº§åå¸ˆ]', req: ()=>game.teachers.main>=2 },
        'psy_5': { cat: 'psy', name: 'å¹æ°”å¹²æ‰°', desc: 'AP:12ã€‚æ•Œæ–¹æ”»é˜²åŒé™2å›åˆã€‚', ap: 12, reqDesc: 'æ— ', req: ()=>true },

        // --- çµæ„Ÿç³» (INSP) ---
        'insp_0': { cat: 'insp', name: 'è’™ä¸€ä¸ª', desc: 'AP:5ã€‚50%å‡ ç‡300%ä¼¤ï¼Œ50% missã€‚', ap: 5, reqDesc: 'æ— ', req: ()=>true },
        'insp_1': { cat: 'insp', name: 'æŠ¼é¢˜å‘½ä¸­', desc: 'AP:30ã€‚30%å‡ ç‡é€ æˆ999ä¼¤å®³ã€‚', ap: 30, reqDesc: 'æ— ', req: ()=>true },
        'insp_2': { cat: 'insp', name: 'çµå…‰ä¹ç°', desc: 'AP:20ã€‚ä¸‹ä¸€æ¬¡æ”»å‡»å¿…å®šæš´å‡»ã€‚', ap: 20, reqDesc: 'è‰ºæœ¯å±æ€§>50', req: ()=>game.art>50 },
        'insp_3': { cat: 'insp', name: 'è‰ºæœ¯é€šæ„Ÿ', desc: 'AP:30ã€‚åŸºäºè‰ºæœ¯å±æ€§é€ æˆå·¨é¢ä¼¤å®³ã€‚', ap: 30, reqDesc: 'è‰ºæœ¯å±æ€§>70', req: ()=>game.art>70 },

        // --- ä½“ç³»ç³» (SYS) ---
        'sys_è¡¡æ°´': { cat: 'sys', name: 'è¡¡æ°´æ¨¡å¼', desc: 'AP:50ã€‚æ”»å‡»ç¿»å€ï¼Œè‡ªèº«æ‰£è¡€20%ã€‚', ap: 50, reqDesc: 'æ”¿ç­–[è¡¡æ°´é«˜è€ƒé›†ä¸­è¥]', req: ()=>hasPolicy('A8') },
        'sys_ç´ è´¨': { cat: 'sys', name: 'ç´ è´¨æ•™è‚²', desc: 'AP:50ã€‚å…¨å±æ€§æå‡ï¼ŒæŒç»­å›è¡€å‡å‹ã€‚', ap: 50, reqDesc: 'æ”¿ç­–[ç†æƒ³ä¹Œæ‰˜é‚¦æ ¡å›­]', req: ()=>hasPolicy('D8') },
        'sys_èµ„æœ¬': { cat: 'sys', name: 'é’èƒ½åŠ›', desc: 'AP:0ã€‚è€—50ä¸‡èµ„é‡‘ï¼Œç§’æ€9999ç‚¹ä¼¤å®³ã€‚', ap: 0, reqDesc: 'æ‹¥æœ‰ä¸“å®¶[åƒäº¿å•†ä¸šå·¨å­]', req: ()=>hasExpert('e17') }
    };

    // æ•Œæ–¹BOSSåº“ (åŠ å…¥BOSSç‰¹æ€§)
    const RIVALS = [
        { id: 't1_1', tier:1, name: "æ‘å£å¸Œæœ›ä¸­å­¦", hp: 4000, atk: 650, def: 60, pts: 5, traitName:"é‡è›®ç”Ÿé•¿", traitDesc:"æ¯å›åˆæ¢å¤å°‘é‡ç”Ÿå‘½ã€‚", traitEff:(p,e)=>{ e.hp=Math.min(e.maxHp, e.hp+Math.floor(e.maxHp*0.02)); return "æ•Œæ–¹æ¢å¤ç”Ÿå‘½å€¼"; } },
        { id: 't1_2', tier:1, name: "é•‡åŠç¬¬ä¸‰ä¸­å­¦", hp: 5500, atk: 750, def: 120, pts: 8, traitName:"é¡½å¼ºæŠµæŠ—", traitDesc:"ç”Ÿå‘½ä½äº50%æ—¶é˜²å¾¡ç¿»å€ã€‚", traitEff:(p,e)=>{ if(e.hp<e.maxHp*0.5){ e.buffs.defUp=1; return "é˜²å¾¡æ¿€å¢"; } return null; } },
        { id: 't1_3', tier:1, name: "å¿èŒä¸šä¸­ä¸“", hp: 7000, atk: 850, def: 150, pts: 10, traitName:"æµæ°“æ‰“æ³•", traitDesc:"æ”»å‡»æœ‰æ¦‚ç‡æ–½åŠ æ™•çœ©ã€‚", traitEff:(p,e)=>null },
        { id: 't2_1', tier:2, name: "å¿ç¬¬ä¸€ä¸­å­¦", hp: 10500, atk: 1000, def: 300, pts: 15, traitName:"é¢˜æµ·æˆ˜æœ¯", traitDesc:"æ¯å›åˆå›ºå®šå‰Šå‡æˆ‘æ–¹APã€‚", traitEff:(p,e)=>{ p.ap=Math.max(0,p.ap-2); return "å‰Šå‡ç©å®¶AP"; } },
        { id: 't2_2', tier:2, name: "å¸‚æ™®é€šé«˜ä¸­", hp: 13500, atk: 1150, def: 360, pts: 18, traitName:"ä¸­è§„ä¸­çŸ©", traitDesc:"å…ç–«æ‰€æœ‰å±æ€§ä¸‹é™Debuffã€‚", traitEff:(p,e)=>{ e.buffs.atkDown=0; e.buffs.defDown=0; return null; } },
        { id: 't2_3', tier:2, name: "ç§ç«‹è´µæ—å­¦æ ¡", hp: 15000, atk: 1300, def: 300, pts: 20, traitName:"é’èƒ½åŠ›åŠ æŒ", traitDesc:"å¼€åœºè‡ªå¸¦é«˜é¢æŠ¤ç›¾å¹¶æå‡æ”»å‡»ã€‚", traitEff:(p,e)=>{ if(bState.turn===1){ e.buffs.shield=2; e.buffs.atkUp=5; return "æ¿€æ´»é‡‘é’±æŠ¤ç›¾ä¸æ”»å‡»"; } return null; } },
        { id: 't3_1', tier:3, name: "å¸‚å®éªŒä¸­å­¦", hp: 24000, atk: 1600, def: 600, pts: 30, traitName:"å®éªŒåˆ›æ–°", traitDesc:"æ¯3å›åˆæ–½åŠ å‰§æ¯’åŒ–å­¦ä¼¤å®³ã€‚", traitEff:(p,e)=>{ if(bState.turn%3===0){ p.buffs.dot=2; return "é‡Šæ”¾åŒ–å­¦æ¯’ç´ "; } return null; } },
        { id: 't3_2', tier:3, name: "å¸‚å¤–å›½è¯­", hp: 27000, atk: 1750, def: 540, pts: 35, traitName:"å¬åŠ›æŠ˜ç£¨", traitDesc:"å¢åŠ ç©å®¶æ¯å›åˆçš„å‹åŠ›å¢é•¿ã€‚", traitEff:(p,e)=>{ p.stress+=3; return "å™ªéŸ³å¢åŠ å‹åŠ›"; } },
        { id: 't3_3', tier:3, name: "çœé™„å±åˆ†æ ¡", hp: 30000, atk: 1900, def: 750, pts: 40, traitName:"æœ¬éƒ¨æ”¯æ´", traitDesc:"åŠè¡€æ—¶å¬å”¤ä¸€æ¬¡å¼ºåŠ›æ‰“å‡»ã€‚", traitEff:(p,e)=>{ if(e.hp<e.maxHp*0.5 && !e.hasSummoned){ e.hasSummoned=true; p.hp-=2000; return "å¤©é™ç¥ç½šï¼"; } return null; } },
        { id: 't4_1', tier:4, name: "çœå®éªŒä¸­å­¦", hp: 45000, atk: 2500, def: 1200, pts: 50, traitName:"å…¨çœæ ‡æ†", traitDesc:"æ”»å‡»åŠ›éšå›åˆæ•°ä¸æ–­æå‡ã€‚", traitEff:(p,e)=>{ e.atk+=50; return "æ”»å‡»åŠ›æˆé•¿"; } },
        { id: 't4_2', tier:4, name: "çœå¸ˆå¤§é™„ä¸­", hp: 48000, atk: 2650, def: 1260, pts: 55, traitName:"åå¸ˆå…‰ç¯", traitDesc:"å›åˆå¼€å§‹æ—¶æ¢å¤å¤§é‡ç”Ÿå‘½ã€‚", traitEff:(p,e)=>{ e.hp+=1500; return "åå¸ˆæ²»ç–—"; } },
        { id: 't4_3', tier:4, name: "ç™¾å¹´è€æ ¡ä¸€ä¸­", hp: 54000, atk: 2800, def: 1500, pts: 60, traitName:"åº•è•´æ·±åš", traitDesc:"æé«˜åŸºç¡€é˜²å¾¡ï¼Œå…ç–«æš´å‡»ã€‚", traitEff:(p,e)=>null },
        { id: 't5_1', tier:5, name: "è¡¡æ°´é’¢é“ä¸­å­¦", hp: 90000, atk: 4600, def: 2400, pts: 100, traitName:"æ­»äº¡è¡Œå†›", traitDesc:"åŒæ–¹æ— æ³•å›è¡€ï¼Œæ•Œæ–¹æ”»å‡»é™„å¸¦é«˜é¢çœŸä¼¤ã€‚", traitEff:(p,e)=>{ p.buffs.hot=0; e.buffs.hot=0; return "ç¦ç–—ç«‹åœºå±•å¼€"; } },
        { id: 't5_2', tier:5, name: "åŒ—äº¬å››ä¸­æœ¬éƒ¨", hp: 105000, atk: 3700, def: 3600, pts: 120, traitName:"é™ç»´æ‰“å‡»", traitDesc:"æ¯å›åˆå°å°ç©å®¶çš„APæ¢å¤ã€‚", traitEff:(p,e)=>{ p.ap=Math.max(0,p.ap-3); return "APå‹åˆ¶"; } },
        { id: 't5_3', tier:5, name: "é»„å†ˆå¯†å·å·¥å‚", hp: 84000, atk: 6100, def: 1500, pts: 150, traitName:"é¢˜æµ·æ·±æ¸Š", traitDesc:"æé«˜æ”»å‡»ï¼Œæ¯æ¬¡å—å‡»åå¼¹ä¼¤å®³ã€‚", traitEff:(p,e)=>null },
        { id: 't5_4', tier:5, name: "äººå¤§é™„ä¸­ç¥åŸŸ", hp: 120000, atk: 4900, def: 3000, pts: 200, traitName:"å…­è¾¹å½¢æˆ˜å£«", traitDesc:"å…ç–«æ‰€æœ‰å¼‚å¸¸ï¼Œå…¨å±æ€§æŒç»­å¢å¼ºã€‚", traitEff:(p,e)=>{ e.atk+=100; e.def+=50; return "ç¥æ€§å¢å¼º"; } },
        { id: 't5_5', tier:5, name: "å®‡å®™çœŸç†ä¸­å­¦", hp: 150000, atk: 7600, def: 7500, pts: 500, traitName:"çœŸç†æŠ¹æ€", traitDesc:"ç¬¬15å›åˆç›´æ¥ç§’æ€ç©å®¶ã€‚", traitEff:(p,e)=>{ if(bState.turn>=15){ p.hp=0; return "çœŸç†æŠ¹æ€å¯åŠ¨ï¼"; } return null; } }
    ];

    const WEATHER_TYPES = [
        { id: 'sun', name: 'â˜€ï¸ æ™´æœ—', desc: 'æ— ç‰¹æ®Šæ•ˆæœ', effect: ()=>{} },
        { id: 'rain', name: 'ğŸŒ§ï¸ é˜´é›¨', desc: 'å…¨å‘˜å¿ƒæƒ…ä½è½ï¼Œæš´å‡»ç‡-10%', effect: (p,e)=>{p.crit-=10; e.crit-=10;} },
        { id: 'morning', name: 'ğŸ“– æ—©è¯»å£°æµª', desc: 'æ€ç»´æ´»è·ƒï¼ŒåŒæ–¹æ”»å‡»åŠ›+20%', effect: (p,e)=>{p.atk*=1.2; e.atk*=1.2;} },
        { id: 'sleepy', name: 'ğŸ˜´ åˆåå›°å€¦', desc: 'æ˜æ˜æ¬²ç¡ï¼ŒåŒæ–¹é˜²å¾¡åŠ›-30%', effect: (p,e)=>{p.def*=0.7; e.def*=0.7;} },
        { id: 'storm', name: 'âš¡ è€ƒè¯•é£æš´', desc: 'å‹åŠ›éª¤å¢ï¼Œæ¯å›åˆå¢åŠ 10ç‚¹ç†µå¢', effect: (p,e)=>{p.stress+=10; e.stress+=10;} }
    ];

    const POLICY_TREE = [
        { tier: 1, nodes: [
            { id: "A1", name: "å†›äº‹åŒ–æ—©è¯»", class: "branch-a", desc: "å­¦ä¸š+1, å‹åŠ›+1", cost: 10, req: null },
            { id: "B1", name: "ä»ªå®¹ä»ªè¡¨å¤§æ£€æŸ¥", class: "branch-b", desc: "çºªå¾‹+1, è‰ºæœ¯-1", cost: 10, req: null },
            { id: "C1", name: "å°å–éƒ¨ç–¯ç‹‚æ¶¨ä»·", class: "branch-c", desc: "æ¯æœˆèµ„é‡‘ç•¥å¢, çºªå¾‹-1", cost: 10, req: null },
            { id: "D1", name: "å¼€è®¾è¯¾å¤–ç¤¾å›¢", class: "branch-d", desc: "è‰ºæœ¯+1, å‹åŠ›-1", cost: 10, req: null }
        ]},
        { tier: 2, nodes: [
            { id: "A2", name: "å¼ºåˆ¶æ™šè‡ªä¹ ", class: "branch-a", desc: "å­¦ä¸š+2, å‹åŠ›+2", cost: 20, req: "A1" },
            { id: "A3", name: "æœˆè€ƒçº¢æ¦œå¤§å­—æŠ¥", class: "branch-a", desc: "å­¦ä¸š+1, çºªå¾‹+1", cost: 20, req: "A1" },
            { id: "B2", name: "å…¨æ ¡ç”µå­è®¾å¤‡ç¦ä»¤", class: "branch-b", desc: "çºªå¾‹+2, å‹åŠ›+1", cost: 20, req: "B1" },
            { id: "B3", name: "ç”·å¥³ç”Ÿåˆ†æ¡Œè¿›é¤", class: "branch-b", desc: "é˜²æ—©æ‹, çºªå¾‹+1", cost: 20, req: "B1" },
            { id: "C2", name: "é£Ÿå ‚å¯¹å¤–å±‚å±‚æ‰¿åŒ…", class: "branch-c", desc: "èµ„é‡‘å¢åŠ , ä½“è´¨-2", cost: 20, req: "C1" },
            { id: "C3", name: "èµåŠ©è´¹æ˜ç æ ‡ä»·", class: "branch-c", desc: "å½•å–é™åˆ†æ”¶é’±, èµ„é‡‘å¤§å¢", cost: 20, req: "C1" },
            { id: "D2", name: "è½å®å‘¨æœ«åŒä¼‘", class: "branch-d", desc: "å‹åŠ›-3, å­¦ä¸š-1", cost: 20, req: "D1" },
            { id: "D3", name: "å…¨æ ¡è‰ºæœ¯èŠ‚ç­¹åŠ", class: "branch-d", desc: "è‰ºæœ¯+3, æ¶ˆè€—èµ„é‡‘", cost: 20, req: "D1" }
        ]},
        { tier: 3, nodes: [
            { id: "A4", name: "å‘¨æœ«ç–¯ç‹‚è¡¥è¯¾", class: "branch-a", desc: "å­¦ä¸š+3, å‹åŠ›+4", cost: 50, req: "A2" },
            { id: "A5", name: "é¢˜æµ·æˆ˜æœ¯å¤§çˆ†å‘", class: "branch-a", desc: "å­¦ä¸š+3, ä½“è´¨-2", cost: 50, req: "A3" },
            { id: "B4", name: "æ•™å®¤360åº¦ç›‘æ§", class: "branch-b", desc: "çºªå¾‹+3, å‹åŠ›+2", cost: 50, req: "B2" },
            { id: "B5", name: "è¿ç¦å“åœ°æ¯¯å¼æœæŸ¥", class: "branch-b", desc: "çºªå¾‹+2, ä½“è´¨+1", cost: 50, req: "B3" },
            { id: "C4", name: "å­¦åŒºæˆ¿ç–¯ç‹‚ç‚’ä½œ", class: "branch-c", desc: "æå‡åæ°”å’Œèµ„é‡‘", cost: 50, req: "C2" },
            { id: "C5", name: "å‹æ¦¨åº•è–ªå®ä¹ æ•™å¸ˆ", class: "branch-c", desc: "æ•™å¸ˆå·¥èµ„å¤§å¹…é™ä½", cost: 50, req: "C3" },
            { id: "D4", name: "å¿ƒç†å¥åº·è¯Šç–—å‘¨", class: "branch-d", desc: "å‹åŠ›-5, çºªå¾‹+1", cost: 50, req: "D2" },
            { id: "D5", name: "å¤§å­¦å¼è‡ªç”±èµ°ç­åˆ¶", class: "branch-d", desc: "è‰ºæœ¯+4, çºªå¾‹-2", cost: 50, req: "D3" }
        ]},
        { tier: 4, nodes: [
            { id: "A6", name: "æœ«ä½æ·˜æ±°åˆ¶é‡ç‚¹ç­", class: "branch-a", desc: "å­¦ä¸š+5, æåº¦é«˜å‹", cost: 100, req: "A4" },
            { id: "A7", name: "å¥¥èµ›å¼ºåŸºæå°–è¥", class: "branch-a", desc: "å­¦ä¸š+4, çƒ§é’±", cost: 100, req: "A5" },
            { id: "B6", name: "å­¦ç”Ÿäº’ç›¸ä¸¾æŠ¥å¥–åŠ±åˆ¶", class: "branch-b", desc: "çºªå¾‹+5, å‹åŠ›çˆ†è¡¨", cost: 100, req: "B4" },
            { id: "B7", name: "å†›è®­å¸¸æ€åŒ–", class: "branch-b", desc: "ä½“è´¨+5, çºªå¾‹+3", cost: 100, req: "B5" },
            { id: "C6", name: "å›½é™…åœŸè±ªç­å‰²éŸ­èœ", class: "branch-c", desc: "èµ„é‡‘æ¯æœˆå·¨é¢å…¥è´¦", cost: 100, req: "C4" },
            { id: "C7", name: "å¼ºè¿«è´­ä¹°å¤©ä»·æ ¡æœ", class: "branch-c", desc: "èµ„é‡‘æš´æ¶¨, å£°èª‰è·Œ", cost: 1000, req: "C5" },
            { id: "D6", name: "æ ¡å›­æ‹çˆ±å®Œå…¨è§£ç¦", class: "branch-d", desc: "å‹åŠ›-8, çºªå¾‹-5", cost: 1000, req: "D4" },
            { id: "D7", name: "å¸¸é’è—¤ç´ è´¨è€ƒæ ¸æ ‡å‡†", class: "branch-d", desc: "è‰ºæœ¯/ä½“è´¨+5, å£°èª‰é£™å‡", cost: 1000, req: "D5" }
        ]},
        { tier: 5, nodes: [
            { id: "A8", name: "ã€ç»ˆæã€‘è¡¡æ°´é«˜è€ƒé›†ä¸­è¥", class: "branch-a", desc: "è§£é”å¿…æ€æŠ€ã€åœ°ç‹±å‘¨ç‰¹è®­ã€‘", cost: 30000, req: "A6" },
            { id: "B8", name: "ã€ç»ˆæã€‘æ–¯å·´è¾¾ç»å¯¹æœä»", class: "branch-b", desc: "çºªå¾‹é”æ­»100", cost: 30000, req: "B6" },
            { id: "C8", name: "ã€ç»ˆæã€‘çº³æ–¯è¾¾å…‹ä¸Šå¸‚é›†å›¢", class: "branch-c", desc: "èµ„é‡‘æ— é™è†¨èƒ€", cost: 30000, req: "C6" },
            { id: "D8", name: "ã€ç»ˆæã€‘ç†æƒ³ä¹Œæ‰˜é‚¦æ ¡å›­", class: "branch-d", desc: "å‹åŠ›æ°¸è¿œä¸º0", cost: 30000, req: "D6" }
        ]}
    ];

    const ACHIEVEMENTS = [ 
        { id: 'a1', name: "ğŸ’¸ ç¬¬ä¸€æ¡¶é‡‘", desc: "èµ„é‡‘ç ´ 1,000 ä¸‡" }, 
        { id: 'a2', name: "ğŸ¤‘ å•†ä¸šå¸å›½", desc: "èµ„é‡‘ç ´ 1 äº¿" }, 
        { id: 'a3', name: "ğŸŒŸ åæ»¡å¤©ä¸‹", desc: "å£°èª‰ç ´ 10,000 ç‚¹" }, 
        { id: 'a4', name: "ğŸ‘‘ æ•™è‚²éœ¸ä¸»", desc: "å­¦æ ¡è¯„çº§è¾¾åˆ°ã€å…¨å›½é¡¶å°–ã€‘" }, 
        { id: 'a5', name: "ğŸ“ å­¦æœ¯æ³°æ–—", desc: "å…¨æ ¡å­¦ä¸šå¹³å‡è¾¾åˆ°90" }, 
        { id: 'a6', name: "ğŸ­ å·ç‹ä¹‹ç‹", desc: "ä¸»ç§‘è¯¾æ—¶æ’æ»¡40èŠ‚" }, 
        { id: 'a7', name: "ğŸ¥‡ å¥¥èµ›å¼ºæ ¡", desc: "ç‚¹äº®å¥¥èµ›å¼ºåŸºæ”¿ç­–" }, 
        { id: 'a8', name: "ğŸ’¥ é«˜å‹é”…ç‚¸äº†", desc: "å…¨æ ¡å¹³å‡å‹åŠ›çˆ†è¡¨100" }, 
        { id: 'a9', name: "ğŸš” æ— æ³•æ— å¤©", desc: "çºªå¾‹è·Œç ´10" }, 
        { id: 'a10', name: "ğŸƒ æ¬§çš‡é™„ä½“", desc: "æŠ½åˆ° SSR çº§ä¸“å®¶" }, 
        { id: 'a11', name: "ğŸ—ï¸ åŸºå»ºç‹‚é­”", desc: "å»ºæ»¡20å—åœ°çš®" }, 
        { id: 'a12', name: "ğŸ‘¨â€ğŸ« ç¾¤æ˜Ÿé—ªè€€", desc: "é›†é½20ä½åå¸ˆ" }, 
        { id: 'a13', name: "ğŸ“œ æ³•å®¶å¤§æˆ", desc: "ç‚¹æ»¡å…¨éƒ¨15é¡¹æ ¡ç­–" }, 
        { id: 'a14', name: "ğŸ‘¨â€ğŸ“ é‡‘æ¦œé¢˜å", desc: "å­¦ç”Ÿæ¨¡å¼é«˜è€ƒè¾¾åˆ°680åˆ†" }, 
        { id: 'a15', name: "ğŸ’• é’æ˜¥æ— æ‚”", desc: "å­¦ç”Ÿæ¨¡å¼æ™®é€šè¡¨ç™½æˆåŠŸ" }, 
        { id: 'a16', name: "ğŸ’€ å½»åº•å´©æºƒ", desc: "å­¦ç”Ÿæ¨¡å¼å‹åŠ›çªç ´100" }, 
        { id: 'a17', name: "âš”ï¸ å¯†å·å…‹æ˜Ÿ", desc: "PVEä¸­å‡»æºƒé»„å†ˆå¯†å·å·¥å‚" }, 
        { id: 'a18', name: "ğŸŒ å…¨çƒéœ¸æƒ", desc: "å»ºç«‹å…¨éƒ¨æµ·å¤–åˆ†æ ¡" },
        { id: 'a19', name: "ğŸ… å›½å®¶é˜Ÿ", desc: "å­¦ç”Ÿæ¨¡å¼è·å¾—å¥¥èµ›ä¿é€" },
        { id: 'ach_lin', name: "ğŸ“– å­¦éœ¸ä¹‹æ‹", desc: "åœ¨å­¦ç”Ÿæ¨¡å¼ä¸­æˆåŠŸæ”»ç•¥æ—çŸ¥ç§‹" },
        { id: 'ach_xia', name: "ğŸ¨ è‰ºæœ¯ä¹‹æ‹", desc: "åœ¨å­¦ç”Ÿæ¨¡å¼ä¸­æˆåŠŸæ”»ç•¥å¤æ™šæ™´" },
        { id: 'ach_jiang', name: "ğŸ€ çƒ­è¡€ä¹‹æ‹", desc: "åœ¨å­¦ç”Ÿæ¨¡å¼ä¸­æˆåŠŸæ”»ç•¥æ±Ÿä¸€èˆŸ" },
        { id: 'ach_shen', name: "ğŸš¬ æ•‘èµä¹‹æ‹", desc: "åœ¨å­¦ç”Ÿæ¨¡å¼ä¸­æˆåŠŸæ”»ç•¥æ²ˆæ¸”" },
        { id: 'a20', name: "ğŸ† ä¸‡è±¡å½’ä¸€", desc: "è§£é”å…¨éƒ¨æˆå°±ï¼" } 
    ];

    const FRIENDS = [
        {id:'f1', name:'ğŸ¤“ å­¦éœ¸åŒæ¡Œ', cost:200, desc:'æ¯æœˆå­¦ä¸š+2', eff:()=>{stuGame.grade+=2;}},
        {id:'f2', name:'ğŸ’° å¯ŒäºŒä»£å‘å°', cost:500, desc:'æ¯æœˆé›¶èŠ±é’±+100', eff:()=>{stuGame.money+=100;}},
        {id:'f3', name:'ğŸƒ ä½“è‚²ç‰¹é•¿ç”Ÿ', cost:200, desc:'æ¯æœˆä½“è´¨+3', eff:()=>{stuGame.fit+=3;}}
    ];

    // å››å¤§æ‹çˆ±å¯¹è±¡é…ç½®
    const CRUSHES = [
        { 
            id: 'lin', name: 'æ—çŸ¥ç§‹', title: 'å­¦éœ¸ç­é•¿', desc: 'è¡¨é¢é«˜å†·ä¸¥è°¨ï¼Œå®åˆ™å†…å¿ƒæ¸´æœ›è¢«ç†è§£ã€‚æ¸…åŒ—ç§å­é€‰æ‰‹ã€‚',
            dialogues: ["è¿™é“é¢˜é€‰Cï¼Œåˆ«å‘å‘†äº†ã€‚","ä»Šå¤©çš„æ—©è¯»ä½ è¿Ÿåˆ°äº†1åˆ†é’Ÿã€‚","ç¬”è®°å€Ÿä½ ï¼Œä¸è¦å¼„è„ã€‚","ä½ è§‰å¾—â€¦â€¦å®‡å®™æœ‰è¾¹ç•Œå—ï¼Ÿ","å‘¨æœ«é™ªæˆ‘å»è¶Ÿå›¾ä¹¦é¦†å§ã€‚","åˆ«è€æ˜¯ç©æ¸¸æˆäº†ï¼Œå¿«æœˆè€ƒäº†ã€‚","æˆ‘çš„ç›®æ ‡æ˜¯æ¸…åï¼Œä½ å‘¢ï¼Ÿ","ä»Šå¤©è®²çš„æ•°åˆ—ä½ å¬æ‡‚äº†å—ï¼Ÿ","æˆ‘å¶å°”ä¹Ÿä¼šè§‰å¾—ç´¯â€¦â€¦","ä½ ä¸ºä»€ä¹ˆæ€»æ˜¯çœ‹ç€æˆ‘ï¼Ÿ"],
            events: {
                30: { trigger: false, name:"å¤©å°èƒŒå•è¯", desc:"å‘ç°å¥¹å·å·åœ¨å¤©å°ä¸Šå†™è¯—ã€‚", check:()=>hasPolicy('A1')?1.5:(hasPolicy('D2')?0.7:1), log:"å¥¹æ¬£èµä½ çš„è‡ªå¾‹ï¼Œå¥½æ„Ÿå€å¢ã€‚" },
                60: { trigger: false, name:"æ•´ç†ç«èµ›èµ„æ–™", desc:"ç†¬å¤œç…§é¡¾ç”Ÿç—…çš„å¥¹ã€‚", check:()=>hasPolicy('A7')?2:1, log:"å…±åŒçš„ç«èµ›ç›®æ ‡è®©ä½ ä»¬ç´§ç´§ç›¸è¿ã€‚" },
                90: { trigger: false, name:"çº¦å®šæœªæ¥", desc:"ä¸€èµ·æŠ¥è€ƒåŒä¸€æ‰€å¤§å­¦ã€‚", check:()=>hasPolicy('A6')?(stuGame.grade>=80?1:-999):1, log:"ä½ ä»¬è®¸ä¸‹äº†ç¥åœ£çš„è¯ºè¨€ã€‚" }
            }
        },
        { 
            id: 'xia', name: 'å¤æ™šæ™´', title: 'è‰ºæœ¯ç‰¹é•¿ç”Ÿ', desc: 'è‡ªç”±æ´’è„±ï¼Œè®¨åŒæŸç¼šï¼Œæ„Ÿæ€§æµªæ¼«ã€‚åœ¨æ ¡å¤–å…¼èŒæ¨¡ç‰¹ã€‚',
            dialogues: ["è¿™æœµäº‘çš„å½¢çŠ¶åƒä¸åƒä¸€é¡¶å¸½å­ï¼Ÿ","å­¦æ ¡çš„åˆ¶æœçœŸéš¾çœ‹ã€‚","å‘¨æœ«æˆ‘è¦å»æ¼«å±•ï¼Œä¸€èµ·æ¥å—ï¼Ÿ","æˆ‘åˆšæ‰ç”»äº†ä½ ï¼Œåˆ«åŠ¨ï¼","å¥½æƒ³é€ƒè¯¾å»æµ·è¾¹å•Šâ€¦â€¦","ä½ å–œæ¬¢æ¢µé«˜è¿˜æ˜¯è«å¥ˆï¼Ÿ","å¬è¿™é¦–æ­Œï¼Œæ˜¯ä¸æ˜¯å¾ˆæœ‰æ„Ÿè§‰ï¼Ÿ","æˆ‘è®¨åŒè¢«è§„åˆ™æŸç¼šã€‚","ä½ è§‰å¾—æˆ‘è¿™èº«æ­é…æ€ä¹ˆæ ·ï¼Ÿ","å˜˜ï¼Œåˆ«å‘Šè¯‰è€å¸ˆæˆ‘åœ¨ç”»ç”»ã€‚"],
            events: {
                30: { trigger: false, name:"æ±Ÿè¾¹å†™ç”Ÿ", desc:"èŠèµ·å¥¹æƒ³å»æ„å¤§åˆ©ç•™å­¦ã€‚", check:()=>hasPolicy('D3')?1.5:(hasPolicy('A4')?0.5:1), log:"è‰ºæœ¯èŠ‚ç­¹åŠè®©å¥¹æ„Ÿå—åˆ°äº†è¢«é‡è§†ã€‚" },
                60: { trigger: false, name:"ç”»ä½œè¢«æ‰¹", desc:"å¥¹çš„ç”»è¢«è€å¸ˆæ‰¹è¯„ï¼Œä½ ç«™å‡ºæ¥ä¸ºå¥¹è¾©æŠ¤ã€‚", check:()=>hasPolicy('D5')?2:0.5, log:"ä½ çš„è¾©æŠ¤æ‰“åŠ¨äº†å¥¹ã€‚" },
                90: { trigger: false, name:"ç­¹åŠç”»å±•", desc:"éœ€è¦èµ„é‡‘æ”¯æŒã€‚", check:()=>hasPolicy('C2')?(stuGame.money>=500?2:-999):1, log:"ä½ ç”¨èµ„é‡‘èµåŠ©äº†å¥¹çš„ç”»å±•ï¼Œå¥¹æ„ŸåŠ¨è½æ³ªã€‚" }
            }
        },
        { 
            id: 'jiang', name: 'æ±Ÿä¸€èˆŸ', title: 'ä½“è‚²ç‰¹é•¿ç”Ÿ', desc: 'æ ¡ç¯®çƒé˜Ÿé˜Ÿé•¿ï¼Œé˜³å…‰å¼€æœ—ã€‚è®²ä¹‰æ°”ï¼Œæœ‰ç‚¹è½æ’ã€‚',
            dialogues: ["èµ°ï¼Œæ‰“çƒå»ï¼","ä½ è¿™ä½“èƒ½ä¸è¡Œå•Šï¼Œå¾—å¤šç»ƒã€‚","æ˜¨å¤©é‚£åœºNBAçœ‹äº†æ²¡ï¼Ÿ","é¥¿æ­»äº†ï¼Œå»é£Ÿå ‚åƒçƒ§çƒ¤ã€‚","å…„å¼Ÿï¼Œå¸®æˆ‘æŠ„ä¸‹ä½œä¸šå‘—ã€‚","æˆ‘å¯æ˜¯è¦è¿›å›½å®¶é˜Ÿçš„ç”·äººã€‚","åˆ«æ€•ï¼Œæœ‰æˆ‘åœ¨æ²¡äººæ•¢æ¬ºè´Ÿä½ ã€‚","å“å‘€ï¼Œå—ä¼¤æ˜¯å®¶å¸¸ä¾¿é¥­ã€‚","å‘¨æœ«å»ç½‘å§å¼€é»‘ï¼Ÿ","ä½ è§‰å¾—é‚£ä¸ªå•¦å•¦é˜Ÿé•¿æ€ä¹ˆæ ·ï¼Ÿå¼€ç©ç¬‘çš„å•¦ã€‚"],
            events: {
                30: { trigger: false, name:"èµ›åçƒ§çƒ¤", desc:"çœ‹ä»–æ‰“çƒèµ›åä¸€èµ·å»åƒçƒ§çƒ¤ã€‚", check:()=>(getFacLevelCount('track',1)>0)?1.5:(hasPolicy('D2')?1.2:0.8), log:"æ–°çƒé¦†è®©ä»–æˆ˜æ„é«˜æ˜‚ã€‚" },
                60: { trigger: false, name:"æ‹‰å–èµåŠ©", desc:"çƒé˜Ÿé¢ä¸´è§£æ•£å±æœºï¼Œä½ å¸®ä»–æ‹‰èµåŠ©ã€‚", check:()=>hasPolicy('C4')?2:1, log:"æ ¡å‹æŠ•èµ„æŒ½æ•‘äº†çƒé˜Ÿã€‚" },
                90: { trigger: false, name:"å…¨å¸‚å†³èµ›", desc:"ä½ å»ç°åœºåŠ æ²¹åŠ©å¨ã€‚", check:()=>hasPolicy('A4')?0.1:1.5, log:"ä½ åœ¨åœºè¾¹å¤§å–Šäº†ä»–çš„åå­—ã€‚" }
            }
        },
        { 
            id: 'shen', name: 'æ²ˆæ¸”', title: 'å›é€†è½¬æ ¡ç”Ÿ', desc: 'ä»å¤§åŸå¸‚è½¬æ¥ï¼ŒæŠ½çƒŸé€ƒè¯¾æŸ“å‘ã€‚å˜´ç¡¬å¿ƒè½¯ï¼Œé˜²å¾¡å¿ƒæå¼ºã€‚',
            dialogues: ["åˆ«çƒ¦æˆ‘ã€‚","ä½ å†çœ‹æˆ‘è¯•è¯•ï¼Ÿ","æ— èŠé€é¡¶çš„å­¦æ ¡ã€‚","å€Ÿä¸ªç«ã€‚","ä½ æƒ³çŸ¥é“æˆ‘è¿‡å»çš„äº‹ï¼Ÿåˆ«é—®ã€‚","è¿™é‡Œçš„ç©ºæ°”çœŸæ²‰é—·ã€‚","ä½ ä¸ºä»€ä¹ˆä¸å’Œå…¶ä»–äººä¸€æ ·èº²ç€æˆ‘ï¼Ÿ","æˆ‘ä¸éœ€è¦åŒæƒ…ã€‚","è¿™é¦–æ­Œï¼Œä½ å¬è¿‡å—ï¼Ÿ","å…¶å®â€¦â€¦è°¢è°¢ä½ é‚£å¤©å¸®æˆ‘ã€‚"],
            events: {
                30: { trigger: false, name:"å‘ç°ç§˜å¯†", desc:"å‘ç°å¥¹å…¶å®åœ¨æ‰“å·¥å…»å®¶ï¼Œä½ å¸®å¥¹ä¿å®ˆç§˜å¯†ã€‚", check:()=>hasPolicy('B1')?-1:(getFacLevelCount('clinic',0)>0?1.5:1), log:"ä½ çš„ç†è§£èåŒ–äº†å¥¹çš„å†°å†·ã€‚" },
                60: { trigger: false, name:"è‹±é›„æ•‘ç¾", desc:"å¥¹è¢«å°æ··æ··çº ç¼ ï¼Œä½ æŒºèº«è€Œå‡ºã€‚", check:()=>hasPolicy('B4')?2:1, log:"å®‰ä¿é˜Ÿçš„ä»‹å…¥è®©äº‹ä»¶å’Œå¹³è§£å†³ã€‚" },
                90: { trigger: false, name:"æ•å¼€å¿ƒæ‰‰", desc:"å¥¹ç”Ÿæ—¥ï¼Œä½ é€äº†å¥¹å–œæ¬¢çš„ä¹¦ã€‚", check:()=>hasPolicy('B3')?-1:1.5, log:"å¥¹ç¬¬ä¸€æ¬¡å¯¹ä½ éœ²å‡ºäº†çœŸå¿ƒçš„å¾®ç¬‘ã€‚" }
            }
        }
    ];

    const EVENT_POOL = [
        { t: "æ•™è‚²å±€çªå‡»æš—è®¿", d: "ä¸Šé¢çªå‡»æ£€æŸ¥è¿è§„è¡¥è¯¾ã€‚", o1: "å¡é’±æ‰“ç‚¹", a1:{act:()=>payCost(0,5)?(log("èŠ±é’±æ¶ˆç¾"),true):false, txt:"è€—èµ„ï¿¥5ä¸‡"}, o2: "ç¡¬æŠ—å®¡æŸ¥", a2:{act:()=>{game.discipline>65?mod("rep",15):mod("rep",-20);return true;}, txt:"çºªå¾‹>65å£°èª‰+15ï¼Œå¦åˆ™-20"} },
        { t: "é£Ÿå ‚é¼ å¤´é¸­è„–äº‹ä»¶", d: "å­¦ç”Ÿæ‹ç…§å‘äº†å¾®åšçƒ­æœã€‚", o1: "èŠ±é’±å‹çƒ­æœ", a1:{act:()=>payCost(0,10)?(mod("stress",5),true):false, txt:"è€—èµ„ï¿¥10ä¸‡,å‹åŠ›+5"}, o2: "æ‰¿è®¤å¹¶æ•´æ”¹", a2:{act:()=>{mod("rep",-20); mod("funds",-5);return true;}, txt:"å£°èª‰-20,èµ„é‡‘-5ä¸‡"} },
        { t: "å¤©å°æŠ‘éƒé¢„è­¦", d: "æœ‰å­¦ç”Ÿå—ä¸äº†çˆ¬ä¸Šå¤©å°ï¼", o1: "ç´§æ€¥å¿ƒç†å¹²é¢„", a1:{act:()=>payCost(2,5)?(mod("stress",-10),true):false, txt:"è€—AP:2,ï¿¥5ä¸‡,å‹åŠ›-10"}, o2: "æ¶ˆé˜²å¼ºè¡Œæ‹‰ä¸‹", a2:{act:()=>{mod("stress",15);return true;}, txt:"å‹åŠ›+15"} },
        { t: "å°–å­ç”Ÿæ—©æ‹è¢«æŠ“", d: "å…¨æ ¡ç¬¬ä¸€å’Œç¬¬äºŒåœ¨æ“åœºçº¦ä¼šã€‚", o1: "æ£’æ‰“é¸³é¸¯è®°è¿‡", a1:{act:()=>{mod("stress",10); mod("disc",5);return true;}, txt:"å‹åŠ›+10,çºªå¾‹+5"}, o2: "é¡ºå…¶è‡ªç„¶", a2:{act:()=>{mod("grade",-5); mod("disc",-5);return true;}, txt:"å­¦ä¸š-5,çºªå¾‹-5"} },
        { t: "æ ¡å¤–é»‘å¸®æ”¶ä¿æŠ¤è´¹", d: "å‘¨è¾¹æ²»å®‰æ€¥å‰§æ¶åŒ–ã€‚", o1: "é›‡ä½£å®‰ä¿é˜Ÿ", a1:{act:()=>payCost(0,8)?(mod("disc",10),true):false, txt:"è€—èµ„ï¿¥8ä¸‡,çºªå¾‹+10"}, o2: "ä¸é—»ä¸é—®", a2:{act:()=>{mod("stress",15);mod("disc",-10);return true;}, txt:"å‹åŠ›+15,çºªå¾‹-10"} },
        { t: "ç«äº‰ç§ç«‹åæ ¡æ¥æŒ–å¢™è„š", d: "éš”å£æƒ³ç”¨ä¸¤å€å·¥èµ„æŒ–ä½ çš„åå¸ˆã€‚", o1: "åŠ è–ªæŒ½ç•™", a1:{act:()=>payCost(0,10)?(mod("grade",5),true):false, txt:"è€—èµ„ï¿¥10ä¸‡,å­¦ä¸š+5"}, o2: "çˆ±èµ°èµ°ä¸ç•™", a2:{act:()=>{mod("grade",-10);return true;}, txt:"å­¦ä¸š-10"} },
        { t: "æ¸…åå­¦éœ¸çŠ¶å…ƒç¬”è®°æ³„éœ²", d: "å…¨æ ¡ç–¯æŠ¢å¤å°ï¼Œå¼•å‘è¸©è¸é£é™©ã€‚", o1: "å­¦æ ¡å‡ºèµ„å®˜æ–¹å°å‘", a1:{act:()=>payCost(0,3)?(mod("grade",5),true):false, txt:"è€—èµ„ï¿¥3ä¸‡,å­¦ä¸š+5"}, o2: "æ²¡æ”¶å……å…¬", a2:{act:()=>{mod("stress",10);mod("disc",5);return true;}, txt:"å‹åŠ›+10,çºªå¾‹+5"} },
        { t: "äº’è”ç½‘å¤§å‚é«˜ç®¡æ ¡å‹å›è®¿", d: "æ›¾ç»çš„åˆºå¤´å­¦ç”Ÿå¦‚ä»Šèº«ä»·è¿‡äº¿ã€‚", o1: "æœ€é«˜è§„æ ¼æ¥å¾…æ‹‰æŠ•èµ„", a1:{act:()=>payCost(2,5)?(mod("funds",30),true):false, txt:"è€—AP:2,ï¿¥5ä¸‡,è·ï¿¥30ä¸‡"}, o2: "ç®€å•åº§è°ˆ", a2:{act:()=>{mod("rep",10);return true;}, txt:"å£°èª‰+10"} }
    ];

    // ================= å…¨å±€çŠ¶æ€ =================
    let metaData = { rebirthPoints: 0, unlockedEndings: [], alumni: [] };
    let defaultGame = {
        year: 2018, month: 9, levelIdx: 0, diff: 1, funds: 100, reputation: 100, ap: 10, maxAp: 20, eduPoints: 0, students: 300, examPoints: 0,
        grade: 40, stress: 10, discipline: 60, fitness: 50, art: 30, schedule: { main: 20, minor: 15, spec: 5 }, teachers: { main: 0, minor: 0, spec: 0 },
        unlockedNodes: [], unlockedExperts: [], branches: [], achievements: [], map: new Array(20).fill(null), policies: [],
        gaokaoHistory: [], lastGaokaoAvg: 0, seniorYear: false, seniorCountdown: 0,
        yearEndRating: [], battleSquad: []
    };
    let game = {}; let autoInterval = null; let selectedMapIndex = -1; let currentMode = 'principal';
    
    // å­¦ç”Ÿæ¨¡å¼çŠ¶æ€
    let stuGame = { active: false, year:1, month:1, turn:1, grade:40, stress:0, fit:40, art:40, talent:[], family:'', money:0, crushes:{}, lover:false, loverName:'', friends:[], examScore: 0, energy: 100, maxEnergy: 100, olympiadProgress: 0, isInsured: false };
    
    // æˆ˜æ–—çŠ¶æ€æœº
    let bState = { active: false, isOver: false, turn: 1, phase: '', p: {}, e: {}, log: [], rivalId: '', pts: 0, currentCat: 'atk', weather: null, expertUsed: false };

    // ================= åˆå§‹åŒ– =================
    function sanitizeGame(g) {
        // ç¡®ä¿æ‰€æœ‰æ•°ç»„å­—æ®µå­˜åœ¨ä¸”ä¸ºæ•°ç»„ï¼ˆé˜²æ­¢æ—§å­˜æ¡£å…¼å®¹æ€§crashï¼‰
        const arrFields = ['unlockedNodes','unlockedExperts','branches','achievements','policies','gaokaoHistory','yearEndRating','battleSquad'];
        arrFields.forEach(f => { if(!Array.isArray(g[f])) g[f] = []; });
        // ç¡®ä¿ map æ˜¯é•¿åº¦20çš„æ•°ç»„
        if(!Array.isArray(g.map) || g.map.length < 20) {
            let oldMap = Array.isArray(g.map) ? g.map : [];
            g.map = new Array(20).fill(null).map((_, i) => oldMap[i] !== undefined ? oldMap[i] : null);
        }
        // ç¡®ä¿åµŒå¥—å¯¹è±¡å­˜åœ¨
        if(!g.schedule || typeof g.schedule !== 'object') g.schedule = { main:20, minor:15, spec:5 };
        if(!g.teachers || typeof g.teachers !== 'object') g.teachers = { main:0, minor:0, spec:0 };
        // ç¡®ä¿æ•°å€¼å­—æ®µå­˜åœ¨
        const numDefaults = { year:2018, month:9, levelIdx:0, diff:1, funds:100, reputation:100, ap:10, maxAp:20, eduPoints:0, students:300, examPoints:0, grade:40, stress:10, discipline:60, fitness:50, art:30, lastGaokaoAvg:0, seniorCountdown:0 };
        Object.entries(numDefaults).forEach(([k,v]) => { if(typeof g[k] !== 'number') g[k] = v; });
        if(typeof g.seniorYear !== 'boolean') g.seniorYear = false;
        return g;
    }

    function init() {
        // æœ€ç®€å•æœ€å¯é çš„åˆå§‹åŒ–â€”â€”æ‰€æœ‰é”™è¯¯éƒ½catchä½ï¼Œç¡®ä¿éš¾åº¦é€‰æ‹©ä¸€å®šå¼¹å‡º
        try {
            let saved = null;
            try { saved = localStorage.getItem('school_v12_save'); } catch(e) {}
            try { let m = localStorage.getItem('school_v12_meta'); if(m) metaData = JSON.parse(m); } catch(e) {}
            
            if(saved) {
                let parsed = JSON.parse(saved);
                let loaded = sanitizeGame(Object.assign(JSON.parse(JSON.stringify(defaultGame)), parsed));
                // éªŒè¯å­˜æ¡£æœ‰æ•ˆ
                if(loaded.year && loaded.month && typeof loaded.funds === 'number') {
                    game = loaded;
                    showCustomModal("ğŸŒ æ¬¢è¿å›æ¥ï¼Œæ ¡é•¿ï¼",
                        `æ£€æµ‹åˆ°å­˜æ¡£ï¼š<b>${SCHOOL_LEVELS[game.levelIdx]?SCHOOL_LEVELS[game.levelIdx].name:'ä¹¡é•‡ä¸­å­¦'}</b> Â· ${game.year}å¹´${game.month}æœˆ<br>èµ„é‡‘: ï¿¥${Math.floor(game.funds)}ä¸‡ | å£°èª‰: ${Math.floor(game.reputation)}`, [
                        {text:"â–¶ ç»§ç»­éœ¸ä¸š", action:()=>{ updateUI(); }},
                        {text:"ğŸ”„ é‡æ–°å¼€å§‹", action:()=>{ try{localStorage.removeItem('school_v12_save');}catch(e){} game={}; showDifficultySelect(); }}
                    ]);
                    return;
                }
            }
        } catch(e) {
            console.warn('Init load error:', e);
        }
        // æ²¡æœ‰å­˜æ¡£æˆ–åŠ è½½å¤±è´¥â€”â€”ç›´æ¥æ˜¾ç¤ºéš¾åº¦é€‰æ‹©
        showDifficultySelect();
    }
    
    // ========== åŸºç¡€å¼•æ“ ==========
    function saveGame() { 
        try {
            localStorage.setItem('school_v12_save', JSON.stringify(game)); 
            localStorage.setItem('school_v12_meta', JSON.stringify(metaData));
            showToast("ğŸ’¾ ä¿å­˜æˆåŠŸ");
        } catch(e) { showToast("ğŸ’¾ ä¿å­˜å¤±è´¥ï¼ˆæ²™ç®±é™åˆ¶ï¼‰"); }
    }
    function hardReset() { if(confirm("è½®å›é‡å»ºï¼Œå½“å‰è¿›åº¦å½’é›¶ï¼ˆä¿ç•™è½®å›ç‚¹ï¼‰ï¼Œç¡®å®šå—ï¼Ÿ")){ if(autoInterval) toggleAuto(); localStorage.removeItem('school_v12_save'); location.reload(); }}
    function getScaleFactor() { let _d = (game.diff != null) ? game.diff : 1; let diff = DIFF_MODS[_d] || DIFF_MODS[1]; return Math.max(1.0, ((game.students||300) / 500) * (diff.costMult||1.0)); }
    function mod(stat, val) { game[stat] += val; }
    function getFacLevelCount(type, minLevel) { if(!game || !Array.isArray(game.map)) return 0; return game.map.filter(x => x && x.id === type && x.level >= minLevel).length; }
    function hasExpert(id) { return Array.isArray(game.unlockedExperts) && game.unlockedExperts.includes(id); }
    function hasPolicy(id) { return Array.isArray(game.policies) && game.policies.includes(id); }
    function hasBranch(id) { return Array.isArray(game.branches) && game.branches.includes(id); }
    
    function log(msg, color="#334155") { let b = document.getElementById('log-box'); b.innerHTML = `<div class="log-item"><span style="color:var(--primary);font-weight:bold;">[${game.year}.${game.month}]</span> <span style="color:${color}">${msg}</span></div>` + b.innerHTML; }
    function showToast(msg) { let b = document.getElementById('toast-container'); let t = document.createElement('div'); t.className = 'toast'; t.innerText = msg; b.appendChild(t); setTimeout(()=>t.remove(), 3900); }
    
    // å¼¹çª—ç³»ç»Ÿ
    window.currentModalCallbacks = [];
    function showCustomModal(title, desc, btns) {
        document.getElementById('modal-title').innerHTML = title; 
        document.getElementById('modal-desc').innerHTML = desc;
        let btnContainer = document.getElementById('modal-buttons'); btnContainer.innerHTML = '';
        window.currentModalCallbacks = btns.map(b => b.action || function(){});
        btns.forEach((b, i) => {
            let btnEl = document.createElement('button'); btnEl.className = 'modal-btn'; btnEl.innerHTML = b.text;
            btnEl.onclick = function() { document.getElementById('modal-overlay').style.display = 'none'; window.currentModalCallbacks[i](); };
            btnContainer.appendChild(btnEl);
        });
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function openModal(id) {
        let el = document.getElementById(id); if(!el) return;
        el.style.display='flex';
        if(id==='modal-achieve') { if(game && game.year) renderAchievements(); }
        else if(id !== 'modal-battle') { if(game && game.year) { try { renderModals(); } catch(e) { console.warn('renderModals error:', e); } } }
    }

    function showDifficultySelect() {
        showCustomModal("ğŸŒ å¼€å¯éœ¸ä¸šçºªå…ƒï¼šé€‰æ‹©éš¾åº¦", "éš¾åº¦å†³å®šåˆå§‹èµ„é‡‘ã€æ—¥å¸¸å¼€é”€å€ç‡ä»¥åŠå­¦ç”ŸæŠ—å‹èƒ½åŠ›çš„æé™ã€‚", [
            {text:"ç®€å• (é€‚åˆä¼‘é—²ä½“éªŒ)", action:()=>startGame(0)}, 
            {text:"æ­£å¸¸ (æ ‡å‡†æ¨¡æ‹Ÿæ³•åˆ™)", action:()=>startGame(1)}, 
            {text:"å›°éš¾ (æè‡´æŠ—å‹æŠ˜ç£¨)", action:()=>startGame(2)}
        ]);
    }
    function startGame(diffIdx) {
        game = JSON.parse(JSON.stringify(defaultGame)); game.diff = diffIdx; game.funds = DIFF_MODS[diffIdx].startFund;
        document.getElementById('principal-container').style.display = 'grid';
        document.getElementById('student-container').style.display = 'none';
        log(`é€‰æ‹©äº†ã€${DIFF_MODS[diffIdx].name}ã€‘éš¾åº¦ã€‚å­¦æ ¡æ­£å¼æŒ‚ç‰Œæˆç«‹ï¼`); updateUI();
    }

    // ================= æ ¸å¿ƒæ¨æ¼”é€»è¾‘ =================
    function advanceMonth() {
        if(!game || !game.year) return showToast("è¯·å…ˆå¼€å§‹æ¸¸æˆï¼");
        if(bState.active) return showToast("æˆ˜æ–—ä¸­æ— æ³•æ¨è¿›ï¼");
        let advBtn = document.getElementById('btn-advance'); if(game.funds <= 0 && advBtn && advBtn.disabled) return;
        game.month++; if (game.month > 12) { game.month = 1; game.year++; }
        
        // APæ¢å¤
        let hallLevel = getFacLevelCount('hall',0) ? game.map.find(x=>x&&x.id==='hall').level : -1;
        game.maxAp = 20 + (hallLevel>=0?5:0) + (hallLevel>=1?10:0) + (hallLevel>=2?30:0) + (hasBranch('b_beijing')?5:0);
        game.ap = Math.min(game.maxAp, game.ap + 3);

        // åˆ†æ ¡æ”¶ç›Š
        BRANCHES_DB.forEach(b => {
            if(hasBranch(b.id)) {
                if(b.id.includes('hengshui')) game.reputation += 20;
                if(b.id.includes('beijing')) game.funds += 100;
                if(b.id.includes('shanghai')) game.reputation += 50;
                if(b.id.includes('harvard')) game.funds += 500;
                if(b.id.includes('oxford')) game.eduPoints += 50;
                if(b.id.includes('huanggang')) game.grade += 0.5;
            }
        });

        // æ¯å­¦æœŸæ”¶å­¦è´¹ (3æœˆä¸9æœˆ) - æ ¹æ®å£°èª‰ã€åœ¨æ ¡è§„æ¨¡ã€å­¦æ ¡ç­‰çº§åŠ¨æ€è°ƒæ•´
        if (game.month === 3 || game.month === 9) {
            let lvl = SCHOOL_LEVELS[game.levelIdx];
            
            // åœ¨æ ¡è§„æ¨¡ï¼šåŸºç¡€äººæ•° Ã— å£°èª‰ç³»æ•°ï¼ˆå£°èª‰è¶Šé«˜ï¼Œæ‹›ç”Ÿè¶Šå¤šï¼Œä¸Šé™1.8å€ï¼Œä¸‹é™0.4å€ï¼‰
            let repFactor = Math.max(0.4, Math.min(1.8, 0.6 + game.reputation / (lvl.reqRep || 500) * 0.6));
            game.students = Math.floor(lvl.baseStu * repFactor);
            game.students = Math.max(50, game.students);

            // å­¦è´¹å•ä»·ï¼šåŸºç¡€è´¹ç‡ Ã— å­¦æ ¡ç­‰çº§ç³»æ•° Ã— å£°èª‰æº¢ä»· Ã— é«˜è€ƒæˆç»©åŠ æˆ
            let baseRate = lvl.tuition;                                              // åŸºç¡€è´¹ç‡ï¼ˆä¸‡/äººï¼‰
            let repPremium = 1 + Math.min(1.0, game.reputation / 5000);            // å£°èª‰æº¢ä»·æœ€å¤šç¿»å€
            let gaokaoBonus = game.lastGaokaoAvg ? Math.max(0, (game.lastGaokaoAvg - 450) / 1500) : 0; // é«˜è€ƒå‡åˆ†è¶Šé«˜å­¦è´¹è¶Šè´µ
            let tuitionPerHead = baseRate * repPremium * (1 + gaokaoBonus);

            let income = Math.floor(game.students * tuitionPerHead);
            game.funds += income;
            let semesterName = game.month === 3 ? 'æ˜¥å­£å­¦æœŸ' : 'ç§‹å­£å­¦æœŸ';
            log(`ğŸ« ã€${semesterName}å¼€å­¦ã€‘åœ¨æ ¡ç”Ÿ ${game.students} äºº Ã— å­¦è´¹ ï¿¥${(tuitionPerHead * 10000).toFixed(0)}å…ƒ = æ”¶å…¥ ï¿¥${income}ä¸‡`, "var(--success)");
            showToast(`ğŸ“š ${semesterName}å­¦è´¹æ”¶å…¥ ï¿¥${income}ä¸‡`);
        }

        // åŸºç¡€æ¶ˆè€—
        let scale = getScaleFactor();
        let tch = game.teachers||{}; let ts = (i)=>(TEACHER_TIERS[i]||TEACHER_TIERS[0]).salary; let totalSal = (ts(tch.main)+ts(tch.minor)+ts(tch.spec)) * ((game.students||300) / 150); 
        let upkeep = SCHOOL_LEVELS[game.levelIdx].upkeep * scale * (hasExpert('e2')?0.85:1);
        let exUpkeep = 0; (game.unlockedExperts||[]).forEach(id => { let ex=EXPERT_POOL.find(x=>x.id===id); if(ex) exUpkeep += (ex.upkeep||0); });
        game.funds -= (totalSal + upkeep + exUpkeep);

        // å±æ€§å˜åŠ¨
        let fMain = game.schedule.main / 20; 
        game.grade += 1.0 * fMain * TEACHER_TIERS[game.teachers.main].multi;
        let diffMod = DIFF_MODS[game.diff!=null?game.diff:1] || DIFF_MODS[1]; let stressGain = 1.5 * fMain * (diffMod.stressMult||0.7);
        let clinicReduce = getFacLevelCount('clinic',0)*5 + getFacLevelCount('clinic',1)*10;
        if(getFacLevelCount('clinic',2)>0) stressGain = 0; else game.stress += Math.max(0, stressGain - clinicReduce);
        
        game.fitness += 0.5; game.art += 0.5;

        // å­¦ç”Ÿæ¨¡å¼è”åŠ¨
        if(stuGame.active) {
            // è¢«åŠ¨ç²¾åŠ›ä¸å…‰ç¯
            stuGame.maxEnergy = hasPolicy('D5') ? 120 : 100;
            stuGame.energy = stuGame.maxEnergy;
            if(hasPolicy('A1')) stuGame.stress += 5; // å†›äº‹åŒ–åŠ å‹
            if(stuGame.lover) stuGame.energy += 30; // çˆ±æƒ…æ»‹æ¶¦å¤§å¹…åŠ ç²¾åŠ›
            
            // æ­»å…šè¢«åŠ¨
            stuGame.friends.forEach(fid => {
                let f = FRIENDS.find(x=>x.id===fid);
                if(f) f.eff();
            });
            
            updateStuUI();
            
            // è‡ªåŠ¨è®¡ç®—è”è€ƒ
            if(game.month === 3 || game.month === 6 || game.month === 11) {
                let base = stuGame.grade * 5 + stuGame.art * 2 + stuGame.fit * 1;
                if(stuGame.isInsured) base = 750; // ä¿é€æ»¡åˆ†
                let rand = Math.random() * 50;
                stuGame.examScore = Math.floor(base + rand);
                let rank = Math.max(1, Math.floor(1000 - stuGame.examScore)); 
                document.getElementById('stu-exam-score').innerText = stuGame.examScore;
                document.getElementById('stu-exam-rank').innerText = `å…¨æ ¡æ’å: ${rank}`;
                let stuBox = document.getElementById('stu-log-box');
                stuBox.innerHTML += `<div>ğŸ“… è”è€ƒç»“æŸï¼Œä½ çš„åˆ†æ•°: <b>${stuGame.examScore}</b> (æ’å${rank})</div>`;
                
                if(stuGame.examScore > 600) { game.reputation += 5; log("ğŸŒŸ å­¦ç”Ÿä»£è¡¨è¡¨ç°ä¼˜å¼‚ï¼Œæ¯æ ¡å£°èª‰+5"); }
            }

            // å­¦ç”Ÿéšæœºäº‹ä»¶ (10%)
            if(Math.random() < 0.1) {
                showCustomModal("ğŸ’ æ ¡å›­å¥‡é‡", "åœ¨èµ°å»Šé‡Œæ¡åˆ°äº†ä¸€æœ¬æ­¦æ—ç§˜ç±(äº”ä¸‰çœŸé¢˜)ã€‚", [{text:"ç–¯ç‹‚å†…å·", action:()=>{stuGame.grade+=10; stuGame.stress+=20; updateStuUI();}}, {text:"æ‹¿å»å–åºŸå“", action:()=>{stuGame.money+=50; updateStuUI();}}]);
                if(autoInterval) toggleAuto();
                return;
            }
        }

        checkCrisis(); clampStats(); checkAchievements(); updateMailbox();
        // æœˆåº¦ç›®æ ‡åˆ·æ–° + ç¤¾ä¼šå…³ç³»è¢«åŠ¨ç»“ç®—ï¼ˆå…ˆåˆå§‹åŒ–å†è°ƒç”¨ï¼‰
        try {
            initSocialRelations();
            generateMonthlyTargets();
            // æ•™è‚²å±€é«˜å¥½æ„Ÿå¸¦æ¥æ”¿ç­–æ‹¨æ¬¾
            if(game.social.govRelations.edu_bureau >= 70) { game.funds += 5; }
            // ç¤¾åŒºä½å¥½æ„Ÿå¸¦æ¥å£°èª‰æƒ©ç½š
            if(game.social.communityRel < 20) { game.reputation -= 5; log("ğŸ˜ï¸ ç¤¾åŒºå±…æ°‘æŒç»­æŠ•è¯‰ï¼Œå£°èª‰å—æŸ", "#ef4444"); }
            // æ•™å¸ˆæ´¾ç³»è¢«åŠ¨å½±å“
            let f = game.social.teacherFactions;
            if(f.young >= 70) game.grade = Math.min(100, game.grade + 0.5);
            if(f.old >= 70) game.discipline = Math.min(100, game.discipline + 0.5);
            if(f.reform >= 70) game.art = Math.min(100, game.art + 0.5);
            let maxF = Math.max(f.young, f.old, f.reform);
            let minF = Math.min(f.young, f.old, f.reform);
            if(maxF - minF > 60) { game.stress = Math.min(100, game.stress + 2); }
        } catch(e) { /* ç¤¾ä¼šå…³ç³»ç³»ç»Ÿå°šæœªæ¿€æ´»ï¼Œè·³è¿‡ */ }

        // é«˜ä¸‰å†²åˆºå€’è®¡æ—¶ç³»ç»Ÿ
        if(stuGame.active) {
            let stuYearNum = Math.ceil(stuGame.turn/12);
            if(stuYearNum >= 3 && !game.seniorYear) {
                game.seniorYear = true;
                game.seniorCountdown = 12; // 12ä¸ªæœˆåˆ°é«˜è€ƒ
                showCustomModal("âš¡ é«˜ä¸‰å†²åˆºå¼€å§‹ï¼", `<div style="text-align:center;"><div style="font-size:3rem;">ğŸ“</div><p>è·ç¦»é«˜è€ƒè¿˜æœ‰ <b style="color:var(--danger);font-size:1.5rem;">${game.seniorCountdown}</b> ä¸ªæœˆï¼</p><p style="color:#ef4444;font-weight:bold;">ä»ç°åœ¨èµ·ï¼Œæ¯æœˆå‹åŠ›ç¿»å€å¢é•¿ã€‚è¯·æ…é‡é€‰æ‹©ï¼šç»§ç»­åŠ å‹ï¼Œè¿˜æ˜¯å¿ƒç†ç–å¯¼ï¼Ÿ</p></div>`, [{text:"å†²ï¼ç»ä¸é€€ç¼©ï¼", action:()=>{stuGame.stress+=10; showToast("å‹åŠ›+10ï¼Œä½†æ„å¿—å¦‚é“ï¼");}}]);
            }
            if(game.seniorYear) {
                game.seniorCountdown = Math.max(0, game.seniorCountdown - 1);
                // å‹åŠ›æ¯æœˆç¿»å€å¢é•¿
                let pressureGain = 5 + (12 - game.seniorCountdown) * 2;
                stuGame.stress += pressureGain;
                
                // å´©æºƒ/å¼ƒè€ƒ/ç¦»å®¶å‡ºèµ°ç³»ç»Ÿ
                if(stuGame.stress >= 90 && Math.random() < 0.2) {
                    let events = [
                        { title: "ğŸš¨ ç²¾ç¥å´©æºƒè­¦æŠ¥", desc: "å­¦ç”Ÿå·²ç²¾ç¥é«˜åº¦ç´§ç»·ï¼Œå‡ºç°å´©æºƒå¾å…†ï¼", opt1:"ç»§ç»­åŠ å‹ï¼ˆé«˜åˆ†ä¼˜å…ˆï¼‰", opt2:"ç«‹å³å¿ƒç†ç–å¯¼ï¼ˆé™ä½å‹åŠ›ï¼‰", eff1:()=>{stuGame.stress+=15; stuGame.grade+=5;}, eff2:()=>{stuGame.stress-=20; stuGame.grade-=3; showToast("å‹åŠ›å‡è½»ï¼Œåˆ†æ•°ç¨é™ã€‚");}},
                        { title: "ğŸ˜° è€ƒç”Ÿæœ‰å¼ƒè€ƒå¿µå¤´", desc: "å­¦ç”Ÿç§ä¸‹è¡¨ç¤ºä¸æƒ³å‚åŠ é«˜è€ƒäº†...", opt1:"å¼ºåˆ¶å‚åŠ ï¼ˆçºªå¾‹å¤„åˆ†ï¼‰", opt2:"å¼€å¯¼è°ˆå¿ƒï¼ˆå‡åˆ†å‡å‹ï¼‰", eff1:()=>{stuGame.stress+=20; stuGame.grade+=3;}, eff2:()=>{stuGame.stress-=15; stuGame.grade-=5;}},
                        { title: "ğŸšª å­¦ç”Ÿç¦»å®¶å‡ºèµ°ï¼", desc: "å‹åŠ›è¿‡å¤§ï¼Œå­¦ç”Ÿæ˜¨æ™šæ²¡æœ‰å›å®¶ï¼", opt1:"æŠ¥è­¦å¼ºåˆ¶å¸¦å›", opt2:"ç»™ä»–ä¸€å¤©è‡ªç”±æ—¶é—´", eff1:()=>{stuGame.stress-=5; game.reputation-=10;}, eff2:()=>{stuGame.stress-=25; stuGame.grade-=8;}}
                    ];
                    let ev = events[Math.floor(Math.random()*events.length)];
                    if(autoInterval) toggleAuto();
                    showCustomModal(ev.title, `<p>${ev.desc}</p><p style="color:#ef4444;font-weight:bold;">è·é«˜è€ƒï¼š${game.seniorCountdown}ä¸ªæœˆ | å‹åŠ›ï¼š${stuGame.stress}</p>`, [
                        {text: ev.opt1, action:()=>{ev.eff1(); updateStuUI();}},
                        {text: ev.opt2, action:()=>{ev.eff2(); updateStuUI();}}
                    ]);
                    return;
                }
                
                // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
                document.getElementById('stu-exam-rank').innerText = `â³ è·é«˜è€ƒï¼š${game.seniorCountdown} ä¸ªæœˆ | å‹åŠ›+${pressureGain}`;
            }
        }

        // è§¦å‘ç‰¹æ®Šäº‹ä»¶
        if (game.month === 3 || game.month === 11) { triggerExamSeason(); return; }
        if (game.month === 6) { triggerGaokao(); return; }
        if (Math.random() < 0.2) { 
            let e = EVENT_POOL[Math.floor(Math.random()*EVENT_POOL.length)];
            showCustomModal(`ğŸ² çªå‘äº‹ä»¶ï¼š${e.t}`, e.d, [
                {text: e.o1 + `<br><span class="event-eff">${e.a1.txt}</span>`, action:()=>{ if(e.a1.act()){updateUI();}else{advanceMonth();} }},
                {text: e.o2 + `<br><span class="event-eff">${e.a2.txt}</span>`, action:()=>{ e.a2.act(); updateUI(); }}
            ]);
            if(autoInterval) toggleAuto();
        } else updateUI();
    }
    
    function toggleAuto() {
        let btn = document.getElementById('btn-auto');
        if (autoInterval) { clearInterval(autoInterval); autoInterval = null; btn.classList.remove('active'); btn.innerText = "ğŸ¤– è‡ªåŠ¨æ¨æ¼”"; } 
        else { btn.classList.add('active'); btn.innerText = "ğŸ›‘ åœæ­¢æ¨æ¼”"; autoInterval = setInterval(() => { if(document.getElementById('modal-overlay').style.display === 'flex' || bState.active) return; document.getElementById('btn-advance').click(); }, 1200); }
    }

    function clampStats() { ['grade', 'stress', 'discipline', 'fitness', 'art'].forEach(s => game[s] = Math.max(0, Math.min(100, game[s]))); game.students = Math.max(50, game.students); }
    
    function triggerGameOver(icon, title, reason) {
        if(game._gameOver) return;
        game._gameOver = true;
        if(autoInterval) toggleAuto();
        let rating = getGameRating();
        let yearsRun = game.year - 2018;
        let html = `<div style="text-align:center;">
            <div style="font-size:4rem;">${icon}</div>
            <h2 style="color:var(--danger); margin:5px 0;">${title}</h2>
            <p style="color:#475569;">${reason}ï¼ŒåŠå­¦ <b>${yearsRun}</b> å¹´åç”»ä¸Šå¥ç‚¹ã€‚</p>
            <div style="background:#fef2f2; border:2px solid #fca5a5; border-radius:8px; padding:15px; margin:15px 0;">
                <div style="font-size:3rem; font-weight:900; color:${rating.color};">${rating.grade}</div>
                <div style="font-weight:bold; color:${rating.color};">${rating.name}</div>
                <p style="font-style:italic; color:#475569; margin:8px 0 0;">"${rating.quote}"</p>
            </div>
            <div style="background:#f8fafc; border-radius:8px; padding:12px; text-align:left; font-size:0.9rem;">
                <div>ğŸ“š å­¦ä¸šï¼š${Math.floor(game.grade)} | ğŸ˜° å‹åŠ›ï¼š${Math.floor(game.stress)} | ğŸ“ çºªå¾‹ï¼š${Math.floor(game.discipline)}</div>
                <div>â­ å£°èª‰ï¼š${Math.floor(game.reputation)} | ğŸ“ é«˜è€ƒå±Šæ•°ï¼š${game.gaokaoHistory.length} | ğŸ† è”è€ƒç§¯åˆ†ï¼š${game.examPoints}</div>
            </div>
        </div>`;
        showCustomModal(`ğŸ’€ æ¸¸æˆç»“æŸ Â· ${title}`, html, [
            {text:"ğŸ“œ æŸ¥çœ‹å®Œæ•´ç»“å±€", action:()=>{ showFinalRating('principal'); }},
            {text:"ğŸ”„ é‡æ–°å¼€å§‹", action: hardReset}
        ]);
        let btn = document.getElementById('btn-advance');
        if(btn) { btn.disabled = true; btn.innerText = "ğŸ’€ å·²ç»ˆç»“ Â· æ¸¸æˆç»“æŸ"; btn.style.background = '#7f1d1d'; }
    }

    function checkCrisis() { 
        if(game._gameOver) return true;
        // â‘  èµ„é‡‘ç ´äº§
        if (game.funds < 0) { 
            game.funds = 0;
            triggerGameOver('ğŸ’¸','å­¦æ ¡ç ´äº§',`èµ„é‡‘é“¾æ–­è£‚ï¼Œæ‚¨çš„å­¦æ ¡åœ¨ ${game.year}å¹´${game.month}æœˆ å®£å‘Šç ´äº§`);
            return true; 
        }
        // â‘¡ å£°èª‰å½’é›¶ - è¢«ç¤¾ä¼šæŠ›å¼ƒ
        if(game.reputation <= 0) {
            game.reputation = 0;
            triggerGameOver('ğŸ‘','å£°èª‰å´©å¡Œ',`å­¦æ ¡å£°èª‰å½»åº•å½’é›¶ï¼Œæ•™è‚²å±€è´£ä»¤åœåŠï¼ˆ${game.year}å¹´${game.month}æœˆï¼‰`);
            return true;
        }
        // â‘¢ è¿ç»­3ä¸ªæœˆå‹åŠ›>90 - å‹åŠ›å´©æºƒ
        if(!game._highStressMonths) game._highStressMonths = 0;
        if(game.stress >= 90) { game._highStressMonths++; } else { game._highStressMonths = 0; }
        if(game._highStressMonths >= 3) {
            triggerGameOver('ğŸ’”','æ ¡å›­å¿ƒç†å±æœº',`è¿ç»­ä¸‰ä¸ªæœˆå…¨æ ¡å‹åŠ›çˆ†è¡¨ï¼Œæ¶æ€§äº‹ä»¶é¢‘å‘ï¼Œæ•™è‚²å±€å¼ºåˆ¶åœåŠï¼ˆ${game.year}å¹´${game.month}æœˆï¼‰`);
            return true;
        }
        // â‘£ çºªå¾‹é•¿æœŸä½ä¸‹ - å­¦ç”Ÿæš´åŠ¨
        if(!game._lowDiscMonths) game._lowDiscMonths = 0;
        if(game.discipline <= 10) { game._lowDiscMonths++; } else { game._lowDiscMonths = 0; }
        if(game._lowDiscMonths >= 4) {
            triggerGameOver('ğŸ”¥','å­¦ç”Ÿæš´åŠ¨',`çºªå¾‹é•¿æœŸå´©æºƒï¼Œå­¦ç”Ÿé›†ä½“ç½¢è¯¾å¹¶å†²å‡»æ ¡åŠï¼Œå­¦æ ¡è¢«è¿«åœåŠï¼ˆ${game.year}å¹´${game.month}æœˆï¼‰`);
            return true;
        }
        // â‘¤ ä¸¥é‡è¿è§„æ”¿ç­–è¢«æŸ¥å° (æ”¿ç­–åå™¬)
        if(game._govShutdown) {
            triggerGameOver('ğŸ›ï¸','æ”¿åºœæŸ¥å°',`å­¦æ ¡è¿è§„è¡Œä¸ºè¢«æ•™è‚²å±€ä¸¾æŠ¥å½»æŸ¥ï¼Œå¼ºåˆ¶åœåŠï¼ˆ${game.year}å¹´${game.month}æœˆï¼‰`);
            return true;
        }
        return false;
    }

    // ================= æˆå°±ç³»ç»Ÿ =================
    function checkAchievements() {
        ACHIEVEMENTS.forEach(a => {
            if(!game.achievements.includes(a.id)) {
                let unlocked = false;
                if(a.id==='a1' && game.funds>=1000) unlocked=true;
                if(a.id==='a2' && game.funds>=10000) unlocked=true;
                if(a.id==='a3' && game.reputation>=10000) unlocked=true;
                if(a.id==='a4' && game.levelIdx>=4) unlocked=true;
                if(a.id==='a8' && game.stress>=100) unlocked=true;
                if(a.id==='a9' && game.discipline<=10) unlocked=true;
                if(a.id==='a13' && game.policies.length>=15) unlocked=true;
                if(a.id==='a16' && stuGame.active && stuGame.stress>=100) unlocked=true;
                // å…¶ä»–éšè—æˆå°±é€šè¿‡æ¸¸æˆå†…äº‹ä»¶ç›´æ¥è§¦å‘
                if(unlocked) {
                    game.achievements.push(a.id);
                    showToast(`ğŸ† è·å¾—æˆå°±ï¼š${a.name}`);
                }
            }
        });
    }

    function renderAchievements() {
        let c = document.getElementById('achieve-container');
        c.innerHTML = ACHIEVEMENTS.map(a => {
            let has = game.achievements.includes(a.id);
            return `<div style="background:#fff; border:2px solid ${has?'var(--gold)':'#e2e8f0'}; padding:10px; border-radius:6px; opacity:${has?1:0.5}"><b>${a.name}</b><br><span style="font-size:0.75rem">${a.desc}</span></div>`;
        }).join('');
    }

    // ================= æˆ˜æ–—ç³»ç»Ÿ V2.0 =================
    function triggerExamSeason() {
        if(autoInterval) toggleAuto();
        showBattlePrep();
    }

    function showBattlePrep() {
        openModal('modal-battle');
        document.getElementById('b-prep').style.display = 'block'; document.getElementById('b-main').style.display = 'none';
        
        // Expert squad selection section
        let squadHtml = `<div style="background:#0f172a; border:1px solid #a3e635; border-radius:8px; padding:15px; margin-bottom:25px;">
            <h3 style="color:#fde047; margin-top:0;">âš”ï¸ ç»„å»ºæˆ˜æ–—ç¼–é˜Ÿ (é€‰æ‹© 3-5 ä½ä¸“å®¶)</h3>
            <p style="color:#94a3b8; font-size:0.85rem; margin-bottom:10px;">å·²é€‰ä¸“å®¶çš„æŠ€èƒ½ç»„åˆå°†äº§ç”ŸåŒ–å­¦ååº”ï¼Œå¸¦æ¥é¢å¤–å¢ç›Šã€‚</p>
            <div style="display:flex; flex-wrap:wrap; gap:8px;" id="squad-selector">`;
        (game.unlockedExperts||[]).forEach(eid => {
            let ex = EXPERT_POOL.find(x=>x.id===eid);
            if(!ex || !ex.battle) return;
            let inSquad = (game.battleSquad||[]).includes(eid);
            squadHtml += `<button onclick="toggleSquad('${eid}',this)" style="background:${inSquad?'#14532d':'rgba(0,0,0,0.6)'}; border:1px solid ${inSquad?'#a3e635':'#3f6212'}; color:${inSquad?'#a3e635':'#94a3b8'}; padding:6px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem; transition:0.2s;">
                ${ex.name} <span style="font-size:0.65rem;">(${ex.rarity})</span>
            </button>`;
        });
        let squadCount = (game.battleSquad||[]).length;
        let synergy = getBattleSynergy();
        squadHtml += `</div>
            <div style="margin-top:10px; color:#fde047; font-size:0.85rem;">å·²é€‰: <span id="squad-count">${squadCount}</span>/5 | ${synergy}</div>
        </div>`;
        
        let prepDiv = document.getElementById('b-prep');
        // Insert squad section at top if not already present
        let existingSquad = prepDiv.querySelector('.squad-section');
        if(!existingSquad) {
            let squadEl = document.createElement('div');
            squadEl.className = 'squad-section';
            squadEl.innerHTML = squadHtml;
            prepDiv.insertBefore(squadEl, prepDiv.querySelector('h2').nextSibling);
        } else {
            existingSquad.innerHTML = squadHtml;
        }
        
        let render = (list, id) => {
            let el = document.getElementById(id); el.innerHTML = '';
            list.forEach(r => {
                let unlocked = game.levelIdx + 1 >= r.tier;
                let html = `<div style="background:#0f172a; border:1px solid ${unlocked?'#4ade80':'#64748b'}; border-radius:6px; padding:10px; font-size:0.8rem; opacity:${unlocked?1:0.5}; position:relative;">
                    <div style="font-weight:bold; color:${unlocked?'#fff':'#94a3b8'}">${r.name}</div>
                    <div style="color:#fde047; margin:4px 0;">HP:${r.hp} ATK:${r.atk}</div>
                    <div style="color:#fca5a5; font-size:0.7rem; border-top:1px dashed #475569; padding-top:4px;"><b>ç‰¹æ€§:</b> ${r.traitName}</div>
                    ${unlocked ? `<button class="btn" style="margin-top:5px; padding:4px; font-size:0.8rem;" onclick="startBattle('${r.id}')">å‡ºå¾è®¨ä¼</button>` : 'ğŸ”’ ç­‰çº§ä¸è¶³'}
                </div>`;
                el.innerHTML += html;
            });
        };
        render(RIVALS.filter(r=>r.tier===1), 'b-rival-t1');
        render(RIVALS.filter(r=>r.tier===2), 'b-rival-t2');
        render(RIVALS.filter(r=>r.tier===3), 'b-rival-t3');
        render(RIVALS.filter(r=>r.tier===4), 'b-rival-t4');
        render(RIVALS.filter(r=>r.tier===5), 'b-rival-t5');
    }
    
    function toggleSquad(eid, btn) {
        if(!game.battleSquad) game.battleSquad = [];
        let idx = game.battleSquad.indexOf(eid);
        if(idx >= 0) {
            game.battleSquad.splice(idx, 1);
            btn.style.background = 'rgba(0,0,0,0.6)'; btn.style.borderColor = '#3f6212'; btn.style.color = '#94a3b8';
        } else {
            if(game.battleSquad.length >= 5) return showToast("æœ€å¤šé€‰æ‹©5åä¸“å®¶ï¼");
            game.battleSquad.push(eid);
            btn.style.background = '#14532d'; btn.style.borderColor = '#a3e635'; btn.style.color = '#a3e635';
        }
        let c = document.getElementById('squad-count');
        if(c) c.innerText = game.battleSquad.length;
        let syn = document.querySelector('.squad-section');
        if(syn) { let sDiv = syn.querySelector('div[style*="fde047"]'); if(sDiv) { sDiv.innerHTML = `å·²é€‰: <span id="squad-count">${game.battleSquad.length}</span>/5 | ${getBattleSynergy()}`; } }
    }
    
    function getBattleSynergy() {
        let squad = game.battleSquad || [];
        if(squad.length < 3) return `<span style="color:#94a3b8">éœ€è‡³å°‘3äººæ‰èƒ½æ¿€æ´»ååŒæ•ˆåº”</span>`;
        // Check synergies
        let hasHealer = squad.some(id => ['e4','e18','e6'].includes(id));
        let hasAttacker = squad.some(id => ['e7','e11','e16'].includes(id));
        let hasDebuffer = squad.some(id => ['e1','e10','e19'].includes(id));
        let synergies = [];
        if(hasHealer && hasAttacker) synergies.push('<span style="color:#a3e635">âš¡æ”»å®ˆå…¼å¤‡: æ”»å‡»+15%å›è¡€+1%</span>');
        if(hasDebuffer && hasAttacker) synergies.push('<span style="color:#fde047">ğŸ’¥ å…‹åˆ¶æˆ˜æœ¯: æš´å‡»ç‡+20%</span>');
        if(squad.length >= 5) synergies.push('<span style="color:#c084fc">âœ¨ æ»¡ç¼–åŠ æˆ: å…¨å±æ€§+10%</span>');
        return synergies.length ? synergies.join(' | ') : '<span style="color:#64748b">æ— ååŒæ•ˆåº”</span>';
    }

    function startBattle(rId) {
        let r = RIVALS.find(x => x.id === rId);
        document.getElementById('b-prep').style.display = 'none'; document.getElementById('b-main').style.display = 'flex';
        
        // åˆ†æ ¡æˆ˜æ–—å¢ç›Šï¼ˆå¤§å¹…åŠ å¼ºï¼‰
        let branchBuff = { atk:1, def:1, hp:1, crit:0, ap:0 };
        if(hasBranch('b_hengshui')) { branchBuff.atk+=0.35; branchBuff.hp+=0.4; bLog && bLog("è¡¡æ°´åˆ†æ ¡ï¼šæ”»å‡»+35% è¡€é‡+40%"); }
        if(hasBranch('b_beijing'))  { branchBuff.def+=0.4; branchBuff.ap+=10; }
        if(hasBranch('b_shanghai')) { branchBuff.crit+=20; }
        if(hasBranch('b_harvard'))  { branchBuff.atk+=0.4; branchBuff.def+=0.4; branchBuff.hp+=0.4; }
        if(hasBranch('b_oxford'))   { branchBuff.def+=0.3; branchBuff.hp+=0.3; }
        if(hasBranch('b_huanggang')){ branchBuff.atk+=0.5; } // ä½†æ¯å›åˆæ‰£è¡€
        
        // APä¸Šé™éšç­‰çº§æå‡
        let levelApBonus = game.levelIdx * 5;
        let initAp = Math.min(game.maxAp + levelApBonus, game.ap + levelApBonus + branchBuff.ap);

        bState = {
            active: true, isOver: false, turn: 1, phase: 'NORMAL', log: [], currentCat: 'atk',
            rivalId: rId, pts: r.pts, weather: WEATHER_TYPES[Math.floor(Math.random()*WEATHER_TYPES.length)],
            expertUsed: false,
            p: {
                maxHp: Math.floor((game.fitness * 100 + game.students * (10 + game.teachers.spec * 5)) * branchBuff.hp),
                atk: Math.floor(game.grade * (10 + game.teachers.main * 5) * branchBuff.atk),
                def: Math.floor(game.discipline * 8 * branchBuff.def),
                crit: Math.floor(game.art * 0.5 + branchBuff.crit),
                stress: 20, // åˆå§‹æ€ç»´ç†µå¢20ï¼ˆé0ï¼‰
                ap: initAp, maxAp: game.maxAp + levelApBonus, morale: 100,
                buffs: { atkUp:0, defUp:0, critUp:0, dmgUp:0, dodge:0, shield:0, hot:0, dot:0, stun:0, atkDown:0, defDown:0 }
            },
            e: {
                name: r.name, maxHp: r.hp, hp: r.hp, atk: r.atk, def: r.def, stress: 0, morale: 100, hasSummoned: false,
                buffs: { atkUp:0, defUp:0, shield:0, hot:0, stun:0, atkDown:0, defDown:0, dot:0 }
            }
        };
        bState.p.hp = bState.p.maxHp;
        
        // Apply squad synergy
        let squad = game.battleSquad || [];
        if(squad.length >= 3) {
            let hasHealer = squad.some(id => ['e4','e18','e6'].includes(id));
            let hasAttacker = squad.some(id => ['e7','e11','e16'].includes(id));
            let hasDebuffer = squad.some(id => ['e1','e10','e19'].includes(id));
            if(hasHealer && hasAttacker) { bState.p.atk = Math.floor(bState.p.atk * 1.15); bState.p.buffs.hot = 99; }
            if(hasDebuffer && hasAttacker) { bState.p.crit += 20; }
            if(squad.length >= 5) { bState.p.atk = Math.floor(bState.p.atk * 1.1); bState.p.def = Math.floor(bState.p.def * 1.1); }
        }

        // æ¸²æŸ“ä¸“å®¶åˆ—è¡¨ (å¸¦æŠ€èƒ½è¯´æ˜)
        let exEl = document.getElementById('b-expert-list'); exEl.innerHTML = '';
        if(game.unlockedExperts.length === 0) {
            exEl.innerHTML = `<div style="color:#475569;font-size:0.8rem;padding:5px;">å°šæ— ä¸“å®¶å¯è°ƒç”¨</div>`;
        }
        (game.unlockedExperts||[]).forEach(eid => {
            let ex = EXPERT_POOL.find(x=>x.id===eid);
            if(!ex || !ex.battle) return;
            let rarityColor = ex.rarity==='SSR'?'#fde047':ex.rarity==='SR'?'#c084fc':'#60a5fa';
            let btn = document.createElement('button');
            btn.style.cssText = `background:rgba(0,0,0,0.7);border:1px solid ${rarityColor};color:#e2e8f0;padding:6px 10px;border-radius:5px;cursor:pointer;font-size:0.72rem;display:flex;align-items:center;gap:6px;text-align:left;transition:0.2s;min-width:180px;`;
            btn.innerHTML = `<div style="width:28px;height:28px;border-radius:14px;overflow:hidden;flex-shrink:0;border:1px solid ${rarityColor};">
                <img src="src/expert/${eid}.png" onerror="this.style.display='none';this.parentNode.innerHTML='<div style=\\'background:${rarityColor};width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:0.6rem;color:#000;\\'>${ex.rarity}</div>'" style="width:100%;height:100%;object-fit:cover;">
            </div>
            <div>
                <div style="color:${rarityColor};font-weight:bold;">${ex.name}</div>
                <div style="color:#94a3b8;font-size:0.65rem;margin-top:1px;">${ex.desc}</div>
            </div>`;
            btn.onmouseover = () => btn.style.background = 'rgba(255,255,255,0.1)';
            btn.onmouseout = () => btn.style.background = 'rgba(0,0,0,0.7)';
            btn.onclick = () => useExpert(eid, btn);
            exEl.appendChild(btn);
        });

        document.getElementById('be-name').innerText = "> " + bState.e.name;
        document.getElementById('be-skill-desc').innerText = `${r.traitName}: ${r.traitDesc}`;
        document.getElementById('b-log').querySelector('.b-log-inner').innerHTML = `<span class="sys">æˆ˜æ–—å¼€å§‹ï¼é­é‡ ${bState.e.name}ï¼</span>`;
        bStartTurn();
    }

    function handleBuffs(entity, isPlayer) {
        let eName = isPlayer ? "æˆ‘æ–¹" : "æ•Œæ–¹";
        if(entity.buffs.dot > 0) {
            let dmg = Math.floor(entity.maxHp * 0.05);
            entity.hp -= dmg;
            bLog(`<span class="e">${eName} å—åˆ°æ¯’ç´ /æµè¡€ä¼¤å®³ ${dmg}ï¼</span>`);
            entity.buffs.dot--;
        }
        if(entity.buffs.hot > 0) {
            let heal = Math.floor(entity.maxHp * 0.08);
            entity.hp = Math.min(entity.maxHp, entity.hp + heal);
            bLog(`<span class="p">${eName} æŒç»­æ¢å¤äº† ${heal} HPï¼</span>`);
            entity.buffs.hot--;
        }
        ['atkUp', 'defUp', 'critUp', 'dmgUp', 'shield', 'stun', 'atkDown', 'defDown'].forEach(k => {
            if(entity.buffs[k] > 0) entity.buffs[k]--;
        });
    }

    function bStartTurn() {
        if(bState.isOver || bCheckEnd()) return;
        bState.expertUsed = false;
        bLog(`<br><span style="color:#94a3b8">--- ROUND ${bState.turn} ---</span>`);
        
        // å¤©æ°”ç³»ç»Ÿ
        if(bState.turn % 3 === 0) { bState.weather = WEATHER_TYPES[Math.floor(Math.random()*WEATHER_TYPES.length)]; bLog(`â˜ï¸ å¤©æ°”å˜æ›´ä¸ºï¼š${bState.weather.name}`); }
        if(bState.weather.effect) bState.weather.effect(bState.p, bState.e);

        // APæ¢å¤ï¼ˆæ¯å›åˆ+3ï¼Œä¸Šé™ç”±ç­‰çº§å†³å®šï¼‰
        bState.p.ap = Math.min(bState.p.maxAp, bState.p.ap + 3);
        
        // æ€ç»´ç†µå¢è‡ªç„¶å¢é•¿ï¼ˆæ¯å›åˆ+2ï¼‰
        bState.p.stress = Math.min(100, bState.p.stress + 2);
        
        // ç†µå¢æ··ä¹±æƒ©ç½šï¼ˆç†µå¢>70æ—¶æ”»é˜²é™ä½ï¼›ç†µå¢>90æ—¶å®Œå…¨æ··ä¹±ï¼‰
        let entropyPenalty = '';
        if(bState.p.stress >= 90) {
            bState.p.buffs.atkDown = Math.max(bState.p.buffs.atkDown, 1);
            bState.p.buffs.defDown = Math.max(bState.p.buffs.defDown, 1);
            entropyPenalty = 'âš ï¸ æ€ç»´ç†µå¢æé«˜ï¼æ”»é˜²å¤§å¹…ä¸‹é™ï¼';
        } else if(bState.p.stress >= 70) {
            entropyPenalty = 'âš ï¸ æ€ç»´æ··ä¹±ï¼Œæ”»é˜²è½»åº¦é™ä½';
        }
        if(entropyPenalty) bLog(`<span style="color:#f59e0b">${entropyPenalty}</span>`);
        
        // BUFF ç»“ç®—
        handleBuffs(bState.p, true);
        handleBuffs(bState.e, false);

        // è§¦å‘æ•Œæ–¹ç‰¹æ€§
        let r = RIVALS.find(x=>x.id===bState.rivalId);
        if(r && r.traitEff) {
            let msg = r.traitEff(bState.p, bState.e);
            if(msg) bLog(`<span style="color:#fde047">[BOSSç‰¹æ€§è§¦å‘] ${msg}</span>`);
        }

        if(hasBranch('b_huanggang')) { bState.p.hp -= Math.floor(bState.p.maxHp*0.04); bLog("å¯†å·åå™¬æ‰£è¡€ï¼"); }
        if(bCheckEnd()) return;

        bUpdateUI();
        if(bState.p.stress >= 100) {
            bLog("ğŸš¨ æ€ç»´ç†µå¢çˆ†è¡¨ï¼Œé™·å…¥æ··ä¹±ï¼è·³è¿‡å›åˆï¼"); bState.p.stress = 40; setTimeout(eAction, 1000);
        } else if(bState.p.buffs.stun > 0) {
            bLog("ğŸš¨ æˆ‘æ–¹è¢«æ™•çœ©ï¼Œæ— æ³•è¡ŒåŠ¨ï¼"); setTimeout(eAction, 1000);
        } else {
            bShowCat(bState.currentCat);
            let btns = document.getElementById('b-expert-list').querySelectorAll('button');
            btns.forEach(b => b.disabled = false); 
        }
    }

    function useExpert(id, btn) {
        if(bState.expertUsed) return showToast("æ¯å›åˆåªèƒ½æŒ‡æ´¾ä¸€åä¸“å®¶ï¼");
        let ex = EXPERT_POOL.find(x=>x.id===id);
        if(!ex || !ex.battle) return showToast("è¯¥ä¸“å®¶æ— æˆ˜æ–—æŠ€èƒ½");
        let msg = ex.battle(bState.p, bState.e);
        if(msg) { 
            bLog(`<span class="sys">âš¡ [${ex.name}] ä¸“å®¶åŠ©é˜µ: ${msg}</span>`); 
            bState.expertUsed = true; 
            btn.disabled = true;
            btn.style.background = '#374151';
            btn.style.color = '#6b7280';
            if(bCheckEnd()) return;
            bUpdateUI(); 
        }
    }

    function pAction(sid) {
        let s = SKILL_DB[sid];
        if(bState.p.ap < s.ap) return showToast("APä¸è¶³ï¼");
        bState.p.ap -= s.ap;
        document.getElementById('b-skills-container').innerHTML = ''; // Lock UI

        bLog(`<span class="p">æˆ‘æ–¹é‡Šæ”¾ [${s.name}]</span>`);
        
        // åˆ¤æ–­æŠ€èƒ½ç±»å‹å¹¶ç”Ÿæ•ˆ
        if(sid === 'sys_èµ„æœ¬') {
            if(game.funds>=50) { game.funds-=50; bState.e.hp -= 9999; bLog("é‡‘é’±çš„åŠ›é‡é€ æˆäº†æ¯ç­æ€§æ‰“å‡»ï¼"); }
            else bLog("èµ„é‡‘ä¸è¶³ä»¥é‡Šæ”¾é’èƒ½åŠ›ï¼");
        } else if(sid === 'insp_1') { 
            if(Math.random()<0.3) { bState.e.hp-=999; bLog("æŠ¼ä¸­åŸé¢˜ï¼é€ æˆ999å·¨é¢çœŸå®ä¼¤å®³ï¼"); } else { bState.e.hp-=10; bLog("æŠ¼é¢˜å¤±è´¥...åªé€ æˆäº†10ç‚¹æ“¦ä¼¤"); }
        } else if(s.cat === 'atk' || s.cat === 'insp') {
            let base = 1.0;
            let match = s.desc.match(/(\d+)%/);
            if(match) base = parseInt(match[1]) / 100;
            
            let rawAtk = bState.p.atk * (bState.p.buffs.atkUp>0 ? 1.5 : 1) * (bState.p.buffs.atkDown>0 ? 0.7 : 1);
            // æ€ç»´ç†µå¢â‰¥70æ—¶æ”»å‡»åŠ›è¡°å‡
            if(bState.p.stress >= 90) rawAtk *= 0.6;
            else if(bState.p.stress >= 70) rawAtk *= 0.8;
            let targetDef = bState.e.def * (bState.e.buffs.defUp>0 ? 1.5 : 1) * (bState.e.buffs.defDown>0 ? 0.3 : 1);
            
            // éƒ¨åˆ†æŠ€èƒ½æ— è§†é˜²å¾¡
            if(s.desc.includes('æ— è§†éƒ¨åˆ†é˜²å¾¡')) targetDef *= 0.5;
            if(s.desc.includes('çœŸå®ä¼¤å®³')) targetDef = 0;
            
            let critRate = bState.p.crit + (bState.p.buffs.critUp>0 ? 50 : 0);
            let isCrit = Math.random()*100 < critRate || bState.p.buffs.dmgUp>0;
            
            let dmg = Math.max(10, rawAtk * base - targetDef);
            if(isCrit) { dmg *= (bState.p.buffs.dmgUp>0 ? 2.0 : 1.5); bLog(`<span class="crit">æš´å‡»ï¼</span>`); }
            
            // å¤šæ®µä¼¤å®³å¤„ç†
            let hitCount = 1;
            if(sid === 'atk_4') hitCount = 3;
            if(sid === 'atk_12') hitCount = 4;
            
            let totalDmg = 0;
            for(let i=0; i<hitCount; i++) {
                let currentHit = dmg;
                if(bState.e.buffs.shield > 0) { currentHit=0; bState.e.buffs.shield--; bLog("æ•Œæ–¹æŠ¤ç›¾æŠµæŒ¡äº†ä¼¤å®³ï¼"); }
                else { totalDmg += Math.floor(currentHit); }
            }
            
            bState.e.hp -= totalDmg;
            bLog(`é€ æˆ <span class="dmg">${totalDmg}</span> ç‚¹ä¼¤å®³`);
            
            // æŠ€èƒ½é™„åŠ æ•ˆæœ
            if(sid==='atk_6') bState.e.buffs.defDown = 2;
            if(sid==='atk_7') bState.e.buffs.dot = 3;
            if(sid==='atk_8') bState.p.buffs.stun = 1;
            if(sid==='atk_9') bState.e.buffs.atkDown = 2;
        } else {
            // éæ”»å‡»æŠ€èƒ½
            if(sid==='def_0') bState.p.buffs.defUp = 2;
            if(sid==='def_1') { bState.p.hp += bState.p.maxHp*0.15; bState.p.buffs.atkDown=0; bState.p.buffs.defDown=0; bLog("çŠ¶æ€æ¢å¤"); }
            if(sid==='def_2') { bState.p.buffs.defUp=2; bState.p.ap+=5; }
            if(sid==='def_3') { bState.p.buffs.shield=1; bLog("è·å¾—æŠ¤ç›¾"); }
            if(sid==='def_4') { bState.p.stress=Math.max(0,bState.p.stress-20); bLog("å‹åŠ›ä¸‹é™"); }
            if(sid==='def_5') { bState.p.buffs.shield=2; bLog("è·å¾—å·¨é¢æŠ¤ç›¾"); }
            if(sid==='def_6') { bState.p.hp += bState.p.maxHp*0.3; bState.p.buffs.hot=2; bLog("æŒç»­å›è¡€å¼€å§‹"); }
            if(sid==='def_7') { bState.p.buffs.dodge=1; bLog("è¿›å…¥é—ªé¿çŠ¶æ€"); }
            if(sid==='def_8') { bState.p.buffs.dmgUp=2; bLog("é˜²å®ˆåå‡»è“„åŠ›"); }
            if(sid==='def_9') { bState.p.hp+=bState.p.maxHp*0.1; bState.p.buffs.dot=0; bState.p.buffs.stun=0; bLog("æ¸…å¿ƒå¯¡æ¬²"); }
            
            if(sid==='sup_0') { bState.p.ap+=10; }
            if(sid==='sup_1') { bState.p.hp+=bState.p.maxHp*0.05; bState.p.ap+=5; }
            if(sid==='sup_2') { bState.p.buffs.atkUp=3; }
            if(sid==='sup_3') { bState.p.buffs.critUp=2; }
            if(sid==='sup_4') { bState.p.hp=bState.p.maxHp; bState.p.ap=game.maxAp; bLog("å…¨å‘˜æ»¡çŠ¶æ€å¤æ´»ï¼"); }
            if(sid==='sup_5') { bState.p.buffs.atkUp=2; bState.p.buffs.defUp=2; bState.p.buffs.critUp=2; bLog("è€ƒç¥é™„ä½“å…¨å±æ€§æå‡ï¼"); }
            
            if(sid==='psy_0') { bState.e.stress+=15; }
            if(sid==='psy_1') { bState.e.stress+=25; bState.e.buffs.defDown=2; }
            if(sid==='psy_2') { bState.e.buffs.atkDown=3; bLog("æ•Œæ–¹æ”»å‡»å¤§å¹…ä¸‹é™"); }
            if(sid==='psy_3') { bState.e.hp -= bState.e.hp*0.2; bLog("æ•Œæ–¹å¿ƒæ€å—åˆ›ç™¾åˆ†æ¯”æ‰£è¡€"); }
            if(sid==='psy_4') { bState.e.buffs.stun=1; bState.e.hp -= bState.p.atk*2; bLog("å«å®¶é•¿å¨åŠ›å·¨å¤§ï¼"); }
            if(sid==='psy_5') { bState.e.buffs.atkDown=2; bState.e.buffs.defDown=2; }
            
            if(sid==='sys_è¡¡æ°´') { bState.p.buffs.atkUp=5; bState.p.hp-=bState.p.maxHp*0.2; bLog("å¼€å¯ç‹‚æš´æ¨¡å¼ï¼"); }
            if(sid==='sys_ç´ è´¨') { bState.p.buffs.atkUp=3; bState.p.buffs.defUp=3; bState.p.buffs.hot=3; bState.p.stress=0; bLog("ç´ è´¨ä¹Œæ‰˜é‚¦é™ä¸´ï¼"); }
        }

        bUpdateUI();
        if(bCheckEnd()) return;
        setTimeout(eAction, 1000);
    }

    function eAction() {
        if(bState.isOver) return;
        if(bState.e.buffs.stun > 0) { bLog("æ•Œæ–¹æ™•çœ©ä¸­ï¼Œè·³è¿‡å›åˆ..."); setTimeout(nextTurn, 1000); return; }

        let rawAtk = bState.e.atk * (bState.e.buffs.atkUp>0 ? 1.5 : 1) * (bState.e.buffs.atkDown>0 ? 0.7 : 1);
        let targetDef = bState.p.def * (bState.p.buffs.defUp>0 ? 1.5 : 1) * (bState.p.buffs.defDown>0 ? 0.3 : 1);
        
        let dmg = Math.max(10, rawAtk - targetDef);
        
        if(bState.p.buffs.dodge > 0) { dmg = 0; bLog("æˆ‘æ–¹å®Œç¾é—ªé¿äº†æ”»å‡»ï¼"); bState.p.buffs.dodge--; }
        else if(bState.p.buffs.shield > 0) { dmg = 0; bLog("æˆ‘æ–¹æŠ¤ç›¾æŠµæŒ¡äº†æ”»å‡»ï¼"); bState.p.buffs.shield--; }
        else {
            bState.p.hp -= Math.floor(dmg);
            bLog(`<span class="e">æ•Œæ–¹æ”»å‡»é€ æˆ ${Math.floor(dmg)} ä¼¤å®³</span>`);
        }
        
        bUpdateUI();
        if(bCheckEnd()) return;
        setTimeout(nextTurn, 1000);
    }

    function nextTurn() { bState.turn++; bStartTurn(); }

    function bCheckEnd() {
        if(bState.isOver) return true;
        if(bState.e.hp <= 0) {
            bState.isOver = true;
            let finalPts = bState.pts * 2;
            let finalMoney = bState.pts * 20; 
            let repGain = Math.floor(bState.pts * 3);
            game.examPoints += finalPts; game.funds += finalMoney; game.reputation += repGain;
            if(bState.rivalId === 't5_3' && !game.achievements.includes('a17')) { game.achievements.push('a17'); showToast("è¾¾æˆæˆå°±ï¼šå¯†å·å…‹æ˜Ÿ"); }
            showCustomModal("ğŸ† å²è¯—å¤§æ·", `è·å¾— ${finalPts} ç§¯åˆ†ï¼Œå¥–é‡‘ ï¿¥${finalMoney}ä¸‡ï¼Œå£°èª‰ +${repGain}ï¼`, [{text:"ç¡®å®š", action:()=>{ closeModal('modal-battle'); bState.active=false; updateUI(); }}]);
            return true;
        }
        if(bState.p.hp <= 0) {
            bState.isOver = true;
            game.reputation -= 30; // å¤±è´¥æ‰£å£°èª‰
            showCustomModal("ğŸ’€ æƒ¨è´¥", "å…¨å†›è¦†æ²¡ï¼Œå£°èª‰ä¸¥é‡å—æŸã€‚ä½†å­¦æ ¡åŸºé‡‘ä¼šå·²ä¸ºæ‚¨å…œåº•ï¼Œèµ„é‡‘æœªå—æŸå¤±ã€‚", [{text:"ç¡®å®š", action:()=>{ closeModal('modal-battle'); bState.active=false; updateUI(); }}]);
            return true;
        }
        return false;
    }

    function bLog(msg) { 
        let inner = document.getElementById('b-log').querySelector('.b-log-inner');
        inner.innerHTML += msg + '<br>'; 
        document.getElementById('b-log').scrollTop = document.getElementById('b-log').scrollHeight;
    }

    function bUpdateUI() {
        let p = bState.p; let e = bState.e;
        document.getElementById('b-weather-ui').innerHTML = `<b>${bState.weather.name}</b><br><span style="font-size:0.65rem">${bState.weather.desc}</span>`;
        document.getElementById('bp-hp-bar').style.width = Math.max(0, p.hp/p.maxHp*100) + '%';
        document.getElementById('bp-hp-txt').innerText = `${Math.floor(p.hp)}/${p.maxHp}`;
        document.getElementById('be-hp-bar').style.width = Math.max(0, e.hp/e.maxHp*100) + '%';
        document.getElementById('be-hp-txt').innerText = `${Math.floor(e.hp)}/${e.maxHp}`;
        document.getElementById('bp-ap').innerText = p.ap;
        document.getElementById('bp-atk').innerText = Math.floor(p.atk * (p.buffs.atkUp>0?1.5:1) * (p.buffs.atkDown>0?0.7:1));
        document.getElementById('be-atk').innerText = Math.floor(e.atk * (e.buffs.atkUp>0?1.5:1) * (e.buffs.atkDown>0?0.7:1));
        document.getElementById('bp-def').innerText = Math.floor(p.def * (p.buffs.defUp>0?1.5:1) * (p.buffs.defDown>0?0.3:1));
        document.getElementById('be-def').innerText = Math.floor(e.def * (e.buffs.defUp>0?1.5:1) * (e.buffs.defDown>0?0.3:1));
        
        let getBuffsStr = (buffObj) => {
            let res = [];
            if(buffObj.atkUp) res.push("âš”ï¸æ”»â†‘"); if(buffObj.defUp) res.push("ğŸ›¡ï¸é˜²â†‘");
            if(buffObj.atkDown) res.push("ğŸ“‰æ”»â†“"); if(buffObj.defDown) res.push("ğŸ“‰é˜²â†“");
            if(buffObj.shield) res.push("ğŸ”°æŠ¤ç›¾"); if(buffObj.dodge) res.push("ğŸ’¨é—ªé¿");
            if(buffObj.hot) res.push("ğŸ’–å›è¡€"); if(buffObj.dot) res.push("â˜ ï¸ä¸­æ¯’");
            if(buffObj.stun) res.push("ğŸ’«æ™•çœ©"); if(buffObj.critUp) res.push("âš¡æš´å‡»â†‘");
            return res.join(' ') || 'æ— ';
        }
        document.getElementById('bp-buffs').innerText = "BUFFS: " + getBuffsStr(p.buffs);
        document.getElementById('be-buffs').innerText = "BUFFS: " + getBuffsStr(e.buffs);
        
        document.getElementById('b-turn-ui').innerText = bState.turn;
    }

    function bShowCat(cat) {
        bState.currentCat = cat;
        document.querySelectorAll('.b-cat-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`cat-${cat}`).classList.add('active');

        let c = document.getElementById('b-skills-container'); c.innerHTML = '';
        for(let k in SKILL_DB) {
            let s = SKILL_DB[k];
            if(s.cat === cat) {
                let unlocked = s.req();
                let btn = document.createElement('button');
                btn.className = 'b-skill-btn';
                btn.disabled = !unlocked || bState.p.ap < s.ap;
                btn.innerHTML = `<div class="b-s-name">${s.name} (AP:${s.ap})</div>
                                 <div class="b-s-desc">${unlocked ? s.desc : `<span style="color:#ef4444">æ¡ä»¶æœªæ»¡è¶³: ${s.reqDesc}</span>`}</div>`;
                btn.onclick = () => pAction(k);
                c.appendChild(btn);
            }
        }
    }
    
    function bRetreat() {
        showCustomModal("ğŸ³ï¸ ç¡®è®¤æ’¤é€€ï¼Ÿ", "æ’¤é€€è§†ä¸ºé€ƒå…µï¼å£°èª‰å°†å‡å°‘50ç‚¹ã€‚", [
            {text:"âœ… ç¡®è®¤æ’¤é€€", action:()=>{ bState.isOver = true; game.reputation -= 50; closeModal('modal-battle'); bState.active=false; updateUI(); }},
            {text:"âŒ ç»§ç»­æˆ˜æ–—", action:()=>{}}
        ]);
    }

    // ================= å…¶å®ƒç³»ç»Ÿ =================
    function renderModals() {
        // åœ°å›¾
        let mGrid = document.getElementById('map-grid'); mGrid.innerHTML = '';
        game.map.forEach((fac, idx) => {
            let div = document.createElement('div'); div.className = 'map-cell' + (idx === selectedMapIndex ? ' selected' : '');
            if(fac) {
                let fData = FACILITIES[fac.id];
                div.innerHTML = `<span style="font-size:1.8rem;">${fData.icon}</span><span style="font-size:0.75rem;">${fData.levels[fac.level].name}</span>`;
            } else div.innerHTML = `<span style="color:#a3e635;font-size:2rem;">+</span>`;
            div.onclick = () => { selectedMapIndex = idx; renderFacDetail(); }; mGrid.appendChild(div);
        });
        renderFacDetail();
        
        // ä¸“å®¶
        let ehtml = ''; EXPERT_POOL.forEach(e => {
            if(hasExpert(e.id)) {
                let typeTag = e.battle ? '<span class="type-tag type-battle">æˆ˜æ–—å‹</span>' : '<span class="type-tag type-passive">å†…æ”¿å‹</span>';
                ehtml += `<div class="gacha-card rarity-${e.rarity}">
                    <img src="src/expert/${e.id}.png" class="expert-img" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'50\\' height=\\'50\\'><rect width=\\'50\\' height=\\'50\\' fill=\\'%23e2e8f0\\'/><text x=\\'50%\\' y=\\'50%\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' font-size=\\'12\\'>æš‚æ— </text></svg>'">
                    <div class="upkeep-tag">ï¿¥${e.upkeep}</div>${typeTag}
                    <div><b>${e.name}</b><br><span style="font-size:0.75rem">${e.desc}</span></div>
                </div>`;
            }
        }); document.getElementById('expert-container').innerHTML = ehtml;

        // åˆ†æ ¡
        let bEl = document.getElementById('branch-container');
        if(bEl) {
            bEl.innerHTML = BRANCHES_DB.map(b => {
                let owned = hasBranch(b.id);
                return `<div style="background:#fff; border:2px solid ${owned?'var(--gold)':'#cbd5e1'}; padding:15px; border-radius:8px;">
                    <div style="font-weight:bold; font-size:1.1rem;">${b.name}</div>
                    <div style="font-size:0.8rem; color:#64748b; margin:5px 0;">${b.desc}</div>
                    ${owned ? '<span style="color:var(--success);font-weight:bold;">âœ… å·²å»ºç«‹</span>' : `<button class="btn" onclick="buyBranch('${b.id}', ${b.cost})">å»ºç«‹ (ï¿¥${b.cost}ä¸‡)</button>`}
                </div>`;
            }).join('');
        }

        // æ”¿ç­–
        let thtml = '';
        POLICY_TREE.forEach(layer => {
            let row = `<div class="tree-tier">`;
            layer.nodes.forEach(n => {
                let unlocked = hasPolicy(n.id); let canUnlock = !unlocked && (!n.req || hasPolicy(n.req));
                let cls = unlocked ? 'unlocked ' + n.class : (canUnlock ? n.class : 'locked ' + n.class);
                let btn = unlocked ? `<span style="color:var(--success);font-size:0.8rem;font-weight:bold;">å·²ç”Ÿæ•ˆ</span>` : 
                          (canUnlock ? `<button class="btn" style="margin:0; padding:4px;" onclick="unlockPolicy('${n.id}', ${n.cost})">é¢å¸ƒ</button>` : `<span style="color:#94a3b8;font-size:0.75rem;">æœªè§£é”</span>`);
                row += `<div class="tree-node ${cls}"><div><h4 style="margin:0 0 5px 0;font-size:0.95rem;">${n.name}</h4><p style="font-size:0.75rem;color:#64748b;">${n.desc}</p></div>${btn}</div>`;
            });
            thtml += row + `</div>`;
        });
        document.getElementById('policy-container').innerHTML = thtml;
        document.getElementById('ui-eduPoints').innerText = game.eduPoints;
    }

    function renderFacDetail() {
        let list = document.getElementById('fac-list'); list.innerHTML = '';
        if(selectedMapIndex===-1) return;
        if(game.map[selectedMapIndex]) {
            let fac = game.map[selectedMapIndex]; let fData = FACILITIES[fac.id];
            let lvlData = fData.levels[fac.level];
            let isMax = fac.level >= fData.levels.length-1;
            let nextInfo = !isMax ? `å‡çº§â†’ ${fData.levels[fac.level+1].name}` : '';
            list.innerHTML = `<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:8px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                    <span style="font-size:1.8rem;">${fData.icon}</span>
                    <div>
                        <div style="font-weight:bold;color:#1e293b;">${lvlData.name}</div>
                        <div style="font-size:0.7rem;color:#64748b;">ç­‰çº§ ${fac.level+1}/${fData.levels.length}</div>
                    </div>
                </div>
                <div style="background:#eff6ff;border-left:3px solid #3b82f6;padding:6px 10px;border-radius:0 6px 6px 0;font-size:0.8rem;color:#1e40af;margin-bottom:8px;">
                    âš¡ æ•ˆæœï¼š${lvlData.desc}
                </div>
                ${isMax ? '<div style="color:#10b981;font-size:0.8rem;font-weight:bold;">âœ… å·²æ»¡çº§</div>' : 
                `<div style="font-size:0.75rem;color:#64748b;margin-bottom:6px;">${nextInfo} (ï¿¥${fData.levels[fac.level+1].cost}ä¸‡)</div>
                <button class="btn" style="margin-right:6px;" onclick="upgradeFac()">â¬† å‡çº§</button>`}
                <button class="btn" style="border-color:#ef4444;color:#ef4444;" onclick="demolish()">ğŸ”¨ æ‹†é™¤</button>
            </div>`;
        } else {
            list.innerHTML = `<div style="color:#64748b;font-size:0.85rem;margin-bottom:8px;">é€‰æ‹©è¦å»ºé€ çš„å»ºç­‘ï¼š</div>`;
            for(let k in FACILITIES) {
                let fData = FACILITIES[k];
                let cost = fData.levels[0].cost;
                let desc = fData.levels[0].desc;
                list.innerHTML += `<button class="btn" style="margin-bottom:6px;text-align:left;display:block;width:100%;" onclick="buildFac('${k}',${cost})">
                    ${fData.icon} <b>${fData.levels[0].name}</b> (ï¿¥${cost}ä¸‡)<br>
                    <span style="font-size:0.72rem;color:#475569;">${desc}</span>
                </button>`;
            }
        }
    }

    function buildFac(k,c){ if(payCost(0,c)){game.map[selectedMapIndex]={id:k,level:0}; renderModals(); updateUI();}}
    function upgradeFac(){ let f=game.map[selectedMapIndex]; let c=FACILITIES[f.id].levels[f.level+1].cost; if(payCost(0,c)){f.level++; renderModals(); updateUI();}}
    function demolish() { game.map[selectedMapIndex] = null; renderModals(); updateUI(); }
    
    function unlockPolicy(id, cost) {
        if(game.eduPoints < cost) return showToast("æ•™ç ”ç‚¹ä¸è¶³");
        game.eduPoints -= cost; game.policies.push(id); renderModals(); updateUI();
    }

    function gachaExpert() {
        if(!payCost(0, 50)) return;
        let r = Math.random(); 
        let ssrRate = [0, 0.005, 0.015, 0.04, 0.08][game.levelIdx]; 
        let srRate = 0.1 + (game.levelIdx * 0.02);
        let targetRarity = 'R'; if(r < ssrRate) targetRarity = 'SSR'; else if(r < ssrRate + srRate) targetRarity = 'SR';
        
        let pool = EXPERT_POOL.filter(x => x.rarity === targetRarity && !hasExpert(x.id));
        if(pool.length === 0) pool = EXPERT_POOL.filter(x => !hasExpert(x.id));
        if(pool.length === 0) return showToast("äººæ‰åº“å·²ç©º");
        
        let ex = pool[Math.floor(Math.random() * pool.length)]; game.unlockedExperts.push(ex.id);
        showCustomModal("âœ¨ å¯»è®¿æˆåŠŸ", `è·å¾— ${ex.rarity} çº§ä¸“å®¶ï¼š${ex.name}`, [{text:"ç¡®å®š", action:()=>{renderModals(); updateUI();}}]);
    }

    function buyBranch(id, cost) { if(payCost(0, cost)) { game.branches.push(id); log(`ğŸŒ å»ºç«‹äº†ã€${BRANCHES_DB.find(x=>x.id===id).name}ã€‘ï¼`); renderModals(); updateUI(); } }
    
    function payCost(ap, money) { if(game.ap>=ap && game.funds>=money) { game.ap-=ap; game.funds-=money; return true; } showToast("èµ„æºä¸è¶³"); return false; }

    function updateMailbox() {
        let box = document.getElementById('student-comments-box');
        let msgs = [];
        if(stuGame.active) {
            msgs.push(`è‡ªå·±: åˆšè€ƒäº† ${stuGame.examScore||0} åˆ†ã€‚`);
            if(stuGame.stress > 80) msgs.push("è‡ªå·±: å‹åŠ›å¤ªå¤§äº†ï¼Œæƒ³é€€å­¦...");
        } else {
            msgs.push("åŒ¿å: æ ¡é•¿å¥½ï¼Œæˆ‘ä¹Ÿæƒ³ç©å­¦ç”Ÿæ¨¡å¼ã€‚");
        }
        if(game.stress > 80) msgs.push("åŒ¿å: å­¦æ ¡å¤ªå‹æŠ‘äº†ï¼");
        if(hasBranch('b_harvard')) msgs.push("åŒ¿å: å¬è¯´å’±ä»¬è¿˜æœ‰å“ˆä½›åˆ†æ ¡ï¼Ÿå¤ªç‰›äº†ï¼");
        
        box.innerHTML = '';
        msgs.forEach(m => {
            box.innerHTML += `<div class="comment-bubble">${m}<div class="comment-meta">${game.year}.${game.month}</div></div>`;
        });
        box.scrollTop = box.scrollHeight;
    }

    function updateUI() {
        if(!game || !game.year) return;
        document.getElementById('principal-container').style.display = 'grid';
        document.getElementById('ui-date').innerText = `${game.year}å¹´ ${game.month}æœˆ`;
        document.getElementById('ui-funds').innerText = Math.floor(game.funds);
        document.getElementById('ui-rep').innerText = Math.floor(game.reputation);
        document.getElementById('ui-ap').innerText = Math.floor(game.ap);
        document.getElementById('val-grade').innerText = Math.floor(game.grade);
        document.getElementById('bar-grade').style.width = game.grade + '%';
        document.getElementById('ui-students').innerText = game.students;
        document.getElementById('ui-examPoints').innerText = game.examPoints;
        document.getElementById('val-stress').innerText = Math.floor(game.stress);
        document.getElementById('bar-stress').style.width = Math.min(100, game.stress) + '%';
        document.getElementById('val-disc').innerText = Math.floor(game.discipline);
        document.getElementById('bar-disc').style.width = game.discipline + '%';
        document.getElementById('val-fit').innerText = Math.floor(game.fitness);
        document.getElementById('bar-fit').style.width = game.fitness + '%';
        document.getElementById('val-art').innerText = Math.floor(game.art);
        document.getElementById('bar-art').style.width = game.art + '%';
        
        document.getElementById('ui-level-name').innerText = `ğŸ† ${SCHOOL_LEVELS[game.levelIdx].name}`;
        
        let exUpkeep = 0; (game.unlockedExperts||[]).forEach(id => { let ex=EXPERT_POOL.find(x=>x.id===id); if(ex) exUpkeep += ex.upkeep||0; });
        let tch2=game.teachers||{}; let ts2=(i)=>(TEACHER_TIERS[i]||TEACHER_TIERS[0]).salary; let totalSal = (ts2(tch2.main)+ts2(tch2.minor)+ts2(tch2.spec)) * ((game.students||300) / 150); 
        let upkeep = SCHOOL_LEVELS[game.levelIdx].upkeep * getScaleFactor() * (hasExpert('e2')?0.85:1);
        document.getElementById('ui-salary').innerText = `å¸¸è€—:-${Math.floor(totalSal + upkeep)} ä¸“å®¶:-${exUpkeep}`;

        let tn=(i)=>(TEACHER_TIERS[i]||TEACHER_TIERS[0]).name; let th=game.teachers||{};
        document.getElementById('tch-main').innerText = tn(th.main);
        document.getElementById('tch-minor').innerText = tn(th.minor);
        document.getElementById('tch-spec').innerText = tn(th.spec);
    }

    // ================= å‡çº§å¼¹çª—é‡æ„ =================
    function checkUpgrade() {
        let next = SCHOOL_LEVELS[game.levelIdx + 1];
        if(!next) return showToast("å·²æ˜¯æœ€é«˜çº§åˆ«ï¼");
        let html = `
            <ul style="text-align:left; line-height:1.8; font-size:1.1rem; background:#f1f5f9; padding:15px 15px 15px 30px; border-radius:8px;">
                <li><b>åæœ›è¦æ±‚:</b> ${next.reqRep} (å½“å‰:${Math.floor(game.reputation)}) ${game.reputation>=next.reqRep?'<span style="color:var(--success)">âœ…</span>':'<span style="color:var(--danger)">âŒ</span>'}</li>
                <li><b>èµ„é‡‘å‚¨å¤‡:</b> ${next.reqFunds}ä¸‡ (å½“å‰:${Math.floor(game.funds)}) ${game.funds>=next.reqFunds?'<span style="color:var(--success)">âœ…</span>':'<span style="color:var(--danger)">âŒ</span>'}</li>
                <li><b>å¹³å‡å­¦ä¸š:</b> ${next.reqGrade} (å½“å‰:${Math.floor(game.grade)}) ${game.grade>=next.reqGrade?'<span style="color:var(--success)">âœ…</span>':'<span style="color:var(--danger)">âŒ</span>'}</li>
            </ul>
        `;
        let canUp = game.reputation>=next.reqRep && game.funds>=next.reqFunds && game.grade>=next.reqGrade;
        let btns = [{text:"ç»§ç»­åŠªåŠ›", action:()=>{}}];
        if(canUp) btns.push({text:"ç¡®è®¤æ™‹å‡ï¼", action:()=>{ game.levelIdx++; log(`æ™‹å‡ä¸ºã€${next.name}ã€‘ï¼`); updateUI(); }});
        showCustomModal(`ç”³è¯·æ™‹å‡ï¼š${next.name}`, html, btns);
    }

    // å­¦ç”Ÿæ¨¡å¼å‡½æ•°
    function switchMode(m) { 
        if(m==='student'){ 
            document.getElementById('principal-container').style.display='none'; 
            document.getElementById('student-container').style.display='block'; 
            renderStudentSetup(); 
            renderStuFriends();
            renderStuCrushes();
        }
        else { document.getElementById('principal-container').style.display='grid'; document.getElementById('student-container').style.display='none'; updateUI(); }
    }
    
    function renderStudentSetup() {
        let grid = document.getElementById('stu-family-grid');
        grid.innerHTML = '';
        FAMILIES.forEach(f => {
            let el = document.createElement('div');
            el.className = 'family-card';
            if(stuGame.family === f.id) el.classList.add('selected');
            el.onclick = () => selectFamily(f.id, el);
            el.innerHTML = `<h3 style="margin:0 0 5px 0;">${f.name}</h3><p style="font-size:0.8rem;color:#64748b;">${f.desc}</p><div style="font-weight:bold;color:var(--primary);margin-top:5px;">åˆå§‹: ï¿¥${f.money}</div>`;
            grid.appendChild(el);
        });
    }

    function selectFamily(id, el) { 
        stuGame.family = id; 
        document.querySelectorAll('.family-card').forEach(c=>c.classList.remove('selected')); 
        el.classList.add('selected'); 
    }
    
    function buyTalent(id, c, el) { if(metaData.rebirthPoints>=c && !stuGame.talent.includes(id)) { metaData.rebirthPoints-=c; stuGame.talent.push(id); el.style.background='#dcfce7'; saveGame(); }}
    function startStudentGameplay() { 
        if(stuGame.family) { 
            stuGame.active=true; 
            if(!stuGame.crushes['lin']) {
                CRUSHES.forEach(c => { stuGame.crushes[c.id] = { aff:0, events:[] }; });
            }
            document.getElementById('stu-setup').style.display='none'; 
            document.getElementById('stu-gameplay').style.display='grid'; 
            updateStuUI(); 
            renderStuCrushes();
        } else showToast("è¯·é€‰å‡ºèº«"); 
    }
    
    // å­¦ç”Ÿè¡ŒåŠ¨é€»è¾‘ (æ¶ˆè€—ç²¾åŠ› + æ‰©å……ç©æ³•)
    function stuAct(t) { 
        let costs = {
            'hard_study': 40, 'study': 25, 'olympiad': 50, 'abroad': 30, 'work': 30, 'gacha': 10, 'esport': 40, 'show': 40, 'sport': 25, 'book': 20, 'sick': 10, 'parent': 15,
            'mun': 50, 'daydream': 10, 'scalper': 30, 'rooftop': 20,
            'diary': 10, 'volunteer': 25, 'club_drama': 35, 'tutor': 30, 'fight': 20, 'confession_prep': 40
        };
        let cost = costs[t] || 20;
        
        if(stuGame.energy < cost) { showToast("ğŸ˜´ ç²¾åŠ›ä¸è¶³ï¼Œè¯·ç‚¹å‡»ã€ç¡è§‰ã€‘ç»“æŸæœ¬æœˆï¼"); return; }
        
        stuGame.energy -= cost;
        let sLog = "";
        
        // æ•ˆæœæ¨¡æ‹Ÿ
        if(t==='study') { stuGame.grade+=2; stuGame.stress+=5; sLog="è®¤çœŸå¬è®²åšç¬”è®°ï¼Œå­¦ä¸š+2ï¼Œå‹åŠ›å¢åŠ ";}
        if(t==='hard_study') { stuGame.grade+=4; stuGame.stress+=12; sLog="ç–¯ç‹‚åˆ·çœŸé¢˜ç†¬å¤œï¼Œå­¦ä¸šå¤§å¢ï¼Œå¤´ç—›æ¬²è£‚ï¼";}
        if(t==='parent') { stuGame.money+=50; sLog="è·Ÿçˆ¶æ¯è¦äº†50å—é’±ç”Ÿæ´»è´¹ã€‚";}
        if(t==='work') { stuGame.money+=30; stuGame.fit-=2; sLog="å»æ ¡å¤–æ‰“å·¥ï¼Œèµšäº†30å…ƒï¼Œèº«ä½“ç–²æƒ«ã€‚";}
        if(t==='mun') { stuGame.grade+=1; stuGame.art+=3; sLog="å‚åŠ æ¨¡æ‹Ÿè”åˆå›½ï¼Œå£æ‰ä¸è§†é‡æå‡ï¼";}
        if(t==='daydream') { stuGame.stress=Math.max(0, stuGame.stress-5); sLog="å¯¹ç€çª—å¤–å‘å‘†ï¼Œç¨å¾®ç¼“äº†å£æ°”ã€‚";}
        if(t==='rooftop') { stuGame.stress=Math.max(0, stuGame.stress-12); sLog="åœ¨å¤©å°å¹é£ï¼Œå‹æŠ‘çš„å¿ƒæƒ…å¾—åˆ°ç¼“è§£ã€‚";}
        if(t==='sick') { stuGame.grade-=2; stuGame.stress=Math.floor(stuGame.stress/2); sLog="è£…ç—…èº²è¿›åŒ»åŠ¡å®¤ï¼Œæ¼äº†è¯¾ï¼Œä½†å‹åŠ›å‡åŠäº†ã€‚"; }
        if(t==='sport') { stuGame.fit+=3; stuGame.art+=1; stuGame.stress=Math.max(0,stuGame.stress-5); sLog="æŒ¥æ´’æ±—æ°´ï¼Œå¼ºå¥ä½“é­„ï¼"; }
        if(t==='book') { stuGame.art+=3; stuGame.stress=Math.max(0,stuGame.stress-5); sLog="åœ¨ä¹¦ä¸­æ‰¾åˆ°äº†é¢œå¦‚ç‰ã€‚"; }
        if(t==='show') { if(stuGame.art>60){stuGame.stress-=15; sLog="ä½ åœ¨èˆå°ä¸Šå¤§æ”¾å¼‚å½©ï¼å…¨åœºç©ç›®ï¼";}else{stuGame.stress+=10; sLog="æ‰è‰ºä¸ä½³ï¼Œæç ¸äº†è¡¨æ¼”ï¼Œå°´å°¬å¾—è„šè¶¾æŠ åœ°ã€‚";} }
        if(t==='esport') { if(Math.random()<0.5){stuGame.money+=100; stuGame.stress-=20; sLog="å¸¦é¢†æˆ˜é˜Ÿå¤ºå† ï¼Œç½‘è´¹å…¨å…è¿˜æ‹¿äº†å¥–é‡‘ï¼";}else{stuGame.stress+=10; sLog="é‡åˆ°çŒªé˜Ÿå‹è¿è·ªï¼Œæ°”å¾—é«˜è¡€å‹ã€‚";} }
        if(t==='scalper') { 
            if(Math.random()<0.3) { stuGame.money-=50; stuGame.stress+=20; sLog="å€’å–è¢«æ•™å¯¼ä¸»ä»»æŠ“ä½ï¼æ²¡æ”¶å¹¶ç½šæ¬¾ï¼"; }
            else { stuGame.money+=150; sLog="å€’å–æ¼”å”±ä¼šé—¨ç¥¨å¤§èµšä¸€ç¬”ï¼"; }
        }
        if(t==='diary') { 
            stuGame.stress=Math.max(0,stuGame.stress-8); 
            if(!stuGame.endingFlags) stuGame.endingFlags={};
            stuGame.endingFlags.diary = (stuGame.endingFlags.diary||0)+1;
            sLog=`å†™äº†ç¬¬${stuGame.endingFlags.diary}ç¯‡æ—¥è®°ï¼Œå€¾è¯‰å†…å¿ƒç§¯å‹çš„æƒ…ç»ªï¼Œå‡å‹8ç‚¹ã€‚`;
            if(stuGame.endingFlags.diary>=5) { stuGame.endingFlags.writer=true; sLog+=" (è§£é”éšè—ç»“å±€ï¼šæ–‡å­—è®°å½•è€…)"; }
        }
        if(t==='volunteer') { 
            stuGame.art+=3; stuGame.stress=Math.max(0,stuGame.stress-5);
            if(!stuGame.endingFlags) stuGame.endingFlags={};
            stuGame.endingFlags.volunteer=(stuGame.endingFlags.volunteer||0)+1;
            sLog="å‚åŠ ç¤¾åŒºæœåŠ¡ï¼Œå¸®åŠ©äº†æœ‰éœ€è¦çš„äººï¼Œé­…åŠ›+3ï¼Œå‹åŠ›-5ã€‚"; 
        }
        if(t==='club_drama') { 
            stuGame.art+=6; stuGame.stress=Math.max(0,stuGame.stress-15); 
            sLog="è¯å‰§ç¤¾æ’ç»ƒäº†ä¸‰ä¸ªå°æ—¶ï¼Œå®Œå…¨æ²‰æµ¸å…¶ä¸­ï¼Œå¿˜è®°äº†æ‰€æœ‰çƒ¦æ¼ï¼é­…åŠ›+6ï¼Œå‡å‹15ã€‚"; 
        }
        if(t==='tutor') { 
            stuGame.money+=80; stuGame.grade+=1; 
            sLog="ç»™å­¦å¼Ÿå­¦å¦¹è¡¥è¯¾ä¸¤å°æ—¶ï¼Œè®²é¢˜è¿‡ç¨‹ä¸­è‡ªå·±ä¹Ÿå·©å›ºäº†çŸ¥è¯†ç‚¹ï¼Œèµšäº†80å…ƒã€‚"; 
        }
        if(t==='fight') { 
            if(Math.random()<0.5) { 
                stuGame.stress-=20; stuGame.fit+=2;
                game.discipline-=5;
                sLog="ç—›æäº†å‡ ä¸ªæ¬ºè´Ÿäººçš„å®¶ä¼™ï¼Œå‹åŠ›æš´å‡ï¼ä½†çºªå¾‹ä¸»ä»»æ‰¾åˆ°å­¦æ ¡äº†â€¦â€¦çºªå¾‹-5ã€‚"; 
            } else { 
                stuGame.stress+=15; stuGame.fit-=3;
                sLog="è¢«å¯¹æ–¹å‡ ä¸ªäººå›´ä½äº†ï¼Œåƒäº†å¤§äºï¼Œèº«ä¸Šæœ‰ä¼¤ï¼Œè¿˜è¢«è¯·å®¶é•¿â€¦â€¦";
            }
        }
        if(t==='confession_prep') {
            if(!stuGame.confessionReady) stuGame.confessionReady = 0;
            stuGame.confessionReady = Math.min(3, stuGame.confessionReady+1);
            stuGame.stress = Math.max(0, stuGame.stress - 5);
            sLog = `ç²¾å¿ƒç­–åˆ’è¡¨ç™½æ–¹æ¡ˆï¼ˆè¿›åº¦${stuGame.confessionReady}/3ï¼‰ï¼Œå…‰æ˜¯æƒ³ç€å°±æœ‰ç‚¹ç”œèœœâ€¦â€¦å‡å‹5ã€‚`;
            if(stuGame.confessionReady>=3) sLog += " æ–¹æ¡ˆå°±ç»ªï¼è¡¨ç™½æˆåŠŸç‡å¤§å¹…æå‡ï¼";
        }
        
        // å¥¥èµ›æœºåˆ¶
        if(t === 'olympiad') {
            if(stuGame.isInsured) { sLog = "å·²ç»ä¿é€æ¸…åŒ—ï¼Œæ— éœ€å†å·ï¼"; }
            else {
                let successRate = stuGame.grade / 100; 
                if(Math.random() < successRate) {
                    stuGame.olympiadProgress += 15;
                    sLog = `æ”»å…‹éš¾é¢˜ï¼å¥¥èµ›è¿›åº¦: ${stuGame.olympiadProgress}%`;
                    if(stuGame.olympiadProgress >= 100) {
                        stuGame.isInsured = true;
                        showCustomModal("ğŸ† å›½å®¶é˜Ÿé‡‘ç‰Œï¼", "ä½ åœ¨å¥¥æ—åŒ¹å…‹ç«èµ›ä¸­æ–©è·é‡‘ç‰Œï¼Œå·²æå‰ä¿é€æ¸…åŒ—ï¼æ ¡é•¿ä¹ç–¯äº†ï¼", [{text:"çˆ½", action:()=>{ game.eduPoints+=100; game.reputation+=500; updateUI(); }}]);
                    }
                } else {
                    stuGame.stress += 20;
                    sLog = "é¢˜ç›®å¤ªéš¾ï¼Œä¸€é“æ²¡è§£å‡ºæ¥ï¼Œå¿ƒæ€ç‚¸è£‚ï¼";
                }
            }
        }
        
        let stuBox = document.getElementById('stu-log-box');
        stuBox.innerHTML += `<div>ğŸ‘‰ ${sLog}</div>`;
        stuBox.scrollTop = stuBox.scrollHeight;

        stuGame.turn++; updateStuUI(); 
    }
    
    function endStudentMonth() { advanceMonth(); }

    function updateStuUI() { 
        document.getElementById('stu-val-grade').innerText = stuGame.grade; 
        document.getElementById('stu-val-stress').innerText = stuGame.stress; 
        document.getElementById('stu-val-fit').innerText = stuGame.fit; 
        document.getElementById('stu-val-art').innerText = stuGame.art; 
        document.getElementById('stu-val-oly').innerText = stuGame.olympiadProgress; 
        document.getElementById('stu-val-money').innerText = stuGame.money;
        document.getElementById('stu-val-energy').innerText = stuGame.energy;
        document.getElementById('stu-bar-energy').style.width = (stuGame.energy/stuGame.maxEnergy*100) + '%';
        
        document.getElementById('stu-lover-tag').innerHTML = stuGame.lover ? `ğŸ’• ä¸[${stuGame.loverName}]çƒ­æ‹ä¸­` : 'ğŸ’” å•èº«ç‹—';

        document.getElementById('stu-ui-year').innerText = Math.ceil(stuGame.turn/12);
        document.getElementById('stu-ui-month').innerText = game.month;
        document.getElementById('stu-ui-turn').innerText = stuGame.turn;
    }
    
    // ================= æ‹çˆ±æœºåˆ¶æ‰©å…… (v2 - æ·±åº¦æƒ…æ„Ÿçº¿) =================
    // renderStuCrushes åœ¨ä¸‹æ–¹ç¬¬äºŒå¤„å®šä¹‰ï¼ŒåŒ…å«å®Œæ•´åŠŸèƒ½
    
    function interactCrush(cid, type) {
        if(stuGame.lover && type === 'confess') return showToast("ä½ å·²ç»æœ‰ä¼´ä¾£äº†ï¼Œä¸“ä¸€ä¸€ç‚¹ï¼");
        let ch = CRUSHES.find(x=>x.id===cid);
        let data = stuGame.crushes[cid];
        
        if(type === 'confess') {
            if(stuGame.energy < 50) return showToast("ç²¾åŠ›ä¸è¶³ï¼ˆéœ€è¦50ç‚¹ï¼‰");
            stuGame.energy -= 50;
            let dBox = document.getElementById(`dialog-${cid}`);
            if(dBox) dBox.style.display = 'block';
            
            if(data.aff >= 100) {
                if(hasPolicy('B3') || hasPolicy('B4')) {
                    if(dBox) dBox.innerText = `"å­¦æ ¡ç°åœ¨æŸ¥å¾—å¤ªä¸¥äº†ï¼Œç›‘æ§åˆ°å¤„éƒ½æ˜¯â€¦â€¦å¯¹ä¸èµ·ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç®—äº†å§ã€‚"`;
                    stuGame.stress += 50;
                    showToast("ç¯å¢ƒæ¶åŠ£ï¼Œè¡¨ç™½å¤±è´¥ï¼");
                } else {
                    stuGame.lover = true;
                    stuGame.loverName = ch.name;
                    if(dBox) dBox.innerText = `"å…¶å®â€¦â€¦æˆ‘ä¹Ÿå–œæ¬¢ä½ å¾ˆä¹…äº†ã€‚"`;
                    showToast(`ğŸ’˜ æˆåŠŸä¸ ${ch.name} å å…¥çˆ±æ²³ï¼`);
                    let achId = '';
                    if(cid==='lin') achId='ach_lin'; if(cid==='xia') achId='ach_xia';
                    if(cid==='jiang') achId='ach_jiang'; if(cid==='shen') achId='ach_shen';
                    if(achId && !game.achievements.includes(achId)) {
                        game.achievements.push(achId);
                        showToast(`ğŸ† è·å¾—æˆå°±ï¼š${ACHIEVEMENTS.find(x=>x.id===achId).name}`);
                    }
                }
            } else {
                if(dBox) dBox.innerText = `"æˆ‘ä»¬åªæ˜¯æ™®é€šçš„åŒå­¦å…³ç³»å§ï¼Ÿåˆ«å¼€è¿™ç§ç©ç¬‘äº†ã€‚"`;
                stuGame.stress += 30;
                showToast("å¥½æ„Ÿåº¦ä¸è¶³ï¼Œæƒ¨é­æ‹’ç»ï¼");
            }
        }

        // æ£€æŸ¥é˜¶æ®µäº‹ä»¶
        for(let lv in ch.events) {
            if(data.aff >= parseInt(lv) && !data.events.includes(lv)) {
                let ev = ch.events[lv];
                let checkRes = ev.check();
                if(checkRes === -999) {
                    showToast(`[äº‹ä»¶ä¸­æ–­] ${ch.name}å¯¹ä½ å¤§å¤±æ‰€æœ›ã€‚`);
                    data.events.push(lv);
                    data.aff -= 20;
                } else {
                    data.aff += 10 * checkRes;
                    data.events.push(lv);
                    showCustomModal(`ğŸ’• ç¾ç»ŠåŠ æ·±ï¼š${ch.name} - ${ev.name}`, `${ev.desc}<br><br><span style="color:var(--primary);font-weight:bold;">${ev.log}</span>`, [{text:"ç»§ç»­", action:()=>{renderStuCrushes(); updateStuUI();}}]);
                    return;
                }
            }
        }

        renderStuCrushes();
        updateStuUI();
    }

    // ================= å¥½æ„Ÿåº¦buffç³»ç»Ÿ =================
    function getCrushBuff(cid, aff) {
        if(aff < 30) return null;
        const buffs = {
            'lin': { name: 'å­¦éœ¸å…‰ç¯', desc: 'æ¯æ¬¡å­¦ä¹ é¢å¤–+2å­¦ä¸š', threshold: 30, apply: ()=>{ stuGame.grade += 2; } },
            'xia': { name: 'è‰ºæœ¯çµæ„Ÿ', desc: 'é­…åŠ›+3ï¼Œå‡å‹2', threshold: 30, apply: ()=>{ stuGame.art += 3; stuGame.stress = Math.max(0, stuGame.stress-2); } },
            'jiang': { name: 'è¿åŠ¨åŠ æˆ', desc: 'ä½“è´¨+2ï¼Œç²¾åŠ›+10', threshold: 30, apply: ()=>{ stuGame.fit += 2; stuGame.energy = Math.min(stuGame.maxEnergy, stuGame.energy+10); } },
            'shen': { name: 'å¿ƒçµæ…°è—‰', desc: 'å‡å‹5ï¼Œé­…åŠ›+2', threshold: 30, apply: ()=>{ stuGame.stress = Math.max(0,stuGame.stress-5); stuGame.art+=2; } }
        };
        return buffs[cid] || null;
    }

    // å¯¹è¯é€‰é¡¹ç³»ç»Ÿ - æ¯è§’è‰²10+ç§ï¼Œæœ‰å¢åŠ /å‡å°‘å¥½æ„Ÿçš„é€‰é¡¹
    const CRUSH_DIALOGUE_OPTIONS = {
        'lin': [
            { text: 'ä½ ä»Šå¤©è®²é¢˜è®²å¾—çœŸå¥½', effect: 5, reply: '"å“¼ï¼Œä½ åªæ˜¯åœ¨æ‹é©¬å±è€Œå·²ã€‚â€¦â€¦è°¢è°¢ä½ ã€‚"', type: 'good' },
            { text: 'å’±ä»¬ä¸€èµ·å»å›¾ä¹¦é¦†?', effect: 8, reply: '"å¥½å•Šï¼Œä½†ä½ å¾—è·Ÿä¸Šæˆ‘çš„è¿›åº¦ã€‚"', type: 'good' },
            { text: 'æˆ‘è§‰å¾—å¤ªå·äº†ï¼Œä¸å€¼å¾—', effect: -8, reply: '"ä½ è¿™ç§æ€åº¦è®©æˆ‘å¾ˆå¤±æœ›ã€‚è‡ªå·±æƒ³æ¸…æ¥šå§ã€‚"', type: 'bad' },
            { text: 'ä½ å¹³æ—¶æ€ä¹ˆæ”¾æ¾?', effect: 3, reply: '"â€¦â€¦å¶å°”ä¼šä¸€ä¸ªäººåœ¨å¤©å°çœ‹æ˜Ÿæ˜Ÿã€‚ä½ åˆ«ç¬‘è¯æˆ‘ã€‚"', type: 'neutral' },
            { text: 'å¸®æˆ‘æŠ„ä¸€ä¸‹ä½œä¸š', effect: -5, reply: '"ä½ ä»¥ä¸ºæˆ‘ä¼šå¸®ä½ ä½œå¼Šï¼Ÿï¼æ»šå»è‡ªå·±å†™ï¼"', type: 'bad' },
            { text: 'ä½ æœ‰æ²¡æœ‰æƒ³è¿‡æ¸…åä»¥å¤–çš„è·¯?', effect: 4, reply: '"æœ‰æ—¶å€™ä¼šæƒ³â€¦â€¦ä½†ç°åœ¨ä¸æ˜¯è¯¥æƒ³è¿™ä¸ªçš„æ—¶å€™ã€‚"', type: 'neutral' },
            { text: 'ä¸Šæ¬¡è€ƒè¯•ä½ æ˜¯ç¬¬ä¸€åå¯¹å—', effect: 6, reply: '"å—¯ã€‚ä½†æˆ‘è§‰å¾—æ•°å­¦è¿˜å¯ä»¥å†æé«˜ã€‚"', type: 'good' },
            { text: 'ä½ è¿™é“é¢˜çš„è§£æ³•ä¸å¯¹', effect: -3, reply: '"â€¦â€¦è®©æˆ‘é‡æ–°ç®—ç®—ã€‚ä½ è¯´å¾—æœ‰ç‚¹é“ç†ã€‚"', type: 'neutral' },
            { text: 'ä½ çš„å­—å¥½æ¼‚äº®', effect: 7, reply: '"â€¦ä½ æœ‰ç‚¹çƒ¦ã€‚è°¢è°¢ä½ æ³¨æ„åˆ°çš„ã€‚"', type: 'good' },
            { text: 'å‡æœŸæƒ³å»å“ªé‡Œ?', effect: 5, reply: '"æ¸…åå›­ã€‚æˆ‘è¦å»æ„Ÿå—ä¸€ä¸‹æ°›å›´ã€‚ä¹Ÿè®¸â€¦â€¦å¸¦ä¸Šä½ ä¹Ÿè¡Œã€‚"', type: 'good' },
        ],
        'xia': [
            { text: 'ä½ çš„ç”»çœŸçš„å¤ªæœ‰æ„Ÿè§‰äº†', effect: 8, reply: '"çœŸçš„å—ï¼Ÿï¼ä½ æ˜¯ç¬¬ä¸€ä¸ªè¿™ä¹ˆè¯´çš„ï¼"', type: 'good' },
            { text: 'è¦ä¸è¦ä¸€èµ·é€ƒè¯¾?', effect: 10, reply: '"å“‡ï¼Œä½ æ¯”æˆ‘æƒ³è±¡çš„æœ‰è¶£ï¼èµ°èµ°èµ°ï¼"', type: 'good' },
            { text: 'ç”»ç”»æ²¡ä»€ä¹ˆç”¨ï¼Œè¿˜æ˜¯å­¦ä¹ é‡è¦', effect: -10, reply: '"é‚£å°±åˆ«æ¥æ‰“æ‰°æˆ‘ç”»ç”»ï¼"', type: 'bad' },
            { text: 'è¿™é¦–æ­ŒçœŸå¥½å¬', effect: 6, reply: '"å¯¹å¯¹å¯¹ï¼è¿™æ˜¯æˆ‘æœ€è¿‘åœ¨è¿½çš„ä¹å›¢ï¼ä½ ä¹Ÿå–œæ¬¢ï¼Ÿ"', type: 'good' },
            { text: 'ä½ çš„åˆ¶æœå…¶å®æŒºå¥½çœ‹çš„', effect: 5, reply: '"â€¦â€¦å¥½å§ä½ çš„å®¡ç¾è¿˜è¡Œã€‚"', type: 'neutral' },
            { text: 'ä½ ç”»çš„è¿™æœµäº‘åƒæ£‰èŠ±ç³–', effect: 4, reply: '"å“ˆå“ˆï¼ä½ çš„è”æƒ³åŠ›ä¸å·®ï¼"', type: 'neutral' },
            { text: 'ä½ æœ‰æƒ³è¿‡å»æ„å¤§åˆ©å­¦è‰ºæœ¯å—', effect: 9, reply: '"ä½ â€¦â€¦æ€ä¹ˆçŸ¥é“æˆ‘çš„æ¢¦æƒ³ï¼Ÿä¸€èµ·å»å—ï¼Ÿ"', type: 'good' },
            { text: 'è¿™ç§é£æ ¼å¤ªå°ä¼—äº†', effect: -6, reply: '"éšä½ æ€ä¹ˆè¯´ï¼Œæˆ‘ä¸åœ¨ä¹å¤§ä¼—ã€‚"', type: 'bad' },
            { text: 'å¯ä»¥å¸®æˆ‘ç”»ä¸ªåƒå—', effect: 7, reply: '"å¥½å•Šï¼ä½†ä½ è¦ä¸€ç›´ä¿æŒè¿™ä¸ªè¡¨æƒ…ã€‚"', type: 'good' },
            { text: 'ä½ ä¸æ€•è¢«è€å¸ˆæŠ“åˆ°ç”»ç”»?', effect: 3, reply: '"æŠ“åˆ°åˆæ€æ ·ï¼Œå¤§ä¸äº†äº¤ä½œä¸šã€‚"', type: 'neutral' },
        ],
        'jiang': [
            { text: 'ä½ æ‰“ç¯®çƒçœŸçš„å¥½é…·', effect: 8, reply: '"å˜¿å˜¿ï¼Œä½ æ‡‚å¾—æ¬£èµï¼æ¥ï¼Œæˆ‘æ•™ä½ ï¼"', type: 'good' },
            { text: 'ä¸€èµ·å»æ‰“çƒå§', effect: 10, reply: '"ç­‰ä»€ä¹ˆï¼èµ°èµ·ï¼"', type: 'good' },
            { text: 'è¿åŠ¨æµªè´¹æ—¶é—´', effect: -10, reply: '"â€¦â€¦ä½ è¿™ç§äººæˆ‘æœ€çœ‹ä¸ä¸Šã€‚"', type: 'bad' },
            { text: 'ä½ æ˜¨å¤©é‚£ä¸ªä¸‰åˆ†çƒå¤ªå¸…äº†', effect: 7, reply: '"å“ˆï¼çœ‹åˆ°äº†ï¼Ÿé‚£å«è‰ºæœ¯ï¼"', type: 'good' },
            { text: 'å¸®æˆ‘åšä½œä¸šå§æˆ‘æ¥æ‰“çƒ', effect: -5, reply: '"å…„å¼Ÿï¼Œæˆ‘ä¹Ÿä¸ä¼šåšå•Šâ€¦â€¦"', type: 'bad' },
            { text: 'ä½ æœ‰æ²¡æœ‰æƒ³è¿‡æ‰“èŒä¸šè”èµ›', effect: 6, reply: '"å½“ç„¶ï¼æˆ‘å¯æ˜¯è¦è¿›å›½å®¶é˜Ÿçš„ç”·äººï¼"', type: 'good' },
            { text: 'ä»Šæ™šä¸€èµ·å»åƒçƒ§çƒ¤?', effect: 9, reply: '"è¿™è¯æˆ‘çˆ±å¬ï¼é›†åˆï¼"', type: 'good' },
            { text: 'ä½ å¹³æ—¶ä¹Ÿçœ‹ä¹¦å—', effect: 4, reply: '"â€¦â€¦å¶å°”ã€‚ä½“è‚²æ‚å¿—ç®—å—ï¼Ÿ"', type: 'neutral' },
            { text: 'ä½ å—ä¼¤äº†è¦å»åŒ»é™¢', effect: 6, reply: '"æ²¡äº‹æ²¡äº‹ï¼Œæ“¦ç ´ç‚¹çš®è€Œå·²ï¼"', type: 'neutral' },
            { text: 'çƒåœºçš„äº‹å…¨é ä½ äº†', effect: 5, reply: '"æ”¾å¿ƒï¼Œæˆ‘ä¸ä¼šè®©å¤§å®¶å¤±æœ›çš„ï¼"', type: 'good' },
        ],
        'shen': [
            { text: 'ä½ ä»Šå¤©çœ‹èµ·æ¥æŒºå¥½çš„', effect: 5, reply: '"â€¦â€¦å°‘åºŸè¯ã€‚"ï¼ˆä½†å˜´è§’å¾®å¾®ä¸Šæ‰¬ï¼‰', type: 'neutral' },
            { text: 'é‚£å¤©å¤šè°¢ä½ å¸®æˆ‘', effect: 8, reply: '"â€¦â€¦æˆ‘æ²¡æœ‰å¸®ä½ ï¼Œåˆ«ä¹±è¯´ã€‚"ï¼ˆèƒŒè¿‡è„¸å»ï¼‰', type: 'good' },
            { text: 'ä½ ä¸ºä»€ä¹ˆæ€»æ˜¯é€ƒè¯¾?', effect: -4, reply: '"å…³ä½ ä»€ä¹ˆäº‹ã€‚"', type: 'bad' },
            { text: 'è¿™é¦–æ­Œæ˜¯ä½ åœ¨å¬å—', effect: 7, reply: '"â€¦â€¦ä½ ä¹Ÿå¬åœ°ä¸‹ä¹é˜Ÿï¼Ÿ"ï¼ˆéœ²å‡ºæƒŠè®¶è¡¨æƒ…ï¼‰', type: 'good' },
            { text: 'ä½ åº”è¯¥å¥½å¥½ä¸Šè¯¾', effect: -8, reply: '"ä½ å’Œé‚£äº›è€å¸ˆä¸€æ ·çƒ¦ã€‚"', type: 'bad' },
            { text: 'æˆ‘ä¸ä¼šå‘Šè¯‰åˆ«äººä½ æ‰“å·¥çš„äº‹', effect: 10, reply: '"â€¦â€¦ä½ ä¸ºä»€ä¹ˆè¦å¸®æˆ‘ã€‚"ï¼ˆæ²‰é»˜è‰¯ä¹…ï¼‰', type: 'good' },
            { text: 'æŸ“å‘å¥½çœ‹ï¼Œæ˜¯ä»€ä¹ˆé¢œè‰²?', effect: 6, reply: '"â€¦â€¦æ˜Ÿäº‘è“ã€‚ä½ çœ¼ç›ä¸é”™ã€‚"', type: 'good' },
            { text: 'ä½ å®¶é‡Œâ€¦â€¦è¿˜å¥½å—', effect: 5, reply: '"â€¦â€¦ç®¡å¥½ä½ è‡ªå·±ã€‚"ï¼ˆè¯­æ°”è½¯åŒ–äº†ï¼‰', type: 'neutral' },
            { text: 'å€Ÿä½ æœ¬ä¹¦', effect: 9, reply: '"â€¦â€¦è¿™æ˜¯ä½ å–œæ¬¢çš„ä¹¦å—ã€‚"ï¼ˆè½»è½»æ¥è¿‡ï¼‰', type: 'good' },
            { text: 'è·Ÿæˆ‘è¯´è¯´ä½ è¿‡å»çš„äº‹?', effect: -3, reply: '"æˆ‘è¯´äº†ï¼Œåˆ«é—®ã€‚"', type: 'bad' },
        ]
    };
    
    // ç¤¼ç‰©ç³»ç»Ÿ
    const GIFT_CATALOG = {
        'lin': [
            { name: 'æ¸…åå¤§å­¦å‘¨è¾¹çºªå¿µå†Œ', cost: 80, effect: 15, reply: '"è¿™â€¦â€¦è¿™æ­£æ˜¯æˆ‘æƒ³è¦çš„ï¼è°¢è°¢ä½ ï¼ï¼"' },
            { name: 'é«˜ä¸­æ•°å­¦è§£é¢˜å®å…¸', cost: 50, effect: 10, reply: '"æ­£å¥½æˆ‘ç¼ºè¿™æœ¬ï¼Œè°¢è°¢ä½ è®°å¾—ã€‚"' },
            { name: 'æ¸¸ä¹åœºé—¨ç¥¨', cost: 100, effect: -5, reply: '"â€¦â€¦æˆ‘æ²¡ç©ºå»è¿™ç§åœ°æ–¹ã€‚"' },
        ],
        'xia': [
            { name: 'æ‰‹å·¥é¢œæ–™å¥—è£…', cost: 120, effect: 18, reply: '"è¿™æ˜¯ä¸“ä¸šçº§çš„ï¼ä½ çœŸçš„å¤ªæ‡‚æˆ‘äº†ï¼"' },
            { name: 'æ¢µé«˜ç”»å†Œ', cost: 80, effect: 12, reply: '"å“‡ï¼æˆ‘æœ€å–œæ¬¢æ¢µé«˜ï¼ä½ æ€ä¹ˆçŸ¥é“ï¼"' },
            { name: 'æ•°å­¦ä¹ é¢˜é›†', cost: 30, effect: -8, reply: '"â€¦â€¦è°¢è°¢ï¼Œæˆ‘â€¦â€¦ä¸éœ€è¦è¿™ä¸ªã€‚"' },
        ],
        'jiang': [
            { name: 'NBAçºªå¿µç‰ˆçƒè¡£', cost: 150, effect: 18, reply: '"å“‡é ï¼è¿™æ˜¯æˆ‘æœ€å–œæ¬¢çš„çƒé˜Ÿï¼å¤ªä»—ä¹‰äº†ï¼"' },
            { name: 'è›‹ç™½ç²‰èƒ½é‡æ£’', cost: 60, effect: 10, reply: '"å…„å¼Ÿï¼Œä½ å¤ªæ‡‚æˆ‘äº†ï¼"' },
            { name: 'æ–‡å­¦åè‘—å…¨é›†', cost: 80, effect: -3, reply: '"å‘ƒâ€¦â€¦è°¢äº†ï¼Œæˆ‘â€¦â€¦ä¼šçœ‹çš„ã€‚"' },
        ],
        'shen': [
            { name: 'åœ°ä¸‹ä¹é˜Ÿä¸“è¾‘é»‘èƒ¶', cost: 100, effect: 20, reply: '"â€¦â€¦ä½ æ€ä¹ˆæ‰¾åˆ°è¿™å¼ çš„ã€‚"ï¼ˆçœ¼çœ¶å¾®çº¢ï¼‰', },
            { name: 'ä¾¿åˆ©åº—ç”œå“', cost: 30, effect: 8, reply: '"â€¦â€¦æˆ‘ä¸å–œæ¬¢ç”œçš„ã€‚ä½†è°¢è°¢ä½ ã€‚"ï¼ˆé»˜é»˜åƒæ‰ï¼‰' },
            { name: 'åŠ±å¿—æˆåŠŸå­¦ä¹¦', cost: 40, effect: -12, reply: '"ä½ è§‰å¾—æˆ‘éœ€è¦è¢«æ¿€åŠ±ï¼Ÿæ»šã€‚"' },
        ]
    };

    function renderStuCrushes() {
        let c = document.getElementById('stu-crush-container');
        c.innerHTML = '';
        CRUSHES.forEach(ch => {
            let data = stuGame.crushes[ch.id];
            if(!data) return;
            
            let aff = data.aff;
            let buffInfo = getCrushBuff(ch.id, aff);
            let buffTag = buffInfo && aff >= 30 ? `<div style="background:#fdf2f8; border:1px solid #f9a8d4; padding:4px 8px; border-radius:4px; font-size:0.7rem; color:#be185d; margin-bottom:5px;">âœ¨ å¥½æ„ŸBUFF: ${buffInfo.name} - ${buffInfo.desc}</div>` : '';
            
            // é€æ­¥è§£é”å±æ€§ä¿¡æ¯
            let attrInfo = '';
            if(aff >= 20) attrInfo += `<span style="font-size:0.65rem; background:#f0fdf4; color:#166534; padding:1px 4px; border-radius:3px; margin-right:3px;">çˆ±å¥½å·²è§£é”</span>`;
            if(aff >= 50) attrInfo += `<span style="font-size:0.65rem; background:#eff6ff; color:#1e40af; padding:1px 4px; border-radius:3px; margin-right:3px;">ç§˜å¯†å·²è§£é”</span>`;
            if(aff >= 80) attrInfo += `<span style="font-size:0.65rem; background:#faf5ff; color:#6b21a8; padding:1px 4px; border-radius:3px; margin-right:3px;">å¿ƒå£°å·²è§£é”</span>`;
            
            let html = `
            <div class="crush-card">
                <div class="crush-head">
                    <img src="src/love/${ch.id}.png" class="crush-img" style="width:70px;height:70px;cursor:pointer;" onclick="showCrushPortrait('${ch.id}')"
                        onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'70\\' height=\\'70\\'><circle cx=\\'35\\' cy=\\'35\\' r=\\'35\\' fill=\\'%23fbcfe8\\'/><text x=\\'50%\\' y=\\'50%\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' font-size=\\'16\\' fill=\\'%23be185d\\'>${ch.name[0]}</text></svg>'" title="ç‚¹å‡»æŸ¥çœ‹ç«‹ç»˜">
                    <div class="crush-info">
                        <h4>${ch.name} <span style="font-size:0.7rem;color:#f472b6;">[${ch.title}]</span></h4>
                        <p>${ch.desc}</p>
                        ${attrInfo}
                    </div>
                </div>
                ${buffTag}
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                    <span style="font-size:0.7rem;color:#be185d;font-weight:bold;">å¥½æ„Ÿåº¦ ${Math.floor(aff)}/100</span>
                    ${aff>=100?'<span style="font-size:0.7rem;color:#db2777;font-weight:bold;">ğŸ’– å¿ƒåŠ¨æ»¡æº¢</span>':''}
                </div>
                <div class="crush-bar-bg"><div class="crush-bar-fill" style="width:${Math.min(100,aff)}%"></div></div>
                <div class="crush-dialog" id="dialog-${ch.id}"></div>
                <div class="crush-actions">
                    <button class="btn" style="margin:0; font-size:0.75rem; padding:6px;" onclick="showDialogOptions('${ch.id}')">ğŸ’¬ é€‰æ‹©è¯é¢˜ (5èƒ½)</button>
                    <button class="btn" style="margin:0; font-size:0.75rem; padding:6px;" onclick="showDeepCrushDialog('${ch.id}')">ğŸ­ è§¦å‘åœºæ™¯å¯¹è¯ (5èƒ½)</button>
                    <button class="btn" style="margin:0; font-size:0.75rem; padding:6px;" onclick="showGiftMenu('${ch.id}')">ğŸ é€‰æ‹©ç¤¼ç‰©</button>
                    <button class="btn-main" style="grid-column:1/-1; margin:0; padding:8px; font-size:0.8rem; background:#db2777;" onclick="interactCrush('${ch.id}', 'confess')">ğŸ’˜ å‹‡æ•¢è¡¨ç™½ (50èƒ½)</button>
                </div>
            </div>`;
            c.innerHTML += html;
        });
    }
    
    const CRUSH_PROFILES = {
        'lin': {
            icon: 'ğŸ“š', color: '#be185d',
            intro: 'æ—çŸ¥ç§‹ï¼Œ17å²ï¼Œæ–‡ç§‘ç­ç­é•¿ï¼Œå…¨å¹´çº§ç¬¬ä¸€ã€‚å¥¹çš„ä¸–ç•Œåªæœ‰ä¸‰ç§é¢œè‰²ï¼šè¯•å·çš„ç™½ã€å¢¨æ°´çš„é»‘ã€æ¸…åæ ¡å¾½çš„ç´«ã€‚æ¯å¤©æ—©ä¸Šäº”ç‚¹èµ·åºŠï¼ŒèƒŒå•è¯ã€åšç¬”è®°ã€æ•´ç†é”™é¢˜æœ¬â€”â€”å¥¹ä¸å…è®¸è‡ªå·±çŠ¯é”™ï¼Œå› ä¸ºå¥¹çŸ¥é“ï¼Œä¸€æ—¦åœä¸‹æ¥ï¼Œé‚£äº›å‹ç€å¥¹çš„ä¸œè¥¿å°±ä¼šæŠŠå¥¹æ·¹æ²¡ã€‚',
            hobby: 'å†™è¯—ï¼ˆä»ä¸ç»™äººçœ‹ï¼‰ã€å¤œæ™šåœ¨å¤©å°æ•°æ˜Ÿæ˜Ÿ',
            fear: 'å®³æ€•è®©çˆ¶æ¯å¤±æœ›ï¼Œå®³æ€•å‘ç°åŠªåŠ›æ²¡æœ‰æ„ä¹‰',
            dream: 'è€ƒä¸Šæ¸…åï¼Œç„¶åâ€¦â€¦å¥¹è¿˜æ²¡æœ‰æƒ³è¿‡"ç„¶å"ã€‚',
            quote: '"æˆ‘ä¸æ˜¯å¤©æ‰ï¼Œæˆ‘åªæ˜¯ä¸æ•¢åœã€‚"'
        },
        'xia': {
            icon: 'ğŸ¨', color: '#7c3aed',
            intro: 'å¤æ™šæ™´ï¼Œ17å²ï¼Œè‰ºæœ¯ç‰¹é•¿ç”Ÿï¼Œæ ¡å¤–å…¼èŒæ¨¡ç‰¹ã€‚å¥¹æ˜¯é‚£ç§èµ°è¿›æ•™å®¤ä¼šè®©ç©ºæ°”éƒ½å˜å¾—ä¸åŒçš„äººâ€”â€”é¦™æ°´ã€æ•£å‘ã€æ°¸è¿œæ­ªæˆ´çš„å¸½å¾½ã€‚å¥¹è®¨åŒè§„åˆ™ï¼Œè®¨åŒæ ‡å‡†ç­”æ¡ˆï¼Œè®¨åŒä»»ä½•å‘Šè¯‰å¥¹"åº”è¯¥æ€æ ·"çš„äººã€‚ä½†å¾ˆå°‘æœ‰äººçŸ¥é“ï¼Œå¥¹æ¯å¤©æ·±å¤œéƒ½åœ¨ç”»ç”»ï¼Œç”»å¥¹é‚£ä¸ªåªæœ‰å¥¹è‡ªå·±èƒ½è¿›å…¥çš„ä¸–ç•Œã€‚',
            hobby: 'åœ°ä¸‹å±•è§ˆã€ç‹¬ç«‹éŸ³ä¹èŠ‚ã€åŠå¤œå†™ç”Ÿ',
            fear: 'å®³æ€•æœ‰ä¸€å¤©å†ä¹Ÿç”»ä¸å‡ºè®©è‡ªå·±æ„ŸåŠ¨çš„ä¸œè¥¿',
            dream: 'å»ç±³å…°ï¼Œå¼€ä¸€åœºåªå±äºè‡ªå·±çš„ä¸ªå±•',
            quote: '"æˆ‘ä¸æ˜¯åœ¨é€ƒè¯¾ï¼Œæˆ‘æ˜¯åœ¨æ‰¾çœŸæ­£çš„è¯¾ã€‚"'
        },
        'jiang': {
            icon: 'ğŸ€', color: '#0369a1',
            intro: 'æ±Ÿä¸€èˆŸï¼Œ18å²ï¼Œæ ¡ç¯®çƒé˜Ÿé˜Ÿé•¿ï¼Œä½“è‚²ç‰¹é•¿ç”Ÿã€‚ä»–æ˜¯é‚£ç§ä½ ä¸€çœ¼å°±ä¼šæ³¨æ„åˆ°çš„ç”·ç”Ÿâ€”â€”ä¸æ˜¯å› ä¸ºå¸…ï¼Œè€Œæ˜¯å› ä¸ºä»–èº«ä¸Šæœ‰ä¸€ç§è®©äººæ”¾æ¾çš„åŠ›é‡ã€‚ä»–å¤§å¤§å’§å’§ï¼Œä¹‰æ°”å½“å¤´ï¼Œå¯ä»¥ä¸ºäº†æœ‹å‹ç¿»å¢™å‡ºå»ä¹°å®µå¤œï¼Œä¹Ÿå¯ä»¥å¸¦ä¼¤ä¸Šåœºæ‰“å®Œå†³èµ›ã€‚å¾ˆå¤šäººä¸çŸ¥é“ä»–å³æ‰‹æœ‰ä¸€å¤„æ²¡æœ‰å®Œå…¨åº·å¤çš„æ—§ä¼¤ã€‚',
            hobby: 'NBAç›´æ’­ã€è¡—å¤´ç¯®çƒã€åƒçƒ§çƒ¤',
            fear: 'å®³æ€•æœ‰ä¸€å¤©æ‰“ä¸äº†çƒï¼Œå®³æ€•è¢«äººçœ‹å‡ºä»–å…¶å®ä¹Ÿä¼šç´¯',
            dream: 'è¿›çœé˜Ÿï¼Œç„¶åæ˜¯å›½å®¶é˜Ÿ',
            quote: '"è¾“äº†å¯ä»¥ï¼Œä½†ä¸èƒ½è¾“å¾—ä¸å¥½çœ‹ã€‚"'
        },
        'shen': {
            icon: 'ğŸŒ™', color: '#475569',
            intro: 'æ²ˆæ¸”ï¼Œ17å²ï¼Œä»å¤§åŸå¸‚è½¬æ¥çš„æ’ç­ç”Ÿï¼ŒæŸ“äº†ä¸€å¤´æ˜Ÿäº‘è“çš„å‘ï¼Œè€³æœºæ°¸è¿œæŒ‚åœ¨è„–å­ä¸Šã€‚å¥¹ä¸è·Ÿäººè¯´è¯ï¼Œä¸å‚åŠ ä»»ä½•æ´»åŠ¨ï¼Œè¯¾å ‚ä¸Šè¦ä¹ˆç¡è§‰è¦ä¹ˆçœ‹çª—å¤–ã€‚å…¨æ ¡éƒ½çŸ¥é“å¥¹æ˜¯"é—®é¢˜å­¦ç”Ÿ"ï¼Œä½†æ²¡æœ‰äººçŸ¥é“å¥¹æ¯å¤©æ”¾å­¦åå»å“ªé‡Œâ€”â€”å¥¹åœ¨ç»™å¼Ÿå¼Ÿçš„å­¦è´¹æ‰“å·¥ã€‚å¥¹çš„é˜²å¾¡å¿ƒæ˜¯ä¸€åº§åŸå¢™ï¼Œä½†åŸå¢™é‡Œé¢ï¼Œä½ç€ä¸€ä¸ªæåº¦æ¸´æœ›è¢«çœŸæ­£ç†è§£çš„äººã€‚',
            hobby: 'åœ°ä¸‹ä¹é˜Ÿã€æ·±å¤œä¾¿åˆ©åº—ã€ä¸€ä¸ªäººèµ°å¾ˆè¿œçš„è·¯',
            fear: 'å®³æ€•è¢«äººç”¨æ€œæ‚¯çš„çœ¼ç¥çœ‹å¾…',
            dream: 'è®©å¼Ÿå¼Ÿèƒ½å¥½å¥½ä¸Šå­¦ï¼Œè‡³äºè‡ªå·±â€¦â€¦èµ°ä¸€æ­¥çœ‹ä¸€æ­¥ã€‚',
            quote: '"åˆ«é—®æˆ‘ä¸ºä»€ä¹ˆï¼Œé—®äº†æˆ‘ä¹Ÿä¸ä¼šè¯´ã€‚"'
        }
    };

    function showCrushPortrait(cid) {
        let ch = CRUSHES.find(x=>x.id===cid);
        let aff = (stuGame.crushes[cid] && stuGame.crushes[cid].aff) || 0;
        let prof = CRUSH_PROFILES[cid];
        
        let secrets = '';
        if(aff >= 50) secrets += `<div style="background:#f5f3ff;border-left:3px solid #8b5cf6;padding:8px 10px;border-radius:0 6px 6px 0;margin-top:8px;"><span style="color:#7c3aed;font-size:0.7rem;font-weight:bold;">ğŸ’œ è§£é”ç§˜å¯†ï¼ˆå¥½æ„Ÿâ‰¥50ï¼‰</span><p style="margin:4px 0 0;font-size:0.8rem;color:#475569;">${cid==='lin'?'å¥¹åœ¨å¤©å°ä¸Šå†™äº†ä¸‰å¹´è¯—ï¼Œä»æœªè®©ä»»ä½•äººçœ‹è¿‡ã€‚æœ‰ä¸€é¦–å†™çš„æ˜¯"å¦‚æœå¯ä»¥ï¼Œæˆ‘æƒ³åœ¨å®‡å®™è¾¹ç•Œå’Œä½ ä¸€èµ·è¿·è·¯"ã€‚':cid==='xia'?'å¥¹çš„æ¯äº²æ˜¯ä½ä¸¥è‹›çš„é’¢ç´è€å¸ˆï¼Œå¥¹ç”»ç”»æœ€åˆåªæ˜¯é€ƒç¦»ç´å£°çš„æ–¹å¼ï¼Œå´æ„å¤–å˜æˆäº†å¥¹å”¯ä¸€çš„å‡ºå£ã€‚':cid==='jiang'?'ä»–å³æ‰‹æœ‰ä¸€å¤„æ—§ä¼¤æ²¡æœ‰å®Œå…¨åº·å¤ï¼Œä½†ä»–åœ¨å†³èµ›å‰æ²¡æœ‰å‘Šè¯‰ä»»ä½•äººã€‚é‚£åœºçƒï¼Œä»–æ‰“å®Œå°±å»åŒ»åŠ¡å®¤æ‰“äº†å°é—­é’ˆã€‚':'å¥¹åœ¨æ‰“å·¥å…»å¼Ÿå¼Ÿä¸Šå­¦ï¼Œæ¯æœˆå·¥èµ„è½¬ç»™å®¶é‡Œï¼Œè‡ªå·±åªç•™ç”Ÿæ´»è´¹ã€‚å­¦æ ¡é‡Œæ²¡æœ‰ä¸€ä¸ªäººçŸ¥é“ã€‚'}</p></div>`;
        if(aff >= 80) secrets += `<div style="background:#fdf2f8;border-left:3px solid #ec4899;padding:8px 10px;border-radius:0 6px 6px 0;margin-top:8px;"><span style="color:#be185d;font-size:0.7rem;font-weight:bold;">ğŸ’– å¿ƒé‡Œè¯ï¼ˆå¥½æ„Ÿâ‰¥80ï¼‰</span><p style="margin:4px 0 0;font-size:0.8rem;color:#475569;font-style:italic;">${cid==='lin'?'"æˆ‘æƒ³è€ƒæ¸…åï¼Œä½†å¦‚æœå¯ä»¥çš„è¯â€¦â€¦æˆ‘å¸Œæœ›æˆ‘ä»¬èƒ½åœ¨åŒä¸€åº§åŸå¸‚ã€‚è¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡ï¼ŒæŠŠä¸€ä¸ªäººæ”¾è¿›æˆ‘çš„è®¡åˆ’é‡Œã€‚"':cid==='xia'?'"æˆ‘æ€•æˆ‘çœŸçš„ä¼šçˆ±ä¸Šä½ ã€‚ä½ å‡ºç°å¾—ä¸æ˜¯æ—¶å€™ï¼Œæˆ‘è¿˜æ²¡å‡†å¤‡å¥½è®©ä¸€ä¸ªäººçœ‹è§æˆ‘æ²¡ç”»å®Œçš„é‚£äº›ç”»ã€‚"':cid==='jiang'?'"ä½ æ˜¯æˆ‘é™¤äº†çƒä»¥å¤–ï¼Œç¬¬ä¸€ä¸ªè®©æˆ‘æƒ³è®¤çœŸä¿æŠ¤çš„äººã€‚è¿™è¯æˆ‘æ²¡è·Ÿä»»ä½•äººè¯´è¿‡ã€‚"':'"è°¢è°¢ä½ æ²¡æœ‰ç”¨é‚£ç§çœ¼ç¥çœ‹æˆ‘â€¦â€¦ä½ çŸ¥é“é‚£ç§çœ¼ç¥ã€‚è°¢è°¢ä½ è®©æˆ‘è§‰å¾—ï¼Œæˆ‘ä¹Ÿæ˜¯ä¸ªæ™®é€šäººã€‚"'}</p></div>`;
        
        showCustomModal(`${ch.name} Â· ${ch.title}`, `
            <div style="display:flex;gap:15px;align-items:flex-start;flex-wrap:wrap;">
                <div style="text-align:center;flex-shrink:0;">
                    <img src="src/avatar/${cid}.png" style="max-width:160px;max-height:220px;border-radius:8px;border:3px solid #f9a8d4;"
                        onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                    <div style="display:none;width:120px;height:160px;background:linear-gradient(135deg,#fdf2f8,#fce7f3);border-radius:8px;align-items:center;justify-content:center;border:3px dashed #f9a8d4;flex-direction:column;">
                        <div style="font-size:3rem;">${prof.icon}</div>
                        <div style="font-size:0.8rem;color:${prof.color};margin-top:8px;font-weight:bold;">${ch.name}</div>
                    </div>
                    <div style="margin-top:8px;background:#fdf2f8;border-radius:6px;padding:6px 10px;">
                        <div style="font-size:0.7rem;color:#be185d;font-weight:bold;">å¥½æ„Ÿåº¦</div>
                        <div style="background:#f1f5f9;height:6px;border-radius:3px;overflow:hidden;margin-top:4px;">
                            <div style="background:linear-gradient(90deg,#f472b6,#db2777);height:100%;width:${Math.min(100,aff)}%;transition:0.3s;"></div>
                        </div>
                        <div style="font-size:0.7rem;color:#64748b;margin-top:2px;">${Math.floor(aff)}/100</div>
                    </div>
                </div>
                <div style="flex:1;min-width:200px;text-align:left;">
                    <h3 style="color:${prof.color};margin:0 0 8px;">${ch.name} <span style="font-size:0.8rem;color:#94a3b8;">Â· ${ch.title}</span></h3>
                    <p style="font-size:0.82rem;color:#475569;line-height:1.6;margin:0 0 10px;">${prof.intro}</p>
                    <div style="display:flex;flex-direction:column;gap:5px;font-size:0.8rem;">
                        <div style="background:#f8fafc;padding:6px 10px;border-radius:6px;"><span style="color:#64748b;font-weight:bold;">çˆ±å¥½ï¼š</span>${prof.hobby}</div>
                        <div style="background:#f8fafc;padding:6px 10px;border-radius:6px;"><span style="color:#64748b;font-weight:bold;">å®³æ€•ï¼š</span>${prof.fear}</div>
                        <div style="background:#f8fafc;padding:6px 10px;border-radius:6px;"><span style="color:#64748b;font-weight:bold;">æ¢¦æƒ³ï¼š</span>${prof.dream}</div>
                        <div style="background:#fdf2f8;padding:8px 10px;border-radius:6px;border-left:3px solid ${prof.color};font-style:italic;color:#475569;">"${prof.quote}"</div>
                    </div>
                    ${secrets}
                </div>
            </div>`, [{text:'å…³é—­', action:()=>{}}]);
    }
    
    function showDialogOptions(cid) {
        if(stuGame.energy < 5) return showToast("ç²¾åŠ›ä¸è¶³ï¼ˆéœ€è¦5ç‚¹ï¼‰");
        let ch = CRUSHES.find(x=>x.id===cid);
        let options = CRUSH_DIALOGUE_OPTIONS[cid] || [];
        let selected = [...options].sort(()=>Math.random()-0.5).slice(0,5);
        let curAff = (stuGame.crushes[cid]&&stuGame.crushes[cid].aff)||0;
        let html = `<p style="color:#64748b; font-size:0.85rem; margin-top:0;">å’Œ ${ch.name} èŠä»€ä¹ˆï¼Ÿï¼ˆå½“å‰å¥½æ„Ÿï¼š<b style="color:#db2777;">${Math.floor(curAff)}</b>/100ï¼‰</p>
        <div style="display:flex;flex-direction:column;gap:8px;">`;
        selected.forEach((opt) => {
            let idx = options.indexOf(opt);
            html += `<button class="btn" style="text-align:left;padding:12px 14px;font-size:0.9rem;" onclick="pickDialogOption('${cid}',${idx})">${opt.text}</button>`;
        });
        html += '</div>';
        showCustomModal(`ğŸ’¬ å’Œ ${ch.name} èŠå¤©`, html, [{text:'ç®—äº†ï¼Œä¸è¯´äº†', action:()=>{}}]);
    }
    
    function pickDialogOption(cid, optIdx) {
        stuGame.energy -= 5;
        let ch = CRUSHES.find(x=>x.id===cid);
        let opt = CRUSH_DIALOGUE_OPTIONS[cid][optIdx];
        let data = stuGame.crushes[cid];
        let oldAff = data.aff;
        data.aff = Math.max(0, Math.min(100, data.aff + opt.effect));
        let delta = Math.round(data.aff - oldAff);
        let deltaStr = delta > 0 ? `<span style="color:#10b981;font-weight:bold;font-size:1.1rem;">+${delta} å¥½æ„Ÿ ğŸ’š</span>` : delta < 0 ? `<span style="color:#ef4444;font-weight:bold;font-size:1.1rem;">${delta} å¥½æ„Ÿ â¤ï¸â€ğŸ”¥</span>` : `<span style="color:#f59e0b;font-weight:bold;">æ— å˜åŒ– ğŸ’›</span>`;
        let resultHtml = `<div style="background:#f8fafc;border-radius:8px;padding:12px;margin-bottom:12px;border-left:3px solid #cbd5e1;">
            <p style="margin:0;font-size:0.9rem;color:#475569;font-style:italic;">"${opt.reply}"</p>
        </div>
        <div style="text-align:center;padding:8px;">${deltaStr}<br><span style="font-size:0.8rem;color:#64748b;">å½“å‰å¥½æ„Ÿï¼š${Math.floor(data.aff)}/100</span></div>`;
        showCustomModal(`ğŸ’¬ ${ch.name} çš„å›åº”`, resultHtml, [{text:'æ˜ç™½äº†', action:()=>{ checkCrushBuff(cid); renderStuCrushes(); updateStuUI(); }}]);
    }
    
    function showGiftMenu(cid) {
        let ch = CRUSHES.find(x=>x.id===cid);
        let gifts = GIFT_CATALOG[cid] || [];
        let html = `<p style="color:#64748b; font-size:0.85rem; margin-top:0;">é€‰æ‹©ä¸€ä»½ç¤¼ç‰©é€ç»™ ${ch.name}ï¼š</p><div style="display:flex;flex-direction:column;gap:8px;">`;
        gifts.forEach((g, i) => {
            html += `<button class="btn" style="text-align:left; padding:10px 12px;" onclick="giveGift('${cid}',${i})">
                ğŸ ${g.name} <span style="color:#94a3b8; font-size:0.75rem;">ï¿¥${g.cost}</span>
            </button>`;
        });
        html += '</div>';
        showCustomModal(`ğŸ ç»™ ${ch.name} é€ç¤¼ç‰©`, html, [{text:'å–æ¶ˆ', action:()=>{}}]);
    }
    
    function giveGift(cid, giftIdx) {
        let gifts = GIFT_CATALOG[cid];
        let g = gifts[giftIdx];
        if(stuGame.money < g.cost) return showToast("é›¶èŠ±é’±ä¸è¶³ï¼");
        stuGame.money -= g.cost;
        let data = stuGame.crushes[cid];
        data.aff = Math.max(0, Math.min(100, data.aff + g.effect));
        showToast(g.effect > 0 ? `ğŸ’ ${CRUSHES.find(x=>x.id===cid).name} ä¼¼ä¹å¾ˆå–œæ¬¢è¿™ä»½ç¤¼ç‰©` : `ğŸ’” è¿™ä»½ç¤¼ç‰©å¥½åƒæ²¡é€åˆ°å¿ƒåé‡Œâ€¦â€¦`);
        let dBox = document.getElementById(`dialog-${cid}`);
        if(dBox) { dBox.style.display='block'; dBox.innerText = g.reply; }
        checkCrushBuff(cid);
        renderStuCrushes();
        updateStuUI();
    }
    
    function checkCrushBuff(cid) {
        let data = stuGame.crushes[cid];
        if(data && data.aff >= 30) {
            let b = getCrushBuff(cid, data.aff);
            if(b) b.apply();
        }
    }
    function renderStuFriends() {
        let c = document.getElementById('stu-friends-container');
        c.innerHTML = FRIENDS.map(f => {
            let has = stuGame.friends.includes(f.id);
            return `<div class="friend-card ${has?'active':''}">
                <div><b>${f.name}</b><br><span style="font-size:0.75rem">${f.desc}</span></div>
                ${has?'<span style="color:var(--success);font-weight:bold;">å·²ç»“äº¤</span>':`<button class="btn" style="margin:0;padding:4px;" onclick="buyFriend('${f.id}',${f.cost})">ç»“äº¤ ï¿¥${f.cost}</button>`}
            </div>`;
        }).join('');
    }
    function buyFriend(id, cost) {
        if(stuGame.money >= cost) {
            stuGame.money -= cost;
            stuGame.friends.push(id);
            renderStuFriends();
            updateStuUI();
        } else showToast("é›¶èŠ±é’±ä¸è¶³");
    }

    function organizeExam() { 
        if(!payCost(3,2)) return;
        game.eduPoints += 3;
        
        let total = game.students;
        let baseScore = game.grade * 6 + 150; 
        
        let t_qb = Math.floor(total * (baseScore > 680 ? (baseScore-680)/400 : 0)); 
        let t_985 = Math.floor(total * (baseScore > 600 ? (baseScore-600)/350 : 0)); 
        let t_211 = Math.floor(total * (baseScore > 550 ? (baseScore-550)/300 : 0)); 
        let t_bk = Math.floor(total * (baseScore > 450 ? (baseScore-450)/250 : 0)); 
        let t_zk = Math.floor(total * (baseScore > 300 ? (baseScore-300)/200 : 0)); 
        
        t_985 = Math.max(0, t_985 - t_qb);
        t_211 = Math.max(0, t_211 - t_985 - t_qb);
        t_bk = Math.max(0, t_bk - t_211 - t_985 - t_qb);
        t_zk = Math.max(0, t_zk - t_bk - t_211 - t_985 - t_qb);
        let t_fail = Math.max(0, total - t_qb - t_985 - t_211 - t_bk - t_zk);
        
        let upline = total - t_fail;
        let uplinePct = Math.floor(upline/total*100);
        let repGain = Math.floor(t_qb * 2 + t_985 * 1 + uplinePct * 0.5);
        game.reputation += repGain;
        
        let html = `
        <div class="chart-container" style="width:100%;">
            <div class="chart-col"><div class="chart-bar" style="background:#ef4444; height:${Math.max(2, (t_qb/total)*150)}px;">${t_qb}</div><div class="chart-label">æ¸…åŒ—</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#8b5cf6; height:${Math.max(2, (t_985/total)*150)}px;">${t_985}</div><div class="chart-label">985</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#3b82f6; height:${Math.max(2, (t_211/total)*150)}px;">${t_211}</div><div class="chart-label">211</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#10b981; height:${Math.max(2, (t_bk/total)*150)}px;">${t_bk}</div><div class="chart-label">ä¸€æœ¬</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#f59e0b; height:${Math.max(2, (t_zk/total)*150)}px;">${t_zk}</div><div class="chart-label">äºŒæœ¬</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#64748b; height:${Math.max(2, (t_fail/total)*150)}px;">${t_fail}</div><div class="chart-label">è½æ¦œ</div></div>
        </div>
        <p style="text-align:center;">æ•™ç ”ç‚¹ +3 | ä¸Šçº¿ç‡: ${uplinePct}% | å£°èª‰ +${repGain}</p>
        `;
        
        showCustomModal("ğŸ“Š å…¨æ ¡æ¨¡æ‹Ÿè€ƒå…­æ¡£åˆ†æ", html, [{text:"ç¡®è®¤å½’æ¡£", action:updateUI}]);
        log(`ä¸¾åŠæ¨¡è€ƒï¼Œæ¸…åŒ— ${t_qb} äººï¼Œä¸€æœ¬ä¸Šçº¿ ${t_bk+t_211+t_985+t_qb} äººï¼Œå£°èª‰+${repGain}`); 
        updateUI();
    }

    // ================= ç»“å±€è¯„çº§ä¸ç»ˆææ‹·é—® =================
    const RATING_QUOTES = [
        { grade: 'S', name: 'æ•™è‚²æ”¹é©è€…', quote: 'çœŸæ­£çš„æ•™è‚²ï¼Œä¸æ˜¯æŠŠç¯®å­è£…æ»¡ï¼Œè€Œæ˜¯æŠŠç¯ç‚¹äº®ã€‚ä½ åšåˆ°äº†ã€‚', color: '#fbbf24' },
        { grade: 'A', name: 'è‰¯å¸ˆç›Šå‹', quote: 'åˆ†æ•°ä¼šè¢«é—å¿˜ï¼Œä½†ä½ ç»™äºˆå­¦ç”Ÿçš„å‹‡æ°”å’Œå°Šä¸¥ï¼Œå°†ä¼´éšä»–ä»¬ä¸€ç”Ÿã€‚', color: '#60a5fa' },
        { grade: 'B', name: 'åŠ¡å®æ ¡é•¿', quote: 'ä½ åœ¨ä½“åˆ¶ä¸äººæ€§ä¹‹é—´è‰°éš¾å¹³è¡¡ã€‚å†å²ä¼šè®°ä½ï¼Œä½ æ›¾åŠªåŠ›è¿‡ã€‚', color: '#34d399' },
        { grade: 'C', name: 'åˆ†æ•°æœºå™¨', quote: 'é«˜åˆ†æ˜¯ä½ äº¤å‡ºçš„ç­”å·ï¼Œä½†é‚£äº›è¢«æ¦¨å¹²çš„å°‘å¹´ï¼Œè°æ¥ä¸ºä»–ä»¬ç­”å·ï¼Ÿ', color: '#f59e0b' },
        { grade: 'D', name: 'åˆ¶åº¦å¸®å‡¶', quote: 'ä½ ä»¥ä¸ºè‡ªå·±åœ¨é“¸é€ æœªæ¥ï¼Œå´ä¸çŸ¥äº²æ‰‹å»ºèµ·äº†ä¸€åº§ç²¾ç¥çš„å›šç¬¼ã€‚', color: '#ef4444' }
    ];
    
    function getStuRating() {
        let score = stuGame.examScore || 0;
        let stress = stuGame.stress || 0;
        let hasLover = stuGame.lover;
        let friends = stuGame.friends.length;
        let pts = 0;
        if(score >= 680) pts = 90;
        else if(score >= 620) pts = 75;
        else if(score >= 550) pts = 60;
        else if(score >= 450) pts = 45;
        else pts = 25;
        if(hasLover) pts += 10;
        pts += friends * 3;
        if(stuGame.isInsured) pts += 15;
        if(stress >= 90) pts -= 25;
        else if(stress >= 70) pts -= 10;
        const STU_RATINGS = [
            { grade: 'S', name: 'å…¨é¢å‘å±•çš„é’æ˜¥', quote: 'ä½ ç”¨åˆ†æ•°è¯æ˜äº†è‡ªå·±ï¼Œä¹Ÿç”¨æ¸©åº¦ç•™ä½äº†åˆ«äººã€‚è¿™æ ·çš„é«˜ä¸­æ—¶å…‰ï¼Œå€¼å¾—è¢«é“­è®°ã€‚', color: '#fbbf24' },
            { grade: 'A', name: 'æ— æ‚”çš„å°‘å¹´', quote: 'æˆç»©ä¸æ˜¯ä½ å”¯ä¸€çš„å‹‹ç« ã€‚é‚£äº›ç¬‘è¿‡ã€å“­è¿‡ã€çˆ±è¿‡çš„ç¬é—´ï¼Œæ‰æ˜¯çœŸæ­£å±äºä½ çš„è´¢å¯Œã€‚', color: '#60a5fa' },
            { grade: 'B', name: 'æ™®é€šå´çœŸå®', quote: 'ä½ æ²¡æœ‰æˆä¸ºåˆ«äººæœŸå¾…çš„æ ·å­ï¼Œä½†ä½ ä¸€ç›´æ˜¯ä½ è‡ªå·±ã€‚è¿™å·²ç»å¾ˆäº†ä¸èµ·äº†ã€‚', color: '#34d399' },
            { grade: 'C', name: 'è¢«åˆ†æ•°åå™¬çš„ä¸‰å¹´', quote: 'ä½ èµ¢äº†è€ƒè¯•ï¼Œå´è¾“äº†ä¸€äº›æ›´çè´µçš„ä¸œè¥¿ã€‚å¸Œæœ›å¤§å­¦èƒ½ç»™ä½ é‡æ–°è®¤è¯†è‡ªå·±çš„æœºä¼šã€‚', color: '#f59e0b' },
            { grade: 'D', name: 'è¿˜æ²¡å¼€å§‹å°±ç»“æŸäº†', quote: 'ä¸‰å¹´ï¼Œä½ æ‰›ç€æ¯”åŒé¾„äººæ›´é‡çš„ä¸œè¥¿ã€‚æ— è®ºç»“æœå¦‚ä½•ï¼Œä½ æ’‘ä¸‹æ¥äº†ã€‚è¿™å·²ç»æ˜¯è‹±é›„ã€‚', color: '#ef4444' }
        ];
        if(pts >= 85) return STU_RATINGS[0];
        if(pts >= 65) return STU_RATINGS[1];
        if(pts >= 45) return STU_RATINGS[2];
        if(pts >= 25) return STU_RATINGS[3];
        return STU_RATINGS[4];
    }

    // ========== 20+ç§å­¦ç”Ÿç»“å±€ç³»ç»Ÿ ==========
    function getStudentEnding() {
        let score = stuGame.examScore || 0;
        let stress = stuGame.stress || 0;
        let isInsured = stuGame.isInsured;
        let hasLover = stuGame.lover;
        let loverName = stuGame.loverName;
        let friends = stuGame.friends.length;
        let money = stuGame.money || 0;
        // å…³é”®èŠ‚ç‚¹æ ‡è®° (ä»æ¸¸æˆè¿‡ç¨‹ä¸­æ”¶é›†)
        let flags = stuGame.endingFlags || {};
        
        // ä¼˜å…ˆçº§æœ€é«˜çš„ç‰¹æ®Šç»“å±€
        if(isInsured) return {
            id:'E_OLYMPIAD', icon:'ğŸ…', name:'ç«èµ›ä¿é€ä¹‹è·¯',
            title:'å¥¥èµ›ä¿é€ï¼Œç›´è¾¾æ¸…åŒ—',
            desc:`ä½ åœ¨ç«èµ›ä¸­å±•ç°äº†è¶…è¶Šå¸¸äººçš„å¤©èµ‹ï¼Œç»•è¿‡äº†é«˜è€ƒè¿™æ¡ç‹¬æœ¨æ¡¥ï¼Œç›´æ¥è¢«æ¸…åå¤§å­¦å½•å–ã€‚
ç«™åœ¨æ¸…åå›­é‡Œï¼Œä½ æ„è¯†åˆ°ï¼šçœŸæ­£è®©ä½ èµ°åˆ°è¿™é‡Œçš„ï¼Œä¸æ˜¯é‚£äº›åšäº†æ— æ•°éçš„çœŸé¢˜ï¼Œè€Œæ˜¯é‚£ä¸ªå‡Œæ™¨ä¸¤ç‚¹ä»åœ¨æ”»å…‹éš¾é¢˜ã€çœ¼ç›å‘äº®çš„è‡ªå·±ã€‚`,
            color:'#fbbf24', emoji:'ğŸ“'
        };
        if(stress >= 95 && score < 400) return {
            id:'E_BREAKDOWN', icon:'ğŸ’”', name:'è¢«å‹å®çš„å°‘å¹´',
            title:'é«˜è€ƒå‰å¤•çš„å´©æºƒ',
            desc:`é«˜è€ƒå‰ä¸‰å¤©ï¼Œä½ è¯·äº†ç—…å‡ã€‚ä¸æ˜¯èº«ä½“ï¼Œæ˜¯å¿ƒã€‚åŒ»ç”Ÿè¯´ä½ æ˜¯é‡åº¦ç„¦è™‘ï¼Œéœ€è¦ä¼‘æ¯ã€‚
ä½ æ²¡æœ‰å‚åŠ é«˜è€ƒã€‚è¿™åœ¨å½“æ—¶åƒä¸€åœºåœ°éœ‡ï¼Œä½†äº”å¹´åï¼Œå½“ä½ åœ¨ä¸€å®¶å’–å•¡é¦†é‡Œåšç€è‡ªå·±å–œæ¬¢çš„äº‹ï¼Œä½ æœ‰æ—¶ä¼šæƒ³ï¼šä¹Ÿè®¸é‚£æ¬¡å´©æºƒï¼Œæ‰æ˜¯çœŸæ­£çš„æ‹¯æ•‘ã€‚`,
            color:'#6366f1', emoji:'ğŸŒ±'
        };
        if(flags.dropout) return {
            id:'E_DROPOUT', icon:'ğŸ’', name:'ä¸­é€”é€€å­¦',
            title:'æˆ‘é€‰æ‹©äº†å¦ä¸€æ¡è·¯',
            desc:`ä½ åœ¨é«˜äºŒé€€äº†å­¦ã€‚æ‰€æœ‰äººéƒ½è¯´ä½ ç–¯äº†ï¼Œä½ å¦ˆå“­äº†ä¸‰å¤©ã€‚
ä¸‰å¹´åï¼Œä½ çš„æ‰‹å·¥çš®å…·å“ç‰Œåœ¨ç½‘ä¸Šçˆ†çº¢ï¼Œæœˆè¥ä¸šé¢è¶…è¿‡äº†ç­ä¸Šå¤§å¤šæ•°åŒå­¦çš„å·¥èµ„ã€‚ä½ ä¸çŸ¥é“è¿™ç®—ä¸ç®—æˆåŠŸï¼Œä½†ä½ çŸ¥é“ï¼Œé‚£å¤©è¿ˆå‡ºæ ¡é—¨çš„è‡ªå·±ï¼Œæ¯”ä»»ä½•æ—¶å€™éƒ½è¯šå®ã€‚`,
            color:'#f59e0b', emoji:'âœ‚ï¸'
        };
        if(hasLover && score < 450) return {
            id:'E_EARLY_LOVE', icon:'ğŸ’•', name:'çˆ±æƒ…ï¼Œæ¯”æˆç»©æ›´é‡',
            title:'åˆ†æ•°ä¸é«˜ï¼Œä½†å¿ƒé‡Œæœ‰äºº',
            desc:`ä½ æ²¡è€ƒä¸Šä»€ä¹ˆå¥½å¤§å­¦ï¼Œä½†ä½ å’Œ${loverName}åœ¨åŒä¸€åº§åŸå¸‚ï¼Œè¯»ç€ä¸åŒçš„å­¦æ ¡ã€‚
å‘¨æœ«çš„æ—¶å€™ä½ ä»¬éª‘ç€å•è½¦å»åƒè·¯è¾¹æ‘Šï¼Œå¥¹/ä»–è¯´è¿™æ¯”ä¸Šæ¸…åæ›´å¹¸ç¦ã€‚ä¹Ÿè®¸å§ã€‚ä½†ä½ ç§ä¸‹é‡Œï¼Œä»ç„¶åœ¨å­¦ä¸€é—¨æŠ€èƒ½â€”â€”ä¸æ˜¯ä¸ºäº†è¯æ˜ä»€ä¹ˆï¼Œåªæ˜¯ä¸æƒ³è®©å¥¹/ä»–çš„å°†æ¥ï¼Œå› ä¸ºä½ è€Œå˜çª„ã€‚`,
            color:'#f472b6', emoji:'ğŸ’•'
        };
        if(flags.workToStudy && money >= 2000) return {
            id:'E_WORKER', icon:'ğŸ”§', name:'æ‰“å·¥ä»”çš„é€†è¢­',
            title:'ä¸€è¾¹æ‰“å·¥ï¼Œä¸€è¾¹è¯»ä¹¦',
            desc:`ä½ é«˜ä¸­ä¸‰å¹´éƒ½åœ¨æ‰“å·¥è¡¥è´´å®¶ç”¨ã€‚æˆç»©ä¸ç®—é¡¶å°–ï¼Œä½†ä½ çš„è‡ªå¾‹å’Œåƒè‹¦ç²¾ç¥è®©ä½ åœ¨å¤§å­¦ä¸€æ¯•ä¸šå°±å‡äº†ç»„é•¿ã€‚
ä¸‰åå²çš„ä½ ç®¡ç€äºŒåä¸ªäººï¼Œä½ å¯¹ä»–ä»¬è¯´ï¼šæˆ‘æ²¡ä¸Šè¿‡985ï¼Œä½†æˆ‘ä¸Šè¿‡æ¯”985æ›´éš¾çš„å­¦æ ¡â€”â€”ç”Ÿæ´»ã€‚`,
            color:'#10b981', emoji:'ğŸ’ª'
        };
        if(score >= 680) return {
            id:'E_ELITE', icon:'ğŸ“', name:'æ¸…åŒ—ä¹‹è·¯',
            title:'é¡¶å°–åæ ¡ï¼Œè£è€€ä¸ä»£ä»·',
            desc:`ä½ å¦‚æ„¿è€ƒä¸Šäº†é¡¶å°–åæ ¡ã€‚å¼€å­¦ç¬¬ä¸€å¤©ç«™åœ¨æœªåæ¹–è¾¹ï¼Œä½ è§‰å¾—ä¸‰å¹´çš„è¾›è‹¦å€¼äº†ã€‚
ä½†å¤§äºŒçš„æŸä¸ªæ·±å¤œï¼Œä½ å¯¹ç€å¤©èŠ±æ¿æƒ³ï¼šæˆ‘å–œæ¬¢ä»€ä¹ˆï¼Ÿæˆ‘ä¸ºä»€ä¹ˆåœ¨è¿™é‡Œï¼Ÿé‚£ä¸ªé—®é¢˜æ‚¬åœ¨ç©ºä¸­ï¼Œè‡³ä»Šæ²¡æœ‰ç­”æ¡ˆã€‚
æˆåŠŸæœ‰æ—¶å€™æ˜¯ä¸€ä¸ªæ¼‚äº®çš„ç‰¢ç¬¼â€”â€”ä½†è‡³å°‘ï¼Œæ˜¯ä½ è‡ªå·±é€‰çš„ã€‚`,
            color:'#ef4444', emoji:'ğŸ›ï¸'
        };
        if(score >= 600 && friends >= 3) return {
            id:'E_985_SOCIAL', icon:'ğŸ¤', name:'985+äººç”Ÿèµ¢å®¶',
            title:'æˆç»©ä¸å‹æƒ…ï¼Œéƒ½æ²¡è½ä¸‹',
            desc:`985é«˜æ ¡ï¼ŒåŠ ä¸Šä¸‰ä¸ªçœŸæ­£çš„æœ‹å‹ã€‚ä½ å¤§å­¦å››å¹´æœ€å¸¸è¢«é—®çš„é—®é¢˜æ˜¯ï¼šä½ å½“å¹´é«˜ä¸­æ˜¯æ€ä¹ˆè¿‡çš„ï¼Ÿ
ä½ æƒ³äº†æƒ³ï¼Œè¯´ï¼šæŒºå¥½çš„ï¼Œæœ‰äººé™ªã€‚é‚£æ˜¯å®è¯ã€‚`,
            color:'#3b82f6', emoji:'ğŸ‘¥'
        };
        if(score >= 550) return {
            id:'E_211', icon:'ğŸ“š', name:'211æœ¬ç§‘ï¼Œç¨³æ‰ç¨³æ‰“',
            title:'ä¸ç®—é¡¶å°–ï¼Œä½†å¤Ÿç”¨ä¸€ç”Ÿ',
            desc:`211å¤§å­¦ï¼Œä¸­ç­‰æˆç»©ï¼Œæ™®é€šä½†è¸å®çš„é’æ˜¥ã€‚
ä½ æ²¡æœ‰æˆä¸ºä¼ è¯´ï¼Œä½†ä½ æœ‰äº†ä¸€ä»½ç¨³å®šçš„å·¥ä½œï¼Œå…»äº†ä¸€åªçŒ«ï¼Œæ¯é€¢å‡æœŸå›åˆ°è¿™åº§åŸå¸‚ï¼Œç«™åœ¨å­¦æ ¡é—¨å£ï¼Œä½ ä¼šæƒ³ï¼šä¸‰å¹´ï¼Œä¹ŸæŒºå¥½çš„ã€‚`,
            color:'#8b5cf6', emoji:'ğŸ¯'
        };
        if(score >= 450) return {
            id:'E_REEXAM', icon:'ğŸ”„', name:'å¤è¯»ä¸€å¹´ï¼Œé‡æ–°å‡ºå‘',
            title:'å†æ¥ä¸€å¹´ï¼Œæˆ‘ä¸ç”˜å¿ƒ',
            desc:`ä¸€æœ¬çº¿å·®äº†ä¸€ç‚¹ã€‚ä½ é€‰æ‹©äº†å¤è¯»ã€‚é‚£ä¸€å¹´æ˜¯ä½ äººç”Ÿé‡Œæœ€å­¤ç‹¬çš„ä¸€å¹´â€”â€”åŒå­¦éƒ½èµ°äº†ï¼Œä½ ä¸€ä¸ªäººååœ¨æ•™å®¤é‡Œã€‚
ç¬¬äºŒå¹´ï¼Œä½ è€ƒä¸Šäº†æ»¡æ„çš„å­¦æ ¡ã€‚ä½†è®©ä½ çœŸæ­£æˆé•¿çš„ï¼Œæ˜¯å¤è¯»é‚£ä¸€å¹´çš„æ²‰é»˜ä¸åšæŒã€‚`,
            color:'#f59e0b', emoji:'ğŸŒ…'
        };
        if(score >= 300) return {
            id:'E_ORDINARY', icon:'ğŸŒ±', name:'æ™®é€šï¼Œä¹Ÿæ˜¯ä¸€ç§ç­”æ¡ˆ',
            title:'äºŒæœ¬ç”Ÿçš„å¹³é™äººç”Ÿ',
            desc:`äºŒæœ¬ï¼Œä¸æ˜¯ç†æƒ³ä¸­çš„ç»“æœã€‚åˆšå¼€å§‹ä½ æœ‰äº›æ²®ä¸§ï¼Œä½†æ…¢æ…¢åœ°ï¼Œä½ å‘ç°å¤§å­¦é‡Œæœ‰å¾ˆå¤šäººå’Œä½ ä¸€æ ·â€”â€”åŠªåŠ›è¿‡ã€æ²¡è¾¾åˆ°ï¼Œä½†ç…§æ ·åœ¨æ´»ç€ã€‚
åå¹´åï¼Œä½ ç»è¥ç€ä¸€å®¶å°åº—ï¼Œé¡¾å®¢éƒ½æ˜¯å›å¤´å®¢ã€‚ä½ ä¸çº¢ï¼Œä½†æ‰å®ã€‚`,
            color:'#64748b', emoji:'â˜•'
        };
        if(stress >= 80 && score >= 600) return {
            id:'E_HOLLOW', icon:'ğŸª†', name:'ç©ºå¿ƒä¼˜ç­‰ç”Ÿ',
            title:'è€ƒä¸Šäº†ï¼Œä½†ä»€ä¹ˆéƒ½æ²¡äº†',
            desc:`ä½ è€ƒä¸Šäº†å¥½å¤§å­¦ï¼Œä½†è¿›æ ¡å›­çš„ç¬¬ä¸€å­¦æœŸä½ å°±é€€å‡ºäº†æ‰€æœ‰ç¤¾å›¢ã€‚ä½ æ„Ÿåˆ°ä¸€ç§å¥‡ç‰¹çš„ç©ºæ´ã€‚
å¿ƒç†å’¨è¯¢å¸ˆè¯´è¿™å«"ç©ºå¿ƒç—…"â€”â€”ä¸ºäº†ç›®æ ‡æ´»äº†åå…«å¹´ï¼Œç›®æ ‡å®ç°äº†ï¼Œè‡ªå·±å´ä¸è§äº†ã€‚
ä½ åœ¨æ…¢æ…¢æ‰¾å›æ¥ã€‚`,
            color:'#94a3b8', emoji:'ğŸ”'
        };
        if(friends >= 4 && score < 500) return {
            id:'E_FRIENDSHIP', icon:'ğŸ­', name:'äººæ¯”åˆ†æ•°é‡è¦',
            title:'æˆç»©ä¸€èˆ¬ï¼Œä½†äº¤åˆ°äº†ä¸€ç”Ÿçš„æœ‹å‹',
            desc:`ä½ æ²¡è€ƒä¸Šä»€ä¹ˆå¥½å­¦æ ¡ï¼Œä½†é«˜ä¸­ä¸‰å¹´ä½ äº¤åˆ°äº†å››ä¸ªçœŸæ­£çš„æœ‹å‹ã€‚æ¯•ä¸šåå¹´ï¼Œä½ ä»¬è¿˜æ˜¯æ¯å¹´èšä¸€æ¬¡ã€‚
æœ‰ä¸€æ¬¡å–é…’ï¼Œæœ‰äººè¯´ï¼šæˆ‘å®æ„¿è¦é‚£æ®µæ—¶å…‰ï¼Œä¸è¦é‚£å¼ æ–‡å‡­ã€‚ä½ ä»¬éƒ½æ²‰é»˜äº†ä¸€ä¸‹ï¼Œç„¶åå“ˆå“ˆå¤§ç¬‘ã€‚`,
            color:'#fb923c', emoji:'ğŸ»'
        };
        // é»˜è®¤ç»“å±€
        return {
            id:'E_DEFAULT', icon:'ğŸš¶', name:'æ™®é€šçš„ï¼ŒçœŸå®çš„äººç”Ÿ',
            title:'æ²¡æœ‰ä¼ å¥‡ï¼Œä½†æœ‰è‡ªå·±',
            desc:`æ²¡æœ‰æˆå‰§æ€§çš„åè½¬ï¼Œä¹Ÿæ²¡æœ‰é«˜å…‰æ—¶åˆ»ã€‚ä½ è€ƒäº†ä¸€ä¸ªè¯´å¾—è¿‡å»çš„åˆ†æ•°ï¼Œå»äº†ä¸€æ‰€è¯´å¾—è¿‡å»çš„å­¦æ ¡ï¼Œè¿‡ç€è¯´å¾—è¿‡å»çš„ç”Ÿæ´»ã€‚
ä½†æœ‰ä¸€å¤©ä½ å‘ç°ï¼Œé‚£äº›ä½ ä»¥ä¸º"è¯´å¾—è¿‡å»"çš„äº‹ï¼Œéƒ½æ˜¯ä½ ä¸€ç‚¹ä¸€ç‚¹é€‰å‡ºæ¥çš„ã€‚
è¿™å°±æ˜¯ä½ çš„äººç”Ÿã€‚æ²¡æœ‰åˆ«äººçš„ï¼Œåªæœ‰ä½ çš„ã€‚`,
            color:'#475569', emoji:'ğŸŒ'
        };
    }
    
    function showFinalRating(mode) {
        let rating = mode === 'student' ? getStuRating() : getGameRating();
        let html = `<div style="text-align:center;">
            <div style="font-size:5rem; font-weight:900; color:${rating.color}; text-shadow: 0 0 20px ${rating.color};">${rating.grade}</div>
            <h2 style="color:${rating.color}; margin:5px 0;">${rating.name}</h2>
            <p style="font-size:1.05rem; color:#475569; font-style:italic; margin:15px 0; line-height:1.7; padding:15px; background:#f8fafc; border-left:4px solid ${rating.color}; text-align:left; border-radius:0 8px 8px 0;">"${rating.quote}"</p>`;
        
        if(mode === 'student') {
            let ending = getStudentEnding();
            let stuScore = stuGame.examScore || 0;
            let stuLabel = stuScore>=680?'æ¸…åŒ—å½•å– ğŸ‰':stuScore>=600?'985å½•å–':stuScore>=550?'211å½•å–':stuScore>=450?'ä¸€æœ¬å½•å–':stuScore>=300?'äºŒæœ¬å½•å–':'æœªèƒ½å½•å–';
            
            // ç»“å±€å¡ç‰‡
            html += `<div style="background:linear-gradient(135deg,${ending.color}22,${ending.color}11);border:2px solid ${ending.color};border-radius:12px;padding:18px;margin-bottom:15px;text-align:left;">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                    <span style="font-size:2.5rem;">${ending.emoji}</span>
                    <div>
                        <div style="font-size:0.7rem;color:${ending.color};font-weight:bold;letter-spacing:2px;">YOUR ENDING</div>
                        <div style="font-size:1.2rem;font-weight:900;color:#1e293b;">${ending.name}</div>
                    </div>
                </div>
                <p style="color:#374151;font-size:0.88rem;line-height:1.8;white-space:pre-line;margin:0;">${ending.desc}</p>
            </div>`;
            
            // å­¦ç”Ÿæˆç»©æ‘˜è¦
            html += `<div style="background:#f8fafc;border-radius:8px;padding:12px;text-align:left;font-size:0.85rem;margin-bottom:12px;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">
                    <div>ğŸ“Š é«˜è€ƒï¼š<b style="color:var(--primary);">${stuScore}åˆ†</b> (${stuLabel})</div>
                    <div>ğŸ˜° æœ€ç»ˆå‹åŠ›ï¼š${Math.floor(stuGame.stress)}</div>
                    <div>ğŸ’• ${stuGame.lover?'ğŸ’˜ ä¸'+stuGame.loverName+'åœ¨ä¸€èµ·':'ğŸ’” å•èº«ç‹—'}</div>
                    <div>ğŸ‘« æ­»å…šï¼š${stuGame.friends.length}äºº</div>
                    <div>ğŸ… å¥¥èµ›ä¿é€ï¼š${stuGame.isInsured?'âœ… æ˜¯':'âŒ å¦'}</div>
                    <div>ğŸ’° å‰©ä½™ï¼šï¿¥${stuGame.money}</div>
                </div>
            </div>`;
            
            // åŒå­¦ä»¬çš„åå¹´å
            html += `<h3 style="margin:10px 0 8px;color:#1e293b;text-align:left;font-size:1rem;">ğŸ”® ä½ çš„åŒå­¦ä»¬ï¼Œåå¹´åâ€¦â€¦</h3><div style="display:flex;flex-direction:column;gap:8px;">`;
            const FUTURES = {
                'lin':{
                    high:'æ—çŸ¥ç§‹è€ƒä¸Šäº†æ¸…åï¼Œæˆäº†ä¸€ä½åŠ©ç†æ•™æˆã€‚ä½†å¥¹æœ€è¿‘åœ¨å†™ä¸€ç¯‡è®ºæ–‡ï¼Œé¢˜ç›®å«ã€Šä¸­å›½é«˜ä¸­ç”Ÿçš„å¿ƒç†åˆ›ä¼¤ä¸è®¤çŸ¥æ¨¡å¼ã€‹â€”â€”å¥¹ç ”ç©¶çš„ï¼Œæ­£æ˜¯å¥¹è‡ªå·±ã€‚',
                    mid:'æ—çŸ¥ç§‹è€ƒä¸Šäº†985ï¼Œæ¯•ä¸šååšäº†ä¸€åé«˜ä¸­æ•°å­¦è€å¸ˆã€‚å¥¹ç»™å­¦ç”Ÿå¸ƒç½®çš„ä½œä¸šæ¯”åŒäº‹å°‘ä¸€åŠï¼Œå¥¹è¯´ï¼šå¤Ÿäº†å°±å¤Ÿäº†ã€‚',
                    low:'æ—çŸ¥ç§‹æ²¡æœ‰è€ƒä¸Šæ¸…åã€‚å¥¹è¾—è½¬è¯»äº†ä¸€æ‰€æ™®é€šé™¢æ ¡ï¼Œæ¯•ä¸šåå»äº†ä¸€å®¶å‡ºç‰ˆç¤¾åšç¼–è¾‘ã€‚å¥¹ç»ˆäºå¼€å§‹è®©äººçœ‹å¥¹å†™çš„è¯—äº†ã€‚'
                },
                'xia':{
                    high:'å¤æ™šæ™´çš„ç”»ä½œåœ¨ç±³å…°ä¸€ä¸ªå°ç”»å»Šå±•å‡ºï¼Œå…¥åœºè´¹äº”æ¬§å…ƒã€‚å¥¹è¯´é‚£æ˜¯å¥¹äººç”Ÿæœ€å¥½çš„ä¸€å¤©ã€‚',
                    mid:'å¤æ™šæ™´åœ¨ä¸€å®¶å¹¿å‘Šå…¬å¸åšè®¾è®¡ï¼Œå¶å°”æ¥è‡ªå·±çš„ç§æ´»å„¿ã€‚å¥¹æŠŠå®¢å…ä¸€é¢å¢™æ¶‚æˆäº†é»‘è‰²ï¼Œè¯´é‚£æ˜¯å¥¹çš„å®‡å®™ã€‚',
                    low:'å¤æ™šæ™´é«˜ä¸­æ²¡è¯»å®Œå°±è¾å­¦äº†ã€‚ç°åœ¨åœ¨ç½‘ä¸Šå–æ‰‹ç»˜ï¼Œæœˆå…¥ä¸‰åƒï¼Œå…»æ´»è‡ªå·±ã€‚å¥¹è¯´ï¼šè¿˜ä¸é”™ã€‚'
                },
                'jiang':{
                    high:'æ±Ÿä¸€èˆŸè¿›äº†çœé˜Ÿï¼Œæ²¡è¿›å›½å®¶é˜Ÿï¼Œä½†å½“ä¸Šäº†ä¸€æ‰€ä¸­å­¦çš„ä½“è‚²è€å¸ˆã€‚ä»–å¸¦çš„ç¯®çƒé˜Ÿè¿ç»­ä¸‰å¹´æ‹¿äº†å¸‚å† å†›ã€‚',
                    mid:'æ±Ÿä¸€èˆŸå¤§å­¦æ‰“äº†å››å¹´æ ¡é˜Ÿï¼Œæ¯•ä¸šååšäº†é”€å”®ã€‚å³æ‰‹åœ¨å˜å¤©æ—¶è¿˜ä¼šç–¼ï¼Œä½†ä»–ä¸æã€‚ä»–è¯´é‚£æ˜¯ä»–çš„å‹‹ç« ã€‚',
                    low:'æ±Ÿä¸€èˆŸé«˜ä¸‰æ²¡æ‰“æˆçƒï¼Œè¯»äº†ä¸ªå¤§ä¸“ï¼Œæ¯•ä¸šåå¼€äº†ä¸ªå°åº—å–è¿åŠ¨å™¨æã€‚æ¯å‘¨æ—¥ä¸‹åˆä»–è¿˜æ˜¯ä¼šå»çƒåœºï¼Œå’Œä¸€ç¾¤å”å”ä»¬æ‰“åŠåœºã€‚'
                },
                'shen':{
                    high:'æ²ˆæ¸”çš„ä¹é˜Ÿåœ¨åœ°ä¸‹éŸ³ä¹åœˆæœ‰äº†ä¸€äº›åæ°”ï¼Œå‡ºäº†ä¸€å¼ EPã€‚å¥¹åœ¨æœ€åä¸€é¦–æ­Œçš„å¤‡æ³¨é‡Œå†™ï¼šçŒ®ç»™é‚£ä¸ªæˆ‘ä»¥ä¸ºä¸é‡è¦çš„è‡ªå·±ã€‚',
                    mid:'æ²ˆæ¸”é«˜ä¸­æ¯•ä¸šåå»äº†å¤§åŸå¸‚ï¼Œç™½å¤©ä¸Šç­ï¼Œæ™šä¸Šåœ¨é…’å§é©»å”±ã€‚å¼Ÿå¼Ÿå·²ç»ä¸Šå¤§å­¦äº†ï¼Œå¥¹è§‰å¾—è‡ªå·±å¯ä»¥å¼€å§‹ä¸ºè‡ªå·±æ´»äº†ã€‚',
                    low:'æ²ˆæ¸”æ²¡èƒ½æ’‘å®Œé«˜ä¸­å°±èµ°äº†ã€‚å¥¹å»äº†å—æ–¹çš„ä¸€ä¸ªå·¥å‚ï¼Œå·¥ä½œå¾ˆç´¯ï¼Œä½†èµšäº†é’±ã€‚å¼Ÿå¼Ÿè€ƒä¸Šäº†å¤§å­¦ï¼Œå¥¹åœ¨è§†é¢‘é‡Œå“­äº†ã€‚å¥¹è¯´ï¼šå¤Ÿäº†ã€‚'
                }
            };
            CRUSHES.forEach(ch => {
                let data = stuGame.crushes[ch.id];
                let aff = data ? data.aff : 0;
                let f = FUTURES[ch.id];
                let story = aff >= 70 ? f.high : aff >= 35 ? f.mid : f.low;
                let borderColor = aff >= 70 ? '#f472b6' : aff >= 35 ? '#60a5fa' : '#94a3b8';
                html += `<div style="background:#f8fafc;padding:10px;border-radius:8px;border-left:3px solid ${borderColor};text-align:left;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <b style="color:#1e293b;font-size:0.9rem;">${ch.name}</b>
                        <span style="font-size:0.7rem;color:${borderColor};">å¥½æ„Ÿåº¦ ${Math.floor(aff)}</span>
                    </div>
                    <p style="margin:4px 0 0;font-size:0.8rem;color:#475569;font-style:italic;">${story}</p>
                </div>`;
            });
            html += '</div>';
        } else {
            // æ ¡é•¿æ¨¡å¼ï¼šè§¦å‘"åå¹´åçš„æ ¡å‹å›è®¿"
            let alumni = generateAlumniVisit();
            html += `<div style="background:#f8fafc;padding:15px;border-radius:8px;margin-top:10px;text-align:left;">
                <h4 style="margin:0 0 10px;color:#1e293b;">ğŸ« å­¦æ ¡å»ºè®¾æˆæœ</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.88rem;">
                    <div>â­ æœ€ç»ˆå£°èª‰ï¼š${Math.floor(game.reputation)}</div>
                    <div>ğŸ’° èµ„é‡‘ï¼š${Math.floor(game.funds)}ä¸‡</div>
                    <div>ğŸ“š å­¦ä¸šï¼š${Math.floor(game.grade)}</div>
                    <div>ğŸ“ é«˜è€ƒå±Šæ•°ï¼š${game.gaokaoHistory.length}</div>
                    <div>ğŸ† è”è€ƒç§¯åˆ†ï¼š${game.examPoints}</div>
                    <div>ğŸ—“ï¸ åŠå­¦ï¼š${game.year - 2018}å¹´</div>
                </div>
            </div>
            <h4 style="margin:15px 0 8px;color:#1e293b;">ğŸ‘¤ æ ¡å‹å›è®¿æ—¥ Â· åå¹´åä»–ä»¬è¯´â€¦â€¦</h4>
            <div style="display:flex;flex-direction:column;gap:8px;">
                ${alumni.map(a=>`<div style="background:${a.bg};padding:10px;border-radius:8px;border-left:3px solid ${a.color};text-align:left;">
                    <div style="font-size:0.75rem;color:${a.color};font-weight:bold;">${a.tag} Â· ${a.type}</div>
                    <p style="margin:4px 0 0;font-size:0.82rem;color:#374151;font-style:italic;">"${a.quote}"</p>
                </div>`).join('')}
            </div>`;
        }
        html += '</div>';
        showCustomModal(`${mode==='student'?'ğŸ‘¨â€ğŸ“ å­¦ç”Ÿç”Ÿæ¶¯':'ğŸ« æ ¡é•¿ç”Ÿæ¶¯'} Â· ç»“å±€è¯„ä»·`, html, [{text:'é“­è®°äºå¿ƒ', action:()=>{}}]);
    }

    function generateAlumniVisit() {
        let rep = game.reputation;
        let stress = game.stress;
        let grade = game.grade;
        let alumni = [];
        
        if(grade >= 80 && stress >= 80) alumni.push({
            tag:'æ¸…åæ¯•ä¸šç”Ÿ', type:'é«˜åˆ†å­¦ç”ŸÂ·åå¹´å', color:'#ef4444', bg:'#fef2f2',
            quote:`æ ¡é•¿ï¼Œæˆ‘å¦‚æ‚¨æ‰€æ„¿è€ƒä¸Šäº†æ¸…åã€‚ç°åœ¨æ˜¯æŸäº’è”ç½‘å…¬å¸çš„P8ã€‚ä½†æˆ‘æƒ³é—®æ‚¨ä¸€ä¸ªé—®é¢˜ï¼šå½“å¹´é‚£é“æœˆè€ƒçš„æœ€åä¸€é¢˜ï¼Œæ‚¨çœŸçš„è§‰å¾—æ¯”æˆ‘ä»¬çš„ç¡çœ æ›´é‡è¦å—ï¼Ÿ`
        });
        if(grade >= 60 && stress < 60) alumni.push({
            tag:'985æ¯•ä¸šç”Ÿ', type:'æ™®é€šå­¦ç”ŸÂ·åå¹´å', color:'#60a5fa', bg:'#eff6ff',
            quote:`é‚£æ—¶å€™å­¦æ ¡å‹åŠ›ä¸ç®—å¤ªå¤§ï¼Œæˆ‘è¯»äº†985ï¼Œç°åœ¨åœ¨ä¸€å®¶ç ”ç©¶æ‰€åšç§‘ç ”ã€‚æˆ‘å¸¸å¸¸åº†å¹¸ï¼šå½“å¹´é‚£ä¸ªæ ¡é•¿ï¼Œè¿˜è®°å¾—æˆ‘ä»¬æ˜¯äººã€‚`
        });
        if(stress >= 90) alumni.push({
            tag:'åŒ¿åæ ¡å‹', type:'ä¸­é€”é€€å­¦è€…Â·åå¹´å', color:'#94a3b8', bg:'#f8fafc',
            quote:`æˆ‘æ²¡æœ‰æ¯•ä¸šã€‚å‹åŠ›å¤ªå¤§ï¼Œæˆ‘èµ°äº†ã€‚æˆ‘ç°åœ¨è¿˜å¥½ï¼Œä½†æˆ‘ä¸ä¼šå›é‚£æ‰€å­¦æ ¡çš„â€”â€”ä¸æ˜¯å› ä¸ºæ¨ï¼Œæ˜¯å› ä¸ºæ€•ã€‚`
        });
        if(rep < 200) alumni.push({
            tag:'å®¶é•¿ä»£è¡¨', type:'å½“å¹´è´¨ç–‘è€…', color:'#f59e0b', bg:'#fffbeb',
            quote:`æˆ‘å½“å¹´å°±è¯´é‚£æ‰€å­¦æ ¡ä¸é è°±ã€‚ç°åœ¨å­©å­å»äº†å¦ä¸€æ‰€ï¼Œè€ƒå¾—è¿˜è¡Œã€‚æ‚¨çŸ¥é“å—ï¼Œå£°èª‰è¿™ç§ä¸œè¥¿ï¼Œå­©å­ä»¬æ¯”å¤§äººæ›´èƒ½æ„Ÿå—åˆ°ã€‚`
        });
        alumni.push({
            tag:'é—®é¢˜å­¦ç”Ÿ', type:'å½“å¹´çš„åˆºå„¿å¤´', color:'#10b981', bg:'#f0fdf4',
            quote:`æ‚¨å¯èƒ½ä¸è®°å¾—æˆ‘äº†ï¼Œæˆ‘å½“å¹´è€é—¯ç¥¸ã€‚æˆ‘ç°åœ¨å¼€äº†ä¸ªå°å…¬å¸ï¼Œä¸‰åä¸ªå‘˜å·¥ã€‚æˆ‘æ‹›äººåªçœ‹ä¸€ä»¶äº‹ï¼šè¿™ä¸ªäººæœ‰æ²¡æœ‰è‡ªå·±çš„æƒ³æ³•ã€‚`
        });
        if(game.gaokaoHistory.length >= 5) alumni.push({
            tag:'ä¹¡æ‘æ•™å¸ˆ', type:'æ™®é€šæ¯•ä¸šç”Ÿ', color:'#8b5cf6', bg:'#faf5ff',
            quote:`æˆ‘æ²¡è€ƒä¸Šä»€ä¹ˆå¥½å­¦æ ¡ï¼Œç°åœ¨åœ¨åè¿œå±±åŒºæ•™å°å­¦ã€‚è¿™é‡Œæ²¡äººçŸ¥é“985æ˜¯ä»€ä¹ˆï¼Œä½†å­©å­ä»¬çŸ¥é“ï¼šæœ‰äººåœ¨ä¹ä»–ä»¬ã€‚æˆ‘æƒ³ï¼Œè¿™å°±å¤Ÿäº†ã€‚`
        });
        return alumni.slice(0, 4);
    }

    function getGameRating() {
        let score = 0;
        score += Math.min(40, game.reputation / 500);
        score += Math.min(20, game.grade);
        score += Math.min(10, (100 - game.stress) / 5);
        score += Math.min(10, game.discipline / 10);
        score += Math.min(10, game.fitness / 10);
        score += Math.min(10, game.art / 10);
        if(game.stress > 80) score -= 20;
        if(hasPolicy('A8')) score -= 15;
        if(hasPolicy('B6')) score -= 10;
        if(hasPolicy('D7') || hasPolicy('D8')) score += 15;
        if(score >= 80) return RATING_QUOTES[0];
        if(score >= 60) return RATING_QUOTES[1];
        if(score >= 40) return RATING_QUOTES[2];
        if(score >= 20) return RATING_QUOTES[3];
        return RATING_QUOTES[4];
    }
    
    function showGaokaoHistory() {
        if(!game.gaokaoHistory || game.gaokaoHistory.length === 0) {
            return showCustomModal("ğŸ“Š å†å¹´é«˜è€ƒ", "å°šæœªä¸¾åŠè¿‡é«˜è€ƒï¼Œè¯·ç»§ç»­æ¨æ¼”è‡³å…­æœˆã€‚", [{text:"å¥½çš„", action:()=>{}}]);
        }
        let maxQb = Math.max(1, ...game.gaokaoHistory.map(h=>h.qb||0));
        let barsHtml = game.gaokaoHistory.slice(-10).map(h => {
            let barH = Math.max(4, Math.floor((h.qb/maxQb)*150));
            let upH = Math.max(2, Math.floor((h.upline/100)*30));
            return `<div style="display:flex;flex-direction:column;align-items:center;flex:1;min-width:40px;">
                <div style="font-size:0.6rem;color:#ef4444;font-weight:bold;">${h.qb}æ¸…åŒ—</div>
                <div style="background:#ef4444;width:80%;height:${barH}px;border-radius:3px 3px 0 0;min-height:4px; margin-bottom:2px;"></div>
                <div style="background:#3b82f6;width:80%;height:${upH}px;border-radius:3px 3px 0 0;"></div>
                <div style="font-size:0.55rem;color:#64748b;margin-top:3px;text-align:center;">${h.year}<br>${h.upline}%</div>
            </div>`;
        }).join('');
        let tableHtml = `<table style="width:100%;border-collapse:collapse;font-size:0.8rem;margin-top:15px;">
            <tr style="background:#f1f5f9;font-weight:bold;"><td style="padding:5px;">å¹´ä»½</td><td>å‡åˆ†</td><td>æ¸…åŒ—</td><td>985</td><td>211</td><td>ä¸€æœ¬</td><td>ä¸Šçº¿ç‡</td></tr>`;
        game.gaokaoHistory.forEach(h => {
            tableHtml += `<tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:4px;font-weight:bold;">${h.year}</td><td style="color:#ef4444;">${h.avg}</td><td style="color:#ef4444;">${h.qb}</td><td style="color:#8b5cf6;">${h.rep985}</td><td style="color:#3b82f6;">${h.p211}</td><td style="color:#10b981;">${h.bk}</td><td style="color:#64748b;">${h.upline}%</td></tr>`;
        });
        tableHtml += '</table>';
        showCustomModal("ğŸ“Š å†å¹´é«˜è€ƒæˆç»©è®°å½•", `<div style="background:#f8fafc;border-radius:8px;padding:10px;border:1px solid #e2e8f0;"><div style="display:flex;align-items:flex-end;height:180px;gap:4px;justify-content:space-around;">${barsHtml}</div><div style="text-align:center;font-size:0.65rem;color:#94a3b8;margin-top:5px;">ğŸŸ¥ çº¢æŸ±=æ¸…åŒ—äººæ•° &nbsp;ğŸŸ¦ è“æŸ±=ä¸Šçº¿ç‡</div></div>${tableHtml}`, [{text:"å…³é—­", action:()=>{}}]);
    }
    
    function runAction(t) {
        if(t==='sponsor') { if(payCost(4,0)) { game.funds+=50; game.reputation-=20; log("æ‹‰èµåŠ©+50ä¸‡"); updateUI(); } }
    }

    // =========== ç¤¾ä¼šå…³ç³»ç³»ç»Ÿ ===========
    function initSocialRelations() {
        if(!game || typeof game !== 'object') return; // æ¸¸æˆæœªåˆå§‹åŒ–
        if(!game.social) game.social = {};
        let s = game.social;
        // å¼ºåˆ¶è¡¥å…¨æ‰€æœ‰ç¼ºå¤±å­—æ®µï¼Œå…¼å®¹æ—§å­˜æ¡£
        if(!s.teacherFactions || typeof s.teacherFactions !== 'object') s.teacherFactions = { young: 50, old: 50, reform: 50 };
        if(typeof s.teacherFactions.young !== 'number') s.teacherFactions.young = 50;
        if(typeof s.teacherFactions.old !== 'number') s.teacherFactions.old = 50;
        if(typeof s.teacherFactions.reform !== 'number') s.teacherFactions.reform = 50;
        if(!s.govRelations || typeof s.govRelations !== 'object') s.govRelations = { local: 30, edu_bureau: 30, media: 20 };
        if(typeof s.govRelations.local !== 'number') s.govRelations.local = 30;
        if(typeof s.govRelations.edu_bureau !== 'number') s.govRelations.edu_bureau = 30;
        if(typeof s.govRelations.media !== 'number') s.govRelations.media = 20;
        if(typeof s.communityRel !== 'number') s.communityRel = 40;
        if(!Array.isArray(s.principals)) s.principals = [];
        if(typeof s.lastInspection !== 'number') s.lastInspection = -12;
        if(typeof s.inspectionWarned !== 'boolean') s.inspectionWarned = false;
        if(!Array.isArray(s.monthlyTargets)) s.monthlyTargets = [];
        if(typeof s.targetGenMonth !== 'number') s.targetGenMonth = -1;
    }

    // ç¤¾ä¼šå…³ç³»è¡ŒåŠ¨èŠ±è´¹éšç­‰çº§æå‡ï¼ˆç­‰çº§0-4ï¼‰
    function getSocialCosts() {
        let lv = Math.min(4, Math.max(0, game.levelIdx || 0));
        return {
            teacher_ap: 1 + lv,
            gov_gift:          [10, 25,  50, 100, 200][lv],
            media_pr:          [ 5, 12,  25,  50, 100][lv],
            inspect_sample:    [ 8, 20,  40,  80, 150][lv],
            inspect_bribe:     [15, 40,  80, 150, 300][lv],
            community_event:   [ 3,  8,  15,  30,  60][lv],
            principal_forum_ap:[ 2,  2,   3,   3,   4][lv],
            principal_compete: [20, 50, 100, 200, 400][lv]
        };
    }

    function showSocialWindow() {
        if(!game || !game.year) return showToast("è¯·å…ˆå¼€å§‹æ¸¸æˆ");
        initSocialRelations();
        let s = game.social;
        let c = getSocialCosts();
        let lvName = ['ä¹¡é•‡','å¿çº§','å¸‚çº§','çœçº§','é¡¶å°–'][game.levelIdx||0];
        let html = `<div style="margin-bottom:10px;background:#1e293b;color:#94a3b8;border-radius:6px;padding:6px 12px;font-size:0.75rem;">
            å½“å‰å­¦æ ¡ç­‰çº§ï¼š<b style="color:#f59e0b">${lvName}</b> â€” èŠ±è´¹éšç­‰çº§åŠ¨æ€è°ƒæ•´
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
        
        <!-- æ•™å¸ˆæ´¾ç³» -->
        <div style="background:#f8fafc;border-radius:10px;padding:15px;border-left:4px solid #8b5cf6;">
            <h3 style="margin:0 0 10px;color:#6d28d9;">ğŸ‘©â€ğŸ« æ•™å¸ˆæ´¾ç³»å…³ç³»</h3>
            ${[['young','ğŸŒ± å¹´è½»æ”¹é©æ´¾','#10b981'],['old','ğŸ“š ä¿å®ˆä¼ ç»Ÿæ´¾','#6366f1'],['reform','âš¡ æ¿€è¿›æ”¹é©æ´¾','#f59e0b']].map(([k,name,color])=>`
            <div style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;font-size:0.85rem;">
                    <span>${name}</span><b style="color:${color};">${Math.floor(s.teacherFactions[k])}/100</b>
                </div>
                <div style="background:#e2e8f0;height:6px;border-radius:3px;overflow:hidden;">
                    <div style="background:${color};height:100%;width:${Math.min(100,s.teacherFactions[k])}%;"></div>
                </div>
            </div>`).join('')}
            <div style="display:flex;gap:5px;flex-wrap:wrap;">
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('teacher_young')">æ”¯æŒå¹´è½»æ´¾ (AP:${c.teacher_ap} ï¿¥${[5,10,25,75,200][game.levelIdx||0]}ä¸‡)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('teacher_old')">å®‰æŠšä¼ ç»Ÿæ´¾ (AP:${c.teacher_ap} ï¿¥${[5,10,25,75,200][game.levelIdx||0]}ä¸‡)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('teacher_reform')">æ¿€åŠ±æ”¹é©æ´¾ (AP:${c.teacher_ap} ï¿¥${[5,10,25,75,200][game.levelIdx||0]}ä¸‡)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('teacher_gossip')">ğŸ•µ æŸ¥çœ‹å…«å¦</button>
            </div>
        </div>

        <!-- æ”¿åºœå…³ç³» -->
        <div style="background:#f8fafc;border-radius:10px;padding:15px;border-left:4px solid #3b82f6;">
            <h3 style="margin:0 0 10px;color:#1d4ed8;">ğŸ›ï¸ æ”¿åºœä¸åª’ä½“å…³ç³»</h3>
            ${[['local','ğŸ™ï¸ åœ°æ–¹æ”¿åºœ','#60a5fa'],['edu_bureau','ğŸ“‹ æ•™è‚²å±€','#818cf8'],['media','ğŸ“¡ åª’ä½“å…¬å…³','#f472b6']].map(([k,name,color])=>`
            <div style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;font-size:0.85rem;">
                    <span>${name}</span><b style="color:${color};">${Math.floor(s.govRelations[k])}/100</b>
                </div>
                <div style="background:#e2e8f0;height:6px;border-radius:3px;overflow:hidden;">
                    <div style="background:${color};height:100%;width:${Math.min(100,s.govRelations[k])}%;"></div>
                </div>
            </div>`).join('')}
            <div style="display:flex;gap:5px;flex-wrap:wrap;">
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('gov_gift')">é€ç¤¼æ‰“ç‚¹ (ï¿¥${c.gov_gift}ä¸‡)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('media_pr')">åª’ä½“å®£ä¼  (ï¿¥${c.media_pr}ä¸‡)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('inspect_prep')">ğŸ“‹ å¤‡æˆ˜è§†å¯Ÿ</button>
            </div>
            <div style="margin-top:8px;background:#fff;border-radius:6px;padding:8px;font-size:0.78rem;color:#475569;">
                ${s.govRelations.edu_bureau>=70?'âœ… æ•™è‚²å±€è®¤å¯ - æ¯æœˆæ”¿ç­–æ‹¨æ¬¾':s.govRelations.edu_bureau>=40?'âš ï¸ å…³ç³»ä¸€èˆ¬ - è§†å¯Ÿé£é™©è¾ƒé«˜':'âŒ å…³ç³»æ¶åŠ£ - éšæ—¶å¯èƒ½è¢«æŸ¥å°'}
            </div>
        </div>

        <!-- ç¤¾åŒºå…³ç³» -->
        <div style="background:#f8fafc;border-radius:10px;padding:15px;border-left:4px solid #10b981;">
            <h3 style="margin:0 0 10px;color:#065f46;">ğŸ˜ï¸ ç¤¾åŒºå…³ç³»</h3>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                <div style="flex:1;background:#e2e8f0;height:10px;border-radius:5px;overflow:hidden;">
                    <div style="background:#10b981;height:100%;width:${Math.min(100,s.communityRel)}%;transition:0.3s;"></div>
                </div>
                <b style="color:#10b981;">${Math.floor(s.communityRel)}/100</b>
            </div>
            <p style="font-size:0.8rem;color:#475569;margin:0 0 8px;">${s.communityRel>=70?'ç¤¾åŒºå±…æ°‘ç§¯ææ”¯æŒï¼Œå¯è·å¾—å¿—æ„¿è€…èµ„æºå’Œåœºåœ°':s.communityRel>=40?'å…³ç³»å°šå¯ï¼Œä¿æŒç°çŠ¶':s.communityRel>=20?'å±…æ°‘æœ‰æŠ±æ€¨ï¼Œå™ªéŸ³/å µè½¦é—®é¢˜é¢‘å‘':'å±…æ°‘å¼ºçƒˆæŠ•è¯‰ï¼Œå¯èƒ½è”åè¯·æ„¿è¦æ±‚æ¬è¿'}</p>
            <div style="display:flex;gap:5px;flex-wrap:wrap;">
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('community_event')">ğŸª å¼€å±•ç¤¾åŒºæ´»åŠ¨ (ï¿¥${c.community_event}ä¸‡)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('open_campus')">ğŸ« å¼€æ”¾æ ¡å›­ (AP:1)</button>
            </div>
        </div>

        <!-- æ ¡é•¿åœˆ -->
        <div style="background:#f8fafc;border-radius:10px;padding:15px;border-left:4px solid #f59e0b;">
            <h3 style="margin:0 0 10px;color:#92400e;">ğŸ“ æ•™è‚²åœˆäººè„‰</h3>
            <p style="font-size:0.8rem;color:#475569;margin:0 0 10px;">å·²å»ºç«‹å…³ç³»: ${(s.principals||[]).length} æ‰€å­¦æ ¡</p>
            <div style="display:flex;flex-direction:column;gap:6px;max-height:100px;overflow-y:auto;">
                ${(s.principals||[]).map(p=>`<div style="font-size:0.78rem;padding:4px 8px;background:${p.rel==='ally'?'#f0fdf4':'#fef2f2'};border-radius:4px;">${p.rel==='ally'?'ğŸ¤':'âš”ï¸'} ${p.name} (${p.rel==='ally'?'åŒç›Ÿ':'ç«äº‰'})</div>`).join('')||'<div style="color:#94a3b8;font-size:0.8rem;">å°šæœªå»ºç«‹ä»»ä½•åŒè¡Œå…³ç³»</div>'}
            </div>
            <div style="display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;">
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('principal_forum')">ğŸ“£ æ ¡é•¿è®ºå› (AP:${c.principal_forum_ap})</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('principal_compete')">âš”ï¸ æŒ–è§’ç«äº‰å¯¹æ‰‹ (ï¿¥${c.principal_compete}ä¸‡)</button>
            </div>
        </div>
        </div>`;
        showCustomModal("ğŸ¤ ç¤¾ä¼šå…³ç³»ç½‘ç»œ", html, [{text:'å…³é—­', action:()=>{}}]);
    }

    function socialAct(t) {
        if(!game || !game.year) return showToast("è¯·å…ˆå¼€å§‹æ¸¸æˆ");
        initSocialRelations();
        let s = game.social;
        if(!s) return;
        let lv = Math.min(4, Math.max(0, game.levelIdx || 0));
        const costScale = [1, 2, 5, 15, 40][lv];
        const baseFunds = (n) => n * costScale;
        const c = getSocialCosts();
        
        if(t==='teacher_young') { 
            if(!payCost(c.teacher_ap, baseFunds(5))) return; 
            s.teacherFactions.young=Math.min(100,s.teacherFactions.young+10); 
            s.teacherFactions.old=Math.max(0,s.teacherFactions.old-5); 
            game.grade+=1; 
            showToast(`å¹´è½»æ´¾æ”¯æŒï¼å­¦ä¸š+1 (AP:${c.teacher_ap} ï¿¥${baseFunds(5)}ä¸‡)`); 
        }
        if(t==='teacher_old') { 
            if(!payCost(c.teacher_ap, baseFunds(5))) return; 
            s.teacherFactions.old=Math.min(100,s.teacherFactions.old+10); 
            s.teacherFactions.reform=Math.max(0,s.teacherFactions.reform-5); 
            game.discipline+=2; 
            showToast(`ä¼ ç»Ÿæ´¾å®‰æŠšï¼çºªå¾‹+2 (AP:${c.teacher_ap} ï¿¥${baseFunds(5)}ä¸‡)`); 
        }
        if(t==='teacher_reform') { 
            if(!payCost(c.teacher_ap, baseFunds(5))) return; 
            s.teacherFactions.reform=Math.min(100,s.teacherFactions.reform+10); 
            s.teacherFactions.old=Math.max(0,s.teacherFactions.old-8); 
            game.art+=2; 
            showToast(`æ”¹é©æ´¾æ¿€åŠ±ï¼è‰ºæœ¯+2 (AP:${c.teacher_ap} ï¿¥${baseFunds(5)}ä¸‡)`); 
        }
        if(t==='teacher_gossip') {
            let gossips = [
                `"å¬è¯´${s.teacherFactions.young>60?'å¹´è½»çš„ç‹è€å¸ˆè¦å»ç§ç«‹å­¦æ ¡äº†':'ä¼ ç»Ÿæ´¾çš„èµµè€å¸ˆåœ¨å·å·å…¼èŒåŸ¹è®­æœºæ„'}"`,
                `"æ•°å­¦ç»„å’Œè¯­æ–‡ç»„æœ€è¿‘ä¸ºäº†åŠå…¬å®¤ç©ºè°ƒæ¸©åº¦é—¹çŸ›ç›¾ï¼Œè¯¾ä»£è¡¨éƒ½è¢«è¿«ç«™é˜Ÿäº†â€¦â€¦"`,
                `"ç­ä¸»ä»»ä»¬ç§ä¸‹ä¼ ï¼š'æ ¡é•¿é‚£ä¸ªæœˆåº¦å¥–é‡‘åˆ¶åº¦å§ï¼Œæ ¹æœ¬å°±æ˜¯å†…éƒ¨å…³ç³»æˆ·'ã€‚"`,
                `"æœ‰è€å¸ˆè¯´è¦é›†ä½“è¯·å‡å»å‚åŠ æ•™è‚²å±€çš„ä»€ä¹ˆåº§è°ˆä¼šï¼Œè¯´æ˜¯ä¸ºäº†'ç»´æƒ'"`,
                `"å¹´çº§ç»„é•¿è·Ÿæ•™åŠ¡ä¸»ä»»ä¸å¯¹ä»˜ï¼Œæ’è¯¾è¡¨æ—¶æœ‰æ„æŠŠå¯¹æ–¹ä¸å–œæ¬¢çš„ç­æ’åœ¨æ—©8ç‚¹ã€‚"`
            ];
            showCustomModal("ğŸ•µï¸ æ•™å¸ˆå…«å¦åœˆ", gossips[Math.floor(Math.random()*gossips.length)], [
                {text:'å½“æ²¡å¬è§',action:()=>{}},
                {text:`å¹²é¢„è°ƒè§£ (ï¿¥${baseFunds(3)}ä¸‡)`,action:()=>{if(payCost(0,baseFunds(3))){s.teacherFactions.young=Math.min(100,s.teacherFactions.young+5);s.teacherFactions.old=Math.min(100,s.teacherFactions.old+5);showToast("è°ƒè§£æˆåŠŸï¼");}}}
            ]);
            return;
        }
        if(t==='gov_gift') { 
            if(!payCost(0, c.gov_gift)) return; 
            s.govRelations.local=Math.min(100,s.govRelations.local+12); 
            s.govRelations.edu_bureau=Math.min(100,s.govRelations.edu_bureau+8); 
            showToast(`å…³ç³»æ‰“ç‚¹ï¼æ”¿åºœå¥½æ„Ÿ+12 (èŠ±è´¹ ï¿¥${c.gov_gift}ä¸‡)`); 
        }
        if(t==='media_pr') { 
            if(!payCost(0, c.media_pr)) return; 
            s.govRelations.media=Math.min(100,s.govRelations.media+15); 
            game.reputation+=20; 
            showToast(`åª’ä½“å®£ä¼ ï¼å£°èª‰+20 (èŠ±è´¹ ï¿¥${c.media_pr}ä¸‡)`); 
        }
        if(t==='inspect_prep') { 
            showCustomModal("ğŸ“‹ è§†å¯Ÿåº”å¯¹æ–¹æ¡ˆ", `å­¦æ ¡ç­‰çº§ï¼š${['ä¹¡é•‡','å¿çº§','å¸‚çº§','çœçº§','å…¨å›½'][lv]}ï¼ˆèŠ±è´¹ç³»æ•°Ã—${costScale}ï¼‰\né€‰æ‹©åº”å¯¹ç­–ç•¥ï¼š`, [
                {text:`ğŸ­ ç²¾å¿ƒå¸ƒç½®æ ·æ¿è¯¾ (ï¿¥${c.inspect_sample}ä¸‡)`, action:()=>{ if(payCost(0,c.inspect_sample)){s.govRelations.edu_bureau=Math.min(100,s.govRelations.edu_bureau+20); showToast("å®Œç¾åº”å¯¹ï¼æ•™è‚²å±€+20");} }},
                {text:`ğŸ’° ç›´æ¥æ‰“ç‚¹å…³é”®å®˜å‘˜ (ï¿¥${c.inspect_bribe}ä¸‡)`, action:()=>{ if(payCost(0,c.inspect_bribe)){s.govRelations.edu_bureau=Math.min(100,s.govRelations.edu_bureau+35); showToast("é“¶å¼¹å¤–äº¤ï¼æ•™è‚²å±€+35");} }},
                {text:"ğŸ˜¤ ç¡¬æŠ—ï¼Œå±•ç¤ºçœŸå®æ°´å¹³", action:()=>{ let pass=game.grade>=60&&game.reputation>=500; s.govRelations.edu_bureau+=pass?10:-15; showToast(pass?"çœŸå®åŠ›é€šè¿‡ï¼":"å®åŠ›ä¸è¶³è¢«æ‰¹è¯„ï¼"); }}
            ]);
            return;
        }
        if(t==='community_event') { 
            if(!payCost(0, c.community_event)) return; 
            s.communityRel=Math.min(100,s.communityRel+15); 
            game.reputation+=10; 
            showToast(`ç¤¾åŒºæ´»åŠ¨åœ†æ»¡ï¼å£°èª‰+10 (èŠ±è´¹ ï¿¥${c.community_event}ä¸‡)`); 
        }
        if(t==='open_campus') { if(!payCost(1,0)) return; s.communityRel=Math.min(100,s.communityRel+8); game.fitness+=1; showToast("å¼€æ”¾æ ¡å›­ï¼ç¤¾åŒºå…³ç³»+8"); }
        if(t==='principal_forum') { 
            if(!payCost(c.principal_forum_ap, baseFunds(2))) return;
            let names = ['å¸‚ä¸€ä¸­æ ¡é•¿','çœå®éªŒæ ¡é•¿','é‡ç‚¹é™„ä¸­æ ¡é•¿','ç§ç«‹åæ ¡æ€»è£','åŒºæ•™è‚²å±€å‰¯å±€é•¿'];
            let newSchool = {name: names[Math.floor(Math.random()*names.length)], rel:'neutral'};
            if(!Array.isArray(s.principals)) s.principals=[];
            s.principals.push(newSchool); game.reputation+=15+lv*10;
            showToast(`ç»“è¯†äº† ${newSchool.name}ï¼å£°èª‰+${15+lv*10}`);
        }
        if(t==='principal_compete') { 
            if(!payCost(0, c.principal_compete)) return;
            game.grade+=5; game.students=Math.min(10000,game.students+100);
            showToast(`æˆåŠŸæŒ–èµ°ç«äº‰å¯¹æ‰‹çš„åå¸ˆï¼å­¦ä¸š+5ï¼Œç”Ÿæº+100 (èŠ±è´¹ ï¿¥${c.principal_compete}ä¸‡)`);
        }
        updateUI();
        showSocialWindow();
    }

    // =========== æœˆåº¦ç›®æ ‡ç³»ç»Ÿ ===========
    const TARGET_TEMPLATES = [
        {type:'teach',  icon:'ğŸ“š', gen:()=>({desc:`å°†å­¦ä¸šæå‡è‡³ ${Math.floor(game.grade+10)} ä»¥ä¸Š`, check:()=>game.grade>=(game.grade+10), reward:{rep:50,edu:5}, difficulty:'ç®€å•'})},
        {type:'build',  icon:'ğŸ—ï¸', gen:()=>({desc:'æœ¬æœˆæ–°å»ºæˆ–å‡çº§ä¸€åº§å»ºç­‘', check:()=>true, reward:{rep:30,funds:5}, difficulty:'ç®€å•'})},
        {type:'expert', icon:'ğŸ‘¨â€ğŸ«', gen:()=>({desc:'æ‹›å‹Ÿä¸€ä½æ–°ä¸“å®¶', check:()=>true, reward:{rep:60,edu:8}, difficulty:'ä¸­ç­‰'})},
        {type:'funds',  icon:'ğŸ’°', gen:()=>({desc:`èµ„é‡‘ç§¯ç´¯åˆ° ${Math.floor(game.funds+50)} ä¸‡ä»¥ä¸Š`, check:()=>game.funds>=(game.funds+50), reward:{rep:40,funds:20}, difficulty:'ä¸­ç­‰'})},
        {type:'rep',    icon:'â­', gen:()=>({desc:`å£°èª‰çªç ´ ${Math.floor(game.reputation+200)} ç‚¹`, check:()=>game.reputation>=(game.reputation+200), reward:{rep:80,edu:10}, difficulty:'å›°éš¾'})},
        {type:'stress', icon:'ğŸ˜Œ', gen:()=>({desc:`å°†å…¨æ ¡å‹åŠ›é™ä½è‡³ ${Math.max(20,Math.floor(game.stress-20))} ä»¥ä¸‹`, check:()=>game.stress<=Math.max(20,game.stress-20), reward:{rep:50,funds:10}, difficulty:'ä¸­ç­‰'})},
        {type:'battle', icon:'âš”ï¸', gen:()=>({desc:'èµ¢å¾—ä¸€åœºè”è€ƒæˆ˜æ–—', check:()=>game.examPoints>=(game.examPoints+5), reward:{rep:100,edu:15}, difficulty:'å›°éš¾'})}
    ];

    function generateMonthlyTargets() {
        if(!game || typeof game !== 'object') return;
        initSocialRelations();
        if(!game.social) return;
        let s = game.social;
        if(s.targetGenMonth === game.month) return;
        s.targetGenMonth = game.month;
        let count = 3 + Math.floor(Math.random()*3);
        let shuffled = [...TARGET_TEMPLATES].sort(()=>Math.random()-0.5).slice(0,count);
        s.monthlyTargets = shuffled.map(t=>{
            try {
                let g = t.gen();
                return { icon:t.icon, desc:g.desc, reward:g.reward, difficulty:g.difficulty, done:false, failed:false };
            } catch(e) {
                return { icon:t.icon, desc:'å®Œæˆæœ¬æœˆä»»åŠ¡', reward:{rep:30}, difficulty:'ç®€å•', done:false, failed:false };
            }
        });
    }

    function showMonthlyTargets() {
        if(!game || !game.year) return showCustomModal("ğŸ¯ æœˆåº¦ç›®æ ‡","è¯·å…ˆå¼€å§‹æ¸¸æˆï¼",[{text:'å¥½çš„',action:()=>{}}]);
        initSocialRelations();
        if(!game.social) return showToast("è¯·å…ˆå¼€å§‹æ¸¸æˆ");
        generateMonthlyTargets();
        let targets = Array.isArray(game.social.monthlyTargets) ? game.social.monthlyTargets : [];
        let diffColor = {ç®€å•:'#10b981',ä¸­ç­‰:'#f59e0b',å›°éš¾:'#ef4444'};
        let html = `<p style="color:#475569;font-size:0.85rem;margin-top:0;">å®Œæˆç›®æ ‡è·å¾—å¥–åŠ±ï¼Œæ”¾å¼ƒç›®æ ‡å£°èª‰-10ã€‚</p>
        <div style="display:flex;flex-direction:column;gap:10px;">`;
        if(targets.length === 0) {
            html += `<div style="color:#94a3b8;text-align:center;padding:20px;">æœ¬æœˆæš‚æ— ç›®æ ‡ï¼Œä¸‹æœˆè‡ªåŠ¨åˆ·æ–°</div>`;
        }
        targets.forEach((t,i)=>{
            if(!t) return;
            let status = t.done?'âœ… å·²å®Œæˆ':t.failed?'âŒ å·²æ”¾å¼ƒ':'â³ è¿›è¡Œä¸­';
            let statusColor = t.done?'#10b981':t.failed?'#ef4444':'#f59e0b';
            let reward = t.reward || {};
            html += `<div style="background:#f8fafc;border-radius:8px;padding:12px;border-left:4px solid ${diffColor[t.difficulty]||'#cbd5e1'};">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:1.2rem;">${t.icon||'ğŸ¯'}</span>
                    <span style="font-size:0.7rem;background:${diffColor[t.difficulty]||'#94a3b8'};color:white;padding:2px 6px;border-radius:4px;">${t.difficulty||'æ™®é€š'}</span>
                </div>
                <div style="font-size:0.88rem;color:#1e293b;margin:5px 0;">${t.desc||'å®Œæˆæœ¬æœˆä»»åŠ¡'}</div>
                <div style="font-size:0.75rem;color:#64748b;">å¥–åŠ±ï¼šå£°èª‰+${reward.rep||0} ${reward.edu?'æ•™ç ”ç‚¹+'+reward.edu:''} ${reward.funds?'èµ„é‡‘+'+reward.funds+'ä¸‡':''}</div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
                    <span style="font-size:0.75rem;color:${statusColor};font-weight:bold;">${status}</span>
                    ${!t.done&&!t.failed?`<div style="display:flex;gap:5px;">
                        <button class="btn" style="font-size:0.7rem;padding:3px 8px;" onclick="claimTarget(${i})">âœ… å®Œæˆé¢†å–</button>
                        <button class="btn" style="font-size:0.7rem;padding:3px 8px;border-color:#ef4444;color:#ef4444;" onclick="abandonTarget(${i})">æ”¾å¼ƒ</button>
                    </div>`:''}
                </div>
            </div>`;
        });
        html += '</div>';
        showCustomModal("ğŸ¯ æœˆåº¦ç›®æ ‡æ¿", html, [{text:'å…³é—­',action:()=>{}}]);
    }

    function claimTarget(i) {
        if(!game.social || !Array.isArray(game.social.monthlyTargets)) return;
        let t = game.social.monthlyTargets[i];
        if(!t || t.done || t.failed) return showToast("è¯¥ç›®æ ‡å·²å¤„ç†");
        t.done = true;
        let r = t.reward || {};
        if(r.rep) game.reputation += r.rep;
        if(r.edu) game.eduPoints += r.edu;
        if(r.funds) game.funds += r.funds;
        showToast(`ğŸ‰ ç›®æ ‡å®Œæˆï¼å£°èª‰+${r.rep||0}`);
        updateUI(); showMonthlyTargets();
    }
    function abandonTarget(i) {
        if(!game.social || !Array.isArray(game.social.monthlyTargets)) return;
        let t = game.social.monthlyTargets[i];
        if(!t) return;
        t.failed = true; game.reputation = Math.max(0, game.reputation-10);
        showToast("æ”¾å¼ƒç›®æ ‡ï¼Œå£°èª‰-10"); updateUI(); showMonthlyTargets();
    }

    // =========== å­¦ç§‘ç«èµ›ç³»ç»Ÿï¼ˆçœçº§è§£é”ï¼‰===========
    const OLYMPIAD_SUBJECTS = [
        {id:'math',   name:'æ•°å­¦è”èµ›', icon:'ğŸ“', desc:'ä»¥éš¾åº¦å’Œå¹¿åº¦è‘—ç§°ï¼Œå…¨å›½å«é‡‘é‡æœ€é«˜'},
        {id:'physics',name:'ç‰©ç†ç«èµ›', icon:'âš›ï¸', desc:'å®éªŒä¸ç†è®ºå¹¶é‡ï¼Œé—¨æ§›æé«˜'},
        {id:'chem',   name:'åŒ–å­¦ç«èµ›', icon:'ğŸ§ª', desc:'è®°å¿†ä¸æ¨ç†åŒé‡è€ƒéªŒ'},
        {id:'bio',    name:'ç”Ÿç‰©ç«èµ›', icon:'ğŸ§¬', desc:'å®éªŒæ“ä½œä¸ç†è®ºçŸ¥è¯†èåˆ'},
        {id:'info',   name:'ä¿¡æ¯ç«èµ›', icon:'ğŸ’»', desc:'ä»£ç ä¸ç®—æ³•ï¼Œæœªæ¥æœ€çƒ­é—¨'}
    ];

    function showOlympiadSystem() {
        if(!game || !game.year) return showCustomModal("ğŸ”’ ç«èµ›ç³»ç»Ÿ","è¯·å…ˆå¼€å§‹æ¸¸æˆï¼",[{text:'å¥½çš„',action:()=>{}}]);
        if((game.levelIdx||0) < 3) return showCustomModal("ğŸ”’ ç«èµ›ç³»ç»Ÿ","è¯¥ç³»ç»Ÿéœ€è¦å­¦æ ¡è¾¾åˆ°ã€çœçº§åæ ¡ã€‘æ‰å¯è§£é”ã€‚ç»§ç»­åŠªåŠ›ï¼",[{text:'æ˜ç™½',action:()=>{}}]);
        if(!game.olympiadData) game.olympiadData = {
            squads: {math:{level:0,trained:false},physics:{level:0,trained:false},chem:{level:0,trained:false},bio:{level:0,trained:false},info:{level:0,trained:false}},
            medals: {gold:0,silver:0,bronze:0},
            scholarships: 0
        };
        let od = game.olympiadData;
        let html = `<div style="margin-bottom:12px;background:#eff6ff;border-radius:8px;padding:10px;text-align:center;font-size:0.85rem;">
            ğŸ… ç´¯è®¡é‡‘ç‰Œ: <b style="color:#f59e0b">${od.medals.gold}</b> 
            ğŸ¥ˆ é“¶ç‰Œ: <b style="color:#94a3b8">${od.medals.silver}</b> 
            ğŸ¥‰ é“œç‰Œ: <b style="color:#cd7f32">${od.medals.bronze}</b> 
            &nbsp;|&nbsp; ä¿é€åé¢: <b style="color:#10b981">${od.scholarships}</b> äºº
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">`;
        
        OLYMPIAD_SUBJECTS.forEach(sub=>{
            let sq = od.squads[sub.id];
            let stageName = ['æœªç»„å»º','çœçº§åˆèµ›','å…¨å›½å†³èµ›','å›½é™…å¥¥èµ›'][Math.min(3,sq.level)];
            let stageColor = ['#94a3b8','#3b82f6','#8b5cf6','#f59e0b'][Math.min(3,sq.level)];
            html += `<div style="background:#f8fafc;border:2px solid ${stageColor};border-radius:10px;padding:12px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <span style="font-size:1.8rem;">${sub.icon}</span>
                    <div>
                        <div style="font-weight:bold;font-size:0.9rem;">${sub.name}</div>
                        <div style="font-size:0.65rem;color:${stageColor};font-weight:bold;">${stageName}</div>
                    </div>
                </div>
                <p style="font-size:0.72rem;color:#64748b;margin:0 0 8px;">${sub.desc}</p>
                <div style="display:flex;flex-direction:column;gap:4px;">
                    ${sq.level===0?`<button class="btn" style="font-size:0.73rem;padding:4px;" onclick="olympiadAct('build','${sub.id}')">ğŸ”¨ ç»„å»ºé›†è®­é˜Ÿ (ï¿¥15ä¸‡+AP:2)</button>`:''}
                    ${sq.level>=1&&sq.level<3?`<button class="btn" style="font-size:0.73rem;padding:4px;" onclick="olympiadAct('compete','${sub.id}')">âš”ï¸ å‚åŠ æ¯”èµ› (AP:3)</button>`:''}
                    ${sq.level>=1?`<button class="btn" style="font-size:0.73rem;padding:4px;" onclick="olympiadAct('train','${sub.id}')">ğŸ‹ï¸ å¼ºåŒ–è®­ç»ƒ (ï¿¥5ä¸‡)</button>`:''}
                </div>
            </div>`;
        });
        html += '</div>';
        showCustomModal("ğŸ† å­¦ç§‘å¥¥æ—åŒ¹å…‹ç«èµ›ç³»ç»Ÿ", html, [{text:'å…³é—­',action:()=>{}}]);
    }

    function olympiadAct(act, subId) {
        if(!game.olympiadData) return;
        let sq = game.olympiadData.squads[subId];
        let od = game.olympiadData;
        if(act==='build') {
            if(!payCost(2,15)) return;
            sq.level=1; game.reputation+=30; game.eduPoints+=5;
            showToast(`${OLYMPIAD_SUBJECTS.find(s=>s.id===subId).name} é›†è®­é˜Ÿç»„å»ºå®Œæ¯•ï¼å£°èª‰+30`);
        }
        if(act==='train') {
            if(!payCost(0,5)) return;
            sq.trained=true; showToast("å¼ºåŒ–è®­ç»ƒå®Œæˆï¼ä¸‹æ¬¡å‚èµ›æˆåŠŸç‡æå‡");
        }
        if(act==='compete') {
            if(!payCost(3,0)) return;
            let sub = OLYMPIAD_SUBJECTS.find(s=>s.id===subId);
            let baseRate = 0.3 + game.grade/300 + (sq.trained?0.2:0) + (sq.level>=2?0.15:0);
            sq.trained = false;
            let roll = Math.random();
            let result, medal='', repGain=0, schGain=0;
            if(roll < baseRate*0.3) { medal='ğŸ¥‡ é‡‘ç‰Œ'; od.medals.gold++; repGain=200; schGain=2; result='é‡‘ç‰Œï¼ä¿é€åé¢+2ï¼'; sq.level=Math.min(3,sq.level+1); }
            else if(roll < baseRate*0.7) { medal='ğŸ¥ˆ é“¶ç‰Œ'; od.medals.silver++; repGain=100; schGain=1; result='é“¶ç‰Œï¼ä¿é€åé¢+1ï¼'; sq.level=Math.min(3,sq.level+1); }
            else if(roll < baseRate) { medal='ğŸ¥‰ é“œç‰Œ'; od.medals.bronze++; repGain=50; result='é“œç‰Œï¼å£°èª‰+50'; }
            else { result='æœªèƒ½è·å¥–â€¦â€¦æ˜å¹´å†æ¥'; repGain=-10; }
            od.scholarships += schGain;
            game.reputation += repGain;
            showCustomModal(`${sub.icon} ${sub.name} ç»“æœ`, `${medal||'ğŸ“‹'} ${result}\n\nå£°èª‰${repGain>=0?'+':''}${repGain} | ä¿é€åé¢æ€»è®¡: ${od.scholarships}`, [{text:'ç¡®è®¤',action:()=>showOlympiadSystem()}]);
            return;
        }
        updateUI(); showOlympiadSystem();
    }

    // =========== å­¦ç”Ÿæ—¥è®°/å†…å¿ƒç‹¬ç™½ç³»ç»Ÿ ===========
    function showStuJournal() {
        if(!stuGame.active) return showCustomModal("ğŸ““","è¯·å…ˆè¿›å…¥å­¦ç”Ÿæ¨¡å¼",[{text:'å¥½',action:()=>{}}]);
        if(!stuGame.journal) stuGame.journal = [];
        let entries = stuGame.journal;
        let autoEntry = generateAutoJournalEntry();
        let html = `<div style="background:#fffbeb;border-radius:8px;padding:15px;border-left:4px solid #f59e0b;margin-bottom:12px;">
            <div style="font-size:0.7rem;color:#92400e;font-weight:bold;">${game.year}å¹´${game.month}æœˆ Â· ä»Šæ—¥å¿ƒæƒ…</div>
            <p style="font-size:0.88rem;color:#78350f;line-height:1.7;margin:6px 0 0;font-style:italic;">"${autoEntry}"</p>
        </div>
        <h4 style="margin:0 0 8px;color:#1e293b;">ğŸ“– å†å²æ—¥è®°</h4>
        <div style="display:flex;flex-direction:column;gap:8px;max-height:200px;overflow-y:auto;">
        ${entries.length?entries.slice(-6).reverse().map(e=>`<div style="background:#f8fafc;border-radius:6px;padding:10px;border-left:3px solid #cbd5e1;">
            <div style="font-size:0.65rem;color:#94a3b8;">${e.date}</div>
            <p style="margin:3px 0 0;font-size:0.82rem;color:#475569;font-style:italic;">"${e.text}"</p>
        </div>`).join('') : '<div style="color:#94a3b8;font-size:0.82rem;">è¿˜æ²¡æœ‰ä»»ä½•æ—¥è®°ã€‚é€šè¿‡ã€å†™æ—¥è®°ã€‘è¡ŒåŠ¨æ¥è®°å½•ä½ çš„é«˜ä¸­æ—¶å…‰ã€‚</div>'}
        </div>`;
        showCustomModal("ğŸ““ å†…å¿ƒæ—¥è®°", html, [
            {text:'å†™ä¸‹ä»Šæ—¥æ„Ÿæƒ³', action:()=>{ stuGame.journal.push({date:`${game.year}.${game.month}`,text:autoEntry}); stuGame.stress=Math.max(0,stuGame.stress-5); showToast("å†™æ—¥è®°å‡å‹5"); showStuJournal(); }},
            {text:'å…³é—­', action:()=>{}}
        ]);
    }

    function generateAutoJournalEntry() {
        let stress = stuGame.stress, grade = stuGame.grade, score = stuGame.examScore||0;
        let lover = stuGame.lover, loverName = stuGame.loverName;
        let entries = [
            stress>=80?`ä»Šå¤©å‹åŠ›${Math.floor(stress)}ï¼Œæˆ‘å¿«å–˜ä¸è¿‡æ°”äº†ã€‚ä½†æˆ‘ä¸èƒ½åœï¼Œä¸æ•¢åœã€‚æˆ‘å®³æ€•å¦‚æœæˆ‘åœä¸‹æ¥ï¼Œæ‰€æœ‰äººéƒ½ä¼šå¤±æœ›ã€‚`:`å‹åŠ›${Math.floor(stress)}ï¼Œè¿˜ç®—å¯ä»¥ã€‚æˆ‘å‘Šè¯‰è‡ªå·±ï¼šæ¯ä¸€å¤©éƒ½ä¼šè¿‡å»çš„ã€‚`,
            grade>=70?`æ¨¡æ‹Ÿé¢˜åšåˆ°å‡Œæ™¨ï¼Œé”™è¯¯ç‡åœ¨ä¸‹é™ã€‚ä¹Ÿè®¸æˆ‘çœŸçš„å¯ä»¥ï¼Ÿ`:`åˆè®¢æ­£äº†ä¸€éé”™é¢˜æœ¬ã€‚åšå®Œä¹‹åï¼Œæˆ‘ååœ¨é‚£é‡Œå‘äº†ä¸€ä¼šå„¿å‘†ã€‚è¿™ä¸€åˆ‡å€¼å¾—å—ï¼Ÿ`,
            lover?`ä»Šå¤©${loverName}å†²æˆ‘ç¬‘äº†ä¸€ä¸‹ã€‚æˆ‘çš„å¿ƒè·³çªç„¶å¿«äº†ä¸‰æ‹ã€‚çœŸçš„å¾ˆè ¢ï¼Œä½†æ˜¯â€¦â€¦å¾ˆçœŸå®ã€‚`:`ç­ä¸Šæœ‰äººåœ¨è°ˆæ‹çˆ±ï¼Œæˆ‘æ²¡è¯´ä»€ä¹ˆã€‚åªæ˜¯æƒ³ç€ï¼Œå¦‚æœæˆ‘ä¹Ÿâ€¦â€¦ç®—äº†ã€‚`,
            `é£Ÿå ‚ä»Šå¤©æœ‰çº¢çƒ§è‚‰ã€‚æˆ‘å¤šæ‰“äº†ä¸€ä»½ã€‚è¿™æ˜¯ä»Šå¤©å”¯ä¸€è®©æˆ‘é«˜å…´çš„äº‹æƒ…ã€‚`,
            stress>=70?`æˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦è¯»ä¹¦ã€‚ä½†æˆ‘ä¹Ÿä¸çŸ¥é“ä¸è¯»ä¹¦çš„è¯ï¼Œæˆ‘ä¼šæ˜¯ä»€ä¹ˆã€‚æ‰€ä»¥æˆ‘ç»§ç»­è¯»ã€‚`:`èµ°å»Šä¸Šçœ‹åˆ°å¤•é˜³æŠŠçª—å­æŸ“æˆé‡‘è‰²ã€‚æˆ‘åœä¸‹æ¥çœ‹äº†ä¸‰ç§’é’Ÿã€‚ç„¶åç»§ç»­èµ°ã€‚`,
        ];
        let idx = Math.floor(Math.random()*entries.length);
        return entries[idx];
    }

    // =========== æ·±åº¦æƒ…æ„Ÿçº¿ï¼šè§’è‰²ç‹¬ç«‹å¯¹è¯ä¸åé¦ˆ ===========
    const DEEP_CRUSH_DIALOGUES = {
        'lin': {
            low: [
                {scene:'æ”¾å­¦å', line:`"ä½ â€¦â€¦æ˜¯æœ‰ä»€ä¹ˆäº‹å—ï¼Ÿæˆ‘è¦å»å›¾ä¹¦é¦†äº†ã€‚"`, mood:'è­¦æƒ•'},
                {scene:'æ—©è¯»è¯¾', line:`"é‚£é“é¢˜ä½ é€‰Cæ˜¯é”™çš„ã€‚æ˜¯Aï¼Œä½ è‡ªå·±å»æ¨å¯¼ä¸€éã€‚"`, mood:'å†·æ·¡'},
                {scene:'è¯¾é—´', line:`"å€Ÿç¬”è®°å¯ä»¥ï¼Œä½†ä¸è¦å¼„è„ã€‚"`, mood:'ç–è¿œ'}
            ],
            mid: [
                {scene:'æ”¾å­¦èµ°å»Š', line:`"ä»Šæ™šä¸ƒç‚¹æ•°å­¦è‡ªä¹ å®¤ï¼Œå¦‚æœä½ æ„¿æ„çš„è¯â€¦â€¦å¯ä»¥ä¸€èµ·ã€‚"`, mood:'è¯•æ¢'},
                {scene:'å¤©å°', line:`"â€¦â€¦ä½ ä¹Ÿå–œæ¬¢æ¥å¤©å°ï¼Ÿæˆ‘ä»¥ä¸ºåªæœ‰æˆ‘ä¸€ä¸ªäººçŸ¥é“è¿™é‡Œã€‚"`, mood:'æƒŠè®¶'},
                {scene:'è€ƒè¯•å', line:`"è¿™æ¬¡ä½ è¿›æ­¥äº†ä¸‰åã€‚æˆ‘æ³¨æ„åˆ°äº†ã€‚"`, mood:'å…³æ³¨'}
            ],
            high: [
                {scene:'æ·±å¤œå›¾ä¹¦é¦†', line:`"ä½ è¯´â€¦â€¦å¦‚æœæˆ‘ä»¬éƒ½æ²¡è€ƒä¸Šæ¸…åï¼Œæˆ‘ä»¬è¿˜ä¼šæ˜¯æœ‹å‹å—ï¼Ÿ"`, mood:'è„†å¼±'},
                {scene:'å¤©å°', line:`"æˆ‘ä»æ¥æ²¡æŠŠè¯—ç»™äººçœ‹è¿‡ã€‚ä½†â€¦â€¦ä½ å¯ä»¥çœ‹ã€‚"`, mood:'ä¿¡ä»»'},
                {scene:'å®£èª“å', line:`"æˆ‘ä¸çŸ¥é“å–œæ¬¢ä¸€ä¸ªäººæ˜¯ä»€ä¹ˆæ„Ÿè§‰ã€‚ä½†å½“ä½ åœ¨çš„æ—¶å€™ï¼Œæˆ‘çš„ä¸–ç•Œå¥½åƒâ€¦â€¦ä¸é‚£ä¹ˆé»‘ç™½äº†ã€‚"`, mood:'å¿ƒåŠ¨'}
            ]
        },
        'xia': {
            low: [
                {scene:'ç¾æœ¯å®¤å¤–', line:`"æ²¡äº‹ä½ ç»•ç€èµ°ï¼Œè¿™é‡Œåœ¨ä¸Šè¯¾ã€‚"`, mood:'æ— è§†'},
                {scene:'èµ°å»Š', line:`"å€Ÿé’±çš„è¯å»æ‰¾åˆ«äººï¼Œæˆ‘ä¹Ÿä¸å¯Œè£•ã€‚"`, mood:'æˆ’å¤‡'},
                {scene:'éŸ³ä¹è¯¾', line:`"â€¦â€¦åˆ«çœ‹æˆ‘ï¼Œçƒ¦ã€‚"`, mood:'æŠ—æ‹’'}
            ],
            mid: [
                {scene:'æ”¾å­¦', line:`"ä½ çŸ¥é“ä»Šæ™šæœ‰ä¸ªåœ°ä¸‹ä¹é˜Ÿåœ¨å•†åœºæ¼”å‡ºå—ï¼Ÿâ€¦â€¦é—®ä¸€å¥è€Œå·²ï¼Œåˆæ²¡å«ä½ å»ã€‚"`, mood:'æš—ç¤º'},
                {scene:'ç¾æœ¯å®¤', line:`"è¿™æ˜¯æˆ‘ç”»çš„ä½ ã€‚æ‹¿å»å§ï¼Œä¸è¦ä¸è¦è¿™ä¹ˆæƒŠè®¶ï¼Œä½ è¡¨æƒ…å¤ªæœ‰è¶£äº†ã€‚"`, mood:'å¤§èƒ†'},
                {scene:'æ“åœº', line:`"é‚£ä¸ªâ€¦â€¦æˆ‘æƒ³ç»™ä¸€ä¸ªäººç”»ç”»ï¼Œä½†æˆ‘ä¸çŸ¥é“ä»–å–œä¸å–œæ¬¢ã€‚"`, mood:'ç¾æ¶©'}
            ],
            high: [
                {scene:'æ¼«å±•', line:`"æˆ‘å…¶å®â€¦â€¦å¾ˆæ€•æœ‰ä¸€å¤©ç”»ä¸å‡ºä¸œè¥¿äº†ã€‚ä½ ä¸ä¼šè¯´æˆ‘çŸ«æƒ…å—ï¼Ÿ"`, mood:'è¢’éœ²'},
                {scene:'æ±Ÿè¾¹', line:`"å¦‚æœæˆ‘å»äº†ç±³å…°ï¼Œä½ ä¼šæ¥çœ‹æˆ‘çš„ç”»å±•å—ï¼Ÿ"`, mood:'æœŸå¾…'},
                {scene:'ç”»å®¤å¤œæ™š', line:`"æˆ‘ä¸çŸ¥é“çˆ±æƒ…æ˜¯ä»€ä¹ˆã€‚ä½†æˆ‘çŸ¥é“ç”»ä½ çš„æ—¶å€™ï¼Œæˆ‘çš„çº¿æ¡æ¯”ä»¥å‰æ›´ç¨³äº†ã€‚"`, mood:'æ·±æƒ…'}
            ]
        },
        'jiang': {
            low: [
                {scene:'æ“åœº', line:`"å“Ÿï¼Œæ¥çœ‹çƒï¼Ÿç«™è¿œç‚¹ï¼Œåˆ«æŒ¡ç€ã€‚"`, mood:'æ¼«ä¸ç»å¿ƒ'},
                {scene:'èµ°å»Š', line:`"å“ˆå“ˆä¸ç”¨è°¢ï¼Œéšæ‰‹çš„äº‹ã€‚"`, mood:'éšæ„'},
                {scene:'é£Ÿå ‚', line:`"é‚£ä¸ªåº§ä½æœ‰äººçš„ï¼Œæˆ‘æœ‹å‹çš„ã€‚"`, mood:'ç–è¿œ'}
            ],
            mid: [
                {scene:'ç¯®çƒåœº', line:`"çœ‹ä½ è·‘æ­¥å§¿åŠ¿ä¸å¯¹ï¼Œç­‰æ”¾å­¦æˆ‘æ•™ä½ ã€‚"`, mood:'ä¸»åŠ¨'},
                {scene:'æ¯”èµ›å', line:`"ä»Šå¤©ä½ æ¥çœ‹äº†ï¼Œæ˜¯å§ï¼Ÿè°¢äº†â€¦â€¦æˆ‘æ‰“å¾—è¿˜è¡Œå§ï¼Ÿ"`, mood:'åœ¨æ„'},
                {scene:'æ“åœºè¾¹', line:`"æˆ‘æ‰‹è¿™é‡Œâ€¦â€¦æ²¡äº‹ï¼Œè€æ¯›ç—…ã€‚ä½ åˆ«å£°å¼ å•Šï¼Œä¸ç„¶ä¸»ä»»åˆè®©æˆ‘ä¼‘èµ›ã€‚"`, mood:'ä¿¡ä»»'}
            ],
            high: [
                {scene:'æ·±å¤œæ“åœº', line:`"æˆ‘å…¶å®æ€•æ‰“ä¸äº†çƒäº†ã€‚ä½†æˆ‘æ›´æ€•â€¦â€¦ä¸çŸ¥é“å¦‚æœæ²¡æœ‰çƒï¼Œæˆ‘æ˜¯è°ã€‚"`, mood:'çœŸå®'},
                {scene:'æ¯”èµ›å‰', line:`"ä½ ä»Šå¤©ä¸€å®šè¦æ¥å•Šã€‚è®¤çœŸçš„ï¼Œä¸æ˜¯å¼€ç©ç¬‘ï¼Œæˆ‘â€¦â€¦éœ€è¦ä½ åœ¨åœºè¾¹ã€‚"`, mood:'ä¾èµ–'},
                {scene:'çƒ§çƒ¤æ‘Š', line:`"ä½ æ˜¯ç¬¬ä¸€ä¸ªâ€¦â€¦è®©æˆ‘è§‰å¾—ï¼Œå“ªæ€•ä¸æ‰“çƒï¼Œä¹Ÿè¿˜å¥½çš„äººã€‚"`, mood:'æ·±æƒ…'}
            ]
        },
        'shen': {
            low: [
                {scene:'èµ°å»Š', line:`"â€¦â€¦"ï¼ˆæˆ´ç€è€³æœºï¼Œæ²¡æœ‰å›åº”ï¼‰`, mood:'å°é—­'},
                {scene:'æ•™å®¤', line:`"æœ‰äº‹å—ï¼Ÿæ²¡äº‹åˆ«çƒ¦æˆ‘ã€‚"`, mood:'é˜²å¾¡'},
                {scene:'é—¨å£', line:`"å€Ÿæ©¡çš®ï¼Ÿè¿™ã€‚ä¸ç”¨è¿˜äº†ã€‚"`, mood:'å†·æ¼ '}
            ],
            mid: [
                {scene:'ä¾¿åˆ©åº—', line:`"â€¦â€¦ä½ ä¹Ÿä¹°è¿™ä¸ªå£å‘³å—ã€‚"ï¼ˆæ²‰é»˜ï¼‰"â€¦â€¦å¥½åƒå°±è¡Œã€‚"`, mood:'æ„å¤–'},
                {scene:'èµ°å»Š', line:`"ä½ â€¦â€¦çœ‹åˆ°æˆ‘ä»å“ªé‡Œæ¥äº†ï¼Ÿï¼ˆåœé¡¿ï¼‰â€¦â€¦åˆ«é—®ã€‚"`, mood:'ç´§å¼ '},
                {scene:'å¤©å°', line:`"ä½ ä¸é—®æˆ‘ä¸ºä»€ä¹ˆæ€»æ˜¯å¾ˆæ™šå›æ¥ï¼Œæ˜¯å› ä¸ºä½ çŒœåˆ°äº†ï¼Œè¿˜æ˜¯ä½ æ ¹æœ¬ä¸åœ¨ä¹ï¼Ÿ"`, mood:'è¯•æ¢'}
            ],
            high: [
                {scene:'ä¾¿åˆ©åº—æ·±å¤œ', line:`"æˆ‘å¼Ÿè¯´â€¦â€¦æœ‰äººå¸®ä»–å«äº†é¥­é’±ã€‚æ˜¯ä½ å—ã€‚ï¼ˆæ²‰é»˜ï¼‰â€¦â€¦è°¢è°¢ã€‚"`, mood:'åŠ¨å®¹'},
                {scene:'æ¥¼æ¢¯å£', line:`"æˆ‘ä¸æ˜¯ä¸æƒ³è¯´ã€‚æ˜¯æ€•è¯´äº†ï¼Œä½ ç”¨é‚£ç§çœ¼ç¥çœ‹æˆ‘ã€‚"`, mood:'è„†å¼±'},
                {scene:'å¤©å°å¤œæ™š', line:`"ä½ æ˜¯ç¬¬ä¸€ä¸ªâ€¦â€¦ä¸é—®åŸå› ã€ä¸ç»™å»ºè®®ã€åªæ˜¯åœ¨çš„äººã€‚"`, mood:'è¢’éœ²'}
            ]
        }
    };

    function showDeepCrushDialog(cid) {
        if(stuGame.energy < 5) return showToast("ç²¾åŠ›ä¸è¶³ï¼ˆéœ€è¦5ç‚¹ï¼‰");
        if(!stuGame.crushes[cid]) return showToast("å…ˆå»è®¤è¯†å¥¹/ä»–å§ï¼");
        stuGame.energy -= 5;
        let ch = CRUSHES.find(x=>x.id===cid);
        let aff = (stuGame.crushes[cid]&&stuGame.crushes[cid].aff)||0;
        let tier = aff>=70?'high':aff>=35?'mid':'low';
        let pool = DEEP_CRUSH_DIALOGUES[cid][tier];
        let entry = pool[Math.floor(Math.random()*pool.length)];
        let prof = CRUSH_PROFILES[cid];
        let moodColor = {å¿ƒåŠ¨:'#db2777',æ·±æƒ…:'#7c3aed',è„†å¼±:'#6366f1',ä¿¡ä»»:'#0284c7',è¢’éœ²:'#0891b2',çœŸå®:'#0f766e',è¯•æ¢:'#b45309',ç¾æ¶©:'#be185d',æœŸå¾…:'#7c3aed',åœ¨æ„:'#0369a1',ä¾èµ–:'#0369a1',å¤§èƒ†:'#7c3aed',æš—ç¤º:'#92400e',å…³æ³¨:'#065f46',æƒŠè®¶:'#1d4ed8',è­¦æƒ•:'#475569',å†·æ·¡:'#475569',ç–è¿œ:'#64748b',æˆ’å¤‡:'#475569',é˜²å¾¡:'#475569',éšæ„:'#64748b',æ¼«ä¸ç»å¿ƒ:'#94a3b8',æ— è§†:'#9ca3af',æ„å¤–:'#b45309',ç´§å¼ :'#b45309',å°é—­:'#475569',å†·æ¼ :'#94a3b8',åŠ¨å®¹:'#0891b2',æŠ—æ‹’:'#dc2626'}[entry.mood]||'#475569';
        let html = `<div style="display:flex;gap:15px;align-items:flex-start;">
            <div style="flex-shrink:0;text-align:center;">
                <div style="width:60px;height:80px;border-radius:8px;overflow:hidden;border:2px solid #f9a8d4;background:${prof.color}22;display:flex;align-items:center;justify-content:center;">
                    <span style="font-size:2.5rem;">${prof.icon}</span>
                </div>
                <div style="font-size:0.65rem;color:${moodColor};font-weight:bold;margin-top:4px;">${entry.mood}</div>
            </div>
            <div style="flex:1;">
                <div style="font-size:0.7rem;color:#94a3b8;margin-bottom:6px;">ğŸ“ ${entry.scene}</div>
                <div style="background:#f8fafc;border-left:3px solid ${prof.color};padding:10px 14px;border-radius:0 8px 8px 0;">
                    <p style="margin:0;font-size:0.92rem;color:#1e293b;line-height:1.7;">${entry.line}</p>
                </div>
                <div style="margin-top:8px;font-size:0.72rem;color:#64748b;">å½“å‰å¥½æ„Ÿï¼š${Math.floor(aff)}/100 ${aff>=70?'ğŸ’— å¥¹/ä»–çš„å¿ƒå‘ä½ æ•å¼€äº†':aff>=35?'ğŸ’› åœ¨æ…¢æ…¢å¸ä¸‹é˜²å¤‡':'ğŸ©¶ è¿˜åœ¨è¯•æ¢ä½ '}</div>
            </div>
        </div>`;
        showCustomModal(`ğŸ’¬ ${ch.name} è¯´â€¦â€¦`, html, [
            {text:'è®¤çœŸå¬ï¼Œç»™äºˆå›åº” (+å¥½æ„Ÿ)', action:()=>{
                let data = stuGame.crushes[cid]; data.aff=Math.min(100,data.aff+5);
                stuGame.energy=Math.max(0,stuGame.energy-5);
                checkCrushBuff(cid); renderStuCrushes(); updateStuUI();
                showToast(`ä¸${ch.name}çš„è·ç¦»æ›´è¿‘äº† (+5å¥½æ„Ÿ)`);
            }},
            {text:'æ•·è¡åº”ä»˜ (-å°‘é‡å¥½æ„Ÿ)', action:()=>{
                let data = stuGame.crushes[cid]; data.aff=Math.max(0,data.aff-3);
                renderStuCrushes(); updateStuUI();
            }},
            {text:'é»˜é»˜é™ªä¼´ (æ— å˜åŒ–ä½†åŠ æ·±å°è±¡)', action:()=>{renderStuCrushes(); updateStuUI();}}
        ]);
    }
    
    function adjustSchedule(t) {
        let val = parseInt(document.getElementById('range-'+t).value);
        game.schedule[t] = val;
        document.getElementById('lbl-'+t+'-hr').innerText = val + "èŠ‚";
        
        let total = game.schedule.main + game.schedule.minor + game.schedule.spec;
        document.getElementById('sch-total-hr').innerText = total;
        let warnBox = document.getElementById('sch-warn-box');
        if(total > 50) { warnBox.style.display='block'; warnBox.innerHTML='âš ï¸ <b>æåº¦å±é™©ï¼š</b>å­¦ç”Ÿæ¿’ä¸´çŒæ­»ï¼'; }
        else if(game.schedule.main > 25) { warnBox.style.display='block'; warnBox.innerHTML='âš ï¸ <b>å±é™©è­¦å‘Šï¼š</b>ä¸»ç§‘æ’è¯¾æ•°è‹¥è¶…è¿‡ <b>25èŠ‚</b>ï¼Œäº§ç”Ÿçš„æ€ç»´ç†µå¢å°†å‘ˆ<b>æŒ‡æ•°çº§çˆ†ç‚¸</b>ï¼'; }
        else { warnBox.style.display='none'; }
        updateUI();
    }

    function upgradeTeacher(k) { if(game.teachers[k]<2 && payCost(0,50)) { game.teachers[k]++; updateUI(); } }
    function triggerGaokao() { 
        let total = game.students;
        let baseScore = game.grade * 6.5 + 120 + Math.random() * 30 - 15;
        game.lastGaokaoAvg = Math.floor(baseScore);
        
        let t_qb = Math.floor(total * (baseScore > 680 ? (baseScore-680)/350 : 0)); 
        let t_985 = Math.floor(total * (baseScore > 600 ? (baseScore-600)/320 : 0)); 
        let t_211 = Math.floor(total * (baseScore > 550 ? (baseScore-550)/280 : 0)); 
        let t_bk = Math.floor(total * (baseScore > 450 ? (baseScore-450)/240 : 0)); 
        let t_zk = Math.floor(total * (baseScore > 300 ? (baseScore-300)/200 : 0)); 
        t_985 = Math.max(0, t_985 - t_qb);
        t_211 = Math.max(0, t_211 - t_985 - t_qb);
        t_bk = Math.max(0, t_bk - t_211 - t_985 - t_qb);
        t_zk = Math.max(0, t_zk - t_bk - t_211 - t_985 - t_qb);
        let t_fail = Math.max(0, total - t_qb - t_985 - t_211 - t_bk - t_zk);
        
        let uplinePct = Math.floor((total - t_fail)/total*100);
        let repGain = t_qb * 5 + t_985 * 2 + t_211 * 1 + Math.floor(uplinePct * 2);
        game.reputation += repGain;
        
        game.gaokaoHistory.push({ year: game.year, avg: game.lastGaokaoAvg, qb: t_qb, rep985: t_985, p211: t_211, bk: t_bk, zk: t_zk, fail: t_fail, upline: uplinePct });
        
        let historyHtml = '';
        if(game.gaokaoHistory.length > 1) {
            historyHtml = `<div style="margin-top:15px; border-top:2px dashed #e2e8f0; padding-top:15px;">
                <h4 style="text-align:center; margin:0 0 10px 0; color:#1e293b;">ğŸ“ˆ å†å¹´é«˜è€ƒæ¸…åŒ—äººæ•°å¯¹æ¯”</h4>
                <div style="display:flex; align-items:flex-end; justify-content:space-around; height:120px; background:#f8fafc; border-radius:8px; padding:10px 5px 0; border:1px solid #e2e8f0;">`;
            let maxQb = Math.max(1, ...game.gaokaoHistory.map(h=>h.qb||0));
            game.gaokaoHistory.slice(-8).forEach(h => {
                let barH = Math.max(5, Math.floor((h.qb/Math.max(1,maxQb))*100));
                historyHtml += `<div style="display:flex;flex-direction:column;align-items:center;width:11%;">
                    <div style="font-size:0.6rem;color:#ef4444;font-weight:bold;">${h.qb}</div>
                    <div style="background:#ef4444;width:100%;height:${barH}px;border-radius:2px 2px 0 0;min-height:4px;"></div>
                    <div style="font-size:0.55rem;color:#64748b;margin-top:3px;">${h.year}</div>
                </div>`;
            });
            historyHtml += `</div></div>`;
        }
        
        let html = `
        <div class="chart-container" style="width:100%;">
            <div class="chart-col"><div class="chart-bar" style="background:#ef4444; height:${Math.max(2, (t_qb/total)*150)}px;">${t_qb}</div><div class="chart-label">æ¸…åŒ—</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#8b5cf6; height:${Math.max(2, (t_985/total)*150)}px;">${t_985}</div><div class="chart-label">985</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#3b82f6; height:${Math.max(2, (t_211/total)*150)}px;">${t_211}</div><div class="chart-label">211</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#10b981; height:${Math.max(2, (t_bk/total)*150)}px;">${t_bk}</div><div class="chart-label">ä¸€æœ¬</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#f59e0b; height:${Math.max(2, (t_zk/total)*150)}px;">${t_zk}</div><div class="chart-label">äºŒæœ¬</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#64748b; height:${Math.max(2, (t_fail/total)*150)}px;">${t_fail}</div><div class="chart-label">è½æ¦œ</div></div>
        </div>
        <p style="text-align:center;"><b>${game.year}å¹´é«˜è€ƒ</b> | å‡åˆ†: ${game.lastGaokaoAvg} | ä¸Šçº¿ç‡: ${uplinePct}% | å£°èª‰ +${repGain}</p>
        ${historyHtml}`;
        
        log(`ğŸ“ ${game.year}å¹´é«˜è€ƒæ­æ™“ï¼å‡åˆ†${game.lastGaokaoAvg}ï¼Œæ¸…åŒ—${t_qb}äººï¼Œä¸Šçº¿ç‡${uplinePct}%ï¼Œå£°èª‰+${repGain}`, "var(--success)");
        
        // å­¦ç”Ÿæ¨¡å¼ï¼šé«˜ä¸‰ï¼ˆturn>=25ï¼‰é«˜è€ƒåè‡ªåŠ¨å¼¹å‡ºç»“å±€
        let isStudentFinalGaokao = stuGame.active && stuGame.turn >= 25;
        let afterBtns = [];
        if(isStudentFinalGaokao) {
            afterBtns = [{text:"ğŸ“œ æŸ¥çœ‹æˆ‘çš„ç»“å±€ â†’", action:()=>{ showFinalRating('student'); }}];
        } else {
            afterBtns = [{text:"ç¡®è®¤å½’æ¡£", action:updateUI}];
        }
        
        showCustomModal(`ğŸ“ ${game.year}å¹´ Â· é«˜è€ƒæˆç»©å…¬å‘Š`, html, afterBtns);
    }
    function triggerEnrollment() { showCustomModal("å¼€å­¦", "ä¹æœˆæ–°å­¦æœŸå¼€å§‹ï¼Œè¿æ¥æ–°ç”Ÿä¸æ–°ç”Ÿå­¦è´¹ï¼", [{text:"OK", action:updateUI}]); }

    // æ‰§è¡Œå…¥å£
    try { init(); } catch(e) { console.error('Init failed:', e); showDifficultySelect(); }
</script>
</body>
</html>

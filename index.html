<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµå®å­”å­å­¦æ ¡ - V0.0.2</title>
    <style>
        :root {
            --bg-body: #0f172a; --panel-bg: rgba(255, 255, 255, 0.95);
            --board-bg: #1e293b; --chalk-white: #f8f9fa; --chalk-yellow: #fde047; --chalk-blue: #60a5fa;
            --primary: #2563eb; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --purple: #8b5cf6;
            --gold: #fbbf24; --wood: #452912;
            --radius: 12px; --shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: var(--bg-body); background-image: radial-gradient(circle at top, #1e293b, #0f172a); color: #334155; margin: 0; padding: 10px; display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden;}
        .container { width: 100%; max-width: 1450px; display: grid; gap: 15px; grid-template-columns: 310px 1fr 310px; transition: 0.5s; }
        
        .header-banner { grid-column: 1 / -1; background: linear-gradient(135deg, #7f1d1d, #991b1b); color: #fff; text-align: center; padding: 15px; border-radius: var(--radius); border: 3px solid #fca5a5; box-shadow: var(--shadow); position: relative; }
        .header-banner h1 { margin: 0; font-size: 2.2rem; letter-spacing: 2px; color: var(--chalk-yellow); text-shadow: 2px 2px 5px rgba(0,0,0,0.6); }
        .sys-bar { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; background: var(--panel-bg); padding: 10px 20px; border-radius: var(--radius); box-shadow: var(--shadow); flex-wrap: wrap; gap:10px;}
        .school-badge { padding: 5px 12px; background: linear-gradient(135deg, #fef08a, var(--gold)); color: #713f12; border-radius: 20px; font-weight: 800; border: 1px solid #d97706;}
        .sys-btn { padding:6px 12px; cursor:pointer; background:#f8fafc; border:1px solid #cbd5e1; border-radius:6px; font-weight:bold; transition: 0.2s; color: #1e293b; display: inline-flex; align-items: center; gap: 4px; font-size: 0.85rem;}
        .sys-btn:hover:not(:disabled) { background: #e2e8f0; transform: translateY(-1px); }
        .btn-auto.active { background: var(--danger); color: white; border-color: #b91c1c; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(239,68,68,0.5);} 70% {box-shadow: 0 0 0 8px rgba(239,68,68,0);} 100% {box-shadow: 0 0 0 0 rgba(239,68,68,0);} }

        .panel { background: var(--panel-bg); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); display:flex; flex-direction: column; }
        .panel-title { font-size: 1.1rem; font-weight: 800; border-bottom: 3px solid var(--primary); padding-bottom: 8px; margin-top: 0; margin-bottom: 12px; color: #1e293b; display:flex; justify-content:space-between; align-items:flex-end;}
        
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .res-box { background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; position: relative;}
        .res-box span { display: block; font-size: 1.2rem; font-weight: 900; color: var(--primary); margin-top: 5px; font-family: monospace;}
        .res-sub { font-size: 0.7rem; color: var(--danger); position: absolute; bottom: 2px; right: 5px; font-weight:bold;}

        .blackboard { background: var(--board-bg); border: 8px solid var(--wood); border-radius: 6px; padding: 15px; color: var(--chalk-white); box-shadow: inset 0 0 15px rgba(0,0,0,0.8); }
        .stat-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem; font-weight: bold; position:relative;}
        .stat-label { width: 85px; color: var(--chalk-blue); z-index:2;}
        .bar-bg { flex: 1; height: 18px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); margin: 0 10px; position:relative;}
        .bar-fill { height: 100%; transition: width 0.3s ease-out; background-image: linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 10px 100%;}
        .stat-val { width: 35px; text-align: right; font-family: monospace; font-size: 1.1rem; color: var(--chalk-yellow); z-index:2;}
        .stress-warning { color: #fca5a5; font-size: 0.75rem; text-align: center; animation: blink 0.8s infinite; margin-top:-5px; font-weight:bold;}
        @keyframes blink { 50% { opacity: 0.5; } }

        .btn { width: 100%; padding: 10px; background: #fff; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; text-align: left; transition: 0.2s; font-weight: bold; color: #334155; display:flex; flex-direction:column; margin-bottom:8px;}
        .btn:hover:not(:disabled) { border-color: var(--primary); background: #eff6ff; transform: translateX(3px); }
        .btn:disabled { background: #f1f5f9; border-color: #cbd5e1; color: #94a3b8; cursor: not-allowed; }
        .btn-desc { font-size: 0.7rem; color: #64748b; font-weight: normal; margin-top: 4px; }
        .btn-main { background: linear-gradient(135deg, var(--primary), #1e40af); color: white; border: none; font-size: 1.2rem; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 900; width: 100%; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.4); text-align:center;}
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(37, 99, 235, 0.6);}

        .fs-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.85); z-index: 2000; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(4px);}
        .fs-content { background: #f8fafc; width: 100%; max-width: 1300px; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.5);}
        .fs-header { background: #1e293b; color: white; padding: 15px 20px; display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; align-items:center;}
        .fs-close { background: transparent; border: none; color: white; font-size: 1.8rem; cursor: pointer; line-height:1;}
        .fs-body { padding: 20px; overflow-y: auto; flex: 1; }

        .grid-sys { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
        .gacha-card { background: #fff; border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 15px; position:relative;}
        .upkeep-tag { position:absolute; top:5px; right:5px; font-size:0.7rem; background:#fee2e2; color:#991b1b; padding:2px 5px; border-radius:4px; font-weight:bold;}
        .rarity-R { border-color: #3b82f6; box-shadow: 0 0 10px rgba(59,130,246,0.2); }
        .rarity-SR { border-color: #a855f7; box-shadow: 0 0 15px rgba(168,85,247,0.3); }
        .rarity-SSR { border-color: var(--gold); box-shadow: 0 0 20px rgba(251,191,36,0.5); background: linear-gradient(135deg, #fff, #fefce8);}
        
        .tree-tier { display: flex; gap: 15px; justify-content: center; width: 100%; margin-bottom: 25px; flex-wrap: wrap; }
        .tree-node { width: 220px; background:#fff; border: 2px solid #cbd5e1; border-radius: 8px; padding: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.3s; display: flex; flex-direction: column; justify-content: space-between;}
        .tree-node.locked { filter: grayscale(1); opacity: 0.6; }
        .tree-node.unlocked { border-color: var(--success); box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); background:#f0fdf4;}
        .tree-node.branch-a { border-top: 5px solid var(--danger); }
        .tree-node.branch-b { border-top: 5px solid var(--warning); }
        .tree-node.branch-c { border-top: 5px solid #fbbf24; }
        .tree-node.branch-d { border-top: 5px solid var(--success); }

        .map-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background: #84cc16; padding: 15px; border-radius: 8px; border: 4px solid #4d7c0f;}
        .map-cell { background: rgba(255,255,255,0.5); border: 2px dashed #65a30d; border-radius: 6px; height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; position: relative;}
        .map-cell:hover { background: rgba(255,255,255,0.9); }
        .map-cell.selected { border: 3px solid var(--danger); background: #fff; }

        .log-box { flex: 1; overflow-y: auto; font-size: 0.85rem; background: #fff; border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; line-height: 1.5; }
        .log-item { margin-bottom: 8px; border-bottom: 1px dashed #e2e8f0; padding-bottom: 4px; }
        
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; backdrop-filter: blur(2px);}
        .modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 550px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);}
        .modal-btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 8px; font-weight: bold; font-size: 1rem; transition: 0.2s; display:inline-flex; flex-direction:column; align-items:center;}
        .modal-btn:hover { background: #1d4ed8; transform: translateY(-2px); }
        .event-eff { font-size:0.75rem; color:#fde047; margin-top:4px; font-weight:normal; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none;}
        .toast { background: rgba(15,23,42,0.95); color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold; border-left: 4px solid var(--primary); animation: slideIn 0.3s forwards, fadeOut 0.5s 3.5s forwards; box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
        @keyframes slideIn { from{transform: translateX(100%);} to{transform: translateX(0);} }
        @keyframes fadeOut { to{transform: translateY(-20px); opacity:0;} }

        /* å­¦ç”Ÿæ¨¡å¼æ ·å¼ */
        #student-container { display: none; width: 100%; max-width: 1200px; background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px; margin: 0 auto; box-shadow: var(--shadow); }
        .stu-grid { display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        .stu-act-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;}
        .stu-act-btn { padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; background: #fff; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; transition:0.2s; text-align:left;}
        .stu-act-btn:hover { border-color: var(--primary); background: #eff6ff; transform:scale(1.02); }
        .stu-stat-box { background: #1e293b; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .exam-board { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; border: 3px solid #047857;}
    </style>
</head>
<body>

<div id="toast-container"></div>
<input type="file" id="import-file" style="display:none;" accept=".json" onchange="importData(event)">

<!-- ================= æ ¡é•¿æ¨¡å¼ ================= -->
<div class="container" id="principal-container">
    <div class="header-banner">
        <h1>å­”å­å­¦æ ¡ V0.0.2</h1>
        <p style="margin: 5px 0 0 0; font-size: 0.95rem; opacity: 0.9;">By ChansonTech</p>
    </div>

    <div class="sys-bar">
        <div style="display:flex; align-items:center; gap: 10px;">
            <span class="school-badge" id="ui-level-name">ğŸ† ä¹¡é•‡ä¸­å­¦</span>
            <button class="sys-btn" onclick="checkUpgrade()">ğŸ–ï¸ ç”³è¯·è¯„çº§</button>
            <button class="sys-btn btn-auto" id="btn-auto" onclick="toggleAuto()">ğŸ¤– è‡ªåŠ¨æ¨æ¼”</button>
        </div>
        <div style="display:flex; gap: 8px; align-items:center;">
            <button class="sys-btn" style="background:var(--purple); color:white; border:none;" onclick="switchMode('student')">ğŸ‘¨â€ğŸ“ åˆ‡æ¢è‡³ï¼šå­¦ç”Ÿä¸‰é‡è§†è§’</button>
            <span id="ui-diff-badge" style="font-size:0.8rem; background:#475569; color:white; padding:4px 8px; border-radius:4px; font-weight:bold;">éš¾åº¦: æ­£å¸¸</span>
            <button class="sys-btn" onclick="exportData()">ğŸ“¤ å¯¼å‡º</button>
            <button class="sys-btn" onclick="document.getElementById('import-file').click()">ğŸ“¥ å¯¼å…¥</button>
            <button class="sys-btn" onclick="hardReset()" style="color:var(--danger)">ğŸ”„ é‡ç”Ÿ</button>
        </div>
    </div>

    <div class="panel">
        <h2 class="panel-title">ğŸ“Š è´¢åŠ¡ä¸æ¦‚å†µ</h2>
        <div class="res-grid">
            <div class="res-box">æ€»èµ„é‡‘(ä¸‡) <span id="ui-funds" style="color:#059669;">100</span><div class="res-sub" id="ui-salary">å‡€è€—:-0</div></div>
            <div class="res-box">åœ¨æ ¡ç”Ÿè§„æ¨¡ <span id="ui-students" style="color:#2563eb;">300</span></div>
            <div class="res-box">ç¤¾ä¼šå£°èª‰ <span id="ui-rep" style="color:var(--warning)">100</span></div>
            <div class="res-box">è¡Œæ”¿ AP <span><span id="ui-ap">10</span>/<span id="ui-maxap">20</span></span></div>
        </div>

        <h2 class="panel-title" style="margin-top: 5px;">ğŸ§¬ ç”Ÿæºäº”ç»´çŠ¶æ€</h2>
        <div class="blackboard">
            <div class="stat-row"><div class="stat-label">ğŸ“š å­¦ä¸šåŸºç¡€</div><div class="bar-bg"><div id="bar-grade" class="bar-fill" style="background:linear-gradient(90deg, #3b82f6, #60a5fa);"></div></div><div class="stat-val" id="val-grade">40</div></div>
            <div class="stat-row" style="margin-bottom:0;"><div class="stat-label">ğŸ¤¯ ç²¾ç¥å‹åŠ›</div><div class="bar-bg"><div id="bar-stress" class="bar-fill" style="background:linear-gradient(90deg, #ef4444, #f87171);"></div></div><div class="stat-val" id="val-stress">20</div></div>
            <div class="stress-warning" id="warn-stress" style="display:none;">âš ï¸ è­¦å‘Šï¼šå‹åŠ›ä¸¥é‡æº¢å‡ºï¼Œææ˜“å¼•å‘é€€å­¦æš´ä¹±ï¼</div>
            <div class="stat-row" style="margin-top:10px;"><div class="stat-label">ğŸ›¡ï¸ çºªå¾‹ä½œé£</div><div class="bar-bg"><div id="bar-disc" class="bar-fill" style="background:linear-gradient(90deg, #f59e0b, #fbbf24);"></div></div><div class="stat-val" id="val-disc">60</div></div>
            <div class="stat-row"><div class="stat-label">ğŸƒâ€â™‚ï¸ èº«ä½“ç´ è´¨</div><div class="bar-bg"><div id="bar-fit" class="bar-fill" style="background:linear-gradient(90deg, #10b981, #34d399);"></div></div><div class="stat-val" id="val-fit">50</div></div>
            <div class="stat-row"><div class="stat-label">ğŸ¨ è‰ºæœ¯æ¶µå…»</div><div class="bar-bg"><div id="bar-art" class="bar-fill" style="background:linear-gradient(90deg, #8b5cf6, #a78bfa);"></div></div><div class="stat-val" id="val-art">30</div></div>
        </div>
    </div>

    <div class="panel">
        <div style="text-align: center; margin-bottom: 15px; background:#f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div id="ui-date" style="font-size: 1.6rem; font-weight: 900; color: var(--primary); letter-spacing: 1px;">2018å¹´ 9æœˆ</div>
        </div>
        <button class="btn-main" id="btn-advance" onclick="advanceMonth()">â³ æ¨è¿›ä¸€ä¸ªæœˆ (æ ¡é•¿æ‰¹ç¤º)</button>

        <h2 class="panel-title">ğŸ§  æ ¸å¿ƒä¸­æ¢</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom:15px;">
            <button class="btn" style="background:#ecfdf5; border-color:#10b981;" onclick="openModal('modal-map')">ğŸ—ºï¸ æ ¡å›­è§„åˆ’æ²™ç›’<span class="btn-desc">ä¿®å»º10å¤§åœ°æ ‡å»ºç­‘</span></button>
            <button class="btn" style="background:#eff6ff; border-color:#3b82f6;" onclick="openModal('modal-experts')">ğŸ‘¨â€ğŸ« å¯»è®¿é¡¶çº§ä¸“å®¶<span class="btn-desc">æ”¶é›†20å¤§ä¼ è¯´çº§åå¸ˆ</span></button>
            <button class="btn" style="background:#faf5ff; border-color:#a855f7;" onclick="openModal('modal-schedule')">ğŸ“… å¸ˆèµ„ä¸ä¸»ç§‘æ’è¯¾<span class="btn-desc">æ’è¯¾è¶Šå¤šï¼Œå‹åŠ›å‘ˆæŒ‡æ•°çˆ†ç‚¸</span></button>
            <button class="btn" style="background:#fefce8; border-color:#eab308;" onclick="openModal('modal-policy')">ğŸ« å›½å®¶æ ¡ç­–ç§‘æŠ€æ ‘<span class="btn-desc">æ•™ç ”ç‚¹: <span id="ui-eduPoints" style="font-weight:bold;color:var(--danger)">0</span></span></button>
        </div>

        <h2 class="panel-title">ğŸ¯ æˆ˜æœ¯æ‰©å¼  <span style="font-size:0.75rem; font-weight:normal; color:#64748b;">(åŠ¨æ€è†¨èƒ€)</span></h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <button class="btn" onclick="organizeExam()">ğŸ“ æ¨¡æ‹Ÿå¤§è”è€ƒ<span class="btn-desc">è€—AP:3, ï¿¥<span id="cost-exam" class="c-val">2</span>ä¸‡ | èµšå–æ•™ç ”ç‚¹</span></button>
            <button class="btn" onclick="runAction('marketing')">ğŸ“¢ åª’ä½“ä¹°é‡æ‹›ç”Ÿ<span class="btn-desc">è€—ï¿¥<span id="cost-mar" class="c-val">10</span>ä¸‡ | å¤§å¹…æ‹”é«˜å£°èª‰</span></button>
            <button class="btn" onclick="runAction('sponsor')">ğŸ¤ å®´è¯·æ‹‰èµåŠ©<span class="btn-desc">è€—AP:4, é™å£°èª‰ | å¾—ï¿¥<span id="gain-spo" style="color:var(--success)">100</span>ä¸‡</span></button>
            <button class="btn" onclick="openModal('modal-achieve')">ğŸ† è£èª‰å›¾é‰´<span class="btn-desc">æŸ¥çœ‹20å¤§ç©¶ææˆå°±</span></button>
            <button class="btn" id="btn-branch" style="grid-column: 1/-1; background:#fff7ed; border-color:#f97316;" onclick="openModal('modal-branch')">ğŸŒ å¼€å¯å…¨çƒåˆ†æ ¡å®å›¾ (10å¤§æ ¡åŒº)<span class="btn-desc">éœ€: å…¨å›½é¡¶å°–è¯„çº§</span></button>
        </div>
    </div>

    <div class="panel">
        <h2 class="panel-title">ğŸ“œ çºªäº‹æœ¬æœ«</h2>
        <div class="log-box" id="log-box"></div>
    </div>
</div>

<!-- ================= å­¦ç”Ÿæ¨¡å¼ ================= -->
<div id="student-container">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 3px solid var(--purple); padding-bottom:10px; margin-bottom:20px;">
        <h1 style="margin:0; color:var(--purple);">ğŸ‘¨â€ğŸ“ å­¦ç”Ÿè§†è§’ï¼šä¸‰å¹´é€†è¢­ä½“éªŒ</h1>
        <button class="sys-btn" onclick="switchMode('principal')">ğŸ”™ æ”¾å¼ƒå­¦ä¸šï¼Œè¿”å›æ ¡é•¿æ¨¡å¼</button>
    </div>

    <div id="stu-setup" style="text-align:center; padding: 40px;">
        <h2>é€‰æ‹©ä½ çš„åˆå§‹å¤©èµ‹ï¼ˆéš¾åº¦ï¼‰</h2>
        <p style="color:#64748b;">å½“å‰æ¯æ ¡çš„è¯¾ç¨‹å®‰æ’ä¸æ”¿ç­–å°†ç›´æ¥å½±å“ä½ è¿™ä¸‰å¹´çš„ç”Ÿæ´»éš¾åº¦ã€‚</p>
        <div style="display:flex; justify-content:center; gap:20px; margin-top:30px;">
            <button class="btn-main" style="width:200px; background:#10b981;" onclick="startStudentMode(3)">å¤©æ‰å­¦ç¥ (ç®€å•)<br><span style="font-size:0.8rem;font-weight:normal">èµ„è´¨æä½³ï¼Œå®¹æ˜“æ¶ˆåŒ–çŸ¥è¯†</span></button>
            <button class="btn-main" style="width:200px; background:#3b82f6;" onclick="startStudentMode(2)">æ™®é€šå­¦ç”Ÿ (æ­£å¸¸)<br><span style="font-size:0.8rem;font-weight:normal">èµ„è´¨å¹³å¹³ï¼Œå®¹æ˜“å´©æºƒ</span></button>
            <button class="btn-main" style="width:200px; background:#ef4444;" onclick="startStudentMode(1)">å­¦æ¸£å¼€å±€ (å›°éš¾)<br><span style="font-size:0.8rem;font-weight:normal">ä¹¦éƒ½çœ‹ä¸æ‡‚ï¼Œéš¾å¦‚ç™»å¤©</span></button>
        </div>
    </div>

    <div id="stu-gameplay" style="display:none;" class="stu-grid">
        <!-- å·¦ä¾§çŠ¶æ€ -->
        <div>
            <div class="stu-stat-box">
                <h3 style="margin-top:0; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;">ğŸ“Š ä¸ªäººçŠ¶æ€é¢æ¿</h3>
                <div>ğŸ“† è¿›åº¦: é«˜<span id="stu-ui-year">ä¸€</span> <span id="stu-ui-month">ä¸Š</span>å­¦æœŸ (<span id="stu-ui-turn">1</span>/36)</div>
                <div style="margin-top:10px;">
                    <div style="display:flex; justify-content:space-between;"><span>ğŸ“š å­¦ä¸šæŒæ§</span> <span id="stu-val-grade" style="color:var(--chalk-yellow);font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>ğŸ¤¯ ç²¾ç¥å‹åŠ›</span> <span id="stu-val-stress" style="color:#fca5a5;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>ğŸƒâ€â™‚ï¸ èº«ä½“ç´ è´¨</span> <span id="stu-val-fit" style="color:#a7f3d0;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>ğŸ¨ ä¸ªäººé­…åŠ›</span> <span id="stu-val-art" style="color:#c4b5fd;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; border-top:1px dashed #475569; padding-top:5px;">
                        <span style="color:#fbbf24">ğŸ¥‡ å¥¥èµ›è¿›åº¦: <span id="stu-val-oly">0</span>%</span>
                        <span style="color:#60a5fa">âœˆï¸ ç•™å­¦å‡†å¤‡: <span id="stu-val-abr">0</span>%</span>
                    </div>
                </div>
            </div>

            <div class="exam-board">
                <h3 style="margin:0 0 5px 0;">ä¸Šæœˆå¤§å‹è”è€ƒæˆç»©</h3>
                <div style="font-size:3rem; font-weight:900; line-height:1;" id="stu-exam-score">--</div>
                <div style="font-size:0.9rem; margin-top:5px; opacity:0.9;" id="stu-exam-rank">å…¨æ ¡æ’å: å°šæœªè¿›è¡Œ</div>
            </div>

            <div style="background:#fefce8; border:1px solid #eab308; padding:10px; border-radius:6px; font-size:0.85rem; margin-bottom:15px; color:#854d0e;">
                <b>ğŸ« æ¯æ ¡ç¯å¢ƒç»¼åˆè¯„ä¼°ï¼š</b><br><span id="stu-env-desc">è®¡ç®—ä¸­...</span>
            </div>
        </div>

        <!-- å³ä¾§åŠ¨ä½œåŒº -->
        <div style="display:flex; flex-direction:column; height:100%;">
            <h2 style="margin-top:0;">ğŸ¯ å®‰æ’æœ¬æœˆçš„æ ¡å›­ç”Ÿæ´»</h2>
            <div class="stu-act-grid" style="flex:1; overflow-y:auto; padding-right:10px;">
                <button class="stu-act-btn" onclick="stuAct('hard_study')"><span style="font-size:2rem;">âœï¸</span><div><b>ç‹‚åˆ·çœŸé¢˜ç†¬å¤œ</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">å­¦ä¸š+4, å‹åŠ›+8, ä½“è´¨-1</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('study')"><span style="font-size:2rem;">ğŸ“–</span><div><b>è®¤çœŸå¬è®²åšç¬”è®°</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">å­¦ä¸š+2, å‹åŠ›+4</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('olympiad')"><span style="font-size:2rem;">ğŸ”¬</span><div><b>æ­»ç£•å¥¥æ—åŒ¹å…‹ç«èµ›</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">éš¾åº¦æé«˜,æˆåŠŸ+è¿›åº¦,å‹åŠ›+10</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('abroad')"><span style="font-size:2rem;">âœˆï¸</span><div><b>å‡†å¤‡é›…æ€æ‰˜ç¦å‡ºå›½</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">è€—è´¹ç²¾åŠ›,éœ€é­…åŠ›æ”¯æ’‘</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('internet')"><span style="font-size:2rem;">ğŸ®</span><div><b>ç¿»å¢™å»ç½‘å§åŒ…å¤œ</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">å­¦ä¸š-2, å‹åŠ›-15</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('walk')"><span style="font-size:2rem;">ğŸ§</span><div><b>æ“åœºæ•£æ­¥å¬æ­Œ</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">å­¦ä¸š-1, å‹åŠ›-8</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('sport')"><span style="font-size:2rem;">ğŸ€</span><div><b>å‚åŠ ç¤¾å›¢æ‰“çƒ</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">ä½“è´¨+3, é­…åŠ›+1, å‹åŠ›-5</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('love')"><span style="font-size:2rem;">ğŸ’Œ</span><div><b>å‘æš—æ‹å¯¹è±¡è¡¨ç™½</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">é­…åŠ›++, å‹åŠ›--, é£é™©æå¤§</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('eat')"><span style="font-size:2rem;">ğŸ”</span><div><b>å°å–éƒ¨ç‹‚åƒé›¶é£Ÿ</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">ä½“è´¨+1, å‹åŠ›-3</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('sick')"><span style="font-size:2rem;">ğŸ¥</span><div><b>è£…ç—…å»åŒ»åŠ¡å®¤èººå¹³</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">å­¦ä¸š-3, å‹åŠ›-20</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('sleep')"><span style="font-size:2rem;">ğŸ’¤</span><div><b>ä¸Šè¯¾è’™å¤´ç¡å¤§è§‰</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">å­¦ä¸š-2, å‹åŠ›-10, ä½“è´¨+1</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('book')"><span style="font-size:2rem;">ğŸ“š</span><div><b>èº²å›¾ä¹¦é¦†çœ‹é—²ä¹¦</b><br><span style="font-size:0.75rem;color:#64748b;font-weight:normal">é­…åŠ›+4, å­¦ä¸š-1, å‹åŠ›-5</span></div></button>
            </div>
            
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:10px; height: 180px; overflow-y:auto; font-size:0.85rem; margin-top:15px;" id="stu-log-box"></div>
        </div>
    </div>
</div>

<!-- ================= æ¨¡æ€æ¡†ç»„ ================= -->
<div id="modal-map" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>ğŸ—ºï¸ æ ¡å›­åŸºå»ºè§„åˆ’ (20åœ°å—)</div><button class="fs-close" onclick="closeModal('modal-map')">Ã—</button></div>
        <div class="fs-body" style="display:grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            <div class="map-grid" id="map-grid"></div>
            <div style="background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:15px; overflow-y:auto;">
                <h3 style="margin-top:0; border-bottom:2px solid #e2e8f0; padding-bottom:8px;">ğŸ› ï¸ å·¥ç¨‹å›¾çº¸</h3>
                <p id="map-hint" style="color:var(--danger); font-size:0.9rem;">è¯·å…ˆåœ¨å·¦ä¾§ç‚¹é€‰ä¸€å—ç©ºåœ°ï¼</p>
                <div id="fac-list" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </div>
    </div>
</div>

<div id="modal-experts" class="fs-modal">
    <div class="fs-content" style="max-width:1000px;">
        <div class="fs-header"><div>ğŸ‘¨â€ğŸ« çŒå¤´å¯»è®¿ç³»ç»Ÿ (20ä½é¡¶çº§ä¸“å®¶)</div><button class="fs-close" onclick="closeModal('modal-experts')">Ã—</button></div>
        <div class="fs-body">
            <div style="text-align:center; margin-bottom:20px;">
                <button class="btn-main" style="width:auto; padding:15px 40px; font-size:1.5rem;" onclick="gachaExpert()">ğŸ² æ”¯ä»˜ ï¿¥50ä¸‡ å¯»è®¿ä¸“å®¶</button>
                <p style="color:#ef4444; font-size:0.9rem; font-weight:bold;">âš ï¸ æ³¨æ„ï¼šè¶Šå¼ºåŠ›çš„ä¸“å®¶ï¼Œæ¯æœˆçš„è–ªèµ„ç»´æŠ¤è´¹è¶Šé«˜ï¼å°å¿ƒç ´äº§ï¼</p>
            </div>
            <div class="grid-sys" id="expert-container"></div>
        </div>
    </div>
</div>

<div id="modal-schedule" class="fs-modal">
    <div class="fs-content" style="max-width: 600px; height:auto;">
        <div class="fs-header"><div>ğŸ“… å¸ˆèµ„è°ƒåº¦ä¸è¯¾è¡¨åˆ¶å®š</div><button class="fs-close" onclick="closeModal('modal-schedule')">Ã—</button></div>
        <div class="fs-body">
            <div style="background:#fee2e2; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.85rem; color:#991b1b; border:1px solid #fca5a5;"><b>âš ï¸ å±é™©è­¦å‘Šï¼š</b>ä¸»ç§‘æ’è¯¾æ•°è‹¥è¶…è¿‡ <b>25èŠ‚</b>ï¼Œäº§ç”Ÿçš„ç²¾ç¥å‹åŠ›å°†å‘ˆ<b>æŒ‡æ•°çº§çˆ†ç‚¸</b>ï¼</div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn" onclick="upgradeTeacher('main')" style="flex:1">ä¸»ç§‘ç»„å‡çº§<br><span id="tch-main" style="color:var(--primary); font-size:1.1rem;">å®ä¹ </span></button>
                <button class="btn" onclick="upgradeTeacher('minor')" style="flex:1">å‰¯ç§‘ç»„å‡çº§<br><span id="tch-minor" style="color:var(--primary); font-size:1.1rem;">å®ä¹ </span></button>
                <button class="btn" onclick="upgradeTeacher('spec')" style="flex:1">ç´ è´¨ç»„å‡çº§<br><span id="tch-spec" style="color:var(--primary); font-size:1.1rem;">å®ä¹ </span></button>
            </div>
            <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; display:flex; flex-direction:column; gap:15px;">
                <div><b>ğŸ“š ä¸»ç§‘è¯¾æ—¶ (æé«˜å‹)</b> <span id="lbl-main-hr" style="color:var(--danger); font-weight:bold;">20èŠ‚</span><input type="range" id="range-main" min="0" max="40" value="20" oninput="adjustSchedule('main')" style="width:100%"></div>
                <div><b>ğŸ”¬ å‰¯ç§‘è¯¾æ—¶ (ä½å‹)</b> <span id="lbl-minor-hr" style="color:var(--primary); font-weight:bold;">15èŠ‚</span><input type="range" id="range-minor" min="0" max="40" value="15" oninput="adjustSchedule('minor')" style="width:100%"></div>
                <div><b>ğŸ¨ ç´ è´¨è¯¾æ—¶ (é™å‹)</b> <span id="lbl-spec-hr" style="color:var(--success); font-weight:bold;">5èŠ‚</span><input type="range" id="range-spec" min="0" max="40" value="5" oninput="adjustSchedule('spec')" style="width:100%"></div>
            </div>
        </div>
    </div>
</div>

<div id="modal-policy" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>ğŸ« å›½å®¶æ ¡ç­–ç§‘æŠ€æ ‘ (å››å¤§æµæ´¾ 40é¡¹èŠ‚ç‚¹)</div><button class="fs-close" onclick="closeModal('modal-policy')">Ã—</button></div>
        <div class="fs-body">
            <div style="text-align:center; margin-bottom:20px; font-weight:bold;">
                <span style="color:var(--danger); margin-right:15px;">ğŸŸ¥ æé™åº”è¯•çº¿</span>
                <span style="color:var(--warning); margin-right:15px;">ğŸŸ¨ é“è…•çºªå¾‹çº¿</span>
                <span style="color:#fbbf24; margin-right:15px;">ğŸŸ¤ èµ„æœ¬è¿ä½œçº¿</span>
                <span style="color:var(--success);">ğŸŸ© ç´ è´¨å¼€æ”¾çº¿</span>
            </div>
            <div id="policy-container" style="display:flex; flex-direction:column; align-items:center;"></div>
        </div>
    </div>
</div>

<div id="modal-branch" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>ğŸŒ å…¨çƒåˆ†æ ¡å®å›¾ (é«˜æ˜‚ç»´æŠ¤è´¹è­¦å‘Š)</div><button class="fs-close" onclick="closeModal('modal-branch')">Ã—</button></div>
        <div class="fs-body" id="branch-container" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:15px;"></div>
    </div>
</div>

<div id="modal-achieve" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>ğŸ† è£èª‰å²å†Œ (20å¤§ç©¶ææˆå°±)</div><button class="fs-close" onclick="closeModal('modal-achieve')">Ã—</button></div>
        <div class="fs-body grid-sys" id="achieve-container"></div>
    </div>
</div>

<!-- é€šç”¨äº‹ä»¶æç¤ºæ¡† -->
<div id="modal-overlay">
    <div class="modal-content">
        <h2 id="modal-title" style="margin-top:0; color:#1e293b;">æ ‡é¢˜</h2>
        <div id="modal-desc" style="line-height:1.6; margin-bottom:25px; font-size:1rem; color:#475569; text-align:left;">å†…å®¹</div>
        <div id="modal-buttons" style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px;"></div>
    </div>
</div>

<script>
    // ================= åŸºç¡€å­—å…¸æ•°æ® =================
    const DIFF_MODS = { 0: { name: "ç®€å•", startFund: 500, stressMult: 0.6, costMult: 0.6 }, 1: { name: "æ­£å¸¸", startFund: 100, stressMult: 1.0, costMult: 1.0 }, 2: { name: "å›°éš¾", startFund: 50,  stressMult: 1.5, costMult: 1.5 } };
    const SCHOOL_LEVELS = [ { name: "ä¹¡é•‡ä¸­å­¦", baseStu: 300, reqRep: 0, reqFunds: 0, reqGrade: 0, upkeep: 8 }, { name: "å¿çº§é‡ç‚¹", baseStu: 1000, reqRep: 300, reqFunds: 100, reqGrade: 45, upkeep: 25 }, { name: "å¸‚çº§ç¤ºèŒƒ", baseStu: 2500, reqRep: 1000, reqFunds: 400, reqGrade: 60, upkeep: 60 }, { name: "çœçº§åæ ¡", baseStu: 5000, reqRep: 4000, reqFunds: 1500, reqGrade: 80, upkeep: 150 }, { name: "å…¨å›½é¡¶å°–", baseStu: 10000, reqRep: 10000, reqFunds: 5000, reqGrade: 92, upkeep: 350 } ];
    const TEACHER_TIERS = [ { name: "å®ä¹ ç”Ÿ", multi: 0.8, upCost: 0, salary: 4 }, { name: "å¸‚éª¨å¹²", multi: 1.2, upCost: 40, salary: 12 }, { name: "ç‰¹çº§åå¸ˆ", multi: 1.8, upCost: 120, salary: 35 } ];

    const FACILITIES = { 'confucius': { name: 'å­”å­åœ£åƒ', icon: 'ğŸ—¿', cost: 20, desc: 'çºªå¾‹+1ï¼Œå£°èª‰+3/æœˆ' }, 'media': { name: 'ç”µæ•™å¤§æ¥¼', icon: 'ğŸ¢', cost: 40, desc: 'å­¦ä¸šæå‡å€ç‡å¢åŠ ' }, 'track': { name: 'å¡‘èƒ¶æ“åœº', icon: 'ğŸƒ', cost: 30, desc: 'ä½“è´¨+1.5ï¼Œç¼“è§£å‹åŠ›' }, 'library': { name: 'å›¾ä¹¦é¦†', icon: 'ğŸ“š', cost: 50, desc: 'æ¯æœˆå­¦ä¸šåŸºç¡€+1' }, 'clinic': { name: 'å¿ƒç†è¯Šæ‰€', icon: 'ğŸ›‹ï¸', cost: 45, desc: 'æå¤§åœ°å¯¹å†²ä¸»ç§‘é«˜å‹ï¼' }, 'art': { name: 'è‰ºæœ¯ä¸­å¿ƒ', icon: 'ğŸ¨', cost: 60, desc: 'ç´ è´¨ç‹‚é£™ï¼Œé…åˆç§‘æŠ€èµ·é£' }, 'lab': { name: 'å®éªŒå¤§æ¥¼', icon: 'ğŸ”¬', cost: 80, desc: 'æ¯æ¬¡è”è€ƒé¢å¤–äº§å‡ºæ•™ç ”ç‚¹' }, 'dorm': { name: 'è´µæ—å…¬å¯“', icon: 'ğŸ¨', cost: 100, desc: 'è¢«åŠ¨æŒ‰è§„æ¨¡å¸é‡‘' }, 'hospital': { name: 'æ ¡åŒ»é™¢', icon: 'ğŸ¥', cost: 40, desc: 'ä½“è´¨+2ï¼Œé˜²ç”Ÿç—…åœè¯¾' }, 'hall': { name: 'å¤§ç¤¼å ‚', icon: 'ğŸ›ï¸', cost: 150, desc: 'è¡Œæ”¿ä¸­å¿ƒã€‚APä¸Šé™+5' } };

    // åˆ†æ ¡ç³»ç»Ÿ (åŠ å…¥é«˜æ˜‚ upkeep ç»´æŠ¤è´¹)
    const BRANCH_CITIES = [
        { id: 'b_sh', name: 'ä¸Šæµ·è´¢ç»åˆ†æ ¡', cost: 8000, upkeep: 50, buffDesc: 'æ¯æœˆé¢å¤–å‡€èµš +300ä¸‡' },
        { id: 'b_bj', name: 'åŒ—äº¬å¼ºåŸºåˆ†æ ¡', cost: 15000, upkeep: 100, buffDesc: 'é«˜è€ƒæ¸…åŒ—å½•å–äººæ•°å¢åŠ 1.5å€' },
        { id: 'b_ld', name: 'ä¼¦æ•¦è‰ºæœ¯åˆ†æ ¡', cost: 20000, upkeep: 150, buffDesc: 'è‰ºæœ¯æ¶µå…»æš´å¢ï¼Œå£°èª‰æé«˜' },
        { id: 'b_ny', name: 'çº½çº¦å¸¸é’è—¤æ ¡åŒº', cost: 30000, upkeep: 200, buffDesc: 'æ‹‰å–èµåŠ©é‡‘é¢ç¿»3å€' },
        { id: 'b_hs', name: 'è¡¡æ°´ç©¶æåˆ†æ ¡', cost: 40000, upkeep: 300, buffDesc: 'å­¦ä¸šç‹‚é£™ï¼ŒæŠ—å‹æé™å¤§å¹…æé«˜' },
        { id: 'b_sz', name: 'æ·±åœ³ç§‘åˆ›åŸºåœ°', cost: 45000, upkeep: 350, buffDesc: 'æ¯æ¬¡è”è€ƒè·å¾—æ•™ç ”ç‚¹ç¿»å€' },
        { id: 'b_cd', name: 'æˆéƒ½èººå¹³åˆ†æ ¡', cost: 50000, upkeep: 400, buffDesc: 'å…¨æ ¡å‹åŠ›æå¤§å¹…åº¦é™ä½' },
        { id: 'b_db', name: 'è¿ªæ‹œåœŸè±ªæ ¡åŒº', cost: 80000, upkeep: 600, buffDesc: 'æ¯æœˆæé«˜æ¦‚ç‡å¤©é™æ¨ªè´¢ï¼Œçºªå¾‹ä¸‹é™' },
        { id: 'b_mq', name: 'æœˆçƒç§‘ç ”è€ƒå¯Ÿç«™', cost: 150000, upkeep: 1000, buffDesc: 'å­¦æ ¡å£°æœ›ä»¥ææ€–é€Ÿåº¦æš´æ¶¨' },
        { id: 'b_hx', name: 'ç«æ˜Ÿæ–‡æ˜ç¯å¡”æ ¡åŒº', cost: 300000, upkeep: 2000, buffDesc: 'å…ç–«æ‰€æœ‰è´Ÿé¢äº‹ä»¶ï¼Œå…¨å±æ€§ç‹‚å‡' }
    ];

    // ä¸“å®¶ç³»ç»Ÿ (åŠ å…¥ upkeep ç»´æŠ¤è´¹)
    const EXPERT_POOL = [
        { id: 'e1', name: "é€€å½¹é­”é¬¼æ•™å®˜", rarity: 'R', upkeep: 2, desc: "çºªå¾‹æ¯æœˆæµå¤±é€Ÿåº¦å‡åŠ" },
        { id: 'e2', name: "æŠ é—¨è€å‡ºçº³", rarity: 'R', upkeep: 2, desc: "å­¦æ ¡åŸºç¡€ç»´æŠ¤è´¹é™ä½ 15%" },
        { id: 'e3', name: "å‡¶æ‚å®¿ç®¡å¤§å¦ˆ", rarity: 'R', upkeep: 2, desc: "è´µæ—å…¬å¯“å¸é‡‘èƒ½åŠ›å€å¢" },
        { id: 'e4', name: "æ–°ä¸œæ–¹å¤§å¨", rarity: 'R', upkeep: 2, desc: "ä½“è´¨æ¯æœˆè¢«åŠ¨+1" },
        { id: 'e5', name: "é“å£é—¨å«å¤§çˆ·", rarity: 'R', upkeep: 2, desc: "æ ¡å›­æ··æ··é—¹äº‹äº‹ä»¶å…¨å…ç–«" },
        { id: 'e6', name: "å®ä¹ å¿ƒç†åŒ»ç”Ÿ", rarity: 'R', upkeep: 2, desc: "æ¯æœˆå¾®å¼±ç¼“è§£å…¨æ ¡å‹åŠ›" },
        { id: 'e7', name: "é€€ä¼‘è€ç‰¹çº§", rarity: 'R', upkeep: 2, desc: "åŸºç¡€å­¦ä¸šæ¯æœˆè¢«åŠ¨+0.5" },
        { id: 'e8', name: "é¸¡è¡€å®£ä¼ å¹²äº‹", rarity: 'R', upkeep: 2, desc: "ä¹°é‡å®£ä¼ æ•ˆæœå¢åŠ " },
        { id: 'e9', name: "æµ·å½’é’å¹´å­¦è€…", rarity: 'SR', upkeep: 10, desc: "æ‘¸åº•è€ƒè¯•æ•™ç ”ç‚¹äº§å‡º+2" },
        { id: 'e10', name: "æƒå¨å¿ƒç†å­¦æ•™æˆ", rarity: 'SR', upkeep: 10, desc: "å‹åŠ›é›ªå´©é˜ˆå€¼æå‡è‡³130" },
        { id: 'e11', name: "å›½å®¶çº§é‡‘ç‰Œæ•™ç»ƒ", rarity: 'SR', upkeep: 10, desc: "æœ‰å®éªŒå¤§æ¥¼æ—¶å­¦ä¸šæš´å¢" },
        { id: 'e12', name: "æŠ–éŸ³ç½‘çº¢åå¸ˆ", rarity: 'SR', upkeep: 10, desc: "æ¯æœˆè‡ªåŠ¨è·å–ä¸­é‡å£°èª‰" },
        { id: 'e13', name: "é“è…•çº§éƒ¨ä¸»ä»»", rarity: 'SR', upkeep: 10, desc: "ä¸»ç§‘è½¬åŒ–ç‡æé«˜ï¼Œä¸æ€•åœç”µ" },
        { id: 'e14', name: "é€€å½¹å¥¥è¿å¥å°†", rarity: 'SR', upkeep: 10, desc: "å…¨æ ¡ä½“è´¨å¤§å¹…é£™å‡" },
        { id: 'e15', name: "è½é­„è‰ºæœ¯å¤§å¸ˆ", rarity: 'SR', upkeep: 10, desc: "è‰ºæœ¯æ¶µå…»å¢åŠ æå¿«" },
        { id: 'e16', name: "å…¨å›½å‘½é¢˜ç»„ç»„é•¿", rarity: 'SSR', upkeep: 50, desc: "é«˜è€ƒå‡åˆ†ç»å¯¹å€¼æš´å¢ +30åˆ†ï¼" },
        { id: 'e17', name: "åƒäº¿å•†ä¸šå·¨å­", rarity: 'SSR', upkeep: 50, desc: "æ‹‰èµåŠ©ç›´æ¥è·å– 5å€ èµ„é‡‘ï¼" },
        { id: 'e18', name: "è¯ºå¥–åè£”å¾—ä¸»", rarity: 'SSR', upkeep: 50, desc: "æ¯æœˆè‡ªåŠ¨è·å–æ•™ç ”ç‚¹å’Œæé«˜å­¦ä¸šï¼" },
        { id: 'e19', name: "æ•™è‚²å…ç‰¹æ´¾å‘˜", rarity: 'SSR', upkeep: 50, desc: "æ— è§†è´Ÿé¢å®¡æŸ¥ï¼Œå¤§å¹…åŠ å£°èª‰" },
        { id: 'e20', name: "å­”å­è½¬ä¸–æœ¬å°Š", rarity: 'SSR', upkeep: 150, desc: "çœŸç¥é™ä¸´ã€‚æ‰€æœ‰è´Ÿé¢äº‹ä»¶è±å…ï¼Œå…¨å±æ€§å‡æ»¡ï¼" }
    ];

    // ================= 40å¤§æ”¿ç­–ç§‘æŠ€æ ‘ (å½»åº•é‡æ„ä¸ºæ ‘çŠ¶ç»“æ„) =================
    const POLICY_TREE = [
        { tier: 1, nodes: [
            { id: "A1", name: "å†›äº‹åŒ–æ—©è¯»", class: "branch-a", desc: "å­¦ä¸š+1, å‹åŠ›+1", cost: 10, req: null },
            { id: "B1", name: "ä»ªå®¹ä»ªè¡¨å¤§æ£€æŸ¥", class: "branch-b", desc: "çºªå¾‹+1, è‰ºæœ¯-1", cost: 10, req: null },
            { id: "C1", name: "å°å–éƒ¨ç–¯ç‹‚æ¶¨ä»·", class: "branch-c", desc: "æ¯æœˆèµ„é‡‘ç•¥å¢, çºªå¾‹-1", cost: 10, req: null },
            { id: "D1", name: "å¼€è®¾è¯¾å¤–ç¤¾å›¢", class: "branch-d", desc: "è‰ºæœ¯+1, å‹åŠ›-1", cost: 10, req: null }
        ]},
        { tier: 2, nodes: [
            { id: "A2", name: "å¼ºåˆ¶æ™šè‡ªä¹ ", class: "branch-a", desc: "å­¦ä¸š+2, å‹åŠ›+2", cost: 20, req: "A1" },
            { id: "A3", name: "æœˆè€ƒçº¢æ¦œå¤§å­—æŠ¥", class: "branch-a", desc: "å­¦ä¸š+1, çºªå¾‹+1", cost: 20, req: "A1" },
            { id: "B2", name: "å…¨æ ¡ç”µå­è®¾å¤‡ç¦ä»¤", class: "branch-b", desc: "çºªå¾‹+2, å‹åŠ›+1", cost: 20, req: "B1" },
            { id: "B3", name: "ç”·å¥³ç”Ÿåˆ†æ¡Œè¿›é¤", class: "branch-b", desc: "é˜²æ—©æ‹, çºªå¾‹+1", cost: 20, req: "B1" },
            { id: "C2", name: "é£Ÿå ‚å¯¹å¤–å±‚å±‚æ‰¿åŒ…", class: "branch-c", desc: "èµ„é‡‘å¢åŠ , ä½“è´¨-2", cost: 20, req: "C1" },
            { id: "C3", name: "èµåŠ©è´¹æ˜ç æ ‡ä»·", class: "branch-c", desc: "å½•å–é™åˆ†æ”¶é’±, èµ„é‡‘å¤§å¢", cost: 20, req: "C1" },
            { id: "D2", name: "è½å®å‘¨æœ«åŒä¼‘", class: "branch-d", desc: "å‹åŠ›-3, å­¦ä¸š-1", cost: 20, req: "D1" },
            { id: "D3", name: "å…¨æ ¡è‰ºæœ¯èŠ‚ç­¹åŠ", class: "branch-d", desc: "è‰ºæœ¯+3, æ¶ˆè€—èµ„é‡‘", cost: 20, req: "D1" }
        ]},
        { tier: 3, nodes: [
            { id: "A4", name: "å‘¨æœ«ç–¯ç‹‚è¡¥è¯¾", class: "branch-a", desc: "å­¦ä¸š+3, å‹åŠ›+4", cost: 50, req: "A2" },
            { id: "A5", name: "é¢˜æµ·æˆ˜æœ¯å¤§çˆ†å‘", class: "branch-a", desc: "å­¦ä¸š+3, ä½“è´¨-2", cost: 50, req: "A3" },
            { id: "B4", name: "æ•™å®¤360åº¦ç›‘æ§", class: "branch-b", desc: "çºªå¾‹+3, å‹åŠ›+2", cost: 50, req: "B2" },
            { id: "B5", name: "è¿ç¦å“åœ°æ¯¯å¼æœæŸ¥", class: "branch-b", desc: "çºªå¾‹+2, ä½“è´¨+1", cost: 50, req: "B3" },
            { id: "C4", name: "å­¦åŒºæˆ¿ç–¯ç‹‚ç‚’ä½œ", class: "branch-c", desc: "æå¤§åœ°æå‡åæ°”å’Œèµ„é‡‘", cost: 50, req: "C2" },
            { id: "C5", name: "å‹æ¦¨åº•è–ªå®ä¹ æ•™å¸ˆ", class: "branch-c", desc: "æ•™å¸ˆå·¥èµ„å¤§å¹…é™ä½", cost: 50, req: "C3" },
            { id: "D4", name: "å¿ƒç†å¥åº·è¯Šç–—å‘¨", class: "branch-d", desc: "å‹åŠ›-5, çºªå¾‹+1", cost: 50, req: "D2" },
            { id: "D5", name: "å¤§å­¦å¼è‡ªç”±èµ°ç­åˆ¶", class: "branch-d", desc: "è‰ºæœ¯+4, çºªå¾‹-2", cost: 50, req: "D3" }
        ]},
        { tier: 4, nodes: [
            { id: "A6", name: "æœ«ä½æ·˜æ±°åˆ¶é‡ç‚¹ç­", class: "branch-a", desc: "å­¦ä¸š+5, æåº¦é«˜å‹", cost: 100, req: "A4" },
            { id: "A7", name: "å¥¥èµ›å¼ºåŸºæå°–è¥", class: "branch-a", desc: "å­¦ä¸š+4, çƒ§é’±", cost: 100, req: "A5" },
            { id: "B6", name: "å­¦ç”Ÿäº’ç›¸ä¸¾æŠ¥å¥–åŠ±åˆ¶", class: "branch-b", desc: "çºªå¾‹+5, å‹åŠ›çˆ†è¡¨", cost: 100, req: "B4" },
            { id: "B7", name: "å†›è®­å¸¸æ€åŒ–(æ¯æœˆæ‹‰ç»ƒ)", class: "branch-b", desc: "ä½“è´¨+5, çºªå¾‹+3", cost: 100, req: "B5" },
            { id: "C6", name: "å›½é™…åœŸè±ªç­å‰²éŸ­èœ", class: "branch-c", desc: "èµ„é‡‘æ¯æœˆå·¨é¢å…¥è´¦", cost: 100, req: "C4" },
            { id: "C7", name: "å¼ºè¿«è´­ä¹°å¤©ä»·æ ¡æœ", class: "branch-c", desc: "èµ„é‡‘æš´æ¶¨, å£°èª‰ç‹‚è·Œ", cost: 1000, req: "C5" },
            { id: "D6", name: "æ ¡å›­æ‹çˆ±å®Œå…¨è§£ç¦", class: "branch-d", desc: "å‹åŠ›-8, çºªå¾‹-5", cost: 1000, req: "D4" },
            { id: "D7", name: "å¸¸é’è—¤ç´ è´¨è€ƒæ ¸æ ‡å‡†", class: "branch-d", desc: "è‰ºæœ¯/ä½“è´¨+5, å£°èª‰é£™å‡", cost: 1000, req: "D5" }
        ]},
        { tier: 5, nodes: [
            { id: "A8", name: "ã€ç»ˆæã€‘è¡¡æ°´é«˜è€ƒé›†ä¸­è¥", class: "branch-a", desc: "å­¦ä¸šæš´å¢æ— ä¸Šé™, å…ç–«éƒ¨åˆ†å‹åŠ›æƒ©ç½š", cost: 30000, req: "A6" },
            { id: "B8", name: "ã€ç»ˆæã€‘æ–¯å·´è¾¾ç»å¯¹æœä»", class: "branch-b", desc: "çºªå¾‹é”æ­»100, ç»å¯¹ä¸ä¼šä¹±", cost: 30000, req: "B6" },
            { id: "C8", name: "ã€ç»ˆæã€‘çº³æ–¯è¾¾å…‹ä¸Šå¸‚é›†å›¢", class: "branch-c", desc: "èµ„é‡‘å‘ˆæŒ‡æ•°çº§æ— é™è†¨èƒ€", cost: 30000, req: "C6" },
            { id: "D8", name: "ã€ç»ˆæã€‘ç†æƒ³ä¹Œæ‰˜é‚¦æ ¡å›­", class: "branch-d", desc: "å‹åŠ›æ°¸è¿œä¸º0, æ‰€æœ‰ç´ è´¨å±æ€§æ‹‰æ»¡", cost: 30000, req: "D6" }
        ]}
    ];

    const ACHIEVEMENTS = [ { id: 'a1', name: "ğŸ’¸ ç¬¬ä¸€æ¡¶é‡‘", desc: "èµ„é‡‘ç ´ 1,000 ä¸‡" }, { id: 'a2', name: "ğŸ¤‘ å•†ä¸šå¸å›½", desc: "èµ„é‡‘ç ´ 1 äº¿" }, { id: 'a3', name: "ğŸŒŸ åæ»¡å¤©ä¸‹", desc: "å£°èª‰ç ´ 10,000 ç‚¹" }, { id: 'a4', name: "ğŸ‘‘ æ•™è‚²éœ¸ä¸»", desc: "å­¦æ ¡è¯„çº§è¾¾åˆ°ã€å…¨å›½é¡¶å°–ã€‘" }, { id: 'a5', name: "ğŸ“ æ¸…åŒ—æ‘‡ç¯®", desc: "å•å±Šé«˜è€ƒæ¸…åŒ—å½•å–ç ´ 10 äºº" }, { id: 'a6', name: "ğŸ­ å·ç‹ä¹‹ç‹", desc: "å•å±Šé«˜è€ƒæ¸…åŒ—å½•å–ç ´ 50 äºº" }, { id: 'a7', name: "ğŸ¥‡ å¥¥èµ›å¼ºæ ¡", desc: "å•å±Šé«˜è€ƒæ¸…åŒ—å½•å–ç ´ 100 äºº" }, { id: 'a8', name: "ğŸ’¥ é«˜å‹é”…ç‚¸äº†", desc: "ç»å†ä¸€æ¬¡å¯æ€•çš„å‹åŠ›é›ªå´©" }, { id: 'a9', name: "ğŸš” æ— æ³•æ— å¤©", desc: "ç»å†ä¸€æ¬¡å½»åº•çš„çºªå¾‹æš´ä¹±" }, { id: 'a10', name: "ğŸƒ æ¬§çš‡é™„ä½“", desc: "æŠ½åˆ° SSR çº§ä¸“å®¶" }, { id: 'a11', name: "ğŸŒ èµ°å‘ä¸–ç•Œ", desc: "å»ºç«‹ç¬¬ä¸€æ‰€æµ·å¤–åˆ†æ ¡" }, { id: 'a12', name: "ğŸš€ æ˜Ÿé™…æ®–æ°‘", desc: "å»ºç«‹ç«æ˜Ÿæ–‡æ˜ç¯å¡”æ ¡åŒº" }, { id: 'a13', name: "ğŸ—ï¸ åŸºå»ºç‹‚é­”", desc: "é“ºæ»¡ 20 ä¸ªåœ°å›¾æ²™ç›’" }, { id: 'a14', name: "ğŸ‘¨â€ğŸ« ç¾¤æ˜Ÿé—ªè€€", desc: "é›†é½å…¨éƒ¨ 20 ä½ä¸“å®¶" }, { id: 'a15', name: "ğŸ“œ æ³•å®¶å¤§æˆ", desc: "ç‚¹æ»¡ 15 é¡¹æ ¡ç­–èŠ‚ç‚¹" }, { id: 'a16', name: "ğŸŒ å…¨çƒéœ¸ä¸»", desc: "ä¹°ä¸‹æ‰€æœ‰ 10 æ‰€åˆ†æ ¡" }, { id: 'a17', name: "ğŸ‘¨â€ğŸ“ é‡‘æ¦œé¢˜å", desc: "å­¦ç”Ÿæ¨¡å¼é«˜è€ƒè¾¾åˆ°æ¸…åŒ—çº¿" }, { id: 'a18', name: "ğŸ’• é’æ˜¥æ— æ‚”", desc: "å­¦ç”Ÿæ¨¡å¼è°ˆä¸€åœºæ‹çˆ±" }, { id: 'a19', name: "ğŸ’€ å½»åº•å´©æºƒ", desc: "å­¦ç”Ÿæ¨¡å¼å‹åŠ›çªç ´æé™é€€å­¦" }, { id: 'a20', name: "ğŸ† éœ¸ä¸šä¸ç¾¤æ˜Ÿ", desc: "è§£é”æ‰€æœ‰æˆå°±ï¼" } ];

    // ================= 50ä¸ªçº¯æ‰‹å·¥æ‰“ç£¨çš„çªå‘äº‹ä»¶ (æ•°å€¼ç»å¯¹æ§åˆ¶åœ¨<=20ï¼ŒèŠ±è´¹>0) =================
    const EVENT_POOL = [
        { t: "æ•™è‚²å±€çªå‡»æš—è®¿", d: "ä¸Šé¢çªå‡»æ£€æŸ¥è¿è§„è¡¥è¯¾ã€‚", o1: "å¡é’±æ‰“ç‚¹", a1:{act:()=>payCost(0,5)?(log("èŠ±é’±æ¶ˆç¾"),true):false, txt:"è€—èµ„ï¿¥5ä¸‡"}, o2: "ç¡¬æŠ—å®¡æŸ¥", a2:{act:()=>{game.discipline>65?mod("rep",15):mod("rep",-20);return true;}, txt:"çºªå¾‹>65å£°èª‰+15ï¼Œå¦åˆ™-20"} },
        { t: "é£Ÿå ‚é¼ å¤´é¸­è„–äº‹ä»¶", d: "å­¦ç”Ÿæ‹ç…§å‘äº†å¾®åšçƒ­æœã€‚", o1: "èŠ±é’±å‹çƒ­æœ", a1:{act:()=>payCost(0,10)?(mod("stress",5),true):false, txt:"è€—èµ„ï¿¥10ä¸‡,å‹åŠ›+5"}, o2: "æ‰¿è®¤å¹¶æ•´æ”¹", a2:{act:()=>{mod("rep",-20); mod("funds",-5);return true;}, txt:"å£°èª‰-20,èµ„é‡‘-5ä¸‡"} },
        { t: "å¤©å°æŠ‘éƒé¢„è­¦", d: "æœ‰å­¦ç”Ÿå—ä¸äº†çˆ¬ä¸Šå¤©å°ï¼", o1: "ç´§æ€¥å¿ƒç†å¹²é¢„", a1:{act:()=>payCost(2,5)?(mod("stress",-10),true):false, txt:"è€—AP:2,ï¿¥5ä¸‡,å‹åŠ›-10"}, o2: "æ¶ˆé˜²å¼ºè¡Œæ‹‰ä¸‹", a2:{act:()=>{mod("stress",15);return true;}, txt:"å‹åŠ›+15"} },
        { t: "å°–å­ç”Ÿæ—©æ‹è¢«æŠ“", d: "å…¨æ ¡ç¬¬ä¸€å’Œç¬¬äºŒåœ¨æ“åœºçº¦ä¼šã€‚", o1: "æ£’æ‰“é¸³é¸¯è®°è¿‡", a1:{act:()=>{mod("stress",10); mod("disc",5);return true;}, txt:"å‹åŠ›+10,çºªå¾‹+5"}, o2: "é¡ºå…¶è‡ªç„¶", a2:{act:()=>{mod("grade",-5); mod("disc",-5);return true;}, txt:"å­¦ä¸š-5,çºªå¾‹-5"} },
        { t: "æµæ„Ÿå¤§é¢ç§¯çˆ†å‘", d: "ç§‹å­£æ„Ÿå†’è‚†è™ä¸€åŠå­¦ç”Ÿã€‚", o1: "ä¹°è¯å…¨æ ¡å‘", a1:{act:()=>payCost(0,5)?(mod("fit",10),true):false, txt:"è€—èµ„ï¿¥5ä¸‡,ä½“è´¨+10"}, o2: "ç¡¬æŠ—ä¸æ”¾å‡", a2:{act:()=>{mod("fit",-15);mod("grade",-5);return true;}, txt:"ä½“è´¨-15,å­¦ä¸š-5"} },
        { t: "å¯Œå•†å®¶é•¿ææ¬¾", d: "æŸç…¤è€æ¿æƒ³ç»™å‚»å„¿å­ä¹°ç‰¹ä¿åé¢ã€‚", o1: "æ”¶é’±åŠäº‹", a1:{act:()=>{mod("funds",20);mod("rep",-10);return true;}, txt:"èµ„é‡‘+20,å£°èª‰-10"}, o2: "ä¸¥è¯æ‹’ç»", a2:{act:()=>{mod("rep",15);return true;}, txt:"å£°èª‰+15"} },
        { t: "æ ¡å¤–é»‘å¸®æ”¶ä¿æŠ¤è´¹", d: "å‘¨è¾¹æ²»å®‰æ€¥å‰§æ¶åŒ–ã€‚", o1: "é›‡ä½£å®‰ä¿é˜Ÿ", a1:{act:()=>payCost(0,8)?(mod("disc",10),true):false, txt:"è€—èµ„ï¿¥8ä¸‡,çºªå¾‹+10"}, o2: "ä¸é—»ä¸é—®", a2:{act:()=>{mod("stress",15);mod("disc",-10);return true;}, txt:"å‹åŠ›+15,çºªå¾‹-10"} },
        { t: "æ™šè‡ªä¹ å…¨æ ¡å¤§åœç”µ", d: "å­¦ç”Ÿä»¬ç–¯ç‹‚æ’•ä¹¦æ¬¢å‘¼ï¼", o1: "ç‚¹èœ¡çƒ›ç»§ç»­å·", a1:{act:()=>{mod("stress",15);mod("grade",2);return true;}, txt:"å‹åŠ›+15,å­¦ä¸š+2"}, o2: "æå‰æ”¾å­¦", a2:{act:()=>{mod("stress",-15);mod("grade",-2);return true;}, txt:"å‹åŠ›-15,å­¦ä¸š-2"} },
        { t: "é‡‘ç‰Œå¤–æ•™å«Œå¤ªå·è·‘è·¯", d: "å¤–ç±æ•™å¸ˆå—ä¸äº†è¿å¤œä¹°æœºç¥¨èµ°äº†ã€‚", o1: "èŠ±é‡é‡‘å†æŒ–", a1:{act:()=>payCost(0,15)?(mod("rep",10),true):false, txt:"è€—èµ„ï¿¥15ä¸‡,å£°èª‰+10"}, o2: "æœ¬åœ°è‹±è¯­è€å¸ˆé¡¶æ›¿", a2:{act:()=>{mod("grade",-5);return true;}, txt:"å­¦ä¸š-5"} },
        { t: "ç«äº‰ç§ç«‹åæ ¡æ¥æŒ–å¢™è„š", d: "éš”å£æƒ³ç”¨ä¸¤å€å·¥èµ„æŒ–ä½ çš„åå¸ˆã€‚", o1: "åŠ è–ªæŒ½ç•™", a1:{act:()=>payCost(0,10)?(mod("grade",5),true):false, txt:"è€—èµ„ï¿¥10ä¸‡,å­¦ä¸š+5"}, o2: "çˆ±èµ°èµ°ä¸ç•™", a2:{act:()=>{mod("grade",-10);return true;}, txt:"å­¦ä¸š-10"} },
        { t: "å°å–éƒ¨å”®å–è¿‡æœŸè¾£æ¡", d: "åå‡ ä¸ªä½æ ¡ç”Ÿä¸Šåä¸‹æ³»ã€‚", o1: "åœä¸šæ•´é¡¿èµ”é’±", a1:{act:()=>payCost(0,5)?(mod("fit",5),true):false, txt:"è€—èµ„ï¿¥5ä¸‡,ä½“è´¨æ¢å¤"}, o2: "åŒ…åº‡å…³ç³»æˆ·è€æ¿", a2:{act:()=>{mod("rep",-15);mod("fit",-10);return true;}, txt:"å£°èª‰-15,ä½“è´¨-10"} },
        { t: "æ ¡è¿ä¼šè·¨æ éª¨æŠ˜", d: "ä½“è‚²ç”Ÿå†²åˆºæ—¶ä¸æ…æ‘”æ–­è…¿ã€‚", o1: "å­¦æ ¡å…¨é¢å«ä»˜åŒ»è¯è´¹", a1:{act:()=>payCost(0,8)?(mod("rep",10),true):false, txt:"è€—èµ„ï¿¥8ä¸‡,å£°èª‰+10"}, o2: "æ¨è¯¿ç»™ä¿é™©å…¬å¸", a2:{act:()=>{mod("stress",10);mod("rep",-15);return true;}, txt:"å‹åŠ›+10,å£°èª‰-15"} },
        { t: "é»‘å®¢å…¥ä¾µå¹¿æ’­ç«™", d: "è¯¾é—´æ“å¤§å–‡å­ç‹‚æ”¾ç¤¾ä¼šæ‘‡ã€‚", o1: "æ‹”ç”µæºå¤„åˆ†è‚‡äº‹è€…", a1:{act:()=>payCost(1,0)?(mod("disc",10),true):false, txt:"è€—AP:1,çºªå¾‹+10"}, o2: "é¡ºåŠ¿åŠå…¨æ ¡èˆä¼š", a2:{act:()=>{mod("stress",-20);mod("disc",-10);return true;}, txt:"å‹åŠ›-20,çºªå¾‹-10"} },
        { t: "æ¸…åå­¦éœ¸çŠ¶å…ƒç¬”è®°æ³„éœ²", d: "å…¨æ ¡ç–¯æŠ¢å¤å°ï¼Œå¼•å‘è¸©è¸é£é™©ã€‚", o1: "å­¦æ ¡å‡ºèµ„å®˜æ–¹å°å‘", a1:{act:()=>payCost(0,3)?(mod("grade",5),true):false, txt:"è€—èµ„ï¿¥3ä¸‡,å­¦ä¸š+5"}, o2: "æ²¡æ”¶å……å…¬", a2:{act:()=>{mod("stress",10);mod("disc",5);return true;}, txt:"å‹åŠ›+10,çºªå¾‹+5"} },
        { t: "äº’è”ç½‘å¤§å‚é«˜ç®¡æ ¡å‹å›è®¿", d: "æ›¾ç»çš„åˆºå¤´å­¦ç”Ÿå¦‚ä»Šèº«ä»·è¿‡äº¿ã€‚", o1: "æœ€é«˜è§„æ ¼æ¥å¾…æ‹‰æŠ•èµ„", a1:{act:()=>payCost(2,5)?(mod("funds",30),true):false, txt:"è€—AP:2,ï¿¥5ä¸‡,è·ï¿¥30ä¸‡"}, o2: "ç®€å•åº§è°ˆ", a2:{act:()=>{mod("rep",10);return true;}, txt:"å£°èª‰+10"} },
        { t: "å®¿èˆå·å·ä½¿ç”¨çƒ­å¾—å¿«", d: "ç”µçº¿è€åŒ–å¼•å‘å°å‹ç«ç¾ã€‚", o1: "å…¨æ ¡é€šæŠ¥å½»æŸ¥", a1:{act:()=>payCost(2,0)?(mod("disc",15),true):false, txt:"è€—AP:2,çºªå¾‹+15"}, o2: "ä½è°ƒå¤„ç†æ¯äº‹å®äºº", a2:{act:()=>{mod("rep",-10);mod("disc",-5);return true;}, txt:"å£°èª‰-10,çºªå¾‹-5"} },
        { t: "é‡é¸¡æ•™è‚²ä¸“å®¶æ¨é”€éª—å±€", d: "æ¥æ¨é”€æ˜‚è´µçš„å¿ƒçµé¸¡æ±¤æ™ºå•†ç¨æ•™æã€‚", o1: "é…åˆè¯ˆéª—æ‹¿ææˆ", a1:{act:()=>{mod("funds",15);mod("rep",-20);return true;}, txt:"å¾—ï¿¥15ä¸‡,å£°èª‰-20"}, o2: "è½°å‡ºæ ¡é—¨", a2:{act:()=>{mod("rep",10);return true;}, txt:"å£°èª‰+10"} },
        { t: "å­¦æ ¡æ—è¾¹æ–°å¼€è±ªåç½‘å’–", d: "å……æ–¥ç€å„ç§æå“è¯±æƒ‘ï¼Œé€ƒè¯¾ç‡é£™å‡ã€‚", o1: "è”åˆæ‰§æ³•æŸ¥å°", a1:{act:()=>payCost(3,5)?(mod("disc",10),true):false, txt:"è€—AP:3,ï¿¥5ä¸‡,çºªå¾‹+10"}, o2: "ä»…åŠ å¼ºé—¨ç¦", a2:{act:()=>{mod("disc",-10);mod("grade",-5);return true;}, txt:"çºªå¾‹-10,å­¦ä¸š-5"} },
        { t: "å…¨å¸‚ç»Ÿä¸€æ¨¡æ‹Ÿè€ƒç–‘ä¼¼æ³„é¢˜", d: "å¹³æ—¶å€’æ•°çš„å­¦ç”Ÿè€ƒäº†æ»¡åˆ†ã€‚", o1: "å‡ºèµ„å…¨éƒ¨é‡æ–°å°å·é‡è€ƒ", a1:{act:()=>payCost(0,10)?(mod("stress",15),true):false, txt:"è€—èµ„ï¿¥10ä¸‡,å‹åŠ›+15"}, o2: "å°†é”™å°±é”™é—­çœ¼å¹", a2:{act:()=>{mod("grade",-15);mod("rep",-10);return true;}, txt:"å­¦ä¸š-15,å£°èª‰-10"} },
        { t: "æ•™å¸ˆèŠ‚æ”¶å—å·¨é¢ç¤¼å“å¡é£æ³¢", d: "å®¶å§”ä¼šç»™ç­ä¸»ä»»é€äº†åŠ³åŠ›å£«æ‰‹è¡¨ã€‚", o1: "ä¸¥ä»¤é€€å›å¹¶å¼€é™¤", a1:{act:()=>payCost(1,0)?(mod("rep",15),true):false, txt:"è€—AP:1,å£°èª‰+15"}, o2: "é»˜è®¸ç”šè‡³æŠ½æˆ", a2:{act:()=>{mod("funds",10);mod("disc",-10);return true;}, txt:"å¾—ï¿¥10ä¸‡,çºªå¾‹-10"} },
        { t: "è‰ºæœ¯èŠ‚èˆç¾ç»è´¹ä¸¥é‡è¶…æ”¯", d: "å­¦ç”Ÿä¼šè¦æ±‚å¢åŠ é¢„ç®—ä¹°è¿›å£ç¯å…‰ã€‚", o1: "å¤§ç¬”ä¸€æŒ¥æ‰¹äº†", a1:{act:()=>payCost(0,15)?(mod("art",15),true):false, txt:"è€—èµ„ï¿¥15ä¸‡,è‰ºæœ¯+15"}, o2: "å‹’ä»¤å–æ¶ˆè®©è·¯ç»™é«˜è€ƒ", a2:{act:()=>{mod("stress",20);mod("art",-15);return true;}, txt:"å‹åŠ›+20,è‰ºæœ¯-15"} },
        { t: "å¸‚çº§æ–‡æ˜å«ç”Ÿæ ¡å›­è¯„æ¯”", d: "èµ¢äº†æœ‰é¢å­ï¼Œè¾“äº†è¦æŒ¨æ‰¹ã€‚", o1: "åœè¯¾å…¨æ ¡ç–¯ç‹‚å¤§æ‰«é™¤ä½œå‡", a1:{act:()=>payCost(2,0)?(mod("rep",10),true):false, txt:"è€—AP:2,å£°èª‰+10(å½±å“å­¦ä¸š)"}, o2: "å¹³æ—¶æŠ“å¾—ä¸¥ä¸æ€•çªå‡»", a2:{act:()=>{game.discipline>70?mod("rep",15):mod("rep",-10);return true;}, txt:"çºªå¾‹>70å£°èª‰åŠ ,å¦åˆ™é™"} },
        { t: "å®šç‚¹ç§Ÿèµæ ¡è½¦åŠè·¯æŠ›é”š", d: "å¯¼è‡´å‡ ç™¾åèµ°è¯»ç”Ÿåœ¨æš´é›¨ä¸­è¿Ÿåˆ°ã€‚", o1: "ç´§æ€¥è°ƒé£å¤§å·´æ¥é€", a1:{act:()=>payCost(0,8)?(mod("rep",5),true):false, txt:"è€—èµ„ï¿¥8ä¸‡,æŒ½å›éƒ¨åˆ†å£°èª‰"}, o2: "è´£ç½šå­¦ç”Ÿæ²¡æ—©èµ·", a2:{act:()=>{mod("stress",10);mod("rep",-15);return true;}, txt:"å‹åŠ›+10,å£°èª‰-15"} },
        { t: "å­¦ç”Ÿåæ§½å­¦æ ¡è‡ªåª’ä½“çˆ†ç«", d: "ä¸€æ¡åæ§½é£Ÿå ‚çš„çŸ­è§†é¢‘æ’­æ”¾é‡ç ´äº”ç™¾ä¸‡ã€‚", o1: "å…¬å…³èŠ±é’±å…¨ç½‘åˆ å¸–", a1:{act:()=>payCost(0,10)?(mod("stress",5),true):false, txt:"è€—èµ„ï¿¥10ä¸‡,å‹åŠ›+5"}, o2: "æ ¼å±€æ‰“å¼€æ‹›å®‰ä¸ºå®£ä¼ å¤§ä½¿", a2:{act:()=>{mod("rep",20);mod("disc",-5);return true;}, txt:"å£°èª‰+20,çºªå¾‹-5"} },
        { t: "è€æ—§åŒ–å­¦å®éªŒå®¤å‰§æ¯’æ³„éœ²", d: "åˆºé¼»çš„é»„è‰²æ°”ä½“åœ¨èµ°å»Šè”“å»¶ã€‚", o1: "ç´§æ€¥ç–æ•£å…¨æ ¡åœè¯¾ä¸€å‘¨", a1:{act:()=>payCost(3,0)?(mod("grade",-10),true):false, txt:"è€—AP:3,å­¦ä¸š-10"}, o2: "å¼€çª—é€šé£æˆ´å£ç½©ç»§ç»­ä¸Šè¯¾", a2:{act:()=>{mod("fit",-20);mod("rep",-20);return true;}, txt:"ä½“è´¨-20,å£°èª‰-20"} },
        { t: "é«˜ä¸­å¥³ç”Ÿæ„å¤–æ€€å­•è°£è¨€å››èµ·", d: "æ•´ä¸ªæ ¡å›­éƒ½åœ¨åƒç“œï¼Œäººå¿ƒæƒ¶æƒ¶ã€‚", o1: "æŠ¥è­¦æŠ“é€ è°£è€…å¼€é™¤è¾Ÿè°£", a1:{act:()=>payCost(2,0)?(mod("disc",10),true):false, txt:"è€—AP:2,çºªå¾‹+10"}, o2: "å…¨æ ¡å¼€å±•ç”Ÿç†å¥åº·è®²åº§", a2:{act:()=>payCost(0,5)?(mod("art",5),true):false, txt:"è€—èµ„ï¿¥5ä¸‡,è‰ºæœ¯+5"} },
        { t: "é£Ÿå ‚å¤§å¦ˆæ‰‹æŠ–å¸•é‡‘æ£®ç»¼åˆå¾", d: "æ‰“é¥­åªç»™ä¸€å‹ºè‚‰ï¼Œå¼•å‘ä¸¥é‡ä¼—æ€’ã€‚", o1: "å¢åŠ é«˜é¢ä¼™é£Ÿè‚‰ç±»è¡¥è´´", a1:{act:()=>payCost(0,10)?(mod("stress",-15),true):false, txt:"è€—èµ„ï¿¥10ä¸‡,å‹åŠ›-15"}, o2: "å¼€é™¤å‡ ä¸ªä¸´æ—¶å·¥å¤§å¦ˆé¡¶ç½ª", a2:{act:()=>{mod("stress",-5);mod("disc",-5);return true;}, txt:"å‹åŠ›-5,çºªå¾‹-5"} },
        { t: "æ ¡è‰å¸¸è¢«ä¿æ—¶æ·å¯Œå©†æ¥é€", d: "ä»·å€¼è§‚å—åˆ°äº†æå…¶ä¸¥é‡çš„å†²å‡»ã€‚", o1: "çº¦è°ˆå®¶é•¿å¼ºåˆ¶é€€å­¦", a1:{act:()=>payCost(1,0)?(mod("disc",5),true):false, txt:"è€—AP:1,çºªå¾‹+5"}, o2: "åªè¦æˆç»©å¥½ç§ç”Ÿæ´»ä¸ç®¡", a2:{act:()=>{mod("disc",-15);mod("stress",-5);return true;}, txt:"çºªå¾‹-15,å‹åŠ›-5"} },
        { t: "æ¯•ä¸šå­£è·³èš¤å¸‚åœºå¤§ä¹±æ–—", d: "é«˜ä¸‰å­¦é•¿å–æ—§ä¹¦ç»“æœæ¼”å˜æˆç¾¤æ®´ã€‚", o1: "å‡ºåŠ¨ä¿å®‰å¼ºåŠ›é•‡å‹æ²¡æ”¶", a1:{act:()=>payCost(1,0)?(mod("disc",10),true):false, txt:"è€—AP:1,çºªå¾‹+10,å‹åŠ›+10"}, o2: "è§„åˆ’ä¸“é—¨åŒºåŸŸå®˜æ–¹ç®¡æ§", a2:{act:()=>payCost(0,5)?(mod("stress",-10),true):false, txt:"è€—èµ„ï¿¥5ä¸‡,å‹åŠ›-10"} },
        { t: "ç‹‚çŠ¬ç—…æµæµªè—ç’é—¯å…¥æ“åœº", d: "å¤šååœ¨ä¸Šä½“è‚²è¯¾çš„å­¦ç”Ÿè¢«ä¸¥é‡å’¬ä¼¤ã€‚", o1: "å…¨é¢èµ”ä»˜å¤©ä»·ç‹‚çŠ¬ç–«è‹—è´¹", a1:{act:()=>payCost(0,15)?(mod("rep",5),true):false, txt:"è€—èµ„ï¿¥15ä¸‡,å£°èª‰å¾®å¢"}, o2: "æ­»ä¸è®¤è´¦æ¨è„±è´£ä»»", a2:{act:()=>{mod("rep",-20);mod("fit",-10);return true;}, txt:"å£°èª‰-20,ä½“è´¨-10"} },
        { t: "å²è¯—çº§å¯’æ½®æš–æ°”ç®¡é“å…¨çº¿å†»è£‚", d: "æ•™å®¤é‡Œå†·å¦‚å†°çª–ï¼Œå­¦ç”Ÿå†»å¾—ç‘Ÿç‘Ÿå‘æŠ–ã€‚", o1: "é«˜ä»·è˜è¯·å·¥ç¨‹é˜Ÿè¿å¤œæŠ¢ä¿®", a1:{act:()=>payCost(0,12)?(mod("fit",5),true):false, txt:"è€—èµ„ï¿¥12ä¸‡,ä½“è´¨+5"}, o2: "è®©å­¦ç”Ÿå¤šç©¿å‡ ä»¶ç¡¬æŒºè¿‡å»", a2:{act:()=>{mod("fit",-20);mod("stress",15);return true;}, txt:"ä½“è´¨-20,å‹åŠ›+15"} },
        { t: "é«˜ä¸‰è€ƒå‰æ¼«å¤©æ’•ä¹¦ç‹‚æ¬¢", d: "æ— æ•°è¯•å·å¦‚é›ªèŠ±èˆ¬è½ä¸‹ï¼Œå‘æ³„å‹åŠ›ã€‚", o1: "æ³•ä¸è´£ä¼—éšä»–ä»¬å»å§", a1:{act:()=>{mod("stress",-20);mod("disc",-15);return true;}, txt:"å‹åŠ›-20,çºªå¾‹-15"}, o2: "å‡ºåŠ¨çº å¯Ÿé˜ŸæŒ¨ä¸ªè®°å¤§è¿‡", a2:{act:()=>payCost(2,0)?(mod("disc",15),true):false, txt:"è€—AP:2,çºªå¾‹+15,å‹åŠ›+20"} },
        { t: "è´´å§åœ°ä¸‹æ ¡èŠ±è¯„é€‰å¤§èµ›", d: "ä¸¥é‡å½±å“äº†éƒ¨åˆ†å­¦ç”Ÿçš„å­¦ä¹ å¿ƒæ€ã€‚", o1: "é¡ºæ°´æ¨èˆŸæå®˜æ–¹é€‰ç¾å½¢è±¡å¤§ä½¿", a1:{act:()=>payCost(0,5)?(mod("art",15),true):false, txt:"è€—èµ„ï¿¥5ä¸‡,è‰ºæœ¯+15,å­¦ä¸š-5"}, o2: "ä¸€ç½‘æ‰“å°½å…¨éƒ¨å†™å…«ç™¾å­—æ£€æŸ¥", a2:{act:()=>{mod("disc",10);mod("art",-10);return true;}, txt:"çºªå¾‹+10,è‰ºæœ¯-10"} },
        { t: "æ ¡å›­éœ¸ç‹é¾™æ”¶ä¿æŠ¤è´¹", d: "ä½“æ ¡ç‰¹é•¿ç”Ÿæ‹‰å¸®ç»“æ´¾æ¬ºå‡Œå¼±å°ã€‚", o1: "ç›´æ¥ç§»äº¤å…¬å®‰æœºå…³å¤„ç†", a1:{act:()=>payCost(2,0)?(mod("disc",15),true):false, txt:"è€—AP:2,çºªå¾‹+15"}, o2: "æ‹›å®‰è¿›å­¦æ ¡çº å¯Ÿé˜Ÿä»¥æ¯’æ”»æ¯’", a2:{act:()=>{mod("fit",10);mod("rep",-10);return true;}, txt:"ä½“è´¨+10,å£°èª‰-10"} },
        { t: "ç”·å•æ‰€æƒŠç°å˜æ€å·æ‹æ‘„åƒå¤´", d: "è™½ç„¶æ²¡æ‹åˆ°å•¥ï¼Œä½†æ€§è´¨æå…¶æ¶åŠ£ã€‚", o1: "å…¨é¢å¤§æ’æŸ¥å¹¶æŠ¥è­¦å…¬å¼€", a1:{act:()=>payCost(1,0)?(mod("rep",10),true):false, txt:"è€—AP:1,å£°èª‰+10,çºªå¾‹+5"}, o2: "å†…éƒ¨æ‚„æ‚„é”€æ¯è®¾å¤‡ä¿å¯†", a2:{act:()=>{mod("rep",-15);mod("stress",10);return true;}, txt:"å£°èª‰-15,å‹åŠ›+10"} },
        { t: "æ™šè‡ªä¹ æƒŠå¤©UFOç›®å‡»ä¼ é—»", d: "åŠä¸ªå­¦æ ¡çš„äººéƒ½è·‘åˆ°èµ°å»Šä¸Šçœ‹å‘å…‰ä½“ã€‚", o1: "æ‹¨æ¬¾æˆç«‹å¤©æ–‡è§‚æµ‹ç¤¾å›¢å¼•å¯¼", a1:{act:()=>payCost(0,5)?(mod("art",10),true):false, txt:"è€—èµ„ï¿¥5ä¸‡,è‰ºæœ¯+10"}, o2: "æ€’æ–¥æ— ç¨½ä¹‹è°ˆå¼ºåˆ¶å›åº§ä½", a2:{act:()=>{mod("stress",10);mod("grade",2);return true;}, txt:"å‹åŠ›+10,å­¦ä¸š+2"} },
        { t: "æœŸä¸­å®¶é•¿ä¼šæ¼”å˜å…¨æ­¦è¡Œ", d: "ä¸¤ä¸ªæˆç»©å·®çš„å­¦ç”Ÿå®¶é•¿äº’å˜²æ‰“äº†èµ·æ¥ã€‚", o1: "å«ä¿å®‰æ‹‰åæ¶æŠ¤ç€æœ‰é’±çš„", a1:{act:()=>payCost(1,0)?(mod("funds",10),true):false, txt:"è€—AP:1,å¾—èµ„10ä¸‡,å£°èª‰-15"}, o2: "å…¬å¹³å…¬æ­£æŠ¥è­¦è°ƒè§£", a2:{act:()=>{mod("rep",5);mod("disc",5);return true;}, txt:"å£°èª‰+5,çºªå¾‹+5"} },
        { t: "é«˜ä¸‰æŠ—è®®æ¨¡æ‹Ÿå·å¤ªéš¾é›†ä½“ç½¢è¯¾", d: "å…¨çº§éƒ¨æ‹’ç»ä¸Šæ—©è‡ªä¹ åœ¨æ“åœºé™åã€‚", o1: "æ€é¸¡å„†çŒ´å¼€é™¤å¸¦å¤´å¤§å“¥", a1:{act:()=>payCost(2,0)?(mod("disc",15),true):false, txt:"è€—AP:2,çºªå¾‹+15,å‹åŠ›+15"}, o2: "å¦¥åå¹¶æ”¾åŠå¤©å‡çœ‹ç”µå½±", a2:{act:()=>{mod("stress",-20);mod("grade",-5);return true;}, txt:"å‹åŠ›-20,å­¦ä¸š-5"} },
        { t: "æŠ‘éƒç—‡å¤šå‘ä¼‘å­¦æ½®å±æœº", d: "ä¸€ä¸ªæœˆå†…è¿ç»­10äººå¼€æŠ‘éƒè¯æ˜ä¼‘å­¦ã€‚", o1: "èŠ±é‡é‡‘å¤–è˜é¡¶çº§å¿ƒç†ä¸“å®¶å›¢é˜Ÿ", a1:{act:()=>payCost(0,20)?(mod("stress",-20),true):false, txt:"è€—èµ„ï¿¥20ä¸‡,å‹åŠ›-20"}, o2: "è®¤å®šä¸ºè£…ç—…é€ƒé¿ä¸¥å¡å®¡æ‰¹", a2:{act:()=>{mod("rep",-20);mod("stress",15);return true;}, txt:"å£°èª‰-20,å‹åŠ›+15"} },
        { t: "æš´é›¨é›·å‡»æ‘§æ¯æ ¡å›­ä¸»å¹²ç½‘", d: "æ–­ç½‘å¯¼è‡´æ‰€æœ‰ç”µæ•™è®¾å¤‡ç˜«ç—ªã€‚", o1: "åŠ æ€¥æ”¯ä»˜ä¸‰å€è´¹ç”¨è¿å¤œæŠ¢ä¿®", a1:{act:()=>payCost(0,10)?(mod("grade",5),true):false, txt:"è€—èµ„ï¿¥10ä¸‡,å­¦ä¸šä¸é™åå¢"}, o2: "å¯ç”¨æœ€åŸå§‹çš„ç²‰ç¬”é»‘æ¿æ•™å­¦", a2:{act:()=>{mod("grade",-10);mod("art",5);return true;}, txt:"å­¦ä¸š-10,è‰ºæœ¯+5"} },
        { t: "é£Ÿå ‚é¥­èœæš´æ¶¨ä¸‰æ¯›é’±æŠ—è®®", d: "è‚‰ä¸ç‚’é¢æ²¡æœ‰è‚‰è¿˜æ¶¨ä»·ï¼Œç¾¤æƒ…æ¿€æ„¤ã€‚", o1: "å­¦æ ¡æ‹¿é’±è¡¥è´´å¹³æŠ‘ç‰©ä»·", a1:{act:()=>payCost(0,10)?(mod("stress",-10),true):false, txt:"è€—èµ„ï¿¥10ä¸‡,å‹åŠ›-10"}, o2: "çˆ±åƒä¸åƒä¸æƒ¯ç€è‡­æ¯›ç—…", a2:{act:()=>{mod("stress",15);mod("rep",-10);return true;}, txt:"å‹åŠ›+15,å£°èª‰-10"} },
        { t: "å•æ‰€æŠ½çƒŸå¼•å‘åƒåœ¾æ¡¶å¤§ç«", d: "çƒŸé›¾æŠ¥è­¦å™¨å“å½»äº‘éœ„å…¨æ ¡ç‹‚å¥”ç–æ•£ã€‚", o1: "å‡çº§é˜²ç«ç³»ç»Ÿæ›´æ¢é˜»ç‡ƒæ¡¶", a1:{act:()=>payCost(0,8)?(mod("fit",5),true):false, txt:"è€—èµ„ï¿¥8ä¸‡,å®‰å…¨æå‡(ä½“è´¨+5)"}, o2: "å…¨æ ¡ç”·å•æ‰€æ´¾è€å¸ˆæ­»ç›¯", a2:{act:()=>payCost(2,0)?(mod("disc",10),true):false, txt:"è€—AP:2,çºªå¾‹+10,å‹åŠ›+5"} },
        { t: "æ•™åŠ¡ä¸»ä»»ä¹°æ•™è¾…åƒå›æ‰£è¢«å®åä¸¾æŠ¥", d: "ä¸€æœ¬ä¹¦èµšäºŒåï¼Œè¢«å­¦ç”ŸæŠ“åˆ°äº†é“è¯ã€‚", o1: "å¤§ä¹‰ç­äº²å¼€é™¤ç§»äº¤æ³•åŠ", a1:{act:()=>payCost(1,0)?(mod("rep",15),true):false, txt:"è€—AP:1,å£°èª‰+15,çºªå¾‹+5"}, o2: "åŒ…åº‡ä¸‹æ¥ä¸¤äººäº”äº”åˆ†è´¦", a2:{act:()=>{mod("funds",20);mod("rep",-20);return true;}, txt:"èµ„é‡‘+20,å£°èª‰-20"} },
        { t: "æ–°æ¥å¥³æ•™å¸ˆç©¿ç€è¿‡äºæš´éœ²è¢«æŠ•è¯‰", d: "ç”·å­¦ç”Ÿä¸Šè¯¾ä¸çœ‹é»‘æ¿ï¼Œå®¶é•¿ç”µè¯æ‰“çˆ†ã€‚", o1: "æ‹¨ç»è´¹ç»Ÿä¸€å®šåˆ¶ä¸¥å®èŒä¸šè£…", a1:{act:()=>payCost(0,5)?(mod("disc",5),true):false, txt:"è€—èµ„ï¿¥5ä¸‡,çºªå¾‹+5"}, o2: "å°Šé‡ç©¿è¡£è‡ªç”±ä¸äºˆå¹²æ¶‰", a2:{act:()=>{mod("art",10);mod("grade",-5);return true;}, txt:"è‰ºæœ¯+10,å­¦ä¸š-5"} },
        { t: "èµ°è¯»ç”ŸåŠå¤œç¿»å¢™å»ç½‘å§æ‘”æ–­è…¿", d: "å¢™å¤´ç¢ç»ç’ƒå¼•å‘æƒ¨æ¡ˆï¼Œå®¶å±æ¥é—¹ã€‚", o1: "èŠ±é’±æ¶ˆç¾ç§äº†å¹¶åŠ é«˜å›´å¢™", a1:{act:()=>payCost(0,15)?(mod("disc",10),true):false, txt:"è€—èµ„ï¿¥15ä¸‡,çºªå¾‹+10"}, o2: "è´£ä»»å…¨åœ¨å­¦ç”Ÿæ­»ç£•åˆ°åº•", a2:{act:()=>{mod("rep",-20);mod("stress",10);return true;}, txt:"å£°èª‰-20,å‹åŠ›+10"} },
        { t: "å›½é™…éƒ¨ç•™å­¦ç”Ÿä¸æœ¬åœ°ç”Ÿå¤§èµ·åº•å†²çª", d: "å› ä¸ºäº‰æŠ¢ç¯®çƒåœºåœ°å¼•å‘äº†ç™¾äººå¯¹å³™ã€‚", o1: "èŠ±é’±é‡æ–°ä¿®ä¸¤ä¸ªä¸“å±é«˜çº§çƒåœº", a1:{act:()=>payCost(0,18)?(mod("fit",10),true):false, txt:"è€—èµ„ï¿¥18ä¸‡,ä½“è´¨+10,å‹åŠ›-5"}, o2: "åè¢’ç•™å­¦ç”Ÿæ¯äº‹å®äºº", a2:{act:()=>{mod("rep",-15);mod("stress",15);return true;}, txt:"å£°èª‰-15,å‹åŠ›+15"} },
        { t: "æœŸæœ«å¤§è€ƒæƒŠç°é«˜ç§‘æŠ€ä½œå¼Šå›¢ä¼™", d: "éšå½¢è€³æœºã€å¾®å‹æ‘„åƒå¤´ä¸€åº”ä¿±å…¨ã€‚", o1: "ä¹°åä½œå¼Šå±è”½è½¦å…¨å¤©å€™å·¡é€»", a1:{act:()=>payCost(0,12)?(mod("grade",5),true):false, txt:"è€—èµ„ï¿¥12ä¸‡,å­¦ä¸š+5,çºªå¾‹+10"}, o2: "æŠ“å‡ ä¸ªå€’éœ‰è›‹é¡¶ç½ªè‰è‰ç»“æ¡ˆ", a2:{act:()=>{mod("grade",-15);mod("disc",-10);return true;}, txt:"å­¦ä¸š-15,çºªå¾‹-10"} },
        { t: "å¿ƒç†è¾…å¯¼è€å¸ˆç–‘ä¼¼çŒ¥äºµå¥³ç”Ÿä¸‘é—»", d: "è®ºå›ä¸Šæœ‰åŒ¿åå¸–å­çˆ†æ–™ï¼Œç»†èŠ‚æƒŠæ‚šã€‚", o1: "æŠ¥è­¦å½»æŸ¥å¹¶é«˜è–ªé‡è˜æ­£è§„ä¸“å®¶", a1:{act:()=>payCost(0,20)?(mod("rep",10),true):false, txt:"è€—èµ„ï¿¥20ä¸‡,å£°èª‰ä¿ä½å¹¶æå‡"}, o2: "å¼ºå‹çƒ­æœæ­»æ‚ç›–å­ä¸æ‰¿è®¤", a2:{act:()=>{mod("rep",-20);mod("stress",20);return true;}, txt:"å£°èª‰-20,å‹åŠ›æš´å¢20"} },
        { t: "ç™¾å¹´éš¾é‡ç‰¹å¤§æš´é›¨æ“åœºè¢«å½»åº•æ·¹æ²¡", d: "å­¦æ ¡å˜æˆäº†å¨å°¼æ–¯ï¼Œè¿é±¼éƒ½æ¸¸è¿›æ•™å®¤äº†ã€‚", o1: "é«˜ä»·ä¹°æŠ½æ°´æœºè¿å¤œæ’æ¶ä¿å­¦ä¸š", a1:{act:()=>payCost(0,10)?(mod("grade",5),true):false, txt:"è€—èµ„ï¿¥10ä¸‡,å­¦ä¸šä¸é™å+5"}, o2: "ä¹å¾—æ¸…é—²ç›´æ¥å®£å¸ƒæ”¾å‡ä¸‰å¤©", a2:{act:()=>{mod("stress",-20);mod("grade",-10);return true;}, txt:"å‹åŠ›å¤§å‡-20,å­¦ä¸š-10"} },
        { t: "éš”å£æ­»å¯¹å¤´èŒé«˜æ··æ··ç»“çŸ³æ¥ç ¸åœºå­", d: "å‡ åä¸ªäººæ‹¿ç€é’¢ç®¡å µåœ¨æ ¡é—¨å£å«åš£ã€‚", o1: "èŠ±é’±é›‡ä½£ä¸“ä¸šå®‰ä¿å…¬å¸åˆ—é˜µå¯¹å³™", a1:{act:()=>payCost(0,15)?(mod("disc",15),true):false, txt:"è€—èµ„ï¿¥15ä¸‡,éœ‡æ…‘å…¨åœºçºªå¾‹+15"}, o2: "ç´§é—­å¤§é—¨è®©å­¦ç”Ÿå½“ç¼©å¤´ä¹Œé¾Ÿ", a2:{act:()=>{mod("stress",15);mod("rep",-15);return true;}, txt:"å‹åŠ›+15,å£°èª‰-15"} }
    ];

    // ================= å…¨å±€çŠ¶æ€ =================
    let defaultGame = {
        year: 2018, month: 9, levelIdx: 0, diff: 1, funds: 100, reputation: 100, ap: 10, maxAp: 20, eduPoints: 0, students: 300,
        grade: 40, stress: 10, discipline: 60, fitness: 50, art: 30, schedule: { main: 20, minor: 15, spec: 5 }, teachers: { main: 0, minor: 0, spec: 0 },
        unlockedNodes: [], unlockedExperts: [], achievements: [], unlockedBranches: [], map: new Array(20).fill(null), policies: []
    };
    let game = {}; let autoInterval = null; let selectedMapIndex = -1; let currentMode = 'principal';

    // å­¦ç”Ÿæ¨¡å¼ä¸“å±æ•°æ®
    let stuGame = { active: false, year:1, month:1, turn:1, grade:40, stress:0, fit:40, art:40, talent:1, examScore: 0, olympiad: 0, abroad: 0 };

    function init() {
        let saved = localStorage.getItem('school_v9_save');
        if(saved) { game = Object.assign(JSON.parse(JSON.stringify(defaultGame)), JSON.parse(saved)); log("è¯»å–å­˜æ¡£æˆåŠŸï¼æ¸¸æˆç»§ç»­ã€‚"); updateUI(); } 
        else { showDifficultySelect(); }
    }

    function showDifficultySelect() {
        showCustomModal("ğŸŒ å¼€å¯éœ¸ä¸šçºªå…ƒï¼šé€‰æ‹©éš¾åº¦", "éš¾åº¦å†³å®šåˆå§‹èµ„é‡‘ã€æ—¥å¸¸å¼€é”€å€ç‡ä»¥åŠå­¦ç”ŸæŠ—å‹èƒ½åŠ›çš„æé™ã€‚", [{text:"ç®€å• (é€‚åˆä¼‘é—²ä½“éªŒ)", action:()=>startGame(0)}, {text:"æ­£å¸¸ (æ ‡å‡†æ¨¡æ‹Ÿæ³•åˆ™)", action:()=>startGame(1)}, {text:"å›°éš¾ (æè‡´æŠ—å‹æŠ˜ç£¨)", action:()=>startGame(2)}]);
    }

    function startGame(diffIdx) {
        game = JSON.parse(JSON.stringify(defaultGame)); game.diff = diffIdx; game.funds = DIFF_MODS[diffIdx].startFund;
        log(`é€‰æ‹©äº†ã€${DIFF_MODS[diffIdx].name}ã€‘éš¾åº¦ã€‚å­¦æ ¡æ­£å¼æŒ‚ç‰Œæˆç«‹ï¼`); updateUI();
    }

    function saveGame() { localStorage.setItem('school_v9_save', JSON.stringify(game)); showToast("ğŸ’¾ ä¿å­˜æˆåŠŸ"); }
    function hardReset() { if(confirm("è½®å›é‡å»ºï¼Œä¸€åˆ‡å½’é›¶ï¼Œç¡®å®šå—ï¼Ÿ")){ if(autoInterval) toggleAuto(); localStorage.removeItem('school_v9_save'); location.reload(); }}
    
    // ================= æ ¸å¿ƒæ¨æ¼” =================
    function getScaleFactor() { return Math.max(1.0, (game.students / 500) * DIFF_MODS[game.diff].costMult); }
    function mod(stat, val) { game[stat] += val; }
    function countFac(type) { return game.map.filter(x => x === type).length; }
    function hasExpert(id) { return game.unlockedExperts.includes(id); }
    function hasPolicy(id) { return game.policies.includes(id); }
    function hasBranch(id) { return game.unlockedBranches.includes(id); }

    function applyPassiveEffects() {
        let scale = getScaleFactor();
        
        // è´¢åŠ¡ç»“ç®— (åŠ å…¥å¤©ä»·ä¸“å®¶å’Œåˆ†æ ¡ç»´æŠ¤è´¹)
        let tMain = TEACHER_TIERS[game.teachers.main].salary; let tMinor = TEACHER_TIERS[game.teachers.minor].salary; let tSpec = TEACHER_TIERS[game.teachers.spec].salary;
        let totalSal = (tMain + tMinor + tSpec) * (game.students / 150); 
        let upkeep = SCHOOL_LEVELS[game.levelIdx].upkeep * scale;
        if(hasExpert('e2')) upkeep *= 0.85; 
        
        // è®¡ç®—ä¸“å®¶å’Œåˆ†æ ¡æ‰£è´¹
        let exUpkeep = 0; game.unlockedExperts.forEach(id => { exUpkeep += EXPERT_POOL.find(x=>x.id===id).upkeep; });
        let brUpkeep = 0; game.unlockedBranches.forEach(id => { brUpkeep += BRANCH_CITIES.find(x=>x.id===id).upkeep; });

        game.funds -= (totalSal + upkeep + exUpkeep + brUpkeep);
        game.funds += countFac('dorm') * (hasExpert('e3')?6:3) * scale; 
        
        if(hasBranch('b_sh')) game.funds += 300; 
        if(hasBranch('b_db')) { game.funds += Math.floor(Math.random()*1500); game.discipline -= 2; }

        // æ•™å­¦è½¬åŒ–
        let fMain = game.schedule.main / 20; 
        let mediaBoost = 1 + (countFac('media') * 0.05);
        game.grade += 1.0 * fMain * TEACHER_TIERS[game.teachers.main].multi * mediaBoost;
        
        let stressGain = 1.5 * fMain;
        if(game.schedule.main > 20) stressGain += Math.pow((game.schedule.main - 20) * 0.2, 2);
        if(game.schedule.main > 25) stressGain += Math.pow((game.schedule.main - 25) * 0.5, 3);
        game.stress += stressGain * DIFF_MODS[game.diff].stressMult;

        let fMinor = game.schedule.minor / 15; game.grade += 0.5 * fMinor; game.stress += 0.8 * fMinor;
        let fSpec = game.schedule.spec / 5; game.stress -= 2.0 * fSpec; game.art += 1.0 * fSpec; game.fitness += 1.0 * fSpec;

        // 40å¤§æ”¿ç­–ç»“ç®—
        if(hasPolicy('A1')){game.grade+=1;game.stress+=1;} if(hasPolicy('B1')){game.discipline+=1;game.art-=1;}
        if(hasPolicy('C1')){game.funds+=10;game.discipline-=1;} if(hasPolicy('D1')){game.art+=1;game.stress-=1;}
        if(hasPolicy('A2')){game.grade+=2;game.stress+=2;} if(hasPolicy('A3')){game.grade+=1;game.discipline+=1;}
        if(hasPolicy('B2')){game.discipline+=2;game.stress+=1;} if(hasPolicy('B3')){game.discipline+=1;}
        if(hasPolicy('C2')){game.funds+=20;game.fitness-=2;} if(hasPolicy('C3')){game.funds+=30;}
        if(hasPolicy('D2')){game.stress-=3;game.grade-=1;} if(hasPolicy('D3')){game.art+=3;game.funds-=15;}
        if(hasPolicy('A4')){game.grade+=3;game.stress+=4;} if(hasPolicy('A5')){game.grade+=3;game.fitness-=2;}
        if(hasPolicy('B4')){game.discipline+=3;game.stress+=2;} if(hasPolicy('B5')){game.discipline+=2;game.fitness+=1;}
        if(hasPolicy('C4')){game.funds+=80;game.reputation+=20;} if(hasPolicy('C5')){game.funds+=50;}
        if(hasPolicy('D4')){game.stress-=5;game.discipline+=1;} if(hasPolicy('D5')){game.art+=4;game.discipline-=2;}
        if(hasPolicy('A6')){game.grade+=5;} if(hasPolicy('A7')){game.grade+=4;game.funds-=30;}
        if(hasPolicy('B6')){game.discipline+=5;} if(hasPolicy('B7')){game.fitness+=5;game.discipline+=3;}
        if(hasPolicy('C6')){game.funds+=150;} if(hasPolicy('C7')){game.funds+=100;game.reputation-=20;}
        if(hasPolicy('D6')){game.stress-=8;game.discipline-=5;} if(hasPolicy('D7')){game.art+=5;game.fitness+=5;game.reputation+=10;}
        if(hasPolicy('A8')){game.grade+=8;} if(hasPolicy('B8')){game.discipline=100;}
        if(hasPolicy('C8')){game.funds+=500;} if(hasPolicy('D8')){game.stress=0;game.art+=10;}

        // å»ºç­‘ä¸ä¸“å®¶ç‰¹åŒ–
        game.discipline += countFac('confucius') * 1; game.reputation += countFac('confucius') * 3;
        game.stress -= countFac('track') * 1.5; game.fitness += countFac('track') * 1.5;
        game.grade += countFac('library') * 1; game.stress -= countFac('clinic') * 5; 
        game.art += countFac('art') * 2; game.fitness += countFac('hospital') * 2;
        
        if(hasExpert('e1')) game.discipline += 1; else game.discipline -= 1; 
        if(hasExpert('e4')) game.fitness += 1; if(hasExpert('e6')) game.stress -= 2;
        if(hasExpert('e7')) game.grade += 0.5; if(hasExpert('e12')) game.reputation += 20;
        if(hasExpert('e14')) game.fitness += 3; if(hasExpert('e15')) game.art += 3;
        if(hasExpert('e20') || hasBranch('b_hx')) { game.reputation+=50; game.discipline=100; game.stress=0; }
        if(hasBranch('b_mq')) game.reputation += 200; if(hasBranch('b_hs')) { game.grade+=5; game.stress+=10; }

        clampStats(); checkAchievements();
    }

    function checkCrisis() {
        if (game.funds < 0) {
            if(autoInterval) toggleAuto();
            showCustomModal("âŒ èµ„é‡‘é“¾å´©ç›˜", `å·¨é¢çš„ç»´æŠ¤è´¹å‹å®äº†ä½ ï¼Œå­¦æ ¡ç ´äº§å€’é—­ï¼ç”Ÿæºæ¸…é›¶ï¼`, [{text:"è½¬ä¸–é‡ç”Ÿ", action:hardReset}]); 
            return true;
        }
        let threshold = (hasExpert('e10') || hasBranch('b_hs')) ? 130 : 100;
        
        if (game.stress > 80 && Math.random() < 0.25 && !hasExpert('e20') && !hasBranch('b_hx') && !hasBranch('b_cd') && !hasPolicy('D8')) {
            game.reputation -= 30; game.stress -= 10; game.funds -= 20;
            log(`ğŸš¨ å‹åŠ›è¿‡é«˜ï¼çˆ†å‘å­¦ç”Ÿç¾¤ä½“æŠ—è®®ï¼Œå£°èª‰ä¸‹é™ï¼`, "var(--danger)"); showToast("æŠ—è®®äº‹ä»¶ï¼");
            if(autoInterval) toggleAuto();
        }

        if (game.stress > threshold && !hasExpert('e20') && !hasBranch('b_hx') && !hasBranch('b_cd') && !hasPolicy('D8')) {
            game.stress -= 40; game.reputation -= 100; game.grade -= 15; 
            let lostStu = Math.floor(game.students * 0.1); game.students -= lostStu;
            log(`ğŸš¨ å‹åŠ›é›ªå´©çˆ†å‘ï¼å‘ç”Ÿæç«¯é€€å­¦äº‹ä»¶ï¼Œæµå¤±ç”Ÿæº ${lostStu} äººï¼`, "var(--danger)"); showToast("é«˜å‹å´©æºƒï¼");
            unlockAchieve('a8'); if(autoInterval) toggleAuto();
        }
        if (game.discipline <= 0 && !hasExpert('e20') && !hasBranch('b_hx') && !hasPolicy('B8')) {
            game.discipline += 30; game.reputation -= 150; game.funds -= 50;
            let lostStu = Math.floor(game.students * 0.1); game.students -= lostStu;
            log(`ğŸš¨ æ ¡å›­æš´åŠ¨ï¼é»‘ç¤¾ä¼šç¾¤æ®´å°æ ¡ï¼Œæµå¤±ç”Ÿæº ${lostStu} äººï¼`, "var(--danger)"); showToast("çºªå¾‹å´©æºƒï¼");
            unlockAchieve('a9'); if(autoInterval) toggleAuto();
        }
        return false;
    }

    function clampStats() { ['grade', 'stress', 'discipline', 'fitness', 'art'].forEach(s => game[s] = Math.max(0, Math.min(100, game[s]))); game.students = Math.max(50, game.students); }

    function advanceMonth() {
        game.month++; if (game.month > 12) { game.month = 1; game.year++; }
        game.maxAp = 20 + countFac('hall')*5 + game.unlockedBranches.length*5;
        game.ap = Math.min(game.maxAp, game.ap + 3 + countFac('hall')*2 + game.unlockedBranches.length);

        applyPassiveEffects(); if(checkCrisis()) return;

        if (game.month === 6) { triggerGaokao(); return; }
        if (game.month === 9) { triggerEnrollment(); return; }
        
        if (Math.random() < 0.25) { 
            let e = EVENT_POOL[Math.floor(Math.random()*EVENT_POOL.length)];
            if(e.t.includes("æ—©æ‹") && hasPolicy('B3')) { log("ğŸ›¡ï¸ æ—©æ‹é£æ³¢è¢«é“è…•æ”¿ç­–ææ­»ã€‚"); updateUI(); return; }
            if(e.t.includes("æµæ°“") && hasExpert('e5')) { log("ğŸ›¡ï¸ é—¨å«å¤§çˆ·å‡»é€€äº†é»‘å¸®å°æ··æ··ã€‚"); updateUI(); return; }
            if(hasExpert('e20') || hasBranch('b_hx')) { log(`ğŸ‘¼ ç¥çº§ç§‘æŠ€åŠ æŒï¼šå…é™¤äº†ä¸€æ¬¡ã€${e.t}ã€‘è´Ÿé¢äº‹ä»¶ï¼`, "var(--gold)"); updateUI(); return; }

            showCustomModal(`ğŸ² çªå‘äº‹ä»¶ï¼š${e.t}`, e.d, [
                {text: e.o1 + `<br><span class="event-eff">${e.a1.txt}</span>`, action:()=>{ if(e.a1.act()){updateUI();}else{advanceMonth();} }},
                {text: e.o2 + `<br><span class="event-eff">${e.a2.txt}</span>`, action:()=>{ e.a2.act(); updateUI(); }}
            ]);
            if(autoInterval) toggleAuto();
        } else updateUI();
    }

    function toggleAuto() {
        if(game.levelIdx < 2) return showToast("ğŸ”’ å¸‚çº§ç¤ºèŒƒæ ¡è§£é”è‡ªåŠ¨æ¨æ¼”");
        let btn = document.getElementById('btn-auto');
        if (autoInterval) { clearInterval(autoInterval); autoInterval = null; btn.classList.remove('active'); btn.innerText = "ğŸ¤– è‡ªåŠ¨æ¨æ¼”"; } 
        else { btn.classList.add('active'); btn.innerText = "ğŸ›‘ åœæ­¢æ¨æ¼”"; autoInterval = setInterval(() => { if(document.getElementById('modal-overlay').style.display === 'flex') return; document.getElementById('btn-advance').click(); }, 1200); }
    }

    function triggerGaokao() {
        if(autoInterval) toggleAuto();
        let mean = game.grade * 5.0 + 200; 
        if(hasExpert('e16')) mean += 30; if(hasPolicy('A8')) mean += 50;
        
        let b = { tsinghua:0, bk985:0, bk1:0, fail:0 };
        const TOTAL = Math.max(50, Math.floor(game.students / 3));

        for(let i=0; i<TOTAL; i++) {
            let u=0,v=0; while(u===0)u=Math.random(); while(v===0)v=Math.random();
            let rand = Math.sqrt(-2.0*Math.log(u))*Math.cos(2.0*Math.PI*v);
            let s = Math.round(mean + rand*50); s = Math.max(0, Math.min(750, s));
            if(s >= 685) b.tsinghua++; else if(s >= 610) b.bk985++; else if(s >= 490) b.bk1++; else b.fail++;
        }
        
        if(hasBranch('b_bj')) b.tsinghua = Math.floor(b.tsinghua * 1.5);
        
        let repGain = (b.bk1*1 + b.bk985*5 + b.tsinghua*50) - (b.fail*1);
        let fundGain = (b.bk1*2 + b.bk985*10 + b.tsinghua*50);

        if(b.tsinghua >= 10) unlockAchieve('a5'); if(b.tsinghua >= 50) unlockAchieve('a6'); if(b.tsinghua >= 100) unlockAchieve('a7');
        game.reputation += repGain; game.funds += fundGain;
        showCustomModal("ğŸ“ ç»ˆæå®¡åˆ¤ï¼šé«˜è€ƒæ”¾æ¦œ", `æ¸…åŒ—: <b>${b.tsinghua}</b> | 985: <b>${b.bk985}</b> | ä¸€æœ¬: <b>${b.bk1}</b> | è½æ¦œ: ${b.fail}<br>å‚è€ƒæ€»äººæ•°: ${TOTAL}äºº<br>å¥–é‡‘è¿›è´¦: ï¿¥${Math.floor(fundGain)}ä¸‡`, [{text:"æ¯•ä¸šæ•£ä¼™", action:updateUI}]);
    }

    function triggerEnrollment() {
        if(autoInterval) toggleAuto();
        let capacity = SCHOOL_LEVELS[game.levelIdx].baseStu + Math.floor(game.reputation / 4);
        let newStu = Math.max(100, Math.floor(capacity * 0.4)); 
        game.students = Math.floor(game.students * 0.65) + newStu; 
        let tuition = newStu * (1.5 + game.levelIdx*0.5) * getScaleFactor(); 
        game.funds += tuition;
        game.grade = (game.grade * 0.5) + ((40+game.levelIdx*5)*0.5); game.stress = Math.max(0, game.stress - 60); 
        showCustomModal("ğŸ’ æ–°å­¦å¹´å¯èˆª", `æ–°ç”Ÿæ³¨å†Œ <b>${newStu}</b> äººï¼Œåœ¨æ ¡ç”Ÿè¾¾ <b>${game.students}</b> äººã€‚<br>æ”¶ç¼´å­¦è´¹ <b style="color:var(--success)">ï¿¥${Math.floor(tuition)}ä¸‡</b>ã€‚`, [{text:"å¼€å§‹æ–°å¾ç¨‹", action:updateUI}]);
    }

    function organizeExam() {
        let cost = Math.floor(2 * getScaleFactor()); if(!payCost(3, cost)) return;
        game.stress += 8; let pts = Math.floor(game.grade/10) + (countFac('lab')*1);
        if(hasBranch('b_sz')) pts *= 2; if(hasExpert('e9')) pts += 2;
        game.eduPoints += pts; log(`æ‘¸åº•è”è€ƒç»“æŸï¼ŒèŠ±è´¹ï¿¥${cost}ä¸‡ï¼Œèµšå–æ•™ç ”ç‚¹ +${pts}`); updateUI();
    }
    
    function runAction(type) {
        if(type==='marketing') {
            let cost = Math.floor(10 * getScaleFactor());
            if(payCost(0, cost)) { game.reputation += (hasExpert('e8')?144:120) * getScaleFactor(); log(`ç–¯ç‹‚ä¹°é‡èŠ±è´¹ï¿¥${cost}ä¸‡ï¼Œåæœ›æš´æ¶¨`); updateUI();}
        } else if(type==='sponsor') {
            let gain = Math.floor((30 + game.reputation * 0.05) * getScaleFactor());
            if(hasExpert('e17')) gain *= 5; if(hasBranch('b_ny')) gain *= 3;
            if(payCost(4, 0)) { game.reputation -= 50; game.funds += gain; log(`æ‹‰å–èµåŠ©è¿›è´¦ ï¿¥${gain}ä¸‡`); updateUI();}
        }
    }

    // ================= æ¨¡æ€æ¡†ä¸æ¸²æŸ“ =================
    function openModal(id) { document.getElementById(id).style.display='flex'; renderModals(); }
    function closeModal(id) { document.getElementById(id).style.display='none'; }

    function renderModals() {
        // æ²™ç›’åœ°å›¾
        let mGrid = document.getElementById('map-grid'); mGrid.innerHTML = '';
        game.map.forEach((facId, idx) => {
            let div = document.createElement('div'); div.className = 'map-cell' + (idx === selectedMapIndex ? ' selected' : '');
            if(facId) div.innerHTML = `<span style="font-size:1.8rem;">${FACILITIES[facId].icon}</span><span style="font-size:0.75rem;font-weight:bold;">${FACILITIES[facId].name}</span>`;
            else div.innerHTML = `<span style="color:#a3e635;font-size:2rem;">+</span>`;
            div.onclick = () => { selectedMapIndex = idx; renderModals(); }; mGrid.appendChild(div);
        });
        let fList = document.getElementById('fac-list');
        if(selectedMapIndex === -1) { document.getElementById('map-hint').style.display='block'; fList.innerHTML=''; }
        else {
            document.getElementById('map-hint').style.display='none';
            if(game.map[selectedMapIndex] !== null) fList.innerHTML = `<div style="text-align:center;"><p>å·²å»ºæœ‰ï¼š<b>${FACILITIES[game.map[selectedMapIndex]].name}</b></p><button class="btn" style="background:var(--danger);color:white;" onclick="demolish()">ğŸšœ æ‹†é™¤è®¾æ–½</button></div>`;
            else {
                let html = ''; for(let key in FACILITIES) {
                    let f = FACILITIES[key]; let can = game.funds >= f.cost;
                    html += `<div class="btn" style="flex-direction:row; align-items:center; gap:10px;" onclick="buildFac('${key}', ${f.cost})"><div style="font-size:1.8rem;">${f.icon}</div><div><div style="font-weight:bold;">${f.name} <span style="color:${can?'var(--danger)':'#94a3b8'}">(ï¿¥${f.cost}ä¸‡)</span></div><div style="font-size:0.7rem;color:#64748b;">${f.desc}</div></div></div>`;
                } fList.innerHTML = html;
            }
        }

        // ä¸“å®¶ (å¸¦ç»´æŠ¤è´¹æ˜¾ç¤º)
        let ehtml = ''; EXPERT_POOL.forEach(e => {
            if(hasExpert(e.id)) ehtml += `<div class="gacha-card rarity-${e.rarity}"><div class="upkeep-tag">è€—ï¿¥${e.upkeep}ä¸‡/æœˆ</div><div style="font-size:2.5rem; background:#f1f5f9; border-radius:50%; padding:5px;">ğŸ§‘â€ğŸ«</div><div><div style="font-weight:bold;">${e.name} <span style="font-size:0.7rem; background:#1e293b; color:white; padding:2px 5px; border-radius:4px;">${e.rarity}</span></div><div style="font-size:0.8rem; color:#64748b;">${e.desc}</div></div></div>`;
        }); document.getElementById('expert-container').innerHTML = ehtml || '<p style="color:#94a3b8; grid-column:1/-1; text-align:center;">æš‚æ— é©»æ ¡ä¸“å®¶ï¼Œå¿«å»å¯»è®¿å§ï¼</p>';

        // 40å¤§æ”¿ç­– (é‡æ„ä¸ºæ ‘çŠ¶ç»“æ„æ¸²æŸ“)
        document.getElementById('ui-eduPoints').innerText = game.eduPoints;
        let thtml = '';
        POLICY_TREE.forEach(layer => {
            let row = `<div class="tree-tier">`;
            layer.nodes.forEach(n => {
                let unlocked = hasPolicy(n.id);
                let canUnlock = !unlocked && (!n.req || hasPolicy(n.req));
                let cls = unlocked ? 'unlocked ' + n.class : (canUnlock ? n.class : 'locked ' + n.class);
                let btn = unlocked ? `<span style="color:var(--success);font-size:0.8rem;font-weight:bold;">å·²é¢å¸ƒç”Ÿæ•ˆ</span>` : 
                          (canUnlock ? `<button class="btn" style="margin:0; padding:4px; border-color:var(--primary);color:var(--primary);" onclick="unlockPolicy('${n.id}', ${n.cost})">é¢å¸ƒ (è€— ${n.cost}æ•™ç ”ç‚¹)</button>` : `<span style="color:#94a3b8;font-size:0.75rem;">æœªæ»¡è¶³å‰ç½®æ¡ä»¶</span>`);
                row += `<div class="tree-node ${cls}"><div><h4 style="margin:0 0 5px 0;font-size:0.95rem;">${n.name}</h4><p style="font-size:0.75rem;color:#64748b;">${n.desc}</p></div>${btn}</div>`;
            });
            thtml += row + `</div>`;
        });
        document.getElementById('policy-container').innerHTML = thtml;

        // åˆ†æ ¡ (å¸¦ç»´æŠ¤è´¹æ˜¾ç¤º)
        let bhtml = ''; BRANCH_CITIES.forEach(b => {
            let active = hasBranch(b.id);
            bhtml += `<div style="background:#fff; border:2px solid ${active?'var(--warning)':'#cbd5e1'}; border-radius:8px; padding:15px; text-align:center; position:relative;">
                        ${active?`<div class="upkeep-tag">è€—ï¿¥${b.upkeep}ä¸‡/æœˆ</div>`:''}
                        <h3 style="margin:0 0 10px 0;">${b.name}</h3>
                        <p style="font-size:0.85rem; color:#64748b; height:40px;">è¢«åŠ¨ï¼š${b.buffDesc}</p>
                        ${active ? `<b style="color:var(--warning)">âœ… å·²ç»è½æˆæŠ•å…¥ä½¿ç”¨</b>` : `<button class="btn-main" style="padding:10px; font-size:1rem; margin-bottom:0;" onclick="buyBranch('${b.id}', ${b.cost})">æ–¥èµ„ ï¿¥${b.cost}ä¸‡ å»ºè®¾</button>`}
                      </div>`;
        }); document.getElementById('branch-container').innerHTML = bhtml;

        // æˆå°±
        let achtml = ''; ACHIEVEMENTS.forEach(a => {
            let un = game.achievements.includes(a.id);
            achtml += `<div style="background:#fff; border:2px solid ${un?'var(--gold)':'#e2e8f0'}; padding:15px; border-radius:8px; filter:${un?'none':'grayscale(1)'}; opacity:${un?1:0.4};">
                        <div style="font-size:2rem; margin-bottom:5px;">${a.name.split(' ')[0]}</div><h4 style="margin:0;">${a.name.split(' ')[1]}</h4><p style="font-size:0.75rem; color:#64748b; margin:5px 0 0 0;">${un?a.desc:'æ¡ä»¶æœªçŸ¥'}</p></div>`;
        }); document.getElementById('achieve-container').innerHTML = achtml;

        ['main','minor','spec'].forEach(k => { document.getElementById(`range-${k}`).value = game.schedule[k]; document.getElementById(`lbl-${k}-hr`).innerText = game.schedule[k]+'èŠ‚'; document.getElementById(`tch-${k}`).innerText = TEACHER_TIERS[game.teachers[k]].name; });
    }

    function buildFac(key, cost) { if(game.funds < cost) return showToast("èµ„é‡‘ä¸è¶³ï¼"); game.funds -= cost; game.map[selectedMapIndex] = key; log(`ğŸ—ï¸ å»ºæˆåœ°æ ‡ï¼šã€${FACILITIES[key].name}ã€‘`); if(countFac('hall')*2 === 20) unlockAchieve('a13'); renderModals(); updateUI(); }
    function demolish() { game.map[selectedMapIndex] = null; renderModals(); updateUI(); }
    
    // æ ‘çŠ¶æ”¿ç­–è§£é”
    function unlockPolicy(id, cost) {
        if(game.eduPoints < cost) return showToast("æ•™ç ”ç‚¹ä¸è¶³ï¼Œè¯·å¤šä¸¾åŠæ¨¡æ‹Ÿè”è€ƒï¼");
        game.eduPoints -= cost; game.policies.push(id);
        
        let pName = ""; POLICY_TREE.forEach(t => t.nodes.forEach(n => { if(n.id===id) pName = n.name; }));
        log(`ğŸ“œ å¼ºåŠ›é¢å¸ƒäº†æ–°çš„å›½å®¶çº§æ•™è‚²ç§‘æŠ€ï¼šã€${pName}ã€‘`, "var(--primary)"); 
        if(game.policies.length>=15) unlockAchieve('a15');
        renderModals(); updateUI();
    }

    function buyBranch(id, cost) {
        if(game.funds < cost) return showToast("èµ„é‡‘ä¸è¶³ä»¥å»ºè®¾æ­¤åˆ†æ ¡ï¼");
        game.funds -= cost; game.unlockedBranches.push(id);
        unlockAchieve('a11'); if(id==='b_hx') unlockAchieve('a12'); if(game.unlockedBranches.length >= 10) unlockAchieve('a16');
        log(`ğŸŒ å•†ä¸šå®å›¾ï¼æˆåŠŸæ–¥èµ„å»ºè®¾ã€${BRANCH_CITIES.find(x=>x.id===id).name}ã€‘ï¼`, "var(--gold)"); renderModals(); updateUI();
    }

    function gachaExpert() {
        if(!payCost(0, 50)) return;
        let r = Math.random(); let ssrRate = [0, 0.01, 0.03, 0.08, 0.15][game.levelIdx]; let srRate = 0.2 + (game.levelIdx * 0.05);
        let targetRarity = 'R'; if(r < ssrRate) targetRarity = 'SSR'; else if(r < ssrRate + srRate) targetRarity = 'SR';

        let pool = EXPERT_POOL.filter(x => x.rarity === targetRarity && !hasExpert(x.id));
        if(pool.length === 0) pool = EXPERT_POOL.filter(x => !hasExpert(x.id)); 
        if(pool.length === 0) return showCustomModal("ğŸ‘¨â€ğŸ« å¯»è®¿ç»“æœ", "ä½ å·²ç»æŒ–ç©ºäº†å…¨éƒ¨20ä½é¡¶çº§ä¸“å®¶åº“ï¼", [{text:"ç¡®å®š",action:null}]);
        
        let ex = pool[Math.floor(Math.random() * pool.length)]; game.unlockedExperts.push(ex.id);
        if(ex.rarity === 'SSR') unlockAchieve('a10'); if(game.unlockedExperts.length >= 20) unlockAchieve('a14');

        let colors = {'R':'#3b82f6', 'SR':'#a855f7', 'SSR':'var(--gold)'};
        showCustomModal("âœ¨ å¯»è®¿æˆåŠŸ", `<div style="font-size:3rem; margin-bottom:10px;">ğŸ§‘â€ğŸ«</div>æŠ½åˆ°äº† <b style="color:${colors[ex.rarity]}">${ex.rarity}</b> çº§ä¸“å®¶ï¼š<br><h3 style="margin:5px 0;">${ex.name}</h3><p style="color:#64748b;">è¢«åŠ¨ï¼š${ex.desc}</p><p style="color:var(--danger);font-size:0.8rem;margin-top:10px;">âš ï¸ æ¯æœˆç»´æŠ¤è´¹ï¼šï¿¥${ex.upkeep}ä¸‡</p>`, [{text:"çº³å…¥æ™ºåº“", action:()=>{renderModals(); updateUI();}}]);
    }

    function adjustSchedule(c) {
        let m=parseInt(document.getElementById('range-main').value), mi=parseInt(document.getElementById('range-minor').value), s=parseInt(document.getElementById('range-spec').value);
        if(m+mi+s !== 40) {
            if(c==='main') { s=40-m-mi; if(s<0){mi+=s; s=0;} } else if(c==='minor') { m=40-mi-s; if(m<0){s+=m; m=0;} } else { m=40-s-mi; if(m<0){mi+=m; m=0;} }
            if(m<0||mi<0||s<0){m=20;mi=15;s=5;}
        }
        game.schedule.main=m; game.schedule.minor=mi; game.schedule.spec=s; updateUI();
    }
    
    function upgradeTeacher(k) {
        if(game.teachers[k] >= 2) return showToast("å·²æ˜¯é¡¶å°–åå¸ˆ");
        let cost = TEACHER_TIERS[game.teachers[k]+1].upCost * getScaleFactor();
        if(payCost(0, cost)) { game.teachers[k]++; updateUI(); }
    }

    function checkUpgrade() {
        if(game.levelIdx >= SCHOOL_LEVELS.length-1) return showToast("å·²è¾¾åˆ°å…¨å›½é¡¶å°–ï¼");
        let next = SCHOOL_LEVELS[game.levelIdx+1];
        if(game.reputation>=next.reqRep && game.funds>=next.reqFunds && game.grade>=next.reqGrade) {
            game.levelIdx++; if(game.levelIdx===4) unlockAchieve('a4'); log(`ğŸ‰ è¯„çº§çªç ´ï¼æ­£å¼æŒ‚ç‰Œã€${next.name}ã€‘ï¼`); updateUI();
        } else showToast(`éœ€: å£°èª‰${next.reqRep}, èµ„é‡‘${next.reqFunds}, å­¦ä¸š${next.reqGrade}`);
    }

    function checkAchievements() {
        if(game.funds >= 1000) unlockAchieve('a1'); if(game.funds >= 10000) unlockAchieve('a2'); if(game.reputation >= 10000) unlockAchieve('a3');
        if(game.achievements.length >= 19) unlockAchieve('a20');
    }
    function unlockAchieve(id) {
        if(!game.achievements.includes(id)) {
            game.achievements.push(id); let a = ACHIEVEMENTS.find(x=>x.id===id);
            if(a) { let b=document.getElementById('toast-container'); let t=document.createElement('div'); t.className='toast'; t.style.borderColor='var(--gold)'; t.innerHTML=`ğŸ… è¾¾æˆæˆå°±ï¼š<b>${a.name}</b>`; b.appendChild(t); setTimeout(()=>t.remove(), 4000); }
        }
    }

    function payCost(ap, money) { if(game.ap>=ap && game.funds>=money) { game.ap-=ap; game.funds-=money; return true; } showToast("è¡Œæ”¿ç‚¹æˆ–èµ„é‡‘ä¸è¶³ï¼"); return false; }
    function log(msg, color="#334155") { let b = document.getElementById('log-box'); b.innerHTML = `<div class="log-item"><span style="color:var(--primary);font-weight:bold;">[${game.year}.${game.month}]</span> <span style="color:${color}">${msg}</span></div>` + b.innerHTML; }
    function showToast(msg) { let b = document.getElementById('toast-container'); let t = document.createElement('div'); t.className = 'toast'; t.innerText = msg; b.appendChild(t); setTimeout(()=>t.remove(), 3900); }
    function showCustomModal(t, d, btns) {
        document.getElementById('modal-overlay').style.display='flex'; document.getElementById('modal-title').innerHTML=t; document.getElementById('modal-desc').innerHTML=d;
        window.customActs = {}; document.getElementById('modal-buttons').innerHTML = btns.map((b,i)=>{ window.customActs[i]=b.action; return `<button class="modal-btn" onclick="closeModal('modal-overlay');if(window.customActs[${i}])window.customActs[${i}]();">${b.text}</button>`}).join('');
    }

    function updateUI() {
        if(!game.year) return;
        document.getElementById('ui-date').innerText = `${game.year}å¹´ ${game.month}æœˆ`; document.getElementById('ui-level-name').innerText = SCHOOL_LEVELS[game.levelIdx].name; document.getElementById('ui-diff-badge').innerText = `éš¾åº¦: ${DIFF_MODS[game.diff].name}`;
        document.getElementById('ui-funds').innerText = Math.floor(game.funds); document.getElementById('ui-students').innerText = game.students; document.getElementById('ui-rep').innerText = Math.floor(game.reputation); document.getElementById('ui-ap').innerText = Math.floor(game.ap);
        
        // åŠ¨æ€è®¡ç®—çœŸå®çš„å‡€æ¶ˆè€—å±•ç°ç»™ç©å®¶
        let scale = getScaleFactor();
        let tMain = TEACHER_TIERS[game.teachers.main].salary; let tMinor = TEACHER_TIERS[game.teachers.minor].salary; let tSpec = TEACHER_TIERS[game.teachers.spec].salary;
        let totalSal = (tMain + tMinor + tSpec) * (game.students / 150); 
        let upkeep = SCHOOL_LEVELS[game.levelIdx].upkeep * scale;
        let exUpkeep = 0; game.unlockedExperts.forEach(id => { exUpkeep += EXPERT_POOL.find(x=>x.id===id).upkeep; });
        let brUpkeep = 0; game.unlockedBranches.forEach(id => { brUpkeep += BRANCH_CITIES.find(x=>x.id===id).upkeep; });
        document.getElementById('ui-salary').innerText = `é¢„ä¼°å‡€è€—:-${Math.floor(totalSal+upkeep+exUpkeep+brUpkeep)}ä¸‡/æœˆ`;

        document.getElementById('cost-exam').innerText = Math.floor(2 * scale); document.getElementById('cost-mar').innerText = Math.floor(10 * scale); document.getElementById('gain-spo').innerText = Math.floor((30 + game.reputation * 0.05) * scale * (hasExpert('e17')?5:1) * (hasBranch('b_ny')?3:1));
        ['grade', 'stress', 'disc', 'fit', 'art'].forEach(s => { let v = s==='disc'?game.discipline : (s==='fit'?game.fitness : game[s]); document.getElementById(`val-${s}`).innerText = Math.floor(v); document.getElementById(`bar-${s}`).style.width = v+'%'; });
        document.getElementById('warn-stress').style.display = game.stress > 80 ? 'block' : 'none';
    }

    // ================= ã€å¹³æ»‘ç‰ˆå­¦ç”Ÿæ¨¡å¼ä¸ç•™å­¦å¥¥èµ›æœºåˆ¶ã€‘ =================
    function switchMode(mode) {
        currentMode = mode;
        if(mode === 'student') {
            document.getElementById('principal-container').style.display = 'none'; document.getElementById('student-container').style.display = 'block';
            if(!stuGame.active) { document.getElementById('stu-setup').style.display = 'block'; document.getElementById('stu-gameplay').style.display = 'none'; }
        } else {
            document.getElementById('principal-container').style.display = 'grid'; document.getElementById('student-container').style.display = 'none'; updateUI();
        }
    }

    function startStudentMode(talent) {
        stuGame = { active: true, turn: 1, year: 1, month: 1, term: "ä¸Š", grade: talent * 20, stress: 10, fit: 50, art: 30, talent: talent, examScore: 0, olympiad: 0, abroad: 0 };
        document.getElementById('stu-setup').style.display = 'none'; document.getElementById('stu-gameplay').style.display = 'grid'; document.getElementById('stu-log-box').innerHTML = '<div style="color:var(--purple); font-weight:bold; margin-bottom:5px;">[ç³»ç»Ÿ] æ¬¢è¿æ¥åˆ°å­”å­å­¦æ ¡ï¼Œä½ çš„é«˜ä¸­ç”Ÿæ¶¯å¼€å§‹äº†ï¼</div>';
        
        let envDesc = ""; stuGame.env = { gradeBuff: 0, stressBuff: 0, fitBuff: 0, artBuff: 0 };
        if(game.schedule.main >= 25) { envDesc += "ğŸ”¥ æé«˜å‹å·ç‹è¯¾è¡¨(æˆç»©+2, å‹åŠ›+3) <br>"; stuGame.env.gradeBuff+=2; stuGame.env.stressBuff+=3; }
        if(hasPolicy('A8')) { envDesc += "ğŸ’€ è¡¡æ°´é›†ä¸­è¥(åœ°ç‹±çº§å†…å·, æˆç»©+4, å‹åŠ›+5) <br>"; stuGame.env.gradeBuff+=4; stuGame.env.stressBuff+=5; }
        if(hasPolicy('D8')) { envDesc += "ğŸŒˆ ç†æƒ³ä¹Œæ‰˜é‚¦(å¤©å ‚çº§ç¯å¢ƒ, å‹åŠ›æä½) <br>"; stuGame.env.stressBuff-=8; }
        if(countFac('clinic')>0) { envDesc += "ğŸ›‹ï¸ æœ‰å¿ƒç†è¯Šæ‰€(ä¸æ˜“å´©æºƒ) <br>"; stuGame.env.stressBuff-=2; }
        if(envDesc === "") envDesc = "å¹³å¹³æ— å¥‡çš„æ™®é€šé«˜ä¸­ç¯å¢ƒã€‚";
        document.getElementById('stu-env-desc').innerHTML = envDesc; updateStuUI();
    }

    function stuLog(msg, color="#334155") {
        let b = document.getElementById('stu-log-box'); let termStr = `é«˜${['ä¸€','äºŒ','ä¸‰'][stuGame.year-1]}${stuGame.term}`;
        b.innerHTML += `<div style="margin-bottom:8px; border-bottom:1px dashed #e2e8f0; padding-bottom:4px;"><span style="color:var(--primary);font-weight:bold;">[${termStr}]</span> <span style="color:${color}">${msg}</span></div>`;
        b.scrollTop = b.scrollHeight;
    }

    // è¡ŒåŠ¨æ•°å€¼å¹³æ»‘åŒ–è®¾è®¡ï¼Œç»å¯¹ä¸è¶…è¿‡15
    function stuAct(type) {
        if(stuGame.turn > 36) return;
        
        if(type === 'hard_study') { stuGame.grade += 2+stuGame.talent; stuGame.stress += 8; stuGame.fit -= 1; stuLog(`ä½ ç‹‚åˆ·äº”ä¸‰ç†¬å¤œã€‚å­¦ä¸šæ‰å®æå‡ï¼Œä½†æœ‰äº›å¤´ç—›ã€‚`); }
        else if(type === 'study') { stuGame.grade += 1+stuGame.talent; stuGame.stress += 3; stuLog(`ä½ æŒ‰éƒ¨å°±ç­è®¤çœŸå¬è®²åšç¬”è®°ã€‚`); }
        else if(type === 'olympiad') { 
            if(stuGame.grade > 70 && stuGame.talent > 1 && Math.random() < 0.4) { stuGame.olympiad += 10; stuLog(`ä½ æ”»å…‹äº†ä¸€é“å¥¥æ•°/ç‰©ç«ç¥é¢˜ï¼ç«èµ›è¿›åº¦å¤§æ¶¨ï¼`, "var(--warning)"); }
            else { stuGame.stress += 10; stuLog(`ç«èµ›é¢˜å¤ªå˜æ€äº†ï¼Œä½ å®Œå…¨çœ‹ä¸æ‡‚ï¼Œå‹åŠ›å‰§å¢ï¼`, "var(--danger)"); }
        }
        else if(type === 'abroad') {
            if(stuGame.art > 50 && Math.random() < 0.6) { stuGame.abroad += 10; stuLog(`ä½ çš„è‹±è¯­å£è¯­å’Œç»¼åˆç´ è´¨è·å¾—äº†å¤–æ•™è®¤å¯ï¼Œç•™å­¦å‡†å¤‡è¿›åº¦æå‡ï¼`, "var(--primary)"); }
            else { stuGame.stress += 5; stuLog(`è€ƒé›…æ€/æ‰˜ç¦å¤ªæŠ˜ç£¨äº†ï¼ŒèƒŒå•è¯èƒŒåˆ°åã€‚`); }
        }
        else if(type === 'internet') { stuGame.grade -= 2; stuGame.stress -= 10; stuLog(`ä½ ç¿»å¢™å»ç½‘å§åŒ…å¤œçˆ½ç©ï¼Œå‹åŠ›å¤§å‡ï¼Œä½†å­¦ä¸šé€€æ­¥ï¼`, "var(--success)"); }
        else if(type === 'walk') { stuGame.grade -= 1; stuGame.stress -= 5; stuLog(`ä½ åœ¨æ“åœºæ•£æ­¥å¬æ­Œï¼Œç¨å¾®æ”¾æ¾äº†å¿ƒæƒ…ã€‚`); }
        else if(type === 'sport') { stuGame.fit += 3; stuGame.art += 1; stuGame.stress -= 5; stuGame.grade -= 1; stuLog(`ä½ åœ¨æ“åœºæŒ¥æ´’æ±—æ°´æ‰“çƒï¼Œå¼ºå¥äº†ä½“é­„ï¼`); }
        else if(type === 'love') {
            if((hasPolicy('B3') || game.discipline>80) && Math.random() < 0.6) { stuGame.stress += 15; stuGame.grade -= 3; stuLog(`ğŸš¨ ä½ æ—©æ‹è¢«ä¸»ä»»æŠ“ä½äº†ï¼å…¨æ ¡é€šæŠ¥æ‰¹è¯„ï¼Œå¿ƒæ€å´©äº†ï¼`, "var(--danger)"); } 
            else { stuGame.stress -= 15; stuGame.art += 5; stuGame.grade -= 2; stuLog(`ğŸ’• ä½ å’ŒTaå å…¥çˆ±æ²³ï¼Œæ„Ÿè§‰ä¸–ç•Œå……æ»¡äº†å…‰ï¼`, "var(--purple)"); unlockAchieve('a18'); }
        }
        else if(type === 'eat') { stuGame.fit += 1; stuGame.stress -= 3; stuLog(`ä½ å»å°å–éƒ¨ç‹‚åƒè¾£æ¡ï¼Œå¿ƒæƒ…å˜å¥½ã€‚`); }
        else if(type === 'sick') { stuGame.grade -= 3; stuGame.stress -= 12; stuGame.fit -= 1; stuLog(`ä½ è£…ç—…å»åŒ»åŠ¡å®¤èººå¹³é€ƒè¯¾ï¼Œèº²é¿äº†ç¹é‡çš„è¯¾ä¸šï¼`); }
        else if(type === 'sleep') { stuGame.grade -= 2; stuGame.stress -= 6; stuGame.fit += 1; stuLog(`ä½ ä¸Šè¯¾è’™å¤´å¤§ç¡ï¼Œé†’æ¥ç¥æ¸…æ°”çˆ½ã€‚`); }
        else if(type === 'book') { stuGame.art += 3; stuGame.grade -= 1; stuGame.stress -= 4; stuLog(`ä½ èº²åœ¨è§’è½çœ‹é—²ä¹¦ï¼Œç²¾ç¥å¾—åˆ°äº†å‡åï¼`); }

        stuGame.grade += stuGame.env.gradeBuff; stuGame.stress += stuGame.env.stressBuff;
        stuGame.grade = Math.max(0, Math.min(100, stuGame.grade)); stuGame.stress = Math.max(0, stuGame.stress);
        
        if(stuGame.stress > 100) {
            stuLog(`ğŸ¤¯ ä½ çš„ç²¾ç¥é˜²çº¿å½»åº•å´©æºƒäº†ï¼ä½ ä¼‘å­¦å›å®¶ï¼Œé—æ†¾ç»“æŸ...`, "var(--danger)"); unlockAchieve('a19');
            setTimeout(() => { showCustomModal("GAME OVER", "å‹åŠ›çªç ´æé™ï¼Œä½ ç²¾ç¥å´©æºƒé€€å­¦äº†ã€‚", [{text:"é‡æ–°æŠ•èƒ", action:()=>startStudentMode(stuGame.talent)}]); }, 500); return;
        }

        calcMonthlyExam();

        stuGame.turn++; stuGame.month++;
        if(stuGame.month > 6) { stuGame.month = 1; stuGame.term = stuGame.term==="ä¸Š"?"ä¸‹":"ä¸Š"; if(stuGame.term==="ä¸Š") stuGame.year++; }

        updateStuUI();
        if(stuGame.turn > 36) triggerStuGaokao();
        else if(Math.random() < 0.2) triggerStuEvent(); // å­¦ç”Ÿä¸“å±éšæœºå°äº‹ä»¶
    }

    // å­¦ç”Ÿä¸“å±éšæœºäº‹ä»¶åº“
    function triggerStuEvent() {
        let evts = [
            { t: "æœŸä¸­è€ƒè¯•ä½ å‘æŒ¥è¶…å¸¸ï¼Œè€å¸ˆå½“ä¼—è¡¨æ‰¬äº†ä½ ï¼", g: 2, s: -5, c: "var(--success)" },
            { t: "ç­é‡Œå‘ç”Ÿäº†ä¸€äº›å°æ‘©æ“¦ï¼Œæ°”æ°›å‹æŠ‘ã€‚", g: 0, s: 5, c: "#64748b" },
            { t: "ä½ åœ¨è¿™ä¸ªæœˆæ‚£ä¸Šäº†é‡æ„Ÿå†’ï¼Œæµ‘èº«æ— åŠ›ã€‚", g: -2, s: 5, c: "var(--danger)" },
            { t: "å¬äº†ä¸€åœºæå…·æ„ŸæŸ“åŠ›çš„æ ¡å‹æ¼”è®²ï¼Œæµ‘èº«å……æ»¡åŠ›é‡ï¼", g: 1, s: -5, c: "var(--warning)" },
            { t: "ä½ æš—æ‹çš„å¯¹è±¡å¯¹ä½ ç¬‘äº†ä¸€ä¸‹ï¼Œä½ å¼€å¿ƒäº†ä¸€æ•´å¤©ã€‚", g: 0, s: -8, c: "var(--purple)" }
        ];
        let e = evts[Math.floor(Math.random() * evts.length)];
        stuGame.grade += e.g; stuGame.stress += e.s;
        stuLog(`ğŸ² çªå‘ï¼š${e.t}`, e.c);
        updateStuUI();
    }

    function calcMonthlyExam() {
        let base = (stuGame.grade * 3.5) + (stuGame.env.gradeBuff * 5) + 200;
        let randomFactor = (Math.random() * 30) - 15; 
        let penalty = stuGame.stress > 80 ? -20 : 0; 
        stuGame.examScore = Math.floor(Math.max(100, Math.min(750, base + randomFactor + penalty)));
        
        let rankStr = "ä¸­ä¸‹æ¸¸";
        if(stuGame.examScore > 650) rankStr = "ğŸ« çº§éƒ¨éœ¸ä¸» (å‰ 1%)";
        else if(stuGame.examScore > 580) rankStr = "ğŸŒŸ é‡ç‚¹ç­ç²¾è‹± (å‰ 10%)";
        else if(stuGame.examScore > 500) rankStr = "ğŸ“Š ä¸­æµç ¥æŸ± (å‰ 40%)";
        else if(stuGame.examScore < 300) rankStr = "âš ï¸ å·®ç”Ÿè­¦å‘Š (å«åº•)";

        document.getElementById('stu-exam-score').innerText = stuGame.examScore;
        document.getElementById('stu-exam-rank').innerText = "ä¸Šæœˆæ’å: " + rankStr;
    }

    function triggerStuGaokao() {
        calcMonthlyExam(); 
        let score = stuGame.examScore;
        let uni = "å¤§ä¸“/è½æ¦œ"; let color = "#64748b";
        
        // åˆ¤å®šç‰¹æ‹›ä¸ç•™å­¦ç»“å±€
        if(stuGame.olympiad >= 50) { uni = "ğŸ† å¥¥èµ›å›½å®¶é˜Ÿä¿é€æ¸…åŒ—"; color = "var(--gold)"; score = "å…è¯•"; unlockAchieve('a17'); }
        else if(stuGame.abroad >= 50) { uni = "âœˆï¸ å½•å–ç¾å›½å¸¸é’è—¤åæ ¡"; color = "var(--purple)"; score = "æ‰˜ç¦ç›´å½•"; }
        else {
            if(score >= 680) { uni = "æ¸…ååŒ—å¤§"; color = "var(--danger)"; unlockAchieve('a17'); }
            else if(score >= 600) { uni = "985/211åæ ¡"; color = "var(--warning)"; }
            else if(score >= 500) { uni = "æ™®é€šä¸€æœ¬"; color = "var(--primary)"; }
            else if(score >= 400) { uni = "äºŒæœ¬é™¢æ ¡"; color = "var(--success)"; }
        }

        stuLog(`ğŸ“ é«˜è€ƒç»“æŸï¼ä½ çš„å»å‘ï¼š${uni}`, color);
        showCustomModal("ğŸ“ ä¸‰å¹´æœŸæ»¡ï¼šç»ˆå±€å‡ºæ¦œ", `ä½ çš„æœ€ç»ˆæˆç»©æ˜¯ï¼š<b style="font-size:2rem;color:${color}">${score}</b><br>å½•å–ç»“æœï¼š<b>${uni}</b><br><br>è¿™æ®µå­”å­å­¦æ ¡çš„ç”Ÿæ¶¯ç»“æŸäº†ã€‚`, [{text:"ç»“æŸä½“éªŒ", action:()=>switchMode('principal')}]);
    }

    function updateStuUI() {
        document.getElementById('stu-ui-turn').innerText = stuGame.turn; document.getElementById('stu-ui-year').innerText = ['ä¸€','äºŒ','ä¸‰'][stuGame.year-1]; document.getElementById('stu-ui-month').innerText = stuGame.term;
        document.getElementById('stu-val-grade').innerText = Math.floor(stuGame.grade); document.getElementById('stu-val-stress').innerText = Math.floor(stuGame.stress); document.getElementById('stu-val-fit').innerText = Math.floor(stuGame.fit); document.getElementById('stu-val-art').innerText = Math.floor(stuGame.art);
        document.getElementById('stu-val-oly').innerText = stuGame.olympiad; document.getElementById('stu-val-abr').innerText = stuGame.abroad;
    }

    window.onload = init;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµå®å­”å­å­¦æ ¡ - åæ ¡ä¹‹è·¯ V0.0.1</title>
    <style>
        :root {
            --board-bg: #1e3a29; /* æ·±é»‘æ¿ç»¿ */
            --chalk-white: #f8f9fa;
            --chalk-yellow: #fde047;
            --banner-red: #b91c1c;
            --wood: #8B5A2B;
            --text-main: #1f2937;
            --bg-paper: #f9f9f9;
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --purple: #9333ea;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Microsoft YaHei', 'SimSun', sans-serif;
            background: #e2e8f0;
            color: var(--text-main);
            margin: 0; padding: 10px;
            display: flex; justify-content: center; min-height: 100vh;
        }

        .container {
            width: 100%; max-width: 1200px;
            display: grid; gap: 15px;
            grid-template-columns: 280px 1fr 320px;
        }

        /* æ¨ªå¹…ä¸ç³»ç»Ÿæ  */
        .header-banner { grid-column: 1 / -1; background: var(--banner-red); color: #fff; text-align: center; padding: 15px; border-radius: var(--radius); border: 3px solid #7f1d1d; box-shadow: 0 4px 15px rgba(185, 28, 28, 0.4); }
        .header-banner h1 { margin: 0; font-size: 2.2rem; font-family: 'SimHei', sans-serif; letter-spacing: 4px; color: var(--chalk-yellow); text-shadow: 2px 2px 0px #450a0a;}
        .sys-bar { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 10px 20px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid #cbd5e1; }
        .school-badge { display: inline-block; padding: 4px 12px; background: linear-gradient(135deg, #fef08a, #eab308); color: #713f12; border-radius: 20px; font-weight: bold; border: 1px solid #ca8a04; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* é¢æ¿åŸºç¡€ */
        .panel { background: #fff; border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); border: 1px solid #e2e8f0; }
        .panel-title { font-size: 1.1rem; font-weight: bold; border-bottom: 2px solid var(--primary); padding-bottom: 8px; margin-top: 0; margin-bottom: 12px; color: var(--primary);}

        /* é»‘æ¿é£æ ¼å±æ€§æ¡† */
        .blackboard { background: var(--board-bg); border: 8px solid var(--wood); border-radius: 4px; padding: 15px; color: var(--chalk-white); box-shadow: inset 0 0 15px rgba(0,0,0,0.6); }
        .stat-row { display: flex; align-items: center; margin-bottom: 10px; font-size: 0.95rem; }
        .stat-label { width: 90px; }
        .bar-bg { flex: 1; height: 12px; background: rgba(255,255,255,0.15); border-radius: 6px; overflow: hidden; margin: 0 10px; border: 1px solid rgba(255,255,255,0.1);}
        .bar-fill { height: 100%; border-radius: 6px; transition: width 0.3s; }
        .stat-val { width: 35px; text-align: right; font-family: monospace; font-size: 1.1rem; color: var(--chalk-yellow);}

        /* èµ„æºå±•ç¤º */
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .res-box { background: #f8fafc; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #cbd5e1;}
        .res-box span { display: block; font-size: 1.2rem; font-weight: bold; color: var(--primary); margin-top: 5px;}
        .res-highlight { color: var(--purple) !important; font-size: 1.4rem !important; }

        /* ä¸­é—´æ“ä½œåŒº */
        .time-control { text-align: center; background: #eff6ff; border: 2px solid #bfdbfe; padding: 15px; border-radius: var(--radius); margin-bottom: 15px;}
        .time-display { font-size: 1.5rem; font-weight: bold; color: var(--primary); margin-bottom: 10px; }
        .btn-main { background: var(--primary); color: white; border: none; font-size: 1.2rem; padding: 12px 30px; border-radius: 30px; cursor: pointer; font-weight: bold; transition: 0.2s; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); width: 100%; }
        .btn-main:hover { background: #1d4ed8; transform: translateY(-2px); }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { width: 100%; padding: 10px; background: #fff; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer; text-align: left; transition: 0.2s; font-family: inherit; }
        .btn:hover:not(:disabled) { border-color: var(--primary); background: #f0fdf4; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background: #f1f5f9; }
        .btn-desc { font-size: 0.75rem; color: #64748b; display: block; margin-top: 4px; }
        
        .btn-hero { background: linear-gradient(to right, #4f46e5, #9333ea); color: white; border: none; text-align: center;}
        .btn-hero .btn-desc { color: #e0e7ff; }
        .btn-hero:hover:not(:disabled) { background: linear-gradient(to right, #4338ca, #7e22ce); transform: scale(1.02);}

        /* æ—¥å¿— */
        .log-box { height: 200px; overflow-y: auto; font-size: 0.85rem; background: #f8fafc; border: 1px inset #e2e8f0; padding: 10px;}
        .log-item { margin-bottom: 8px; border-bottom: 1px dashed #cbd5e1; padding-bottom: 4px; line-height: 1.4; }

        /* å…¨å±æ¨¡æ€æ¡† (ç§‘æŠ€æ ‘/æ’è¯¾) */
        .fs-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; padding: 20px;}
        .fs-content { background: #fff; width: 100%; max-width: 900px; height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5);}
        .fs-header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; font-size: 1.2rem; font-weight: bold;}
        .fs-close { background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .fs-body { padding: 20px; overflow-y: auto; flex: 1; background: #f1f5f9;}

        /* å†³ç­–æ ‘èŠ‚ç‚¹æ ·å¼ */
        .tree-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; }
        .tree-node { background: #fff; border: 2px solid #cbd5e1; border-radius: 8px; padding: 15px; position: relative; transition: 0.2s; }
        .tree-node.locked { filter: grayscale(1); opacity: 0.7; }
        .tree-node.unlocked { border-color: var(--success); background: #f0fdf4; }
        .tree-node h3 { margin: 0 0 5px 0; font-size: 1.1rem; color: var(--text-main); }
        .tree-node p { margin: 0 0 10px 0; font-size: 0.8rem; color: #64748b; line-height: 1.4;}
        .node-cost { font-weight: bold; color: var(--purple); font-size: 0.9rem; margin-bottom: 10px;}
        .node-btn { width: 100%; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;}
        .node-btn:disabled { background: #94a3b8; cursor: not-allowed; }

        /* æ’è¯¾æ»‘å—æ ·å¼ */
        .slider-group { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .slider-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px;}
        input[type=range] { width: 100%; cursor: pointer; }
        
        /* æˆç»©åˆ†æ®µæŸ±çŠ¶å›¾ */
        .chart-row { display: flex; align-items: center; margin-bottom: 8px; }
        .chart-label { width: 120px; font-weight: bold; font-size: 0.9rem;}
        .chart-bar-bg { flex: 1; height: 20px; background: #e2e8f0; margin: 0 10px; border-radius: 3px;}
        .chart-bar-fill { height: 100%; border-radius: 3px; display: flex; align-items: center; padding-left: 5px; color: white; font-size: 0.8rem; font-weight: bold; text-shadow: 1px 1px 1px rgba(0,0,0,0.5);}
        .chart-val { width: 60px; text-align: right; font-weight: bold;}

        /* æ™®é€šå¼¹çª— */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-paper); padding: 30px; border-radius: 12px; width: 90%; max-width: 550px; text-align: center; border: 2px solid var(--primary); box-shadow: 0 10px 25px rgba(0,0,0,0.5);}
        .modal-content h2 { margin-top: 0; color: var(--primary); }
        .modal-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1rem; margin: 5px; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none;}
        .toast { background: rgba(0,0,0,0.85); color: white; padding: 12px 20px; border-radius: 6px; font-size: 0.95rem; animation: fadeInOut 3s forwards; box-shadow: 0 4px 6px rgba(0,0,0,0.3);}
        @keyframes fadeInOut { 0% {opacity: 0; transform: translateX(50px);} 10% {opacity: 1; transform: translateX(0);} 90% {opacity: 1; transform: translateX(0);} 100% {opacity: 0; transform: translateX(50px);} }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div class="container">
    <div class="header-banner">
        <h1>æµå®å­”å­å­¦æ ¡ ver 0.0.1</h1>
        <p>å› ææ–½æ•™ï¼Œæœ‰æ•™æ— ç±» â€”â€” å†²åˆºå…¨å›½ç™¾å¼ºåæ ¡ By ChansonTech</p>
    </div>

    <div class="sys-bar">
        <div>
            å­¦æ ¡ç­‰çº§ï¼š<span class="school-badge" id="ui-level-name">ä¹¡é•‡ä¸­å­¦</span>
            <button onclick="checkUpgrade()" style="margin-left:10px; padding:4px 10px; border:1px solid #ccc; background:#fff; cursor:pointer; border-radius:4px;">ğŸ–ï¸ ç”³è¯·æ™‹å‡</button>
        </div>
        <div>
            <button onclick="saveGame()" style="padding:4px 10px; cursor:pointer;">ğŸ’¾ ä¿å­˜</button>
            <button onclick="loadGame()" style="padding:4px 10px; cursor:pointer;">ğŸ“‚ è¯»å–</button>
        </div>
    </div>

    <!-- å·¦ä¾§ï¼šæ ¡æƒ…ä¸äº”ç»´ -->
    <div class="panel">
        <h2 class="panel-title">ğŸ“Š æ ¡æƒ…ç›‘æ§</h2>
        <div class="res-grid">
            <div class="res-box">èµ„é‡‘(ä¸‡å…ƒ) <span id="ui-funds">50</span></div>
            <div class="res-box">ç¤¾ä¼šå£°èª‰ <span id="ui-rep" style="color:#d97706">100</span></div>
            <div class="res-box">è¡Œæ”¿ç‚¹ AP <span><span id="ui-ap">10</span>/<span id="ui-maxap">20</span></span></div>
            <div class="res-box">æ•™ç ”ç‚¹ (å†³ç­–) <span class="res-highlight" id="ui-eduPoints">0</span></div>
        </div>

        <div class="blackboard">
            <div style="text-align:center; margin-bottom:10px; color:var(--chalk-yellow); border-bottom:1px dashed rgba(255,255,255,0.3); padding-bottom:5px;">ç”Ÿæºå¹³å‡äº”ç»´</div>
            <div class="stat-row"><div class="stat-label">ğŸ“š å­¦ä¸š</div><div class="bar-bg"><div id="bar-grade" class="bar-fill" style="background:#3b82f6;"></div></div><div class="stat-val" id="val-grade">40</div></div>
            <div class="stat-row"><div class="stat-label">ğŸ¤¯ å‹åŠ›</div><div class="bar-bg"><div id="bar-stress" class="bar-fill" style="background:#ef4444;"></div></div><div class="stat-val" id="val-stress">20</div></div>
            <div class="stat-row"><div class="stat-label">ğŸ›¡ï¸ çºªå¾‹</div><div class="bar-bg"><div id="bar-disc" class="bar-fill" style="background:#eab308;"></div></div><div class="stat-val" id="val-disc">60</div></div>
            <div class="stat-row"><div class="stat-label">ğŸƒâ€â™‚ï¸ ä½“è´¨</div><div class="bar-bg"><div id="bar-fit" class="bar-fill" style="background:#22c55e;"></div></div><div class="stat-val" id="val-fit">50</div></div>
            <div class="stat-row"><div class="stat-label">ğŸ¨ ç´ è´¨</div><div class="bar-bg"><div id="bar-art" class="bar-fill" style="background:#a855f7;"></div></div><div class="stat-val" id="val-art">30</div></div>
        </div>
    </div>

    <!-- ä¸­é—´ï¼šæ ¸å¿ƒé©±åŠ¨åŒº -->
    <div class="panel">
        <div class="time-control">
            <div class="time-display" id="ui-date">2018å¹´ 9æœˆ</div>
            <p style="font-size:0.85rem; color:#64748b; margin:0 0 10px 0;" id="ui-season-hint">ã€å¼€å­¦å­£ã€‘æ–°ç”ŸæŠ¥åˆ°ï¼Œæ”¶å–å­¦è´¹</p>
            <button class="btn-main" onclick="advanceMonth()">â³ ç»“ç®—å¹¶è¿›å…¥ä¸‹ä¸ªæœˆ</button>
        </div>

        <h2 class="panel-title">ğŸ§  æ ¸å¿ƒæ•™åŠ¡ç®¡ç†</h2>
        <div class="action-grid">
            <button class="btn btn-hero" onclick="openTechTree()">
                <span class="btn-title" style="font-weight:bold; font-size:1.1rem;">ğŸ’¡ æ•™æ”¹å†³ç­–æ ‘</span>
                <span class="btn-desc">æ¶ˆè€—æ•™ç ”ç‚¹ï¼Œè§£é”15é¡¹ç»ˆææ•™è‚²æ–¹é’ˆ</span>
            </button>
            <button class="btn btn-hero" style="background:linear-gradient(to right, #059669, #10b981);" onclick="openSchedule()">
                <span class="btn-title" style="font-weight:bold; font-size:1.1rem;">ğŸ“… å¸ˆèµ„ä¸æ’è¯¾</span>
                <span class="btn-desc">æ‹›å‹Ÿåå¸ˆï¼Œåˆ†é…ä¸»å‰¯ç§‘è¯¾æ—¶æ¯”ä¾‹</span>
            </button>
        </div>

        <h2 class="panel-title" style="margin-top:20px;">ğŸ¯ ä¸“é¡¹è¡ŒåŠ¨</h2>
        <button class="btn" onclick="organizeExam()">
            ğŸ“ ç»„ç»‡å…¨å¸‚æ¨¡æ‹Ÿè”è€ƒ (è€—AP:3, ï¿¥2ä¸‡)
            <span class="btn-desc">æ¨¡æ‹ŸçœŸå®750åˆ†åˆ¶é«˜è€ƒï¼Œæ ¹æ®åˆ†æ®µäº§å‡ºã€æ•™ç ”ç‚¹ã€‘ã€‚</span>
        </button>
        <button class="btn" onclick="runAction('olympiad')">
            ğŸ† å¥¥èµ›å¼ºåŸºé›†è®­ (è€—AP:4, ï¿¥5ä¸‡)
            <span class="btn-desc">æä¸€æå•è½¦å˜æ‘©æ‰˜ï¼é«˜è€ƒè‹¥å¤ºé‡‘å£°èª‰æš´æ¶¨ã€‚</span>
        </button>
    </div>

    <!-- å³ä¾§ï¼šåŸºå»ºä¸æ—¥å¿— -->
    <div class="panel">
        <h2 class="panel-title">ğŸ—ï¸ æ ¡å›­åŸºå»º</h2>
        <button class="btn" onclick="buildFacility('confucius')">åƒ: å·¨å‹å­”å­åƒ (Lv.<span id="fac-confucius">0</span>) <span class="btn-desc">è€—èµ„:ï¿¥<span id="cost-confucius">10</span>ä¸‡ | æ¯æœˆè¢«åŠ¨æçºªå¾‹/å£°èª‰</span></button>
        <button class="btn" onclick="buildFacility('media')">æ¥¼: æ™ºæ…§å¤šåª’ä½“ (Lv.<span id="fac-media">0</span>) <span class="btn-desc">è€—èµ„:ï¿¥<span id="cost-media">20</span>ä¸‡ | æå‡ä¸»ç§‘æ•™å­¦æ•ˆç‡</span></button>
        <button class="btn" onclick="buildFacility('track')">åœº: å¡‘èƒ¶å¤§æ“åœº (Lv.<span id="fac-track">0</span>) <span class="btn-desc">è€—èµ„:ï¿¥<span id="cost-track">15</span>ä¸‡ | æ¯æœˆæå‡ä½“è´¨ï¼Œç¼“è§£å‹åŠ›</span></button>

        <h2 class="panel-title" style="margin-top: 20px;">ğŸ“œ å­¦æ ¡ç¼–å¹´å²</h2>
        <div class="log-box" id="log-box"></div>
    </div>
</div>

<!-- ================= å¼¹çª—åŒºåŸŸ ================= -->

<!-- 1. å¸ˆèµ„ä¸æ’è¯¾å¼¹çª— -->
<div id="modal-schedule" class="fs-modal">
    <div class="fs-content" style="max-width: 700px; height: auto;">
        <div class="fs-header">
            <div>ğŸ“… å¸ˆèµ„è˜ç”¨ä¸æ’è¯¾ç³»ç»Ÿ</div>
            <button class="fs-close" onclick="closeModal('modal-schedule')">Ã—</button>
        </div>
        <div class="fs-body">
            <p style="color:#64748b; font-size:0.9rem;">æ¯å‘¨æ€»è¯¾æ—¶ä¸ºå›ºå®š <b>40èŠ‚</b>ã€‚è°ƒæ•´å„ç§‘æ¯”ä¾‹å°†æå¤§å½±å“æ¯æœˆçš„å±æ€§èµ°å‘ã€‚æ‹›å‹Ÿæ›´é«˜ç­‰çº§çš„å­¦ç§‘å¸¦å¤´äººå¯è·å¾—å€ç‡åŠ æˆã€‚</p>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
                <!-- å¸ˆèµ„å¡ç‰‡ -->
                <div class="res-box">
                    <h4 style="margin:0 0 5px 0; color:var(--primary)">ä¸»ç§‘ç»„ (è¯­æ•°è‹±)</h4>
                    çº§åˆ«: <span id="tch-main" style="font-weight:bold; color:var(--danger)">å®ä¹ æ•™å¸ˆ (x0.8)</span><br>
                    <button class="btn" style="margin-top:10px; padding:5px;" onclick="upgradeTeacher('main')">æ‹›å‹Ÿå‡çº§ (ï¿¥30ä¸‡)</button>
                </div>
                <div class="res-box">
                    <h4 style="margin:0 0 5px 0; color:var(--primary)">å‰¯ç§‘ç»„ (ç†/æ–‡ç»¼)</h4>
                    çº§åˆ«: <span id="tch-minor" style="font-weight:bold; color:var(--danger)">å®ä¹ æ•™å¸ˆ (x0.8)</span><br>
                    <button class="btn" style="margin-top:10px; padding:5px;" onclick="upgradeTeacher('minor')">æ‹›å‹Ÿå‡çº§ (ï¿¥20ä¸‡)</button>
                </div>
                <div class="res-box">
                    <h4 style="margin:0 0 5px 0; color:var(--primary)">ç´ è´¨ç»„ (ä½“éŸ³ç¾)</h4>
                    çº§åˆ«: <span id="tch-spec" style="font-weight:bold; color:var(--danger)">å®ä¹ æ•™å¸ˆ (x0.8)</span><br>
                    <button class="btn" style="margin-top:10px; padding:5px;" onclick="upgradeTeacher('spec')">æ‹›å‹Ÿå‡çº§ (ï¿¥15ä¸‡)</button>
                </div>
            </div>

            <div class="slider-group">
                <div class="slider-header"><span>ğŸ“š ä¸»ç§‘è¯¾æ—¶ (é«˜æˆç»©/æé«˜å‹åŠ›)</span> <span id="lbl-main-hr">20 èŠ‚</span></div>
                <input type="range" id="range-main" min="0" max="40" value="20" oninput="adjustSchedule('main')">
            </div>
            <div class="slider-group">
                <div class="slider-header"><span>ğŸ”¬ å‰¯ç§‘è¯¾æ—¶ (ä¸­æˆç»©/ä¸­å‹åŠ›)</span> <span id="lbl-minor-hr">15 èŠ‚</span></div>
                <input type="range" id="range-minor" min="0" max="40" value="15" oninput="adjustSchedule('minor')">
            </div>
            <div class="slider-group">
                <div class="slider-header"><span>ğŸ¨ ç´ è´¨è¯¾æ—¶ (æä½“è´¨ç´ è´¨/é™å‹åŠ›)</span> <span id="lbl-spec-hr">5 èŠ‚</span></div>
                <input type="range" id="range-spec" min="0" max="40" value="5" oninput="adjustSchedule('spec')">
            </div>
            <div style="text-align:center; color:var(--danger); font-weight:bold; display:none;" id="warn-schedule">æ€»è¯¾æ—¶å¿…é¡»ç­‰äº40èŠ‚ï¼ç³»ç»Ÿå·²è‡ªåŠ¨å¹³è¡¡ã€‚</div>
        </div>
    </div>
</div>

<!-- 2. æ•™æ”¹å†³ç­–æ ‘å¼¹çª— -->
<div id="modal-tree" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header">
            <div>ğŸ’¡ æ•™æ”¹å†³ç­–æ ‘ (å½“å‰æ•™ç ”ç‚¹: <span id="tree-points" style="color:var(--chalk-yellow)">0</span>)</div>
            <button class="fs-close" onclick="closeModal('modal-tree')">Ã—</button>
        </div>
        <div class="fs-body">
            <div class="tree-grid" id="tree-container">
                <!-- JSåŠ¨æ€ç”ŸæˆèŠ‚ç‚¹ -->
            </div>
        </div>
    </div>
</div>

<!-- 3. é€šç”¨ä¿¡æ¯å¼¹çª— (åŒ…å«è”è€ƒå›¾è¡¨) -->
<div id="modal-overlay">
    <div class="modal-content" id="modal-box-content">
        <h2 id="modal-title">äº‹ä»¶æ ‡é¢˜</h2>
        <div id="modal-desc" style="line-height: 1.6; margin-bottom: 20px; font-size: 1rem; text-align:left;">äº‹ä»¶æè¿°</div>
        <div id="modal-buttons" style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px;"></div>
    </div>
</div>

<script>
    // --- å¸¸é‡é…ç½® ---
    const SCHOOL_LEVELS = [
        { name: "ä¹¡é•‡ä¸­å­¦", reqRep: 0, reqFunds: 0, reqGrade: 0 },
        { name: "å¿çº§é‡ç‚¹", reqRep: 300, reqFunds: 100, reqGrade: 50 },
        { name: "å¸‚çº§ç¤ºèŒƒ", reqRep: 1000, reqFunds: 300, reqGrade: 65 },
        { name: "çœçº§åæ ¡", reqRep: 3000, reqFunds: 1000, reqGrade: 80 },
        { name: "å…¨å›½ç™¾å¼ºé¡¶å°–", reqRep: 8000, reqFunds: 3000, reqGrade: 90 }
    ];

    const TEACHER_TIERS = [
        { name: "å®ä¹ æ•™å¸ˆ", multi: 0.8, cost: 0, color: "var(--text-main)" },
        { name: "å¸‚çº§éª¨å¹²", multi: 1.2, cost: 20, color: "var(--primary)" },
        { name: "ç‰¹çº§åå¸ˆ", multi: 1.8, cost: 50, color: "var(--purple)" }
    ];

    // --- 15ä¸ªå†³ç­–æ ‘èŠ‚ç‚¹ ---
    const DECISION_TREE = [
        // æ•™å­¦ç¯‡
        { id: "t1", cat: "æ•™å­¦", name: "æ—©æ™šè‡ªä¹ åˆ¶åº¦", desc: "å»¶é•¿åœ¨æ ¡æ—¶é—´ã€‚æ¯æœˆå­¦ä¸š+1.5ï¼Œå‹åŠ›+2ã€‚", cost: 10, req: null },
        { id: "t2", cat: "æ•™å­¦", name: "é¢˜æµ·æˆ˜æœ¯", desc: "è”è€ƒæ—¶ï¼Œæˆç»©å‡åˆ†é¢å¤–+20åˆ†ã€‚", cost: 20, req: "t1" },
        { id: "t3", cat: "æ•™å­¦", name: "åˆ†å±‚èµ°ç­åˆ¶", desc: "å› ææ–½æ•™ã€‚æ¯æœˆå­¦ä¸š+1ï¼Œç´ è´¨+1ï¼Œçºªå¾‹-1ã€‚", cost: 30, req: "t1" },
        { id: "t4", cat: "æ•™å­¦", name: "å¥¥èµ›å¼ºåŸºè®¡åˆ’", desc: "å¼€å±•å¥¥èµ›é›†è®­æ—¶ï¼Œå¤ºé‡‘æ¦‚ç‡æå‡ 15%ã€‚", cost: 50, req: "t2" },
        { id: "t5", cat: "æ•™å­¦", name: "åå¸ˆå·¥ä½œå®¤", desc: "å…¨æ ¡æ‰€æœ‰å­¦ç§‘æ•™å¸ˆçš„åŠ æˆå€ç‡é¢å¤–æå‡ 0.2ã€‚", cost: 80, req: "t3" },
        
        // å¾·è‚²å¿ƒç†ç¯‡
        { id: "m1", cat: "å¾·è‚²", name: "è¡¡æ°´åŒ–è·‘æ“", desc: "å£å·éœ‡å¤©ã€‚æ¯æœˆçºªå¾‹+2ï¼Œä½“è´¨+1ï¼Œå‹åŠ›+1.5ã€‚", cost: 15, req: null },
        { id: "m2", cat: "å¾·è‚²", name: "å¿ƒç†è¾…å¯¼å®¤", desc: "ç–å¯¼æƒ…ç»ªã€‚å­¦ç”Ÿå´©æºƒ(ä¼‘å­¦)çš„å‹åŠ›é˜ˆå€¼æé«˜ 10ç‚¹ã€‚", cost: 25, req: null },
        { id: "m3", cat: "å¾·è‚²", name: "é«˜è€ƒèª“å¸ˆå¤§ä¼š", desc: "è§£é”æ–°åŠ¨ä½œï¼šé«˜ä¸‰ä¸‹å­¦æœŸå¯æå¤§å¹…åº¦æå‡çŸ­æœŸæˆç»©ï¼Œä¼´éšæé«˜å‹åŠ›ã€‚", cost: 40, req: "m1" },
        { id: "m4", cat: "å¾·è‚²", name: "è¥å…»é…é¤åˆ¶", desc: "æ”¹å–„ä¼™é£Ÿã€‚æ¯æœˆä½“è´¨+2ï¼Œæ¶ˆè€—èµ„é‡‘+5ä¸‡ã€‚", cost: 45, req: "m2" },
        { id: "m5", cat: "å¾·è‚²", name: "å‡†å†›äº‹åŒ–ç®¡ç†", desc: "é“è…•æ²»æ ¡ã€‚çºªå¾‹æ°¸è¿œä¸ä¼šè·Œç ´ 50ã€‚", cost: 70, req: "m1" },

        // ç´ è´¨æ‹“å±•ç¯‡
        { id: "a1", cat: "ç´ è´¨", name: "å¿«ä¹ä½“è‚²", desc: "é‡Šæ”¾å¤©æ€§ã€‚ç´ è´¨è¯¾(ä½“éŸ³ç¾)çš„é™å‹æ•ˆæœç¿»å€ã€‚", cost: 15, req: null },
        { id: "a2", cat: "ç´ è´¨", name: "ç¤¾å›¢è”åˆä¼š", desc: "ç™¾èŠ±é½æ”¾ã€‚æ¯æœˆç´ è´¨+2ï¼Œçºªå¾‹-1ã€‚", cost: 25, req: "a1" },
        { id: "a3", cat: "ç´ è´¨", name: "å¥–å­¦é‡‘åˆ¶åº¦", desc: "åƒé‡‘ä¹°é©¬éª¨ã€‚æ¯å¹´9æœˆæ‹›ç”Ÿæ—¶é¢å¤–è·å¾— 10% å£°èª‰ã€‚", cost: 40, req: null },
        { id: "a4", cat: "ç´ è´¨", name: "å›½é™…äº¤æµéƒ¨", desc: "é«˜è€ƒç»“ç®—æ—¶ï¼Œç´ è´¨å±æ€§è½¬åŒ–ç•™å­¦å¤–æ±‡çš„æ”¶ç›Šç¿»å€ã€‚", cost: 60, req: "a2" },
        { id: "a5", cat: "ç´ è´¨", name: "æ ¡åŠå°åˆ·å‚", desc: "ç–¯ç‹‚å°å·å­å¤–å–ã€‚æ¯æœˆè¢«åŠ¨å¢åŠ èµ„é‡‘ 15ä¸‡ï¼Œå£°èª‰å¾®é™ã€‚", cost: 80, req: "a3" }
    ];

    // --- æ ¸å¿ƒæ¸¸æˆæ•°æ® ---
    const defaultState = {
        year: 2018, month: 9, levelIdx: 0,
        funds: 80, reputation: 100, ap: 10, maxAp: 20, eduPoints: 0,
        grade: 40, stress: 10, discipline: 60, fitness: 50, art: 30,
        
        // æ’è¯¾ä¸å¸ˆèµ„
        schedule: { main: 20, minor: 15, spec: 5 },
        teachers: { main: 0, minor: 0, spec: 0 }, // tier index
        
        facilities: { confucius: 0, media: 0, track: 0 },
        unlockedNodes: [],
        hasOlympiadTeam: false
    };

    let game = JSON.parse(JSON.stringify(defaultState));

    // --- åˆå§‹åŒ–ä¸ä¸»å¾ªç¯ ---
    function init() {
        let saved = localStorage.getItem('jiningSchoolV4');
        if(saved) {
            game = JSON.parse(saved);
            log("è¯»å–æœ¬åœ°å­˜æ¡£æˆåŠŸï¼Œæ¬¢è¿å›æ¥ï¼Œæ ¡é•¿ï¼");
        } else {
            log(`ã€${game.year}å¹´å»ºæ ¡ã€‘å¼€å¯åæ ¡ä¹‹è·¯ï¼Œè¯·å…ˆè¿›è¡Œã€æ’è¯¾ã€‘ä¸ã€æ‹›å‹Ÿè€å¸ˆã€‘ã€‚`, 'var(--banner-red)');
            // æ–°æ‰‹å¼•å¯¼
            showToast("æç¤ºï¼šç‚¹å‡»ä¸­é—´çš„ã€å¸ˆèµ„ä¸æ’è¯¾ã€‘è®¾ç½®è¯¾è¡¨ï¼");
        }
        updateUI();
        renderDecisionTree();
    }

    function advanceMonth() {
        game.month++;
        if (game.month > 12) { game.month = 1; game.year++; }
        
        game.ap = Math.min(game.maxAp, game.ap + 2);

        applyPassiveEffects();
        checkCrisis();

        if (game.month === 6) { triggerGaokao(); return; }
        if (game.month === 9) { triggerEnrollment(); return; }

        // éšæœºäº‹ä»¶ (10%æ¦‚ç‡)
        if (Math.random() < 0.1) triggerRandomEvent();

        if(!checkGameOver()) updateUI();
    }

    function applyPassiveEffects() {
        // 1. æ’è¯¾ä¸å¸ˆèµ„å½±å“
        let tMulti = {
            main: TEACHER_TIERS[game.teachers.main].multi + (hasNode('t5') ? 0.2 : 0),
            minor: TEACHER_TIERS[game.teachers.minor].multi + (hasNode('t5') ? 0.2 : 0),
            spec: TEACHER_TIERS[game.teachers.spec].multi + (hasNode('t5') ? 0.2 : 0)
        };

        // ä¸»ç§‘(20åŸºå‡†)ï¼šæé«˜æˆç»©ï¼Œæé«˜å‹åŠ›
        let mainFactor = game.schedule.main / 20; 
        game.grade += 1.0 * mainFactor * tMulti.main;
        game.stress += 1.5 * mainFactor;

        // å‰¯ç§‘(15åŸºå‡†)ï¼šä¸­ç­‰æˆç»©ï¼Œä¸­ç­‰å‹åŠ›
        let minorFactor = game.schedule.minor / 15;
        game.grade += 0.5 * minorFactor * tMulti.minor;
        game.stress += 0.8 * minorFactor;

        // ç´ è´¨ç§‘(5åŸºå‡†)ï¼šé™å‹ï¼Œæä½“è´¨ä¸ç´ è´¨
        let specFactor = game.schedule.spec / 5;
        let stressRelief = 2.0 * specFactor * (hasNode('a1') ? 2 : 1);
        game.stress -= stressRelief;
        game.fitness += 0.5 * specFactor * tMulti.spec;
        game.art += 0.8 * specFactor * tMulti.spec;

        // 2. å†³ç­–æ ‘è¢«åŠ¨
        if(hasNode('t1')) { game.grade += 1.5; game.stress += 2; }
        if(hasNode('t3')) { game.grade += 1; game.art += 1; game.discipline -= 1; }
        if(hasNode('m1')) { game.discipline += 2; game.fitness += 1; game.stress += 1.5; }
        if(hasNode('m4')) { game.fitness += 2; game.funds -= 5; }
        if(hasNode('a2')) { game.art += 2; game.discipline -= 1; }
        if(hasNode('a5')) { game.funds += 15; game.reputation -= 1; }
        if(hasNode('m5')) { game.discipline = Math.max(50, game.discipline); }

        // 3. è®¾æ–½è¢«åŠ¨
        game.discipline += game.facilities.confucius * 0.5;
        game.reputation += game.facilities.confucius * 2;
        game.grade += game.facilities.media * 0.8;
        game.fitness += game.facilities.track * 1.0;
        game.stress -= game.facilities.track * 0.5;

        // çº¦æŸä¸åŸºç¡€å¼€é”€
        clampAllStats();
        game.funds -= (10 + game.levelIdx * 5); // æ¯æœˆå›ºå®šå¼€é”€
    }

    function checkCrisis() {
        let stressLimit = 90 + (game.fitness / 10) + (hasNode('m2') ? 10 : 0);
        if (game.stress > stressLimit) {
            game.stress -= 40; game.reputation -= 80; game.grade -= 10;
            log(`ğŸš¨ æ‚²å‰§ï¼é«˜å‹å¯¼è‡´å¤šåå­¦ç”Ÿå¿ƒç†å´©æºƒä¼‘å­¦ã€‚å£°èª‰æš´è·Œï¼`, "var(--danger)");
            showToast("é«˜å‹å´©æºƒäº‹ä»¶çˆ†å‘ï¼");
        }
        if (game.discipline < 15 && !hasNode('m5')) {
            game.discipline += 30; game.funds -= 50; game.reputation -= 100;
            log(`ğŸš¨ å±æœºï¼å‘ç”Ÿæ¶æ€§æ ¡å›­éœ¸å‡Œäº‹ä»¶ã€‚å·¨é¢èµ”å¿ï¼Œåèª‰æ‰«åœ°ï¼`, "var(--danger)");
            showToast("æ ¡å›­æ²»å®‰å±æœºçˆ†å‘ï¼");
        }
    }

    // --- é«˜æ–¯åˆ†å¸ƒä¸è”è€ƒç³»ç»Ÿ (æ ¸å¿ƒç‰¹è‰²) ---
    // ç”Ÿæˆæ ‡å‡†æ­£æ€åˆ†å¸ƒéšæœºæ•°
    function randn_bm() {
        let u = 0, v = 0;
        while(u === 0) u = Math.random();
        while(v === 0) v = Math.random();
        return Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
    }

    function generateGaokaoScores() {
        // æ ¸å¿ƒå…¬å¼æ˜ å°„ï¼šGrade(0-100) æ˜ å°„åˆ° 750åˆ†åˆ¶
        // Grade=50 -> å‡åˆ†425ï¼› Grade=90 -> å‡åˆ†645
        let baseMean = game.grade * 5.5 + 150; 
        if(hasNode('t2')) baseMean += 20; // é¢˜æµ·æˆ˜æœ¯æåˆ†
        
        let stdDev = 60 + (game.stress * 0.3); // å‹åŠ›è¶Šå¤§ï¼Œæ–¹å·®è¶Šå¤§ï¼ˆå‘æŒ¥å¤±å¸¸å’Œè¶…å¸¸å˜å¤šï¼‰
        
        let buckets = { 'under400':0, 'b400_500':0, 'b500_600':0, 'b600_680':0, 'over680':0 };
        const STUDENT_COUNT = 1000; // æ¨¡æ‹Ÿ1000äººä¸€å±Š

        for(let i=0; i<STUDENT_COUNT; i++) {
            let score = Math.round(baseMean + randn_bm() * stdDev);
            score = Math.max(0, Math.min(750, score)); // é™åˆ¶0-750

            if(score < 400) buckets.under400++;
            else if(score < 500) buckets.b400_500++;
            else if(score < 600) buckets.b500_600++;
            else if(score < 680) buckets.b600_680++;
            else buckets.over680++;
        }
        return { buckets, mean: Math.round(baseMean), total: STUDENT_COUNT };
    }

    function organizeExam() {
        if(!payCost(3, 20)) return;
        game.stress += 5;

        let res = generateGaokaoScores();
        let b = res.buckets;
        
        // è®¡ç®—å¥–åŠ±æ•™ç ”ç‚¹
        let gainedEP = Math.floor((b.b500_600*1 + b.b600_680*3 + b.over680*10) / 50);
        game.eduPoints += gainedEP;

        let html = `
            <p>å…¨å¸‚ç»Ÿè€ƒç»“æŸï¼Œå…±æœ‰ ${res.total} åå­¦å­å‚è€ƒã€‚å¹³å‡åˆ†é¢„ä¼°ï¼š<b>${res.mean}åˆ†</b>ã€‚</p>
            <div style="text-align:left; background:#f8fafc; padding:10px; border-radius:6px; margin-bottom:15px;">
                ${renderChartRow("æ¸…åŒ—è‹—å­ (>680)", b.over680, res.total, "#9333ea")}
                ${renderChartRow("é‡æœ¬985 (600-680)", b.b600_680, res.total, "#ef4444")}
                ${renderChartRow("ä¸€æœ¬çº¿ (500-600)", b.b500_600, res.total, "#f59e0b")}
                ${renderChartRow("äºŒæœ¬æœ¬ç§‘ (400-500)", b.b400_500, res.total, "#3b82f6")}
                ${renderChartRow("è½æ¦œä¸“ç§‘ (<400)", b.under400, res.total, "#64748b")}
            </div>
            <p style="color:var(--success); font-weight:bold;">æœ¬æ¬¡è”è€ƒæ ¹æ®ä¼˜å°–ç”Ÿæ¯”ä¾‹ï¼Œè·å¾—äº† ${gainedEP} ç‚¹ã€æ•™ç ”ç‚¹ã€‘ï¼</p>
        `;
        
        log(`ç»„ç»‡å…¨å¸‚è”è€ƒã€‚å‡åˆ†${res.mean}ï¼Œè·å¾—æ•™ç ”ç‚¹ ${gainedEP}ã€‚`);
        showCustomModal("ğŸ“ è”è€ƒæˆç»©åˆ†ææŠ¥å‘Š", html, [{text:"ç¡®è®¤", action:updateUI}]);
    }

    function renderChartRow(label, val, total, color) {
        let pct = Math.max(1, (val / total) * 100).toFixed(1);
        return `
        <div class="chart-row">
            <div class="chart-label" style="color:${color}">${label}</div>
            <div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${pct}%; background:${color}">${pct}%</div></div>
            <div class="chart-val">${val}äºº</div>
        </div>`;
    }

    function triggerGaokao() {
        let res = generateGaokaoScores();
        let b = res.buckets;
        
        // åŸºäºæˆç»©åˆ†æ®µçš„é«˜è€ƒå¥–åŠ±æ ¸ç®—
        let repGain = b.b500_600 * 0.5 + b.b600_680 * 5 + b.over680 * 20 - (b.under400 * 1);
        let fundGain = b.b500_600 * 0.2 + b.b600_680 * 1 + b.over680 * 5;

        let olympDesc = "";
        if (game.hasOlympiadTeam) {
            let winRate = (game.grade * 0.4 + game.art * 0.6) / 100;
            if (hasNode('t4')) winRate += 0.15; // å¼ºåŸºè®¡åˆ’
            if (Math.random() < winRate) {
                repGain += 800; fundGain += 200; game.eduPoints += 20;
                olympDesc = "<div style='color:var(--danger); font-weight:bold; margin-top:10px;'>ğŸ† æ·æŠ¥ï¼æˆ‘æ ¡å­¦å­æ–©è·å¥¥èµ›é‡‘ç‰Œï¼å£°èª‰çˆ†æ£šï¼</div>";
            } else {
                olympDesc = "<div style='color:#64748b; margin-top:10px;'>âŒ å¥¥èµ›å…¨å†›è¦†æ²¡ï¼ŒæŠ•å…¥æ‰“æ°´æ¼‚ã€‚</div>";
            }
            game.hasOlympiadTeam = false;
        }

        let intlDesc = "";
        if (game.art > 60) {
            let intlStudents = Math.floor(game.art / 4);
            let multi = hasNode('a4') ? 20 : 10;
            let intlFunds = intlStudents * multi; 
            fundGain += intlFunds;
            intlDesc = `<div style='color:var(--primary); margin-top:5px;'>âœˆï¸ å›½é™…éƒ¨ä¸°æ”¶ï¼š${intlStudents}äººè·æµ·å¤–åæ ¡Offerï¼Œå¤–æ±‡åˆ›æ”¶ï¿¥${intlFunds}ä¸‡ã€‚</div>`;
        }

        game.reputation += repGain;
        game.funds += fundGain;

        let html = `
            <p style="font-size:1.1rem; color:var(--danger); font-weight:bold;">${game.year}å±Š å†³æˆ˜é«˜è€ƒæ”¾æ¦œï¼</p>
            <div style="text-align:left; background:#f8fafc; padding:10px; border-radius:6px; margin-bottom:15px;">
                ${renderChartRow("æ¸…åŒ—å¤äº¤ (>680)", b.over680, res.total, "#9333ea")}
                ${renderChartRow("é‡æœ¬985 (600-680)", b.b600_680, res.total, "#ef4444")}
                ${renderChartRow("ä¸€æœ¬çº¿ (500-600)", b.b500_600, res.total, "#f59e0b")}
                ${renderChartRow("äºŒæœ¬æœ¬ç§‘ (400-500)", b.b400_500, res.total, "#3b82f6")}
                ${renderChartRow("è½æ¦œä¸“ç§‘ (<400)", b.under400, res.total, "#64748b")}
            </div>
            ${olympDesc} ${intlDesc}
            <hr style="border:1px dashed #ccc; margin:15px 0;">
            <b>å¹´åº¦æ ¸ç®—æ”¶ç›Šï¼š</b><br>
            è·å¾—ç¤¾ä¼šå£°èª‰ï¼š${Math.floor(repGain)}<br>
            è·å¾—å‡å­¦å¥–é‡‘ï¼šï¿¥${Math.floor(fundGain)}ä¸‡
        `;
        
        log(`ã€${game.year}é«˜è€ƒæ”¾æ¦œã€‘æ¸…åŒ—${b.over680}äººï¼Œä¸€æœ¬${b.b500_600+b.b600_680}äººã€‚`);
        showCustomModal("ğŸ“ ç»ˆæå®¡åˆ¤ï¼šé«˜è€ƒæ”¾æ¦œ", html, [{text:"è¿æ¥æ–°é«˜ä¸€", action:()=>{ checkGameOver(); updateUI(); }}]);
    }

    function triggerEnrollment() {
        let currentLv = SCHOOL_LEVELS[game.levelIdx];
        
        let repBonus = hasNode('a3') ? 1.1 : 1.0;
        game.reputation *= repBonus; // å¥–å­¦é‡‘æœºåˆ¶

        let tuition = 80 + (game.levelIdx * 80) + (game.reputation / 8);
        game.funds += tuition;

        // è€ç”Ÿæ¯•ä¸šï¼Œæ–°ç”Ÿæ‹‰ä½/æ‹‰é«˜å¹³å‡çº¿
        let targetGrade = 40 + game.levelIdx * 8 + (game.reputation > currentLv.reqRep ? 5 : -5);
        let targetDisc = 55 + game.levelIdx * 5;
        
        game.grade = (game.grade * 0.6) + (targetGrade * 0.4);
        game.discipline = (game.discipline * 0.6) + (targetDisc * 0.4);
        game.stress = Math.max(0, game.stress - 30); // æš‘å‡æ¸…å‹

        let html = `
            å¾—ç›Šäºå½“å‰çš„å­¦æ ¡ç­‰çº§ã€${currentLv.name}ã€‘åŠå£°èª‰ï¼Œ<br>
            æœ¬å±Šæ–°ç”Ÿç¼´çº³å­¦æ‚è´¹å…±è®¡ï¼š<b style="color:var(--success)">ï¿¥${Math.floor(tuition)}ä¸‡</b>ã€‚<br><br>
            é«˜ä¸‰æ¯•ä¸šï¼Œæ–°è¡€æ³¨å…¥ï¼Œäº”ç»´å±æ€§å·²é‡æ–°è¯„ä¼°ã€‚
        `;
        log(`ã€9æœˆå¼€å­¦ã€‘æ–°ä¸€å±ŠæŠ¥åˆ°ï¼Œæ”¶å–å­¦è´¹ï¿¥${Math.floor(tuition)}ä¸‡ã€‚`);
        showCustomModal("ğŸ’ å¼€å­¦å­£ï¼šæ–°ç”ŸæŠ¥åˆ°", html, [{text:"å¼€å§‹æ–°å­¦å¹´", action:updateUI}]);
    }

    // --- å¸ˆèµ„ä¸æ’è¯¾ç³»ç»Ÿ ---
    function openSchedule() {
        document.getElementById('modal-schedule').style.display = 'flex';
        updateScheduleUI();
    }
    
    function updateScheduleUI() {
        document.getElementById('range-main').value = game.schedule.main;
        document.getElementById('range-minor').value = game.schedule.minor;
        document.getElementById('range-spec').value = game.schedule.spec;
        
        document.getElementById('lbl-main-hr').innerText = game.schedule.main + ' èŠ‚';
        document.getElementById('lbl-minor-hr').innerText = game.schedule.minor + ' èŠ‚';
        document.getElementById('lbl-spec-hr').innerText = game.schedule.spec + ' èŠ‚';

        ['main', 'minor', 'spec'].forEach(type => {
            let tier = TEACHER_TIERS[game.teachers[type]];
            let el = document.getElementById('tch-' + type);
            el.innerText = `${tier.name} (x${tier.multi})`;
            el.style.color = tier.color;
        });
    }

    function adjustSchedule(changed) {
        let m = parseInt(document.getElementById('range-main').value);
        let mi = parseInt(document.getElementById('range-minor').value);
        let s = parseInt(document.getElementById('range-spec').value);
        let total = m + mi + s;

        let warn = document.getElementById('warn-schedule');
        if (total !== 40) {
            warn.style.display = 'block';
            // ç®€å•è‡ªåŠ¨å¹³è¡¡æœºåˆ¶ï¼ˆç‰ºç‰²æœªæ‹¨åŠ¨çš„é¡¹ï¼‰
            if(changed === 'main') { s = 40 - m - mi; if(s<0) {mi += s; s=0;} }
            else if(changed === 'minor') { m = 40 - mi - s; if(m<0) {s += m; m=0;} }
            else { m = 40 - s - mi; if(m<0) {mi += m; m=0;} }
            
            // å¦‚æœæå€¼ä»ä¸å¹³ï¼Œå¼ºåˆ¶é‡ç½®
            if(m<0 || mi<0 || s<0) { m=20; mi=15; s=5; }
            
            game.schedule.main = m; game.schedule.minor = mi; game.schedule.spec = s;
            setTimeout(updateScheduleUI, 100);
        } else {
            warn.style.display = 'none';
            game.schedule.main = m; game.schedule.minor = mi; game.schedule.spec = s;
            updateScheduleUI();
        }
    }

    function upgradeTeacher(type) {
        let currentTier = game.teachers[type];
        if (currentTier >= 2) { showToast("è¯¥å­¦ç§‘ç»„å·²ç»æ˜¯ç‰¹çº§åå¸ˆé…ç½®äº†ï¼"); return; }
        
        let costList = { main: [30, 80], minor: [20, 60], spec: [15, 40] };
        let cost = costList[type][currentTier];

        if (payCost(0, cost)) {
            game.teachers[type]++;
            log(`é‡é‡‘æ‹›å‹Ÿï¼${type}æ•™ç ”ç»„å‡çº§ä¸ºã€${TEACHER_TIERS[game.teachers[type]].name}ã€‘`);
            updateScheduleUI();
            updateUI();
        }
    }

    // --- æ•™æ”¹å†³ç­–æ ‘ç³»ç»Ÿ ---
    function openTechTree() {
        document.getElementById('modal-tree').style.display = 'flex';
        renderDecisionTree();
    }

    function renderDecisionTree() {
        document.getElementById('tree-points').innerText = game.eduPoints;
        let container = document.getElementById('tree-container');
        let html = '';

        DECISION_TREE.forEach(node => {
            let isUnlocked = game.unlockedNodes.includes(node.id);
            let canUnlock = !isUnlocked && (!node.req || game.unlockedNodes.includes(node.req));
            let stateClass = isUnlocked ? 'unlocked' : (canUnlock ? '' : 'locked');
            
            let btnHtml = '';
            if (isUnlocked) {
                btnHtml = `<button class="node-btn" disabled style="background:var(--success)">å·²è½å®</button>`;
            } else if (canUnlock) {
                btnHtml = `<button class="node-btn" onclick="unlockNode('${node.id}')">è½å®å†³ç­–</button>`;
            } else {
                btnHtml = `<button class="node-btn" disabled>å‰ç½®æœªè§£é”</button>`;
            }

            html += `
            <div class="tree-node ${stateClass}">
                <span style="position:absolute; top:5px; right:10px; font-size:0.8rem; background:#e2e8f0; padding:2px 6px; border-radius:10px;">${node.cat}</span>
                <h3>${node.name}</h3>
                <p>${node.desc}</p>
                <div class="node-cost">éœ€æ•™ç ”ç‚¹: ${node.cost}</div>
                ${btnHtml}
            </div>`;
        });
        container.innerHTML = html;
    }

    function unlockNode(id) {
        let node = DECISION_TREE.find(n => n.id === id);
        if (game.eduPoints >= node.cost) {
            game.eduPoints -= node.cost;
            game.unlockedNodes.push(id);
            log(`âœ¨ è½å®æ–°æ•™æ”¹å†³ç­–ï¼šã€${node.name}ã€‘ï¼`);
            renderDecisionTree();
            updateUI();
        } else {
            showToast("æ•™ç ”ç‚¹ä¸è¶³ï¼Œå¤šç»„ç»‡å‡ æ¬¡è”è€ƒå§ï¼");
        }
    }
    function hasNode(id) { return game.unlockedNodes.includes(id); }

    // --- éšæœºäº‹ä»¶åº“ ---
    function triggerRandomEvent() {
        let events = [
            { title: "æ•™è‚²å±€çªå‡»å¬è¯¾", desc: "å¸‚æ•™è‚²å±€æ•™ç ”å‘˜ä¸æ‰“æ‹›å‘¼ç›´æ¥æ¨é—¨å¬è¯¾ã€‚",
              opts: [ { t: "å±•ç¤ºçœŸå®æ°´å¹³ (éœ€å¥½è€å¸ˆ)", act: () => {
                  if(game.teachers.main > 0) { game.reputation+=100; log("åå¸ˆæˆè¯¾å¤§æ”¾å¼‚å½©ï¼Œå—å±€é•¿è¡¨æ‰¬ã€‚"); }
                  else { game.reputation-=50; game.grade-=2; log("å®ä¹ è€å¸ˆç»éªŒä¸è¶³ï¼Œè¯¾å ‚æ··ä¹±è¢«é€šæŠ¥æ‰¹è¯„ã€‚"); }
              }} ]},
            { title: "æ™šè‡ªä¹ åœç”µ", desc: "æ•™å­¦æ¥¼å› è¶…è´Ÿè·åœç”µï¼Œå­¦ç”Ÿåœ¨é»‘æš—ä¸­æ’•ä¹¦ç‹‚æ¬¢ã€‚",
              opts: [ 
                  { t: "å¼€å¤‡ç”¨ç”µæºé•‡å‹ (èµ„é‡‘-10)", act: () => { if(payCost(0,10)){ game.discipline+=5; log("è¿…é€Ÿæ¢å¤ä¾›ç”µï¼Œé•‡å‹éªšä¹±ã€‚");} }},
                  { t: "é¡ºæ°´æ¨èˆŸæ”¾å‡åŠå¤© (å‹åŠ›-20)", act: () => { game.stress-=20; log("å­¦ç”Ÿäº«å—äº†éš¾å¾—çš„ç‹‚æ¬¢å¤œã€‚"); }}
              ]}
        ];
        let ev = events[Math.floor(Math.random()*events.length)];
        let html = ev.opts.map((o,i) => `<button class="modal-btn" onclick="execEvt(${i})">${o.t}</button>`).join('');
        window.tempOpts = ev.opts;
        showCustomModal("ğŸ² çªå‘äº‹ä»¶ï¼š" + ev.title, ev.desc, []);
        document.getElementById('modal-buttons').innerHTML = html;
    }
    function execEvt(i) {
        window.tempOpts[i].act();
        closeModal('modal-overlay');
        updateUI();
    }

    // --- åŸºå»ºä¸ä¸“é¡¹ ---
    function buildFacility(type) {
        if (game.facilities[type] >= 3) { showToast("è¯¥è®¾æ–½å·²æ»¡çº§ï¼"); return; }
        let costs = { 'confucius': 10, 'media': 20, 'track': 15 };
        let cost = costs[type] * (game.facilities[type] + 1);

        if (payCost(0, cost)) {
            game.facilities[type]++;
            log(`ğŸ—ï¸ æ ¡å›­æ‰©å»ºï¼š${type}è®¾æ–½å‡è‡³ Lv.${game.facilities[type]}`);
            updateUI();
        }
    }

    function runAction(type) {
        if (type === 'olympiad') {
            if (game.hasOlympiadTeam) { showToast("ä»Šå¹´å·²ç»æˆç«‹é›†è®­é˜Ÿäº†ï¼"); return; }
            if (payCost(4, 5)) {
                game.hasOlympiadTeam = true; game.stress += 15;
                log("æˆç«‹å¥¥èµ›å¼ºåŸºé›†è®­é˜Ÿï¼Œé™å¾…é«˜è€ƒæ”¾æ¦œï¼"); updateUI();
            }
        }
    }

    function checkUpgrade() {
        if (game.levelIdx >= SCHOOL_LEVELS.length - 1) { showToast("å·²æ˜¯æœ€é«˜çº§åˆ«ï¼"); return; }
        let nextLv = SCHOOL_LEVELS[game.levelIdx + 1];
        if (game.reputation >= nextLv.reqRep && game.funds >= nextLv.reqFunds && game.grade >= nextLv.reqGrade) {
            game.levelIdx++;
            log(`ğŸ‰ æ­å–œï¼æ™‹å‡ä¸ºã€${nextLv.name}ã€‘ï¼`, "var(--success)");
            showCustomModal("ğŸ« å­¦æ ¡æ™‹å‡", `å„é¡¹æŒ‡æ ‡è¾¾æ ‡ï¼æ­£å¼æŒ‚ç‰Œï¼š<b>${nextLv.name}</b>ï¼å­¦è´¹åº•è–ªæå‡ã€‚`, [{text:"å¤ªæ£’äº†", action:updateUI}]);
        } else {
            showCustomModal("âŒ æ¡ä»¶ä¸è¶³", `å‡çº§éœ€è¦ï¼š<br>å£°èª‰: ${Math.floor(game.reputation)}/${nextLv.reqRep} <br>èµ„é‡‘: ${Math.floor(game.funds)}/${nextLv.reqFunds}ä¸‡ <br>å­¦ä¸š: ${Math.floor(game.grade)}/${nextLv.reqGrade}`, [{text:"ç»§ç»­åŠªåŠ›", action:()=>{}}]);
        }
    }

    function checkGameOver() {
        if (game.funds < 0) {
            showCustomModal("âŒ å­¦æ ¡ç ´äº§", "èµ„é‡‘é“¾æ–­è£‚ï¼Œå­¦æ ¡è¢«å¼ºåˆ¶æ‹å–ã€‚", [{text:"é‡å¤´å†æ¥", action:hardReset}]); return true;
        }
        if (game.reputation <= -100) {
            showCustomModal("âŒ èº«è´¥åè£‚", "æ¶æ€§äº‹ä»¶é¢‘å‘ï¼Œæ•™è‚²å±€å¼ºè¡Œæ¥ç®¡å…å»æ ¡é•¿èŒåŠ¡ã€‚", [{text:"é‡å¤´å†æ¥", action:hardReset}]); return true;
        }
        return false;
    }

    // --- å·¥å…·ä¸UIå‡½æ•° ---
    function payCost(ap, funds) {
        if (game.ap >= ap && game.funds >= funds) { game.ap -= ap; game.funds -= funds; return true; }
        showToast("APæˆ–èµ„é‡‘ä¸è¶³ï¼"); return false;
    }

    function clampAllStats() {
        ['grade', 'stress', 'discipline', 'fitness', 'art'].forEach(s => game[s] = Math.max(0, Math.min(100, game[s])));
    }

    function saveGame() { localStorage.setItem('jiningSchoolV4', JSON.stringify(game)); showToast("ğŸ’¾ è¿›åº¦å·²ä¿å­˜"); }
    function loadGame() { let saved=localStorage.getItem('jiningSchoolV4'); if(saved){ game=JSON.parse(saved); updateUI(); showToast("ğŸ“‚ å­˜æ¡£å·²è¯»å–");} }
    function hardReset() { localStorage.removeItem('jiningSchoolV4'); game = JSON.parse(JSON.stringify(defaultState)); init(); closeModal('modal-overlay'); }

    function log(msg, color = "var(--text-main)") {
        let box = document.getElementById('log-box');
        let item = document.createElement('div');
        item.className = 'log-item';
        item.innerHTML = `<span style="color:var(--primary); font-weight:bold;">[${game.year}å¹´${game.month}æœˆ]</span> <span style="color:${color}">${msg}</span>`;
        box.prepend(item);
        if(box.children.length > 50) box.removeChild(box.lastChild);
    }

    function showToast(msg) {
        let box = document.getElementById('toast-container');
        let t = document.createElement('div'); t.className = 'toast'; t.innerText = msg;
        box.appendChild(t); setTimeout(() => t.remove(), 2900);
    }

    function showCustomModal(title, desc, btns) {
        document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('modal-title').innerHTML = title;
        document.getElementById('modal-desc').innerHTML = desc;
        let bHtml = ''; window.customActs = {};
        btns.forEach((b, i) => { window.customActs[i] = b.action; bHtml += `<button class="modal-btn" onclick="execCust(${i})">${b.text}</button>`; });
        document.getElementById('modal-buttons').innerHTML = bHtml;
    }
    function execCust(i) { closeModal('modal-overlay'); if(window.customActs[i]) window.customActs[i](); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function updateUI() {
        document.getElementById('ui-date').innerText = `${game.year}å¹´ ${game.month}æœˆ`;
        let hint = "å¸¸è§„æ•™å­¦æœˆ";
        if(game.month===6) hint = "ã€é«˜è€ƒå­£ã€‘åƒå†›ä¸‡é©¬è¿‡ç‹¬æœ¨æ¡¥";
        if(game.month===9) hint = "ã€å¼€å­¦å­£ã€‘æ–°ç”ŸæŠ¥åˆ°æ”¶å–å­¦è´¹";
        document.getElementById('ui-season-hint').innerText = hint;

        document.getElementById('ui-level-name').innerText = SCHOOL_LEVELS[game.levelIdx].name;
        document.getElementById('ui-funds').innerText = Math.floor(game.funds);
        document.getElementById('ui-rep').innerText = Math.floor(game.reputation);
        document.getElementById('ui-ap').innerText = Math.floor(game.ap);
        document.getElementById('ui-eduPoints').innerText = game.eduPoints;

        ['grade', 'stress', 'disc', 'fit', 'art'].forEach(s => {
            let val = s === 'disc' ? game.discipline : (s === 'fit' ? game.fitness : game[s]);
            document.getElementById(`val-${s}`).innerText = Math.floor(val);
            document.getElementById(`bar-${s}`).style.width = val + '%';
        });

        ['confucius', 'media', 'track'].forEach(f => {
            document.getElementById(`fac-${f}`).innerText = game.facilities[f];
            let baseC = {'confucius':10, 'media':20, 'track':15}[f];
            document.getElementById(`cost-${f}`).innerText = baseC * (game.facilities[f] + 1);
        });
        
        // åˆ·æ–°å¼¹çª—å†…æ•°æ®ä»¥é˜²å¡ç•Œé¢
        document.getElementById('tree-points').innerText = game.eduPoints;
    }

    window.onload = init;
</script>

</body>
</html>
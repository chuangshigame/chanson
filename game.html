
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>孔子学校 - V1.0a 彼岸灯火</title>
    <style>
        :root {
            --bg-body: #060a12;
            --panel-bg: rgba(8, 15, 28, 0.95);
            --panel-border: rgba(0, 200, 255, 0.18);
            --board-bg: #0a1628;
            --chalk-white: #e2f0ff; --chalk-yellow: #ffe566; --chalk-blue: #60c8ff;
            --primary: #00c8ff; --success: #00ff9d; --warning: #ffaa00; --danger: #ff3355; --purple: #bf5fff;
            --gold: #ffd700; --wood: #1a0a00;
            --neon-green: #39ff14; --neon-cyan: #00ffe7; --neon-pink: #ff2d78;
            --radius: 4px; --shadow: 0 0 30px rgba(0, 200, 255, 0.08);
            --scan-line: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.08) 2px, rgba(0,0,0,0.08) 4px);
        }

        body {
            font-family: 'Courier New', 'Microsoft YaHei', monospace;
            background: var(--bg-body);
            background-image:
                radial-gradient(ellipse at 20% 20%, rgba(0,100,255,0.06) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 80%, rgba(150,0,255,0.06) 0%, transparent 60%),
                var(--scan-line);
            color: #8ab4cc;
            margin: 0; padding: 10px;
            display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden;
        }

        .container {
            width: 100%; max-width: 1450px;
            display: grid; gap: 12px;
            grid-template-columns: 310px 1fr 310px;
            transition: 0.5s;
        }

        /* ══════════ 顶部横幅 ══════════ */
        .header-banner {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(0,5,20,0.98), rgba(0,20,50,0.98));
            border: 1px solid rgba(0,200,255,0.4);
            border-top: 3px solid var(--primary);
            border-radius: var(--radius);
            padding: 14px 24px;
            position: relative; overflow: hidden;
            box-shadow: 0 0 40px rgba(0,200,255,0.12), inset 0 0 60px rgba(0,50,100,0.3);
        }
        .header-banner::before {
            content:'';
            position:absolute; top:0; left:-100%; width:60%; height:100%;
            background: linear-gradient(90deg, transparent, rgba(0,200,255,0.05), transparent);
            animation: hdr-scan 6s linear infinite;
        }
        @keyframes hdr-scan { to { left: 150%; } }
        .header-banner h1 {
            margin: 0; font-size: 1.9rem; letter-spacing: 6px;
            color: var(--primary);
            text-shadow: 0 0 20px var(--primary), 0 0 40px rgba(0,200,255,0.4);
            font-family: 'Courier New', monospace; font-weight: 900;
        }
        .header-banner p { margin: 4px 0 0; font-size: 0.78rem; color: rgba(0,200,255,0.5); letter-spacing: 3px; }
        .hdr-corner {
            position: absolute; top: 8px; right: 20px;
            font-size: 0.65rem; color: rgba(0,200,255,0.35); letter-spacing: 2px;
            font-family: monospace;
        }

        /* ══════════ 系统栏 ══════════ */
        .sys-bar {
            grid-column: 1 / -1;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,8,20,0.97);
            border: 1px solid var(--panel-border);
            border-left: 3px solid var(--neon-cyan);
            padding: 8px 16px; border-radius: var(--radius);
            flex-wrap: wrap; gap: 8px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .school-badge {
            padding: 4px 14px;
            background: linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,170,0,0.08));
            color: var(--gold); border-radius: 2px; font-weight: 900;
            border: 1px solid rgba(255,215,0,0.4);
            font-family: monospace; letter-spacing: 1px; font-size: 0.85rem;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        .sys-btn {
            padding: 5px 11px; cursor: pointer;
            background: rgba(0,200,255,0.05);
            border: 1px solid rgba(0,200,255,0.25);
            border-radius: 2px; font-weight: bold;
            transition: 0.2s; color: #7ecfea;
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 0.78rem; font-family: monospace;
            letter-spacing: 0.5px;
        }
        .sys-btn:hover:not(:disabled) {
            background: rgba(0,200,255,0.15);
            border-color: var(--primary);
            color: #fff;
            box-shadow: 0 0 12px rgba(0,200,255,0.3);
        }
        .btn-auto.active {
            background: rgba(255,51,85,0.2); color: var(--danger);
            border-color: var(--danger);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(255,51,85,0.5)} 70%{box-shadow:0 0 0 8px rgba(255,51,85,0)} }

        /* ══════════ 面板 ══════════ */
        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: var(--radius);
            padding: 14px;
            box-shadow: var(--shadow), inset 0 0 30px rgba(0,0,20,0.6);
            position: relative; overflow: hidden;
        }
        .panel::after {
            content:'';
            position:absolute; top:0; left:0; right:0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0.4;
        }
        .panel-title {
            font-size: 0.72rem; font-weight: 900; letter-spacing: 3px;
            color: var(--primary); margin: 0 0 10px;
            border-bottom: 1px solid rgba(0,200,255,0.15);
            padding-bottom: 6px; text-transform: uppercase;
            font-family: monospace;
            text-shadow: 0 0 8px rgba(0,200,255,0.4);
        }
        .panel-title::before { content: '▶ '; opacity: 0.6; font-size: 0.6rem; }

        /* ══════════ 资源格 ══════════ */
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 10px; }
        .res-box {
            background: rgba(0,200,255,0.03);
            border: 1px solid rgba(0,200,255,0.12);
            border-radius: 2px;
            padding: 8px 10px;
            font-size: 0.72rem; color: #5a8fa8;
            letter-spacing: 0.5px; font-family: monospace;
            position: relative;
        }
        .res-box span {
            display: block; font-size: 1.3rem; font-weight: 900;
            color: var(--neon-cyan);
            text-shadow: 0 0 10px rgba(0,255,231,0.5);
            line-height: 1.2; margin-top: 2px;
        }
        .res-sub { font-size: 0.6rem; color: #3a6070; margin-top: 2px; }

        /* ══════════ 黑板→数据面板 ══════════ */
        .blackboard {
            background: rgba(0,5,15,0.9);
            border: 1px solid rgba(0,200,255,0.15);
            border-left: 3px solid rgba(0,200,255,0.4);
            border-radius: 2px; padding: 12px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.6);
        }
        .stat-row { display: flex; align-items: center; gap: 8px; margin-bottom: 7px; }
        .stat-label { width: 90px; font-size: 0.72rem; color: #5a8fa8; letter-spacing: 0.5px; font-family: monospace; flex-shrink: 0; }
        .bar-bg {
            flex: 1; height: 6px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(0,200,255,0.1);
            border-radius: 1px; overflow: hidden;
        }
        .bar-fill { height: 100%; border-radius: 1px; transition: width 0.4s ease-out; }
        .stat-val { width: 28px; text-align: right; font-size: 0.8rem; font-weight: 900; color: var(--chalk-yellow); font-family: monospace; }
        .stress-warning {
            display: none; color: var(--danger); font-size: 0.7rem;
            font-weight: bold; text-align: center; margin: 4px 0;
            animation: pulse 1s infinite;
            text-shadow: 0 0 8px var(--danger);
        }

        /* ══════════ 按钮 ══════════ */
        .btn-main {
            background: linear-gradient(135deg, rgba(0,100,200,0.8), rgba(0,50,150,0.9));
            color: #fff; border: 1px solid rgba(0,200,255,0.5);
            font-size: 1rem; padding: 12px; border-radius: 2px;
            cursor: pointer; font-weight: 900; width: 100%; margin-bottom: 10px;
            box-shadow: 0 0 20px rgba(0,100,200,0.3);
            text-align: center; font-family: monospace; letter-spacing: 2px;
            transition: 0.2s; position: relative; overflow: hidden;
        }
        .btn-main::before {
            content:''; position:absolute; top:0; left:-100%; width:50%; height:100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
            transition: left 0.4s;
        }
        .btn-main:hover::before { left: 150%; }
        .btn-main:hover {
            transform: translateY(-1px);
            box-shadow: 0 0 30px rgba(0,200,255,0.4);
            border-color: var(--primary);
        }

        .btn {
            background: rgba(0,200,255,0.04);
            border: 1px solid rgba(0,200,255,0.2);
            border-radius: 2px; padding: 9px 12px;
            font-size: 0.82rem; cursor: pointer;
            color: #7ecfea; font-family: monospace;
            transition: 0.18s; display: flex; flex-direction: column;
            gap: 2px; text-align: left; font-weight: bold;
        }
        .btn:hover {
            background: rgba(0,200,255,0.12);
            border-color: var(--primary); color: #fff;
            box-shadow: 0 0 12px rgba(0,200,255,0.2);
            transform: translateY(-1px);
        }
        .btn-desc {
            font-size: 0.65rem; color: inherit; opacity: 0.55; font-weight: normal;
            font-family: monospace; letter-spacing: 0.3px;
        }
        .c-val { color: var(--warning); }

        /* ══════════ 彩色霓虹按钮 ══════════ */
        .btn-c-green  { --bc:#00ff9d; border-color:rgba(0,255,157,0.35)!important; color:#00ff9d!important; }
        .btn-c-orange { --bc:#ff8800; border-color:rgba(255,136,0,0.35)!important; color:#ff8800!important; }
        .btn-c-pink   { --bc:#ff2d78; border-color:rgba(255,45,120,0.35)!important; color:#ff6ba8!important; }
        .btn-c-blue   { --bc:#00c8ff; border-color:rgba(0,200,255,0.35)!important; color:#00c8ff!important; }
        .btn-c-purple { --bc:#bf5fff; border-color:rgba(191,95,255,0.35)!important; color:#bf5fff!important; }
        .btn-c-yellow { --bc:#ffe566; border-color:rgba(255,229,102,0.35)!important; color:#ffe566!important; }
        .btn-c-cyan   { --bc:#00ffe7; border-color:rgba(0,255,231,0.35)!important; color:#00ffe7!important; }

        .btn-c-green:hover,.btn-c-orange:hover,.btn-c-pink:hover,.btn-c-blue:hover,
        .btn-c-purple:hover,.btn-c-yellow:hover,.btn-c-cyan:hover {
            background: rgba(255,255,255,0.06)!important;
            border-color: var(--bc)!important;
            box-shadow: 0 0 16px rgba(255,255,255,0.08), inset 0 0 12px rgba(255,255,255,0.04)!important;
            text-shadow: 0 0 8px var(--bc);
        }
        .btn-c-green:hover  { background: rgba(0,255,157,0.07)!important; }
        .btn-c-orange:hover { background: rgba(255,136,0,0.07)!important; }
        .btn-c-pink:hover   { background: rgba(255,45,120,0.07)!important; }
        .btn-c-blue:hover   { background: rgba(0,200,255,0.07)!important; }
        .btn-c-purple:hover { background: rgba(191,95,255,0.07)!important; }
        .btn-c-yellow:hover { background: rgba(255,229,102,0.07)!important; }
        .btn-c-cyan:hover   { background: rgba(0,255,231,0.07)!important; }

        /* ══════════ 全局炫酷特效 ══════════ */
        /* 流光边框动画 */
        @keyframes border-flow {
            0%   { background-position: 0% 50%; }
            50%  { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* 赛博角标装饰 */
        .panel { --corner: rgba(0,200,255,0.5); }
        .panel::before {
            content:'';
            position:absolute; top:0; left:0;
            width:12px; height:12px;
            border-top:2px solid var(--corner);
            border-left:2px solid var(--corner);
            pointer-events:none; z-index:2;
        }
        /* 面板底部角标 */
        .panel-corner-br {
            position:absolute; bottom:0; right:0;
            width:12px; height:12px;
            border-bottom:2px solid rgba(0,200,255,0.3);
            border-right:2px solid rgba(0,200,255,0.3);
            pointer-events:none;
        }

        /* res-box 霓虹悬停 */
        .res-box {
            transition: 0.2s;
            cursor:default;
        }
        .res-box:hover {
            border-color: rgba(0,200,255,0.4);
            box-shadow: 0 0 15px rgba(0,200,255,0.1);
        }

        /* 全局扫描线叠加 */
        body::after {
            content:'';
            position:fixed; inset:0;
            background: repeating-linear-gradient(
                0deg, transparent, transparent 3px,
                rgba(0,200,255,0.012) 3px, rgba(0,200,255,0.012) 4px
            );
            pointer-events:none; z-index:99999;
        }

        /* 动态网格背景点 */
        #principal-container::before {
            content:'';
            position:fixed; inset:0;
            background-image:
                radial-gradient(circle, rgba(0,200,255,0.06) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events:none; z-index:0;
            animation: grid-drift 20s linear infinite;
        }
        @keyframes grid-drift {
            0%   { background-position: 0px 0px; }
            100% { background-position: 40px 40px; }
        }

        /* 系统栏闪烁光标 */
        @keyframes cursor-blink { 50% { opacity:0; } }
        .sys-cursor { animation: cursor-blink 1.2s step-end infinite; }

        /* 霓虹边框发光 - 用于重要元素 */
        .neon-border-cyan { box-shadow: 0 0 0 1px rgba(0,200,255,0.3), 0 0 20px rgba(0,200,255,0.08); }
        .neon-border-green { box-shadow: 0 0 0 1px rgba(0,255,157,0.3), 0 0 20px rgba(0,255,157,0.08); }


        #ui-date {
            font-size: 1.5rem; font-weight: 900;
            color: var(--neon-cyan) !important;
            text-shadow: 0 0 15px rgba(0,255,231,0.6);
            letter-spacing: 3px; font-family: monospace;
        }

        /* ══════════ 日志 ══════════ */
        .log-box {
            flex: 1; overflow-y: auto; font-size: 0.78rem;
            background: rgba(0,5,12,0.9);
            border: 1px solid rgba(0,200,255,0.1);
            padding: 10px; border-radius: 2px;
            line-height: 1.6; color: #4a7a8a;
            font-family: monospace;
        }
        .log-item { margin-bottom: 6px; border-bottom: 1px solid rgba(0,200,255,0.05); padding-bottom: 4px; }
        .log-box::-webkit-scrollbar { width: 3px; }
        .log-box::-webkit-scrollbar-thumb { background: rgba(0,200,255,0.3); border-radius: 2px; }

        /* ══════════ 信箱 ══════════ */
        .mailbox-container {
            height: 150px; overflow-y: auto;
            background: rgba(0,5,12,0.9);
            padding: 8px; border-radius: 2px;
            border: 1px solid rgba(0,200,255,0.1);
            margin-bottom: 10px;
            display: flex; flex-direction: column; gap: 6px;
        }
        .mailbox-container::-webkit-scrollbar { width: 3px; }
        .mailbox-container::-webkit-scrollbar-thumb { background: rgba(0,200,255,0.2); }
        .comment-bubble {
            background: rgba(0,50,80,0.3);
            border-left: 3px solid rgba(0,200,255,0.3);
            padding: 7px 10px; border-radius: 0 3px 3px 0;
            font-size: 0.78rem; color: #6a9aaa;
            font-family: monospace;
        }
        .comment-meta { font-size: 0.62rem; color: #2a4a5a; margin-top: 3px; text-align: right; }



        /* ===== 战斗视觉特效 ===== */
        .b-dmg-float {
            position: fixed; pointer-events: none; z-index: 99990;
            font-family: 'Courier New', monospace; font-weight: 900;
            animation: bdmg-rise 1.5s ease-out forwards;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.8), 0 0 12px currentColor;
            white-space: nowrap;
        }
        @keyframes bdmg-rise {
            0%   { transform: translateY(0) scale(0.6); opacity: 1; }
            20%  { transform: translateY(-20px) scale(1.2); opacity: 1; }
            60%  { transform: translateY(-60px) scale(1); opacity: 0.9; }
            100% { transform: translateY(-110px) scale(0.8); opacity: 0; }
        }
        @keyframes b-shake-x {
            0%,100%{transform:translateX(0) rotate(0)}
            15%{transform:translateX(-10px) rotate(-1.5deg)}
            35%{transform:translateX(10px) rotate(1.5deg)}
            55%{transform:translateX(-7px)}
            75%{transform:translateX(7px)}
        }
        @keyframes b-hit-red { 0%,100%{background:rgba(0,0,0,0.6)} 30%{background:rgba(239,68,68,0.4);box-shadow:inset 0 0 30px rgba(239,68,68,0.5)} }
        @keyframes b-hit-crit { 0%,100%{box-shadow:0 0 15px rgba(0,0,0,0.5)} 30%{box-shadow:0 0 50px rgba(192,132,252,1),inset 0 0 25px rgba(192,132,252,0.4)} }
        @keyframes b-hit-heal { 0%,100%{background:rgba(0,0,0,0.6)} 30%{background:rgba(16,185,129,0.3);box-shadow:inset 0 0 20px rgba(16,185,129,0.4)} }
        @keyframes b-enemy-lunge { 0%,100%{transform:translateX(0)} 25%{transform:translateX(18px) scale(1.03)} 60%{transform:translateX(-4px)} }
        @keyframes b-screen-flash { 0%,100%{opacity:0} 10%,40%{opacity:1} }
        .b-entity.b-hit   { animation: b-shake-x 0.5s ease-out, b-hit-red 0.55s ease-out; }
        .b-entity.b-crit  { animation: b-shake-x 0.6s ease-out, b-hit-crit 0.7s ease-out; }
        .b-entity.b-heal  { animation: b-hit-heal 0.6s ease-out; }
        .b-entity.b-lunge { animation: b-enemy-lunge 0.45s ease-out; }
        #b-screen-flash   { position:absolute;inset:0;pointer-events:none;border-radius:8px;opacity:0;z-index:10; }



        /* 面板通用 */
        .panel { background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow), inset 0 0 30px rgba(0,0,20,0.6); display:flex; flex-direction: column; position: relative; overflow:hidden; }
        .panel::after { content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(90deg,transparent,var(--primary),transparent); opacity:0.4; }
        .panel-title { font-size: 0.7rem; font-weight: 900; letter-spacing: 3px; color: var(--primary); margin: 0 0 10px; border-bottom: 1px solid rgba(0,200,255,0.15); padding-bottom: 6px; text-transform: uppercase; font-family: monospace; text-shadow: 0 0 8px rgba(0,200,255,0.4); }
        .panel-title::before { content: '▶ '; opacity: 0.6; font-size: 0.6rem; }

        /* 模态框系统 */
        .fs-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(2, 6, 18, 0.92); z-index: 2000; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(6px); }
        .fs-content { background: #060f1e; border: 1px solid rgba(0,200,255,0.2); width: 100%; max-width: 1300px; max-height: 90vh; border-radius: 4px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 60px rgba(0,200,255,0.1); }
        .fs-header { background: rgba(0,20,40,0.95); color: var(--primary); padding: 12px 18px; display: flex; justify-content: space-between; font-size: 1rem; font-weight: bold; align-items:center; border-bottom: 1px solid rgba(0,200,255,0.2); font-family:monospace; letter-spacing:2px; }
        .fs-close { background: transparent; border: 1px solid rgba(255,51,85,0.3); color: var(--danger); font-size: 1.2rem; cursor: pointer; line-height:1; padding: 2px 8px; border-radius:2px; transition:0.2s; }
        .fs-close:hover { background: rgba(255,51,85,0.15); }
        .fs-body { padding: 18px; overflow-y: auto; flex: 1; color: #8ab4cc; background: #060f1e; }
        .fs-body::-webkit-scrollbar { width: 4px; }
        .fs-body::-webkit-scrollbar-thumb { background: rgba(0,200,255,0.3); border-radius:2px; }

        /* 网格与卡片 */
        .grid-sys { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; }
        .gacha-card { background: rgba(0,20,40,0.8); border: 1px solid rgba(0,200,255,0.2); padding: 14px; border-radius: 3px; display: flex; align-items: center; gap: 12px; position:relative; }
        .expert-img { width: 56px; height: 56px; border-radius: 4px; object-fit: cover; border: 1px solid rgba(0,200,255,0.3); background: rgba(0,30,60,0.6); flex-shrink: 0; }
        .upkeep-tag { position:absolute; top:4px; right:4px; font-size:0.62rem; background:rgba(255,51,85,0.15); color:var(--danger); padding:2px 5px; border-radius:2px; font-weight:bold; border:1px solid rgba(255,51,85,0.3); }
        .type-tag { position:absolute; bottom:4px; right:4px; font-size:0.62rem; padding:2px 5px; border-radius:2px; font-weight:bold; }
        .type-battle { background: rgba(255,51,85,0.12); color:var(--danger); border:1px solid rgba(255,51,85,0.3); }
        .type-passive { background: rgba(0,200,255,0.1); color:var(--primary); border:1px solid rgba(0,200,255,0.3); }
        .rarity-R { border-color: rgba(59,130,246,0.5); box-shadow: 0 0 8px rgba(59,130,246,0.15); }
        .rarity-SR { border-color: rgba(168,85,247,0.5); box-shadow: 0 0 12px rgba(168,85,247,0.2); }
        .rarity-SSR { border-color: rgba(255,215,0,0.6); box-shadow: 0 0 20px rgba(255,215,0,0.2); background: linear-gradient(135deg, rgba(0,20,40,0.9), rgba(30,20,0,0.9)); }
        
        /* 树形结构 */
        .tree-tier { display: flex; gap: 12px; justify-content: center; width: 100%; margin-bottom: 20px; flex-wrap: wrap; }
        .tree-node { width: 220px; background: rgba(0,15,30,0.9); border: 1px solid rgba(0,200,255,0.2); border-radius: 3px; padding: 12px; text-align: center; transition: 0.3s; display: flex; flex-direction: column; justify-content: space-between; color:#8ab4cc; }
        .tree-node.locked { filter: grayscale(1); opacity: 0.4; }
        .tree-node.unlocked { border-color: var(--success); box-shadow: 0 0 15px rgba(0,255,157,0.15); background: rgba(0,255,157,0.04); }
        .tree-node.branch-a { border-top: 2px solid var(--danger); }
        .tree-node.branch-b { border-top: 2px solid var(--warning); }
        .tree-node.branch-c { border-top: 2px solid var(--gold); }
        .tree-node.branch-d { border-top: 2px solid var(--success); }

        /* 地图 */
        .map-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; background: rgba(0,30,10,0.8); padding: 12px; border-radius: 4px; border: 1px solid rgba(0,255,100,0.2); }
        .map-cell { background: rgba(0,255,100,0.03); border: 1px dashed rgba(0,255,100,0.2); border-radius: 3px; height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; position: relative; font-size:0.7rem; color:#4a8a5a; }
        .map-cell:hover { background: rgba(0,255,100,0.08); border-color: rgba(0,255,100,0.5); color:#fff; }
        .map-cell.selected { border: 1px solid var(--danger); background: rgba(255,51,85,0.08); }

        /* 学生模式 */
        #student-container { display: none; width: 100%; max-width: 1400px; background: rgba(8,15,28,0.98); border: 1px solid rgba(0,200,255,0.15); border-radius: 4px; padding: 12px; margin: 0 auto; box-shadow: var(--shadow); color:#8ab4cc; }
        .stu-grid { display: grid; grid-template-columns: 185px 1fr 380px; gap: 8px; align-items: start; }
        .stu-act-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; }
        .stu-act-btn { padding: 5px 7px; border: 1px solid rgba(0,200,255,0.15); border-radius: 2px; background: rgba(0,20,40,0.6); font-size: 0.7rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 4px; transition:0.15s; text-align:left; line-height: 1.2; width: 100%; box-sizing: border-box; color:#7ecfea; font-family:monospace; }
        .stu-act-btn:hover { border-color: var(--primary); background: rgba(0,200,255,0.1); color:#fff; }
        .stu-act-btn .stu-icon { font-size: 1rem; flex-shrink: 0; }
        .stu-act-btn b { font-size: 0.68rem; display:block; }
        .stu-act-btn .btn-sub { font-size: 0.58rem; color:#2a5a6a; font-weight:normal; display:block; }
        .stu-stat-box { background: rgba(0,10,25,0.95); color: #8ab4cc; border:1px solid rgba(0,200,255,0.15); padding: 10px; border-radius: 3px; margin-bottom: 8px; font-size: 0.8rem; font-family:monospace; }
        .exam-board { background: linear-gradient(135deg, rgba(0,100,80,0.8), rgba(0,60,50,0.9)); color: white; padding: 15px; border-radius: 3px; text-align: center; margin-bottom: 10px; border: 1px solid rgba(0,255,157,0.3); }
        
        .friend-card { background: rgba(0,15,30,0.8); border: 1px solid rgba(0,200,255,0.15); padding: 10px; border-radius: 3px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap:wrap; gap:5px; color:#8ab4cc; }
        .friend-card.active { border-color: var(--success); background: rgba(0,255,157,0.04); }
        .rebirth-points { background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(217,119,6,0.15)); color: var(--gold); padding: 4px 10px; border-radius: 2px; font-weight: bold; font-size: 0.85rem; border:1px solid rgba(255,215,0,0.3); font-family:monospace; }
        .family-card { background: rgba(0,15,30,0.8); border: 1px solid rgba(0,200,255,0.2); padding: 14px; border-radius: 3px; cursor: pointer; transition: 0.2s; position:relative; color:#8ab4cc; }
        .family-card:hover { border-color: var(--primary); background: rgba(0,200,255,0.06); transform: translateY(-2px); box-shadow: 0 0 15px rgba(0,200,255,0.1); }
        .family-card.selected { border-color: var(--primary); background: rgba(0,200,255,0.08); box-shadow: 0 0 0 1px rgba(0,200,255,0.4); }

        .battle-ui { display: flex; flex-direction: column; height: 85vh; max-height:850px; background: #000; color: #a3e635; padding: 15px; border-radius: 8px; font-family: 'Courier New', Courier, monospace; overflow: hidden; box-shadow: 0 0 30px rgba(101, 163, 13, 0.2); }
        .b-header { flex: 0 0 auto; display: flex; justify-content: space-between; border-bottom: 1px dashed #3f6212; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; color: #bef264; }
        .b-arena { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border: 2px solid #65a30d; border-radius: 8px; background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(20, 83, 45, 0.7)); position: relative; height: 160px; box-shadow: inset 0 0 25px rgba(101, 163, 13, 0.4); }
        .b-entity { width: 42%; background: rgba(0, 0, 0, 0.6); padding: 12px; border-radius: 8px; border: 1px solid #3f6212; box-shadow: 0 0 15px rgba(0,0,0,0.8); }
        .b-name { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; color: #d9f99d; text-shadow: 0 0 5px #d9f99d; }
        .b-hp-bg { height: 14px; background: #000; border: 1px solid #a3e635; margin: 5px 0; position: relative; border-radius:3px; overflow:hidden;}
        .b-hp-fill { height: 100%; background: linear-gradient(90deg, #4ade80, #16a34a); box-shadow: inset 0 0 8px rgba(255,255,255,0.4); transition: width 0.3s ease-out; }
        .b-hp-txt { position: absolute; width: 100%; text-align: center; top: -1px; font-size: 0.75rem; font-weight: bold; color: #fff; text-shadow:1px 1px 2px #000;}
        .b-stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; font-size: 0.75rem; color:#cbd5e1; }
        .b-stress-bar { height: 5px; background: #000; border: 1px solid #ef4444; margin-top: 4px; border-radius:2px; }
        .b-stress-fill { height: 100%; background: #dc2626; transition: width 0.3s; }
        
        .b-weather { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); text-align: center; background: rgba(0,0,0,0.8); padding: 5px 12px; border-radius: 6px; border: 1px solid #fde047; color: #fde047; font-size: 0.75rem; z-index: 10; width: 150px; box-shadow: 0 0 10px rgba(253,224,71,0.3);}
        .b-buffs { display: flex; flex-wrap: wrap; gap: 4px; font-size: 0.7rem; margin-top: 5px; color: #a7f3d0; }
        
        /* 战斗日志区域 */
        .b-log { flex: 1; border: 1px dashed #3f6212; padding: 10px; margin: 10px 0; overflow-y: auto; font-size: 0.85rem; line-height: 1.5; background: rgba(0,0,0,0.4); min-height: 100px; display:flex; flex-direction:column; border-radius:4px; }
        .b-log-inner { margin-top: auto; } /* 强制内容靠下 */
        .b-log span.sys { color: #fde047; } .b-log span.p { color: #93c5fd; } .b-log span.e { color: #fca5a5; } 
        .b-log span.dmg { color: #ef4444; font-weight: bold; } .b-log span.crit { color: #c084fc; font-weight: bold; text-shadow: 0 0 5px #c084fc; }
        
        .b-expert-select { flex: 0 0 auto; display:flex; gap:10px; margin-bottom:10px; overflow-x:auto; padding-bottom:5px; border-bottom:1px dashed #3f6212; min-height: 35px; align-items:center; }
        .b-expert-select::-webkit-scrollbar { height: 4px; }
        .b-expert-select::-webkit-scrollbar-thumb { background: #3f6212; border-radius: 2px; }

        /* 操作区域 */
        .b-actions { flex: 0 0 auto; border-top: 1px dashed #3f6212; padding-top: 10px; display: grid; grid-template-columns: 140px 1fr; gap: 10px; height: 160px; }
        .b-cats { display: flex; flex-direction: column; gap: 4px; overflow-y: auto; padding-right:5px;}
        .b-cats::-webkit-scrollbar { width: 4px; } .b-cats::-webkit-scrollbar-thumb { background:#3f6212; }
        .b-cat-btn { background: rgba(0,0,0,0.6); color: #a3e635; border: 1px solid #3f6212; padding: 8px; cursor: pointer; font-family: inherit; font-size: 0.85rem; text-align: left; transition: 0.2s; border-radius:4px; }
        .b-cat-btn:hover, .b-cat-btn.active { background: #14532d; border-color: #a3e635; box-shadow: 0 0 8px rgba(163,230,53,0.3); }
        .b-skills { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 8px; align-content: start; overflow-y: auto; padding-right:5px; }
        .b-skills::-webkit-scrollbar { width: 4px; } .b-skills::-webkit-scrollbar-thumb { background:#3f6212; }
        .b-skill-btn { background: rgba(0,0,0,0.6); color: #fff; border: 1px solid #4ade80; padding: 8px; cursor: pointer; font-family: inherit; text-align: left; display: flex; flex-direction: column; transition: 0.2s; border-radius:4px; }
        .b-skill-btn:hover:not(:disabled) { background: #166534; transform: translateX(2px); box-shadow: 0 0 8px rgba(74,222,128,0.4); }
        .b-skill-btn:disabled { border-color: #334155; color: #64748b; cursor: not-allowed; text-decoration: line-through; opacity: 0.6; }
        .b-s-name { font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }
        .b-s-desc { font-size: 0.7rem; color: #bef264; }

        /* 学生模式 */
        #student-container { display: none; width: 100%; max-width: 1400px; background: rgba(255,255,255,0.95); border-radius: 12px; padding: 12px; margin: 0 auto; box-shadow: var(--shadow); }
        .stu-grid { display: grid; grid-template-columns: 185px 1fr 380px; gap: 8px; align-items: start; }
        .stu-act-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; }
        .stu-act-btn { padding: 4px 6px; border: 1px solid #cbd5e1; border-radius: 5px; background: #fff; font-size: 0.7rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 4px; transition:0.15s; text-align:left; line-height: 1.2; width: 100%; box-sizing: border-box; }
        .stu-act-btn:hover { border-color: var(--primary); background: #eff6ff; }
        .stu-act-btn .stu-icon { font-size: 1rem; flex-shrink: 0; }
        .stu-act-btn b { font-size: 0.68rem; display:block; }
        .stu-act-btn .btn-sub { font-size: 0.58rem; color:#64748b; font-weight:normal; display:block; }
        .stu-stat-box { background: #1e293b; color: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.8rem; }
        .exam-board { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; border: 3px solid #047857; }
        
        .friend-card { background: #f8fafc; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap:wrap; gap:5px; }
        .friend-card.active { border-color: var(--success); background: #ecfdf5; }
        .rebirth-points { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; }
        .family-card { background: #fff; border: 2px solid #e2e8f0; padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; position:relative; }
        .family-card:hover { border-color: var(--primary); background: #eff6ff; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .family-card.selected { border-color: var(--primary); background: #eff6ff; box-shadow: 0 0 0 3px rgba(37,99,235,0.2); }

        .crush-card { background: #fff; border: 1px solid #fbcfe8; border-radius: 5px; padding: 5px; margin-bottom: 4px; display:flex; flex-direction:column; position:relative; overflow:hidden; font-size:0.72rem;}
        .crush-head { display:flex; gap:4px; align-items:center; margin-bottom:4px; }
        .crush-img { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #f9a8d4; object-fit: cover; background: #fdf2f8; flex-shrink:0; cursor:pointer; transition:0.2s; }
        .crush-img:hover { transform: scale(1.1); }
        .crush-info h4 { margin:0; color:#be185d; font-size:0.72rem;}
        .crush-info p { margin:0; font-size:0.6rem; color:#64748b;}
        .crush-bar-bg { background:#f1f5f9; height:5px; border-radius:3px; overflow:hidden; margin-bottom:5px; }
        .crush-bar-fill { background:linear-gradient(90deg, #f472b6, #db2777); height:100%; transition: width 0.3s;}
        .crush-actions { display:grid; grid-template-columns:1fr 1fr; gap:3px; }
        .crush-dialog { background:#fdf2f8; padding:5px; border-radius:4px; font-size:0.65rem; color:#be185d; font-style:italic; margin-bottom:5px; display:none; border-left:2px solid #f472b6;}

        /* ===== 终末之诗 ===== */
        #end-poem-overlay {
            display: none;
            position: fixed; inset: 0;
            background: #000;
            z-index: 99999;
            overflow: hidden;
            cursor: pointer;
        }
        #end-poem-track {
            position: absolute;
            left: 0; right: 0; top: 0;
            padding: 0 clamp(16px, 6vw, 60px) 20vh;
            box-sizing: border-box;
            text-align: center;
            animation: poemScroll 150s linear forwards;
        }
        #end-poem-track.done-anim ~ #end-poem-close-hint { display: block !important; }
        @keyframes poemScroll {
            from { transform: translateY(100vh); }
            to   { transform: translateY(-8000px); }
        }
        .poem-line { display: block; color: #d1d5db; font-size: clamp(1.05rem, 3.2vw, 1.25rem); line-height: 2; font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif; margin: 0; }
        .poem-line.dim    { color: #4b5563; }
        .poem-line.gold   { color: #fde047; font-weight: 700; font-size: clamp(1.1rem, 3.5vw, 1.35rem); }
        .poem-line.big    { color: #fff; font-weight: 900; font-size: clamp(1.3rem, 4.5vw, 1.7rem); letter-spacing: 4px; }
        .poem-line.small  { color: #374151; font-size: clamp(0.78rem, 2.2vw, 0.9rem); }
        .poem-line.italic { color: #c4cdd8; font-style: italic; }
        .poem-line.quote  { color: #f9a8d4; font-style: italic; border-left: 3px solid #f472b6; padding-left: 16px; text-align: left; display: inline-block; max-width: min(640px, 90vw); line-height: 2; margin: 4px 0; }
        .poem-spacer { display: block; height: clamp(1rem, 3vh, 2rem); }
        .poem-hint   { display: block; color: #374151; font-size: 0.8rem; }

        .chart-container { display: flex; align-items: flex-end; justify-content: space-around; height: 180px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px 5px 0 5px; margin: 15px 0; }
        .chart-col { display: flex; flex-direction: column; align-items: center; width: 14%; font-size: 0.7rem; }
        .chart-bar { width: 100%; border-radius: 4px 4px 0 0; transition: 0.5s; display: flex; justify-content: center; align-items:flex-end; color: white; font-weight: bold; padding-top: 5px; font-size: 0.8rem; padding-bottom:2px;}
        .chart-label { font-size: 0.7rem; font-weight: bold; margin-top: 5px; color: #475569; text-align: center; line-height:1.2; }

        /* 通用弹窗覆盖 */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 9000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.6); max-height: 90vh; overflow-y:auto; }
        .modal-btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 8px; font-weight: bold; font-size: 1rem; transition: 0.2s; display:inline-flex; flex-direction:column; align-items:center; }
        .modal-btn:hover { background: #1d4ed8; transform: translateY(-2px); }

        /* Toast */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: rgba(15,23,42,0.95); color: white; padding: 15px 20px; border-radius: 8px; font-weight: bold; border-left: 4px solid var(--primary); animation: slideIn 0.3s forwards, fadeOut 0.5s 3.5s forwards; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        @keyframes slideIn { from{transform: translateX(100%);} to{transform: translateX(0);} }
        @keyframes fadeOut { to{transform: translateY(-20px); opacity:0;} }
        /* ===== 抽卡动画 ===== */
        #gacha-overlay {
            display: none; position: fixed; inset: 0; z-index: 99998;
            background: #000; justify-content: center; align-items: center;
        }
        #gacha-overlay.show { display: flex; }
        #gacha-card {
            width: min(340px, 88vw); aspect-ratio: 2/3;
            border-radius: 20px; position: relative;
            display: flex; flex-direction: column; justify-content: flex-end;
            align-items: center; padding: 24px 20px;
            box-shadow: 0 0 80px var(--gc, #3b82f6);
            transform: scale(0) rotateY(180deg);
            transition: transform 0.6s cubic-bezier(0.34,1.56,0.64,1);
            cursor: pointer; overflow: hidden;
            background: var(--gc-bg, linear-gradient(160deg,#1e3a5f,#0f172a));
        }
        #gacha-card.flip { transform: scale(1) rotateY(0deg); }
        #gacha-card::before {
            content:''; position:absolute; inset:0;
            background: linear-gradient(135deg,rgba(255,255,255,0.15) 0%,transparent 60%);
            pointer-events:none;
        }
        #gacha-particles {
            position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:99999;
        }
        .g-particle {
            position:absolute; border-radius:50%;
            animation: gp-fly 1.2s ease-out forwards;
        }
        @keyframes gp-fly {
            0%   { transform: translate(-50%,-50%) scale(1); opacity:1; }
            100% { transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(0); opacity:0; }
        }
        #gacha-rarity-label {
            font-size: clamp(0.9rem,3vw,1.1rem); font-weight:900; letter-spacing:6px;
            text-transform:uppercase; margin-bottom:8px;
            text-shadow: 0 0 20px currentColor;
        }
        #gacha-name {
            font-size: clamp(1.4rem,5vw,1.9rem); font-weight:900; color:#fff;
            text-align:center; text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            line-height:1.2; margin-bottom:6px;
        }
        #gacha-desc {
            font-size: clamp(0.75rem,2.5vw,0.88rem); color:rgba(255,255,255,0.75);
            text-align:center; line-height:1.5;
        }
        #gacha-icon {
            font-size: clamp(3.5rem,12vw,5rem); margin-bottom:12px;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.5));
            animation: icon-float 2s ease-in-out infinite;
        }
        @keyframes icon-float {
            0%,100% { transform:translateY(0); }
            50%      { transform:translateY(-10px); }
        }
        #gacha-duplicate-badge {
            position:absolute; top:16px; right:16px;
            background:rgba(0,0,0,0.6); color:#fde047; font-size:0.75rem;
            font-weight:bold; padding:4px 10px; border-radius:20px;
            border:1px solid #fde047; display:none;
        }
        #gacha-tap-hint {
            position:absolute; bottom:12px; left:0; right:0; text-align:center;
            color:rgba(255,255,255,0.4); font-size:0.75rem; letter-spacing:2px;
            animation: hint-blink 1.2s infinite;
        }
        @keyframes hint-blink { 50%{opacity:0.1;} }
        #gacha-bg-glow {
            position:absolute; inset:-20px; border-radius:30px;
            background: radial-gradient(circle, var(--gc,#3b82f6) 0%, transparent 70%);
            opacity:0; animation: glow-pulse 1.5s ease-in-out infinite;
            pointer-events:none;
        }
        @keyframes glow-pulse { 0%,100%{opacity:0.15;transform:scale(1);} 50%{opacity:0.4;transform:scale(1.05);} }

        /* ===== 战斗特效 ===== */
        .b-damage-float {
            position: fixed; pointer-events: none; z-index: 99990;
            font-family: 'Courier New', monospace; font-weight: 900;
            text-shadow: 0 0 8px currentColor, 2px 2px 0 rgba(0,0,0,0.8);
            animation: dmg-float 1.4s ease-out forwards;
        }
        @keyframes dmg-float {
            0%   { transform: translateY(0) scale(1); opacity: 1; }
            40%  { transform: translateY(-40px) scale(1.15); opacity: 1; }
            100% { transform: translateY(-100px) scale(0.7); opacity: 0; }
        }
        @keyframes b-shake {
            0%,100% { transform: translateX(0); }
            20% { transform: translateX(-8px) rotate(-1deg); }
            40% { transform: translateX(8px) rotate(1deg); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }
        @keyframes b-flash-red {
            0%,100% { background: rgba(0,0,0,0.6); }
            30% { background: rgba(239,68,68,0.35); }
        }
        @keyframes b-flash-crit {
            0%,100% { box-shadow: 0 0 15px rgba(0,0,0,0.8); }
            30% { box-shadow: 0 0 40px rgba(192,132,252,0.9), inset 0 0 20px rgba(192,132,252,0.3); }
        }
        @keyframes b-flash-heal {
            0%,100% { background: rgba(0,0,0,0.6); }
            30% { background: rgba(16,185,129,0.25); }
        }
        .b-hit { animation: b-shake 0.4s ease-out, b-flash-red 0.5s ease-out; }
        .b-crit { animation: b-shake 0.5s ease-out, b-flash-crit 0.6s ease-out; }
        .b-heal { animation: b-flash-heal 0.6s ease-out; }
        @keyframes b-enemy-atk {
            0%,100% { transform: translateX(0); }
            25% { transform: translateX(15px); }
            75% { transform: translateX(-5px); }
        }
        .b-enemy-atk { animation: b-enemy-atk 0.45s ease-out; }

        /* ===== 十连抽 ===== */
        #gacha10-overlay {
            display: none; position: fixed; inset: 0; z-index: 99997;
            background: #000; flex-direction: column;
            justify-content: center; align-items: center; gap: 16px;
        }
        #gacha10-overlay.show { display: flex; }
        #gacha10-grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 10px; width: min(860px, 96vw); padding: 0 10px;
        }
        .g10-card {
            aspect-ratio: 2/3; border-radius: 12px; position: relative;
            display: flex; flex-direction: column; justify-content: flex-end;
            align-items: center; padding: 10px 6px;
            overflow: hidden;
            transform: translateY(60px) scale(0.8); opacity: 0;
            transition: transform 0.45s cubic-bezier(0.34,1.56,0.64,1), opacity 0.35s ease;
        }
        .g10-card.revealed { transform: translateY(0) scale(1); opacity: 1; }
        .g10-card::before { content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(255,255,255,0.18) 0%,transparent 55%); pointer-events:none; border-radius:12px; }
        .g10-card-icon { font-size: clamp(1.4rem,3.5vw,2rem); margin-bottom:4px; filter:drop-shadow(0 0 8px rgba(255,255,255,0.5)); }
        .g10-card-rarity { font-size: clamp(0.5rem,1.2vw,0.65rem); font-weight:900; letter-spacing:3px; margin-bottom:3px; text-shadow:0 0 8px currentColor; }
        .g10-card-name { font-size: clamp(0.55rem,1.4vw,0.78rem); font-weight:900; color:#fff; text-align:center; line-height:1.2; text-shadow:0 1px 6px rgba(0,0,0,0.9); }
        .g10-dup-badge { position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.6); color:#fde047; font-size:0.48rem; font-weight:bold; padding:2px 5px; border-radius:8px; border:1px solid #fde047; }
        #gacha10-close { background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.3); padding:10px 36px; border-radius:30px; cursor:pointer; font-size:1rem; font-weight:bold; transition:background 0.2s; letter-spacing:2px; }
        #gacha10-close:hover { background:rgba(255,255,255,0.2); }
        #gacha10-summary { color:rgba(255,255,255,0.7); font-size:0.85rem; letter-spacing:1px; opacity:0; transition:opacity 0.5s; text-align:center; }
        #gacha10-summary.show { opacity:1; }

        @media (max-width: 900px) {
            body { padding: 6px; }

            /* 校长三栏 → 单栏 */
            .container { grid-template-columns: 1fr !important; gap: 8px; }
            .header-banner h1 { font-size: 1.3rem; letter-spacing: 1px; }
            .header-banner { padding: 10px; }

            /* 系统栏换行压缩 */
            .sys-bar { padding: 8px 10px; gap: 6px; }
            .sys-btn { padding: 5px 8px; font-size: 0.75rem; }
            .school-badge { font-size: 0.8rem; padding: 4px 8px; }

            /* 资源格子两列保留 */
            .res-grid { grid-template-columns: 1fr 1fr; }

            /* 按钮字体缩小 */
            .btn { padding: 8px; font-size: 0.85rem; }
            .btn-desc { font-size: 0.65rem; }
            .btn-main { font-size: 1rem; padding: 12px; }

            /* 模态框全屏 */
            .fs-modal { padding: 8px; }
            .fs-content { max-height: 95vh; border-radius: 8px; }
            .fs-body { padding: 12px; }
            .fs-header { padding: 10px 14px; font-size: 1rem; }
            .grid-sys { grid-template-columns: 1fr; }

            /* 地图格子缩小 */
            .map-cell { height: 55px; font-size: 0.7rem; }
            .map-grid { gap: 5px; padding: 8px; }

            /* 树节点 */
            .tree-node { width: 160px; font-size: 0.8rem; padding: 8px; }

            /* 学生三栏 → 单栏堆叠 */
            .stu-grid { grid-template-columns: 1fr !important; gap: 6px; }
            #student-container { padding: 8px; }

            /* 学生行动2列保留，缩字体 */
            .stu-act-btn { font-size: 0.65rem; padding: 4px 5px; }
            .stu-act-btn b { font-size: 0.63rem; }
            .stu-act-btn .btn-sub { font-size: 0.55rem; }
            .stu-act-grid { max-height: 300px; }

            /* 动作区取消 max-width 限制 */
            #student-container > .stu-grid > div:nth-child(2) { max-width: 100% !important; }

            /* 恋爱区两列 */
            #stu-crush-container { grid-template-columns: 1fr 1fr !important; }

            /* 弹窗 */
            .modal-content { padding: 15px; width: 95%; }

            /* 黑板字体缩小 */
            .blackboard { padding: 10px; }
            .stat-label { width: 70px; font-size: 0.8rem; }
            .stat-val { font-size: 0.95rem; }

            /* 联考战斗 - 全面重排 */
            .battle-ui { height: auto !important; max-height: none !important; overflow-y: auto !important; padding: 8px !important; }
            .b-arena { height: auto !important; flex-direction: column !important; gap: 8px; padding: 8px !important; }
            .b-entity { width: 100% !important; box-sizing: border-box; }
            .b-actions { grid-template-columns: 1fr !important; height: auto !important; min-height: 0 !important; }
            .b-cats { flex-direction: row !important; flex-wrap: wrap !important; gap: 4px !important; overflow: visible !important; padding: 0 !important; }
            .b-cat-btn { font-size: 0.7rem !important; padding: 5px 7px !important; }
            .b-skills { grid-template-columns: repeat(2, 1fr) !important; max-height: 200px; overflow-y: auto; }
            .b-header { font-size: 0.75rem !important; flex-wrap: wrap; gap: 4px; }
            #modal-battle .fs-content { height: auto !important; max-height: 95vh; overflow-y: auto; }

            /* 课表 */
            #weekly-timetable { font-size: 0.6rem !important; }

            /* 地图弹窗 */
            .fs-body[style*="grid"] { display: flex !important; flex-direction: column !important; }
            .map-fs-body { display: flex !important; flex-direction: column !important; }
            .stu-action-col { max-width: 100% !important; }
        }

        @media (max-width: 480px) {
            .header-banner h1 { font-size: 1.1rem; }
            .sys-bar { flex-direction: column; align-items: flex-start; }
            .res-grid { grid-template-columns: 1fr 1fr; gap: 5px; }
            .res-box { padding: 7px; font-size: 0.8rem; }
            .res-box span { font-size: 1rem; }
            .tree-node { width: 140px; }
            .stu-grid { grid-template-columns: 1fr !important; }
            #stu-crush-container { grid-template-columns: 1fr !important; }
            .map-cell { height: 45px; font-size: 0.6rem; }
        }
    </style>
</head>
<body>

<div id="toast-container"></div>

<!-- 背景音乐 -->
<audio id="bgm" loop style="display:none"></audio>

<!-- ================= 难度选择启动页（独立于modal系统）================= -->
<div id="diff-screen" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:linear-gradient(135deg,#0f172a,#1e293b); z-index:99999; justify-content:center; align-items:center; flex-direction:column;">
    <div style="background:rgba(255,255,255,0.97); border-radius:16px; padding:40px 50px; text-align:center; max-width:520px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.5);">
        <div style="font-size:3rem; margin-bottom:10px;">🏫</div>
        <h1 style="margin:0 0 8px 0; color:#1e293b; font-size:1.8rem;">孔子学校</h1>
        <p style="color:#64748b; margin:0 0 30px 0; font-size:0.95rem;">请选择游戏难度开始你的办学霸业</p>
        <div style="display:flex; flex-direction:column; gap:12px;">
            <button onclick="startGame(0)" style="padding:18px 24px; background:linear-gradient(135deg,#10b981,#059669); color:white; border:none; border-radius:10px; font-size:1.1rem; font-weight:bold; cursor:pointer; transition:0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                🌟 简单模式<br><span style="font-size:0.8rem; font-weight:normal; opacity:0.9;">初始资金500万 · 压力×0.4 · 花费×0.6</span>
            </button>
            <button onclick="startGame(1)" style="padding:18px 24px; background:linear-gradient(135deg,#2563eb,#1d4ed8); color:white; border:none; border-radius:10px; font-size:1.1rem; font-weight:bold; cursor:pointer; transition:0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                ⚔️ 正常模式<br><span style="font-size:0.8rem; font-weight:normal; opacity:0.9;">初始资金100万 · 标准模拟法则</span>
            </button>
            <button onclick="startGame(2)" style="padding:18px 24px; background:linear-gradient(135deg,#dc2626,#b91c1c); color:white; border:none; border-radius:10px; font-size:1.1rem; font-weight:bold; cursor:pointer; transition:0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
                💀 困难模式<br><span style="font-size:0.8rem; font-weight:normal; opacity:0.9;">初始资金50万 · 压力×1.2 · 花费×1.5</span>
            </button>
        </div>
    </div>
</div>

<!-- ================= 校长模式 ================= -->
<div class="container" id="principal-container">
    <div class="header-banner">
        <div style="position:relative;z-index:1;">
            <h1 id="hdr-title" style="margin:0;font-size:1.9rem;letter-spacing:6px;color:var(--primary);text-shadow:0 0 20px var(--primary),0 0 40px rgba(0,200,255,0.4);font-family:monospace;font-weight:900;">孔子学校 V1.0a · 彼岸灯火</h1>
            <p style="margin:4px 0 0;font-size:0.72rem;opacity:0.55;letter-spacing:3px;color:var(--primary);font-family:monospace;">BY CHANSONTECH · 大千世界，皆在局中 <span class="sys-cursor">█</span></p>
        </div>
        <div class="hdr-corner" id="hdr-clock" style="position:absolute;top:8px;right:20px;font-size:0.62rem;color:rgba(0,200,255,0.45);letter-spacing:2px;font-family:monospace;text-align:right;line-height:1.7;">
            <div>SYS::ONLINE ■■■■■ 100%</div>
            <div id="real-clock" style="color:rgba(0,255,231,0.4);"></div>
        </div>
    </div>

    <div class="sys-bar">
        <div style="display:flex; align-items:center; gap: 10px;">
            <span class="school-badge" id="ui-level-name">🏆 乡镇中学</span>
            <button class="sys-btn" onclick="checkUpgrade()">🎖️ 申请评级</button>
            <button class="sys-btn btn-auto" id="btn-auto" onclick="toggleAuto()">🤖 自动推演</button>
            <span style="font-size:0.7rem;color:rgba(255,51,85,0.7);font-family:monospace;letter-spacing:1px;">⚔️ <span id="ui-examPoints" style="color:var(--danger);font-weight:900;">0</span> <span style="opacity:0.5;">PTS</span></span>
        </div>
        <div style="display:flex; gap: 7px; align-items:center;">
            <button class="sys-btn" style="background:rgba(191,95,255,0.12);border-color:rgba(191,95,255,0.4);color:#bf5fff;" onclick="switchMode('student')">👨‍🎓 学生深潜视角</button>
            <span id="ui-diff-badge" style="font-size:0.72rem;background:rgba(0,200,255,0.08);color:rgba(0,200,255,0.6);padding:3px 8px;border-radius:2px;font-weight:bold;border:1px solid rgba(0,200,255,0.2);font-family:monospace;">难度: 正常</span>
            <button class="sys-btn" style="border-color:rgba(0,200,255,0.3);color:#60c8ff;" onclick="showSocialWindow()">🤝 社会关系</button>
            <button class="sys-btn" style="border-color:rgba(0,255,157,0.3);color:#00ff9d;" onclick="showMonthlyTargets()">🎯 月度目标</button>
            <button class="sys-btn" style="border-color:rgba(255,229,102,0.3);color:#ffe566;" onclick="showOlympiadSystem()">🏆 学科竞赛</button>
            <button class="sys-btn" onclick="hardReset()" style="color:var(--danger);border-color:rgba(255,51,85,0.3);">🔄 抹除存档</button>
        </div>
    </div>

    <div class="panel">
        <div class="panel-corner-br"></div>
        <h2 class="panel-title">📊 财务与行政中枢</h2>
        <div class="res-grid">
            <div class="res-box" style="border-color:rgba(0,255,157,0.2);">
                <div style="font-size:0.6rem;color:rgba(0,255,157,0.5);letter-spacing:2px;margin-bottom:2px;">FUNDS</div>
                总资金(万) <span id="ui-funds" style="color:var(--success);text-shadow:0 0 10px rgba(0,255,157,0.5);">100</span>
                <div class="res-sub" id="ui-salary" style="color:rgba(255,51,85,0.5);">常耗:-0 专家:-0</div>
            </div>
            <div class="res-box" style="border-color:rgba(0,200,255,0.2);">
                <div style="font-size:0.6rem;color:rgba(0,200,255,0.5);letter-spacing:2px;margin-bottom:2px;">STUDENTS</div>
                在校生规模 <span id="ui-students" style="color:var(--primary);text-shadow:0 0 10px rgba(0,200,255,0.5);">300</span>
            </div>
            <div class="res-box" style="border-color:rgba(255,170,0,0.2);">
                <div style="font-size:0.6rem;color:rgba(255,170,0,0.5);letter-spacing:2px;margin-bottom:2px;">REPUTATION</div>
                社会声誉 <span id="ui-rep" style="color:var(--warning);text-shadow:0 0 10px rgba(255,170,0,0.5);">100</span>
            </div>
            <div class="res-box" style="border-color:rgba(191,95,255,0.2);">
                <div style="font-size:0.6rem;color:rgba(191,95,255,0.5);letter-spacing:2px;margin-bottom:2px;">ACTION_PT</div>
                行政 AP <span style="color:var(--purple);text-shadow:0 0 10px rgba(191,95,255,0.5);"><span id="ui-ap">10</span>/<span id="ui-maxap">20</span></span>
            </div>
        </div>

        <h2 class="panel-title" style="margin-top: 5px;">🧬 生源六维 (影响全校战力)</h2>
        <div class="blackboard">
            <div class="stat-row"><div class="stat-label">📚 学业(攻击)</div><div class="bar-bg"><div id="bar-grade" class="bar-fill" style="background:linear-gradient(90deg, #3b82f6, #60a5fa);box-shadow:0 0 6px rgba(96,165,250,0.6);"></div></div><div class="stat-val" id="val-grade">40</div></div>
            <div class="stat-row" style="margin-bottom:0;"><div class="stat-label">🤯 压力(熵增)</div><div class="bar-bg"><div id="bar-stress" class="bar-fill" style="background:linear-gradient(90deg, #ef4444, #f87171);box-shadow:0 0 6px rgba(248,113,113,0.6);"></div></div><div class="stat-val" id="val-stress">20</div></div>
            <div class="stress-warning" id="warn-stress">⚠️ 警告：思维熵增濒临崩溃极限！</div>
            <div class="stat-row" style="margin-top:10px;"><div class="stat-label">🛡️ 纪律(防御)</div><div class="bar-bg"><div id="bar-disc" class="bar-fill" style="background:linear-gradient(90deg, #f59e0b, #fbbf24);box-shadow:0 0 6px rgba(251,191,36,0.6);"></div></div><div class="stat-val" id="val-disc">60</div></div>
            <div class="stat-row"><div class="stat-label">🏃‍♂️ 体质(血量)</div><div class="bar-bg"><div id="bar-fit" class="bar-fill" style="background:linear-gradient(90deg, #10b981, #34d399);box-shadow:0 0 6px rgba(52,211,153,0.6);"></div></div><div class="stat-val" id="val-fit">50</div></div>
            <div class="stat-row"><div class="stat-label">🎨 艺术(暴击)</div><div class="bar-bg"><div id="bar-art" class="bar-fill" style="background:linear-gradient(90deg, #8b5cf6, #a78bfa);box-shadow:0 0 6px rgba(167,139,250,0.6);"></div></div><div class="stat-val" id="val-art">30</div></div>
        </div>
    </div>

    <div class="panel">
        <div style="text-align: center; margin-bottom: 12px; background:rgba(0,200,255,0.04); padding: 10px; border-radius: 2px; border: 1px solid rgba(0,200,255,0.15); position:relative; overflow:hidden;">
            <div style="font-size:0.6rem; color:rgba(0,200,255,0.4); letter-spacing:3px; margin-bottom:4px; font-family:monospace;">── TIMELINE NODE ──</div>
            <div id="ui-date" style="font-size: 1.5rem; font-weight: 900; color: var(--neon-cyan); letter-spacing: 3px; font-family:monospace; text-shadow: 0 0 15px rgba(0,255,231,0.6);">2018年 9月</div>
        </div>
        <button class="btn-main" id="btn-advance" onclick="advanceMonth()">⏳ 推进一个月 (触发事件/联考/收学费)</button>

        <h2 class="panel-title">🧠 行政中枢</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom:15px;">
            <button class="btn btn-c-green" onclick="openModal('modal-map')">🗺️ 校园基建扩建<span class="btn-desc">修建建筑，打造你的独特校园</span></button>
            <button class="btn btn-c-orange" onclick="if(!game||!game.map)return showToast('请先选择难度！');openModal('modal-shop');renderShop('infra')">🛒 特供商店<span class="btn-desc">蓝图·道具·政策速通</span></button>
            <button class="btn btn-c-pink" onclick="openModal('modal-rnd')">🔭 教学研发中心<span class="btn-desc">卷轴·组合技·教学装备</span></button>
            <button class="btn btn-c-blue" onclick="openModal('modal-experts')">👨‍🏫 寻访顶级名师<span class="btn-desc">40位专家+强力战技</span></button>
            <button class="btn btn-c-purple" onclick="openScheduleModal()">📅 师资与主科排课<span class="btn-desc">优化排课</span></button>
            <button class="btn btn-c-yellow" onclick="openModal('modal-policy')">🏫 校策科技树<span class="btn-desc">教研点: <span id="ui-eduPoints" style="font-weight:bold;color:var(--danger)">0</span></span></button>
        </div>

        <h2 class="panel-title">🎯 战术与大势</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <button class="btn btn-c-cyan" onclick="organizeExam()">📝 举行模拟考试<span class="btn-desc">耗AP:3, ￥<span id="cost-exam" class="c-val">2</span>万 | 六档分析+教研点</span></button>
            <button class="btn btn-c-cyan" onclick="showGaokaoHistory()">📊 历年高考成绩<span class="btn-desc">查看历年成绩柱状图</span></button>
            <button class="btn btn-c-purple" id="btn-final-rating" onclick="showFinalRating('principal')" style="display:none;">🏁 查看当前结局<span class="btn-desc">评级·校友回访·终末诗</span></button>
            <button class="btn btn-c-blue" onclick="openModal('modal-branches')">🌍 建立全球分校<span class="btn-desc">耗巨资建立分校</span></button>
            <button class="btn btn-c-orange" onclick="runAction('sponsor')">🤝 宴请拉赞助<span class="btn-desc">耗AP:4, 降声誉 | 得￥<span id="gain-spo" style="color:var(--success)">100</span>万</span></button>
            <button class="btn btn-c-yellow" onclick="openModal('modal-achieve')">🏆 荣誉与校友录<span class="btn-desc">成就解锁与名人堂</span></button>
        </div>
    </div>

    <div class="panel" style="display: flex; flex-direction: column;">
        <h2 class="panel-title">📨 学生信箱</h2>
        <div id="student-comments-box" class="mailbox-container"></div>

        <h2 class="panel-title">📜 纪事本末</h2>
        <div class="log-box" id="log-box"></div>
    </div>
</div>

<!-- ================= 学生模式 ================= -->
<div id="student-container">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 3px solid var(--purple); padding-bottom:10px; margin-bottom:20px;">
        <h1 style="margin:0; color:var(--purple);">👨‍🎓 学生视角</h1>
        <div style="display:flex; align-items:center; gap:15px;">
            <span class="rebirth-points">☯️ 轮回点数: <span id="stu-ui-rp">0</span></span>
            <button class="sys-btn" style="background:linear-gradient(135deg,#1e1b4b,#312e81); color:#a5b4fc; border:none;" onclick="showStuJournal()">📓 内心日记</button>
            <button class="sys-btn" onclick="switchMode('principal')">🔙 放弃学业，返回校长模式</button>
        </div>
    </div>

    <div id="stu-setup" style="text-align:center; padding: 20px;">
        <h2>第一步：你的原生家庭决定了起跑线</h2>
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top:20px;" id="stu-family-grid"></div>
        
        <h2 style="margin-top:40px;">第二步：消耗轮回点购买前世遗泽</h2>
        <div style="display:flex; justify-content:center; gap:15px; margin-top:15px;" id="stu-talent-grid">
            <button class="btn" onclick="buyTalent('genius', 20, this)">🧠 过目不忘 (20点)<br><span class="btn-desc">每次学习额外+3学业</span></button>
            <button class="btn" onclick="buyTalent('rich', 15, this)">💰 隐形富豪 (15点)<br><span class="btn-desc">开局自带￥1000巨额资金</span></button>
            <button class="btn" onclick="buyTalent('charm', 10, this)">✨ 绝世容颜 (10点)<br><span class="btn-desc">开局魅力+40，恋爱易如反掌</span></button>
        </div>
        <button class="btn-main" style="width:300px; margin-top:30px; font-size:1.5rem;" onclick="startStudentGameplay()">✨ 降生，开启校园生活</button>
    </div>

    <div id="stu-gameplay" style="display:none;" class="stu-grid">
        <!-- 左侧状态 -->
        <div>
            <div class="stu-stat-box">
                <h3 style="margin-top:0; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;">📊 个人状态面板</h3>
                <div>📆 进度: 高<span id="stu-ui-year">一</span> <span id="stu-ui-month">上</span>学期 (<span id="stu-ui-turn">1</span>/36)</div>
                <div style="font-size:0.8rem; color:#cbd5e1; margin-top:5px;">👨‍👩‍👦 家庭背景: <span id="stu-ui-family">加载中</span></div>
                <div style="font-size:0.8rem; color:#fde047; margin-top:5px; font-weight:bold;">💵 零花钱: ￥<span id="stu-val-money">0</span></div>
                
                <!-- 精力条 -->
                <div style="margin-top:10px; background:rgba(0,0,0,0.5); border-radius:4px; padding:2px; border:1px solid #4ade80;">
                    <div style="font-size:0.7rem; color:#4ade80; text-align:center;">⚡ 本月精力 <span id="stu-val-energy">100</span>/100</div>
                    <div style="height:6px; background:#4ade80; width:100%; transition:0.3s;" id="stu-bar-energy"></div>
                </div>

                <div style="margin-top:10px;">
                    <div style="display:flex; justify-content:space-between;"><span>📚 学业掌控</span> <span id="stu-val-grade" style="color:var(--chalk-yellow);font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>🤯 精神压力</span> <span id="stu-val-stress" style="color:#fca5a5;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>🏃‍♂️ 身体素质</span> <span id="stu-val-fit" style="color:#a7f3d0;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between;"><span>🎨 个人魅力</span> <span id="stu-val-art" style="color:#c4b5fd;font-weight:bold;">0</span></div>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; border-top:1px dashed #475569; padding-top:5px;">
                        <span style="color:#fbbf24">🥇 奥赛: <span id="stu-val-oly">0</span>%</span>
                        <span style="color:#60a5fa" id="stu-lover-tag">💔 单身狗</span>
                    </div>
                </div>
            </div>

            <div class="exam-board">
                <h3 style="margin:0 0 5px 0;">上月大型联考成绩</h3>
                <div style="font-size:3rem; font-weight:900; line-height:1;" id="stu-exam-score">--</div>
                <div style="font-size:0.9rem; margin-top:5px; opacity:0.9;" id="stu-exam-rank">全校排名: 尚未进行</div>
            </div>

            <button class="btn-main" style="background:#475569; margin-top:10px;" onclick="endStudentMonth()">🛌 睡觉 (结束本月)</button>
        </div>

        <!-- 中间动作区 -->
        <div class="stu-action-col" style="display:flex; flex-direction:column; height:100%;">
            <h2 style="margin-top:0;">🎯 本月行动 (消耗精力)</h2>
            <div class="stu-act-grid" style="overflow-y:auto; max-height:480px;">
                <button class="stu-act-btn" onclick="stuAct('hard_study')"><span class="stu-icon">✍️</span><div><b>狂刷真题熬夜</b><span class="btn-sub">耗能:40|学业++,大增压</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('study')"><span class="stu-icon">📖</span><div><b>认真听讲</b><span class="btn-sub">耗能:25|学业+,压力↑</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('olympiad')"><span class="stu-icon">🔬</span><div><b>死磕奥赛</b><span class="btn-sub">耗能:50|满100保送</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('mun')"><span class="stu-icon">🌍</span><div><b>模拟联合国</b><span class="btn-sub">耗能:50|学业+魅力++</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('work')"><span class="stu-icon">🍔</span><div><b>快餐店打工</b><span class="btn-sub">耗能:30|赚钱耗体质</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('scalper')"><span class="stu-icon">🎫</span><div><b>倒卖周边</b><span class="btn-sub">耗能:30|高风险赚钱</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('esport')"><span class="stu-icon">🎮</span><div><b>电竞联赛</b><span class="btn-sub">耗能:40|赢了爆赚减压</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('show')"><span class="stu-icon">🎤</span><div><b>才艺大赛</b><span class="btn-sub">耗能:40|需高魅力</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('sport')"><span class="stu-icon">🏀</span><div><b>社团打球</b><span class="btn-sub">耗能:25|体质++魅力+</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('book')"><span class="stu-icon">📚</span><div><b>图书馆闲书</b><span class="btn-sub">耗能:20|魅力++微减压</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('rooftop')"><span class="stu-icon">🌆</span><div><b>天台发呆</b><span class="btn-sub">耗能:20|压力小幅↓</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('sick')"><span class="stu-icon">🏥</span><div><b>装病躺平</b><span class="btn-sub">耗能:10|学业--减压</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('diary')"><span class="stu-icon">📓</span><div><b>写日记</b><span class="btn-sub">耗能:10|减压解锁结局</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('volunteer')"><span class="stu-icon">🤝</span><div><b>志愿服务</b><span class="btn-sub">耗能:25|综测魅力++</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('club_drama')"><span class="stu-icon">🎭</span><div><b>话剧社排练</b><span class="btn-sub">耗能:35|魅力+++大减压</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('tutor')"><span class="stu-icon">👨‍🏫</span><div><b>给学弟补课</b><span class="btn-sub">耗能:30|赚钱+学业</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('fight')"><span class="stu-icon">🥊</span><div><b>和隔壁打架</b><span class="btn-sub">耗能:20|高风险纪律罚</span></div></button>
                <button class="stu-act-btn" onclick="stuAct('confession_prep')"><span class="stu-icon">💌</span><div><b>策划表白</b><span class="btn-sub">耗能:40|提升攻略率</span></div></button>
            </div><!-- close stu-act-grid -->
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:8px; height: 100px; overflow-y:auto; font-size:0.78rem; margin-top:8px;" id="stu-log-box"></div>
        </div><!-- close middle column -->

        <!-- 右侧社交区 -->
        <div style="display:flex; flex-direction:column; overflow:hidden;">
            <div style="background:#fff; border:2px solid #fbcfe8; border-radius:8px; padding:15px; margin-bottom:15px; display:flex; flex-direction:column; flex:1; overflow-y:auto;">
                <h3 style="margin:0 0 10px 0; color:#db2777;">💌 校园心跳回忆</h3>
                <p style="font-size:0.7rem; color:#94a3b8; margin:0 0 10px 0;">不同的政策会极大影响攻略难度。请选择你的羁绊对象：</p>
                <div id="stu-crush-container" style="display:grid; grid-template-columns:1fr 1fr; gap:6px;"></div>
            </div>

            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:15px; flex:0 0 auto;">
                <h3 style="margin:0 0 10px 0;">👬 同桌与死党羁绊</h3>
                <div id="stu-friends-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- ================= 模态框组 ================= -->
<div id="modal-map" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>🗺️ 校园基建规划与特级升级</div><button class="fs-close" onclick="closeModal('modal-map')">×</button></div>
        <div class="fs-body map-fs-body" style="display:grid; grid-template-columns: 2fr 1fr; gap: 20px;">
            <div>
                <div class="map-grid" id="map-grid"></div>
                <div style="margin-top:12px;">
                    <div style="font-weight:bold;color:#1e293b;margin-bottom:6px;">✨ 激活中的相邻加成</div>
                    <div id="adjacency-panel" style="display:flex;flex-direction:column;gap:5px;"></div>
                </div>
            </div>
            <div style="background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:15px; overflow-y:auto;">
                <h3 style="margin-top:0; border-bottom:2px solid #e2e8f0; padding-bottom:8px;">🛠️ 工程图纸</h3>
                <p id="map-hint" style="color:var(--danger); font-size:0.9rem;">请先在左侧点选一块空地或已建建筑！</p>
                <div id="fac-list" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </div>
    </div>
</div>

<div id="modal-experts" class="fs-modal">
    <div class="fs-content" style="max-width:1100px;">
        <div class="fs-header"><div>👨‍🏫 寻访系统 (40位顶级名师/解锁战技)</div><button class="fs-close" onclick="closeModal('modal-experts')">×</button></div>
        <div class="fs-body">
            <div style="text-align:center; margin-bottom:20px;">
                <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap; align-items:center;">
                    <button class="btn-main" style="width:auto; padding:15px 40px; font-size:1.5rem;" onclick="gachaExpert()">🎲 支付 ￥50万 寻访专家</button>
                    <button class="btn-main" style="width:auto; padding:15px 40px; font-size:1.5rem; background:linear-gradient(135deg,#7c3aed,#4f46e5);" onclick="gachaExpert10()">✨ 十连寻访 ￥450万 <span style="font-size:0.85rem;opacity:0.85;">（九折优惠）</span></button>
                </div>
                <p style="color:#ef4444; font-size:0.9rem; font-weight:bold;">⚠️ 注意：越强力的专家，每月的薪资维护费越高！小心破产！</p>
            </div>
            <div class="grid-sys" id="expert-container"></div>
        </div>
    </div>
</div>

<div id="modal-branches" class="fs-modal">
    <div class="fs-content" style="max-width:800px;">
        <div class="fs-header"><div>🌍 全球分校网络 (提供被动加成与战斗属性)</div><button class="fs-close" onclick="closeModal('modal-branches')">×</button></div>
        <div class="fs-body">
            <p style="color:#64748b; margin-bottom:20px;">建立分校需要巨额资金，但能提供强大的被动光环，并在联考战争中为您提供额外的属性加成。</p>
            <div id="branch-container" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"></div>
        </div>
    </div>
</div>

<div id="modal-schedule" class="fs-modal">
    <div class="fs-content" style="max-width: 600px; height:auto;">
        <div class="fs-header"><div>📅 师资调度与课表制定</div><button class="fs-close" onclick="closeModal('modal-schedule')">×</button></div>
        <div class="fs-body">
            <div style="background:#fee2e2; padding:10px; border-radius:6px; margin-bottom:15px; font-size:0.85rem; color:#991b1b; border:1px solid #fca5a5;" id="sch-warn-box"><b>⚠️ 危险警告：</b>主科排课数若超过 <b>25节</b>，产生的思维熵增将呈<b>指数级爆炸</b>！</div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn" onclick="upgradeTeacher('main')" style="flex:1">主科组升级<br><span id="tch-main" style="color:var(--primary); font-size:1.1rem;">实习</span></button>
                <button class="btn" onclick="upgradeTeacher('minor')" style="flex:1">副科组升级<br><span id="tch-minor" style="color:var(--primary); font-size:1.1rem;">实习</span></button>
                <button class="btn" onclick="upgradeTeacher('spec')" style="flex:1">素质组升级<br><span id="tch-spec" style="color:var(--primary); font-size:1.1rem;">实习</span></button>
            </div>
            <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; display:flex; flex-direction:column; gap:15px;">
                <div><b>📚 主科课时 (高压/高攻)</b> <span id="lbl-main-hr" style="color:var(--danger); font-weight:bold;">20节</span><input type="range" id="range-main" min="0" max="40" value="20" style="width:100%;pointer-events:none;opacity:0.7;" tabindex="-1"></div>
                <div><b>🔬 副科课时 (中压/防守)</b> <span id="lbl-minor-hr" style="color:var(--primary); font-weight:bold;">15节</span><input type="range" id="range-minor" min="0" max="40" value="15" style="width:100%;pointer-events:none;opacity:0.7;" tabindex="-1"></div>
                <div><b>🎨 素质课时 (降压/暴击)</b> <span id="lbl-spec-hr" style="color:var(--success); font-weight:bold;">5节</span><input type="range" id="range-spec" min="0" max="40" value="5" style="width:100%;pointer-events:none;opacity:0.7;" tabindex="-1"></div>
                <div style="text-align:right; font-size:0.9rem; font-weight:bold;">当前周课时总量: <span id="sch-total-hr" style="color:var(--primary)">40</span>/60</div>
            </div>
            <!-- 周课表可视化 -->
            <div style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:15px; margin-top:10px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <h3 style="margin:0;font-size:1rem;">📋 本周课表 (点击格子手动调整)</h3>
                    <button class="btn" style="padding:4px 10px;font-size:0.8rem;" onclick="randomizeSchedule()">🎲 随机排课</button>
                </div>
                <div id="weekly-timetable" style="display:grid;grid-template-columns:60px repeat(5,1fr);gap:3px;font-size:0.75rem;"></div>
                <div style="margin-top:8px;display:flex;gap:10px;font-size:0.72rem;">
                    <span style="background:#fecaca;padding:2px 6px;border-radius:3px;">📚 主科</span>
                    <span style="background:#bfdbfe;padding:2px 6px;border-radius:3px;">🔬 副科</span>
                    <span style="background:#bbf7d0;padding:2px 6px;border-radius:3px;">🎨 素质</span>
                    <span style="background:#f1f5f9;padding:2px 6px;border-radius:3px;">— 空课</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-policy" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>🏫 国家校策科技树 (四大流派 40项节点)</div><button class="fs-close" onclick="closeModal('modal-policy')">×</button></div>
        <div class="fs-body">
            <div style="text-align:center; margin-bottom:20px; font-weight:bold;">
                <span style="color:var(--danger); margin-right:15px;">🟥 极限应试线</span>
                <span style="color:var(--warning); margin-right:15px;">🟨 铁腕纪律线</span>
                <span style="color:#fbbf24; margin-right:15px;">🟤 资本运作线</span>
                <span style="color:var(--success);">🟩 素质开放线</span>
            </div>
            <div id="policy-container" style="display:flex; flex-direction:column; align-items:center;"></div>
        </div>
    </div>
</div>

<div id="modal-achieve" class="fs-modal">
    <div class="fs-content">
        <div class="fs-header"><div>🏆 荣誉史册与杰出校友</div><button class="fs-close" onclick="closeModal('modal-achieve')">×</button></div>
        <div class="fs-body">
            <h3 style="margin-top:0; border-bottom:2px solid #cbd5e1; padding-bottom:5px;">🎓 知名校友录 (学生模式通关留名)</h3>
            <div id="alumni-container" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:25px;"></div>
            <h3 style="border-bottom:2px solid #cbd5e1; padding-bottom:5px;">🏆 终极成就 (25项)</h3>
            <div class="grid-sys" id="achieve-container"></div>
        </div>
    </div>
</div>

<!-- ================= 史诗级学术战争 PVE UI ================= -->
<div id="modal-battle" class="fs-modal" style="background: rgba(0,0,0,0.95); z-index: 6000;">
    <div class="fs-content" style="max-width: 1000px; background: transparent; box-shadow: none; border: 1px solid #3f6212; height:auto;">
        <div class="battle-ui" id="b-main" style="display:none;">
            <div id="b-screen-flash"></div>
            <div class="b-header">
                <div>[ACADEMIC_WARFARE_OS_v2.0]</div>
                <div style="color:#bef264">>>> ROUND: <span id="b-turn-ui">1</span> / <span id="b-phase-ui" style="color:#fde047">NORMAL_PHASE</span> <<<</div>
            </div>
            
            <div class="b-arena">
                <div class="b-weather" id="b-weather-ui">⛅ 天气：晴朗</div>
                <!-- 玩家阵营 -->
                <div class="b-entity" id="b-player-card">
                    <div class="b-name" style="color:#93c5fd">> 玩家本校阵营_</div>
                    <div class="b-hp-bg"><div class="b-hp-fill" id="bp-hp-bar"></div><div class="b-hp-txt" id="bp-hp-txt">100 / 100</div></div>
                    <div class="b-stat-grid">
                        <div>思维强度: <span id="bp-atk" style="color:#fff">0</span></div>
                        <div>逻辑严密: <span id="bp-def" style="color:#fff">0</span></div>
                        <div>灵感迸发: <span id="bp-crit" style="color:#fde047">0</span>%</div>
                        <div>学术AP: <span id="bp-ap" style="color:#fbbf24">0</span></div>
                    </div>
                    <div style="margin-top:5px; font-size:0.7rem;">思维熵增: <span id="bp-stress" style="color:#f59e0b">20</span> / 100 <span style="color:#64748b;font-size:0.65rem;">(≥70混乱·≥100崩溃)</span></div>
                    <div class="b-stress-bar"><div class="b-stress-fill" id="bp-stress-bar"></div></div>
                    <div class="b-buffs" id="bp-buffs">BUFFS: NONE</div>
                </div>

                <div style="font-size:3rem; font-weight:900; color:#ef4444; font-family:monospace;">VS</div>

                <!-- 敌方AI阵营 -->
                <div class="b-entity" id="b-enemy-card">
                    <div class="b-name" style="color:#fca5a5" id="be-name">> 敌方目标_</div>
                    <div class="b-hp-bg" style="border-color:#fca5a5"><div class="b-hp-fill" id="be-hp-bar" style="background:#dc2626"></div><div class="b-hp-txt" id="be-hp-txt">100 / 100</div></div>
                    <div class="b-stat-grid" style="color:#fca5a5">
                        <div>思维强度: <span id="be-atk" style="color:#fff">0</span></div>
                        <div>逻辑严密: <span id="be-def" style="color:#fff">0</span></div>
                        <div style="grid-column:1/-1; border-top:1px dashed #fca5a5; padding-top:4px; margin-top:2px;">
                            <b style="color:#fde047">BOSS特性:</b> <span id="be-skill-desc" style="color:#fff">未知</span>
                        </div>
                    </div>
                    <div style="margin-top:5px; font-size:0.7rem; color:#fca5a5">思维熵增: <span id="be-stress">0</span> / 100</div>
                    <div class="b-stress-bar" style="border-color:#fca5a5"><div class="b-stress-fill" id="be-stress-bar" style="background:#991b1b"></div></div>
                    <div class="b-buffs" id="be-buffs">BUFFS: NONE</div>
                </div>
            </div>

            <!-- 战斗播报终端 (高度自适应) -->
            <div class="b-log" id="b-log">
                <div class="b-log-inner">
                    <span class="sys">SYSTEM BOOT... ACADEMIC INTERFACE ENGAGED.</span><br>
                    <span class="sys">WAITING FOR EXAM TO START...</span>
                </div>
            </div>

            <div class="b-expert-select" id="b-expert-list"></div>

            <!-- 操作台 (固定底部) -->
            <div class="b-actions" id="b-action-panel">
                <div class="b-cats">
                    <button class="b-cat-btn" id="cat-atk" onclick="bShowCat('atk')">[1] 出题攻击系</button>
                    <button class="b-cat-btn" id="cat-def" onclick="bShowCat('def')">[2] 解题防守系</button>
                    <button class="b-cat-btn" id="cat-sup" onclick="bShowCat('sup')">[3] 学术研讨系</button>
                    <button class="b-cat-btn" id="cat-psy" onclick="bShowCat('psy')">[4] 心理干扰系</button>
                    <button class="b-cat-btn" id="cat-insp" onclick="bShowCat('insp')">[5] 灵感爆发系</button>
                    <button class="b-cat-btn" id="cat-ent" onclick="bShowCat('ent')" style="color:#f472b6;border-color:#be185d;">[6] 熵增控制系</button>
                    <button class="b-cat-btn" id="cat-sys" onclick="bShowCat('sys')">[7] 体系必杀系</button>
                    <button class="b-cat-btn" id="cat-combo" onclick="bShowCat('combo')" style="color:#fde047;border-color:#b45309;">[8] ✨组合技</button>
                    <button class="b-cat-btn" style="color:#94a3b8; border-color:#475569;" onclick="bRetreat()">[ESC] 结束战斗</button>
                </div>
                <div class="b-skills" id="b-skills-container">
                    <div style="color:#64748b; margin-top:20px; font-size:0.9rem;">PLEASE SELECT A DISCIPLINE MODULE FROM THE LEFT MENU...</div>
                </div>
            </div>
        </div>
        
        <!-- 战前选对手界面 -->
        <div id="b-prep" style="background:#1e293b; padding:30px; border-radius:12px; display:none; color:#f8fafc; border: 2px solid #334155; height:80vh; overflow-y:auto;">
            <h2 style="text-align:center; margin-top:0; color:#fde047;">> 全省大型联考目标选择 _</h2>
            <p style="text-align:center; color:#94a3b8; margin-bottom:25px;">请选择你要讨伐的顶级名校，胜利将获得巨额校级积分。</p>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px;">Tier 1: 乡镇与县级 (入门)</h3>
            <div class="grid-sys" id="b-rival-t1"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 2: 市级示范 (进阶)</h3>
            <div class="grid-sys" id="b-rival-t2"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 3: 省级名校 (困难)</h3>
            <div class="grid-sys" id="b-rival-t3"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 4: 全国百强 (噩梦)</h3>
            <div class="grid-sys" id="b-rival-t4"></div>
            <h3 style="border-bottom:1px solid #475569; padding-bottom:5px; margin-top:20px;">Tier 5: 传说级神域 (地狱)</h3>
            <div class="grid-sys" id="b-rival-t5"></div>
            
            <div style="text-align:center; margin-top:30px; margin-bottom:50px;">
                <button class="btn-main" style="background:#475569; width:auto; padding:10px 40px;" onclick="closeModal('modal-battle')">ABORT MISSION (撤退无惩罚)</button>
            </div>
        </div>
    </div>
</div>

<!-- 通用弹窗 -->
<div id="modal-overlay">
    <div class="modal-content">
        <h2 id="modal-title" style="margin-top:0; color:#1e293b;">标题</h2>
        <div id="modal-desc" style="line-height:1.6; margin-bottom:25px; font-size:1rem; color:#475569; text-align:left;">内容</div>
        <div id="modal-buttons" style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px;"></div>
    </div>
</div>

<div id="modal-shop" class="fs-modal">
    <div class="fs-content" style="max-width:900px;">
        <div class="fs-header"><div>🛒 特供商店</div><button class="fs-close" onclick="closeModal('modal-shop')">×</button></div>
        <div class="fs-body">
            <div style="display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap;" id="shop-tabs">
                <button class="btn" onclick="renderShop('infra')" style="background:#ecfdf5;border-color:#10b981;">🏗️ 基建类</button>
                <button class="btn" onclick="renderShop('teacher')" style="background:#eff6ff;border-color:#3b82f6;">👨‍🏫 师资类</button>
                <button class="btn" onclick="renderShop('policy')" style="background:#faf5ff;border-color:#a855f7;">📜 政策类</button>
                <button class="btn" onclick="renderShop('consume')" style="background:#fefce8;border-color:#eab308;">⚡ 消耗类</button>
                <button class="btn" onclick="renderShop('special')" style="background:#fff1f2;border-color:#f43f5e;">✨ 特殊类</button>
            </div>
            <div id="shop-content" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;"></div>
        </div>
    </div>
</div>

<div id="modal-rnd" class="fs-modal">
    <div class="fs-content" style="max-width:1000px;">
        <div class="fs-header"><div>🔬 装备研发中心</div><button class="fs-close" onclick="closeModal('modal-rnd')">×</button></div>
        <div class="fs-body">
            <div style="display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap;">
                <button class="btn" onclick="renderRnd('scroll')" style="background:#fff7ed;border-color:#f97316;">📜 战斗卷轴</button>
                <button class="btn" onclick="renderRnd('combo')" style="background:#fdf4ff;border-color:#c026d3;">⚡ 组合技研发</button>
                <button class="btn" onclick="renderRnd('equip')" style="background:#f0fdf4;border-color:#16a34a;">🎒 教学装备</button>
            </div>
            <div id="rnd-content"></div>
        </div>
    </div>
</div>

<!-- ===== 十连抽 overlay ===== -->
<div id="gacha10-overlay">
    <div id="gacha10-grid"></div>
    <div id="gacha10-summary"></div>
    <button id="gacha10-close" onclick="closeGacha10()">确认收下</button>
</div>

<!-- ===== 抽卡动画 overlay ===== -->
<div id="gacha-overlay" onclick="closeGachaCard()">
    <div id="gacha-particles"></div>
    <div id="gacha-card">
        <div id="gacha-bg-glow"></div>
        <div id="gacha-duplicate-badge">重复 · 已退款</div>
        <div id="gacha-icon">👨‍🏫</div>
        <div id="gacha-rarity-label">R</div>
        <div id="gacha-name">专家名称</div>
        <div id="gacha-desc">专家描述</div>
        <div id="gacha-tap-hint">· 点击关闭 ·</div>
    </div>
</div>

<!-- ===== 终末之诗 overlay ===== -->
<div id="end-poem-overlay">
    <div id="end-poem-close-btn" onclick="handlePoemClick()" style="display:none;position:fixed;bottom:40px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:rgba(255,255,255,0.7);padding:10px 32px;border-radius:30px;cursor:pointer;font-size:0.85rem;letter-spacing:3px;z-index:100000;">· 点击关闭 ·</div>
    <div id="end-poem-track">
        <div class="poem-spacer"></div>
        <div class="poem-hint">· 点击关闭 ·</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line dim">你好。</div>
        <div class="poem-spacer"></div>
        <div class="poem-line">如果你读到这里，说明你已经走完了这场游戏。</div>
        <div class="poem-line">谢谢你，愿意花几个小时，</div>
        <div class="poem-line">来体验这所虚拟的学校，来当一个虚拟的校长，</div>
        <div class="poem-line">来经历那些虚拟的胜利与失败、欢笑与泪水。</div>
        <div class="poem-spacer"></div>
        <div class="poem-line gold">但我想说的是，这个游戏里的一切，</div>
        <div class="poem-line gold">对很多人来说，从来都不是虚拟的。</div>
        <div class="poem-spacer"></div>
        <div class="poem-line">那些深夜刷题的疲惫，是真的。</div>
        <div class="poem-line">那些排名下降的恐惧，是真的。</div>
        <div class="poem-line">那些被老师和家长失望的眼神，是真的。</div>
        <div class="poem-line">那些因为一次考试失利而怀疑自己价值的感觉，是真的。</div>
        <div class="poem-line">那些在宿舍里偷偷哭过却不敢出声的夜晚，是真的。</div>
        <div class="poem-spacer"></div>
        <div class="poem-line italic">那些放弃了画画、放弃了音乐、放弃了写作、放弃了"没用"的热爱，是真的。</div>
        <div class="poem-line italic">那些被磨灭的好奇心、被压抑的表达欲、被标准化的思考方式，是真的。</div>
        <div class="poem-spacer"></div>
        <div class="poem-line dim">这个游戏里的每一个数字，背后都可能有无数个真实的夜晚。</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line">这个游戏里，你可以选择当严苛的校长，也可以选择当开明的校长。</div>
        <div class="poem-line">你可以让学生拼命刷题，也可以让他们自由成长。</div>
        <div class="poem-line">你可以追求升学率，也可以追求幸福感。</div>
        <div class="poem-line">你可以赢得所有的战斗，也可以输掉一些东西。</div>
        <div class="poem-spacer"></div>
        <div class="poem-line gold">但无论你怎么选，请记住：</div>
        <div class="poem-line big">那些数字背后，是一个个活生生的人。</div>
        <div class="poem-line">那些人，不是你棋盘上的棋子。</div>
        <div class="poem-line">他们有自己的恐惧，有自己的热爱，有自己的梦想——</div>
        <div class="poem-line">那些梦想，可能和你的期望不一样。</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line">如果你玩了这个游戏，请答应我一件事。</div>
        <div class="poem-spacer"></div>
        <div class="poem-line">下次，当你看到身边有学生低着头走过的时候，别只是看他的成绩。</div>
        <div class="poem-line gold">看看他的眼睛。那里可能有你没看见的东西。</div>
        <div class="poem-spacer"></div>
        <div class="poem-line">下次，当有人告诉你"我是为你好"的时候，</div>
        <div class="poem-line gold">问问自己：他们定义的"好"，真的是你想要的吗？</div>
        <div class="poem-spacer"></div>
        <div class="poem-line">下次，当你为了一个目标拼命奔跑的时候，停下来喘口气。</div>
        <div class="poem-line gold">问自己：如果这个目标永远达不到，我还值得被爱吗？</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>
        <div class="poem-line big">答案是：值得。你永远值得。</div>
        <div class="poem-spacer"></div>
        <div class="poem-line">不管你有没有考上好大学，不管你有没有找到好工作，</div>
        <div class="poem-line">不管你有没有活成别人期待的样子——</div>
        <div class="poem-line">你都值得被爱，被理解，被接纳。</div>
        <div class="poem-line gold">不是因为你优秀，而是因为你是你。</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line dim">这个游戏结束了。</div>
        <div class="poem-line dim">但那些坐在教室里的孩子，还在继续。</div>
        <div class="poem-line">如果可以，请对他们温柔一点。</div>
        <div class="poem-line gold">对自己，也温柔一点。</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line dim">如果这个游戏能让一些人会心一笑，</div>
        <div class="poem-line dim">能让一些人想起自己的十七岁，</div>
        <div class="poem-line dim">能让一些大人稍微想起自己曾经也是孩子——</div>
        <div class="poem-line italic">那就够了。</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line dim">哦对了，游戏里的"校长模式"，某种程度上是我在想象一种理想的教育。</div>
        <div class="poem-line dim">如果我是校长，我会怎么做？我会给学生留多少空间？</div>
        <div class="poem-line dim">我会在升学率和幸福感之间怎么选？</div>
        <div class="poem-line italic">这些问题，我没有答案。我只是把它们放进游戏里，让每个玩家自己去寻找答案。</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line">游戏发布后，我会把收到的每一份反馈都存下来。</div>
        <div class="poem-line">等十年后，二十七岁的我再回头看，也许会笑现在的自己写得幼稚。</div>
        <div class="poem-spacer"></div>
        <div class="poem-line gold">但我想对二十七岁的自己说：</div>
        <div class="poem-line">别忘了十七岁这年，你在凌晨两点的灯光下，敲下这些字的心情。</div>
        <div class="poem-line">别忘了你曾经是谁。</div>
        <div class="poem-line">别忘了你曾经想成为谁。</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line dim">最后，我想用一句话来结束这篇结语。</div>
        <div class="poem-line dim">这句话不是我写的，是一个十七岁的女孩在她的日记里写的。</div>
        <div class="poem-line dim">那本日记，是她去世后，她妈妈发现的。</div>
        <div class="poem-spacer"></div>
        <div class="poem-line quote">"我希望有一天，考试不再是人生的分水岭，而是众多河流中的一条。<br>我希望有一天，我可以不用因为考得好而被爱，也不用因为考不好而失去爱。<br>我希望有一天，有人对我说：你不需要成为任何人，你只需要成为你自己。"</div>
        <div class="poem-spacer"></div>
        <div class="poem-line">她没能等到这一天。</div>
        <div class="poem-line gold">但也许，我们可以帮她等一等。</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>

        <div class="poem-line small">────────────────────────────</div>
        <div class="poem-spacer"></div>
        <div class="poem-line big" style="font-size:clamp(1rem,3.5vw,1.3rem);letter-spacing:5px;color:#9ca3af;">游戏制作人 · ChansonTech</div>
        <div class="poem-line small" style="color:#4b5563;">2026年 春</div>
        <div class="poem-spacer"></div>
        <div class="poem-line italic" style="color:#7c3aed;font-size:clamp(0.95rem,2.8vw,1.1rem);">"教育是一棵树摇动另一棵树，一朵云推动另一朵云，一个灵魂唤醒另一个灵魂。"</div>
        <div class="poem-line small" style="color:#6d28d9;">—— 雅斯贝尔斯</div>
        <div class="poem-spacer"></div>
        <div class="poem-line italic" style="color:#4b5563;font-size:clamp(0.85rem,2.5vw,1rem);">谨以此游戏，献给所有在应试教育中挣扎过、迷茫过、坚持过的灵魂。</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>
        <div class="poem-line small" style="color:#111827;letter-spacing:6px;">— END —</div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>
        <div class="poem-spacer"></div>
    </div>
</div>

<script>
    // ================= 基础字典数据 =================
    const DIFF_MODS = { 0: { name: "简单", startFund: 500, stressMult: 0.4, costMult: 0.6 }, 1: { name: "正常", startFund: 100, stressMult: 0.7, costMult: 1.0 }, 2: { name: "困难", startFund: 50,  stressMult: 1.2, costMult: 1.5 } };
    const SCHOOL_LEVELS = [ 
        { name: "乡镇中学", baseStu: 300, reqRep: 0, reqFunds: 0, reqGrade: 0, reqExam: 0, upkeep: 8, tuition: 0.15 }, 
        { name: "县级重点", baseStu: 1000, reqRep: 300, reqFunds: 100, reqGrade: 45, reqExam: 50, upkeep: 25, tuition: 0.25 }, 
        { name: "市级示范", baseStu: 2500, reqRep: 1000, reqFunds: 400, reqGrade: 60, reqExam: 150, upkeep: 60, tuition: 0.4 }, 
        { name: "省级名校", baseStu: 5000, reqRep: 4000, reqFunds: 1500, reqGrade: 80, reqExam: 400, upkeep: 150, tuition: 0.7 }, 
        { name: "全国顶尖", baseStu: 10000, reqRep: 10000, reqFunds: 5000, reqGrade: 92, reqExam: 1000, upkeep: 350, tuition: 1.5 } 
    ];
    const TEACHER_TIERS = [ { name: "实习生", multi: 0.8, upCost: 0, salary: 4 }, { name: "市骨干", multi: 1.2, upCost: 40, salary: 12 }, { name: "特级名师", multi: 1.8, upCost: 120, salary: 35 } ];
    const FAMILIES = [ {id:'worker', name:"工薪阶层", desc:"家境普通，但父母吃苦耐劳。开局资金少，抗压强。", money: 200}, {id:'intel', name:"书香门第", desc:"父母是教师或公务员。开局学业与艺术属性较高。", money: 500}, {id:'business', name:"经商世家", desc:"家里有矿。开局资金充裕，但父母忙生意，亲情淡漠。", money: 2000} ];

    const FACILITIES = { 
        'confucius': { icon: '🗿', levels: [{name:'孔子圣像',cost:20,desc:'纪律+1,声誉+3/月'}, {name:'百家雕塑群',cost:60,desc:'纪律+3,声誉+10/月'}, {name:'儒学朝圣殿',cost:200,desc:'纪律+8,解锁特技【孔子圣光】'}] }, 
        'media': { icon: '🏢', levels: [{name:'电教大楼',cost:40,desc:'学业倍率提升'}, {name:'智慧校园网',cost:100,desc:'学业倍率大幅提升'}, {name:'量子超算中心',cost:300,desc:'学业极速狂飙'}] }, 
        'track': { icon: '🏃', levels: [{name:'塑胶操场',cost:30,desc:'体质+1.5,减压'}, {name:'室内体育馆',cost:80,desc:'体质+4,大幅减压'}, {name:'奥林匹克中心',cost:250,desc:'体质永不掉落'}] }, 
        'library': { icon: '📚', levels: [{name:'图书馆',cost:50,desc:'每月学业基础+1'}, {name:'数字化书城',cost:120,desc:'每月学业+3'}, {name:'国家级文献库',cost:400,desc:'每月学业+8,高教研点'}] }, 
        'clinic': { icon: '🛋️', levels: [{name:'心理诊所',cost:45,desc:'微弱对冲主科高压'}, {name:'精神康复中心',cost:150,desc:'大幅消除全校压力'}, {name:'脑科学研究所',cost:500,desc:'高压不再产生负面效果'}] }, 
        'art': { icon: '🎨', levels: [{name:'艺术中心',cost:60,desc:'素质提升'}, {name:'皇家大剧院',cost:180,desc:'艺术涵养暴增'}, {name:'国际艺术展馆',cost:600,desc:'艺术拉满,声誉极高'}] }, 
        'lab': { icon: '🔬', levels: [{name:'实验大楼',cost:80,desc:'联考额外教研点'}, {name:'国家重点实验室',cost:250,desc:'教研点获取翻倍'}, {name:'诺奖孵化基地',cost:800,desc:'教研点无限溢出'}] }, 
        'dorm': { icon: '🏨', levels: [{name:'贵族公寓',cost:100,desc:'被动吸金'}, {name:'顶奢全景套房',cost:300,desc:'吸金能力翻倍'}, {name:'伴读独栋别墅区',cost:1000,desc:'吸金恐怖,但降纪律'}] }, 
        'hospital': { icon: '🏥', levels: [{name:'校医院',cost:40,desc:'防生病停课'}, {name:'三甲附属医院',cost:200,desc:'体质飙升,免疫疫病'}, {name:'生命科学中心',cost:600,desc:'全员满血状态'}] }, 
        'hall': { icon: '🏛️', levels: [{name:'大礼堂',cost:150,desc:'AP上限+5'}, {name:'国际会议中心',cost:400,desc:'AP上限+15'}, {name:'联合国会场',cost:1500,desc:'AP无穷尽'}] } 
    };

    const BRANCHES_DB = [
        { id: 'b_hengshui', name: "衡水分校", cost: 2000, desc: "全员攻击力+15%，压力上限+20。每月声誉+20。", buff: {atk:1.15, maxHp:1.2} },
        { id: 'b_beijing', name: "北京分校", cost: 3000, desc: "全员防御力+20%，AP上限+5。每月资金+100。", buff: {def:1.2, ap:5} },
        { id: 'b_shanghai', name: "魔都国际部", cost: 4000, desc: "全员暴击率+10%，AP消耗减少。每月声誉+50。", buff: {crit:10, apRed:1} },
        { id: 'b_harvard', name: "哈佛预科营", cost: 10000, desc: "全属性+20%，解锁隐藏技能。每月资金+500。", buff: {all:1.2} },
        { id: 'b_oxford', name: "牛津书院", cost: 8000, desc: "防御力+30%，免疫晕眩。每月教研点+50。", buff: {def:1.3, immune:true} },
        { id: 'b_huanggang', name: "黄冈密卷厂", cost: 2500, desc: "攻击力+25%，每回合自伤。每月学业+5。", buff: {atk:1.25, selfDmg:true} }
    ];

    const EXPERT_POOL = [
        { id: 'e1', name: "退役魔鬼教官", rarity: 'R', upkeep: 2, desc: "战斗: 使敌方压力+2。", battle: (p,e)=>{ e.stress+=2; return "敌方压力+2"; } },
        { id: 'e2', name: "抠门老出纳", rarity: 'R', upkeep: 2, desc: "被动: 降低15%学校常耗。", battle: null },
        { id: 'e3', name: "凶悍宿管大妈", rarity: 'R', upkeep: 2, desc: "战斗: 己方防御+5%。", battle: (p,e)=>{ p.buffs.defUp=2; return "防御增强2回合"; } },
        { id: 'e4', name: "新东方大厨", rarity: 'R', upkeep: 2, desc: "战斗: 回复2%HP。", battle: (p,e)=>{ p.hp+=p.maxHp*0.02; return "回复少量HP"; } },
        { id: 'e5', name: "铁壁门卫大爷", rarity: 'R', upkeep: 2, desc: "战斗: 己方减伤护盾。", battle: (p,e)=>{ p.buffs.shield=1; return "护盾覆盖"; } },
        { id: 'e6', name: "实习心理医生", rarity: 'R', upkeep: 2, desc: "战斗: 减压3点。", battle: (p,e)=>{ p.stress=Math.max(0,p.stress-3); return "压力-3"; } },
        { id: 'e7', name: "退休老特级", rarity: 'R', upkeep: 2, desc: "战斗: 攻击力+5%。", battle: (p,e)=>{ p.buffs.atkUp=2; return "攻击提升2回合"; } },
        { id: 'e8', name: "鸡血宣传干事", rarity: 'R', upkeep: 2, desc: "战斗: 清除负面BUFF。", battle: (p,e)=>{ p.buffs.atkDown=0; p.buffs.defDown=0; p.buffs.dot=0; return "净化负面"; } },
        { id: 'e9', name: "海归青年学者", rarity: 'SR', upkeep: 10, desc: "战斗: 暴击率+5%。", battle: (p,e)=>{ p.buffs.critUp=3; return "暴击提升3回合"; } },
        { id: 'e10', name: "权威心理学教授", rarity: 'SR', upkeep: 10, desc: "战斗: 敌方攻击-10%。", battle: (p,e)=>{ e.buffs.atkDown=2; return "敌攻下降2回合"; } },
        { id: 'e11', name: "国家级金牌教练", rarity: 'SR', upkeep: 10, desc: "战斗: 攻击力暴增。", battle: (p,e)=>{ p.buffs.atkUp=3; return "攻击大幅提升3回合"; } },
        { id: 'e12', name: "抖音网红名师", rarity: 'SR', upkeep: 10, desc: "战斗: 概率使敌方晕眩。", battle: (p,e)=>{ if(Math.random()<0.3){e.buffs.stun=1; return "敌方晕眩!";} return "未命中"; } },
        { id: 'e13', name: "铁腕级部主任", rarity: 'SR', upkeep: 10, desc: "战斗: 强力护甲。", battle: (p,e)=>{ p.buffs.defUp=3; return "防御大幅增强3回合"; } },
        { id: 'e14', name: "退役奥运健将", rarity: 'SR', upkeep: 10, desc: "被动: HP上限极大幅提升", battle: null },
        { id: 'e15', name: "落魄艺术大师", rarity: 'SR', upkeep: 10, desc: "战斗: 必暴状态。", battle: (p,e)=>{ p.buffs.dmgUp=1; return "下一次攻击必定暴击且伤害提升"; } },
        { id: 'e16', name: "全国命题组组长", rarity: 'SSR', upkeep: 50, desc: "战斗: 致命弱点。", battle: (p,e)=>{ e.buffs.defDown=3; return "敌方防御崩溃3回合"; } },
        { id: 'e17', name: "千亿商业巨子", rarity: 'SSR', upkeep: 50, desc: "战斗: 回复3AP。", battle: (p,e)=>{ p.ap+=3; return "AP+3"; } },
        { id: 'e18', name: "诺奖华裔得主", rarity: 'SSR', upkeep: 50, desc: "战斗: 全员持续回复。", battle: (p,e)=>{ p.buffs.hot=3; return "群体回血状态3回合"; } },
        { id: 'e19', name: "教育厅特派员", rarity: 'SSR', upkeep: 50, desc: "战斗: 封印敌方一回合。", battle: (p,e)=>{ e.buffs.stun=1; e.buffs.atkDown=2; return "敌方震慑晕眩！"; } },
        { id: 'e20', name: "孔子转世本尊", rarity: 'SSR', upkeep: 150, desc: "战斗: 神佑复苏。", battle: (p,e)=>{ p.hp=p.maxHp; p.stress=0; return "神佑复苏，满血复活"; } },
    ];

    // 全新拓展技能库 (34个技能)
    const SKILL_DB = {
        // --- 攻击系 (ATK) ---
        'atk_0': { cat: 'atk', name: '平A出题', desc: '无消耗。造成100%伤害。', ap: 0, reqDesc: '无', req: ()=>true },
        'atk_1': { cat: 'atk', name: '随堂测验', desc: 'AP:5。造成120%伤害。', ap: 5, reqDesc: '无', req: ()=>true },
        'atk_2': { cat: 'atk', name: '刷题机器', desc: 'AP:3。造成80%伤害，回复2%HP。', ap: 3, reqDesc: '无', req: ()=>true },
        'atk_3': { cat: 'atk', name: '月考轰炸', desc: 'AP:15。造成150%伤害，敌方压力+5。', ap: 15, reqDesc: '无', req: ()=>true },
        'atk_4': { cat: 'atk', name: '题海淹没', desc: 'AP:25。造成3段60%伤害。', ap: 25, reqDesc: '主科达到[市骨干]', req: ()=>game.teachers.main>=1 },
        'atk_5': { cat: 'atk', name: '函数压轴题', desc: 'AP:35。造成250%物理伤害。', ap: 35, reqDesc: '主科达到[市骨干]', req: ()=>game.teachers.main>=1 },
        'atk_6': { cat: 'atk', name: '英语听力', desc: 'AP:18。造成110%伤害，施加易伤。', ap: 18, reqDesc: '主科达到[市骨干]', req: ()=>game.teachers.main>=1 },
        'atk_7': { cat: 'atk', name: '化学方程式', desc: 'AP:30。造成180%伤害，施加持续毒素伤害3回合。', ap: 30, reqDesc: '副科达到[市骨干]', req: ()=>game.teachers.minor>=1 },
        'atk_8': { cat: 'atk', name: '物理力学', desc: 'AP:45。造成350%伤害，自身晕眩1回合。', ap: 45, reqDesc: '副科达到[特级名师]', req: ()=>game.teachers.minor>=2 },
        'atk_9': { cat: 'atk', name: '生物遗传图', desc: 'AP:22。造成140%伤害，敌攻下降。', ap: 22, reqDesc: '副科达到[市骨干]', req: ()=>game.teachers.minor>=1 },
        'atk_10': { cat: 'atk', name: '政治辨析', desc: 'AP:40。造成300%精神伤害，无视部分防御。', ap: 40, reqDesc: '素质达到[特级名师]', req: ()=>game.teachers.spec>=2 },
        'atk_11': { cat: 'atk', name: '英语作文背诵', desc: 'AP:15。造成120%伤害，回复少量AP。', ap: 15, reqDesc: '无', req: ()=>true },
        'atk_12': { cat: 'atk', name: '完形填空连斩', desc: 'AP:20。造成4段40%的连续伤害。', ap: 20, reqDesc: '主科达到[市骨干]', req: ()=>game.teachers.main>=1 },
        'atk_13': { cat: 'atk', name: '立体几何原本', desc: 'AP:28。造成200%真实伤害。', ap: 28, reqDesc: '无', req: ()=>true },

        // --- 防守系 (DEF) ---
        'def_0': { cat: 'def', name: '整理错题本', desc: 'AP:5。下回合防御增强。', ap: 5, reqDesc: '无', req: ()=>true },
        'def_1': { cat: 'def', name: '标准答案', desc: 'AP:10。回复15% HP，清除一个负面。', ap: 10, reqDesc: '无', req: ()=>true },
        'def_2': { cat: 'def', name: '两耳不闻', desc: 'AP:8。防御增强，回复5AP。', ap: 8, reqDesc: '无', req: ()=>true },
        'def_3': { cat: 'def', name: '考前划重点', desc: 'AP:15。施加减伤护盾。', ap: 15, reqDesc: '无', req: ()=>true },
        'def_4': { cat: 'def', name: '心理建设', desc: 'AP:12。自身压力-20。', ap: 12, reqDesc: '无', req: ()=>true },
        'def_5': { cat: 'def', name: '题海护盾', desc: 'AP:20。巨额护盾，免疫一次伤害。', ap: 20, reqDesc: '主科达到[市骨干]', req: ()=>game.teachers.main>=1 },
        'def_6': { cat: 'def', name: '名师点拨', desc: 'AP:25。回复30% HP，持续回血2回合。', ap: 25, reqDesc: '素质达到[市骨干]', req: ()=>game.teachers.spec>=1 },
        'def_7': { cat: 'def', name: '绝对防御', desc: 'AP:40。获得极限闪避状态。', ap: 40, reqDesc: '主科达到[特级名师]', req: ()=>game.teachers.main>=2 },
        'def_8': { cat: 'def', name: '逻辑闭环', desc: 'AP:30。防守反击，下回合必定暴击。', ap: 30, reqDesc: '副科达到[特级名师]', req: ()=>game.teachers.minor>=2 },
        'def_9': { cat: 'def', name: '闭目养神', desc: 'AP:10。回复HP并清除所有负面状态。', ap: 10, reqDesc: '无', req: ()=>true },

        // --- 研讨系 (SUP) ---
        'sup_0': { cat: 'sup', name: '小组讨论', desc: 'AP:5。直接回复10点AP。', ap: 5, reqDesc: '无', req: ()=>true },
        'sup_1': { cat: 'sup', name: '全班传纸条', desc: 'AP:10。回血少许，AP+5。', ap: 10, reqDesc: '无', req: ()=>true },
        'sup_2': { cat: 'sup', name: '互帮互助', desc: 'AP:15。自身攻击力提升3回合。', ap: 15, reqDesc: '无', req: ()=>true },
        'sup_3': { cat: 'sup', name: '头脑风暴', desc: 'AP:20。暴击率极大提升2回合。', ap: 20, reqDesc: '素质达到[市骨干]', req: ()=>game.teachers.spec>=1 },
        'sup_4': { cat: 'sup', name: '学术沙龙', desc: 'AP:25。全员满状态恢复大量HP与AP。', ap: 25, reqDesc: '拥有专家[诺奖华裔得主]', req: ()=>hasExpert('e18') },
        'sup_5': { cat: 'sup', name: '考神附体', desc: 'AP:30。获得攻击提升、防御提升、暴击提升综合状态。', ap: 30, reqDesc: '无', req: ()=>true },

        // --- 心理系 (PSY) ---
        'psy_0': { cat: 'psy', name: '死亡凝视', desc: 'AP:10。敌方压力+15。', ap: 10, reqDesc: '无', req: ()=>true },
        'psy_1': { cat: 'psy', name: '凡尔赛发言', desc: 'AP:15。敌方压力+25，附带施加易伤。', ap: 15, reqDesc: '无', req: ()=>true },
        'psy_2': { cat: 'psy', name: '撕毁试卷', desc: 'AP:20。降低敌方攻击力3回合。', ap: 20, reqDesc: '无', req: ()=>true },
        'psy_3': { cat: 'psy', name: '排名公布', desc: 'AP:30。造成敌方当前HP 20%伤害。', ap: 30, reqDesc: '主科达到[市骨干]', req: ()=>game.teachers.main>=1 },
        'psy_4': { cat: 'psy', name: '叫家长', desc: 'AP:40。敌方强行晕眩1回合，大伤害。', ap: 40, reqDesc: '主科达到[特级名师]', req: ()=>game.teachers.main>=2 },
        'psy_5': { cat: 'psy', name: '叹气干扰', desc: 'AP:12。敌方攻防双降2回合。', ap: 12, reqDesc: '无', req: ()=>true },

        // --- 灵感系 (INSP) ---
        'insp_0': { cat: 'insp', name: '蒙一个', desc: 'AP:5。50%几率300%伤，50% miss。', ap: 5, reqDesc: '无', req: ()=>true },
        'insp_1': { cat: 'insp', name: '押题命中', desc: 'AP:30。30%几率造成999伤害。', ap: 30, reqDesc: '无', req: ()=>true },
        'insp_2': { cat: 'insp', name: '灵光乍现', desc: 'AP:20。下一次攻击必定暴击。', ap: 20, reqDesc: '艺术属性>50', req: ()=>game.art>50 },
        'insp_3': { cat: 'insp', name: '艺术通感', desc: 'AP:30。基于艺术属性造成巨额伤害。', ap: 30, reqDesc: '艺术属性>70', req: ()=>game.art>70 },

        // --- 熵增系 (ENTROPY) ---
        'ent_0': { cat: 'ent', name: '冥想净化', desc: 'AP:15。清除自身全部思维熵增（压力归零）。', ap: 15, reqDesc: '无', req: ()=>true },
        'ent_1': { cat: 'ent', name: '心流状态', desc: 'AP:20。自身压力-40，攻击力小幅提升。', ap: 20, reqDesc: '无', req: ()=>true },
        'ent_2': { cat: 'ent', name: '熵增传导', desc: 'AP:25。将己方当前压力的50%转移给敌方。', ap: 25, reqDesc: '无', req: ()=>true },
        'ent_3': { cat: 'ent', name: '精神崩溃弹', desc: 'AP:35。给敌方施加"思维熵增"BUFF，每回合压力+15，持续3回合。', ap: 35, reqDesc: '主科达到[市骨干]', req: ()=>game.teachers.main>=1 },
        'ent_4': { cat: 'ent', name: '虚空凝视', desc: 'AP:18。使敌方压力+30，并封印其下回合技能释放。', ap: 18, reqDesc: '素质达到[市骨干]', req: ()=>game.teachers.spec>=1 },
        'ent_5': { cat: 'ent', name: '浴火重生', desc: 'AP:40。消耗己方所有压力为代价，回复大量HP（压力×20点）。', ap: 40, reqDesc: '无', req: ()=>true },

        // --- 体系系 (SYS) ---
        'sys_衡水': { cat: 'sys', name: '衡水模式', desc: 'AP:50。攻击翻倍，自身扣血20%。', ap: 50, reqDesc: '政策[衡水高考集中营]', req: ()=>hasPolicy('A8') },
        'sys_素质': { cat: 'sys', name: '素质教育', desc: 'AP:50。全属性提升，持续回血减压。', ap: 50, reqDesc: '政策[理想乌托邦校园]', req: ()=>hasPolicy('D8') },
        'sys_资本': { cat: 'sys', name: '钞能力', desc: 'AP:0。耗50万资金，秒杀9999点伤害。', ap: 0, reqDesc: '拥有专家[千亿商业巨子]', req: ()=>hasExpert('e17') }
    };

    // 敌方BOSS库 (加入BOSS特性)
    const RIVALS = [
        { id: 't1_1', tier:1, name: "村口希望中学", hp: 4000, atk: 650, def: 60, pts: 5, traitName:"野蛮生长", traitDesc:"每回合恢复少量生命。", traitEff:(p,e)=>{ e.hp=Math.min(e.maxHp, e.hp+Math.floor(e.maxHp*0.02)); return "敌方恢复生命值"; } },
        { id: 't1_2', tier:1, name: "镇办第三中学", hp: 5500, atk: 750, def: 120, pts: 8, traitName:"顽强抵抗", traitDesc:"生命低于50%时防御翻倍。", traitEff:(p,e)=>{ if(e.hp<e.maxHp*0.5){ e.buffs.defUp=1; return "防御激增"; } return null; } },
        { id: 't1_3', tier:1, name: "县职业中专", hp: 7000, atk: 850, def: 150, pts: 10, traitName:"流氓打法", traitDesc:"攻击有概率施加晕眩。", traitEff:(p,e)=>null },
        { id: 't2_1', tier:2, name: "县第一中学", hp: 10500, atk: 1000, def: 300, pts: 15, traitName:"题海战术", traitDesc:"每回合固定削减我方AP。", traitEff:(p,e)=>{ p.ap=Math.max(0,p.ap-2); return "削减玩家AP"; } },
        { id: 't2_2', tier:2, name: "市普通高中", hp: 13500, atk: 1150, def: 360, pts: 18, traitName:"中规中矩", traitDesc:"免疫所有属性下降Debuff。", traitEff:(p,e)=>{ e.buffs.atkDown=0; e.buffs.defDown=0; return null; } },
        { id: 't2_3', tier:2, name: "私立贵族学校", hp: 15000, atk: 1300, def: 300, pts: 20, traitName:"钞能力加持", traitDesc:"开场自带高额护盾并提升攻击。", traitEff:(p,e)=>{ if(bState.turn===1){ e.buffs.shield=2; e.buffs.atkUp=5; return "激活金钱护盾与攻击"; } return null; } },
        { id: 't3_1', tier:3, name: "市实验中学", hp: 24000, atk: 1600, def: 600, pts: 30, traitName:"实验创新", traitDesc:"每3回合施加剧毒化学伤害。", traitEff:(p,e)=>{ if(bState.turn%3===0){ p.buffs.dot=2; return "释放化学毒素"; } return null; } },
        { id: 't3_2', tier:3, name: "市外国语", hp: 27000, atk: 1750, def: 540, pts: 35, traitName:"听力折磨", traitDesc:"增加玩家每回合的压力增长。", traitEff:(p,e)=>{ p.stress+=3; return "噪音增加压力"; } },
        { id: 't3_3', tier:3, name: "省附属分校", hp: 30000, atk: 1900, def: 750, pts: 40, traitName:"本部支援", traitDesc:"半血时召唤一次强力打击。", traitEff:(p,e)=>{ if(e.hp<e.maxHp*0.5 && !e.hasSummoned){ e.hasSummoned=true; p.hp-=2000; return "天降神罚！"; } return null; } },
        { id: 't4_1', tier:4, name: "省实验中学", hp: 45000, atk: 2500, def: 1200, pts: 50, traitName:"全省标杆", traitDesc:"攻击力随回合数不断提升。", traitEff:(p,e)=>{ e.atk+=50; return "攻击力成长"; } },
        { id: 't4_2', tier:4, name: "省师大附中", hp: 48000, atk: 2650, def: 1260, pts: 55, traitName:"名师光环", traitDesc:"回合开始时恢复大量生命。", traitEff:(p,e)=>{ e.hp+=1500; return "名师治疗"; } },
        { id: 't4_3', tier:4, name: "百年老校一中", hp: 54000, atk: 2800, def: 1500, pts: 60, traitName:"底蕴深厚", traitDesc:"极高基础防御，免疫暴击。", traitEff:(p,e)=>null },
        { id: 't5_1', tier:5, name: "衡水钢铁中学", hp: 90000, atk: 4600, def: 2400, pts: 100, traitName:"死亡行军", traitDesc:"双方无法回血，敌方攻击附带高额真伤。", traitEff:(p,e)=>{ p.buffs.hot=0; e.buffs.hot=0; return "禁疗立场展开"; } },
        { id: 't5_2', tier:5, name: "北京四中本部", hp: 105000, atk: 3700, def: 3600, pts: 120, traitName:"降维打击", traitDesc:"每回合封印玩家的AP恢复。", traitEff:(p,e)=>{ p.ap=Math.max(0,p.ap-3); return "AP压制"; } },
        { id: 't5_3', tier:5, name: "黄冈密卷工厂", hp: 84000, atk: 6100, def: 1500, pts: 150, traitName:"题海深渊", traitDesc:"极高攻击，每次受击反弹伤害。", traitEff:(p,e)=>null },
        { id: 't5_4', tier:5, name: "人大附中神域", hp: 120000, atk: 4900, def: 3000, pts: 200, traitName:"六边形战士", traitDesc:"免疫所有异常，全属性持续增强。", traitEff:(p,e)=>{ e.atk+=100; e.def+=50; return "神性增强"; } },
        { id: 't5_5', tier:5, name: "宇宙真理中学", hp: 150000, atk: 7600, def: 7500, pts: 500, traitName:"真理抹杀", traitDesc:"第15回合直接秒杀玩家。", traitEff:(p,e)=>{ if(bState.turn>=15){ p.hp=0; return "真理抹杀启动！"; } return null; } }
    ];

    const WEATHER_TYPES = [
        { id: 'sun', name: '☀️ 晴朗', desc: '无特殊效果', effect: ()=>{} },
        { id: 'rain', name: '🌧️ 阴雨', desc: '全员心情低落，暴击率-10%', effect: (p,e)=>{p.crit-=10; e.crit-=10;} },
        { id: 'morning', name: '📖 早读声浪', desc: '思维活跃，双方攻击力+20%', effect: (p,e)=>{p.atk*=1.2; e.atk*=1.2;} },
        { id: 'sleepy', name: '😴 午后困倦', desc: '昏昏欲睡，双方防御力-30%', effect: (p,e)=>{p.def*=0.7; e.def*=0.7;} },
        { id: 'storm', name: '⚡ 考试风暴', desc: '压力骤增，每回合增加10点熵增', effect: (p,e)=>{p.stress+=10; e.stress+=10;} }
    ];

    const POLICY_TREE = [
        { tier: 1, nodes: [
            { id: "A1", name: "军事化早读", class: "branch-a", desc: "学业+1, 压力+1", cost: 10, req: null },
            { id: "B1", name: "仪容仪表大检查", class: "branch-b", desc: "纪律+1, 艺术-1", cost: 10, req: null },
            { id: "C1", name: "小卖部疯狂涨价", class: "branch-c", desc: "每月资金略增, 纪律-1", cost: 10, req: null },
            { id: "D1", name: "开设课外社团", class: "branch-d", desc: "艺术+1, 压力-1", cost: 10, req: null }
        ]},
        { tier: 2, nodes: [
            { id: "A2", name: "强制晚自习", class: "branch-a", desc: "学业+2, 压力+2", cost: 20, req: "A1" },
            { id: "A3", name: "月考红榜大字报", class: "branch-a", desc: "学业+1, 纪律+1", cost: 20, req: "A1" },
            { id: "B2", name: "全校电子设备禁令", class: "branch-b", desc: "纪律+2, 压力+1", cost: 20, req: "B1" },
            { id: "B3", name: "男女生分桌进餐", class: "branch-b", desc: "防早恋, 纪律+1", cost: 20, req: "B1" },
            { id: "C2", name: "食堂对外层层承包", class: "branch-c", desc: "资金增加, 体质-2", cost: 20, req: "C1" },
            { id: "C3", name: "赞助费明码标价", class: "branch-c", desc: "录取降分收钱, 资金大增", cost: 20, req: "C1" },
            { id: "D2", name: "落实周末双休", class: "branch-d", desc: "压力-3, 学业-1", cost: 20, req: "D1" },
            { id: "D3", name: "全校艺术节筹办", class: "branch-d", desc: "艺术+3, 消耗资金", cost: 20, req: "D1" }
        ]},
        { tier: 3, nodes: [
            { id: "A4", name: "周末疯狂补课", class: "branch-a", desc: "学业+3, 压力+4", cost: 50, req: "A2" },
            { id: "A5", name: "题海战术大爆发", class: "branch-a", desc: "学业+3, 体质-2", cost: 50, req: "A3" },
            { id: "B4", name: "教室360度监控", class: "branch-b", desc: "纪律+3, 压力+2", cost: 50, req: "B2" },
            { id: "B5", name: "违禁品地毯式搜查", class: "branch-b", desc: "纪律+2, 体质+1", cost: 50, req: "B3" },
            { id: "C4", name: "学区房疯狂炒作", class: "branch-c", desc: "提升名气和资金", cost: 50, req: "C2" },
            { id: "C5", name: "压榨底薪实习教师", class: "branch-c", desc: "教师工资大幅降低", cost: 50, req: "C3" },
            { id: "D4", name: "心理健康诊疗周", class: "branch-d", desc: "压力-5, 纪律+1", cost: 50, req: "D2" },
            { id: "D5", name: "大学式自由走班制", class: "branch-d", desc: "艺术+4, 纪律-2", cost: 50, req: "D3" }
        ]},
        { tier: 4, nodes: [
            { id: "A6", name: "末位淘汰制重点班", class: "branch-a", desc: "学业+5, 极度高压", cost: 100, req: "A4" },
            { id: "A7", name: "奥赛强基掐尖营", class: "branch-a", desc: "学业+4, 烧钱", cost: 100, req: "A5" },
            { id: "B6", name: "学生互相举报奖励制", class: "branch-b", desc: "纪律+5, 压力爆表", cost: 100, req: "B4" },
            { id: "B7", name: "军训常态化", class: "branch-b", desc: "体质+5, 纪律+3", cost: 100, req: "B5" },
            { id: "C6", name: "国际土豪班割韭菜", class: "branch-c", desc: "资金每月巨额入账", cost: 100, req: "C4" },
            { id: "C7", name: "强迫购买天价校服", class: "branch-c", desc: "资金暴涨, 声誉跌", cost: 1000, req: "C5" },
            { id: "D6", name: "校园恋爱完全解禁", class: "branch-d", desc: "压力-8, 纪律-5", cost: 1000, req: "D4" },
            { id: "D7", name: "常青藤素质考核标准", class: "branch-d", desc: "艺术/体质+5, 声誉飙升", cost: 1000, req: "D5" }
        ]},
        { tier: 5, nodes: [
            { id: "A8", name: "【终极】衡水高考集中营", class: "branch-a", desc: "解锁必杀技【地狱周特训】", cost: 30000, req: "A6" },
            { id: "B8", name: "【终极】斯巴达绝对服从", class: "branch-b", desc: "纪律锁死100", cost: 30000, req: "B6" },
            { id: "C8", name: "【终极】纳斯达克上市集团", class: "branch-c", desc: "资金无限膨胀", cost: 30000, req: "C6" },
            { id: "D8", name: "【终极】理想乌托邦校园", class: "branch-d", desc: "压力永远为0", cost: 30000, req: "D6" }
        ]}
    ];

    const ACHIEVEMENTS = [ 
        { id: 'a1', name: "💸 第一桶金", desc: "资金破 1,000 万" }, 
        { id: 'a2', name: "🤑 商业帝国", desc: "资金破 1 亿" }, 
        { id: 'a3', name: "🌟 名满天下", desc: "声誉破 10,000 点" }, 
        { id: 'a4', name: "👑 教育霸主", desc: "学校评级达到【全国顶尖】" }, 
        { id: 'a5', name: "🎓 学术泰斗", desc: "全校学业平均达到90" }, 
        { id: 'a6', name: "🏭 卷王之王", desc: "主科课时排满40节" }, 
        { id: 'a7', name: "🥇 奥赛强校", desc: "点亮奥赛强基政策" }, 
        { id: 'a8', name: "💥 高压锅炸了", desc: "全校平均压力爆表100" }, 
        { id: 'a9', name: "🚔 无法无天", desc: "纪律跌破10" }, 
        { id: 'a10', name: "🃏 欧皇附体", desc: "抽到 SSR 级专家" }, 
        { id: 'a11', name: "🏗️ 基建狂魔", desc: "建满20块地皮" }, 
        { id: 'a12', name: "👨‍🏫 群星闪耀", desc: "集齐20位名师" }, 
        { id: 'a13', name: "📜 法家大成", desc: "点满全部15项校策" }, 
        { id: 'a14', name: "👨‍🎓 金榜题名", desc: "学生模式高考达到680分" }, 
        { id: 'a15', name: "💕 青春无悔", desc: "学生模式普通表白成功" }, 
        { id: 'a16', name: "💀 彻底崩溃", desc: "学生模式压力突破100" }, 
        { id: 'a17', name: "⚔️ 密卷克星", desc: "PVE中击溃黄冈密卷工厂" }, 
        { id: 'a18', name: "🌍 全球霸权", desc: "建立全部海外分校" },
        { id: 'a19', name: "🏅 国家队", desc: "学生模式获得奥赛保送" },
        { id: 'ach_lin', name: "📖 学霸之恋", desc: "在学生模式中成功攻略林知秋" },
        { id: 'ach_xia', name: "🎨 艺术之恋", desc: "在学生模式中成功攻略夏晚晴" },
        { id: 'ach_jiang', name: "🏀 热血之恋", desc: "在学生模式中成功攻略江一舟" },
        { id: 'ach_shen', name: "🚬 救赎之恋", desc: "在学生模式中成功攻略沈渔" },
        { id: 'a20', name: "🏆 万象归一", desc: "解锁全部成就！" } 
    ];

    const FRIENDS = [
        {id:'f1', name:'🤓 学霸同桌', cost:200, desc:'每月学业+2', eff:()=>{stuGame.grade+=2;}},
        {id:'f2', name:'💰 富二代发小', cost:500, desc:'每月零花钱+100', eff:()=>{stuGame.money+=100;}},
        {id:'f3', name:'🏃 体育特长生', cost:200, desc:'每月体质+3', eff:()=>{stuGame.fit+=3;}}
    ];

    // 四大恋爱对象配置
    const CRUSHES = [
        { 
            id: 'lin', name: '林知秋', title: '学霸班长', desc: '表面高冷严谨，实则内心渴望被理解。清北种子选手。',
            dialogues: ["这道题选C，别发呆了。","今天的早读你迟到了1分钟。","笔记借你，不要弄脏。","你觉得……宇宙有边界吗？","周末陪我去趟图书馆吧。","别老是玩游戏了，快月考了。","我的目标是清华，你呢？","今天讲的数列你听懂了吗？","我偶尔也会觉得累……","你为什么总是看着我？"],
            events: {
                30: { trigger: false, name:"天台背单词", desc:"发现她偷偷在天台上写诗。", check:()=>hasPolicy('A1')?1.5:(hasPolicy('D2')?0.7:1), log:"她欣赏你的自律，好感倍增。" },
                60: { trigger: false, name:"整理竞赛资料", desc:"熬夜照顾生病的她。", check:()=>hasPolicy('A7')?2:1, log:"共同的竞赛目标让你们紧紧相连。" },
                90: { trigger: false, name:"约定未来", desc:"一起报考同一所大学。", check:()=>hasPolicy('A6')?(stuGame.grade>=80?1:-999):1, log:"你们许下了神圣的诺言。" }
            }
        },
        { 
            id: 'xia', name: '夏晚晴', title: '艺术特长生', desc: '自由洒脱，讨厌束缚，感性浪漫。在校外兼职模特。',
            dialogues: ["这朵云的形状像不像一顶帽子？","学校的制服真难看。","周末我要去漫展，一起来吗？","我刚才画了你，别动！","好想逃课去海边啊……","你喜欢梵高还是莫奈？","听这首歌，是不是很有感觉？","我讨厌被规则束缚。","你觉得我这身搭配怎么样？","嘘，别告诉老师我在画画。"],
            events: {
                30: { trigger: false, name:"江边写生", desc:"聊起她想去意大利留学。", check:()=>hasPolicy('D3')?1.5:(hasPolicy('A4')?0.5:1), log:"艺术节筹办让她感受到了被重视。" },
                60: { trigger: false, name:"画作被批", desc:"她的画被老师批评，你站出来为她辩护。", check:()=>hasPolicy('D5')?2:0.5, log:"你的辩护打动了她。" },
                90: { trigger: false, name:"筹办画展", desc:"需要资金支持。", check:()=>hasPolicy('C2')?(stuGame.money>=500?2:-999):1, log:"你用资金赞助了她的画展，她感动落泪。" }
            }
        },
        { 
            id: 'jiang', name: '江一舟', title: '体育特长生', desc: '校篮球队队长，阳光开朗。讲义气，有点莽撞。',
            dialogues: ["走，打球去！","你这体能不行啊，得多练。","昨天那场NBA看了没？","饿死了，去食堂吃烧烤。","兄弟，帮我抄下作业呗。","我可是要进国家队的男人。","别怕，有我在没人敢欺负你。","哎呀，受伤是家常便饭。","周末去网吧开黑？","你觉得那个啦啦队长怎么样？开玩笑的啦。"],
            events: {
                30: { trigger: false, name:"赛后烧烤", desc:"看他打球赛后一起去吃烧烤。", check:()=>(getFacLevelCount('track',1)>0)?1.5:(hasPolicy('D2')?1.2:0.8), log:"新球馆让他战意高昂。" },
                60: { trigger: false, name:"拉取赞助", desc:"球队面临解散危机，你帮他拉赞助。", check:()=>hasPolicy('C4')?2:1, log:"校友投资挽救了球队。" },
                90: { trigger: false, name:"全市决赛", desc:"你去现场加油助威。", check:()=>hasPolicy('A4')?0.1:1.5, log:"你在场边大喊了他的名字。" }
            }
        },
        { 
            id: 'shen', name: '沈渔', title: '叛逆转校生', desc: '从大城市转来，抽烟逃课染发。嘴硬心软，防御心极强。',
            dialogues: ["别烦我。","你再看我试试？","无聊透顶的学校。","借个火。","你想知道我过去的事？别问。","这里的空气真沉闷。","你为什么不和其他人一样躲着我？","我不需要同情。","这首歌，你听过吗？","其实……谢谢你那天帮我。"],
            events: {
                30: { trigger: false, name:"发现秘密", desc:"发现她其实在打工养家，你帮她保守秘密。", check:()=>hasPolicy('B1')?-1:(getFacLevelCount('clinic',0)>0?1.5:1), log:"你的理解融化了她的冰冷。" },
                60: { trigger: false, name:"英雄救美", desc:"她被小混混纠缠，你挺身而出。", check:()=>hasPolicy('B4')?2:1, log:"安保队的介入让事件和平解决。" },
                90: { trigger: false, name:"敞开心扉", desc:"她生日，你送了她喜欢的书。", check:()=>hasPolicy('B3')?-1:1.5, log:"她第一次对你露出了真心的微笑。" }
            }
        }
    ];

    const EVENT_POOL = [
        { t: "教育局突击暗访", d: "上面突击检查违规补课。", o1: "塞钱打点", a1:{act:()=>payCost(0,5)?(log("花钱消灾"),true):false, txt:"耗资￥5万"}, o2: "硬抗审查", a2:{act:()=>{game.discipline>65?mod("reputation",15):mod("reputation",-20);return true;}, txt:"纪律>65声誉+15，否则-20"} },
        { t: "食堂鼠头鸭脖事件", d: "学生拍照发了微博热搜。", o1: "花钱压热搜", a1:{act:()=>payCost(0,10)?(mod("stress",5),true):false, txt:"耗资￥10万,压力+5"}, o2: "承认并整改", a2:{act:()=>{mod("reputation",-20); mod("funds",-5);return true;}, txt:"声誉-20,资金-5万"} },
        { t: "天台抑郁预警", d: "有学生受不了爬上天台！", o1: "紧急心理干预", a1:{act:()=>payCost(2,5)?(mod("stress",-10),true):false, txt:"耗AP:2,￥5万,压力-10"}, o2: "消防强行拉下", a2:{act:()=>{mod("stress",15);return true;}, txt:"压力+15"} },
        { t: "尖子生早恋被抓", d: "全校第一和第二在操场约会。", o1: "棒打鸳鸯记过", a1:{act:()=>{mod("stress",10); mod("discipline",5);return true;}, txt:"压力+10,纪律+5"}, o2: "顺其自然", a2:{act:()=>{mod("grade",-5); mod("discipline",-5);return true;}, txt:"学业-5,纪律-5"} },
        { t: "校外黑帮收保护费", d: "周边治安急剧恶化。", o1: "雇佣安保队", a1:{act:()=>payCost(0,8)?(mod("discipline",10),true):false, txt:"耗资￥8万,纪律+10"}, o2: "不闻不问", a2:{act:()=>{mod("stress",15);mod("discipline",-10);return true;}, txt:"压力+15,纪律-10"} },
        { t: "竞争私立名校来挖墙脚", d: "隔壁想用两倍工资挖你的名师。", o1: "加薪挽留", a1:{act:()=>payCost(0,10)?(mod("grade",5),true):false, txt:"耗资￥10万,学业+5"}, o2: "爱走走不留", a2:{act:()=>{mod("grade",-10);return true;}, txt:"学业-10"} },
        { t: "清华学霸状元笔记泄露", d: "全校疯抢复印，引发踩踏风险。", o1: "学校出资官方印发", a1:{act:()=>payCost(0,3)?(mod("grade",5),true):false, txt:"耗资￥3万,学业+5"}, o2: "没收充公", a2:{act:()=>{mod("stress",10);mod("discipline",5);return true;}, txt:"压力+10,纪律+5"} },
        { t: "互联网大厂高管校友回访", d: "曾经的刺头学生如今身价过亿。", o1: "最高规格接待拉投资", a1:{act:()=>payCost(2,5)?(mod("funds",30),true):false, txt:"耗AP:2,￥5万,获￥30万"}, o2: "简单座谈", a2:{act:()=>{mod("reputation",10);return true;}, txt:"声誉+10"} }
    ];

    // ================= 全局状态 =================
    let metaData = { rebirthPoints: 0, unlockedEndings: [], alumni: [] };
    let defaultGame = {
        year: 2018, month: 9, levelIdx: 0, diff: 1, funds: 100, reputation: 100, ap: 10, maxAp: 20, eduPoints: 0, students: 300, examPoints: 0,
        grade: 40, stress: 10, discipline: 60, fitness: 50, art: 30, schedule: { main: 20, minor: 15, spec: 5 }, teachers: { main: 0, minor: 0, spec: 0 },
        unlockedNodes: [], unlockedExperts: [], branches: [], achievements: [], map: new Array(20).fill(null), policies: [],
        gaokaoHistory: [], lastGaokaoAvg: 0, seniorYear: false, seniorCountdown: 0,
        yearEndRating: [], battleSquad: [],
        shopData: { permBought:{}, monthlyBought:{}, month:9 },
        policyDiscount: 0, repShield: false, inspectImmune: false, nextGachaGuarantee: null, shards: 0
    };
    let game = null; let autoInterval = null; let selectedMapIndex = -1; let currentMode = 'principal';
    
    // 学生模式状态
    let stuGame = { active: false, year:1, month:1, turn:1, grade:40, stress:0, fit:40, art:40, talent:[], family:'', money:0, crushes:{}, lover:false, loverName:'', friends:[], examScore: 0, energy: 100, maxEnergy: 100, olympiadProgress: 0, isInsured: false };
    
    // 战斗状态机
    let bState = { active: false, isOver: false, turn: 1, phase: '', p: {}, e: {}, log: [], rivalId: '', pts: 0, currentCat: 'atk', weather: null, expertUsed: false };

    // ================= 初始化 =================
    function showDiffScreen() {
        let ds = document.getElementById('diff-screen');
        if(ds) ds.style.display = 'flex';
    }
    function hideDiffScreen() {
        let ds = document.getElementById('diff-screen');
        if(ds) ds.style.display = 'none';
    }

    function init() {
        // Always start with a valid game object
        game = JSON.parse(JSON.stringify(defaultGame));
        
        let meta = localStorage.getItem('school_v12_meta');
        if(meta) { try { metaData = JSON.parse(meta); } catch(e) {} }

        let saved = localStorage.getItem('school_v12_save');
        if(saved) {
            try {
                let parsed = JSON.parse(saved);
                game = Object.assign(JSON.parse(JSON.stringify(defaultGame)), parsed);
                // Repair any missing/invalid fields for old save compatibility
                if (game.diff === undefined || game.diff === null || !DIFF_MODS[game.diff]) game.diff = 1;
                if (!game.map || !Array.isArray(game.map)) game.map = new Array(20).fill(null);
                if (!Array.isArray(game.unlockedExperts)) game.unlockedExperts = [];
                if (!Array.isArray(game.policies)) game.policies = [];
                if (!Array.isArray(game.branches)) game.branches = [];
                if (!Array.isArray(game.achievements)) game.achievements = [];
                if (!Array.isArray(game.gaokaoHistory)) game.gaokaoHistory = [];
                if (!Array.isArray(game.battleSquad)) game.battleSquad = [];
                if (!game.teachers || typeof game.teachers !== 'object') game.teachers = { main: 0, minor: 0, spec: 0 };
                if (!game.schedule || typeof game.schedule !== 'object') game.schedule = { main: 20, minor: 15, spec: 5 };
                hideDiffScreen();
                log("读取存档成功！霸业继续。");
                updateUI();
            } catch(e) {
                console.error("存档解析失败，重置:", e);
                localStorage.removeItem('school_v12_save');
                game = JSON.parse(JSON.stringify(defaultGame));
                showDiffScreen();
            }
        } else {
            showDiffScreen();
        }
    }
    
    // ========== 基础引擎 ==========
    function saveGame() { 
        localStorage.setItem('school_v12_save', JSON.stringify(game)); 
        localStorage.setItem('school_v12_meta', JSON.stringify(metaData));
        showToast("💾 保存成功"); 
    }
    function hardReset() { if(confirm("轮回重建，当前进度归零（保留轮回点），确定吗？")){ if(autoInterval) toggleAuto(); localStorage.removeItem('school_v12_save'); game = JSON.parse(JSON.stringify(defaultGame)); showDiffScreen(); }}
    function getScaleFactor() {
        if(!game) return 1;
        let diff = (game.diff !== undefined && DIFF_MODS[game.diff]) ? game.diff : 1;
        return Math.max(1.0, (game.students / 500) * DIFF_MODS[diff].costMult);
    }
    function mod(stat, val) { game[stat] += val; }
   function getFacLevelCount(type, minLevel) { 
        try {
            if (!game || !game.map || !Array.isArray(game.map)) return 0;
            return game.map.filter(x => x && x.id === type && x.level >= minLevel).length;
        } catch(e) { return 0; }
    }
    function hasExpert(id) { return game && Array.isArray(game.unlockedExperts) && game.unlockedExperts.includes(id); }
    function hasPolicy(id) { return game && Array.isArray(game.policies) && game.policies.includes(id); }
    function hasBranch(id) { return game && Array.isArray(game.branches) && game.branches.includes(id); }
    
    function log(msg, color="#334155") { let b = document.getElementById('log-box'); if(!b) return; let date = (game && game.year) ? `[${game.year}.${game.month}]` : '[--]'; b.innerHTML = `<div class="log-item"><span style="color:var(--primary);font-weight:bold;">${date}</span> <span style="color:${color}">${msg}</span></div>` + b.innerHTML; }
    function showToast(msg) { let b = document.getElementById('toast-container'); let t = document.createElement('div'); t.className = 'toast'; t.innerText = msg; b.appendChild(t); setTimeout(()=>t.remove(), 3900); }
    
    // 弹窗系统
    window.currentModalCallbacks = [];
    function showCustomModal(title, desc, btns) {
        document.getElementById('modal-title').innerHTML = title; 
        document.getElementById('modal-desc').innerHTML = desc;
        let btnContainer = document.getElementById('modal-buttons'); btnContainer.innerHTML = '';
        window.currentModalCallbacks = btns.map(b => b.action || function(){});
        btns.forEach((b, i) => {
            let btnEl = document.createElement('button'); btnEl.className = 'modal-btn'; btnEl.innerHTML = b.text;
            btnEl.onclick = function() { document.getElementById('modal-overlay').style.display = 'none'; window.currentModalCallbacks[i](); };
            btnContainer.appendChild(btnEl);
        });
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function openModal(id) { 
        if(!game || !game.map) return showToast("请先选择难度开始游戏！");
        document.getElementById(id).style.display='flex'; 
        if(id==='modal-achieve') renderAchievements();
        if(id==='modal-rnd') renderRnd('scroll');
        if(id==='modal-shop') renderShop('infra');
        renderModals(); 
    }

    function showDifficultySelect() {
        showCustomModal("🌍 开启霸业纪元：选择难度", "难度决定初始资金、日常开销倍率以及学生抗压能力的极限。", [
            {text:"简单 (适合休闲体验)", action:()=>startGame(0)}, 
            {text:"正常 (标准模拟法则)", action:()=>startGame(1)}, 
            {text:"困难 (极致抗压折磨)", action:()=>startGame(2)}
        ]);
    }
    function startGame(diffIdx) {
        game = JSON.parse(JSON.stringify(defaultGame));
        game.diff = diffIdx;
        game.funds = DIFF_MODS[diffIdx].startFund;
        hideDiffScreen();
        log(`选择了【${DIFF_MODS[diffIdx].name}】难度。学校正式挂牌成立！`);
        updateUI();
    }

    // ================= 核心推演逻辑 =================
    function advanceMonth() {
        if(!game || !game.map) return showToast("请先选择难度开始游戏！");
        if(bState.active) return showToast("战斗中无法推进！");
        let advBtn = document.getElementById('btn-advance'); if(game.funds <= 0 && advBtn && advBtn.disabled) return;
        game.month++; if (game.month > 12) { game.month = 1; game.year++; }
        
        // AP恢复
        let hallLevel = getFacLevelCount('hall',0) ? game.map.find(x=>x&&x.id==='hall').level : -1;
        game.maxAp = 20 + (game.levelIdx * 5) + (hallLevel>=0?5:0) + (hallLevel>=1?10:0) + (hallLevel>=2?30:0) + (hasBranch('b_beijing')?5:0);
        game.ap = Math.min(game.maxAp, game.ap + 3);

        // 分校收益
        BRANCHES_DB.forEach(b => {
            if(hasBranch(b.id)) {
                if(b.id.includes('hengshui')) game.reputation += 20;
                if(b.id.includes('beijing')) game.funds += 100;
                if(b.id.includes('shanghai')) game.reputation += 50;
                if(b.id.includes('harvard')) game.funds += 500;
                if(b.id.includes('oxford')) game.eduPoints += 50;
                if(b.id.includes('huanggang')) game.grade += 0.5;
            }
        });

        // 每学期收学费 (3月与9月) - 根据声誉、在校规模、学校等级动态调整
        if (game.month === 3 || game.month === 9) {
            let lvl = SCHOOL_LEVELS[game.levelIdx];
            
            // 在校规模：基础人数 × 声誉系数（声誉越高，招生越多，上限1.8倍，下限0.4倍）
            let repFactor = Math.max(0.4, Math.min(1.8, 0.6 + game.reputation / (lvl.reqRep || 500) * 0.6));
            game.students = Math.floor(lvl.baseStu * repFactor);
            game.students = Math.max(50, game.students);

            // 学费单价：基础费率 × 学校等级系数 × 声誉溢价 × 高考成绩加成
            let baseRate = lvl.tuition;                                              // 基础费率（万/人）
            let repPremium = 1 + Math.min(1.0, game.reputation / 5000);            // 声誉溢价最多翻倍
            let gaokaoBonus = game.lastGaokaoAvg ? Math.max(0, (game.lastGaokaoAvg - 450) / 1500) : 0; // 高考均分越高学费越贵
            let tuitionPerHead = baseRate * repPremium * (1 + gaokaoBonus);

            let income = Math.floor(game.students * tuitionPerHead);
            game.funds += income;
            let semesterName = game.month === 3 ? '春季学期' : '秋季学期';
            log(`🏫 【${semesterName}开学】在校生 ${game.students} 人 × 学费 ￥${(tuitionPerHead * 10000).toFixed(0)}元 = 收入 ￥${income}万`, "var(--success)");
            showToast(`📚 ${semesterName}学费收入 ￥${income}万`);
        }

        // 基础消耗
        let scale = getScaleFactor();
        let totalSal = (TEACHER_TIERS[game.teachers.main].salary + TEACHER_TIERS[game.teachers.minor].salary + TEACHER_TIERS[game.teachers.spec].salary) * (game.students / 150); 
        let upkeep = SCHOOL_LEVELS[game.levelIdx].upkeep * scale * (hasExpert('e2')?0.85:1);
        let exUpkeep = 0; game.unlockedExperts.forEach(id => { exUpkeep += EXPERT_POOL.find(x=>x.id===id).upkeep; });
        game.funds -= (totalSal + upkeep + exUpkeep);

        // 属性变动
        let fMain = game.schedule.main / 20; 
        game.grade += 1.0 * fMain * TEACHER_TIERS[game.teachers.main].multi;
        let stressGain = 1.5 * fMain * DIFF_MODS[game.diff !== undefined && DIFF_MODS[game.diff] ? game.diff : 1].stressMult;
        let clinicReduce = getFacLevelCount('clinic',0)*5 + getFacLevelCount('clinic',1)*10;
        if(getFacLevelCount('clinic',2)>0) stressGain = 0; else game.stress += Math.max(0, stressGain - clinicReduce);
        
        game.fitness += 0.5; game.art += 0.5;

        checkCrisis(); clampStats(); checkAchievements(); updateMailbox();
        applyAdjacencyBonuses(); // 建筑相邻加成
        // 政策折扣倒计时
        if(game.policyDiscount>0) game.policyDiscount--;
        // 月度目标刷新 + 教育局关系被动衰减 + 社区被动影响
        generateMonthlyTargets();
        initSocialRelations();
        // 教育局高好感带来政策拨款
        if(game.social && game.social.govRelations.edu_bureau >= 70) { game.funds += 5; }
        // 社区低好感带来声誉惩罚
        if(game.social && game.social.communityRel < 20) { game.reputation -= 5; log("🏘️ 社区居民持续投诉，声誉受损", "#ef4444"); }
        // 教师派系影响（年轻派占优→学业，传统派占优→纪律，改革派占优→艺术）
        if(game.social) {
            let f = game.social.teacherFactions;
            if(f.young >= 70) game.grade = Math.min(100, game.grade + 0.5);
            if(f.old >= 70) game.discipline = Math.min(100, game.discipline + 0.5);
            if(f.reform >= 70) game.art = Math.min(100, game.art + 0.5);
            let maxF = Math.max(f.young, f.old, f.reform);
            let minF = Math.min(f.young, f.old, f.reform);
            if(maxF - minF > 60) { game.stress = Math.min(100, game.stress + 2); }
        }

        // 触发特殊事件
        if (game.month === 3 || game.month === 11) { triggerExamSeason(); return; }
        if (game.month === 6) { triggerGaokao(); return; }
        if (Math.random() < 0.2) { 
            let e = EVENT_POOL[Math.floor(Math.random()*EVENT_POOL.length)];
            showCustomModal(`🎲 突发事件：${e.t}`, e.d, [
                {text: e.o1 + `<br><span class="event-eff">${e.a1.txt}</span>`, action:()=>{ if(e.a1.act()){updateUI();}else{advanceMonth();} }},
                {text: e.o2 + `<br><span class="event-eff">${e.a2.txt}</span>`, action:()=>{ e.a2.act(); updateUI(); }}
            ]);
            if(autoInterval) toggleAuto();
        } else updateUI();
    }
    
    function toggleAuto() {
        if(!game || !game.map) return showToast("请先选择难度开始游戏！");
        let btn = document.getElementById('btn-auto');
        if (autoInterval) { clearInterval(autoInterval); autoInterval = null; btn.classList.remove('active'); btn.innerText = "🤖 自动推演"; } 
        else { btn.classList.add('active'); btn.innerText = "🛑 停止推演"; autoInterval = setInterval(() => { if(document.getElementById('modal-overlay').style.display === 'flex' || bState.active) return; document.getElementById('btn-advance').click(); }, 1200); }
    }

    function clampStats() { ['grade', 'stress', 'discipline', 'fitness', 'art'].forEach(s => game[s] = Math.max(0, Math.min(100, game[s]))); game.students = Math.max(50, game.students); }
    
    function triggerGameOver(icon, title, reason) {
        if(game._gameOver) return;
        game._gameOver = true;
        if(autoInterval) toggleAuto();
        let rating = getGameRating();
        let yearsRun = game.year - 2018;
        let html = `<div style="text-align:center;">
            <div style="font-size:4rem;">${icon}</div>
            <h2 style="color:var(--danger); margin:5px 0;">${title}</h2>
            <p style="color:#475569;">${reason}，办学 <b>${yearsRun}</b> 年后画上句点。</p>
            <div style="background:#fef2f2; border:2px solid #fca5a5; border-radius:8px; padding:15px; margin:15px 0;">
                <div style="font-size:3rem; font-weight:900; color:${rating.color};">${rating.grade}</div>
                <div style="font-weight:bold; color:${rating.color};">${rating.name}</div>
                <p style="font-style:italic; color:#475569; margin:8px 0 0;">"${rating.quote}"</p>
            </div>
            <div style="background:#f8fafc; border-radius:8px; padding:12px; text-align:left; font-size:0.9rem;">
                <div>📚 学业：${Math.floor(game.grade)} | 😰 压力：${Math.floor(game.stress)} | 📏 纪律：${Math.floor(game.discipline)}</div>
                <div>⭐ 声誉：${Math.floor(game.reputation)} | 🎓 高考届数：${game.gaokaoHistory.length} | 🏆 联考积分：${game.examPoints}</div>
            </div>
        </div>`;
        showCustomModal(`💀 游戏结束 · ${title}`, html, [
            {text:"📜 查看完整结局", action:()=>{ showFinalRating('principal'); }},
            {text:"🔄 重新开始", action: hardReset}
        ]);
        let btn = document.getElementById('btn-advance');
        if(btn) { btn.disabled = true; btn.innerText = "💀 已终结 · 游戏结束"; btn.style.background = '#7f1d1d'; }
        let ratingBtn = document.getElementById('btn-final-rating');
        if(ratingBtn) ratingBtn.style.display = 'block';
    }

    function checkCrisis() { 
        if(game._gameOver) return true;
        // ① 资金破产
        if (game.funds < 0) { 
            game.funds = 0;
            triggerGameOver('💸','学校破产',`资金链断裂，您的学校在 ${game.year}年${game.month}月 宣告破产`);
            return true; 
        }
        // ② 声誉归零 - 被社会抛弃
        if(game.reputation <= 0) {
            game.reputation = 0;
            triggerGameOver('👎','声誉崩塌',`学校声誉彻底归零，教育局责令停办（${game.year}年${game.month}月）`);
            return true;
        }
        // ③ 连续3个月压力>90 - 压力崩溃
        if(!game._highStressMonths) game._highStressMonths = 0;
        if(game.stress >= 90) { game._highStressMonths++; } else { game._highStressMonths = 0; }
        if(game._highStressMonths >= 3) {
            triggerGameOver('💔','校园心理危机',`连续三个月全校压力爆表，恶性事件频发，教育局强制停办（${game.year}年${game.month}月）`);
            return true;
        }
        // ④ 纪律长期低下 - 学生暴动
        if(!game._lowDiscMonths) game._lowDiscMonths = 0;
        if(game.discipline <= 10) { game._lowDiscMonths++; } else { game._lowDiscMonths = 0; }
        if(game._lowDiscMonths >= 4) {
            triggerGameOver('🔥','学生暴动',`纪律长期崩溃，学生集体罢课并冲击校办，学校被迫停办（${game.year}年${game.month}月）`);
            return true;
        }
        // ⑤ 严重违规政策被查封 (政策反噬)
        if(game._govShutdown) {
            triggerGameOver('🏛️','政府查封',`学校违规行为被教育局举报彻查，强制停办（${game.year}年${game.month}月）`);
            return true;
        }
        return false;
    }

    // ================= 成就系统 =================
    function checkAchievements() {
        if(!game || !Array.isArray(game.achievements)) return;
        ACHIEVEMENTS.forEach(a => {
            if(!game.achievements.includes(a.id)) {
                let unlocked = false;
                if(a.id==='a1' && game.funds>=1000) unlocked=true;
                if(a.id==='a2' && game.funds>=10000) unlocked=true;
                if(a.id==='a3' && game.reputation>=10000) unlocked=true;
                if(a.id==='a4' && game.levelIdx>=4) unlocked=true;
                if(a.id==='a8' && game.stress>=100) unlocked=true;
                if(a.id==='a9' && game.discipline<=10) unlocked=true;
                if(a.id==='a13' && game.policies.length>=15) unlocked=true;
                if(a.id==='a16' && stuGame.active && stuGame.stress>=100) unlocked=true;
                // 其他隐藏成就通过游戏内事件直接触发
                if(unlocked) {
                    game.achievements.push(a.id);
                    showToast(`🏆 获得成就：${a.name}`);
                }
            }
        });
    }

    function renderAchievements() {
        let c = document.getElementById('achieve-container');
        c.innerHTML = ACHIEVEMENTS.map(a => {
            let has = game.achievements.includes(a.id);
            return `<div style="background:#fff; border:2px solid ${has?'var(--gold)':'#e2e8f0'}; padding:10px; border-radius:6px; opacity:${has?1:0.5}"><b>${a.name}</b><br><span style="font-size:0.75rem">${a.desc}</span></div>`;
        }).join('');
    }

    // ================= 战斗系统 V2.0 =================
    function triggerExamSeason() {
        if(autoInterval) toggleAuto();
        showBattlePrep();
    }

    function showBattlePrep() {
        openModal('modal-battle');
        document.getElementById('b-prep').style.display = 'block'; document.getElementById('b-main').style.display = 'none';
        
        // Expert squad selection section
        let squadHtml = `<div style="background:#0f172a; border:1px solid #a3e635; border-radius:8px; padding:15px; margin-bottom:25px;">
            <h3 style="color:#fde047; margin-top:0;">⚔️ 组建战斗编队 (选择 3-5 位专家)</h3>
            <p style="color:#94a3b8; font-size:0.85rem; margin-bottom:10px;">已选专家的技能组合将产生化学反应，带来额外增益。</p>
            <div style="display:flex; flex-wrap:wrap; gap:8px;" id="squad-selector">`;
        game.unlockedExperts.forEach(eid => {
            let ex = EXPERT_POOL.find(x=>x.id===eid);
            if(!ex || !ex.battle) return;
            let inSquad = (game.battleSquad||[]).includes(eid);
            squadHtml += `<button onclick="toggleSquad('${eid}',this)" style="background:${inSquad?'#14532d':'rgba(0,0,0,0.6)'}; border:1px solid ${inSquad?'#a3e635':'#3f6212'}; color:${inSquad?'#a3e635':'#94a3b8'}; padding:6px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem; transition:0.2s;">
                ${ex.name} <span style="font-size:0.65rem;">(${ex.rarity})</span>
            </button>`;
        });
        let squadCount = (game.battleSquad||[]).length;
        let synergy = getBattleSynergy();
        squadHtml += `</div>
            <div style="margin-top:10px; color:#fde047; font-size:0.85rem;">已选: <span id="squad-count">${squadCount}</span>/5 | ${synergy}</div>
        </div>`;
        
        let prepDiv = document.getElementById('b-prep');
        // Insert squad section at top if not already present
        let existingSquad = prepDiv.querySelector('.squad-section');
        if(!existingSquad) {
            let squadEl = document.createElement('div');
            squadEl.className = 'squad-section';
            squadEl.innerHTML = squadHtml;
            prepDiv.insertBefore(squadEl, prepDiv.querySelector('h2').nextSibling);
        } else {
            existingSquad.innerHTML = squadHtml;
        }
        
        let render = (list, id) => {
            let el = document.getElementById(id); el.innerHTML = '';
            list.forEach(r => {
                let unlocked = game.levelIdx + 1 >= r.tier;
                let html = `<div style="background:#0f172a; border:1px solid ${unlocked?'#4ade80':'#64748b'}; border-radius:6px; padding:10px; font-size:0.8rem; opacity:${unlocked?1:0.5}; position:relative;">
                    <div style="font-weight:bold; color:${unlocked?'#fff':'#94a3b8'}">${r.name}</div>
                    <div style="color:#fde047; margin:4px 0;">HP:${r.hp} ATK:${r.atk}</div>
                    <div style="color:#fca5a5; font-size:0.7rem; border-top:1px dashed #475569; padding-top:4px;"><b>特性:</b> ${r.traitName}</div>
                    ${unlocked ? `<button class="btn" style="margin-top:5px; padding:4px; font-size:0.8rem;" onclick="startBattle('${r.id}')">出征讨伐</button>` : '🔒 等级不足'}
                </div>`;
                el.innerHTML += html;
            });
        };
        render(RIVALS.filter(r=>r.tier===1), 'b-rival-t1');
        render(RIVALS.filter(r=>r.tier===2), 'b-rival-t2');
        render(RIVALS.filter(r=>r.tier===3), 'b-rival-t3');
        render(RIVALS.filter(r=>r.tier===4), 'b-rival-t4');
        render(RIVALS.filter(r=>r.tier===5), 'b-rival-t5');
    }
    
    function toggleSquad(eid, btn) {
        if(!game.battleSquad) game.battleSquad = [];
        let idx = game.battleSquad.indexOf(eid);
        if(idx >= 0) {
            game.battleSquad.splice(idx, 1);
            btn.style.background = 'rgba(0,0,0,0.6)'; btn.style.borderColor = '#3f6212'; btn.style.color = '#94a3b8';
        } else {
            if(game.battleSquad.length >= 5) return showToast("最多选择5名专家！");
            game.battleSquad.push(eid);
            btn.style.background = '#14532d'; btn.style.borderColor = '#a3e635'; btn.style.color = '#a3e635';
        }
        let c = document.getElementById('squad-count');
        if(c) c.innerText = game.battleSquad.length;
        let syn = document.querySelector('.squad-section');
        if(syn) { let sDiv = syn.querySelector('div[style*="fde047"]'); if(sDiv) { sDiv.innerHTML = `已选: <span id="squad-count">${game.battleSquad.length}</span>/5 | ${getBattleSynergy()}`; } }
    }
    
    function getBattleSynergy() {
        let squad = game.battleSquad || [];
        if(squad.length < 3) return `<span style="color:#94a3b8">需至少3人才能激活协同效应</span>`;
        // Check synergies
        let hasHealer = squad.some(id => ['e4','e18','e6'].includes(id));
        let hasAttacker = squad.some(id => ['e7','e11','e16'].includes(id));
        let hasDebuffer = squad.some(id => ['e1','e10','e19'].includes(id));
        let synergies = [];
        if(hasHealer && hasAttacker) synergies.push('<span style="color:#a3e635">⚡攻守兼备: 攻击+15%回血+1%</span>');
        if(hasDebuffer && hasAttacker) synergies.push('<span style="color:#fde047">💥 克制战术: 暴击率+20%</span>');
        if(squad.length >= 5) synergies.push('<span style="color:#c084fc">✨ 满编加成: 全属性+10%</span>');
        return synergies.length ? synergies.join(' | ') : '<span style="color:#64748b">无协同效应</span>';
    }

    function startBattle(rId) {
        let r = RIVALS.find(x => x.id === rId);
        document.getElementById('b-prep').style.display = 'none'; document.getElementById('b-main').style.display = 'flex';
        
        // 分校战斗增益（大幅加强）
        let branchBuff = { atk:1, def:1, hp:1, crit:0, ap:0 };
        if(hasBranch('b_hengshui')) { branchBuff.atk+=0.35; branchBuff.hp+=0.4; bLog && bLog("衡水分校：攻击+35% 血量+40%"); }
        if(hasBranch('b_beijing'))  { branchBuff.def+=0.4; branchBuff.ap+=10; }
        if(hasBranch('b_shanghai')) { branchBuff.crit+=20; }
        if(hasBranch('b_harvard'))  { branchBuff.atk+=0.4; branchBuff.def+=0.4; branchBuff.hp+=0.4; }
        if(hasBranch('b_oxford'))   { branchBuff.def+=0.3; branchBuff.hp+=0.3; }
        if(hasBranch('b_huanggang')){ branchBuff.atk+=0.5; } // 但每回合扣血
        
        // AP上限随等级提升
        let levelApBonus = game.levelIdx * 5;
        let initAp = Math.min(game.maxAp + levelApBonus, game.ap + levelApBonus + branchBuff.ap);

        bState = {
            active: true, isOver: false, turn: 1, phase: 'NORMAL', log: [], currentCat: 'atk',
            rivalId: rId, pts: r.pts, weather: WEATHER_TYPES[Math.floor(Math.random()*WEATHER_TYPES.length)],
            expertUsed: false,
            p: {
                maxHp: Math.floor((game.fitness * 100 + game.students * (10 + game.teachers.spec * 5)) * branchBuff.hp),
                atk: Math.floor(game.grade * (10 + game.teachers.main * 5) * branchBuff.atk),
                def: Math.floor(game.discipline * 8 * branchBuff.def),
                crit: Math.floor(game.art * 0.5 + branchBuff.crit),
                stress: 20, // 初始思维熵增20（非0）
                ap: initAp, maxAp: game.maxAp + levelApBonus, morale: 100,
                buffs: { atkUp:0, defUp:0, critUp:0, dmgUp:0, dodge:0, shield:0, hot:0, dot:0, stun:0, atkDown:0, defDown:0 }
            },
            e: {
                name: r.name, maxHp: r.hp, hp: r.hp, atk: r.atk, def: r.def, stress: 0, morale: 100, hasSummoned: false,
                buffs: { atkUp:0, defUp:0, shield:0, hot:0, stun:0, atkDown:0, defDown:0, dot:0 }
            }
        };
        bState.p.hp = bState.p.maxHp;
        
        // Apply squad synergy
        let squad = game.battleSquad || [];
        if(squad.length >= 3) {
            let hasHealer = squad.some(id => ['e4','e18','e6'].includes(id));
            let hasAttacker = squad.some(id => ['e7','e11','e16'].includes(id));
            let hasDebuffer = squad.some(id => ['e1','e10','e19'].includes(id));
            if(hasHealer && hasAttacker) { bState.p.atk = Math.floor(bState.p.atk * 1.15); bState.p.buffs.hot = 99; }
            if(hasDebuffer && hasAttacker) { bState.p.crit += 20; }
            if(squad.length >= 5) { bState.p.atk = Math.floor(bState.p.atk * 1.1); bState.p.def = Math.floor(bState.p.def * 1.1); }
        }

        // 渲染专家列表 (带技能说明)
        let exEl = document.getElementById('b-expert-list'); exEl.innerHTML = '';
        if(game.unlockedExperts.length === 0) {
            exEl.innerHTML = `<div style="color:#475569;font-size:0.8rem;padding:5px;">尚无专家可调用</div>`;
        }
        game.unlockedExperts.forEach(eid => {
            let ex = EXPERT_POOL.find(x=>x.id===eid);
            if(!ex || !ex.battle) return;
            let rarityColor = ex.rarity==='SSR'?'#fde047':ex.rarity==='SR'?'#c084fc':'#60a5fa';
            let btn = document.createElement('button');
            btn.style.cssText = `background:rgba(0,0,0,0.7);border:1px solid ${rarityColor};color:#e2e8f0;padding:6px 10px;border-radius:5px;cursor:pointer;font-size:0.72rem;display:flex;align-items:center;gap:6px;text-align:left;transition:0.2s;min-width:180px;`;
            btn.innerHTML = `<div style="width:28px;height:28px;border-radius:14px;overflow:hidden;flex-shrink:0;border:1px solid ${rarityColor};">
                <img src="src/expert/${eid}.png" onerror="this.style.display='none';this.parentNode.innerHTML='<div style=\\'background:${rarityColor};width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:0.6rem;color:#000;\\'>${ex.rarity}</div>'" style="width:100%;height:100%;object-fit:cover;">
            </div>
            <div>
                <div style="color:${rarityColor};font-weight:bold;">${ex.name}</div>
                <div style="color:#94a3b8;font-size:0.65rem;margin-top:1px;">${ex.desc}</div>
            </div>`;
            btn.onmouseover = () => btn.style.background = 'rgba(255,255,255,0.1)';
            btn.onmouseout = () => btn.style.background = 'rgba(0,0,0,0.7)';
            btn.onclick = () => useExpert(eid, btn);
            exEl.appendChild(btn);
        });

        document.getElementById('be-name').innerText = "> " + bState.e.name;
        document.getElementById('be-skill-desc').innerText = `${r.traitName}: ${r.traitDesc}`;
        document.getElementById('b-log').querySelector('.b-log-inner').innerHTML = `<span class="sys">战斗开始！遭遇 ${bState.e.name}！</span>`;
        bStartTurn();
    }

    function handleBuffs(entity, isPlayer) {
        let eName = isPlayer ? "我方" : "敌方";
        if(entity.buffs.dot > 0) {
            let dmg = Math.floor(entity.maxHp * 0.05);
            entity.hp -= dmg;
            bLog(`<span class="e">${eName} 受到毒素/流血伤害 ${dmg}！</span>`);
            entity.buffs.dot--;
        }
        if(entity.buffs.hot > 0) {
            let heal = Math.floor(entity.maxHp * 0.08);
            entity.hp = Math.min(entity.maxHp, entity.hp + heal);
            bLog(`<span class="p">${eName} 持续恢复了 ${heal} HP！</span>`);
            entity.buffs.hot--;
        }
        ['atkUp', 'defUp', 'critUp', 'dmgUp', 'shield', 'stun', 'atkDown', 'defDown'].forEach(k => {
            if(entity.buffs[k] > 0) entity.buffs[k]--;
        });
    }

    function bStartTurn() {
        if(bState.isOver || bCheckEnd()) return;
        bState.expertUsed = false;
        bLog(`<br><span style="color:#94a3b8">--- ROUND ${bState.turn} ---</span>`);
        
        // 天气系统
        if(!bState.weather || bState.turn % 3 === 0) { bState.weather = WEATHER_TYPES[Math.floor(Math.random()*WEATHER_TYPES.length)]; bLog(`☁️ 天气变更为：${bState.weather.name}`); }
        if(bState.weather && bState.weather.effect) bState.weather.effect(bState.p, bState.e);

        // AP恢复（每回合+3，上限由等级决定）
        bState.p.ap = Math.min(bState.p.maxAp, bState.p.ap + 3);
        
        // 思维熵增自然增长（每回合+2）
        bState.p.stress = Math.min(100, bState.p.stress + 2);
        // 敌方entropyDot（精神崩溃弹效果）
        if(bState.e.buffs.entropyDot > 0) {
            bState.e.stress = Math.min(100, bState.e.stress + 15);
            bState.e.buffs.entropyDot--;
            bLog(`<span style="color:#f472b6">敌方思维熵增发作！敌方压力+15（剩余${bState.e.buffs.entropyDot}回合）</span>`);
        }
        
        // 熵增混乱惩罚（熵增>70时攻防降低；熵增>90时完全混乱）
        let entropyPenalty = '';
        if(bState.p.stress >= 90) {
            bState.p.buffs.atkDown = Math.max(bState.p.buffs.atkDown, 1);
            bState.p.buffs.defDown = Math.max(bState.p.buffs.defDown, 1);
            entropyPenalty = '⚠️ 思维熵增极高！攻防大幅下降！';
        } else if(bState.p.stress >= 70) {
            entropyPenalty = '⚠️ 思维混乱，攻防轻度降低';
        }
        if(entropyPenalty) bLog(`<span style="color:#f59e0b">${entropyPenalty}</span>`);
        
        // BUFF 结算
        handleBuffs(bState.p, true);
        handleBuffs(bState.e, false);

        // 触发敌方特性
        let r = RIVALS.find(x=>x.id===bState.rivalId);
        if(r && r.traitEff) {
            let msg = r.traitEff(bState.p, bState.e);
            if(msg) bLog(`<span style="color:#fde047">[BOSS特性触发] ${msg}</span>`);
        }

        if(hasBranch('b_huanggang')) { bState.p.hp -= Math.floor(bState.p.maxHp*0.04); bLog("密卷反噬扣血！"); }
        if(bCheckEnd()) return;

        bUpdateUI();
        if(bState.p.stress >= 100) {
            bLog("🚨 思维熵增爆表，陷入混乱！跳过回合！"); bState.p.stress = 40; setTimeout(eAction, 1000);
        } else if(bState.p.buffs.stun > 0) {
            bLog("🚨 我方被晕眩，无法行动！"); setTimeout(eAction, 1000);
        } else {
            bShowCat(bState.currentCat);
            let btns = document.getElementById('b-expert-list').querySelectorAll('button');
            btns.forEach(b => b.disabled = false); 
        }
    }

    function useExpert(id, btn) {
        if(bState.expertUsed) return showToast("每回合只能指派一名专家！");
        let ex = EXPERT_POOL.find(x=>x.id===id);
        if(!ex || !ex.battle) return showToast("该专家无战斗技能");
        let msg = ex.battle(bState.p, bState.e);
        if(msg) { 
            bLog(`<span class="sys">⚡ [${ex.name}] 专家助阵: ${msg}</span>`); 
            bState.expertUsed = true; 
            btn.disabled = true;
            btn.style.background = '#374151';
            btn.style.color = '#6b7280';
            if(bCheckEnd()) return;
            bUpdateUI(); 
        }
    }

    // ===== 战斗视觉特效 =====
    function bFx(entityId, cls, label, color, size) {
        var el = document.getElementById(entityId);
        if(el) {
            el.classList.remove('b-hit','b-crit','b-heal','b-lunge');
            void el.offsetWidth;
            el.classList.add(cls);
            setTimeout(function(){ el.classList.remove(cls); }, 750);
        }
        if(label) {
            // Use battle container center as fallback; entityId tells us which side
            var bMain = document.getElementById('b-main');
            var r = el ? el.getBoundingClientRect() : null;
            var bx, by;
            if(r && r.width > 0) {
                bx = r.left + r.width * (0.2 + Math.random() * 0.5);
                by = r.top + r.height * 0.2;
            } else if(bMain) {
                var br = bMain.getBoundingClientRect();
                var isEnemy = entityId.indexOf('enemy') >= 0;
                bx = br.left + (isEnemy ? br.width * 0.65 : br.width * 0.2) + Math.random() * 60;
                by = br.top + br.height * 0.15;
            } else {
                bx = window.innerWidth * (entityId.indexOf('enemy') >= 0 ? 0.65 : 0.2);
                by = window.innerHeight * 0.3;
            }
            var f = document.createElement('div');
            f.className = 'b-dmg-float';
            f.style.cssText = 'left:'+Math.round(bx)+'px;top:'+Math.round(by)+'px;font-size:'+(size||'1.5rem')+';color:'+(color||'#ef4444')+';';
            f.textContent = label;
            document.body.appendChild(f);
            setTimeout(function(){ if(f.parentNode) f.remove(); }, 1700);
        }
    }
    function bScreenFlash(color, dur) {
        var f = document.getElementById('b-screen-flash');
        if(!f) return;
        f.style.background = color;
        f.style.animation = 'none';
        void f.offsetWidth;
        f.style.animation = `b-screen-flash ${dur||0.4}s ease-out forwards`;
        setTimeout(()=>{ f.style.animation='none'; f.style.opacity=0; }, (dur||0.4)*1000+50);
    }

    function pAction(sid) {
        let s = SKILL_DB[sid];
        if(!s) return console.error('Unknown skill:', sid);
        if(bState.p.ap < s.ap) return showToast("AP不足！");
        bState.p.ap -= s.ap;
        document.getElementById('b-skills-container').innerHTML = ''; // Lock UI

        bLog(`<span class="p">我方释放 [${s.name}]</span>`);
        
        // 判断技能类型并生效
        if(sid === 'sys_资本') {
            if(game.funds>=50) { game.funds-=50; bState.e.hp -= 9999; bLog("金钱的力量造成了毁灭性打击！"); }
            else bLog("资金不足以释放钞能力！");
        } else if(sid === 'insp_1') { 
            if(Math.random()<0.3) { bState.e.hp-=999; bLog("押中原题！造成999巨额真实伤害！"); } else { bState.e.hp-=10; bLog("押题失败...只造成了10点擦伤"); }
        } else if(s.cat === 'atk' || s.cat === 'insp') {
            let base = 1.0;
            let match = s.desc.match(/(\d+)%/);
            if(match) base = parseInt(match[1]) / 100;
            
            let rawAtk = bState.p.atk * (bState.p.buffs.atkUp>0 ? 1.5 : 1) * (bState.p.buffs.atkDown>0 ? 0.7 : 1);
            // 思维熵增≥70时攻击力衰减
            if(bState.p.stress >= 90) rawAtk *= 0.6;
            else if(bState.p.stress >= 70) rawAtk *= 0.8;
            let targetDef = bState.e.def * (bState.e.buffs.defUp>0 ? 1.5 : 1) * (bState.e.buffs.defDown>0 ? 0.3 : 1);
            
            // 部分技能无视防御
            if(s.desc.includes('无视部分防御')) targetDef *= 0.5;
            if(s.desc.includes('真实伤害')) targetDef = 0;
            
            let critRate = bState.p.crit + (bState.p.buffs.critUp>0 ? 50 : 0);
            let isCrit = Math.random()*100 < critRate || bState.p.buffs.dmgUp>0;
            
            let dmg = Math.max(10, rawAtk * base - targetDef);
            if(isCrit) { dmg *= (bState.p.buffs.dmgUp>0 ? 2.0 : 1.5); bLog(`<span class="crit">暴击！</span>`); }
            
            // 多段伤害处理
            let hitCount = 1;
            if(sid === 'atk_4') hitCount = 3;
            if(sid === 'atk_12') hitCount = 4;
            
            let totalDmg = 0;
            for(let i=0; i<hitCount; i++) {
                let currentHit = dmg;
                if(bState.e.buffs.shield > 0) { currentHit=0; bState.e.buffs.shield--; bLog("敌方护盾抵挡了伤害！"); }
                else { totalDmg += Math.floor(currentHit); }
            }
            
            bState.e.hp -= totalDmg;
            bLog(`造成 <span class="dmg">${totalDmg}</span> 点伤害`);
            // 视觉特效
            if(isCrit) { bFx('b-enemy-card','b-crit',`💥 ${totalDmg}`,'#fde047','2rem'); bScreenFlash('rgba(192,132,252,0.35)',0.5); }
            else { bFx('b-enemy-card','b-hit',`-${totalDmg}`,'#ef4444','1.5rem'); }

            
            // 技能附加效果
            if(sid==='atk_6') bState.e.buffs.defDown = 2;
            if(sid==='atk_7') bState.e.buffs.dot = 3;
            if(sid==='atk_8') bState.p.buffs.stun = 1;
            if(sid==='atk_9') bState.e.buffs.atkDown = 2;
        } else {
            // 非攻击技能
            if(sid==='def_0') bState.p.buffs.defUp = 2;
            if(sid==='def_1') { let h=Math.floor(bState.p.maxHp*0.15); bState.p.hp=Math.min(bState.p.maxHp,bState.p.hp+h); bState.p.buffs.atkDown=0; bState.p.buffs.defDown=0; bLog(`状态恢复 HP+${h}`); bFx('b-player-card','b-heal',`+${h}`,'#34d399','1.3rem'); }
            if(sid==='def_2') { bState.p.buffs.defUp=2; bState.p.ap+=5; }
            if(sid==='def_3') { bState.p.buffs.shield=1; bLog("获得护盾"); bScreenFlash('rgba(59,130,246,0.2)',0.35); }
            if(sid==='def_4') { bState.p.stress=Math.max(0,bState.p.stress-20); bLog("压力下降20"); bFx('b-player-card','b-heal','🧘-20压','#a78bfa','1.8rem'); }
            if(sid==='def_5') { bState.p.buffs.shield=2; bLog("获得巨额护盾"); bScreenFlash('rgba(59,130,246,0.3)',0.4); }
            if(sid==='def_6') { let h=Math.floor(bState.p.maxHp*0.3); bState.p.hp=Math.min(bState.p.maxHp,bState.p.hp+h); bState.p.buffs.hot=2; bLog(`名师点拨 HP+${h}，持续回血2回合`); bFx('b-player-card','b-heal',`+${h}`,'#34d399','1.5rem'); }
            if(sid==='def_7') { bState.p.buffs.dodge=1; bLog("进入闪避状态"); bScreenFlash('rgba(251,191,36,0.2)',0.3); }
            if(sid==='def_8') { bState.p.buffs.dmgUp=2; bLog("防守反击蓄力"); }
            if(sid==='def_9') { let h=Math.floor(bState.p.maxHp*0.1); bState.p.hp=Math.min(bState.p.maxHp,bState.p.hp+h); bState.p.buffs.dot=0; bState.p.buffs.stun=0; bLog(`闭目养神 HP+${h}`); bFx('b-player-card','b-heal',`+${h}`,'#34d399','1.2rem'); }
            
            if(sid==='sup_0') { bState.p.ap+=10; bFx('b-player-card','b-heal','AP+10','#60a5fa','1.3rem'); }
            if(sid==='sup_1') { let h=Math.floor(bState.p.maxHp*0.05); bState.p.hp=Math.min(bState.p.maxHp,bState.p.hp+h); bState.p.ap+=5; bFx('b-player-card','b-heal',`+${h}`,'#34d399','1.3rem'); }
            if(sid==='sup_2') { bState.p.buffs.atkUp=3; }
            if(sid==='sup_3') { bState.p.buffs.critUp=2; }
            if(sid==='sup_4') { bState.p.hp=bState.p.maxHp; bState.p.ap=game.maxAp; bLog("全员满状态复活！"); bFx('b-player-card','b-heal','✨ 满血复活','#fde047','1.6rem'); bScreenFlash('rgba(253,224,71,0.4)',0.6); }
            if(sid==='sup_5') { bState.p.buffs.atkUp=2; bState.p.buffs.defUp=2; bState.p.buffs.critUp=2; bLog("考神附体全属性提升！"); bScreenFlash('rgba(251,191,36,0.3)',0.5); }

            if(sid==='psy_0') { bState.e.stress+=15; bFx('b-enemy-card','b-hit','⚡压力+15','#f59e0b','1.3rem'); }
            if(sid==='psy_1') { bState.e.stress+=25; bState.e.buffs.defDown=2; bFx('b-enemy-card','b-hit','💥压力+25','#f59e0b','1.5rem'); }
            if(sid==='psy_2') { bState.e.buffs.atkDown=3; bLog("敌方攻击大幅下降"); bFx('b-enemy-card','b-hit','⬇ATK','#94a3b8','1.3rem'); }
            if(sid==='psy_3') { let dpct=Math.floor(bState.e.hp*0.2); bState.e.hp -= dpct; bLog("敌方心态受创百分比扣血"); bFx('b-enemy-card','b-hit',`-${dpct}`,'#ef4444','1.5rem'); }
            if(sid==='psy_4') { bState.e.buffs.stun=1; let dp=Math.floor(bState.p.atk*2); bState.e.hp -= dp; bLog("叫家长威力巨大！"); bFx('b-enemy-card','b-crit',`👨‍👩‍👦 -${dp}`,'#fde047','1.7rem'); bScreenFlash('rgba(239,68,68,0.25)',0.4); }
            if(sid==='psy_5') { bState.e.buffs.atkDown=2; bState.e.buffs.defDown=2; bFx('b-enemy-card','b-hit','⬇⬇崩溃','#c084fc','1.4rem'); }

            if(sid==='sys_衡水') { bState.p.buffs.atkUp=5; bState.p.hp-=Math.floor(bState.p.maxHp*0.2); bLog("开启狂暴模式！"); bScreenFlash('rgba(239,68,68,0.4)',0.5); bFx('b-player-card','b-crit','🔥狂暴','#ef4444','1.8rem'); }
            if(sid==='sys_素质') { bState.p.buffs.atkUp=3; bState.p.buffs.defUp=3; bState.p.buffs.hot=3; bState.p.stress=0; bLog("素质乌托邦降临！"); bScreenFlash('rgba(16,185,129,0.3)',0.6); bFx('b-player-card','b-heal','🌈乌托邦','#34d399','1.6rem'); }

            // 熵增系技能
            if(sid==='ent_0') { bState.p.stress=0; bLog("🧘 冥想净化！思维熵增全部清除！"); bFx('b-player-card','b-heal','🧘清零','#a78bfa','1.5rem'); }
            if(sid==='ent_1') { bState.p.stress=Math.max(0,bState.p.stress-40); bState.p.buffs.atkUp=2; bLog("心流状态！压力-40，进入专注模式！"); bFx('b-player-card','b-heal','⚡心流','#a78bfa','1.5rem'); }
            if(sid==='ent_2') { let transfer=Math.floor(bState.p.stress*0.5); bState.e.stress+=transfer; bState.p.stress-=transfer; bLog(`熵增传导！将${transfer}点压力转移给敌方！`); bFx('b-enemy-card','b-hit',`💀+${transfer}压`,'#f59e0b','1.4rem'); }
            if(sid==='ent_3') { bState.e.buffs.entropyDot=(bState.e.buffs.entropyDot||0)+3; bLog("精神崩溃弹！敌方思维熵增每回合+15，持续3回合！"); bFx('b-enemy-card','b-hit','💣崩溃弹','#c084fc','1.4rem'); }
            if(sid==='ent_4') { bState.e.stress+=30; bState.e.buffs.stun=1; bLog("虚空凝视！敌方压力+30，下回合封印！"); bFx('b-enemy-card','b-crit','👁封印','#818cf8','1.6rem'); bScreenFlash('rgba(99,102,241,0.3)',0.4); }
            if(sid==='ent_5') { let heal=Math.floor(bState.p.stress*20); bState.p.hp=Math.min(bState.p.maxHp,bState.p.hp+heal); bState.p.stress=0; bLog(`浴火重生！燃尽压力，回复${heal}HP！`); bFx('b-player-card','b-heal',`🔥+${heal}`,'#f97316','1.7rem'); bScreenFlash('rgba(249,115,22,0.35)',0.6); }
        }

        bUpdateUI();
        if(bCheckEnd()) return;
        setTimeout(eAction, 1000);
    }

    function eAction() {
        if(bState.isOver) return;
        if(bState.e.buffs.stun > 0) { bLog("敌方晕眩中，跳过回合..."); setTimeout(nextTurn, 1000); return; }

        let rawAtk = bState.e.atk * (bState.e.buffs.atkUp>0 ? 1.5 : 1) * (bState.e.buffs.atkDown>0 ? 0.7 : 1);
        let targetDef = bState.p.def * (bState.p.buffs.defUp>0 ? 1.5 : 1) * (bState.p.buffs.defDown>0 ? 0.3 : 1);
        
        let dmg = Math.max(10, rawAtk - targetDef);
        
        // 敌方攻击动画
        bFx('b-enemy-card','b-lunge',null,null,null);

        if(bState.p.buffs.dodge > 0) {
            dmg = 0; bLog("我方完美闪避了攻击！"); bState.p.buffs.dodge--;
            bFx('b-player-card','b-heal','⚡闪避','#fde047','1.4rem');
        } else if(bState.p.buffs.shield > 0) {
            dmg = 0; bLog("我方护盾抵挡了攻击！"); bState.p.buffs.shield--;
            bFx('b-player-card','b-heal','🛡','#60a5fa','1.8rem');
        } else {
            let fdmg = Math.floor(dmg);
            bState.p.hp -= fdmg;
            bLog(`<span class="e">敌方攻击造成 ${fdmg} 伤害</span>`);
            bFx('b-player-card','b-hit',`-${fdmg}`,'#fca5a5','1.5rem');
            bScreenFlash('rgba(239,68,68,0.2)',0.4);
        }
        
        bUpdateUI();
        if(bCheckEnd()) return;
        setTimeout(nextTurn, 1000);
    }

    function nextTurn() { bState.turn++; bStartTurn(); }

    function bCheckEnd() {
        if(bState.isOver) return true;
        if(bState.e.hp <= 0) {
            bState.isOver = true;
            let finalPts = bState.pts * 2;
            let finalMoney = bState.pts * 20; 
            let repGain = Math.floor(bState.pts * 0.2); // 大幅降低声誉奖励
            game.examPoints += finalPts; game.funds += finalMoney; game.reputation += repGain;
            if(bState.rivalId === 't5_3' && !game.achievements.includes('a17')) { game.achievements.push('a17'); showToast("达成成就：密卷克星"); }
            showCustomModal("🏆 史诗大捷", `获得 ${finalPts} 积分，奖金 ￥${finalMoney}万，声誉 +${repGain}！`, [{text:"确定", action:()=>{ closeModal('modal-battle'); bState.active=false; updateUI(); }}]);
            return true;
        }
        if(bState.p.hp <= 0) {
            bState.isOver = true;
            game.reputation -= 30; // 失败扣声誉
            showCustomModal("💀 惨败", "全军覆没，声誉严重受损。但学校基金会已为您兜底，资金未受损失。", [{text:"确定", action:()=>{ closeModal('modal-battle'); bState.active=false; updateUI(); }}]);
            return true;
        }
        return false;
    }

    function bLog(msg) { 
        let inner = document.getElementById('b-log').querySelector('.b-log-inner');
        inner.innerHTML += msg + '<br>'; 
        document.getElementById('b-log').scrollTop = document.getElementById('b-log').scrollHeight;
    }

    function bUpdateUI() {
        let p = bState.p; let e = bState.e;
        document.getElementById('b-weather-ui').innerHTML = `<b>${bState.weather.name}</b><br><span style="font-size:0.65rem">${bState.weather.desc}</span>`;
        document.getElementById('bp-hp-bar').style.width = Math.max(0, p.hp/p.maxHp*100) + '%';
        document.getElementById('bp-hp-txt').innerText = `${Math.floor(p.hp)}/${p.maxHp}`;
        document.getElementById('be-hp-bar').style.width = Math.max(0, e.hp/e.maxHp*100) + '%';
        document.getElementById('be-hp-txt').innerText = `${Math.floor(e.hp)}/${e.maxHp}`;
        document.getElementById('bp-ap').innerText = p.ap;
        document.getElementById('bp-atk').innerText = Math.floor(p.atk * (p.buffs.atkUp>0?1.5:1) * (p.buffs.atkDown>0?0.7:1));
        document.getElementById('be-atk').innerText = Math.floor(e.atk * (e.buffs.atkUp>0?1.5:1) * (e.buffs.atkDown>0?0.7:1));
        document.getElementById('bp-def').innerText = Math.floor(p.def * (p.buffs.defUp>0?1.5:1) * (p.buffs.defDown>0?0.3:1));
        document.getElementById('be-def').innerText = Math.floor(e.def * (e.buffs.defUp>0?1.5:1) * (e.buffs.defDown>0?0.3:1));
        
        let getBuffsStr = (buffObj) => {
            let res = [];
            if(buffObj.atkUp) res.push("⚔️攻↑"); if(buffObj.defUp) res.push("🛡️防↑");
            if(buffObj.atkDown) res.push("📉攻↓"); if(buffObj.defDown) res.push("📉防↓");
            if(buffObj.shield) res.push("🔰护盾"); if(buffObj.dodge) res.push("💨闪避");
            if(buffObj.hot) res.push("💖回血"); if(buffObj.dot) res.push("☠️中毒");
            if(buffObj.stun) res.push("💫晕眩"); if(buffObj.critUp) res.push("⚡暴击↑");
            return res.join(' ') || '无';
        }
        document.getElementById('bp-buffs').innerText = "BUFFS: " + getBuffsStr(p.buffs);
        document.getElementById('be-buffs').innerText = "BUFFS: " + getBuffsStr(e.buffs);
        
        document.getElementById('b-turn-ui').innerText = bState.turn;
    }

    function bShowCat(cat) {
        bState.currentCat = cat;
        document.querySelectorAll('.b-cat-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`cat-${cat}`).classList.add('active');

        let c = document.getElementById('b-skills-container'); c.innerHTML = '';
        for(let k in SKILL_DB) {
            let s = SKILL_DB[k];
            if(s.cat === cat) {
                let unlocked = s.req();
                let btn = document.createElement('button');
                btn.className = 'b-skill-btn';
                btn.disabled = !unlocked || bState.p.ap < s.ap;
                btn.innerHTML = `<div class="b-s-name">${s.name} (AP:${s.ap})</div>
                                 <div class="b-s-desc">${unlocked ? s.desc : `<span style="color:#ef4444">条件未满足: ${s.reqDesc}</span>`}</div>`;
                btn.onclick = () => pAction(k);
                c.appendChild(btn);
            }
        }
        // 渲染组合技
        if(cat==='combo' && game.combos && game.combos.length) {
            let div = document.createElement('div');
            div.innerHTML = renderComboSkills();
            c.appendChild(div);
        } else if(cat==='combo') {
            c.innerHTML = '<div style="color:#64748b;padding:15px;font-size:0.85rem;">尚未研发任何组合技。前往研发中心解锁。</div>';
        }
    }
    
    function bRetreat() {
        showCustomModal("🏳️ 确认撤退？", "撤退视为逃兵！声誉将减少50点。", [
            {text:"✅ 确认撤退", action:()=>{ bState.isOver = true; game.reputation -= 50; closeModal('modal-battle'); bState.active=false; updateUI(); }},
            {text:"❌ 继续战斗", action:()=>{}}
        ]);
    }

    // ================= 相邻奖励系统 =================
    const ADJACENCY_BONUSES = [
        { pair: ['library','lab'],     name:'知识共振', desc:'图书馆+实验楼相邻: 每月教研点+3', apply:(p,e)=>{ if(p&&e) game.eduPoints+=3; } },
        { pair: ['clinic','track'],    name:'身心健康', desc:'心理诊所+操场相邻: 压力每月额外-5', apply:(p,e)=>{ if(p&&e) game.stress=Math.max(0,game.stress-5); } },
        { pair: ['confucius','hall'],  name:'礼乐合一', desc:'孔子圣像+大礼堂相邻: 声誉每月+15', apply:(p,e)=>{ if(p&&e) game.reputation+=15; } },
        { pair: ['media','lab'],       name:'智慧校园', desc:'电教大楼+实验楼相邻: 学业倍率额外+3%', apply:(p,e)=>{ if(p&&e) game.grade=Math.min(100,game.grade+0.5); } },
        { pair: ['dorm','hospital'],   name:'贵族医疗', desc:'贵族公寓+校医院相邻: 每月资金+20', apply:(p,e)=>{ if(p&&e) game.funds+=20; } },
        { pair: ['art','confucius'],   name:'文化圣地', desc:'艺术中心+孔子圣像相邻: 纪律+5', apply:(p,e)=>{ if(p&&e) game.discipline=Math.min(100,game.discipline+5); } },
        { pair: ['track','hospital'],  name:'运动康复', desc:'操场+校医院相邻: 体质每月+2', apply:(p,e)=>{ if(p&&e) game.fitness=Math.min(100,game.fitness+2); } },
        { pair: ['library','art'],     name:'人文荟萃', desc:'图书馆+艺术中心相邻: 艺术+3', apply:(p,e)=>{ if(p&&e) game.art=Math.min(100,game.art+3); } },
        { pair: ['hall','dorm'],       name:'华贵套院', desc:'大礼堂+贵族公寓相邻: AP上限+2', apply:(p,e)=>{ if(p&&e) game.maxAp=Math.min(50,game.maxAp+2); } },
    ];

    // 检查地图上是否有两种类型的建筑相邻（4格相邻，地图为5列）
    function checkAdjacency(typeA, typeB) {
        const cols = 5;
        let posA = [], posB = [];
        game.map.forEach((f,i)=>{ if(f&&f.id===typeA) posA.push(i); if(f&&f.id===typeB) posB.push(i); });
        for(let a of posA) for(let b of posB) {
            let dr = Math.abs(Math.floor(a/cols)-Math.floor(b/cols));
            let dc = Math.abs((a%cols)-(b%cols));
            if((dr===1&&dc===0)||(dr===0&&dc===1)) return true;
        }
        return false;
    }

    function applyAdjacencyBonuses() {
        if(!game||!game.map) return;
        ADJACENCY_BONUSES.forEach(ab=>{
            let hasAdj = checkAdjacency(ab.pair[0],ab.pair[1]);
            ab.apply(hasAdj, hasAdj);
        });
    }

    function getActiveAdjacencies() {
        if(!game||!game.map) return [];
        return ADJACENCY_BONUSES.filter(ab=>checkAdjacency(ab.pair[0],ab.pair[1]));
    }

    // ================= 商店系统 =================
    const SHOP_ITEMS = {
        infra: [
            { id:'blueprint', name:'建筑蓝图（随机）', desc:'解锁一种未建造的特殊建筑', icon:'📐', costType:'funds', cost:200, limitType:'perm', limit:2,
              action:()=>{ let built=game.map.filter(x=>x).map(x=>x.id); let avail=Object.keys(FACILITIES).filter(k=>!built.includes(k)); if(!avail.length)return showToast("所有建筑已解锁！"); let chosen=avail[Math.floor(Math.random()*avail.length)]; let slot=game.map.findIndex(x=>!x); if(slot<0)return showToast("地块已满！"); game.map[slot]={id:chosen,level:0}; showToast(`📐 获得蓝图：${FACILITIES[chosen].levels[0].name}！`); } },
            { id:'landcard', name:'土地扩容卡', desc:'增加1块可建造地块（最多25块）', icon:'🗺️', costType:'funds', cost:500, limitType:'perm', limit:5,
              action:()=>{ if(game.map.length>=25)return showToast("已达最大地块数！"); game.map.push(null); showToast("🗺️ 地块扩张！当前"+game.map.length+"块"); } },
        ],
        teacher: [
            { id:'headhunt', name:'名师猎头券', desc:'下次寻访必得SR及以上', icon:'🎯', costType:'edu', cost:150, limitType:'monthly', limit:2,
              action:()=>{ game.nextGachaGuarantee='SR'; showToast("🎯 下次寻访保底SR！"); } },
            { id:'trainpkg', name:'教师培训礼包', desc:'任选一科教师组升一级', icon:'📦', costType:'funds', cost:180, limitType:'perm', limit:3,
              action:()=>{ showCustomModal("📦 选择培训科目","",[{text:"主科组升级",action:()=>{if(game.teachers.main<5){game.teachers.main++;updateUI();showToast("主科升级！");}}},{text:"副科组升级",action:()=>{if(game.teachers.minor<5){game.teachers.minor++;updateUI();showToast("副科升级！");}}},{text:"素质组升级",action:()=>{if(game.teachers.spec<5){game.teachers.spec++;updateUI();showToast("素质升级！");}}}]); } },
            { id:'ssr_studio', name:'特级教师工作室', desc:'直接解锁一位SSR专家（自选）', icon:'⭐', costType:'exam', cost:300, limitType:'perm', limit:1,
              action:()=>{ let ssrPool=EXPERT_POOL.filter(e=>e.rarity==='SSR'&&!hasExpert(e.id)); if(!ssrPool.length)return showToast("SSR专家已全部招募！"); showCustomModal("⭐ 选择SSR专家","",ssrPool.map(e=>({text:e.name+' - '+e.desc,action:()=>{game.unlockedExperts.push(e.id);renderModals();updateUI();showToast("获得："+e.name);}}))); } },
        ],
        policy: [
            { id:'policy_fast', name:'政策速通手册', desc:'教研点消耗-20%，持续3个月', icon:'📋', costType:'funds', cost:300, limitType:'perm', limit:2,
              action:()=>{ game.policyDiscount=(game.policyDiscount||0)+3; showToast("📋 教研点消耗-20%，持续3个月！"); } },
            { id:'media_ctrl', name:'舆论操控指南', desc:'媒体关系+30（一次性）', icon:'📢', costType:'funds', cost:120, limitType:'none', limit:99,
              action:()=>{ initSocialRelations(); game.social.govRelations.media=Math.min(100,game.social.govRelations.media+30); showToast("📢 媒体关系+30！"); } },
            { id:'inspect_pass', name:'教育局免检金牌', desc:'下次视察自动通过，压力不增', icon:'🥇', costType:'exam', cost:100, limitType:'monthly', limit:1,
              action:()=>{ game.inspectImmune=true; showToast("🥇 下次视察自动通过！"); } },
        ],
        consume: [
            { id:'ap_potion', name:'精力恢复剂', desc:'立即恢复5点AP', icon:'⚡', costType:'funds', cost:50, limitType:'monthly', limit:3,
              action:()=>{ game.ap=Math.min(game.maxAp,game.ap+5); updateUI(); showToast("⚡ AP+5！"); } },
            { id:'stress_course', name:'全校减压课程', desc:'全校压力-10', icon:'😌', costType:'funds', cost:100, limitType:'monthly', limit:2,
              action:()=>{ game.stress=Math.max(0,game.stress-10); updateUI(); showToast("😌 全校压力-10！"); } },
            { id:'rep_shield', name:'声誉保护伞', desc:'当月声誉下降事件-50%影响', icon:'🛡️', costType:'funds', cost:80, limitType:'monthly', limit:1,
              action:()=>{ game.repShield=true; showToast("🛡️ 本月声誉受损减半！"); } },
        ],
        special: [
            { id:'hourglass', name:'时光沙漏', desc:'立即推进一月（不触发事件）', icon:'⏳', costType:'funds', cost:350, limitType:'perm', limit:3,
              action:()=>{ game.month++; if(game.month>12){game.month=1;game.year++;} game.ap=Math.min(game.maxAp,game.ap+game.maxAp); updateUI(); showToast("⏳ 时间跳跃！推进一月！"); } },
            { id:'compass', name:'命运罗盘', desc:'随机获得一项未解锁成就', icon:'🧭', costType:'edu', cost:200, limitType:'perm', limit:1,
              action:()=>{ let unowned=ACHIEVEMENTS.filter(a=>!game.achievements.includes(a.id)); if(!unowned.length)return showToast("成就已全部解锁！"); let pick=unowned[Math.floor(Math.random()*unowned.length)]; game.achievements.push(pick.id); showToast("🧭 获得成就："+pick.name+"！"); } },
            { id:'shard', name:'隐藏建筑碎片', desc:'集齐3片兑换"孔子学院总部"', icon:'💎', costType:'exam', cost:80, limitType:'perm', limit:99,
              action:()=>{ game.shards=(game.shards||0)+1; showToast(`💎 碎片+1，已有${game.shards}/3片`); if(game.shards>=3){ game.shards-=3; let slot=game.map.findIndex(x=>!x); if(slot<0)return showToast("地块已满，兑换失败！"); game.map[slot]={id:'confucius',level:2}; showToast("🏛️ 解锁！孔子学院总部建立！"); } } },
        ]
    };

    // 商店购买记录存储
    function getShopData() {
        if(!game.shopData) game.shopData = { permBought:{}, monthlyBought:{}, month:game.month };
        if(game.shopData.month !== game.month) { game.shopData.monthlyBought={}; game.shopData.month=game.month; }
        return game.shopData;
    }

    function renderShop(cat) {
        let el = document.getElementById('shop-content');
        if(!el) return;
        let items = SHOP_ITEMS[cat] || [];
        let sd = getShopData();
        let html = '';
        items.forEach(item => {
            let bought = item.limitType==='perm' ? (sd.permBought[item.id]||0) : (sd.monthlyBought[item.id]||0);
            let remaining = item.limit - bought;
            let canAfford = item.costType==='funds' ? game.funds>=item.cost
                          : item.costType==='edu'   ? game.eduPoints>=item.cost
                          : game.examPoints>=item.cost;
            let costLabel = item.costType==='funds' ? `￥${item.cost}万`
                          : item.costType==='edu'   ? `教研点${item.cost}`
                          : `联考积分${item.cost}`;
            let limitLabel = item.limitType==='perm' ? `永久限${item.limit}`
                           : item.limitType==='monthly' ? `每月限${item.limit}` : '无限制';
            let soldOut = remaining <= 0;
            html += `<div style="background:#f8fafc;border:2px solid ${soldOut?'#e2e8f0':canAfford?'#3b82f6':'#fca5a5'};border-radius:10px;padding:14px;display:flex;flex-direction:column;gap:6px;">
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:1.8rem;">${item.icon}</span>
                    <div>
                        <div style="font-weight:bold;color:#1e293b;">${item.name}</div>
                        <div style="font-size:0.78rem;color:#64748b;">${item.desc}</div>
                    </div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
                    <span style="font-size:0.8rem;color:#64748b;">剩余:<b style="color:${remaining>0?'#10b981':'#ef4444'}">${remaining}</b> | ${limitLabel}</span>
                    <button class="btn" style="padding:5px 14px;font-size:0.85rem;${soldOut?'opacity:0.4;cursor:not-allowed;':''}${canAfford?'':'border-color:#ef4444;color:#ef4444;'}"
                        ${soldOut?'disabled':''} onclick="buyShopItem('${cat}','${item.id}')">
                        ${soldOut?'已售完':costLabel}
                    </button>
                </div>
            </div>`;
        });
        el.innerHTML = html || '<p style="color:#64748b;">暂无商品</p>';
    }

    function buyShopItem(cat, itemId) {
        let item = (SHOP_ITEMS[cat]||[]).find(x=>x.id===itemId);
        if(!item) return;
        let sd = getShopData();
        let bought = item.limitType==='perm' ? (sd.permBought[itemId]||0) : (sd.monthlyBought[itemId]||0);
        if(bought >= item.limit) return showToast("已达购买上限！");
        if(item.costType==='funds') { if(!payCost(0,item.cost)) return; }
        else if(item.costType==='edu') { if(game.eduPoints<item.cost)return showToast("教研点不足！"); game.eduPoints-=item.cost; }
        else { if(game.examPoints<item.cost)return showToast("联考积分不足！"); game.examPoints-=item.cost; }
        if(item.limitType==='perm') sd.permBought[itemId]=(sd.permBought[itemId]||0)+1;
        else if(item.limitType==='monthly') sd.monthlyBought[itemId]=(sd.monthlyBought[itemId]||0)+1;
        item.action();
        updateUI();
        renderShop(cat);
    }

    // ================= 周课表系统 =================
    // 课表：5天 × 8节 = 40格，存储在 game.weeklyTable (数组40个元素: 'main'/'minor'/'spec'/null)
    function initWeeklyTable() {
        if(!game.weeklyTable || game.weeklyTable.length !== 40) {
            game.weeklyTable = new Array(40).fill(null);
            // 默认排课
            randomizeScheduleData();
        }
    }

    function randomizeSchedule() {
        randomizeScheduleData();
        renderWeeklyTimetable();
        syncScheduleFromTable();
    }

    function randomizeScheduleData() {
        if(!game) return;
        let m = game.schedule.main || 20, mi = game.schedule.minor || 15, sp = game.schedule.spec || 5;
        let slots = new Array(40).fill(null);
        let place = (type, count) => {
            let placed = 0, tries = 0;
            while(placed < count && tries < 200) {
                let idx = Math.floor(Math.random()*40);
                if(!slots[idx]) { slots[idx]=type; placed++; }
                tries++;
            }
        };
        place('main', Math.min(m,40)); place('minor', Math.min(mi, 40 - Math.min(m,40)));
        place('spec', Math.min(sp, 40 - Math.min(m,40) - Math.min(mi,40)));
        game.weeklyTable = slots;
    }

    function renderWeeklyTimetable() {
        let el = document.getElementById('weekly-timetable');
        if(!el) return;
        initWeeklyTable();
        const days = ['一','二','三','四','五'];
        const periods = ['第1节','第2节','第3节','第4节','午休','第5节','第6节','第7节'];
        const COLOR = { main:'#fecaca', minor:'#bfdbfe', spec:'#bbf7d0', null:'#f1f5f9' };
        const LABEL = { main:'📚主科', minor:'🔬副科', spec:'🎨素质', null:'—' };
        const CYCLE = [null,'main','minor','spec'];
        // Header row
        let html = `<div style="background:#e2e8f0;border-radius:3px;padding:4px;text-align:center;font-weight:bold;">节次</div>`;
        days.forEach(d=>{ html+=`<div style="background:#e2e8f0;border-radius:3px;padding:4px;text-align:center;font-weight:bold;">周${d}</div>`; });
        // Body
        periods.forEach((p,row)=>{
            html+=`<div style="background:#f8fafc;border-radius:3px;padding:4px;text-align:center;color:#64748b;font-size:0.7rem;">${p}</div>`;
            days.forEach((_,col)=>{
                if(p==='午休'){ html+=`<div style="background:#fef9c3;border-radius:3px;padding:4px;text-align:center;color:#a16207;font-size:0.7rem;" colspan="5">午休</div>`; return; }
                let realRow = row > 3 ? row - 1 : row; // skip lunch visually
                let idx = realRow * 5 + col;
                if(row === 4) return; // handled above
                let type = game.weeklyTable[idx] || null;
                html+=`<div onclick="cycleCell(${idx})" style="background:${COLOR[type]};border-radius:3px;padding:4px;text-align:center;cursor:pointer;transition:0.15s;font-size:0.68rem;" title="点击切换">${LABEL[type]||'—'}</div>`;
            });
        });
        el.innerHTML = html;
    }

    function cycleCell(idx) {
        const CYCLE = [null,'main','minor','spec'];
        let cur = game.weeklyTable[idx];
        let next = CYCLE[(CYCLE.indexOf(cur)+1) % CYCLE.length];
        game.weeklyTable[idx] = next;
        syncScheduleFromTable();
        renderWeeklyTimetable();
    }

    function syncScheduleFromTable() {
        if(!game.weeklyTable) return;
        let m=0,mi=0,sp=0;
        game.weeklyTable.forEach(t=>{ if(t==='main')m++; else if(t==='minor')mi++; else if(t==='spec')sp++; });
        game.schedule.main = m; game.schedule.minor = mi; game.schedule.spec = sp;
        let ml=document.getElementById('lbl-main-hr'),ml2=document.getElementById('range-main');
        let mml=document.getElementById('lbl-minor-hr'),mml2=document.getElementById('range-minor');
        let sl=document.getElementById('lbl-spec-hr'),sl2=document.getElementById('range-spec');
        let tl=document.getElementById('sch-total-hr');
        if(ml)ml.innerText=m+'节'; if(ml2)ml2.value=m;
        if(mml)mml.innerText=mi+'节'; if(mml2)mml2.value=mi;
        if(sl)sl.innerText=sp+'节'; if(sl2)sl2.value=sp;
        if(tl)tl.innerText=m+mi+sp;
    }

    // Override adjustSchedule to also re-render timetable
    function openScheduleModal() { 
        openModal('modal-schedule'); 
        initWeeklyTable(); 
        renderWeeklyTimetable(); 
    }

    function renderAdjacencyPanel() {
        let el = document.getElementById('adjacency-panel');
        if(!el) return;
        let active = getActiveAdjacencies();
        if(!active.length) { el.innerHTML='<p style="color:#94a3b8;font-size:0.8rem;">暂无相邻加成（将相符建筑放置于相邻格可激活）</p>'; return; }
        el.innerHTML = active.map(ab=>`<div style="background:#f0fdf4;border:1px solid #86efac;border-radius:6px;padding:6px 10px;font-size:0.78rem;"><b style="color:#15803d;">✨ ${ab.name}</b><br><span style="color:#166534;">${ab.desc}</span></div>`).join('');
    }

    // ================= 其它系统 =================
    function renderModals() {
        if(!game || !game.map || !Array.isArray(game.map)) return;
        // 地图
        let mGrid = document.getElementById('map-grid'); mGrid.innerHTML = '';
        game.map.forEach((fac, idx) => {
            let div = document.createElement('div'); div.className = 'map-cell' + (idx === selectedMapIndex ? ' selected' : '');
            if(fac) {
                let fData = FACILITIES[fac.id];
                let adj = getActiveAdjacencies().some(ab=>ab.pair.includes(fac.id));
                div.innerHTML = `<span style="font-size:1.8rem;">${fData.icon}</span><span style="font-size:0.75rem;">${fData.levels[fac.level].name}</span>${adj?'<span style="position:absolute;top:2px;right:2px;font-size:0.6rem;background:#fde047;border-radius:3px;padding:1px 3px;color:#713f12;">✨邻</span>':''}`;
                div.style.position='relative';
            } else div.innerHTML = `<span style="color:#a3e635;font-size:2rem;">+</span>`;
            div.onclick = () => { selectedMapIndex = idx; renderFacDetail(); }; mGrid.appendChild(div);
        });
        renderFacDetail();
        renderAdjacencyPanel();
        
        // 专家
        let ehtml = ''; EXPERT_POOL.forEach(e => {
            if(hasExpert(e.id)) {
                let typeTag = e.battle ? '<span class="type-tag type-battle">战斗型</span>' : '<span class="type-tag type-passive">内政型</span>';
                ehtml += `<div class="gacha-card rarity-${e.rarity}">
                    <img src="src/expert/${e.id}.png" class="expert-img" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'50\\' height=\\'50\\'><rect width=\\'50\\' height=\\'50\\' fill=\\'%23e2e8f0\\'/><text x=\\'50%\\' y=\\'50%\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' font-size=\\'12\\'>暂无</text></svg>'">
                    <div class="upkeep-tag">￥${e.upkeep}</div>${typeTag}
                    <div><b>${e.name}</b><br><span style="font-size:0.75rem">${e.desc}</span></div>
                </div>`;
            }
        }); document.getElementById('expert-container').innerHTML = ehtml;

        // 分校
        let bEl = document.getElementById('branch-container');
        if(bEl) {
            bEl.innerHTML = BRANCHES_DB.map(b => {
                let owned = hasBranch(b.id);
                return `<div style="background:#fff; border:2px solid ${owned?'var(--gold)':'#cbd5e1'}; padding:15px; border-radius:8px;">
                    <div style="font-weight:bold; font-size:1.1rem;">${b.name}</div>
                    <div style="font-size:0.8rem; color:#64748b; margin:5px 0;">${b.desc}</div>
                    ${owned ? '<span style="color:var(--success);font-weight:bold;">✅ 已建立</span>' : `<button class="btn" onclick="buyBranch('${b.id}', ${b.cost})">建立 (￥${b.cost}万)</button>`}
                </div>`;
            }).join('');
        }

        // 政策
        let thtml = '';
        POLICY_TREE.forEach(layer => {
            let row = `<div class="tree-tier">`;
            layer.nodes.forEach(n => {
                let unlocked = hasPolicy(n.id); let canUnlock = !unlocked && (!n.req || hasPolicy(n.req));
                let cls = unlocked ? 'unlocked ' + n.class : (canUnlock ? n.class : 'locked ' + n.class);
                let btn = unlocked ? `<span style="color:var(--success);font-size:0.8rem;font-weight:bold;">已生效</span>` : 
                          (canUnlock ? `<button class="btn" style="margin:0; padding:4px;" onclick="unlockPolicy('${n.id}', ${n.cost})">颁布</button>` : `<span style="color:#94a3b8;font-size:0.75rem;">未解锁</span>`);
                row += `<div class="tree-node ${cls}"><div><h4 style="margin:0 0 5px 0;font-size:0.95rem;">${n.name}</h4><p style="font-size:0.75rem;color:#64748b;">${n.desc}</p></div>${btn}</div>`;
            });
            thtml += row + `</div>`;
        });
        document.getElementById('policy-container').innerHTML = thtml;
        document.getElementById('ui-eduPoints').innerText = game.eduPoints;
    }

    function renderFacDetail() {
        let list = document.getElementById('fac-list'); list.innerHTML = '';
        if(selectedMapIndex===-1) return;
        if(game.map[selectedMapIndex]) {
            let fac = game.map[selectedMapIndex]; let fData = FACILITIES[fac.id];
            let lvlData = fData.levels[fac.level];
            let isMax = fac.level >= fData.levels.length-1;
            let nextInfo = !isMax ? `升级→ ${fData.levels[fac.level+1].name}` : '';
            list.innerHTML = `<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:8px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                    <span style="font-size:1.8rem;">${fData.icon}</span>
                    <div>
                        <div style="font-weight:bold;color:#1e293b;">${lvlData.name}</div>
                        <div style="font-size:0.7rem;color:#64748b;">等级 ${fac.level+1}/${fData.levels.length}</div>
                    </div>
                </div>
                <div style="background:#eff6ff;border-left:3px solid #3b82f6;padding:6px 10px;border-radius:0 6px 6px 0;font-size:0.8rem;color:#1e40af;margin-bottom:8px;">
                    ⚡ 效果：${lvlData.desc}
                </div>
                ${isMax ? '<div style="color:#10b981;font-size:0.8rem;font-weight:bold;">✅ 已满级</div>' : 
                `<div style="font-size:0.75rem;color:#64748b;margin-bottom:6px;">${nextInfo} (￥${fData.levels[fac.level+1].cost}万)</div>
                <button class="btn" style="margin-right:6px;" onclick="upgradeFac()">⬆ 升级</button>`}
                <button class="btn" style="border-color:#ef4444;color:#ef4444;" onclick="demolish()">🔨 拆除</button>
            </div>`;
        } else {
            list.innerHTML = `<div style="color:#64748b;font-size:0.85rem;margin-bottom:8px;">选择要建造的建筑：</div>`;
            for(let k in FACILITIES) {
                let fData = FACILITIES[k];
                let cost = fData.levels[0].cost;
                let desc = fData.levels[0].desc;
                list.innerHTML += `<button class="btn" style="margin-bottom:6px;text-align:left;display:block;width:100%;" onclick="buildFac('${k}',${cost})">
                    ${fData.icon} <b>${fData.levels[0].name}</b> (￥${cost}万)<br>
                    <span style="font-size:0.72rem;color:#475569;">${desc}</span>
                </button>`;
            }
        }
    }

    function buildFac(k,c){ if(payCost(0,c)){game.map[selectedMapIndex]={id:k,level:0}; renderModals(); updateUI();}}
    function upgradeFac(){ let f=game.map[selectedMapIndex]; let c=FACILITIES[f.id].levels[f.level+1].cost; if(payCost(0,c)){f.level++; renderModals(); updateUI();}}
    function demolish() { game.map[selectedMapIndex] = null; renderModals(); updateUI(); }
    
    function unlockPolicy(id, cost) {
        if(game.eduPoints < cost) return showToast("教研点不足");
        game.eduPoints -= cost; game.policies.push(id); renderModals(); updateUI();
    }

    function gachaExpert() {
        if(!payCost(0, 50)) return;

        // --- 决定稀有度 ---
        let targetRarity = 'R';
        if(game.nextGachaGuarantee) {
            targetRarity = game.nextGachaGuarantee;
            game.nextGachaGuarantee = null;
            showToast("🎯 猎头券生效！保底SR+");
        } else {
            let r = Math.random();
            let ssrRate = [0, 0.005, 0.015, 0.04, 0.08][game.levelIdx];
            let srRate = 0.1 + (game.levelIdx * 0.02);
            if(r < ssrRate) targetRarity = 'SSR'; else if(r < ssrRate + srRate) targetRarity = 'SR';
        }

        // --- 选专家（允许重复，重复退款）---
        let pool = EXPERT_POOL.filter(x => x.rarity === targetRarity);
        if(!pool.length) pool = EXPERT_POOL;
        let ex = pool[Math.floor(Math.random() * pool.length)];
        let isDuplicate = hasExpert(ex.id);
        let refund = 0;

        if(pool.length === 0) {
            game.funds += 40; showToast("人才库已空，退款40万"); return;
        }

        if(!isDuplicate) {
            game.unlockedExperts.push(ex.id);
        } else {
            refund = { SSR: 35, SR: 25, R: 15 }[ex.rarity] || 15;
            game.funds += refund;
        }

        // --- 播放抽卡动画 ---
        showGachaCard(ex, isDuplicate, refund);
        updateUI();
    }

    function showGachaCard(ex, isDuplicate, refund) {
        const RARITY_LABEL = { R:'R · 稀有', SR:'SR · 超稀有', SSR:'SSR ✦ 传奇' };
        let theme = RARITY_THEME[ex.rarity] || RARITY_THEME.R;

        let ov = document.getElementById('gacha-overlay');
        let card = document.getElementById('gacha-card');

        // Apply theme
        card.style.setProperty('--gc', theme.color);
        card.style.setProperty('--gc-bg', theme.bg);
        card.style.background = theme.bg;
        card.style.boxShadow = `0 0 80px ${theme.color}`;
        document.getElementById('gacha-rarity-label').style.color = theme.color;
        document.getElementById('gacha-rarity-label').innerText = RARITY_LABEL[ex.rarity] || theme.label;
        document.getElementById('gacha-icon').innerText = EXPERT_ICONS[ex.id] || theme.icon;
        document.getElementById('gacha-name').innerText = ex.name;
        document.getElementById('gacha-desc').innerText = isDuplicate
            ? `已在麾下 · 退还 ￥${refund}万酬劳`
            : ex.desc;
        let badge = document.getElementById('gacha-duplicate-badge');
        badge.style.display = isDuplicate ? 'block' : 'none';
        document.getElementById('gacha-bg-glow').style.setProperty('--gc', theme.color);

        // Show overlay
        ov.style.display = 'flex';
        card.classList.remove('flip');

        // Flash background then flip card
        ov.style.background = theme.color;
        setTimeout(() => { ov.style.background = '#000'; }, 120);
        setTimeout(() => {
            card.classList.add('flip');
            spawnParticles(theme.color);
            if(ex.rarity === 'SSR') spawnParticles(theme.color);
        }, 200);
    }

    function spawnParticles(color) {
        let container = document.getElementById('gacha-particles');
        let cx = window.innerWidth / 2, cy = window.innerHeight / 2;
        for(let i = 0; i < 24; i++) {
            let p = document.createElement('div');
            p.className = 'g-particle';
            let size = 6 + Math.random() * 10;
            let angle = Math.random() * Math.PI * 2;
            let dist = 120 + Math.random() * 200;
            p.style.cssText = `
                width:${size}px; height:${size}px;
                background:${color}; opacity:0.9;
                left:${cx}px; top:${cy}px;
                --dx:${Math.cos(angle)*dist}px;
                --dy:${Math.sin(angle)*dist}px;
                animation-delay:${Math.random()*0.3}s;
                animation-duration:${0.8+Math.random()*0.6}s;
            `;
            container.appendChild(p);
            setTimeout(() => p.remove(), 1500);
        }
    }

    function closeGachaCard() {
        let ov = document.getElementById('gacha-overlay');
        let card = document.getElementById('gacha-card');
        card.classList.remove('flip');
        setTimeout(() => { ov.style.display = 'none'; renderModals(); }, 300);
    }


    function gachaExpert10() {
        if(!payCost(0, 450)) return;

        let results = [];
        for(let i = 0; i < 10; i++) {
            let targetRarity = 'R';
            let r = Math.random();
            let ssrRate = [0, 0.005, 0.015, 0.04, 0.08][game.levelIdx];
            let srRate = 0.1 + (game.levelIdx * 0.02);
            if(r < ssrRate) targetRarity = 'SSR';
            else if(r < ssrRate + srRate) targetRarity = 'SR';
            // 十连保底：第10抽若无SR+则强制SR
            if(i === 9 && !results.some(x => x.rarity === 'SR' || x.rarity === 'SSR')) targetRarity = 'SR';

            let pool = EXPERT_POOL.filter(x => x.rarity === targetRarity);
            if(!pool.length) pool = EXPERT_POOL;
            let ex = pool[Math.floor(Math.random() * pool.length)];
            let isDuplicate = hasExpert(ex.id);
            let refund = 0;
            if(!isDuplicate) {
                game.unlockedExperts.push(ex.id);
            } else {
                refund = { SSR: 35, SR: 25, R: 15 }[ex.rarity] || 15;
                game.funds += refund;
            }
            results.push({ ex, isDuplicate, refund });
        }
        updateUI();
        showGacha10Cards(results);
    }

    const RARITY_THEME = {
        R:   { color:'#3b82f6', bg:'linear-gradient(160deg,#1e3a5f,#0f172a)', label:'R', icon:'👨‍🏫' },
        SR:  { color:'#a855f7', bg:'linear-gradient(160deg,#3b0764,#1e1b4b)', label:'SR', icon:'🌟' },
        SSR: { color:'#fbbf24', bg:'linear-gradient(160deg,#78350f,#1c1917)', label:'SSR', icon:'👑' },
    };
    const EXPERT_ICONS = {
        e1:'💪',e2:'💰',e3:'👵',e4:'🍳',e5:'🚪',e6:'🧠',e7:'📖',e8:'📢',
        e9:'🎓',e10:'🔬',e11:'🏅',e12:'📱',e13:'⚡',e14:'🏃',e15:'🎨',
        e16:'📝',e17:'💎',e18:'🏆',e19:'🎭',e20:'🌍',
    };

    function showGacha10Cards(results) {
        let ov = document.getElementById('gacha10-overlay');
        let grid = document.getElementById('gacha10-grid');
        let summary = document.getElementById('gacha10-summary');
        grid.innerHTML = '';
        summary.classList.remove('show');
        summary.textContent = '';
        ov.classList.add('show');

        // Flash bg colour of rarest pull
        let topRarity = results.some(x=>x.ex.rarity==='SSR') ? 'SSR' : results.some(x=>x.ex.rarity==='SR') ? 'SR' : 'R';
        let flashColor = RARITY_THEME[topRarity].color;
        ov.style.background = flashColor;
        setTimeout(()=>{ ov.style.background = '#000'; }, 150);

        // Build cards (hidden)
        results.forEach((r, i) => {
            let theme = RARITY_THEME[r.ex.rarity] || RARITY_THEME.R;
            let card = document.createElement('div');
            card.className = 'g10-card';
            card.style.background = theme.bg;
            card.style.boxShadow = `0 0 20px ${theme.color}55`;
            card.innerHTML = `
                ${r.isDuplicate ? '<div class="g10-dup-badge">重复</div>' : ''}
                <div class="g10-card-icon">${EXPERT_ICONS[r.ex.id] || theme.icon}</div>
                <div class="g10-card-rarity" style="color:${theme.color}">${theme.label}</div>
                <div class="g10-card-name">${r.ex.name}</div>
                ${r.isDuplicate ? `<div style="font-size:0.5rem;color:rgba(255,255,255,0.5);text-align:center;margin-top:2px;">退款¥${r.refund}万</div>` : ''}
            `;
            grid.appendChild(card);
        });

        // Stagger reveal
        let cards = grid.querySelectorAll('.g10-card');
        cards.forEach((card, i) => {
            setTimeout(()=>{
                card.classList.add('revealed');
                // Extra particle burst for SSR
                if(results[i].ex.rarity === 'SSR') {
                    spawnParticles(RARITY_THEME.SSR.color);
                    spawnParticles(RARITY_THEME.SSR.color);
                } else if(results[i].ex.rarity === 'SR') {
                    spawnParticles(RARITY_THEME.SR.color);
                }
            }, 80 + i * 120);
        });

        // Summary line
        let newCount = results.filter(x=>!x.isDuplicate).length;
        let ssrCount = results.filter(x=>x.ex.rarity==='SSR').length;
        let srCount  = results.filter(x=>x.ex.rarity==='SR').length;
        let totalRefund = results.reduce((s,x)=>s+(x.refund||0), 0);
        setTimeout(()=>{
            let parts = [];
            if(ssrCount) parts.push(`SSR ×${ssrCount} 🎉`);
            if(srCount)  parts.push(`SR ×${srCount} ✨`);
            parts.push(`新成员 +${newCount}`);
            if(totalRefund) parts.push(`退款 ¥${totalRefund}万`);
            summary.textContent = parts.join('　|　');
            summary.classList.add('show');
        }, 80 + 9 * 120 + 600);
    }

    function closeGacha10() {
        let ov = document.getElementById('gacha10-overlay');
        ov.classList.remove('show');
        renderModals();
    }

    
    function payCost(ap, money) { if(!game) return false; if(game.ap>=ap && game.funds>=money) { game.ap-=ap; game.funds-=money; return true; } showToast("资源不足"); return false; }

    function updateMailbox() {
        let box = document.getElementById('student-comments-box');
        let msgs = [];
        if(stuGame.active) {
            msgs.push(`自己: 刚考了 ${stuGame.examScore||0} 分。`);
            if(stuGame.stress > 80) msgs.push("自己: 压力太大了，想退学...");
        } else {
            msgs.push("匿名: 校长好，我也想玩学生模式。");
        }
        if(game.stress > 80) msgs.push("匿名: 学校太压抑了！");
        if(hasBranch('b_harvard')) msgs.push("匿名: 听说咱们还有哈佛分校？太牛了！");
        
        box.innerHTML = '';
        msgs.forEach(m => {
            box.innerHTML += `<div class="comment-bubble">${m}<div class="comment-meta">${game.year}.${game.month}</div></div>`;
        });
        box.scrollTop = box.scrollHeight;
    }

    function updateUI() {
        if(!game || !game.map) return;
        // update diff badge
        let diffBadge = document.getElementById('ui-diff-badge');
        if(diffBadge) { let d = (game.diff !== undefined && DIFF_MODS[game.diff]) ? game.diff : 1; diffBadge.innerText = `难度: ${DIFF_MODS[d].name}`; }
        let maxApEl = document.getElementById('ui-maxap'); if(maxApEl) maxApEl.innerText = game.maxAp || 20;
        let warn = document.getElementById('warn-stress'); if(warn) warn.style.display = game.stress >= 80 ? 'block' : 'none';
        document.getElementById('ui-date').innerText = `${game.year}年 ${game.month}月`;
        document.getElementById('ui-funds').innerText = Math.floor(game.funds);
        document.getElementById('ui-rep').innerText = Math.floor(game.reputation);
        document.getElementById('ui-ap').innerText = Math.floor(game.ap);
        document.getElementById('val-grade').innerText = Math.floor(game.grade);
        document.getElementById('bar-grade').style.width = game.grade + '%';
        document.getElementById('ui-students').innerText = game.students;
        document.getElementById('ui-examPoints').innerText = game.examPoints;
        document.getElementById('val-stress').innerText = Math.floor(game.stress);
        document.getElementById('bar-stress').style.width = Math.min(100, game.stress) + '%';
        document.getElementById('val-disc').innerText = Math.floor(game.discipline);
        document.getElementById('bar-disc').style.width = game.discipline + '%';
        document.getElementById('val-fit').innerText = Math.floor(game.fitness);
        document.getElementById('bar-fit').style.width = game.fitness + '%';
        document.getElementById('val-art').innerText = Math.floor(game.art);
        document.getElementById('bar-art').style.width = game.art + '%';
        
        document.getElementById('ui-level-name').innerText = `🏆 ${SCHOOL_LEVELS[game.levelIdx].name}`;
        
        let exUpkeep = 0; game.unlockedExperts.forEach(id => { exUpkeep += EXPERT_POOL.find(x=>x.id===id).upkeep; });
        let totalSal = (TEACHER_TIERS[game.teachers.main].salary + TEACHER_TIERS[game.teachers.minor].salary + TEACHER_TIERS[game.teachers.spec].salary) * (game.students / 150); 
        let upkeep = SCHOOL_LEVELS[game.levelIdx].upkeep * getScaleFactor() * (hasExpert('e2')?0.85:1);
        document.getElementById('ui-salary').innerText = `常耗:-${Math.floor(totalSal + upkeep)} 专家:-${exUpkeep}`;

        document.getElementById('tch-main').innerText = TEACHER_TIERS[game.teachers.main].name;
        document.getElementById('tch-minor').innerText = TEACHER_TIERS[game.teachers.minor].name;
        document.getElementById('tch-spec').innerText = TEACHER_TIERS[game.teachers.spec].name;

        // 拉赞助预期金额（随等级和社会关系动态更新）
        let spoEl = document.getElementById('gain-spo');
        if(spoEl) {
            let base = [50, 100, 200, 400, 800][game.levelIdx] || 50;
            initSocialRelations();
            let socialBonus = Math.floor(((game.social.govRelations.local + game.social.govRelations.media) / 200) * base * 0.6);
            spoEl.innerText = base + socialBonus;
        }
    }

    // ================= 升级弹窗重构 =================
    function checkUpgrade() {
        let next = SCHOOL_LEVELS[game.levelIdx + 1];
        if(!next) return showToast("已是最高级别！");
        let html = `
            <ul style="text-align:left; line-height:1.8; font-size:1.1rem; background:#f1f5f9; padding:15px 15px 15px 30px; border-radius:8px;">
                <li><b>名望要求:</b> ${next.reqRep} (当前:${Math.floor(game.reputation)}) ${game.reputation>=next.reqRep?'<span style="color:var(--success)">✅</span>':'<span style="color:var(--danger)">❌</span>'}</li>
                <li><b>资金储备:</b> ${next.reqFunds}万 (当前:${Math.floor(game.funds)}) ${game.funds>=next.reqFunds?'<span style="color:var(--success)">✅</span>':'<span style="color:var(--danger)">❌</span>'}</li>
                <li><b>平均学业:</b> ${next.reqGrade} (当前:${Math.floor(game.grade)}) ${game.grade>=next.reqGrade?'<span style="color:var(--success)">✅</span>':'<span style="color:var(--danger)">❌</span>'}</li>
            </ul>
        `;
        let canUp = game.reputation>=next.reqRep && game.funds>=next.reqFunds && game.grade>=next.reqGrade;
        let btns = [{text:"继续努力", action:()=>{}}];
        if(canUp) btns.push({text:"确认晋升！", action:()=>{ 
            game.levelIdx++; 
            game.maxAp += 5; // 每次升级AP上限+5
            game.ap = Math.min(game.maxAp, game.ap + 5);
            log(`🎉 晋升为【${next.name}】！AP上限+5，现为${game.maxAp}`); 
            updateUI(); 
        }});
        showCustomModal(`申请晋升：${next.name}`, html, btns);
    }

    // 学生模式函数
    function switchMode(m) { 
        if(m==='student'){ 
            document.getElementById('principal-container').style.display='none'; 
            document.getElementById('student-container').style.display='block'; 
            renderStudentSetup(); 
            renderStuFriends();
            renderStuCrushes();
        }
        else { document.getElementById('principal-container').style.display='grid'; document.getElementById('student-container').style.display='none'; updateUI(); }
    }
    
    function renderStudentSetup() {
        let grid = document.getElementById('stu-family-grid');
        grid.innerHTML = '';
        FAMILIES.forEach(f => {
            let el = document.createElement('div');
            el.className = 'family-card';
            if(stuGame.family === f.id) el.classList.add('selected');
            el.onclick = () => selectFamily(f.id, el);
            el.innerHTML = `<h3 style="margin:0 0 5px 0;">${f.name}</h3><p style="font-size:0.8rem;color:#64748b;">${f.desc}</p><div style="font-weight:bold;color:var(--primary);margin-top:5px;">初始: ￥${f.money}</div>`;
            grid.appendChild(el);
        });
    }

    function selectFamily(id, el) { 
        stuGame.family = id; 
        document.querySelectorAll('.family-card').forEach(c=>c.classList.remove('selected')); 
        el.classList.add('selected'); 
    }
    
    function buyTalent(id, c, el) { if(metaData.rebirthPoints>=c && !stuGame.talent.includes(id)) { metaData.rebirthPoints-=c; stuGame.talent.push(id); el.style.background='#dcfce7'; saveGame(); }}
    function startStudentGameplay() { 
        if(stuGame.family) { 
            stuGame.active=true; 
            if(!stuGame.crushes['lin']) {
                CRUSHES.forEach(c => { stuGame.crushes[c.id] = { aff:0, events:[] }; });
            }
            document.getElementById('stu-setup').style.display='none'; 
            document.getElementById('stu-gameplay').style.display='grid'; 
            updateStuUI(); 
            renderStuCrushes();
        } else showToast("请选出身"); 
    }
    
    // 学生行动逻辑 (消耗精力 + 扩充玩法)
    function stuAct(t) { 
        let costs = {
            'hard_study': 40, 'study': 25, 'olympiad': 50, 'abroad': 30, 'work': 30, 'gacha': 10, 'esport': 40, 'show': 40, 'sport': 25, 'book': 20, 'sick': 10, 'parent': 15,
            'mun': 50, 'daydream': 10, 'scalper': 30, 'rooftop': 20,
            'diary': 10, 'volunteer': 25, 'club_drama': 35, 'tutor': 30, 'fight': 20, 'confession_prep': 40
        };
        let cost = costs[t] || 20;
        
        if(stuGame.energy < cost) { showToast("😴 精力不足，请点击【睡觉】结束本月！"); return; }
        
        stuGame.energy -= cost;
        let sLog = "";
        
        // 效果模拟
        if(t==='study') { stuGame.grade+=2; stuGame.stress+=5; sLog="认真听讲做笔记，学业+2，压力增加";}
        if(t==='hard_study') { stuGame.grade+=4; stuGame.stress+=12; sLog="疯狂刷真题熬夜，学业大增，头痛欲裂！";}
        if(t==='parent') { stuGame.money+=50; sLog="跟父母要了50块钱生活费。";}
        if(t==='work') { stuGame.money+=30; stuGame.fit-=2; sLog="去校外打工，赚了30元，身体疲惫。";}
        if(t==='mun') { stuGame.grade+=1; stuGame.art+=3; sLog="参加模拟联合国，口才与视野提升！";}
        if(t==='daydream') { stuGame.stress=Math.max(0, stuGame.stress-5); sLog="对着窗外发呆，稍微缓了口气。";}
        if(t==='rooftop') { stuGame.stress=Math.max(0, stuGame.stress-12); sLog="在天台吹风，压抑的心情得到缓解。";}
        if(t==='sick') { stuGame.grade-=2; stuGame.stress=Math.floor(stuGame.stress/2); sLog="装病躲进医务室，漏了课，但压力减半了。"; }
        if(t==='sport') { stuGame.fit+=3; stuGame.art+=1; stuGame.stress=Math.max(0,stuGame.stress-5); sLog="挥洒汗水，强健体魄！"; }
        if(t==='book') { stuGame.art+=3; stuGame.stress=Math.max(0,stuGame.stress-5); sLog="在书中找到了颜如玉。"; }
        if(t==='show') { if(stuGame.art>60){stuGame.stress=Math.max(0,stuGame.stress-15); sLog="你在舞台上大放异彩！全场瞩目！";}else{stuGame.stress=Math.min(100,stuGame.stress+10); sLog="才艺不佳，搞砸了表演，尴尬得脚趾抠地。";} }
        if(t==='esport') { if(Math.random()<0.5){stuGame.money+=100; stuGame.stress=Math.max(0,stuGame.stress-20); sLog="带领战队夺冠，网费全免还拿了奖金！";}else{stuGame.stress=Math.min(100,stuGame.stress+10); sLog="遇到猪队友连跪，气得高血压。";} }
        if(t==='scalper') { 
            if(Math.random()<0.3) { stuGame.money-=50; stuGame.stress+=20; sLog="倒卖被教导主任抓住！没收并罚款！"; }
            else { stuGame.money+=150; sLog="倒卖演唱会门票大赚一笔！"; }
        }
        if(t==='diary') { 
            if(!stuGame.endingFlags) stuGame.endingFlags={};
            let diaryMonth = stuGame.endingFlags.diaryMonth;
            let curMonth = stuGame.turn; // use turn as unique month key
            if(diaryMonth === curMonth) { sLog="今天已经写过日记了，明天再写吧。（每月限写一次）"; }
            else {
                stuGame.endingFlags.diaryMonth = curMonth;
                stuGame.stress=Math.max(0,stuGame.stress-8); 
                stuGame.endingFlags.diary = (stuGame.endingFlags.diary||0)+1;
                sLog=`写了第${stuGame.endingFlags.diary}篇日记，倾诉内心积压的情绪，减压8点。`;
                if(stuGame.endingFlags.diary>=5) { stuGame.endingFlags.writer=true; sLog+=" (解锁隐藏结局：文字记录者)"; }
            }
        }
        if(t==='volunteer') { 
            stuGame.art+=3; stuGame.stress=Math.max(0,stuGame.stress-5);
            if(!stuGame.endingFlags) stuGame.endingFlags={};
            stuGame.endingFlags.volunteer=(stuGame.endingFlags.volunteer||0)+1;
            sLog="参加社区服务，帮助了有需要的人，魅力+3，压力-5。"; 
        }
        if(t==='club_drama') { 
            stuGame.art+=6; stuGame.stress=Math.max(0,stuGame.stress-15); 
            sLog="话剧社排练了三个小时，完全沉浸其中，忘记了所有烦恼！魅力+6，减压15。"; 
        }
        if(t==='tutor') { 
            stuGame.money+=80; stuGame.grade+=1; 
            sLog="给学弟学妹补课两小时，讲题过程中自己也巩固了知识点，赚了80元。"; 
        }
        if(t==='fight') { 
            if(Math.random()<0.5) { 
                stuGame.stress=Math.max(0,stuGame.stress-20); stuGame.fit+=2;
                game.discipline-=5;
                sLog="痛揍了几个欺负人的家伙，压力暴减！但纪律主任找到学校了……纪律-5。"; 
            } else { 
                stuGame.stress+=15; stuGame.fit-=3;
                sLog="被对方几个人围住了，吃了大亏，身上有伤，还被请家长……";
            }
        }
        if(t==='confession_prep') {
            if(!stuGame.confessionReady) stuGame.confessionReady = 0;
            stuGame.confessionReady = Math.min(3, stuGame.confessionReady+1);
            stuGame.stress = Math.max(0, stuGame.stress - 5);
            sLog = `精心策划表白方案（进度${stuGame.confessionReady}/3），光是想着就有点甜蜜……减压5。`;
            if(stuGame.confessionReady>=3) sLog += " 方案就绪！表白成功率大幅提升！";
        }
        
        // 奥赛机制
        if(t === 'olympiad') {
            if(stuGame.isInsured) { sLog = "已经保送清北，无需再卷！"; }
            else {
                let successRate = stuGame.grade / 100; 
                if(Math.random() < successRate) {
                    stuGame.olympiadProgress = Math.min(100, stuGame.olympiadProgress + 15);
                    sLog = `攻克难题！奥赛进度: ${stuGame.olympiadProgress}%`;
                    if(stuGame.olympiadProgress >= 100) {
                        stuGame.isInsured = true;
                        showCustomModal("🏆 国家队金牌！", "你在奥林匹克竞赛中斩获金牌，已提前保送清北！校长乐疯了！", [{text:"爽", action:()=>{ game.eduPoints+=100; game.reputation+=500; updateUI(); }}]);
                    }
                } else {
                    stuGame.stress += 20;
                    sLog = "题目太难，一道没解出来，心态炸裂！";
                }
            }
        }
        
        let stuBox = document.getElementById('stu-log-box');
        stuBox.innerHTML += `<div>👉 ${sLog}</div>`;
        stuBox.scrollTop = stuBox.scrollHeight;

        // 即时崩溃检测
        if(stuGame.stress >= 100) {
            stuGame.active = false;
            showCustomModal("💀 精神崩溃", 
                `<div style="text-align:center;padding:10px;">
                    <div style="font-size:3rem;">🧠💥</div>
                    <p style="color:#ef4444;font-weight:bold;">精神压力突破极限！</p>
                    <p>在一次高强度学习后，你的学生当场崩溃。高中三年的努力戛然而止。</p>
                </div>`,
                [{text:"结束本次人生", action:()=>{
                    stuGame = { active:false, year:1, month:1, turn:1, grade:40, stress:0, fit:40, art:40, talent:[], family:'', money:0, crushes:{}, lover:false, loverName:'', friends:[], examScore:0, energy:100, maxEnergy:100, olympiadProgress:0, isInsured:false };
                    switchMode('principal');
                }}]);
            return;
        }
        updateStuUI(); 
    }
    
    function endStudentMonth() {
        if(!stuGame.active) return;
        // 被动精力与光环（独立于校长系统）
        stuGame.maxEnergy = hasPolicy('D5') ? 120 : 100;
        stuGame.energy = stuGame.maxEnergy;
        if(hasPolicy('A1')) stuGame.stress += 5;
        if(stuGame.lover) stuGame.energy = Math.min(stuGame.maxEnergy, stuGame.energy + 30);
        stuGame.friends.forEach(fid => { let f = FRIENDS.find(x=>x.id===fid); if(f) f.eff(); });

        stuGame.turn++;
        stuGame.month++;
        if(stuGame.month > 12) { stuGame.month = 1; stuGame.year++; }

        // 压力溢出检测（崩溃结局）
        if(stuGame.stress >= 100) {
            stuGame.active = false;
            showCustomModal("💀 精神崩溃", 
                `<div style="text-align:center;padding:10px;">
                    <div style="font-size:3rem;">🧠💥</div>
                    <p style="color:#ef4444;font-weight:bold;font-size:1.2rem;">精神压力突破极限！</p>
                    <p>你的学生长期承受巨大压力，最终在某个深夜彻底崩溃。<br>高中三年的梦想与挣扎，就此画上句号。</p>
                    <p style="color:#94a3b8;font-size:0.85rem;">学业分数归零，无法参加高考。<br>请好好照顾学生的心理健康。</p>
                </div>`,
                [{text:"结束本次人生", action:()=>{
                    stuGame = { active:false, year:1, month:1, turn:1, grade:40, stress:0, fit:40, art:40, talent:[], family:'', money:0, crushes:{}, lover:false, loverName:'', friends:[], examScore:0, energy:100, maxEnergy:100, olympiadProgress:0, isInsured:false };
                    document.getElementById('principal-container').style.display='grid';
                    document.getElementById('student-container').style.display='none';
                    updateUI();
                }}]);
            return;
        }

        // 自动计算学生联考
        if(stuGame.month === 3 || stuGame.month === 6 || stuGame.month === 11) {
            let base = stuGame.grade * 5 + stuGame.art * 2 + stuGame.fit * 1;
            if(stuGame.isInsured) base = 750;
            let rand = Math.random() * 30;
            stuGame.examScore = Math.min(750, Math.floor(base + rand));
            let rank = Math.max(1, Math.floor(1000 - stuGame.examScore));
            document.getElementById('stu-exam-score').innerText = stuGame.examScore;
            document.getElementById('stu-exam-rank').innerText = `全校排名: ${rank}`;
            let stuBox = document.getElementById('stu-log-box');
            if(stuBox) stuBox.innerHTML = `<div style="color:#2563eb;">📅 联考结束，你的分数: <b>${stuGame.examScore}</b>/750 (排名${rank})</div>` + stuBox.innerHTML;
        }

        // 高三压力递增系统（独立）
        let stuYearNum = Math.ceil(stuGame.turn / 12);
        if(stuYearNum >= 3 && !stuGame.seniorStarted) {
            stuGame.seniorStarted = true;
            stuGame.seniorCountdown = 12;
            showCustomModal("⚡ 高三冲刺开始！", `<div style="text-align:center;"><div style="font-size:3rem;">🎓</div>
                <p>距离高考还有 <b style="color:var(--danger);font-size:1.5rem;">12</b> 个月！</p>
                <p style="color:#ef4444;font-weight:bold;">从现在起，每月压力递增。请慎重分配精力！</p></div>`,
                [{text:"冲！绝不退缩！", action:()=>{stuGame.stress+=10; showToast("压力+10，意志如铁！");}}]);
        }
        if(stuGame.seniorStarted && stuGame.seniorCountdown > 0) {
            stuGame.seniorCountdown = Math.max(0, (stuGame.seniorCountdown||0) - 1);
            let pressureGain = 3 + (12 - stuGame.seniorCountdown) * 1.5;
            stuGame.stress = Math.min(100, stuGame.stress + Math.floor(pressureGain));
            let rankEl = document.getElementById('stu-exam-rank');
            if(rankEl) rankEl.innerText = `⏳ 距高考：${stuGame.seniorCountdown} 个月 | 本月压力+${Math.floor(pressureGain)}`;

            // 崩溃警告事件
            if(stuGame.stress >= 85 && Math.random() < 0.25) {
                let events = [
                    { title:"🚨 精神崩溃警报", desc:"你感觉自己快要撑不住了……", opt1:"咬牙继续（学业+5，压力+15）", opt2:"找老师倾诉（压力-20，学业-3）",
                      eff1:()=>{stuGame.grade+=5;stuGame.stress=Math.min(100,stuGame.stress+15);}, eff2:()=>{stuGame.stress=Math.max(0,stuGame.stress-20);stuGame.grade-=3;} },
                    { title:"😰 想要放弃高考", desc:"你内心开始质疑这一切的意义……", opt1:"强迫自己（压力+20，学业+3）", opt2:"和父母聊聊（压力-15，学业-5）",
                      eff1:()=>{stuGame.stress=Math.min(100,stuGame.stress+20);stuGame.grade+=3;}, eff2:()=>{stuGame.stress=Math.max(0,stuGame.stress-15);stuGame.grade-=5;} }
                ];
                let ev = events[Math.floor(Math.random()*events.length)];
                showCustomModal(ev.title, `<p>${ev.desc}</p><p style="color:#ef4444;">当前压力：${stuGame.stress}/100</p>`,
                    [{text:ev.opt1, action:()=>{ev.eff1(); updateStuUI();}},
                     {text:ev.opt2, action:()=>{ev.eff2(); updateStuUI();}}]);
                return;
            }
        }

        // 学生随机小事件
        if(Math.random() < 0.12) {
            let evs = [
                {t:"🎒 校园奇遇", d:"捡到一本五三真题秘籍！", ops:[{text:"疯狂内卷",action:()=>{stuGame.grade+=10;stuGame.stress+=20;updateStuUI();}},{text:"拿去卖废品",action:()=>{stuGame.money+=50;updateStuUI();}}]},
                {t:"👀 被老师单独辅导", d:"任课老师发现你的潜力！", ops:[{text:"认真听讲",action:()=>{stuGame.grade+=8;updateStuUI();}},{text:"敷衍了事",action:()=>{stuGame.stress=Math.max(0,stuGame.stress-5);updateStuUI();}}]},
                {t:"🎮 同学邀你打游戏", d:"宿舍室友拉你开黑一局……", ops:[{text:"陪玩一局",action:()=>{stuGame.stress=Math.max(0,stuGame.stress-15);stuGame.grade-=3;updateStuUI();}},{text:"婉言拒绝",action:()=>{stuGame.grade+=2;updateStuUI();}}]}
            ];
            let ev = evs[Math.floor(Math.random()*evs.length)];
            showCustomModal(ev.t, ev.d, ev.ops);
            return;
        }

        // 高考结局
        if(stuGame.turn > 36) {
            stuGame.active = false;
            let score = stuGame.examScore;
            let ending = score>=700?"清北录取，桃李满天下！":score>=600?"985录取，前程似锦！":score>=550?"211录取，稳步前行。":score>=450?"本科录取，继续加油。":"未达本科线，人生路还长。";
            showCustomModal("🎓 高考揭晓",
                `<div style="text-align:center;"><div style="font-size:3rem;">🎓</div>
                 <div style="font-size:2rem;font-weight:bold;color:#2563eb;">${score}<span style="font-size:1rem;">/750</span></div>
                 <div style="font-size:1.1rem;margin:10px 0;">${ending}</div>
                 ${stuGame.lover?`<p style="color:#db2777;">💕 与${stuGame.loverName}一起迎接新人生。</p>`:''}
                 </div>`,
                [{text:"📜 查看完整结局", action:()=>{ showFinalRating('student'); }},
                 {text:"返回校长视角", action:()=>{ document.getElementById('principal-container').style.display='grid'; document.getElementById('student-container').style.display='none'; updateUI(); }}]);
            return;
        }

        updateStuUI();
    }

    function updateStuUI() { 
        stuGame.energy = Math.min(stuGame.maxEnergy, Math.max(0, stuGame.energy || 0));
        stuGame.stress = Math.min(100, Math.max(0, stuGame.stress || 0));
        document.getElementById('stu-val-grade').innerText = stuGame.grade; 
        document.getElementById('stu-val-stress').innerText = Math.floor(stuGame.stress); 
        document.getElementById('stu-val-fit').innerText = stuGame.fit; 
        document.getElementById('stu-val-art').innerText = stuGame.art; 
        document.getElementById('stu-val-oly').innerText = Math.min(100, stuGame.olympiadProgress);
        document.getElementById('stu-val-money').innerText = stuGame.money;
        document.getElementById('stu-val-energy').innerText = stuGame.energy;
        document.getElementById('stu-bar-energy').style.width = Math.min(100, (stuGame.energy/stuGame.maxEnergy*100)) + '%';
        
        document.getElementById('stu-lover-tag').innerHTML = stuGame.lover ? `💕 与[${stuGame.loverName}]热恋中` : '💔 单身狗';

        document.getElementById('stu-ui-year').innerText = Math.ceil(stuGame.turn/12);
        document.getElementById('stu-ui-month').innerText = game.month;
        document.getElementById('stu-ui-turn').innerText = stuGame.turn;
    }
    
    // ================= 恋爱机制扩充 (v2 - 深度情感线) =================
    // renderStuCrushes 在下方第二处定义，包含完整功能
    
    function interactCrush(cid, type) {
        if(stuGame.lover && type === 'confess') return showToast("你已经有伴侣了，专一一点！");
        let ch = CRUSHES.find(x=>x.id===cid);
        let data = stuGame.crushes[cid];
        
        if(type === 'confess') {
            if(stuGame.energy < 50) return showToast("精力不足（需要50点）");
            stuGame.energy -= 50;
            let dBox = document.getElementById(`dialog-${cid}`);
            if(dBox) dBox.style.display = 'block';
            
            if(data.aff >= 100) {
                if(hasPolicy('B3') || hasPolicy('B4')) {
                    if(dBox) dBox.innerText = `"学校现在查得太严了，监控到处都是……对不起，我们还是算了吧。"`;
                    stuGame.stress += 50;
                    showToast("环境恶劣，表白失败！");
                } else {
                    stuGame.lover = true;
                    stuGame.loverName = ch.name;
                    if(dBox) dBox.innerText = `"其实……我也喜欢你很久了。"`;
                    showToast(`💘 成功与 ${ch.name} 坠入爱河！`);
                    let achId = '';
                    if(cid==='lin') achId='ach_lin'; if(cid==='xia') achId='ach_xia';
                    if(cid==='jiang') achId='ach_jiang'; if(cid==='shen') achId='ach_shen';
                    if(achId && !game.achievements.includes(achId)) {
                        game.achievements.push(achId);
                        showToast(`🏆 获得成就：${ACHIEVEMENTS.find(x=>x.id===achId).name}`);
                    }
                }
            } else {
                if(dBox) dBox.innerText = `"我们只是普通的同学关系吧？别开这种玩笑了。"`;
                stuGame.stress += 30;
                showToast("好感度不足，惨遭拒绝！");
            }
        }

        // 检查阶段事件
        for(let lv in ch.events) {
            if(data.aff >= parseInt(lv) && !data.events.includes(lv)) {
                let ev = ch.events[lv];
                let checkRes = ev.check();
                if(checkRes === -999) {
                    showToast(`[事件中断] ${ch.name}对你大失所望。`);
                    data.events.push(lv);
                    data.aff -= 20;
                } else {
                    data.aff += 10 * checkRes;
                    data.events.push(lv);
                    showCustomModal(`💕 羁绊加深：${ch.name} - ${ev.name}`, `${ev.desc}<br><br><span style="color:var(--primary);font-weight:bold;">${ev.log}</span>`, [{text:"继续", action:()=>{renderStuCrushes(); updateStuUI();}}]);
                    return;
                }
            }
        }

        renderStuCrushes();
        updateStuUI();
    }

    // ================= 好感度buff系统 =================
    function getCrushBuff(cid, aff) {
        if(aff < 30) return null;
        const buffs = {
            'lin': { name: '学霸光环', desc: '每次学习额外+2学业', threshold: 30, apply: ()=>{ stuGame.grade += 2; } },
            'xia': { name: '艺术灵感', desc: '魅力+3，减压2', threshold: 30, apply: ()=>{ stuGame.art += 3; stuGame.stress = Math.max(0, stuGame.stress-2); } },
            'jiang': { name: '运动加成', desc: '体质+2，精力+10', threshold: 30, apply: ()=>{ stuGame.fit += 2; stuGame.energy = Math.min(stuGame.maxEnergy, stuGame.energy+10); } },
            'shen': { name: '心灵慰藉', desc: '减压5，魅力+2', threshold: 30, apply: ()=>{ stuGame.stress = Math.max(0,stuGame.stress-5); stuGame.art+=2; } }
        };
        return buffs[cid] || null;
    }

    // 对话选项系统 - 每角色10+种，有增加/减少好感的选项
    const CRUSH_DIALOGUE_OPTIONS = {
        'lin': [
            { text: '你今天讲题讲得真好', effect: 5, reply: '"哼，你只是在拍马屁而已。……谢谢你。"', type: 'good' },
            { text: '咱们一起去图书馆?', effect: 8, reply: '"好啊，但你得跟上我的进度。"', type: 'good' },
            { text: '我觉得太卷了，不值得', effect: -8, reply: '"你这种态度让我很失望。自己想清楚吧。"', type: 'bad' },
            { text: '你平时怎么放松?', effect: 3, reply: '"……偶尔会一个人在天台看星星。你别笑话我。"', type: 'neutral' },
            { text: '帮我抄一下作业', effect: -5, reply: '"你以为我会帮你作弊？！滚去自己写！"', type: 'bad' },
            { text: '你有没有想过清华以外的路?', effect: 4, reply: '"有时候会想……但现在不是该想这个的时候。"', type: 'neutral' },
            { text: '上次考试你是第一名对吗', effect: 6, reply: '"嗯。但我觉得数学还可以再提高。"', type: 'good' },
            { text: '你这道题的解法不对', effect: -3, reply: '"……让我重新算算。你说得有点道理。"', type: 'neutral' },
            { text: '你的字好漂亮', effect: 7, reply: '"…你有点烦。谢谢你注意到的。"', type: 'good' },
            { text: '假期想去哪里?', effect: 5, reply: '"清华园。我要去感受一下氛围。也许……带上你也行。"', type: 'good' },
        ],
        'xia': [
            { text: '你的画真的太有感觉了', effect: 8, reply: '"真的吗？！你是第一个这么说的！"', type: 'good' },
            { text: '要不要一起逃课?', effect: 10, reply: '"哇，你比我想象的有趣！走走走！"', type: 'good' },
            { text: '画画没什么用，还是学习重要', effect: -10, reply: '"那就别来打扰我画画！"', type: 'bad' },
            { text: '这首歌真好听', effect: 6, reply: '"对对对！这是我最近在追的乐团！你也喜欢？"', type: 'good' },
            { text: '你的制服其实挺好看的', effect: 5, reply: '"……好吧你的审美还行。"', type: 'neutral' },
            { text: '你画的这朵云像棉花糖', effect: 4, reply: '"哈哈！你的联想力不差！"', type: 'neutral' },
            { text: '你有想过去意大利学艺术吗', effect: 9, reply: '"你……怎么知道我的梦想？一起去吗？"', type: 'good' },
            { text: '这种风格太小众了', effect: -6, reply: '"随你怎么说，我不在乎大众。"', type: 'bad' },
            { text: '可以帮我画个像吗', effect: 7, reply: '"好啊！但你要一直保持这个表情。"', type: 'good' },
            { text: '你不怕被老师抓到画画?', effect: 3, reply: '"抓到又怎样，大不了交作业。"', type: 'neutral' },
        ],
        'jiang': [
            { text: '你打篮球真的好酷', effect: 8, reply: '"嘿嘿，你懂得欣赏！来，我教你！"', type: 'good' },
            { text: '一起去打球吧', effect: 10, reply: '"等什么！走起！"', type: 'good' },
            { text: '运动浪费时间', effect: -10, reply: '"……你这种人我最看不上。"', type: 'bad' },
            { text: '你昨天那个三分球太帅了', effect: 7, reply: '"哈！看到了？那叫艺术！"', type: 'good' },
            { text: '帮我做作业吧我来打球', effect: -5, reply: '"兄弟，我也不会做啊……"', type: 'bad' },
            { text: '你有没有想过打职业联赛', effect: 6, reply: '"当然！我可是要进国家队的男人！"', type: 'good' },
            { text: '今晚一起去吃烧烤?', effect: 9, reply: '"这话我爱听！集合！"', type: 'good' },
            { text: '你平时也看书吗', effect: 4, reply: '"……偶尔。体育杂志算吗？"', type: 'neutral' },
            { text: '你受伤了要去医院', effect: 6, reply: '"没事没事，擦破点皮而已！"', type: 'neutral' },
            { text: '球场的事全靠你了', effect: 5, reply: '"放心，我不会让大家失望的！"', type: 'good' },
        ],
        'shen': [
            { text: '你今天看起来挺好的', effect: 5, reply: '"……少废话。"（但嘴角微微上扬）', type: 'neutral' },
            { text: '那天多谢你帮我', effect: 8, reply: '"……我没有帮你，别乱说。"（背过脸去）', type: 'good' },
            { text: '你为什么总是逃课?', effect: -4, reply: '"关你什么事。"', type: 'bad' },
            { text: '这首歌是你在听吗', effect: 7, reply: '"……你也听地下乐队？"（露出惊讶表情）', type: 'good' },
            { text: '你应该好好上课', effect: -8, reply: '"你和那些老师一样烦。"', type: 'bad' },
            { text: '我不会告诉别人你打工的事', effect: 10, reply: '"……你为什么要帮我。"（沉默良久）', type: 'good' },
            { text: '染发好看，是什么颜色?', effect: 6, reply: '"……星云蓝。你眼睛不错。"', type: 'good' },
            { text: '你家里……还好吗', effect: 5, reply: '"……管好你自己。"（语气软化了）', type: 'neutral' },
            { text: '借你本书', effect: 9, reply: '"……这是你喜欢的书吗。"（轻轻接过）', type: 'good' },
            { text: '跟我说说你过去的事?', effect: -3, reply: '"我说了，别问。"', type: 'bad' },
        ]
    };
    
    // 礼物系统
    const GIFT_CATALOG = {
        'lin': [
            { name: '清华大学周边纪念册', cost: 80, effect: 15, reply: '"这……这正是我想要的！谢谢你！！"' },
            { name: '高中数学解题宝典', cost: 50, effect: 10, reply: '"正好我缺这本，谢谢你记得。"' },
            { name: '游乐场门票', cost: 100, effect: -5, reply: '"……我没空去这种地方。"' },
        ],
        'xia': [
            { name: '手工颜料套装', cost: 120, effect: 18, reply: '"这是专业级的！你真的太懂我了！"' },
            { name: '梵高画册', cost: 80, effect: 12, reply: '"哇！我最喜欢梵高！你怎么知道！"' },
            { name: '数学习题集', cost: 30, effect: -8, reply: '"……谢谢，我……不需要这个。"' },
        ],
        'jiang': [
            { name: 'NBA纪念版球衣', cost: 150, effect: 18, reply: '"哇靠！这是我最喜欢的球队！太仗义了！"' },
            { name: '蛋白粉能量棒', cost: 60, effect: 10, reply: '"兄弟，你太懂我了！"' },
            { name: '文学名著全集', cost: 80, effect: -3, reply: '"呃……谢了，我……会看的。"' },
        ],
        'shen': [
            { name: '地下乐队专辑黑胶', cost: 100, effect: 20, reply: '"……你怎么找到这张的。"（眼眶微红）', },
            { name: '便利店甜品', cost: 30, effect: 8, reply: '"……我不喜欢甜的。但谢谢你。"（默默吃掉）' },
            { name: '励志成功学书', cost: 40, effect: -12, reply: '"你觉得我需要被激励？滚。"' },
        ]
    };

    function renderStuCrushes() {
        let c = document.getElementById('stu-crush-container');
        c.innerHTML = '';
        CRUSHES.forEach(ch => {
            let data = stuGame.crushes[ch.id];
            if(!data) return;
            
            let aff = data.aff;
            let buffInfo = getCrushBuff(ch.id, aff);
            let buffTag = buffInfo && aff >= 30 ? `<div style="background:#fdf2f8; border:1px solid #f9a8d4; padding:4px 8px; border-radius:4px; font-size:0.7rem; color:#be185d; margin-bottom:5px;">✨ 好感BUFF: ${buffInfo.name} - ${buffInfo.desc}</div>` : '';
            
            // 逐步解锁属性信息
            let attrInfo = '';
            if(aff >= 20) attrInfo += `<span style="font-size:0.65rem; background:#f0fdf4; color:#166534; padding:1px 4px; border-radius:3px; margin-right:3px;">爱好已解锁</span>`;
            if(aff >= 50) attrInfo += `<span style="font-size:0.65rem; background:#eff6ff; color:#1e40af; padding:1px 4px; border-radius:3px; margin-right:3px;">秘密已解锁</span>`;
            if(aff >= 80) attrInfo += `<span style="font-size:0.65rem; background:#faf5ff; color:#6b21a8; padding:1px 4px; border-radius:3px; margin-right:3px;">心声已解锁</span>`;
            
            let html = `
            <div class="crush-card">
                <div class="crush-head">
                    <img src="src/love/${ch.id}.png" class="crush-img" style="width:70px;height:70px;cursor:pointer;" onclick="showCrushPortrait('${ch.id}')"
                        onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'70\\' height=\\'70\\'><circle cx=\\'35\\' cy=\\'35\\' r=\\'35\\' fill=\\'%23fbcfe8\\'/><text x=\\'50%\\' y=\\'50%\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' font-size=\\'16\\' fill=\\'%23be185d\\'>${ch.name[0]}</text></svg>'" title="点击查看立绘">
                    <div class="crush-info">
                        <h4>${ch.name} <span style="font-size:0.7rem;color:#f472b6;">[${ch.title}]</span></h4>
                        <p>${ch.desc}</p>
                        ${attrInfo}
                    </div>
                </div>
                ${buffTag}
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                    <span style="font-size:0.7rem;color:#be185d;font-weight:bold;">好感度 ${Math.floor(aff)}/100</span>
                    ${aff>=100?'<span style="font-size:0.7rem;color:#db2777;font-weight:bold;">💖 心动满溢</span>':''}
                </div>
                <div class="crush-bar-bg"><div class="crush-bar-fill" style="width:${Math.min(100,aff)}%"></div></div>
                <div class="crush-dialog" id="dialog-${ch.id}"></div>
                <div class="crush-actions">
                    <button class="btn" style="margin:0; font-size:0.75rem; padding:6px;" onclick="showDialogOptions('${ch.id}')">💬 选择话题 (5能)</button>
                    <button class="btn" style="margin:0; font-size:0.75rem; padding:6px;" onclick="showDeepCrushDialog('${ch.id}')">🎭 触发场景对话 (5能)</button>
                    <button class="btn" style="margin:0; font-size:0.75rem; padding:6px;" onclick="showGiftMenu('${ch.id}')">🎁 选择礼物</button>
                    <button class="btn-main" style="grid-column:1/-1; margin:0; padding:8px; font-size:0.8rem; background:#db2777;" onclick="interactCrush('${ch.id}', 'confess')">💘 勇敢表白 (50能)</button>
                </div>
            </div>`;
            c.innerHTML += html;
        });
    }
    
    const CRUSH_PROFILES = {
        'lin': {
            icon: '📚', color: '#be185d',
            intro: '林知秋，17岁，文科班班长，全年级第一。她的世界只有三种颜色：试卷的白、墨水的黑、清华校徽的紫。每天早上五点起床，背单词、做笔记、整理错题本——她不允许自己犯错，因为她知道，一旦停下来，那些压着她的东西就会把她淹没。',
            hobby: '写诗（从不给人看）、夜晚在天台数星星',
            fear: '害怕让父母失望，害怕发现努力没有意义',
            dream: '考上清华，然后……她还没有想过"然后"。',
            quote: '"我不是天才，我只是不敢停。"'
        },
        'xia': {
            icon: '🎨', color: '#7c3aed',
            intro: '夏晚晴，17岁，艺术特长生，校外兼职模特。她是那种走进教室会让空气都变得不同的人——香水、散发、永远歪戴的帽徽。她讨厌规则，讨厌标准答案，讨厌任何告诉她"应该怎样"的人。但很少有人知道，她每天深夜都在画画，画她那个只有她自己能进入的世界。',
            hobby: '地下展览、独立音乐节、半夜写生',
            fear: '害怕有一天再也画不出让自己感动的东西',
            dream: '去米兰，开一场只属于自己的个展',
            quote: '"我不是在逃课，我是在找真正的课。"'
        },
        'jiang': {
            icon: '🏀', color: '#0369a1',
            intro: '江一舟，18岁，校篮球队队长，体育特长生。他是那种你一眼就会注意到的男生——不是因为帅，而是因为他身上有一种让人放松的力量。他大大咧咧，义气当头，可以为了朋友翻墙出去买宵夜，也可以带伤上场打完决赛。很多人不知道他右手有一处没有完全康复的旧伤。',
            hobby: 'NBA直播、街头篮球、吃烧烤',
            fear: '害怕有一天打不了球，害怕被人看出他其实也会累',
            dream: '进省队，然后是国家队',
            quote: '"输了可以，但不能输得不好看。"'
        },
        'shen': {
            icon: '🌙', color: '#475569',
            intro: '沈渔，17岁，从大城市转来的插班生，染了一头星云蓝的发，耳机永远挂在脖子上。她不跟人说话，不参加任何活动，课堂上要么睡觉要么看窗外。全校都知道她是"问题学生"，但没有人知道她每天放学后去哪里——她在给弟弟的学费打工。她的防御心是一座城墙，但城墙里面，住着一个极度渴望被真正理解的人。',
            hobby: '地下乐队、深夜便利店、一个人走很远的路',
            fear: '害怕被人用怜悯的眼神看待',
            dream: '让弟弟能好好上学，至于自己……走一步看一步。',
            quote: '"别问我为什么，问了我也不会说。"'
        }
    };

    function showCrushPortrait(cid) {
        let ch = CRUSHES.find(x=>x.id===cid);
        let aff = (stuGame.crushes[cid] && stuGame.crushes[cid].aff) || 0;
        let prof = CRUSH_PROFILES[cid];
        
        let secrets = '';
        if(aff >= 50) secrets += `<div style="background:#f5f3ff;border-left:3px solid #8b5cf6;padding:8px 10px;border-radius:0 6px 6px 0;margin-top:8px;"><span style="color:#7c3aed;font-size:0.7rem;font-weight:bold;">💜 解锁秘密（好感≥50）</span><p style="margin:4px 0 0;font-size:0.8rem;color:#475569;">${cid==='lin'?'她在天台上写了三年诗，从未让任何人看过。有一首写的是"如果可以，我想在宇宙边界和你一起迷路"。':cid==='xia'?'她的母亲是位严苛的钢琴老师，她画画最初只是逃离琴声的方式，却意外变成了她唯一的出口。':cid==='jiang'?'他右手有一处旧伤没有完全康复，但他在决赛前没有告诉任何人。那场球，他打完就去医务室打了封闭针。':'她在打工养弟弟上学，每月工资转给家里，自己只留生活费。学校里没有一个人知道。'}</p></div>`;
        if(aff >= 80) secrets += `<div style="background:#fdf2f8;border-left:3px solid #ec4899;padding:8px 10px;border-radius:0 6px 6px 0;margin-top:8px;"><span style="color:#be185d;font-size:0.7rem;font-weight:bold;">💖 心里话（好感≥80）</span><p style="margin:4px 0 0;font-size:0.8rem;color:#475569;font-style:italic;">${cid==='lin'?'"我想考清华，但如果可以的话……我希望我们能在同一座城市。这是我第一次，把一个人放进我的计划里。"':cid==='xia'?'"我怕我真的会爱上你。你出现得不是时候，我还没准备好让一个人看见我没画完的那些画。"':cid==='jiang'?'"你是我除了球以外，第一个让我想认真保护的人。这话我没跟任何人说过。"':'"谢谢你没有用那种眼神看我……你知道那种眼神。谢谢你让我觉得，我也是个普通人。"'}</p></div>`;
        
        showCustomModal(`${ch.name} · ${ch.title}`, `
            <div style="display:flex;gap:15px;align-items:flex-start;flex-wrap:wrap;">
                <div style="text-align:center;flex-shrink:0;">
                    <img src="src/avatar/${cid}.png" style="max-width:160px;max-height:220px;border-radius:8px;border:3px solid #f9a8d4;"
                        onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                    <div style="display:none;width:120px;height:160px;background:linear-gradient(135deg,#fdf2f8,#fce7f3);border-radius:8px;align-items:center;justify-content:center;border:3px dashed #f9a8d4;flex-direction:column;">
                        <div style="font-size:3rem;">${prof.icon}</div>
                        <div style="font-size:0.8rem;color:${prof.color};margin-top:8px;font-weight:bold;">${ch.name}</div>
                    </div>
                    <div style="margin-top:8px;background:#fdf2f8;border-radius:6px;padding:6px 10px;">
                        <div style="font-size:0.7rem;color:#be185d;font-weight:bold;">好感度</div>
                        <div style="background:#f1f5f9;height:6px;border-radius:3px;overflow:hidden;margin-top:4px;">
                            <div style="background:linear-gradient(90deg,#f472b6,#db2777);height:100%;width:${Math.min(100,aff)}%;transition:0.3s;"></div>
                        </div>
                        <div style="font-size:0.7rem;color:#64748b;margin-top:2px;">${Math.floor(aff)}/100</div>
                    </div>
                </div>
                <div style="flex:1;min-width:200px;text-align:left;">
                    <h3 style="color:${prof.color};margin:0 0 8px;">${ch.name} <span style="font-size:0.8rem;color:#94a3b8;">· ${ch.title}</span></h3>
                    <p style="font-size:0.82rem;color:#475569;line-height:1.6;margin:0 0 10px;">${prof.intro}</p>
                    <div style="display:flex;flex-direction:column;gap:5px;font-size:0.8rem;">
                        <div style="background:#f8fafc;padding:6px 10px;border-radius:6px;"><span style="color:#64748b;font-weight:bold;">爱好：</span>${prof.hobby}</div>
                        <div style="background:#f8fafc;padding:6px 10px;border-radius:6px;"><span style="color:#64748b;font-weight:bold;">害怕：</span>${prof.fear}</div>
                        <div style="background:#f8fafc;padding:6px 10px;border-radius:6px;"><span style="color:#64748b;font-weight:bold;">梦想：</span>${prof.dream}</div>
                        <div style="background:#fdf2f8;padding:8px 10px;border-radius:6px;border-left:3px solid ${prof.color};font-style:italic;color:#475569;">"${prof.quote}"</div>
                    </div>
                    ${secrets}
                </div>
            </div>`, [{text:'关闭', action:()=>{}}]);
    }
    
    function showDialogOptions(cid) {
        if(stuGame.energy < 5) return showToast("精力不足（需要5点）");
        let ch = CRUSHES.find(x=>x.id===cid);
        let options = CRUSH_DIALOGUE_OPTIONS[cid] || [];
        let selected = [...options].sort(()=>Math.random()-0.5).slice(0,5);
        let curAff = (stuGame.crushes[cid]&&stuGame.crushes[cid].aff)||0;
        let html = `<p style="color:#64748b; font-size:0.85rem; margin-top:0;">和 ${ch.name} 聊什么？（当前好感：<b style="color:#db2777;">${Math.floor(curAff)}</b>/100）</p>
        <div style="display:flex;flex-direction:column;gap:8px;">`;
        selected.forEach((opt) => {
            let idx = options.indexOf(opt);
            html += `<button class="btn" style="text-align:left;padding:12px 14px;font-size:0.9rem;" onclick="pickDialogOption('${cid}',${idx})">${opt.text}</button>`;
        });
        html += '</div>';
        showCustomModal(`💬 和 ${ch.name} 聊天`, html, [{text:'算了，不说了', action:()=>{}}]);
    }
    
    function pickDialogOption(cid, optIdx) {
        stuGame.energy -= 5;
        let ch = CRUSHES.find(x=>x.id===cid);
        let opt = CRUSH_DIALOGUE_OPTIONS[cid][optIdx];
        let data = stuGame.crushes[cid];
        let oldAff = data.aff;
        data.aff = Math.max(0, Math.min(100, data.aff + opt.effect));
        let delta = Math.round(data.aff - oldAff);
        let deltaStr = delta > 0 ? `<span style="color:#10b981;font-weight:bold;font-size:1.1rem;">+${delta} 好感 💚</span>` : delta < 0 ? `<span style="color:#ef4444;font-weight:bold;font-size:1.1rem;">${delta} 好感 ❤️‍🔥</span>` : `<span style="color:#f59e0b;font-weight:bold;">无变化 💛</span>`;
        let resultHtml = `<div style="background:#f8fafc;border-radius:8px;padding:12px;margin-bottom:12px;border-left:3px solid #cbd5e1;">
            <p style="margin:0;font-size:0.9rem;color:#475569;font-style:italic;">"${opt.reply}"</p>
        </div>
        <div style="text-align:center;padding:8px;">${deltaStr}<br><span style="font-size:0.8rem;color:#64748b;">当前好感：${Math.floor(data.aff)}/100</span></div>`;
        showCustomModal(`💬 ${ch.name} 的回应`, resultHtml, [{text:'明白了', action:()=>{ checkCrushBuff(cid); renderStuCrushes(); updateStuUI(); }}]);
    }
    
    function showGiftMenu(cid) {
        let ch = CRUSHES.find(x=>x.id===cid);
        let gifts = GIFT_CATALOG[cid] || [];
        let html = `<p style="color:#64748b; font-size:0.85rem; margin-top:0;">选择一份礼物送给 ${ch.name}：</p><div style="display:flex;flex-direction:column;gap:8px;">`;
        gifts.forEach((g, i) => {
            html += `<button class="btn" style="text-align:left; padding:10px 12px;" onclick="giveGift('${cid}',${i})">
                🎁 ${g.name} <span style="color:#94a3b8; font-size:0.75rem;">￥${g.cost}</span>
            </button>`;
        });
        html += '</div>';
        showCustomModal(`🎁 给 ${ch.name} 送礼物`, html, [{text:'取消', action:()=>{}}]);
    }
    
    function giveGift(cid, giftIdx) {
        let gifts = GIFT_CATALOG[cid];
        let g = gifts[giftIdx];
        if(stuGame.money < g.cost) return showToast("零花钱不足！");
        stuGame.money -= g.cost;
        let data = stuGame.crushes[cid];
        data.aff = Math.max(0, Math.min(100, data.aff + g.effect));
        showToast(g.effect > 0 ? `💝 ${CRUSHES.find(x=>x.id===cid).name} 似乎很喜欢这份礼物` : `💔 这份礼物好像没送到心坎里……`);
        let dBox = document.getElementById(`dialog-${cid}`);
        if(dBox) { dBox.style.display='block'; dBox.innerText = g.reply; }
        checkCrushBuff(cid);
        renderStuCrushes();
        updateStuUI();
    }
    
    function checkCrushBuff(cid) {
        let data = stuGame.crushes[cid];
        if(data && data.aff >= 30) {
            let b = getCrushBuff(cid, data.aff);
            if(b) b.apply();
        }
    }
    function renderStuFriends() {
        let c = document.getElementById('stu-friends-container');
        c.innerHTML = FRIENDS.map(f => {
            let has = stuGame.friends.includes(f.id);
            return `<div class="friend-card ${has?'active':''}">
                <div><b>${f.name}</b><br><span style="font-size:0.75rem">${f.desc}</span></div>
                ${has?'<span style="color:var(--success);font-weight:bold;">已结交</span>':`<button class="btn" style="margin:0;padding:4px;" onclick="buyFriend('${f.id}',${f.cost})">结交 ￥${f.cost}</button>`}
            </div>`;
        }).join('');
    }
    function buyFriend(id, cost) {
        if(stuGame.money >= cost) {
            stuGame.money -= cost;
            stuGame.friends.push(id);
            renderStuFriends();
            updateStuUI();
        } else showToast("零花钱不足");
    }

    function organizeExam() { 
        if(!payCost(3,2)) return;
        game.eduPoints += 3;
        
        let total = game.students;
        let baseScore = game.grade * 6 + 150; 
        
        let t_qb = Math.floor(total * (baseScore > 680 ? (baseScore-680)/400 : 0)); 
        let t_985 = Math.floor(total * (baseScore > 600 ? (baseScore-600)/350 : 0)); 
        let t_211 = Math.floor(total * (baseScore > 550 ? (baseScore-550)/300 : 0)); 
        let t_bk = Math.floor(total * (baseScore > 450 ? (baseScore-450)/250 : 0)); 
        let t_zk = Math.floor(total * (baseScore > 300 ? (baseScore-300)/200 : 0)); 
        
        t_985 = Math.max(0, t_985 - t_qb);
        t_211 = Math.max(0, t_211 - t_985 - t_qb);
        t_bk = Math.max(0, t_bk - t_211 - t_985 - t_qb);
        t_zk = Math.max(0, t_zk - t_bk - t_211 - t_985 - t_qb);
        let t_fail = Math.max(0, total - t_qb - t_985 - t_211 - t_bk - t_zk);
        
        let upline = total - t_fail;
        let uplinePct = Math.floor(upline/total*100);
        // 模拟阅卷不加声誉，只给教研点和数据分析
        
        let html = `
        <div class="chart-container" style="width:100%;">
            <div class="chart-col"><div class="chart-bar" style="background:#ef4444; height:${Math.max(2, (t_qb/total)*150)}px;">${t_qb}</div><div class="chart-label">清北</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#8b5cf6; height:${Math.max(2, (t_985/total)*150)}px;">${t_985}</div><div class="chart-label">985</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#3b82f6; height:${Math.max(2, (t_211/total)*150)}px;">${t_211}</div><div class="chart-label">211</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#10b981; height:${Math.max(2, (t_bk/total)*150)}px;">${t_bk}</div><div class="chart-label">一本</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#f59e0b; height:${Math.max(2, (t_zk/total)*150)}px;">${t_zk}</div><div class="chart-label">二本</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#64748b; height:${Math.max(2, (t_fail/total)*150)}px;">${t_fail}</div><div class="chart-label">落榜</div></div>
        </div>
        <p style="text-align:center;">教研点 +3 | 上线率: ${uplinePct}%（模拟考不计入声誉）</p>
        `;
        
        showCustomModal("📊 全校模拟考六档分析", html, [{text:"确认归档", action:updateUI}]);
        log(`举办模考，清北 ${t_qb} 人，一本上线 ${t_bk+t_211+t_985+t_qb} 人`); 
        updateUI();
    }

    // ================= 结局评级与终极拷问 =================
    const RATING_QUOTES = [
        { grade: 'S', name: '教育改革者', quote: '真正的教育，不是把篮子装满，而是把灯点亮。你做到了。', color: '#fbbf24' },
        { grade: 'A', name: '良师益友', quote: '分数会被遗忘，但你给予学生的勇气和尊严，将伴随他们一生。', color: '#60a5fa' },
        { grade: 'B', name: '务实校长', quote: '你在体制与人性之间艰难平衡。历史会记住，你曾努力过。', color: '#34d399' },
        { grade: 'C', name: '分数机器', quote: '高分是你交出的答卷，但那些被榨干的少年，谁来为他们答卷？', color: '#f59e0b' },
        { grade: 'D', name: '制度帮凶', quote: '你以为自己在铸造未来，却不知亲手建起了一座精神的囚笼。', color: '#ef4444' }
    ];
    
    function getStuRating() {
        let score = stuGame.examScore || 0;
        let stress = stuGame.stress || 0;
        let hasLover = stuGame.lover;
        let friends = stuGame.friends.length;
        let pts = 0;
        if(score >= 680) pts = 90;
        else if(score >= 620) pts = 75;
        else if(score >= 550) pts = 60;
        else if(score >= 450) pts = 45;
        else pts = 25;
        if(hasLover) pts += 10;
        pts += friends * 3;
        if(stuGame.isInsured) pts += 15;
        if(stress >= 90) pts -= 25;
        else if(stress >= 70) pts -= 10;
        const STU_RATINGS = [
            { grade: 'S', name: '全面发展的青春', quote: '你用分数证明了自己，也用温度留住了别人。这样的高中时光，值得被铭记。', color: '#fbbf24' },
            { grade: 'A', name: '无悔的少年', quote: '成绩不是你唯一的勋章。那些笑过、哭过、爱过的瞬间，才是真正属于你的财富。', color: '#60a5fa' },
            { grade: 'B', name: '普通却真实', quote: '你没有成为别人期待的样子，但你一直是你自己。这已经很了不起了。', color: '#34d399' },
            { grade: 'C', name: '被分数吞噬的三年', quote: '你赢了考试，却输了一些更珍贵的东西。希望大学能给你重新认识自己的机会。', color: '#f59e0b' },
            { grade: 'D', name: '还没开始就结束了', quote: '三年，你扛着比同龄人更重的东西。无论结果如何，你撑下来了。这已经是英雄。', color: '#ef4444' }
        ];
        if(pts >= 85) return STU_RATINGS[0];
        if(pts >= 65) return STU_RATINGS[1];
        if(pts >= 45) return STU_RATINGS[2];
        if(pts >= 25) return STU_RATINGS[3];
        return STU_RATINGS[4];
    }

    // ========== 20+种学生结局系统 ==========
    function getStudentEnding() {
        let score = stuGame.examScore || 0;
        let stress = stuGame.stress || 0;
        let isInsured = stuGame.isInsured;
        let hasLover = stuGame.lover;
        let loverName = stuGame.loverName;
        let friends = stuGame.friends.length;
        let money = stuGame.money || 0;
        // 关键节点标记 (从游戏过程中收集)
        let flags = stuGame.endingFlags || {};
        
        // 优先级最高的特殊结局
        if(isInsured) return {
            id:'E_OLYMPIAD', icon:'🏅', name:'竞赛保送之路',
            title:'奥赛保送，直达清北',
            desc:`你在竞赛中展现了超越常人的天赋，绕过了高考这条独木桥，直接被清华大学录取。
站在清华园里，你意识到：真正让你走到这里的，不是那些做了无数遍的真题，而是那个凌晨两点仍在攻克难题、眼睛发亮的自己。`,
            color:'#fbbf24', emoji:'🎓'
        };
        if(stress >= 95 && score < 400) return {
            id:'E_BREAKDOWN', icon:'💔', name:'被压垮的少年',
            title:'高考前夕的崩溃',
            desc:`高考前三天，你请了病假。不是身体，是心。医生说你是重度焦虑，需要休息。
你没有参加高考。这在当时像一场地震，但五年后，当你在一家咖啡馆里做着自己喜欢的事，你有时会想：也许那次崩溃，才是真正的拯救。`,
            color:'#6366f1', emoji:'🌱'
        };
        if(flags.dropout) return {
            id:'E_DROPOUT', icon:'🎒', name:'中途退学',
            title:'我选择了另一条路',
            desc:`你在高二退了学。所有人都说你疯了，你妈哭了三天。
三年后，你的手工皮具品牌在网上爆红，月营业额超过了班上大多数同学的工资。你不知道这算不算成功，但你知道，那天迈出校门的自己，比任何时候都诚实。`,
            color:'#f59e0b', emoji:'✂️'
        };
        if(hasLover && score < 450) return {
            id:'E_EARLY_LOVE', icon:'💕', name:'爱情，比成绩更重',
            title:'分数不高，但心里有人',
            desc:`你没考上什么好大学，但你和${loverName}在同一座城市，读着不同的学校。
周末的时候你们骑着单车去吃路边摊，她/他说这比上清华更幸福。也许吧。但你私下里，仍然在学一门技能——不是为了证明什么，只是不想让她/他的将来，因为你而变窄。`,
            color:'#f472b6', emoji:'💕'
        };
        if(flags.workToStudy && money >= 2000) return {
            id:'E_WORKER', icon:'🔧', name:'打工仔的逆袭',
            title:'一边打工，一边读书',
            desc:`你高中三年都在打工补贴家用。成绩不算顶尖，但你的自律和吃苦精神让你在大学一毕业就升了组长。
三十岁的你管着二十个人，你对他们说：我没上过985，但我上过比985更难的学校——生活。`,
            color:'#10b981', emoji:'💪'
        };
        if(score >= 680) return {
            id:'E_ELITE', icon:'🎓', name:'清北之路',
            title:'顶尖名校，荣耀与代价',
            desc:`你如愿考上了顶尖名校。开学第一天站在未名湖边，你觉得三年的辛苦值了。
但大二的某个深夜，你对着天花板想：我喜欢什么？我为什么在这里？那个问题悬在空中，至今没有答案。
成功有时候是一个漂亮的牢笼——但至少，是你自己选的。`,
            color:'#ef4444', emoji:'🏛️'
        };
        if(score >= 600 && friends >= 3) return {
            id:'E_985_SOCIAL', icon:'🤝', name:'985+人生赢家',
            title:'成绩与友情，都没落下',
            desc:`985高校，加上三个真正的朋友。你大学四年最常被问的问题是：你当年高中是怎么过的？
你想了想，说：挺好的，有人陪。那是实话。`,
            color:'#3b82f6', emoji:'👥'
        };
        if(score >= 550) return {
            id:'E_211', icon:'📚', name:'211本科，稳扎稳打',
            title:'不算顶尖，但够用一生',
            desc:`211大学，中等成绩，普通但踏实的青春。
你没有成为传说，但你有了一份稳定的工作，养了一只猫，每逢假期回到这座城市，站在学校门口，你会想：三年，也挺好的。`,
            color:'#8b5cf6', emoji:'🎯'
        };
        if(score >= 450) return {
            id:'E_REEXAM', icon:'🔄', name:'复读一年，重新出发',
            title:'再来一年，我不甘心',
            desc:`一本线差了一点。你选择了复读。那一年是你人生里最孤独的一年——同学都走了，你一个人坐在教室里。
第二年，你考上了满意的学校。但让你真正成长的，是复读那一年的沉默与坚持。`,
            color:'#f59e0b', emoji:'🌅'
        };
        if(score >= 300) return {
            id:'E_ORDINARY', icon:'🌱', name:'普通，也是一种答案',
            title:'二本生的平静人生',
            desc:`二本，不是理想中的结果。刚开始你有些沮丧，但慢慢地，你发现大学里有很多人和你一样——努力过、没达到，但照样在活着。
十年后，你经营着一家小店，顾客都是回头客。你不红，但扎实。`,
            color:'#64748b', emoji:'☕'
        };
        if(stress >= 80 && score >= 600) return {
            id:'E_HOLLOW', icon:'🪆', name:'空心优等生',
            title:'考上了，但什么都没了',
            desc:`你考上了好大学，但进校园的第一学期你就退出了所有社团。你感到一种奇特的空洞。
心理咨询师说这叫"空心病"——为了目标活了十八年，目标实现了，自己却不见了。
你在慢慢找回来。`,
            color:'#94a3b8', emoji:'🔍'
        };
        if(friends >= 4 && score < 500) return {
            id:'E_FRIENDSHIP', icon:'🎭', name:'人比分数重要',
            title:'成绩一般，但交到了一生的朋友',
            desc:`你没考上什么好学校，但高中三年你交到了四个真正的朋友。毕业十年，你们还是每年聚一次。
有一次喝酒，有人说：我宁愿要那段时光，不要那张文凭。你们都沉默了一下，然后哈哈大笑。`,
            color:'#fb923c', emoji:'🍻'
        };
        // 默认结局
        return {
            id:'E_DEFAULT', icon:'🚶', name:'普通的，真实的人生',
            title:'没有传奇，但有自己',
            desc:`没有戏剧性的反转，也没有高光时刻。你考了一个说得过去的分数，去了一所说得过去的学校，过着说得过去的生活。
但有一天你发现，那些你以为"说得过去"的事，都是你一点一点选出来的。
这就是你的人生。没有别人的，只有你的。`,
            color:'#475569', emoji:'🌏'
        };
    }
    
    function showFinalRating(mode) {
        let rating = mode === 'student' ? getStuRating() : getGameRating();
        let html = `<div style="text-align:center;">
            <div style="font-size:5rem; font-weight:900; color:${rating.color}; text-shadow: 0 0 20px ${rating.color};">${rating.grade}</div>
            <h2 style="color:${rating.color}; margin:5px 0;">${rating.name}</h2>
            <p style="font-size:1.05rem; color:#475569; font-style:italic; margin:15px 0; line-height:1.7; padding:15px; background:#f8fafc; border-left:4px solid ${rating.color}; text-align:left; border-radius:0 8px 8px 0;">"${rating.quote}"</p>`;
        
        if(mode === 'student') {
            let ending, stuScore;
            try {
                ending = getStudentEnding();
                stuScore = stuGame.examScore || 0;
            } catch(e) {
                ending = { name:'结局加载失败', desc:'数据异常，请重试。', color:'#94a3b8', emoji:'⚠️' };
                stuScore = 0;
            }
            let stuLabel = stuScore>=680?'清北录取 🎉':stuScore>=600?'985录取':stuScore>=550?'211录取':stuScore>=450?'一本录取':stuScore>=300?'二本录取':'未能录取';
            
            // 结局卡片
            html += `<div style="background:linear-gradient(135deg,${ending.color}22,${ending.color}11);border:2px solid ${ending.color};border-radius:12px;padding:18px;margin-bottom:15px;text-align:left;">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                    <span style="font-size:2.5rem;">${ending.emoji}</span>
                    <div>
                        <div style="font-size:0.7rem;color:${ending.color};font-weight:bold;letter-spacing:2px;">YOUR ENDING</div>
                        <div style="font-size:1.2rem;font-weight:900;color:#1e293b;">${ending.name}</div>
                    </div>
                </div>
                <p style="color:#374151;font-size:0.88rem;line-height:1.8;white-space:pre-line;margin:0;">${ending.desc}</p>
            </div>`;
            
            // 学生成绩摘要
            html += `<div style="background:#f8fafc;border-radius:8px;padding:12px;text-align:left;font-size:0.85rem;margin-bottom:12px;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">
                    <div>📊 高考：<b style="color:var(--primary);">${stuScore}分</b> (${stuLabel})</div>
                    <div>😰 最终压力：${Math.floor(stuGame.stress)}</div>
                    <div>💕 ${stuGame.lover?'💘 与'+stuGame.loverName+'在一起':'💔 单身狗'}</div>
                    <div>👫 死党：${stuGame.friends.length}人</div>
                    <div>🏅 奥赛保送：${stuGame.isInsured?'✅ 是':'❌ 否'}</div>
                    <div>💰 剩余：￥${stuGame.money}</div>
                </div>
            </div>`;
            
            // 同学们的十年后
            html += `<h3 style="margin:10px 0 8px;color:#1e293b;text-align:left;font-size:1rem;">🔮 你的同学们，十年后……</h3><div style="display:flex;flex-direction:column;gap:8px;">`;
            const FUTURES = {
                'lin':{
                    high:'林知秋考上了清华，成了一位助理教授。但她最近在写一篇论文，题目叫《中国高中生的心理创伤与认知模式》——她研究的，正是她自己。',
                    mid:'林知秋考上了985，毕业后做了一名高中数学老师。她给学生布置的作业比同事少一半，她说：够了就够了。',
                    low:'林知秋没有考上清华。她辗转读了一所普通院校，毕业后去了一家出版社做编辑。她终于开始让人看她写的诗了。'
                },
                'xia':{
                    high:'夏晚晴的画作在米兰一个小画廊展出，入场费五欧元。她说那是她人生最好的一天。',
                    mid:'夏晚晴在一家广告公司做设计，偶尔接自己的私活儿。她把客厅一面墙涂成了黑色，说那是她的宇宙。',
                    low:'夏晚晴高中没读完就辍学了。现在在网上卖手绘，月入三千，养活自己。她说：还不错。'
                },
                'jiang':{
                    high:'江一舟进了省队，没进国家队，但当上了一所中学的体育老师。他带的篮球队连续三年拿了市冠军。',
                    mid:'江一舟大学打了四年校队，毕业后做了销售。右手在变天时还会疼，但他不提。他说那是他的勋章。',
                    low:'江一舟高三没打成球，读了个大专，毕业后开了个小店卖运动器材。每周日下午他还是会去球场，和一群叔叔们打半场。'
                },
                'shen':{
                    high:'沈渔的乐队在地下音乐圈有了一些名气，出了一张EP。她在最后一首歌的备注里写：献给那个我以为不重要的自己。',
                    mid:'沈渔高中毕业后去了大城市，白天上班，晚上在酒吧驻唱。弟弟已经上大学了，她觉得自己可以开始为自己活了。',
                    low:'沈渔没能撑完高中就走了。她去了南方的一个工厂，工作很累，但赚了钱。弟弟考上了大学，她在视频里哭了。她说：够了。'
                }
            };
            CRUSHES.forEach(ch => {
                let data = stuGame.crushes[ch.id];
                let aff = data ? data.aff : 0;
                let f = FUTURES[ch.id];
                let story = aff >= 70 ? f.high : aff >= 35 ? f.mid : f.low;
                let borderColor = aff >= 70 ? '#f472b6' : aff >= 35 ? '#60a5fa' : '#94a3b8';
                html += `<div style="background:#f8fafc;padding:10px;border-radius:8px;border-left:3px solid ${borderColor};text-align:left;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <b style="color:#1e293b;font-size:0.9rem;">${ch.name}</b>
                        <span style="font-size:0.7rem;color:${borderColor};">好感度 ${Math.floor(aff)}</span>
                    </div>
                    <p style="margin:4px 0 0;font-size:0.8rem;color:#475569;font-style:italic;">${story}</p>
                </div>`;
            });
            html += '</div>';
        } else {
            // 校长模式：触发"十年后的校友回访"
            let alumni;
            try { alumni = generateAlumniVisit(); } catch(e) { alumni = []; }
            html += `<div style="background:#f8fafc;padding:15px;border-radius:8px;margin-top:10px;text-align:left;">
                <h4 style="margin:0 0 10px;color:#1e293b;">🏫 学校建设成果</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.88rem;">
                    <div>⭐ 最终声誉：${Math.floor(game.reputation)}</div>
                    <div>💰 资金：${Math.floor(game.funds)}万</div>
                    <div>📚 学业：${Math.floor(game.grade)}</div>
                    <div>🎓 高考届数：${game.gaokaoHistory.length}</div>
                    <div>🏆 联考积分：${game.examPoints}</div>
                    <div>🗓️ 办学：${game.year - 2018}年</div>
                </div>
            </div>
            <h4 style="margin:15px 0 8px;color:#1e293b;">👤 校友回访日 · 十年后他们说……</h4>
            <div style="display:flex;flex-direction:column;gap:8px;">
                ${alumni.length ? alumni.map(a=>`<div style="background:${a.bg};padding:10px;border-radius:8px;border-left:3px solid ${a.color};text-align:left;">
                    <div style="font-size:0.75rem;color:${a.color};font-weight:bold;">${a.tag} · ${a.type}</div>
                    <p style="margin:4px 0 0;font-size:0.82rem;color:#374151;font-style:italic;">"${a.quote}"</p>
                </div>`).join('') : '<p style="color:#94a3b8;">继续办学，会有更多校友回来……</p>'}
            </div>`;
        }
        html += '</div>';
        showCustomModal(`${mode==='student'?'👨‍🎓 学生生涯':'🏫 校长生涯'} · 结局评价`, html, [{text:'铭记于心', action:()=>{ showEndPoem(); }}]);
    }

    function generateAlumniVisit() {
        let rep = game.reputation;
        let stress = game.stress;
        let grade = game.grade;
        let alumni = [];
        
        if(grade >= 80 && stress >= 80) alumni.push({
            tag:'清华毕业生', type:'高分学生·十年后', color:'#ef4444', bg:'#fef2f2',
            quote:`校长，我如您所愿考上了清华。现在是某互联网公司的P8。但我想问您一个问题：当年那道月考的最后一题，您真的觉得比我们的睡眠更重要吗？`
        });
        if(grade >= 60 && stress < 60) alumni.push({
            tag:'985毕业生', type:'普通学生·十年后', color:'#60a5fa', bg:'#eff6ff',
            quote:`那时候学校压力不算太大，我读了985，现在在一家研究所做科研。我常常庆幸：当年那个校长，还记得我们是人。`
        });
        if(stress >= 90) alumni.push({
            tag:'匿名校友', type:'中途退学者·十年后', color:'#94a3b8', bg:'#f8fafc',
            quote:`我没有毕业。压力太大，我走了。我现在还好，但我不会回那所学校的——不是因为恨，是因为怕。`
        });
        if(rep < 200) alumni.push({
            tag:'家长代表', type:'当年质疑者', color:'#f59e0b', bg:'#fffbeb',
            quote:`我当年就说那所学校不靠谱。现在孩子去了另一所，考得还行。您知道吗，声誉这种东西，孩子们比大人更能感受到。`
        });
        alumni.push({
            tag:'问题学生', type:'当年的刺儿头', color:'#10b981', bg:'#f0fdf4',
            quote:`您可能不记得我了，我当年老闯祸。我现在开了个小公司，三十个员工。我招人只看一件事：这个人有没有自己的想法。`
        });
        if(game.gaokaoHistory.length >= 5) alumni.push({
            tag:'乡村教师', type:'普通毕业生', color:'#8b5cf6', bg:'#faf5ff',
            quote:`我没考上什么好学校，现在在偏远山区教小学。这里没人知道985是什么，但孩子们知道：有人在乎他们。我想，这就够了。`
        });
        return alumni.slice(0, 4);
    }

    function getGameRating() {
        let score = 0;
        score += Math.min(40, game.reputation / 250 * 40);   // rep 10000 满分
        score += Math.min(20, game.grade / 100 * 20);        // grade 0-100 满分
        score += Math.min(10, (100 - game.stress) / 100 * 10);
        score += Math.min(10, game.discipline / 100 * 10);
        score += Math.min(10, game.fitness / 100 * 10);
        score += Math.min(10, game.art / 100 * 10);
        if(game.stress > 80) score -= 20;
        if(hasPolicy('A8')) score -= 15;
        if(hasPolicy('B6')) score -= 10;
        if(hasPolicy('D7') || hasPolicy('D8')) score += 15;
        score = Math.max(0, score);
        if(score >= 80) return RATING_QUOTES[0];
        if(score >= 60) return RATING_QUOTES[1];
        if(score >= 40) return RATING_QUOTES[2];
        if(score >= 20) return RATING_QUOTES[3];
        return RATING_QUOTES[4];
    }
    
    function showGaokaoHistory() {
        if(!game.gaokaoHistory || game.gaokaoHistory.length === 0) {
            return showCustomModal("📊 历年高考", "尚未举办过高考，请继续推演至六月。", [{text:"好的", action:()=>{}}]);
        }
        let maxQb = Math.max(1, ...game.gaokaoHistory.map(h=>h.qb||0));
        let barsHtml = game.gaokaoHistory.slice(-10).map(h => {
            let barH = Math.max(4, Math.floor((h.qb/maxQb)*150));
            let upH = Math.max(2, Math.floor((h.upline/100)*30));
            return `<div style="display:flex;flex-direction:column;align-items:center;flex:1;min-width:40px;">
                <div style="font-size:0.6rem;color:#ef4444;font-weight:bold;">${h.qb}清北</div>
                <div style="background:#ef4444;width:80%;height:${barH}px;border-radius:3px 3px 0 0;min-height:4px; margin-bottom:2px;"></div>
                <div style="background:#3b82f6;width:80%;height:${upH}px;border-radius:3px 3px 0 0;"></div>
                <div style="font-size:0.55rem;color:#64748b;margin-top:3px;text-align:center;">${h.year}<br>${h.upline}%</div>
            </div>`;
        }).join('');
        let tableHtml = `<table style="width:100%;border-collapse:collapse;font-size:0.8rem;margin-top:15px;">
            <tr style="background:#f1f5f9;font-weight:bold;"><td style="padding:5px;">年份</td><td>均分</td><td>清北</td><td>985</td><td>211</td><td>一本</td><td>上线率</td></tr>`;
        game.gaokaoHistory.forEach(h => {
            tableHtml += `<tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:4px;font-weight:bold;">${h.year}</td><td style="color:#ef4444;">${h.avg}</td><td style="color:#ef4444;">${h.qb}</td><td style="color:#8b5cf6;">${h.rep985}</td><td style="color:#3b82f6;">${h.p211}</td><td style="color:#10b981;">${h.bk}</td><td style="color:#64748b;">${h.upline}%</td></tr>`;
        });
        tableHtml += '</table>';
        showCustomModal("📊 历年高考成绩记录", `<div style="background:#f8fafc;border-radius:8px;padding:10px;border:1px solid #e2e8f0;"><div style="display:flex;align-items:flex-end;height:180px;gap:4px;justify-content:space-around;">${barsHtml}</div><div style="text-align:center;font-size:0.65rem;color:#94a3b8;margin-top:5px;">🟥 红柱=清北人数 &nbsp;🟦 蓝柱=上线率</div></div>${tableHtml}`, [{text:"关闭", action:()=>{}}]);
    }
    
    function runAction(t) {
        if(t==='sponsor') { 
            if(payCost(4,0)) { 
                initSocialRelations();
                let base = [50, 100, 200, 400, 800][game.levelIdx] || 50;
                let socialBonus = Math.floor(((game.social.govRelations.local + game.social.govRelations.media) / 200) * base * 0.6);
                let total = base + socialBonus;
                game.funds += total; 
                game.reputation -= 20; 
                log(`🤝 拉赞助获得 ￥${total}万（基础${base}+社会关系+${socialBonus}）`); 
                updateUI(); 
            } 
        }
    }

    // =========== 社会关系系统 ===========
    function initSocialRelations() {
        if(!game.social) game.social = {
            teacherFactions: { young: 50, old: 50, reform: 50 },
            govRelations: { local: 50, edu_bureau: 45, media: 30 },
            communityRel: 40,
            principals: [],
            lastInspection: -12,
            inspectionWarned: false,
            monthlyTargets: [],
            targetGenMonth: -1
        };
    }

    function showSocialWindow() {
        initSocialRelations();
        let s = game.social;
        let html = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
        
        <!-- 教师派系 -->
        <div style="background:#f8fafc;border-radius:10px;padding:15px;border-left:4px solid #8b5cf6;">
            <h3 style="margin:0 0 10px;color:#6d28d9;">👩‍🏫 教师派系关系</h3>
            ${[['young','🌱 年轻改革派','#10b981'],['old','📚 保守传统派','#6366f1'],['reform','⚡ 激进改革派','#f59e0b']].map(([k,name,color])=>`
            <div style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;font-size:0.85rem;">
                    <span>${name}</span><b style="color:${color};">${s.teacherFactions[k]}/100</b>
                </div>
                <div style="background:#e2e8f0;height:6px;border-radius:3px;overflow:hidden;">
                    <div style="background:${color};height:100%;width:${s.teacherFactions[k]}%;"></div>
                </div>
            </div>`).join('')}
            <div style="display:flex;gap:5px;flex-wrap:wrap;">
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('teacher_young')">支持年轻派 (AP:1)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('teacher_old')">安抚传统派 (AP:1)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('teacher_reform')">激励改革派 (AP:1)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('teacher_gossip')">🕵 查看八卦</button>
            </div>
        </div>

        <!-- 政府关系 -->
        <div style="background:#f8fafc;border-radius:10px;padding:15px;border-left:4px solid #3b82f6;">
            <h3 style="margin:0 0 10px;color:#1d4ed8;">🏛️ 政府与媒体关系</h3>
            ${[['local','🏙️ 地方政府','#60a5fa'],['edu_bureau','📋 教育局','#818cf8'],['media','📡 媒体公关','#f472b6']].map(([k,name,color])=>`
            <div style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;font-size:0.85rem;">
                    <span>${name}</span><b style="color:${color};">${s.govRelations[k]}/100</b>
                </div>
                <div style="background:#e2e8f0;height:6px;border-radius:3px;overflow:hidden;">
                    <div style="background:${color};height:100%;width:${s.govRelations[k]}%;"></div>
                </div>
            </div>`).join('')}
            <div style="display:flex;gap:5px;flex-wrap:wrap;">
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('gov_gift')">送礼打点 (￥10万)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('media_pr')">媒体宣传 (￥5万)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('inspect_prep')">📋 备战视察</button>
            </div>
            <div style="margin-top:8px;background:#fff;border-radius:6px;padding:8px;font-size:0.78rem;color:#475569;">
                ${s.govRelations.edu_bureau>=70?'✅ 教育局认可 - 每月政策拨款':s.govRelations.edu_bureau>=40?'⚠️ 关系一般 - 视察风险较高':'❌ 关系恶劣 - 随时可能被查封'}
            </div>
        </div>

        <!-- 社区关系 -->
        <div style="background:#f8fafc;border-radius:10px;padding:15px;border-left:4px solid #10b981;">
            <h3 style="margin:0 0 10px;color:#065f46;">🏘️ 社区关系</h3>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                <div style="flex:1;background:#e2e8f0;height:10px;border-radius:5px;overflow:hidden;">
                    <div style="background:#10b981;height:100%;width:${s.communityRel}%;transition:0.3s;"></div>
                </div>
                <b style="color:#10b981;">${s.communityRel}/100</b>
            </div>
            <p style="font-size:0.8rem;color:#475569;margin:0 0 8px;">${s.communityRel>=70?'社区居民积极支持，可获得志愿者资源和场地':s.communityRel>=40?'关系尚可，保持现状':s.communityRel>=20?'居民有抱怨，噪音/堵车问题频发':'居民强烈投诉，可能联名请愿要求搬迁'}</p>
            <div style="display:flex;gap:5px;flex-wrap:wrap;">
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('community_event')">🎪 开展社区活动 (￥3万)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('open_campus')">🏫 开放校园设施</button>
            </div>
        </div>

        <!-- 校长圈 -->
        <div style="background:#f8fafc;border-radius:10px;padding:15px;border-left:4px solid #f59e0b;">
            <h3 style="margin:0 0 10px;color:#92400e;">🎓 教育圈人脉</h3>
            <p style="font-size:0.8rem;color:#475569;margin:0 0 10px;">已建立关系: ${(s.principals||[]).length} 所学校</p>
            <div style="display:flex;flex-direction:column;gap:6px;max-height:100px;overflow-y:auto;">
                ${(s.principals||[]).map(p=>`<div style="font-size:0.78rem;padding:4px 8px;background:${p.rel==='ally'?'#f0fdf4':'#fef2f2'};border-radius:4px;">${p.rel==='ally'?'🤝':'⚔️'} ${p.name} (${p.rel==='ally'?'同盟':'竞争'})</div>`).join('')||'<div style="color:#94a3b8;font-size:0.8rem;">尚未建立任何同行关系</div>'}
            </div>
            <div style="display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;">
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('principal_forum')">📣 参加校长论坛 (AP:20)</button>
                <button class="btn" style="font-size:0.75rem;padding:5px 8px;" onclick="socialAct('principal_compete')">⚔️ 挖角竞争对手 (￥20万)</button>
            </div>
        </div>
        </div>`;
        showCustomModal("🤝 社会关系网络", html, [{text:'关闭', action:()=>{}}]);
    }

    function socialAct(t) {
        initSocialRelations();
        let s = game.social;
        if(t==='teacher_young') { if(!payCost(1,0)) return; s.teacherFactions.young=Math.min(100,s.teacherFactions.young+10); s.teacherFactions.old=Math.max(0,s.teacherFactions.old-5); game.grade+=1; showToast("年轻派支持！学业+1"); }
        if(t==='teacher_old') { if(!payCost(1,0)) return; s.teacherFactions.old=Math.min(100,s.teacherFactions.old+10); s.teacherFactions.reform=Math.max(0,s.teacherFactions.reform-5); game.discipline+=2; showToast("传统派安抚！纪律+2"); }
        if(t==='teacher_reform') { if(!payCost(1,0)) return; s.teacherFactions.reform=Math.min(100,s.teacherFactions.reform+10); s.teacherFactions.old=Math.max(0,s.teacherFactions.old-8); game.art+=2; showToast("改革派激励！艺术+2"); }
        if(t==='teacher_gossip') {
            let gossips = [
                `"听说${s.teacherFactions.young>60?'年轻的王老师要去私立学校了':'传统派的赵老师在偷偷兼职培训机构'}"`,
                `"数学组和语文组最近为了办公室空调温度闹矛盾，课代表都被迫站队了……"`,
                `"班主任们私下传：'校长那个月度奖金制度吧，根本就是内部关系户'。"`,
                `"有老师说要集体请假去参加教育局的什么座谈会，说是为了'维权'"`,
                `"年级组长跟教务主任不对付，排课表时有意把对方不喜欢的班排在早8点。"`
            ];
            showCustomModal("🕵️ 教师八卦圈", gossips[Math.floor(Math.random()*gossips.length)], [{text:'当没听见',action:()=>{}},{text:'干预调解',action:()=>{s.teacherFactions.young=Math.min(100,s.teacherFactions.young+5);s.teacherFactions.old=Math.min(100,s.teacherFactions.old+5);showToast("调解成功！");}}]);
            return;
        }
        if(t==='gov_gift') { if(!payCost(0,10)) return; s.govRelations.local=Math.min(100,s.govRelations.local+12); s.govRelations.edu_bureau=Math.min(100,s.govRelations.edu_bureau+8); showToast("关系打点！政府好感+12"); }
        if(t==='media_pr') { if(!payCost(0,5)) return; s.govRelations.media=Math.min(100,s.govRelations.media+15); game.reputation+=20; showToast("媒体宣传！声誉+20"); }
        if(t==='inspect_prep') { 
            showCustomModal("📋 视察应对方案", `距上次视察已过 ${game.year*12+game.month-(s.lastInspection||0)} 个月。\n\n选择应对策略：`, [
                {text:"🎭 精心布置样板课 (￥8万)", action:()=>{ if(payCost(0,8)){s.govRelations.edu_bureau=Math.min(100,s.govRelations.edu_bureau+20); showToast("完美应对！教育局+20");} }},
                {text:"💰 直接打点关键官员 (￥15万)", action:()=>{ if(payCost(0,15)){s.govRelations.edu_bureau=Math.min(100,s.govRelations.edu_bureau+35); showToast("银弹外交！教育局+35");} }},
                {text:"😤 硬抗，展示真实水平", action:()=>{ let pass=game.grade>=60&&game.reputation>=500; s.govRelations.edu_bureau+=pass?10:-15; showToast(pass?"真实力通过！":"实力不足被批评！"); }}
            ]);
            return;
        }
        if(t==='community_event') { if(!payCost(0,3)) return; s.communityRel=Math.min(100,s.communityRel+15); game.reputation+=10; showToast("社区活动圆满！声誉+10"); }
        if(t==='open_campus') { s.communityRel=Math.min(100,s.communityRel+8); game.fitness+=1; showToast("开放校园！社区关系+8"); }
        if(t==='principal_forum') { 
            if(!payCost(20,0)) return;
            const SCHOOL_POOL = ['市一中校长','省实验校长','重点附中校长','市示范高中校长','省重点中学校长','区优质高中校长','市教育集团校长','省属中学校长','市新锐名校校长','区双语学校校长'];
            let existing = (s.principals||[]).map(p=>p.name);
            let available = SCHOOL_POOL.filter(name => !existing.includes(name));
            if(!available.length) { showToast("已认识所有可结识的校长！"); return; }
            let newName = available[Math.floor(Math.random()*available.length)];
            let newSchool = {name: newName, rel:'neutral'};
            if(!s.principals) s.principals=[];
            s.principals.push(newSchool); game.reputation+=10;
            showToast(`结识了 ${newSchool.name}！声誉+10`);
        }
        if(t==='principal_compete') { 
            if(!payCost(0,20)) return;
            game.grade+=5; game.students=Math.min(10000,game.students+100);
            showToast("成功挖走竞争对手的名师！学业+5，生源+100");
        }
        updateUI();
        showSocialWindow();
    }

    // =========== 月度目标系统 ===========
    const TARGET_TEMPLATES = [
        {type:'teach',  icon:'📚', gen:()=>{ let tgt=Math.floor(game.grade+10); return {desc:`将学业提升至 ${tgt} 以上`, check:(snap)=>game.grade>=snap.gradeTarget, snap:{gradeTarget:tgt}, reward:{rep:50,edu:5}, difficulty:'简单'}; }},
        {type:'build',  icon:'🏗️', gen:()=>{ let tgt=game.map.filter(x=>x).length+1; return {desc:'本月新建或升级一座建筑', check:(snap)=>game.map.filter(x=>x).length>=snap.buildTarget, snap:{buildTarget:tgt}, reward:{rep:30,funds:5}, difficulty:'简单'}; }},
        {type:'expert', icon:'👨‍🏫', gen:()=>{ let tgt=game.unlockedExperts.length+1; return {desc:'招募一位新专家', check:(snap)=>game.unlockedExperts.length>=snap.expertTarget, snap:{expertTarget:tgt}, reward:{rep:60,edu:8}, difficulty:'中等'}; }},
        {type:'funds',  icon:'💰', gen:()=>{ let tgt=Math.floor(game.funds+50); return {desc:`资金积累到 ${tgt} 万以上`, check:(snap)=>game.funds>=snap.fundsTarget, snap:{fundsTarget:tgt}, reward:{rep:40,funds:20}, difficulty:'中等'}; }},
        {type:'rep',    icon:'⭐', gen:()=>{ let tgt=Math.floor(game.reputation+200); return {desc:`声誉突破 ${tgt} 点`, check:(snap)=>game.reputation>=snap.repTarget, snap:{repTarget:tgt}, reward:{rep:80,edu:10}, difficulty:'困难'}; }},
        {type:'stress', icon:'😌', gen:()=>{ let tgt=Math.max(20,Math.floor(game.stress-20)); return {desc:`将全校压力降低至 ${tgt} 以下`, check:(snap)=>game.stress<=snap.stressTarget, snap:{stressTarget:tgt}, reward:{rep:50,funds:10}, difficulty:'中等'}; }},
        {type:'battle', icon:'⚔️', gen:()=>{ let tgt=game.examPoints+5; return {desc:'赢得一场联考战斗（联考积分+5）', check:(snap)=>game.examPoints>=snap.examTarget, snap:{examTarget:tgt}, reward:{rep:100,edu:15}, difficulty:'困难'}; }}
    ];

    function generateMonthlyTargets() {
        initSocialRelations();
        if(game.social.targetGenMonth === game.month) return;
        game.social.targetGenMonth = game.month;
        let count = 3 + Math.floor(Math.random()*3);
        let shuffled = [...TARGET_TEMPLATES].sort(()=>Math.random()-0.5).slice(0,count);
        game.social.monthlyTargets = shuffled.map(t=>{
            let g = t.gen();
            return { icon:t.icon, desc:g.desc, reward:g.reward, difficulty:g.difficulty, snap:g.snap, check:g.check, done:false, failed:false };
        });
    }

    function showMonthlyTargets() {
        initSocialRelations();
        generateMonthlyTargets();
        let targets = game.social.monthlyTargets || [];
        let diffColor = {简单:'#10b981',中等:'#f59e0b',困难:'#ef4444'};
        let html = `<p style="color:#475569;font-size:0.85rem;margin-top:0;">完成目标获得奖励，放弃目标声誉-10。</p>
        <div style="display:flex;flex-direction:column;gap:10px;">`;
        targets.forEach((t,i)=>{
            let status = t.done?'✅ 已完成':t.failed?'❌ 已放弃':'⏳ 进行中';
            let statusColor = t.done?'#10b981':t.failed?'#ef4444':'#f59e0b';
            html += `<div style="background:#f8fafc;border-radius:8px;padding:12px;border-left:4px solid ${diffColor[t.difficulty]||'#cbd5e1'};">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:1.2rem;">${t.icon}</span>
                    <span style="font-size:0.7rem;background:${diffColor[t.difficulty]};color:white;padding:2px 6px;border-radius:4px;">${t.difficulty}</span>
                </div>
                <div style="font-size:0.88rem;color:#1e293b;margin:5px 0;">${t.desc}</div>
                <div style="font-size:0.75rem;color:#64748b;">奖励：声誉+${t.reward.rep||0} ${t.reward.edu?'教研点+'+t.reward.edu:''} ${t.reward.funds?'资金+'+t.reward.funds+'万':''}</div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
                    <span style="font-size:0.75rem;color:${statusColor};font-weight:bold;">${status}</span>
                    ${!t.done&&!t.failed?`<div style="display:flex;gap:5px;">
                        <button class="btn" style="font-size:0.7rem;padding:3px 8px;" onclick="claimTarget(${i})">✅ 完成领取</button>
                        <button class="btn" style="font-size:0.7rem;padding:3px 8px;border-color:#ef4444;color:#ef4444;" onclick="abandonTarget(${i})">放弃</button>
                    </div>`:''}
                </div>
            </div>`;
        });
        html += '</div>';
        showCustomModal("🎯 月度目标板", html, [{text:'关闭',action:()=>{}}]);
    }

    function claimTarget(i) {
        let t = game.social.monthlyTargets[i];
        if(t.done||t.failed) return showToast("该目标已处理");
        // 检查条件是否真正满足
        let met = false;
        try { met = t.check ? t.check(t.snap||{}) : false; } catch(e) { met = false; }
        if(!met) return showToast("⚠️ 目标条件尚未达成，无法领取！");
        t.done = true;
        if(t.reward.rep) game.reputation += t.reward.rep;
        if(t.reward.edu) game.eduPoints += t.reward.edu;
        if(t.reward.funds) game.funds += t.reward.funds;
        showToast(`🎉 目标完成！声誉+${t.reward.rep||0}`);
        updateUI(); showMonthlyTargets();
    }
    function abandonTarget(i) {
        let t = game.social.monthlyTargets[i];
        t.failed = true; game.reputation = Math.max(0, game.reputation-10);
        showToast("放弃目标，声誉-10"); updateUI(); showMonthlyTargets();
    }

    // =========== 学科竞赛系统（省级解锁）===========
    const OLYMPIAD_SUBJECTS = [
        {id:'math',   name:'数学联赛', icon:'📐', desc:'以难度和广度著称，全国含金量最高'},
        {id:'physics',name:'物理竞赛', icon:'⚛️', desc:'实验与理论并重，门槛极高'},
        {id:'chem',   name:'化学竞赛', icon:'🧪', desc:'记忆与推理双重考验'},
        {id:'bio',    name:'生物竞赛', icon:'🧬', desc:'实验操作与理论知识融合'},
        {id:'info',   name:'信息竞赛', icon:'💻', desc:'代码与算法，未来最热门'}
    ];

    function showOlympiadSystem() {
        if(game.levelIdx < 3) return showCustomModal("🔒 竞赛系统","该系统需要学校达到【省级名校】才可解锁。继续努力！",[{text:'明白',action:()=>{}}]);
        if(!game.olympiadData) game.olympiadData = {
            squads: {math:{level:0,trained:false},physics:{level:0,trained:false},chem:{level:0,trained:false},bio:{level:0,trained:false},info:{level:0,trained:false}},
            medals: {gold:0,silver:0,bronze:0},
            scholarships: 0
        };
        let od = game.olympiadData;
        let html = `<div style="margin-bottom:12px;background:#eff6ff;border-radius:8px;padding:10px;text-align:center;font-size:0.85rem;">
            🏅 累计金牌: <b style="color:#f59e0b">${od.medals.gold}</b> 
            🥈 银牌: <b style="color:#94a3b8">${od.medals.silver}</b> 
            🥉 铜牌: <b style="color:#cd7f32">${od.medals.bronze}</b> 
            &nbsp;|&nbsp; 保送名额: <b style="color:#10b981">${od.scholarships}</b> 人
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">`;
        
        OLYMPIAD_SUBJECTS.forEach(sub=>{
            let sq = od.squads[sub.id];
            let stageName = ['未组建','省级初赛','全国决赛','国际奥赛'][Math.min(3,sq.level)];
            let stageColor = ['#94a3b8','#3b82f6','#8b5cf6','#f59e0b'][Math.min(3,sq.level)];
            html += `<div style="background:#f8fafc;border:2px solid ${stageColor};border-radius:10px;padding:12px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <span style="font-size:1.8rem;">${sub.icon}</span>
                    <div>
                        <div style="font-weight:bold;font-size:0.9rem;">${sub.name}</div>
                        <div style="font-size:0.65rem;color:${stageColor};font-weight:bold;">${stageName}</div>
                    </div>
                </div>
                <p style="font-size:0.72rem;color:#64748b;margin:0 0 8px;">${sub.desc}</p>
                <div style="display:flex;flex-direction:column;gap:4px;">
                    ${sq.level===0?`<button class="btn" style="font-size:0.73rem;padding:4px;" onclick="olympiadAct('build','${sub.id}')">🔨 组建集训队 (￥15万+AP:2)</button>`:''}
                    ${sq.level>=1&&sq.level<3?`<button class="btn" style="font-size:0.73rem;padding:4px;" onclick="olympiadAct('compete','${sub.id}')">⚔️ 参加比赛 (AP:3)</button>`:''}
                    ${sq.level>=1?`<button class="btn" style="font-size:0.73rem;padding:4px;" onclick="olympiadAct('train','${sub.id}')">🏋️ 强化训练 (￥5万)</button>`:''}
                </div>
            </div>`;
        });
        html += '</div>';
        showCustomModal("🏆 学科奥林匹克竞赛系统", html, [{text:'关闭',action:()=>{}}]);
    }

    function olympiadAct(act, subId) {
        if(!game.olympiadData) return;
        let sq = game.olympiadData.squads[subId];
        let od = game.olympiadData;
        if(act==='build') {
            if(!payCost(2,15)) return;
            sq.level=1; game.reputation+=30; game.eduPoints+=5;
            showToast(`${OLYMPIAD_SUBJECTS.find(s=>s.id===subId).name} 集训队组建完毕！声誉+30`);
        }
        if(act==='train') {
            if(!payCost(0,5)) return;
            sq.trained=true; showToast("强化训练完成！下次参赛成功率提升");
        }
        if(act==='compete') {
            if(!payCost(3,0)) return;
            let sub = OLYMPIAD_SUBJECTS.find(s=>s.id===subId);
            let baseRate = 0.3 + game.grade/300 + (sq.trained?0.2:0) + (sq.level>=2?0.15:0);
            sq.trained = false;
            let roll = Math.random();
            let result, medal='', repGain=0, schGain=0;
            if(roll < baseRate*0.3) { medal='🥇 金牌'; od.medals.gold++; repGain=200; schGain=2; result='金牌！保送名额+2！'; sq.level=Math.min(3,sq.level+1); }
            else if(roll < baseRate*0.7) { medal='🥈 银牌'; od.medals.silver++; repGain=100; schGain=1; result='银牌！保送名额+1！'; sq.level=Math.min(3,sq.level+1); }
            else if(roll < baseRate) { medal='🥉 铜牌'; od.medals.bronze++; repGain=50; result='铜牌！声誉+50'; }
            else { result='未能获奖……明年再来'; repGain=-10; }
            od.scholarships += schGain;
            game.reputation += repGain;
            showCustomModal(`${sub.icon} ${sub.name} 结果`, `${medal||'📋'} ${result}\n\n声誉${repGain>=0?'+':''}${repGain} | 保送名额总计: ${od.scholarships}`, [{text:'确认',action:()=>showOlympiadSystem()}]);
            return;
        }
        updateUI(); showOlympiadSystem();
    }

    // =========== 学生日记/内心独白系统 ===========
    function showStuJournal() {
        if(!stuGame.active) return showCustomModal("📓","请先进入学生模式",[{text:'好',action:()=>{}}]);
        if(!stuGame.journal) stuGame.journal = [];
        let entries = stuGame.journal;
        let autoEntry = generateAutoJournalEntry();
        let html = `<div style="background:#fffbeb;border-radius:8px;padding:15px;border-left:4px solid #f59e0b;margin-bottom:12px;">
            <div style="font-size:0.7rem;color:#92400e;font-weight:bold;">${game.year}年${game.month}月 · 今日心情</div>
            <p style="font-size:0.88rem;color:#78350f;line-height:1.7;margin:6px 0 0;font-style:italic;">"${autoEntry}"</p>
        </div>
        <h4 style="margin:0 0 8px;color:#1e293b;">📖 历史日记</h4>
        <div style="display:flex;flex-direction:column;gap:8px;max-height:200px;overflow-y:auto;">
        ${entries.length?entries.slice(-6).reverse().map(e=>`<div style="background:#f8fafc;border-radius:6px;padding:10px;border-left:3px solid #cbd5e1;">
            <div style="font-size:0.65rem;color:#94a3b8;">${e.date}</div>
            <p style="margin:3px 0 0;font-size:0.82rem;color:#475569;font-style:italic;">"${e.text}"</p>
        </div>`).join('') : '<div style="color:#94a3b8;font-size:0.82rem;">还没有任何日记。通过【写日记】行动来记录你的高中时光。</div>'}
        </div>`;
        showCustomModal("📓 内心日记", html, [
            {text:'写下今日感想', action:()=>{ stuGame.journal.push({date:`${game.year}.${game.month}`,text:autoEntry}); stuGame.stress=Math.max(0,stuGame.stress-5); showToast("写日记减压5"); showStuJournal(); }},
            {text:'关闭', action:()=>{}}
        ]);
    }

    function generateAutoJournalEntry() {
        let stress = stuGame.stress, grade = stuGame.grade, score = stuGame.examScore||0;
        let lover = stuGame.lover, loverName = stuGame.loverName;
        let entries = [
            stress>=80?`今天压力${Math.floor(stress)}，我快喘不过气了。但我不能停，不敢停。我害怕如果我停下来，所有人都会失望。`:`压力${Math.floor(stress)}，还算可以。我告诉自己：每一天都会过去的。`,
            grade>=70?`模拟题做到凌晨，错误率在下降。也许我真的可以？`:`又订正了一遍错题本。做完之后，我坐在那里发了一会儿呆。这一切值得吗？`,
            lover?`今天${loverName}冲我笑了一下。我的心跳突然快了三拍。真的很蠢，但是……很真实。`:`班上有人在谈恋爱，我没说什么。只是想着，如果我也……算了。`,
            `食堂今天有红烧肉。我多打了一份。这是今天唯一让我高兴的事情。`,
            stress>=70?`我不知道为什么要读书。但我也不知道不读书的话，我会是什么。所以我继续读。`:`走廊上看到夕阳把窗子染成金色。我停下来看了三秒钟。然后继续走。`,
        ];
        let idx = Math.floor(Math.random()*entries.length);
        return entries[idx];
    }

    // =========== 深度情感线：角色独立对话与反馈 ===========
    const DEEP_CRUSH_DIALOGUES = {
        'lin': {
            low: [
                {scene:'放学后', line:`"你……是有什么事吗？我要去图书馆了。"`, mood:'警惕'},
                {scene:'早读课', line:`"那道题你选C是错的。是A，你自己去推导一遍。"`, mood:'冷淡'},
                {scene:'课间', line:`"借笔记可以，但不要弄脏。"`, mood:'疏远'}
            ],
            mid: [
                {scene:'放学走廊', line:`"今晚七点数学自习室，如果你愿意的话……可以一起。"`, mood:'试探'},
                {scene:'天台', line:`"……你也喜欢来天台？我以为只有我一个人知道这里。"`, mood:'惊讶'},
                {scene:'考试后', line:`"这次你进步了三名。我注意到了。"`, mood:'关注'}
            ],
            high: [
                {scene:'深夜图书馆', line:`"你说……如果我们都没考上清华，我们还会是朋友吗？"`, mood:'脆弱'},
                {scene:'天台', line:`"我从来没把诗给人看过。但……你可以看。"`, mood:'信任'},
                {scene:'宣誓后', line:`"我不知道喜欢一个人是什么感觉。但当你在的时候，我的世界好像……不那么黑白了。"`, mood:'心动'}
            ]
        },
        'xia': {
            low: [
                {scene:'美术室外', line:`"没事你绕着走，这里在上课。"`, mood:'无视'},
                {scene:'走廊', line:`"借钱的话去找别人，我也不富裕。"`, mood:'戒备'},
                {scene:'音乐课', line:`"……别看我，烦。"`, mood:'抗拒'}
            ],
            mid: [
                {scene:'放学', line:`"你知道今晚有个地下乐队在商场演出吗？……问一句而已，又没叫你去。"`, mood:'暗示'},
                {scene:'美术室', line:`"这是我画的你。拿去吧，不要不要这么惊讶，你表情太有趣了。"`, mood:'大胆'},
                {scene:'操场', line:`"那个……我想给一个人画画，但我不知道他喜不喜欢。"`, mood:'羞涩'}
            ],
            high: [
                {scene:'漫展', line:`"我其实……很怕有一天画不出东西了。你不会说我矫情吗？"`, mood:'袒露'},
                {scene:'江边', line:`"如果我去了米兰，你会来看我的画展吗？"`, mood:'期待'},
                {scene:'画室夜晚', line:`"我不知道爱情是什么。但我知道画你的时候，我的线条比以前更稳了。"`, mood:'深情'}
            ]
        },
        'jiang': {
            low: [
                {scene:'操场', line:`"哟，来看球？站远点，别挡着。"`, mood:'漫不经心'},
                {scene:'走廊', line:`"哈哈不用谢，随手的事。"`, mood:'随意'},
                {scene:'食堂', line:`"那个座位有人的，我朋友的。"`, mood:'疏远'}
            ],
            mid: [
                {scene:'篮球场', line:`"看你跑步姿势不对，等放学我教你。"`, mood:'主动'},
                {scene:'比赛后', line:`"今天你来看了，是吧？谢了……我打得还行吧？"`, mood:'在意'},
                {scene:'操场边', line:`"我手这里……没事，老毛病。你别声张啊，不然主任又让我休赛。"`, mood:'信任'}
            ],
            high: [
                {scene:'深夜操场', line:`"我其实怕打不了球了。但我更怕……不知道如果没有球，我是谁。"`, mood:'真实'},
                {scene:'比赛前', line:`"你今天一定要来啊。认真的，不是开玩笑，我……需要你在场边。"`, mood:'依赖'},
                {scene:'烧烤摊', line:`"你是第一个……让我觉得，哪怕不打球，也还好的人。"`, mood:'深情'}
            ]
        },
        'shen': {
            low: [
                {scene:'走廊', line:`"……"（戴着耳机，没有回应）`, mood:'封闭'},
                {scene:'教室', line:`"有事吗？没事别烦我。"`, mood:'防御'},
                {scene:'门口', line:`"借橡皮？这。不用还了。"`, mood:'冷漠'}
            ],
            mid: [
                {scene:'便利店', line:`"……你也买这个口味吗。"（沉默）"……好吃就行。"`, mood:'意外'},
                {scene:'走廊', line:`"你……看到我从哪里来了？（停顿）……别问。"`, mood:'紧张'},
                {scene:'天台', line:`"你不问我为什么总是很晚回来，是因为你猜到了，还是你根本不在乎？"`, mood:'试探'}
            ],
            high: [
                {scene:'便利店深夜', line:`"我弟说……有人帮他垫了饭钱。是你吗。（沉默）……谢谢。"`, mood:'动容'},
                {scene:'楼梯口', line:`"我不是不想说。是怕说了，你用那种眼神看我。"`, mood:'脆弱'},
                {scene:'天台夜晚', line:`"你是第一个……不问原因、不给建议、只是在的人。"`, mood:'袒露'}
            ]
        }
    };

    function showDeepCrushDialog(cid) {
        if(stuGame.energy < 5) return showToast("精力不足（需要5点）");
        if(!stuGame.crushes[cid]) return showToast("先去认识她/他吧！");
        stuGame.energy -= 5;
        let ch = CRUSHES.find(x=>x.id===cid);
        let aff = (stuGame.crushes[cid]&&stuGame.crushes[cid].aff)||0;
        let tier = aff>=70?'high':aff>=35?'mid':'low';
        let pool = DEEP_CRUSH_DIALOGUES[cid][tier];
        let entry = pool[Math.floor(Math.random()*pool.length)];
        let prof = CRUSH_PROFILES[cid];
        let moodColor = {心动:'#db2777',深情:'#7c3aed',脆弱:'#6366f1',信任:'#0284c7',袒露:'#0891b2',真实:'#0f766e',试探:'#b45309',羞涩:'#be185d',期待:'#7c3aed',在意:'#0369a1',依赖:'#0369a1',大胆:'#7c3aed',暗示:'#92400e',关注:'#065f46',主动:'#059669',惊讶:'#1d4ed8',警惕:'#475569',冷淡:'#475569',疏远:'#64748b',戒备:'#475569',防御:'#475569',随意:'#64748b',漫不经心:'#94a3b8',无视:'#9ca3af',意外:'#b45309',紧张:'#b45309',封闭:'#475569',冷漠:'#94a3b8',动容:'#0891b2',抗拒:'#dc2626'}[entry.mood]||'#475569';

        // 构建情景画面
        let sceneHtml = `<div style="background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:12px;padding:16px 18px;margin-bottom:14px;position:relative;overflow:hidden;">
            <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:${prof.color}08;pointer-events:none;"></div>
            <div style="display:flex;gap:14px;align-items:flex-start;">
                <div style="flex-shrink:0;text-align:center;">
                    <div style="width:56px;height:72px;border-radius:10px;background:${prof.color}22;border:2px solid ${prof.color}55;display:flex;align-items:center;justify-content:center;">
                        <span style="font-size:2.2rem;">${prof.icon}</span>
                    </div>
                    <div style="margin-top:5px;font-size:0.6rem;color:${moodColor};font-weight:900;letter-spacing:1px;text-shadow:0 0 8px ${moodColor};">${entry.mood}</div>
                </div>
                <div style="flex:1;">
                    <div style="font-size:0.68rem;color:#64748b;margin-bottom:8px;letter-spacing:1px;">📍 ${entry.scene}</div>
                    <div style="background:#f8fafc;border-left:4px solid ${prof.color};padding:12px 14px;border-radius:0 10px 10px 0;">
                        <p style="margin:0;font-size:0.93rem;color:#1e293b;line-height:1.8;font-style:italic;">${entry.line}</p>
                    </div>
                </div>
            </div>
        </div>`;

        // 构建有条件的回应选项
        let options = CRUSH_SCENE_OPTIONS[cid] ? (CRUSH_SCENE_OPTIONS[cid][tier] || []) : [];
        // 加上通用选项
        options = options.concat(CRUSH_COMMON_OPTIONS[tier] || []);

        let btns = options.map(opt => {
            let canDo = !opt.req || opt.req();
            return {
                text: canDo ? opt.label : `🔒 ${opt.label} <span style="font-size:0.7rem;color:#94a3b8;">[${opt.reqDesc}]</span>`,
                action: canDo ? () => {
                    let data = stuGame.crushes[cid];
                    data.aff = Math.max(0, Math.min(100, data.aff + opt.effect));
                    if(opt.cost) stuGame.energy = Math.max(0, stuGame.energy - opt.cost);
                    if(opt.fn) opt.fn();
                    // 展示回应对话（不透露好感变化数值）
                    let respHtml = `<div style="background:#f8fafc;border-left:3px solid ${prof.color};padding:12px 14px;border-radius:0 8px 8px 0;margin-bottom:10px;">
                        <p style="margin:0;font-size:0.9rem;color:#1e293b;line-height:1.7;font-style:italic;">"${opt.reply}"</p>
                    </div>
                    <div style="font-size:0.78rem;color:#94a3b8;text-align:center;">${opt.outcome}</div>`;
                    showCustomModal(`💬 ${ch.name} 的回应`, respHtml, [{text:'好的', action:()=>{ checkCrushBuff(cid); renderStuCrushes(); updateStuUI(); }}]);
                } : () => { showToast(opt.reqDesc || '条件不满足'); }
            };
        });
        btns.push({text:'……还是算了', action:()=>{ renderStuCrushes(); updateStuUI(); }});

        showCustomModal(`💬 与 ${ch.name} 的场景`, sceneHtml, btns);
    }

    // ===== 场景对话选项系统 =====
    const CRUSH_SCENE_OPTIONS = {
        'lin': {
            low: [
                { label:'主动借她笔记', reqDesc:'', effect: 3, reply:'……可以。但你用完要还我，而且不能折角。', outcome:'她挑了挑眉，勉强算是接受了你。' },
                { label:'提出一起备考', reqDesc:'学业≥50', req:()=>stuGame.grade>=50, effect: 8, cost:5,
                  reply:'你成绩……嗯，还行。那就……每周二晚上，图书馆三楼。', outcome:'她看了你一眼，看起来认为你还不算浪费时间。' },
                { label:'悄悄放一首她喜欢的诗在她桌上', reqDesc:'艺术≥40', req:()=>stuGame.art>=40, effect: 12, cost:0,
                  reply:'（沉默许久）……你怎么知道我喜欢这首。', outcome:'她把那张纸夹进了课本里。' },
            ],
            mid: [
                { label:'认真听她讲题，提出新思路', reqDesc:'学业≥65', req:()=>stuGame.grade>=65, effect: 10, cost:5,
                  reply:'……这个角度我没想到。（停顿）……你最近进步很快。', outcome:'她第一次正眼看你超过三秒。' },
                { label:'在天台陪她看星星，什么都不说', reqDesc:'', effect: 7, reply:'……你不觉得无聊吗？（停顿）……我其实不介意你在。', outcome:'沉默有时候比任何话都有分量。' },
                { label:'告诉她你读了她写的诗', reqDesc:'好感≥45', req:()=>aff>=45, effect: 15, cost:5,
                  reply:'（脸红）……你怎么看到的。那……你觉得写得怎么样。', outcome:'她试图板起脸，但没有成功。' },
            ],
            high: [
                { label:'说：无论结果如何，我都会在', reqDesc:'', effect: 8, reply:'……（低头）这种话……不能随便说的。（停顿）……但谢谢你。', outcome:'她没有抬头，但你看到她的耳尖红了。' },
                { label:'邀请她高考后一起去看日出', reqDesc:'学业≥80且好感≥70', req:()=>stuGame.grade>=80&&aff>=70, effect: 18, cost:10,
                  reply:'……（很长的沉默）高考结束的那天早上……好。', outcome:'这是她第一次主动答应你的邀请。' },
                { label:'帮她整理她从未给人看过的诗集', reqDesc:'好感≥80', req:()=>aff>=80, effect: 20, cost:0,
                  reply:'（颤抖）……这是……谢谢你，认真对待它们。', outcome:'你知道这意味着什么。她也知道。' },
            ]
        },
        'xia': {
            low: [
                { label:'安静旁观她画画，不打扰', reqDesc:'', effect: 5, reply:'……你不走了？随你。（继续画）', outcome:'她没有赶你走。这已经很难得。' },
                { label:'真诚夸她的画很特别', reqDesc:'艺术≥35', req:()=>stuGame.art>=35, effect: 10, reply:'……哼，你懂画吗？（停顿）……但谢谢。', outcome:'她把画笔换了个姿势握，假装若无其事。' },
                { label:'分享一个冷门的地下乐队给她', reqDesc:'艺术≥50', req:()=>stuGame.art>=50, effect: 14, cost:5, reply:'……等等，你也知道这个？（愣了一下）……还挺有品位的。', outcome:'她第一次对你展露出真实的表情。' },
            ],
            mid: [
                { label:'表示愿意为她的画展当志愿者', reqDesc:'', effect: 8, reply:'……你不怕无聊吗？（停顿）……行，但别帮倒忙。', outcome:'她在你额头上点了根记号笔，算是登记在册。' },
                { label:'陪她参加深夜写生', reqDesc:'体质≥40', req:()=>stuGame.fit>=40, effect: 12, cost:5,
                  reply:'……你不怕冷吗？（把围巾的一端递给你）凑合用吧。', outcome:'你们背靠背坐着，直到天边泛出鱼肚白。' },
                { label:'买下她第一次参展的习作', reqDesc:'零花钱≥300', req:()=>stuGame.money>=300, effect: 20, cost:0, fn:()=>{stuGame.money-=300;},
                  reply:'……你……为什么要买这个，这只是习作——（哑了声音）……谢谢。', outcome:'她把找零硬塞给你，但眼眶是红的。' },
            ],
            high: [
                { label:'说：你的画里我看到了你', reqDesc:'好感≥60', req:()=>aff>=60, effect: 10, reply:'……（停了笔）……那你看到了什么。（认真地问）', outcome:'她放下了防御，第一次想知道你眼里的她。' },
                { label:'答应去米兰看她的个展', reqDesc:'好感≥75', req:()=>aff>=75, effect: 18, cost:0,
                  reply:'……（沉默很久）你说话算数吗？（停顿）……我会给你留票的。', outcome:'她转过身，笑了。是那种你很少见到的、不带防备的笑。' },
                { label:'在她最低落时帮她完成一幅画', reqDesc:'艺术≥70且好感≥80', req:()=>stuGame.art>=70&&aff>=80, effect: 25, cost:10,
                  reply:'……这一笔……是你加的。（放下笔）……你画的，和我的感觉一样。', outcome:'你们谁都没说话，但某种东西已经不需要言语了。' },
            ]
        },
        'jiang': {
            low: [
                { label:'在篮球场边鼓掌', reqDesc:'', effect: 3, reply:'哈，谢啊！今天状态还行吧？', outcome:'他随口一说，但已经记住你在场了。' },
                { label:'和他谈论NBA', reqDesc:'', effect: 7, reply:'真的假的你也看！哪队的？（立刻来了精神）', outcome:'他把你当成了"自己人"。' },
                { label:'帮他把受伤的右手包扎', reqDesc:'体质≥45', req:()=>stuGame.fit>=45, effect: 12, cost:5,
                  reply:'……我说我没事。（但他没有缩手）……谢了，别声张。', outcome:'他第一次在你面前承认了软弱。' },
            ],
            mid: [
                { label:'在他失利的比赛后陪他坐在球场', reqDesc:'', effect: 8, reply:'（长时间沉默）……你不说话啊？（停顿）……其实挺好的。', outcome:'他拍了拍你的肩，没有多说。有些事不需要说。' },
                { label:'帮他悄悄联系运动医学医生', reqDesc:'零花钱≥200', req:()=>stuGame.money>=200, effect: 18, fn:()=>{stuGame.money-=200;},
                  reply:'……这是怎么搞的……（看你）……你为什么要……谢谢你，认真的。', outcome:'他沉默了很久，最后捶了你一下，算是道谢。' },
                { label:'带他去吃他最爱的烧烤', reqDesc:'零花钱≥150', req:()=>stuGame.money>=150, effect: 10, fn:()=>{stuGame.money-=150;},
                  reply:'你请客？行，我不客气啊！（大笑）但下次换我。', outcome:'他吃得很开心。他开心你也开心。' },
            ],
            high: [
                { label:'说：哪怕你不打球，你也是你', reqDesc:'好感≥65', req:()=>aff>=65, effect: 12, reply:'……（愣了很久）……你说的是真的吗。（停顿）……谢了。', outcome:'他没有转移话题，而是认真地看了你一眼。' },
                { label:'在他决赛前偷偷把幸运物塞进他包里', reqDesc:'好感≥75', req:()=>aff>=75, effect: 15, cost:0,
                  reply:'（赛后）这是……你放的？（握住）……我整场都感觉你在看着我。', outcome:'他说这话的时候，耳根有点红。' },
                { label:'大声喊他名字为他打气', reqDesc:'体质≥60且好感≥80', req:()=>stuGame.fit>=60&&aff>=80, effect: 20, cost:0,
                  reply:'（赛后拉住你）刚才那声喊……我在场上听到了。（咧嘴笑）……加油我。', outcome:'他把手搭在你肩上，笑得很灿烂。你心跳漏了一拍。' },
            ]
        },
        'shen': {
            low: [
                { label:'静静坐在她旁边，不说话', reqDesc:'', effect: 4, reply:'……（没有离开）', outcome:'她没有走。这比任何话都重要。' },
                { label:'把耳机接口分给她，一起听音乐', reqDesc:'艺术≥30', req:()=>stuGame.art>=30, effect: 8, reply:'……你听这个？（停顿）……还行。', outcome:'她摘下了一边耳机，把另一边给了你。' },
                { label:'帮她弟弟的学校事务', reqDesc:'学业≥55', req:()=>stuGame.grade>=55, effect: 15, cost:10,
                  reply:'……你怎么知道我弟的事。（停顿）……谢谢。不用你管的。', outcome:'她背对你说谢谢，声音很小，但是真的。' },
            ],
            mid: [
                { label:'深夜一起在便利店吃热关东煮', reqDesc:'零花钱≥100', req:()=>stuGame.money>=100, effect: 10, fn:()=>{stuGame.money-=100;},
                  reply:'……你请我吃？（停顿）……好。下次我请。', outcome:'她说了"下次"，这意味着她已经把你算进了她的计划里。' },
                { label:'悄悄替她垫付弟弟一个月的饭钱', reqDesc:'零花钱≥500', req:()=>stuGame.money>=500, effect: 22, fn:()=>{stuGame.money-=500;},
                  reply:'……（很长的沉默）你……为什么要这样做。（眼眶发红）……我会还你的。', outcome:'她没有拒绝。这对她来说已经是莫大的信任。' },
                { label:'告诉她：你不需要解释，我不会评判你', reqDesc:'好感≥40', req:()=>aff>=40, effect: 12, cost:0,
                  reply:'……（停顿很久）你说这话……是认真的吗？（低声）……那……谢谢你。', outcome:'她第一次抬起头，认真地看了你。' },
            ],
            high: [
                { label:'陪她走那条回打工处的路', reqDesc:'体质≥50且好感≥65', req:()=>stuGame.fit>=50&&aff>=65, effect: 15, cost:5,
                  reply:'……（走了很久才开口）这条路很无聊的。（停顿）……谢谢你陪我走。', outcome:'你们谁都没再说话。但那段路比以往任何时候都短。' },
                { label:'送她一副耳机，说：你值得更好的声音', reqDesc:'零花钱≥400且好感≥75', req:()=>stuGame.money>=400&&aff>=75, effect: 20, fn:()=>{stuGame.money-=400;},
                  reply:'……（摸着耳机，沉默）……你……（低下头）……谢谢你。我会好好用的。', outcome:'她把旧耳机收进了口袋，而不是扔掉。你知道那代表什么。' },
                { label:'告诉她：弟弟的事，我们一起想办法', reqDesc:'好感≥85', req:()=>aff>=85, effect: 25, cost:0,
                  reply:'……（哑了）……"我们"？（停顿很久，声音颤抖）……你知道你在说什么吗。', outcome:'这是她第一次哭。她背对着你哭，但她没有离开。' },
            ]
        }
    };

    const CRUSH_COMMON_OPTIONS = {
        low: [
            { label:'安静地看着她/他，什么都没做', reqDesc:'', effect: 1, reply:'……？', outcome:'什么都没发生，但你在她/他眼里留下了一个模糊的印象。' },
        ],
        mid: [
            { label:'分享今天遇到的一件小事', reqDesc:'', effect: 4, reply:'……（停顿）……然后呢？', outcome:'她/他开口问了，就说明还想听下去。' },
        ],
        high: [
            { label:'什么都不说，只是待在她/他身边', reqDesc:'', effect: 6, reply:'……（停顿）……你今天不说话。（停顿）……其实挺好的。', outcome:'有些时刻，存在本身就是答案。' },
        ]
    };
    
    function adjustSchedule(t) {
        let val = parseInt(document.getElementById('range-'+t).value);
        game.schedule[t] = val;
        document.getElementById('lbl-'+t+'-hr').innerText = val + "节";
        
        let total = game.schedule.main + game.schedule.minor + game.schedule.spec;
        document.getElementById('sch-total-hr').innerText = total;
        let warnBox = document.getElementById('sch-warn-box');
        if(total > 50) { warnBox.style.display='block'; warnBox.innerHTML='⚠️ <b>极度危险：</b>学生濒临猝死！'; }
        else if(game.schedule.main > 25) { warnBox.style.display='block'; warnBox.innerHTML='⚠️ <b>危险警告：</b>主科排课数若超过 <b>25节</b>，产生的思维熵增将呈<b>指数级爆炸</b>！'; }
        else { warnBox.style.display='none'; }
        updateUI();
    }

    function upgradeTeacher(k) { if(game.teachers[k]<2 && payCost(0,50)) { game.teachers[k]++; updateUI(); } }
    function triggerGaokao() { 
        let total = game.students;
        let baseScore = Math.min(750, game.grade * 6.5 + 120 + Math.random() * 30 - 15);
        game.lastGaokaoAvg = Math.floor(baseScore);
        
        let t_qb = Math.floor(total * (baseScore > 680 ? (baseScore-680)/350 : 0)); 
        let t_985 = Math.floor(total * (baseScore > 600 ? (baseScore-600)/320 : 0)); 
        let t_211 = Math.floor(total * (baseScore > 550 ? (baseScore-550)/280 : 0)); 
        let t_bk = Math.floor(total * (baseScore > 450 ? (baseScore-450)/240 : 0)); 
        let t_zk = Math.floor(total * (baseScore > 300 ? (baseScore-300)/200 : 0)); 
        t_985 = Math.max(0, t_985 - t_qb);
        t_211 = Math.max(0, t_211 - t_985 - t_qb);
        t_bk = Math.max(0, t_bk - t_211 - t_985 - t_qb);
        t_zk = Math.max(0, t_zk - t_bk - t_211 - t_985 - t_qb);
        let t_fail = Math.max(0, total - t_qb - t_985 - t_211 - t_bk - t_zk);
        
        let uplinePct = Math.floor((total - t_fail)/total*100);
        let repGain = t_qb * 5 + t_985 * 2 + t_211 * 1 + Math.floor(uplinePct * 2);
        game.reputation += repGain;
        
        game.gaokaoHistory.push({ year: game.year, avg: game.lastGaokaoAvg, qb: t_qb, rep985: t_985, p211: t_211, bk: t_bk, zk: t_zk, fail: t_fail, upline: uplinePct });
        
        let historyHtml = '';
        if(game.gaokaoHistory.length > 1) {
            historyHtml = `<div style="margin-top:15px; border-top:2px dashed #e2e8f0; padding-top:15px;">
                <h4 style="text-align:center; margin:0 0 10px 0; color:#1e293b;">📈 历年高考清北人数对比</h4>
                <div style="display:flex; align-items:flex-end; justify-content:space-around; height:120px; background:#f8fafc; border-radius:8px; padding:10px 5px 0; border:1px solid #e2e8f0;">`;
            let maxQb = Math.max(1, ...game.gaokaoHistory.map(h=>h.qb||0));
            game.gaokaoHistory.slice(-8).forEach(h => {
                let barH = Math.max(5, Math.floor((h.qb/Math.max(1,maxQb))*100));
                historyHtml += `<div style="display:flex;flex-direction:column;align-items:center;width:11%;">
                    <div style="font-size:0.6rem;color:#ef4444;font-weight:bold;">${h.qb}</div>
                    <div style="background:#ef4444;width:100%;height:${barH}px;border-radius:2px 2px 0 0;min-height:4px;"></div>
                    <div style="font-size:0.55rem;color:#64748b;margin-top:3px;">${h.year}</div>
                </div>`;
            });
            historyHtml += `</div></div>`;
        }
        
        let html = `
        <div class="chart-container" style="width:100%;">
            <div class="chart-col"><div class="chart-bar" style="background:#ef4444; height:${Math.max(2, (t_qb/total)*150)}px;">${t_qb}</div><div class="chart-label">清北</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#8b5cf6; height:${Math.max(2, (t_985/total)*150)}px;">${t_985}</div><div class="chart-label">985</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#3b82f6; height:${Math.max(2, (t_211/total)*150)}px;">${t_211}</div><div class="chart-label">211</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#10b981; height:${Math.max(2, (t_bk/total)*150)}px;">${t_bk}</div><div class="chart-label">一本</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#f59e0b; height:${Math.max(2, (t_zk/total)*150)}px;">${t_zk}</div><div class="chart-label">二本</div></div>
            <div class="chart-col"><div class="chart-bar" style="background:#64748b; height:${Math.max(2, (t_fail/total)*150)}px;">${t_fail}</div><div class="chart-label">落榜</div></div>
        </div>
        <p style="text-align:center;"><b>${game.year}年高考</b> | 均分: ${game.lastGaokaoAvg} | 上线率: ${uplinePct}% | 声誉 +${repGain}</p>
        ${historyHtml}`;
        
        log(`🎓 ${game.year}年高考揭晓！均分${game.lastGaokaoAvg}，清北${t_qb}人，上线率${uplinePct}%，声誉+${repGain}`, "var(--success)");
        
        // 校长模式：高考结果弹窗，不触发学生结局
        showCustomModal(`🎓 ${game.year}年 · 高考成绩公告`, html, [{text:"确认归档", action:updateUI}]);
    }
    function triggerEnrollment() { showCustomModal("开学", "九月新学期开始，迎接新生与新生学费！", [{text:"OK", action:updateUI}]); }

    // ================= 战斗卷轴系统 =================
    const SCROLLS = [
        { id:'sc_basic',   name:'常规战强化卷', desc:'攻击+10%（默认装备）', icon:'📜', atkMult:1.10, cost:0,   costType:'free', owned:true,  req:()=>true },
        { id:'sc_adv',     name:'强化卷', desc:'攻击+20%', icon:'📋', atkMult:1.20, cost:50,  costType:'edu', owned:false, req:()=>true },
        { id:'sc_boss',    name:'BOSS密卷', desc:'暴击+30%', icon:'📗', critBonus:0.30, cost:80,  costType:'edu', owned:false, req:()=>game.levelIdx>=1 },
        { id:'sc_real',    name:'真题卷', desc:'真实伤害，无视50%防御', icon:'📕', trueReal:true, cost:120, costType:'edu', owned:false, req:()=>game.levelIdx>=2 },
        { id:'sc_multi',   name:'竞赛卷', desc:'多段伤害×3（群体战）', icon:'📘', multiHit:3, cost:150, costType:'edu', owned:false, req:()=>game.levelIdx>=3 },
    ];

    function getScrollData() {
        if(!game.scrolls) game.scrolls = { owned:['sc_basic'], equipped:'sc_basic' };
        return game.scrolls;
    }

    function getActiveScroll() {
        let sd = getScrollData();
        return SCROLLS.find(s=>s.id===sd.equipped) || SCROLLS[0];
    }

    // ================= 组合技系统 =================
    const COMBO_RECIPES = [
        { id:'c01', name:'精神崩溃',   desc:'敌方全体晕眩2回合', ingredients:['sup_0','sup_3'], icon:'🧠', effect:(p,e)=>{ e.buffs.stun=2; bLog("💥 精神崩溃！敌方晕眩2回合！"); } },
        { id:'c02', name:'智慧火花',   desc:'全体AP+10', ingredients:['sup_1','sup_2'], icon:'✨', effect:(p,e)=>{ p.ap=Math.min(p.maxAp,p.ap+10); bLog("✨ 智慧火花！AP+10！"); } },
        { id:'c03', name:'铁壁防御',   desc:'己方防御×2，持续3回合', ingredients:['def_0','def_1'], icon:'🛡️', effect:(p,e)=>{ p.buffs.defUp=3; bLog("🛡️ 铁壁防御！防御翻倍3回合！"); } },
        { id:'c04', name:'毁灭打击',   desc:'造成500%真实伤害', ingredients:['atk_5','atk_13'], icon:'💣', effect:(p,e)=>{ let dmg=Math.floor(bState.p.atk*5); e.hp-=dmg; bLog(`💣 毁灭打击！造成${dmg}真实伤害！`); } },
        { id:'c05', name:'学霸压制',   desc:'敌方攻击-30%，持续5回合', ingredients:['atk_4','sup_3'], icon:'👓', effect:(p,e)=>{ e.buffs.atkDown=5; bLog("👓 学霸压制！敌方攻击大降5回合！"); } },
        { id:'c06', name:'神圣光辉',   desc:'满血复活+全体AP恢复', ingredients:['sup_4','atk_2'], icon:'🌟', effect:(p,e)=>{ p.hp=p.maxHp; p.ap=p.maxAp; bLog("🌟 神圣光辉！满血全AP！"); } },
        { id:'c07', name:'熵增风暴',   desc:'敌方压力+15，混乱3回合', ingredients:['entropy_add','sup_0'], icon:'🌀', effect:(p,e)=>{ e.stress=Math.min(100,(e.stress||0)+15); e.buffs.stun=3; bLog("🌀 熵增风暴！混乱3回合！"); } },
        { id:'c08', name:'减熵冲击',   desc:'消除己方负面BUFF+攻击+30%', ingredients:['entropy_clear','atk_1'], icon:'💫', effect:(p,e)=>{ p.buffs.atkDown=0;p.buffs.dot=0;p.buffs.atkUp=3; bLog("💫 减熵冲击！清除负面+攻击大幅提升！"); } },
        { id:'c09', name:'题海碾压',   desc:'4段100%伤害+敌方防御-50%', ingredients:['atk_4','atk_12'], icon:'📚', effect:(p,e)=>{ for(let i=0;i<4;i++){let d=Math.floor(p.atk);e.hp-=d;} e.buffs.defDown=3; bLog("📚 题海碾压！4段全打+防御崩溃！"); } },
        { id:'c10', name:'教研联动',   desc:'教研点+30，下回合AP全满', ingredients:['atk_8','def_2'], icon:'🔬', effect:(p,e)=>{ game.eduPoints+=30; p.ap=p.maxAp; bLog("🔬 教研联动！教研点+30，AP满！"); } },
        { id:'c11', name:'心灵涤荡',   desc:'己方压力清零+HP回复50%', ingredients:['sup_3','def_0'], icon:'💎', effect:(p,e)=>{ p.stress=0; p.hp=Math.min(p.maxHp,p.hp+Math.floor(p.maxHp*0.5)); bLog("💎 心灵涤荡！压力归零，HP+50%！"); } },
        { id:'c12', name:'奥赛降维',   desc:'无视防御造成300%伤害+晕眩', ingredients:['atk_10','atk_9'], icon:'🏆', effect:(p,e)=>{ let d=Math.floor(p.atk*3); e.hp-=d; e.buffs.stun=1; bLog(`🏆 奥赛降维！${d}真实伤害+晕眩！`); } },
        { id:'c13', name:'全军突击',   desc:'双段250%伤害+己方攻击+20%', ingredients:['atk_3','atk_6'], icon:'⚔️', effect:(p,e)=>{ for(let i=0;i<2;i++){let d=Math.floor(p.atk*2.5); e.hp-=d;} p.buffs.atkUp=2; bLog("⚔️ 全军突击！双段重击！"); } },
        { id:'c14', name:'知识壁垒',   desc:'己方防御+80%持续4回合+反伤', ingredients:['def_1','def_2'], icon:'🧱', effect:(p,e)=>{ p.buffs.defUp=4; p.buffs.thorns=true; bLog("🧱 知识壁垒！超强防御+反伤！"); } },
        { id:'c15', name:'高考特训',   desc:'本场战斗攻击永久+25%', ingredients:['atk_11','atk_7'], icon:'🎯', effect:(p,e)=>{ p.atk=Math.floor(p.atk*1.25); bLog("🎯 高考特训！本场攻击永久+25%！"); } },
        { id:'c16', name:'联考霸权',   desc:'敌方全属性下降+联考积分+10', ingredients:['atk_5','atk_3'], icon:'👑', effect:(p,e)=>{ e.buffs.atkDown=4; e.buffs.defDown=4; game.examPoints+=10; bLog("👑 联考霸权！敌全属性崩溃！"); } },
        { id:'c17', name:'绝命压迫',   desc:'敌方持续伤害5回合+无法回血', ingredients:['atk_7','atk_0'], icon:'☠️', effect:(p,e)=>{ e.buffs.dot=5; e.buffs.noHeal=true; bLog("☠️ 绝命压迫！持续中毒5回合！"); } },
        { id:'c18', name:'资金链攻击',  desc:'消耗敌方资金型（资金+50万）', ingredients:['sup_1','def_0'], icon:'💰', effect:(p,e)=>{ game.funds+=50; bLog("💰 资金链攻击！获得50万资金！"); } },
        { id:'c19', name:'声誉洗白',   desc:'我方声誉+100，敌方压力+10', ingredients:['sup_3','sup_2'], icon:'⭐', effect:(p,e)=>{ game.reputation+=100; e.stress=(e.stress||0)+10; bLog("⭐ 声誉洗白！声誉+100！"); } },
        { id:'c20', name:'教育部联动',  desc:'AP全恢复+敌方晕眩+教研点+20', ingredients:['sup_4','sup_1'], icon:'🏛️', effect:(p,e)=>{ p.ap=p.maxAp; e.buffs.stun=2; game.eduPoints+=20; bLog("🏛️ 教育部联动！AP满+晕眩+教研！"); } },
    ];

    // ================= 教学装备系统 =================
    const EQUIPMENT_DB = [
        { id:'eq_board',    name:'智能黑板',  desc:'教学效率+15%（学业倍率+15%）', icon:'📟', effect:'teach_eff',  bonus:0.15, obtain:'research', researched:false },
        { id:'eq_lab_kit',  name:'实验箱',    desc:'理科课程效果+20%（教研点获取+20%）', icon:'🧪', effect:'sci_eff',  bonus:0.20, obtain:'shop_edu', cost:100, researched:false },
        { id:'eq_sand',     name:'心理沙盘',  desc:'减压效果+30%（减压类技能加强）', icon:'🏖️', effect:'stress_red', bonus:0.30, obtain:'event',   researched:false },
        { id:'eq_vr',       name:'VR教学眼镜', desc:'所有技能AP消耗-2', icon:'🥽', effect:'ap_reduce', bonus:2, obtain:'research', researched:false },
        { id:'eq_projector',name:'超清投影仪', desc:'战斗暴击率+10%', icon:'📽️', effect:'crit_up', bonus:0.10, obtain:'shop_funds', cost:300, researched:false },
        { id:'eq_tablet',   name:'教学平板',  desc:'每月自动获得1教研点', icon:'📱', effect:'edu_auto', bonus:1, obtain:'research', researched:false },
    ];

    function getEquipData() {
        if(!game.equip) game.equip = { owned:[], equipped:[] };
        return game.equip;
    }

    // ================= 装备研发系统渲染 =================
    function openRnd() {
        if(!game||!game.map) return showToast("请先选择难度开始游戏！");
        openModal('modal-rnd');
        renderRnd('scroll');
    }

    function renderRnd(tab) {
        let el = document.getElementById('rnd-content');
        if(!el) return;
        if(tab==='scroll') {
            let sd = getScrollData();
            let html = `<h3 style="margin-top:0;color:#ea580c;">📜 战斗卷轴——增强联考战斗属性</h3>
            <p style="color:#64748b;font-size:0.85rem;">装备卷轴后在战斗中持续生效。当前装备：<b style="color:#ea580c;">${SCROLLS.find(s=>s.id===sd.equipped)?.name||'无'}</b></p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">`;
            SCROLLS.forEach(sc=>{
                let owned = sd.owned.includes(sc.id) || sc.id==='sc_basic';
                let equipped = sd.equipped===sc.id;
                let canReq = sc.req();
                let costLabel = sc.costType==='free'?'默认拥有':`教研点${sc.cost}`;
                html+=`<div style="background:${equipped?'#fef3c7':owned?'#f0fdf4':'#f8fafc'};border:2px solid ${equipped?'#f59e0b':owned?'#10b981':'#cbd5e1'};border-radius:8px;padding:12px;">
                    <div style="font-size:1.5rem;">${sc.icon}</div>
                    <div style="font-weight:bold;color:#1e293b;">${sc.name} ${equipped?'<span style="background:#f59e0b;color:white;font-size:0.6rem;padding:2px 5px;border-radius:3px;">装备中</span>':''}</div>
                    <div style="font-size:0.78rem;color:#64748b;margin:4px 0;">${sc.desc}</div>
                    ${!owned&&canReq?`<button class="btn" style="padding:4px 10px;font-size:0.78rem;margin-top:4px;" onclick="buyScroll('${sc.id}')">研发 ${costLabel}</button>`:''}
                    ${owned&&!equipped?`<button class="btn" style="padding:4px 10px;font-size:0.78rem;margin-top:4px;background:#fef3c7;border-color:#f59e0b;" onclick="equipScroll('${sc.id}')">装备</button>`:''}
                    ${!canReq&&!owned?`<div style="font-size:0.7rem;color:#ef4444;margin-top:4px;">⚠️ 需学校达到更高等级</div>`:''}
                </div>`;
            });
            html+='</div>';
            el.innerHTML=html;
        } else if(tab==='combo') {
            let learned = game.combos || [];
            let html=`<h3 style="margin-top:0;color:#c026d3;">⚡ 组合技研发——消耗教研点解锁强力组合技</h3>
            <p style="color:#64748b;font-size:0.85rem;">组合技在战斗中需要消耗额外AP使用，但效果极为强力。</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">`;
            COMBO_RECIPES.forEach((c,i)=>{
                let isLearned = learned.includes(c.id);
                let cost = 30 + i*5;
                html+=`<div style="background:${isLearned?'#fdf4ff':'#f8fafc'};border:2px solid ${isLearned?'#c026d3':'#cbd5e1'};border-radius:8px;padding:10px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-size:1.5rem;">${c.icon}</span>
                        <div>
                            <div style="font-weight:bold;color:#1e293b;">${c.name} ${isLearned?'<span style="background:#c026d3;color:white;font-size:0.6rem;padding:2px 5px;border-radius:3px;">已解锁</span>':''}</div>
                            <div style="font-size:0.72rem;color:#64748b;">${c.desc}</div>
                        </div>
                    </div>
                    ${!isLearned?`<button class="btn" style="padding:4px 10px;font-size:0.75rem;" onclick="learnCombo('${c.id}',${cost})">研发 教研点${cost}</button>`:'<div style="font-size:0.72rem;color:#10b981;">✅ 已在战斗组合技栏中可用</div>'}
                </div>`;
            });
            html+='</div>';
            el.innerHTML=html;
        } else if(tab==='equip') {
            let ed = getEquipData();
            let html=`<h3 style="margin-top:0;color:#16a34a;">🎒 教学装备——装备后持续提升学校属性</h3>
            <p style="color:#64748b;font-size:0.85rem;">装备可通过研发、商店或事件获得。当前装备数量: ${ed.equipped.length}/3</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">`;
            EQUIPMENT_DB.forEach(eq=>{
                let owned = ed.owned.includes(eq.id);
                let equipped = ed.equipped.includes(eq.id);
                let obtainLabel = eq.obtain==='research'?`教研点80 研发`
                                : eq.obtain==='shop_edu'?`教研点${eq.cost} 购买`
                                : eq.obtain==='shop_funds'?`￥${eq.cost}万 购买`
                                : '通过特定事件获得';
                html+=`<div style="background:${equipped?'#f0fdf4':owned?'#fdf4ff':'#f8fafc'};border:2px solid ${equipped?'#16a34a':owned?'#c026d3':'#cbd5e1'};border-radius:8px;padding:10px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-size:1.5rem;">${eq.icon}</span>
                        <div>
                            <div style="font-weight:bold;">${eq.name} ${equipped?'<span style="background:#16a34a;color:white;font-size:0.6rem;padding:2px 5px;border-radius:3px;">装备中</span>':owned?'<span style="background:#c026d3;color:white;font-size:0.6rem;padding:2px 5px;border-radius:3px;">已拥有</span>':''}</div>
                            <div style="font-size:0.72rem;color:#64748b;">${eq.desc}</div>
                        </div>
                    </div>
                    ${!owned?`<button class="btn" style="padding:4px 10px;font-size:0.75rem;" onclick="buyEquip('${eq.id}')">${obtainLabel}</button>`:''}
                    ${owned&&!equipped?`<button class="btn" style="padding:4px 10px;font-size:0.75rem;background:#f0fdf4;border-color:#16a34a;" onclick="equipItem('${eq.id}')">装备</button>`:''}
                    ${equipped?`<button class="btn" style="padding:4px 10px;font-size:0.75rem;border-color:#ef4444;color:#ef4444;" onclick="unequipItem('${eq.id}')">卸下</button>`:''}
                </div>`;
            });
            html+='</div>';
            el.innerHTML=html;
        }
    }

    function buyScroll(id) {
        let sc = SCROLLS.find(s=>s.id===id);
        if(!sc||sc.costType==='free') return;
        if(game.eduPoints<sc.cost) return showToast("教研点不足！");
        game.eduPoints-=sc.cost;
        let sd = getScrollData();
        if(!sd.owned.includes(id)) sd.owned.push(id);
        showToast(`📜 研发成功：${sc.name}！`);
        updateUI(); renderRnd('scroll');
    }

    function equipScroll(id) {
        let sd = getScrollData();
        sd.equipped=id;
        showToast(`已装备卷轴：${SCROLLS.find(s=>s.id===id)?.name}`);
        renderRnd('scroll');
    }

    function learnCombo(id, cost) {
        if(game.eduPoints<cost) return showToast("教研点不足！");
        game.eduPoints-=cost;
        if(!game.combos) game.combos=[];
        if(!game.combos.includes(id)) game.combos.push(id);
        let c = COMBO_RECIPES.find(x=>x.id===id);
        showToast(`⚡ 组合技【${c?.name}】已解锁！`);
        updateUI(); renderRnd('combo');
    }

    function buyEquip(id) {
        let eq = EQUIPMENT_DB.find(e=>e.id===id);
        if(!eq) return;
        if(eq.obtain==='research') {
            if(game.eduPoints<80) return showToast("教研点不足（需80）！");
            game.eduPoints-=80;
        } else if(eq.obtain==='shop_edu') {
            if(game.eduPoints<eq.cost) return showToast("教研点不足！");
            game.eduPoints-=eq.cost;
        } else if(eq.obtain==='shop_funds') {
            if(!payCost(0,eq.cost)) return;
        } else return showToast("此装备只能通过事件获得！");
        let ed = getEquipData();
        if(!ed.owned.includes(id)) ed.owned.push(id);
        showToast(`🎒 获得装备：${eq.name}！`);
        updateUI(); renderRnd('equip');
    }

    function equipItem(id) {
        let ed = getEquipData();
        if(ed.equipped.length>=3 && !ed.equipped.includes(id)) return showToast("最多同时装备3件！请先卸下一件。");
        if(!ed.equipped.includes(id)) ed.equipped.push(id);
        showToast(`已装备：${EQUIPMENT_DB.find(e=>e.id===id)?.name}`);
        applyEquipmentBonuses(); renderRnd('equip');
    }

    function unequipItem(id) {
        let ed = getEquipData();
        ed.equipped = ed.equipped.filter(x=>x!==id);
        showToast(`已卸下：${EQUIPMENT_DB.find(e=>e.id===id)?.name}`);
        renderRnd('equip');
    }

    function applyEquipmentBonuses() {
        // 月度被动效果在advanceMonth中处理
        let ed = getEquipData();
        ed.equipped.forEach(id=>{
            let eq = EQUIPMENT_DB.find(e=>e.id===id);
            if(!eq) return;
            if(eq.effect==='edu_auto') { game.eduPoints+=eq.bonus; }
        });
    }

    // 在战斗中获取装备对AP的减免
    function getEquipApReduce() {
        let ed = getEquipData();
        let red = 0;
        ed.equipped.forEach(id=>{ let eq=EQUIPMENT_DB.find(e=>e.id===id); if(eq&&eq.effect==='ap_reduce') red+=eq.bonus; });
        return red;
    }

    // 在战斗中获取装备暴击加成
    function getEquipCritBonus() {
        let ed = getEquipData();
        let bonus = 0;
        ed.equipped.forEach(id=>{ let eq=EQUIPMENT_DB.find(e=>e.id===id); if(eq&&eq.effect==='crit_up') bonus+=eq.bonus; });
        return bonus;
    }

    // 添加战斗用新技能：熵增/减熵
    // 在SKILL_DB后追加战斗技能并加入支援组合技入口
    function renderComboSkills() {
        if(!game||!game.combos||!game.combos.length) return '';
        let html = `<div style="margin-top:12px;border-top:2px dashed #c026d3;padding-top:10px;">
            <div style="font-weight:bold;color:#c026d3;font-size:0.85rem;margin-bottom:6px;">⚡ 已解锁组合技</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;">`;
        game.combos.forEach(cid=>{
            let c = COMBO_RECIPES.find(x=>x.id===cid);
            if(!c) return;
            html+=`<button class="b-skill-btn" onclick="useCombo('${cid}')" style="border-color:#c026d3;">${c.icon} ${c.name}<div style="font-size:0.62rem;color:#94a3b8;">${c.desc.substring(0,15)}...</div></button>`;
        });
        html+='</div></div>';
        return html;
    }

    function useCombo(id) {
        if(!bState.active||bState.isOver) return showToast("不在战斗中！");
        let c = COMBO_RECIPES.find(x=>x.id===id);
        if(!c) return;
        let apCost = 20;
        if(bState.p.ap < apCost) return showToast(`AP不足！组合技需要${apCost}AP`);
        bState.p.ap -= apCost;
        c.effect(bState.p, bState.e);
        bCheckEnd(); bRenderBattle();
    }

    // ================= 背景音乐 =================
    const BGM_LIST = ['src/music/1.mp3','src/music/2.mp3','src/music/3.mp3','src/music/4.mp3'];
    let bgmIndex = Math.floor(Math.random() * BGM_LIST.length);
    let bgmStarted = false;

    function initBGM() {
        if(bgmStarted) return;
        bgmStarted = true;
        let audio = document.getElementById('bgm');
        audio.src = BGM_LIST[bgmIndex];
        audio.volume = 0.35;
        audio.play().catch(()=>{});
        audio.addEventListener('ended', () => {
            bgmIndex = (bgmIndex + 1) % BGM_LIST.length;
            audio.src = BGM_LIST[bgmIndex];
            audio.play().catch(()=>{});
        });
    }

    // 首次用户交互时启动音乐（浏览器自动播放策略要求）
    document.addEventListener('click', initBGM, { once: true });
    document.addEventListener('keydown', initBGM, { once: true });

    // ================= 终末之诗 =================
    function showEndPoem() {
        var o = document.getElementById('end-poem-overlay');
        var t = document.getElementById('end-poem-track');
        var fresh = t.cloneNode(true);
        t.parentNode.replaceChild(fresh, t);
        fresh = document.getElementById('end-poem-track');
        o.style.display = 'block';
        o.onclick = null; // not skippable
        // When animation ends, allow close
        fresh.addEventListener('animationend', function() {
            var btn = document.getElementById('end-poem-close-btn');
            if(btn) btn.style.display = 'block';
        });
    }

    function handlePoemClick() {
        // Only called after poem ends
        document.getElementById('end-poem-overlay').style.display = 'none';
    }

    // 初始化加载
    window.onload = init;

    // ===== 实时时钟 =====
    (function tickClock() {
        var el = document.getElementById('real-clock');
        if(el) {
            var d = new Date();
            var hh = String(d.getHours()).padStart(2,'0');
            var mm = String(d.getMinutes()).padStart(2,'0');
            var ss = String(d.getSeconds()).padStart(2,'0');
            el.textContent = hh + ':' + mm + ':' + ss + ' // NODE-CN';
        }
        setTimeout(tickClock, 1000);
    })();

    // ===== 标题随机干扰闪烁 =====
    (function glitchTitle() {
        var el = document.getElementById('hdr-title');
        if(!el) return;
        var orig = el.textContent;
        var chars = '孔子学校V0.0.3万象归一ABCDEF01234';
        // 随机间隔触发
        var delay = 5000 + Math.random() * 8000;
        setTimeout(function() {
            var glitchCount = 0;
            var iv = setInterval(function() {
                if(glitchCount++ > 4) { clearInterval(iv); el.textContent = orig; glitchTitle(); return; }
                var arr = orig.split('');
                [Math.floor(Math.random()*arr.length), Math.floor(Math.random()*arr.length)].forEach(function(i) {
                    arr[i] = chars[Math.floor(Math.random()*chars.length)];
                });
                el.textContent = arr.join('');
            }, 80);
        }, delay);
    })();
</script>
</body>
</html>

